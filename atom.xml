<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>MrBird</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://mrbird.cc/"/>
  <updated>2020-01-21T10:30:56.818Z</updated>
  <id>http://mrbird.cc/</id>
  
  <author>
    <name>MrBird</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Spring Cloud å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹</title>
    <link href="http://mrbird.cc/book.html"/>
    <id>http://mrbird.cc/book.html</id>
    <published>2222-10-24T06:20:57.000Z</published>
    <updated>2020-01-21T10:30:56.818Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:41 GMT+0800 (GMT+08:00) --><p>ğŸ“–ã€Š<a href="https://www.kancloud.cn/mrbird/spring-cloud" target="_blank" rel="noopener"> Spring Cloud å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹ </a>ã€‹ä¸€æœ¬åŸºäºSpring Cloud Hoxton.RELEASE&amp;Spring Cloud Oauth2&amp;Spring Cloud Alibabaçš„å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹ä¹¦ç±ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ ä»é›¶åˆ°K8Sé›†ç¾¤éƒ¨ç½²ã€‚</p><a id="more"></a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263686" target="_blank" rel="noopener">ç¬¬ä¸€ç«  åŸºç¡€æ¡†æ¶æ­å»º</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263687" target="_blank" rel="noopener">1.1 æ¶æ„é¢„è§ˆ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263688" target="_blank" rel="noopener">1.2 æ­å»ºå¾®æœåŠ¡æ³¨å†Œä¸­å¿ƒ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263689" target="_blank" rel="noopener">1.3 æ­å»ºè®¤è¯æœåŠ¡å™¨</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263690" target="_blank" rel="noopener">1.4 æ­å»ºå¾®æœåŠ¡ç½‘å…³</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263691" target="_blank" rel="noopener">1.5 æ­å»ºå¾®æœåŠ¡æä¾›è€…ï¼ˆèµ„æºæœåŠ¡å™¨ï¼‰</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263692" target="_blank" rel="noopener">1.6 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263693" target="_blank" rel="noopener">ç¬¬äºŒç«  æ¶æ„å®Œå–„</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263694" target="_blank" rel="noopener">2.1 å‚æ•°é…ç½®åŒ–</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263695" target="_blank" rel="noopener">2.2 å¼‚å¸¸å¤„ç†</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263696" target="_blank" rel="noopener">2.3 Feignçš„ä½¿ç”¨</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263697" target="_blank" rel="noopener">2.4 å¾®æœåŠ¡é˜²æŠ¤</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263698" target="_blank" rel="noopener">2.5 è·¨åŸŸå¤„ç†</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263699" target="_blank" rel="noopener">2.6 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263700" target="_blank" rel="noopener">ç¬¬ä¸‰ç«  å®Œå–„ç™»å½•æµç¨‹</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263701" target="_blank" rel="noopener">3.1 è¡¨ç»“æ„è®¾è®¡</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263702" target="_blank" rel="noopener">3.2 å®Œå–„ç™»å½•</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263703" target="_blank" rel="noopener">3.3 æ•´åˆå›¾å½¢éªŒè¯ç </a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263704" target="_blank" rel="noopener">3.4 SentineléªŒè¯ç é™æµ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263705" target="_blank" rel="noopener">3.5 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263706" target="_blank" rel="noopener">ç¬¬å››ç«  æ•´åˆSwagger</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263707" target="_blank" rel="noopener">4.1 å®Œå–„febs-server-system</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263708" target="_blank" rel="noopener">4.2 æ¥å…¥Swagger</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263709" target="_blank" rel="noopener">4.3 Swagger OAuth2è®¤è¯</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263710" target="_blank" rel="noopener">4.4 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263711" target="_blank" rel="noopener">ç¬¬äº”ç«  æ•´åˆç¬¬ä¸‰æ–¹æœåŠ¡</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263712" target="_blank" rel="noopener">5.1 æ•´åˆSpring Boot Admin</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263713" target="_blank" rel="noopener">5.2 Sleuth Zipkiné“¾è·¯è¿½è¸ª</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263714" target="_blank" rel="noopener">5.3 logbackæ—¥å¿—æ‰“å°</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263715" target="_blank" rel="noopener">5.4 ELKæ—¥å¿—æ”¶é›†</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263716" target="_blank" rel="noopener">5.5 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263717" target="_blank" rel="noopener">ç¬¬å…­ç«  å‰ç«¯ç³»ç»Ÿä»‹ç»</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263718" target="_blank" rel="noopener">6.1 å°è£…Axios</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263719" target="_blank" rel="noopener">6.2 Vueå¯¼èˆªå®ˆå«</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263720" target="_blank" rel="noopener">6.3 åŠ¨æ€è·¯ç”±æ„å»º</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263721" target="_blank" rel="noopener">6.4 å¤„ç†ç”¨æˆ·ç™»å½•</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263722" target="_blank" rel="noopener">6.5 å¤„ç†ä»¤ç‰Œåˆ·æ–°</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263723" target="_blank" rel="noopener">6.6 è‡ªå®šä¹‰Vueæƒé™æŒ‡ä»¤</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263724" target="_blank" rel="noopener">6.7 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263725" target="_blank" rel="noopener">ç¬¬ä¸ƒç«  å¾®æœåŠ¡éƒ¨ç½²</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263726" target="_blank" rel="noopener">7.1 å¾®æœåŠ¡DokceråŒ–</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263727" target="_blank" rel="noopener">7.2 ä½¿ç”¨Docker Composeéƒ¨ç½²</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263728" target="_blank" rel="noopener">7.3 æœ¬ç« å°ç»“</a></li></ul></li><li><p><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263729" target="_blank" rel="noopener">ç¬¬å…«ç«  å¾®æœåŠ¡è¿›é˜¶</a></p><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1277531" target="_blank" rel="noopener">8.1 ä»¤ç‰Œå­˜å‚¨ç­–ç•¥</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263731" target="_blank" rel="noopener">8.2 ä½¿ç”¨Cloud Gatewayæ­å»ºç½‘å…³</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1271133" target="_blank" rel="noopener">8.3 ä½¿ç”¨Alibaba Nacosæ³¨å†Œä¸­å¿ƒ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1289434" target="_blank" rel="noopener">8.4 ä½¿ç”¨Alibaba Nacoså­˜å‚¨é…ç½®</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1333138" target="_blank" rel="noopener">8.5 æ¥å…¥Prometheus + Grafana</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1337996" target="_blank" rel="noopener">8.6 æ•´åˆskywalkingåˆ†å¸ƒå¼è¿½è¸ª</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1411735" target="_blank" rel="noopener">8.7 å‡çº§åˆ°Hoxton.RELEASE</a></li></ul></li><li><p><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426914" target="_blank" rel="noopener">ç¬¬ä¹ç«  K8Sé›†ç¾¤éƒ¨ç½²</a></p><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426916" target="_blank" rel="noopener">9.1 é›†ç¾¤ç¯å¢ƒå‡†å¤‡</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426917" target="_blank" rel="noopener">9.2 å®‰è£…ç¬¬ä¸‰æ–¹æœåŠ¡</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426918" target="_blank" rel="noopener">9.3 Kubeadmæ­å»ºK8S 1.16.2é›†ç¾¤</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426919" target="_blank" rel="noopener">9.4 NFSæœåŠ¡å™¨æ­å»º</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426920" target="_blank" rel="noopener">9.5 æ­å»ºDockeré•œåƒä»“åº“Harbor</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426921" target="_blank" rel="noopener">9.6 K8Sæ„å»ºé«˜å¯ç”¨Nacos</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426922" target="_blank" rel="noopener">9.7 K8Sæ„å»ºFEBS CloudæœåŠ¡é›†ç¾¤</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426923" target="_blank" rel="noopener">9.8 éƒ¨ç½²å‰ç«¯æµ‹è¯•</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426924" target="_blank" rel="noopener">9.9 K8Så®è·µæ€»ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456142" target="_blank" rel="noopener">ç¬¬åç«  åˆ†å¸ƒå¼äº‹åŠ¡ç ”ç©¶</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456143" target="_blank" rel="noopener">10.1 åˆ†å¸ƒå¼æ¶æ„äº‹åŠ¡æŒ‘æˆ˜</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456144" target="_blank" rel="noopener">10.2 åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456145" target="_blank" rel="noopener">10.3 åŸºäºæ¶ˆæ¯ä¸­é—´ä»¶RocketMQæ–¹æ¡ˆï¼ˆä¸€ï¼‰</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456146" target="_blank" rel="noopener">10.4 åŸºäºæ¶ˆæ¯ä¸­é—´ä»¶RocketMQæ–¹æ¡ˆï¼ˆäºŒï¼‰</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456147" target="_blank" rel="noopener">10.5 åŸºäºTX-LCNæ–¹æ¡ˆ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456148" target="_blank" rel="noopener">10.6 åŸºäºé˜¿é‡ŒSeataæ–¹æ¡ˆ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456149" target="_blank" rel="noopener">10.7 æœ¬ç« æ€»ç»“</a></li></ul></li></ul><script>$(function(){$("#comment-div").remove(),$(".post-copyright").remove(),$("#reward-div").remove(),$(".post-footer").remove()})</script><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:41 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;ğŸ“–ã€Š&lt;a href=&quot;https://www.kancloud.cn/mrbird/spring-cloud&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt; Spring Cloud å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹ &lt;/a&gt;ã€‹ä¸€æœ¬åŸºäºSpring Cloud Hoxton.RELEASE&amp;amp;Spring Cloud Oauth2&amp;amp;Spring Cloud Alibabaçš„å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹ä¹¦ç±ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ ä»é›¶åˆ°K8Sé›†ç¾¤éƒ¨ç½²ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Cloud" scheme="http://mrbird.cc/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>IDEAä¸­ä½¿ç”¨Dockeræ’ä»¶</title>
    <link href="http://mrbird.cc/IDEA-Docker-Plugin.html"/>
    <id>http://mrbird.cc/IDEA-Docker-Plugin.html</id>
    <published>2019-12-03T09:19:29.000Z</published>
    <updated>2020-01-21T03:30:03.127Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>åœ¨Windowsä¸Šå¦‚æœæ²¡æœ‰å®‰è£…docker for windowsçš„è¯ï¼Œæ˜¯æ²¡åŠæ³•æ„å»ºDockeré•œåƒçš„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœè¦é€šè¿‡fat jaræ„å»ºdockeré•œåƒçš„è¯ï¼Œåªèƒ½å°†fat jarä¸Šä¼ åˆ°å®‰è£…äº†dockeræœåŠ¡çš„LinuxæœåŠ¡å™¨ä¸Šï¼Œç„¶åç¼–å†™Dockerfileæ„å»ºã€‚è¿™ç§æ–¹å¼æ¯”è¾ƒéº»çƒ¦ï¼Œè¿™é‡Œè®°å½•ä¸‹å¦‚ä½•é€šè¿‡IDEAçš„Dockeræ’ä»¶è¿œç¨‹æ„å»ºDockeré•œåƒã€‚<a id="more"></a></p><h2 id="Dockerå¼€å¯è¿œç¨‹è®¿é—®"><a href="#Dockerå¼€å¯è¿œç¨‹è®¿é—®" class="headerlink" title="Dockerå¼€å¯è¿œç¨‹è®¿é—®"></a>Dockerå¼€å¯è¿œç¨‹è®¿é—®</h2><p>å‡å¦‚æˆ‘åœ¨CentOSè™šæ‹Ÿæœºä¸Šå®‰è£…å¥½äº†Dockerï¼ŒIPåœ°å€ä¸º192.168.33.11ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹Dockerçš„é…ç½®ï¼Œå¼€å¯è¿œç¨‹è®¿é—®æƒé™ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹Dockeré…ç½®</span></span><br><span class="line">vi /lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹çš„åœ°æ–¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191203190038.png" alt="QQæˆªå›¾20191203190038.png"></p><p>ä¿®æ”¹ä¿å­˜åï¼Œé‡å¯DockeræœåŠ¡ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl restart docker.service</span><br></pre></td></tr></table></figure><p></p><p>é‡å¯åï¼ŒéªŒè¯ä¸‹2375ç«¯å£æ˜¯å¦æ˜¯é€šçš„ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 192.168.33.11:2375/info</span><br></pre></td></tr></table></figure><p>å¦‚æœè¿”å›äº†ä¸€å¨JSONæ•°æ®ï¼Œè¯´æ˜ğŸ†—ã€‚</p><h2 id="IDEAä½¿ç”¨Dockeræ’ä»¶"><a href="#IDEAä½¿ç”¨Dockeræ’ä»¶" class="headerlink" title="IDEAä½¿ç”¨Dockeræ’ä»¶"></a>IDEAä½¿ç”¨Dockeræ’ä»¶</h2><p>IDEA Ultimateç‰ˆæœ¬å·²ç»é»˜è®¤å®‰è£…äº†Dockeræ’ä»¶ï¼ˆæ²¡æœ‰çš„è¯å»æ’ä»¶å¸‚åœºä¸‹è½½å®‰è£…ä¸‹å°±å¯ä»¥äº†ï¼‰ã€‚ç‚¹å‡»IDEA -&gt; File -&gt; Settingsâ€¦ -&gt; Build,Execution,Deployment -&gt; Dockerï¼š</p><p><img src="img/QQæˆªå›¾20191203190538.png" alt="QQæˆªå›¾20191203190538.png"></p><p>å¡«å†™è¿œç¨‹Dockeråœ°å€ï¼Œå¦‚æœæ˜¾ç¤ºConnection Successfullyè¯´æ˜è¿æ¥è¿œç¨‹DockeræœåŠ¡æˆåŠŸã€‚</p><p>æ–°å»ºä¸€ä¸ªç®€å•çš„Spring Booté¡¹ç›®ï¼Œpomå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>ç„¶åç”¨mavenæ‰“åŒ…ï¼Œæ‰“åŒ…åé¡¹ç›®æ ¹ç›®å½•çš„targetä¸‹ä¼šæœ‰å¦‚ä¸‹fat jarï¼š</p><p><img src="img/QQæˆªå›¾20191203191101.png" alt="QQæˆªå›¾20191203191101.png"></p><p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºDockerfileï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:8u212-jre</span><br><span class="line">MAINTAINER MrBird 852252810@qq.com</span><br><span class="line"></span><br><span class="line">COPY target/demo-0.0.1.jar /demo-0.0.1.jar</span><br><span class="line">ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;/demo-0.0.1.jar&quot;]</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åç‚¹å‡»IDEA -&gt; Run -&gt; Edit Configrationsâ€¦</p><p><img src="img/QQæˆªå›¾20191203191341.png" alt="QQæˆªå›¾20191203191341.png"></p><p>é€‰æ‹©è¿œç¨‹çš„DockeræœåŠ¡ï¼Œå¡«å†™é•œåƒæ ‡ç­¾å†…å®¹ï¼Œç‚¹å‡»ä¿å­˜åï¼Œè¿è¡Œï¼š</p><p><img src="img/QQæˆªå›¾20191203191547.png" alt="QQæˆªå›¾20191203191547.png"></p><p>é€šè¿‡æ—¥å¿—æ¥çœ‹ï¼Œé•œåƒæ„å»ºæ˜¯æˆåŠŸçš„ï¼š</p><p><img src="img/QQæˆªå›¾20191203191734.png" alt="QQæˆªå›¾20191203191734.png"></p><p>å¯ä»¥çœ‹åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸Šå·²ç»åŒ…å«äº†è¯¥Dockeré•œåƒï¼š</p><p><img src="img/QQæˆªå›¾20191203191809.png" alt="QQæˆªå›¾20191203191809.png"></p><p>å¯ä»¥åˆ°æœåŠ¡å™¨ä¸ŠéªŒè¯ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20191203191934.png" alt="QQæˆªå›¾20191203191934.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨Windowsä¸Šå¦‚æœæ²¡æœ‰å®‰è£…docker for windowsçš„è¯ï¼Œæ˜¯æ²¡åŠæ³•æ„å»ºDockeré•œåƒçš„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœè¦é€šè¿‡fat jaræ„å»ºdockeré•œåƒçš„è¯ï¼Œåªèƒ½å°†fat jarä¸Šä¼ åˆ°å®‰è£…äº†dockeræœåŠ¡çš„LinuxæœåŠ¡å™¨ä¸Šï¼Œç„¶åç¼–å†™Dockerfileæ„å»ºã€‚è¿™ç§æ–¹å¼æ¯”è¾ƒéº»çƒ¦ï¼Œè¿™é‡Œè®°å½•ä¸‹å¦‚ä½•é€šè¿‡IDEAçš„Dockeræ’ä»¶è¿œç¨‹æ„å»ºDockeré•œåƒã€‚
    
    </summary>
    
    
      <category term="Docker" scheme="http://mrbird.cc/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>KubernetesæœåŠ¡å‘ç°æ€»ç»“</title>
    <link href="http://mrbird.cc/Kubernetes-Service-Discovery-Summary.html"/>
    <id>http://mrbird.cc/Kubernetes-Service-Discovery-Summary.html</id>
    <published>2019-12-02T06:23:17.000Z</published>
    <updated>2020-01-21T03:30:03.135Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>KubernetesæœåŠ¡å‘ç°ä¸»è¦å¯ä»¥å½’ä¸ºä¸‰ç§æƒ…å½¢ï¼š1.Kubernetesé›†ç¾¤å†…éƒ¨é—´æœåŠ¡å¦‚ä½•äº’ç›¸é€šä¿¡ï¼›2.Kuberntesé›†ç¾¤å¤–éƒ¨å¦‚ä½•è®¿é—®é›†ç¾¤å†…éƒ¨æœåŠ¡ï¼›3.Kubernetesé›†ç¾¤å†…éƒ¨å¦‚ä½•è®¿é—®é›†ç¾¤å¤–éƒ¨æœåŠ¡ã€‚è¿™èŠ‚é’ˆå¯¹è¿™ä¸‰ç§æƒ…å†µåšä¸ªæ€»ç»“ã€‚</p><a id="more"></a><h2 id="é›†ç¾¤é—´æœåŠ¡é€šä¿¡"><a href="#é›†ç¾¤é—´æœåŠ¡é€šä¿¡" class="headerlink" title="é›†ç¾¤é—´æœåŠ¡é€šä¿¡"></a>é›†ç¾¤é—´æœåŠ¡é€šä¿¡</h2><p><strong>1.é€šè¿‡Pod IPç›¸äº’é€šä¿¡ï¼Œä½†æ˜¯Podå…·æœ‰ä¸ç¡®å®šæ€§ï¼ŒPod IPä¼šå‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼å¹¶ä¸æ¨èã€‚</strong></p><p><strong>2.éƒ¨ç½²Podå¯¹åº”çš„Serviceï¼Œè®¿é—®Service IPï¼Œè¯·æ±‚è´Ÿè½½å‡è¡¡è½¬å‘æœåŠ¡åˆ°å„ä¸ªå¯¹åº”çš„Podå®ä¾‹ã€‚</strong></p><p>æ¯”å¦‚æœ‰å¦‚ä¸‹é…ç½®æ–‡ä»¶demo.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-d</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">web-app</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">web-app</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">web-app</span></span><br></pre></td></tr></table></figure><p></p><p>è¿è¡Œè¯¥é…ç½®ï¼ŒæŸ¥çœ‹Serviceå¯¹åº”çš„IPï¼š</p><p><img src="img/QQæˆªå›¾20191203143956.png" alt="QQæˆªå›¾20191203143956.png"></p><p>é€šè¿‡Service IPå’Œç«¯å£å°±èƒ½è®¿é—®å¯¹åº”çš„PodæœåŠ¡:</p><p><img src="img/QQæˆªå›¾20191203144119.png" alt="QQæˆªå›¾20191203144119.png"></p><p>ä½†æ˜¯æˆ‘ä»¬äº‹å…ˆå¹¶ä¸çŸ¥é“Serviceçš„IPæ˜¯å¤šå°‘ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å¯åŠ¨æœåŠ¡åå†å»é…ç½®è¿™ä¸ªIPçš„è¯ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿæ˜¯éå¸¸éº»çƒ¦çš„ï¼Œæ‰€å¹¸æˆ‘ä»¬å¯ä»¥é€šè¿‡DNSè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™ç§æ–¹å¼ï¼š</p><p><strong>3.éƒ¨ç½²Podå¯¹åº”çš„Serviceï¼Œé€šè¿‡ServiceNameï¼Œè¯·æ±‚è´Ÿè½½å‡è¡¡è½¬å‘æœåŠ¡åˆ°å„ä¸ªå¯¹åº”çš„Podå®ä¾‹ã€‚</strong></p><p>é€šè¿‡ä¸‹é¢è¿™æ®µé…ç½®éƒ¨ç½²ä¸€ä¸ªæ–°çš„PodæœåŠ¡ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">centos-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">centos</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">centos</span></span><br><span class="line"><span class="attr">      command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">sh</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">-c</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">'while true; do sleep 360000000; done'</span></span><br></pre></td></tr></table></figure><p></p><p>è¿›å…¥åˆ°è¯¥å®¹å™¨å†…éƒ¨ï¼Œæµ‹è¯•ä¸‹æ˜¯å¦å¯ä»¥è®¿é—®ä¸Šé¢åˆ›å»ºçš„Serviceï¼š</p><p><img src="img/QQæˆªå›¾20191203145657.png" alt="QQæˆªå›¾20191203145657.png"></p><p>è¯•ç€é€šè¿‡ServiceNameè®¿é—®NginxæœåŠ¡ï¼š</p><p><img src="img/QQæˆªå›¾20191203145744.png" alt="QQæˆªå›¾20191203145744.png"></p><p>å¯ä»¥çœ‹åˆ°æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚è¿™å¾—ç›ŠäºKube-dnsï¼Œå…·ä½“çš„æ ¼å¼ä¸ºï¼š<strong><code>&lt;service_name&gt;.&lt;namespace&gt;.svc.&lt;cluster_domain&gt;</code></strong>å…¶ä¸­ï¼Œ<code>&lt;cluster_domain&gt;</code>é»˜è®¤å€¼ä¸º<code>cluster.local</code>ï¼Œå¯ä»¥é€šè¿‡kubeletçš„<code>--cluster-domain=SomeDomain</code>å‚æ•°è¿›è¡Œè®¾ç½®ã€‚ä¸ºäº†åœ¨Podä¸­è°ƒç”¨å…¶ä»–Serviceï¼Œkubeletä¼šè‡ªåŠ¨åœ¨å®¹å™¨ä¸­åˆ›å»ºåŸŸåè§£æé…ç½®ï¼š</p><p><img src="img/QQæˆªå›¾20191203150831.png" alt="QQæˆªå›¾20191203150831.png"></p><p>æ‰€ä»¥é™¤äº†ä½¿ç”¨<code>curl nginx-s:8080</code>è®¿é—®å¤–ï¼Œä»¥ä¸‹è¿™äº›ä¹Ÿæ˜¯ç­‰æ•ˆçš„ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl nginx-s.default:8080</span><br><span class="line"></span><br><span class="line">curl nginx-s.default.svc:8080</span><br><span class="line"></span><br><span class="line">curl nginx-s.default.svc.cluster.local:8080</span><br></pre></td></tr></table></figure><p></p><p>æ‰€ä»¥æˆ‘ä»¬ç°åœ¨å¯ä»¥ä¸ç”¨äº‹å…ˆçŸ¥é“Serviceçš„IPäº†ï¼Œåªè¦äº‹å…ˆçŸ¥é“ServiceNameå³å¯ï¼ˆServiceNameæ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ï¼‰ã€‚</p><p><strong>4.é€šè¿‡Headless Serviceï¼Œè¿”å›Podçš„æ‰€æœ‰å®ä¾‹ã€‚</strong></p><p>æœ‰æ—¶å€™æˆ‘ä»¬å¹¶ä¸éœ€è¦Serviceçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè€Œæ˜¯æ‰‹åŠ¨è·å–Serviceå¯¹åº”çš„Podå®ä¾‹ï¼Œè‡ªå·±å†³å®šå¦‚ä½•è®¿é—®ã€‚åˆ›å»ºä¸€ä¸ªHeadless Serviceé…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-headless-s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  clusterIP:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">web-app</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Headless Serviceï¼Œç„¶ååˆ°centos-podå®¹å™¨å†…éƒ¨æŸ¥è¯¢DNSè®°å½•ï¼š</p><p><img src="img/QQæˆªå›¾20191203153848.png" alt="QQæˆªå›¾20191203153848.png"></p><blockquote><p>å¦‚æœæ²¡æœ‰nslookupå‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨<code>yum -y install bind-utils</code>å‘½ä»¤å®‰è£…ã€‚</p></blockquote><p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡è§£ænginx-headless-s DNSï¼Œè¿”å›äº†ä¸‰ä¸ªNginx Podå®ä¾‹åœ°å€ã€‚</p><h2 id="é›†ç¾¤å¤–éƒ¨è®¿é—®å†…éƒ¨"><a href="#é›†ç¾¤å¤–éƒ¨è®¿é—®å†…éƒ¨" class="headerlink" title="é›†ç¾¤å¤–éƒ¨è®¿é—®å†…éƒ¨"></a>é›†ç¾¤å¤–éƒ¨è®¿é—®å†…éƒ¨</h2><p>1.PodæŒ‡å®šhostPortï¼Œæˆ–è€…å¼€å¯hostNetworkï¼Œè¿™æ ·å¤–éƒ¨å°±å¯ä»¥é€šè¿‡Podå®¿ä¸»æœºIP+Podç«¯å£è®¿é—®äº†ï¼Œä½†Podè°ƒåº¦çš„ä¸ç¡®å®šæ€§ï¼Œè¿™ç§æ–¹å¼ä¸æ¨èï¼›</p><p>2.é€šè¿‡Serviceçš„NodePortæš´éœ²æœåŠ¡ï¼Œå¦‚æœæœåŠ¡è¾ƒå¤šçš„è¯ä¸æ¨èï¼Œå› ä¸ºè¿™ç§æ–¹å¼ä¼šåœ¨é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šéƒ½æš´éœ²è¯¥ç«¯å£ï¼Œæ‰€ä»¥å½“æœåŠ¡å¤šçš„æ—¶å€™å¾ˆå®¹æ˜“é€ æˆç«¯å£å†²çªï¼Œå¹¶ä¸”ç«¯å£ç»´æŠ¤ä¸ä¾¿ï¼›</p><p>3.é€šè¿‡Ingressé›†ä¸­æš´éœ²æœåŠ¡ï¼Œè¦æš´éœ²çš„æœåŠ¡è¾ƒå¤šçš„æ—¶å€™æ¨èã€‚</p><p>è¿™ä¸‰ç§æ–¹å¼æ˜¯å‰é¢åšå®¢ä¸­éƒ½æœ‰ä»‹ç»åˆ°ï¼Œæ‰€ä»¥å°±ä¸èµ˜è¿°äº†ã€‚</p><h2 id="é›†ç¾¤å†…éƒ¨è®¿é—®å¤–éƒ¨"><a href="#é›†ç¾¤å†…éƒ¨è®¿é—®å¤–éƒ¨" class="headerlink" title="é›†ç¾¤å†…éƒ¨è®¿é—®å¤–éƒ¨"></a>é›†ç¾¤å†…éƒ¨è®¿é—®å¤–éƒ¨</h2><p>1.ç›´æ¥é€šè¿‡å¤–éƒ¨æœåŠ¡çš„IPå’Œç«¯å£è¿›è¡Œè®¿é—®ï¼›</p><p>2.é€šè¿‡Serviceå’ŒEndpointç»‘å®šï¼Œé›†ç¾¤å†…çš„æœåŠ¡é€šè¿‡DNSè®¿é—®é›†ç¾¤å¤–éƒ¨æœåŠ¡ï¼ˆæ¨èï¼‰ã€‚</p><p>åˆ›å»ºå¦‚ä¸‹é…ç½®ï¼ˆtest-remote.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">remote-s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">remote-s</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="attr">  - addresses:</span></span><br><span class="line"><span class="attr">      - ip:</span> <span class="number">192.168</span><span class="number">.73</span><span class="number">.42</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">      - port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><p></p><p>Serviceå’ŒEndpointsåç§°ä¸€æ ·ï¼Œæ‰€ä»¥ä»–ä»¬ä¼šç»‘å®šä¸Šï¼Œé€šè¿‡è®¿é—®remote-s Serviceä¾¿å¯ä»¥è®¿é—®åˆ°å¯¹åº”çš„Endpointåœ°å€192.168.73.42:8080æœåŠ¡ï¼ˆè¿™æ˜¯ä¸ªæˆ‘åœ¨é›†ç¾¤å¤–éƒ¨ï¼Œé€šè¿‡Spring Bootæ­å»ºçš„ç®€å•webæœåŠ¡ï¼‰ã€‚</p><p>è¿è¡Œè¯¥é…ç½®åï¼Œåœ¨masterèŠ‚ç‚¹ä¸Šï¼Œæµ‹è¯•æ˜¯å¦å¯ä»¥è®¿é—®ï¼š</p><p><img src="img/QQæˆªå›¾20191203165019.png" alt="QQæˆªå›¾20191203165019.png"></p><p>æˆ‘ä»¬è¿›åˆ°centos-podå®¹å™¨å†…éƒ¨ï¼Œé€šè¿‡æœåŠ¡åç§°çœ‹çœ‹æ˜¯å¦å¯ä»¥è®¿é—®åˆ°ï¼š</p><p><img src="img/QQæˆªå›¾20191203165144.png" alt="QQæˆªå›¾20191203165144.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™ç§æ–¹å¼ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ï¼Œæ¨èä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå¯ä»¥é™ä½è€¦åˆåº¦ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;KubernetesæœåŠ¡å‘ç°ä¸»è¦å¯ä»¥å½’ä¸ºä¸‰ç§æƒ…å½¢ï¼š1.Kubernetesé›†ç¾¤å†…éƒ¨é—´æœåŠ¡å¦‚ä½•äº’ç›¸é€šä¿¡ï¼›2.Kuberntesé›†ç¾¤å¤–éƒ¨å¦‚ä½•è®¿é—®é›†ç¾¤å†…éƒ¨æœåŠ¡ï¼›3.Kubernetesé›†ç¾¤å†…éƒ¨å¦‚ä½•è®¿é—®é›†ç¾¤å¤–éƒ¨æœåŠ¡ã€‚è¿™èŠ‚é’ˆå¯¹è¿™ä¸‰ç§æƒ…å†µåšä¸ªæ€»ç»“ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Ingress</title>
    <link href="http://mrbird.cc/Kubernetes-Ingress.html"/>
    <id>http://mrbird.cc/Kubernetes-Ingress.html</id>
    <published>2019-11-28T02:59:56.000Z</published>
    <updated>2020-01-21T03:30:03.134Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>åœ¨<a href="/Kubernetes-Service-Basic.html">Kubernetes ServiceåŸºç¡€</a>ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°å¯ä»¥é€šè¿‡è®¾ç½®Service NodePortå‘Kubernetesé›†ç¾¤å¤–éƒ¨æš´éœ²ç«¯å£ï¼Œå¤–éƒ¨æœåŠ¡å¯ä»¥é€šè¿‡Kubernetesé›†ç¾¤èŠ‚ç‚¹IP+NodePortè®¿é—®é›†ç¾¤å†…éƒ¨èµ„æºã€‚å½“é›†ç¾¤å†…éƒ¨æœåŠ¡ä¼—å¤šæ—¶ï¼Œéœ€è¦æš´éœ²çš„ç«¯å£ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šã€‚è¿™æ ·ä¸ä»…ç«¯å£ç»´æŠ¤å›°éš¾ï¼Œé›†ç¾¤è¾¹ç•Œä¹Ÿå˜å¾—â€œåƒç–®ç™¾å­”â€ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼ŒKubernetesæä¾›äº†Ingressæ¥è§£å†³ï¼ŒIngresså¯¹è±¡ç”¨äºé…ç½®å¤–éƒ¨è¯·æ±‚è½¬å‘åˆ°é›†ç¾¤å†…éƒ¨æœåŠ¡çš„å…·ä½“è§„åˆ™ï¼Œè€Œå®é™…çš„è½¬å‘æ“ä½œç”±Ingress Controlleræ¥å®Œæˆã€‚</p><a id="more"></a><p>å‡è®¾æˆ‘ä»¬çš„Kubernetesé›†ç¾¤ä¸­åˆ†åˆ«å­˜åœ¨2ä¸ªå®ä¾‹çš„tomcatå’Œnginx Deploymentï¼Œå¹¶ä¸”æœ‰å¯¹åº”çš„Serviceã€‚åŠ å…¥Ingressåï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„æœåŠ¡æš´éœ²æ–¹å¼ï¼š</p><p><img src="img/QQæˆªå›¾20191128181259.png" alt="QQæˆªå›¾20191128181259.png"></p><h2 id="Ingress-Controller"><a href="#Ingress-Controller" class="headerlink" title="Ingress Controller"></a>Ingress Controller</h2><p>Ingress Controllerå¹¶ä¸æ˜¯Kuberneteså¯¹è±¡ï¼Œè€Œæ˜¯æ ¹æ®Ingresså¯¹è±¡é…ç½®ï¼Œå®ç°å…·ä½“è½¬å‘åŠŸèƒ½çš„ç»„ä»¶ç»Ÿç§°ã€‚é™¤äº†Kuberneteså®˜æ–¹ç»´æŠ¤çš„GCEå’ŒIngress Nginxå¤–ï¼Œè¿˜æœ‰è®¸å¤šç¬¬ä¸‰æ–¹ç»´æŠ¤çš„å®ç°ã€‚è¿™é‡Œä»¥ç”¨çš„è¾ƒå¤šçš„Ingress Nginxä¸ºä¾‹ï¼Œå®ç°Ingress Controllerçš„éƒ¨ç½²ã€‚</p><p>å› ä¸ºIngress Controlleræ˜¯ç”¨äºå¤„ç†é›†ç¾¤å¤–éƒ¨è¯·æ±‚è®¿é—®é›†ç¾¤å†…éƒ¨æœåŠ¡çš„ç»„ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ€è€ƒï¼Œå¦‚ä½•å°†Ingress Controlleræš´éœ²å‡ºå»ã€‚æœ€ä¸ºå¸¸è§çš„æ–¹å¼ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§ï¼š</p><ol><li><p>åˆ›å»ºå’ŒIntress Controllerå¯¹åº”çš„ServiceæœåŠ¡ï¼ŒServiceé€šè¿‡NodePortå°†æœåŠ¡ç«¯å£æš´éœ²å‡ºå»ï¼›</p></li><li><p>å°†Ingress Controlleréƒ¨ç½²åˆ°å‡ ä¸ª<strong>å›ºå®š</strong>çš„èŠ‚ç‚¹ä¸Šï¼Œç„¶åé€šè¿‡HostPortå°†ç«¯å£æ˜ å°„å‡ºå»ï¼Œæœ€å¤–å±‚é€šè¿‡LVS+keepaliveå®ç°è´Ÿè½½å‡è¡¡ã€‚</p></li></ol><p>å› ä¸ºç¬¬1ç§æ–¹å¼éœ€è¦åœ¨è¯·æ±‚é“¾è·¯ä¸­å†åŠ ä¸€å±‚ServiceæœåŠ¡ï¼Œæ€§èƒ½å¯èƒ½ä¼šæœ‰è€—æŸï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©ç¬¬2ç§æ–¹å¼ã€‚</p><p>ä¸ºäº†ç®€åŒ–è¿‡ç¨‹ï¼Œè¿™é‡Œåªåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šéƒ¨ç½²Ingress Controllerï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€‰æ‹©åœ¨Node1èŠ‚ç‚¹ä¸Šéƒ¨ç½²ã€‚ç»™Node1èŠ‚ç‚¹æ‰“ä¸ªæ ‡ç­¾ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node node1 <span class="built_in">type</span>=<span class="string">"ingress"</span></span><br></pre></td></tr></table></figure><p>ä¸‹è½½Ingress Nginxé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹è¯¥é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi mandatory.yaml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹éƒ¨åˆ†å¦‚ä¸‹æ‰€ç¤º:</p><p><img src="img/QQæˆªå›¾20191128184352.png" alt="QQæˆªå›¾20191128184352.png"></p><p>åˆ›å»ºè¯¥é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f mandatory.yaml</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191128184513.png" alt="QQæˆªå›¾20191128184513.png"></p><p>æŸ¥çœ‹æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š</p><p><img src="img/QQæˆªå›¾20191128184723.png" alt="QQæˆªå›¾20191128184723.png"></p><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="http://192.168.33.12/" target="_blank" rel="noopener">http://192.168.33.12/</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191129091742.png" alt="QQæˆªå›¾20191128190016.png"></p><p>å› ä¸ºè¿˜æ²¡æœ‰åˆ›å»ºIngressï¼Œæ‰€ä»¥é¡µé¢å“åº”æš‚æ—¶ä¸º404ã€‚</p><h2 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h2><p>åœ¨åˆ›å»ºIngresså¯¹è±¡å‰ï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡å¥½tomcatå’ŒnginxæœåŠ¡ï¼Œä¾›å¾…ä¼šæ¼”ç¤ºï¼Œåˆ›å»ºdemo.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          image:</span> <span class="attr">tomcat:8.0.51-alpine</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f demo.yml</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191128191135.png" alt="QQæˆªå›¾20191128191135.png"></p><p>æŸ¥çœ‹æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š</p><p><img src="img/QQæˆªå›¾20191128191253.png" alt="QQæˆªå›¾20191128191253.png"></p><p>æ¥ç€åˆ›å»ºIngressé…ç½®æ–‡ä»¶ï¼ˆingress.ymlï¼‰:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">    - host:</span> <span class="string">tomcat.mrbird.cc</span></span><br><span class="line"><span class="attr">      http:</span></span><br><span class="line"><span class="attr">        paths:</span></span><br><span class="line"><span class="attr">          - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">            backend:</span></span><br><span class="line"><span class="attr">              serviceName:</span> <span class="string">tomcat-service</span></span><br><span class="line"><span class="attr">              servicePort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">    - host:</span> <span class="string">nginx.mrbird.cc</span></span><br><span class="line"><span class="attr">      http:</span></span><br><span class="line"><span class="attr">        paths:</span></span><br><span class="line"><span class="attr">          - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">            backend:</span></span><br><span class="line"><span class="attr">              serviceName:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">              servicePort:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure><p></p><p>æ ¹æ®ä¸Šè¿°é…ç½®ï¼Œå½“æˆ‘ä»¬è®¿é—®tomcat.mrbird.ccæ ¹è·¯å¾„çš„æ—¶å€™ï¼Œè¯·æ±‚å°†è½¬å‘åˆ°åç§°ä¸ºtomcat-serviceï¼Œç«¯å£ä¸º8080çš„serviceä¸Šï¼Œæ ¹æ®ä¸Šé¢demo.ymlçš„é…ç½®ï¼Œè¯¥serviceå¯¹åº”ä¸¤ä¸ªtomcat podï¼›è®¿é—®nginx.mrbird.ccæ ¹è·¯å¾„çš„æ—¶å€™ï¼Œè¯·æ±‚å°†è½¬å‘åˆ°nginx-serviceã€‚</p><p>åˆ›å»ºè¯¥Ingressï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f ingress.yml</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191129094819.png" alt="QQæˆªå›¾20191129094819.png"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå½“æˆ‘ä»¬è®¿é—®tomcat.mrbird.cc/çš„æ—¶å€™ï¼Œè¯·æ±‚ä¼šå‡è¡¡åœ°è½¬å‘åˆ°10.244.1.10:8080/å’Œ10.244.2.15:8080/ã€‚</p><p>åœ¨Windowsä¸Šé…ç½®hostsåŸŸåè§£æï¼š</p><p><img src="img/QQæˆªå›¾20191129095034.png" alt="QQæˆªå›¾20191129095034.png"></p><p>æµè§ˆå™¨è®¿é—®<a href="http://tomcat.mrbird.cc/" target="_blank" rel="noopener">http://tomcat.mrbird.cc/</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191129095222.png" alt="QQæˆªå›¾20191129095222.png"></p><p>è®¿é—®<a href="http://nginx.mrbird.cc/" target="_blank" rel="noopener">http://nginx.mrbird.cc/</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191129095333.png" alt="QQæˆªå›¾20191129095333.png"></p><p>ç»“æœç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p><p>Ingress Nginxå®è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªnginxæœåŠ¡ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨é€šè¿‡æˆ‘ä»¬çš„Ingressé…ç½®ï¼Œç”Ÿæˆç›¸åº”çš„nginxé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥åˆ°Ingress Nginxå®¹å™¨å†…éƒ¨è¯å®è¿™ä¸€ç‚¹:</p><p><img src="img/QQæˆªå›¾20191129100835.png" alt="QQæˆªå›¾20191129100835.png"></p><p>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™äº›é…ç½®ï¼ˆä»…æˆªå–tomcat.mrbird.ccé…ç½®ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">## start server tomcat.mrbird.cc</span><br><span class="line">server &#123;</span><br><span class="line">        server_name tomcat.mrbird.cc ;</span><br><span class="line"></span><br><span class="line">        listen 80  ;</span><br><span class="line">        listen [::]:80  ;</span><br><span class="line">        listen 443  ssl http2 ;</span><br><span class="line">        listen [::]:443  ssl http2 ;</span><br><span class="line"></span><br><span class="line">        set $proxy_upstream_name &quot;-&quot;;</span><br><span class="line"></span><br><span class="line">        ssl_certificate_by_lua_block &#123;</span><br><span class="line">                certificate.call()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line"></span><br><span class="line">                set $namespace      &quot;default&quot;;</span><br><span class="line">                set $ingress_name   &quot;ingress&quot;;</span><br><span class="line">                set $service_name   &quot;tomcat-service&quot;;</span><br><span class="line">                set $service_port   &quot;8080&quot;;</span><br><span class="line">                set $location_path  &quot;/&quot;;</span><br><span class="line"></span><br><span class="line">                rewrite_by_lua_block &#123;</span><br><span class="line">                        lua_ingress.rewrite(&#123;</span><br><span class="line">                                force_ssl_redirect = false,</span><br><span class="line">                                ssl_redirect = true,</span><br><span class="line">                                force_no_ssl_redirect = false,</span><br><span class="line">                                use_port_in_redirects = false,</span><br><span class="line">                        &#125;)</span><br><span class="line">                        balancer.rewrite()</span><br><span class="line">                        plugins.run()</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                header_filter_by_lua_block &#123;</span><br><span class="line"></span><br><span class="line">                        plugins.run()</span><br><span class="line">                &#125;</span><br><span class="line">                body_filter_by_lua_block &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                log_by_lua_block &#123;</span><br><span class="line"></span><br><span class="line">                        balancer.log()</span><br><span class="line"></span><br><span class="line">                        monitor.call()</span><br><span class="line"></span><br><span class="line">                        plugins.run()</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                port_in_redirect off;</span><br><span class="line"></span><br><span class="line">                set $balancer_ewma_score -1;</span><br><span class="line">                set $proxy_upstream_name &quot;default-tomcat-service-8080&quot;;</span><br><span class="line">                set $proxy_host          $proxy_upstream_name;</span><br><span class="line">                set $pass_access_scheme  $scheme;</span><br><span class="line">                set $pass_server_port    $server_port;</span><br><span class="line">                set $best_http_host      $http_host;</span><br><span class="line">                set $pass_port           $pass_server_port;</span><br><span class="line"></span><br><span class="line">                set $proxy_alternative_upstream_name &quot;&quot;;</span><br><span class="line"></span><br><span class="line">                client_max_body_size                    1m;</span><br><span class="line"></span><br><span class="line">                proxy_set_header Host                   $best_http_host;</span><br><span class="line"></span><br><span class="line">                # Pass the extracted client certificate to the backend</span><br><span class="line"></span><br><span class="line">                # Allow websocket connections</span><br><span class="line">                proxy_set_header                        Upgrade           $http_upgrade;</span><br><span class="line"></span><br><span class="line">                proxy_set_header                        Connection        $connection_upgrade;</span><br><span class="line"></span><br><span class="line">                proxy_set_header X-Request-ID           $req_id;</span><br><span class="line">                proxy_set_header X-Real-IP              $remote_addr;</span><br><span class="line"></span><br><span class="line">                proxy_set_header X-Forwarded-For        $remote_addr;</span><br><span class="line"></span><br><span class="line">                proxy_set_header X-Forwarded-Host       $best_http_host;</span><br><span class="line">                proxy_set_header X-Forwarded-Port       $pass_port;</span><br><span class="line">                proxy_set_header X-Forwarded-Proto      $pass_access_scheme;</span><br><span class="line"></span><br><span class="line">                proxy_set_header X-Scheme               $pass_access_scheme;</span><br><span class="line"></span><br><span class="line">                # Pass the original X-Forwarded-For</span><br><span class="line">                proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">                # mitigate HTTPoxy Vulnerability</span><br><span class="line">                # https://www.nginx.com/blog/mitigating-the-httpoxy-vulnerability-with-nginx/</span><br><span class="line">                proxy_set_header Proxy                  &quot;&quot;;</span><br><span class="line"></span><br><span class="line">                # Custom headers to proxied server</span><br><span class="line"></span><br><span class="line">                proxy_connect_timeout                   5s;</span><br><span class="line">                proxy_send_timeout                      60s;</span><br><span class="line">                proxy_read_timeout                      60s;</span><br><span class="line"></span><br><span class="line">                proxy_buffering                         off;</span><br><span class="line">                proxy_buffer_size                       4k;</span><br><span class="line">                proxy_buffers                           4 4k;</span><br><span class="line"></span><br><span class="line">                proxy_max_temp_file_size                1024m;</span><br><span class="line"></span><br><span class="line">                proxy_request_buffering                 on;</span><br><span class="line">                proxy_http_version                      1.1;</span><br><span class="line"></span><br><span class="line">                proxy_cookie_domain                     off;</span><br><span class="line">                proxy_cookie_path                       off;</span><br><span class="line"></span><br><span class="line">                # In case of errors try the next upstream server before returning an error</span><br><span class="line">                proxy_next_upstream                     error timeout;</span><br><span class="line">                proxy_next_upstream_timeout             0;</span><br><span class="line">                proxy_next_upstream_tries               3;</span><br><span class="line"></span><br><span class="line">                proxy_pass http://upstream_balancer;</span><br><span class="line"></span><br><span class="line">                proxy_redirect                          off;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">## end server tomcat.mrbird.cc</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p></p><p>æ›´å¤šIngressé…ç½®å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://v1-12.docs.kubernetes.io/zh/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener">https://v1-12.docs.kubernetes.io/zh/docs/concepts/services-networking/ingress/</a>ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨&lt;a href=&quot;/Kubernetes-Service-Basic.html&quot;&gt;Kubernetes ServiceåŸºç¡€&lt;/a&gt;ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°å¯ä»¥é€šè¿‡è®¾ç½®Service NodePortå‘Kubernetesé›†ç¾¤å¤–éƒ¨æš´éœ²ç«¯å£ï¼Œå¤–éƒ¨æœåŠ¡å¯ä»¥é€šè¿‡Kubernetesé›†ç¾¤èŠ‚ç‚¹IP+NodePortè®¿é—®é›†ç¾¤å†…éƒ¨èµ„æºã€‚å½“é›†ç¾¤å†…éƒ¨æœåŠ¡ä¼—å¤šæ—¶ï¼Œéœ€è¦æš´éœ²çš„ç«¯å£ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šã€‚è¿™æ ·ä¸ä»…ç«¯å£ç»´æŠ¤å›°éš¾ï¼Œé›†ç¾¤è¾¹ç•Œä¹Ÿå˜å¾—â€œåƒç–®ç™¾å­”â€ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼ŒKubernetesæä¾›äº†Ingressæ¥è§£å†³ï¼ŒIngresså¯¹è±¡ç”¨äºé…ç½®å¤–éƒ¨è¯·æ±‚è½¬å‘åˆ°é›†ç¾¤å†…éƒ¨æœåŠ¡çš„å…·ä½“è§„åˆ™ï¼Œè€Œå®é™…çš„è½¬å‘æ“ä½œç”±Ingress Controlleræ¥å®Œæˆã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes StatefulSet</title>
    <link href="http://mrbird.cc/Kubernetes-StatefulSet.html"/>
    <id>http://mrbird.cc/Kubernetes-StatefulSet.html</id>
    <published>2019-11-27T01:17:47.000Z</published>
    <updated>2020-01-21T03:30:03.135Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>å‰é¢ä»‹ç»çš„Podç®¡ç†å¯¹è±¡ï¼Œå¦‚RC/RSã€Deploymentã€DaemonSetç­‰éƒ½æ˜¯é¢å‘æ— çŠ¶æ€æœåŠ¡çš„ï¼Œè€Œå¯¹äºæœ‰çŠ¶æ€çš„åº”ç”¨ï¼Œæ¯”å¦‚MySQLé›†ç¾¤ï¼ŒMongoDBé›†ç¾¤ç­‰ï¼Œåˆ™å¯ä»¥ä½¿ç”¨StatefulSetæ¥å®Œæˆã€‚æœ‰çŠ¶æ€çš„åº”ç”¨é›†ç¾¤é€šå¸¸æœ‰ä»¥ä¸‹è¿™äº›ç‰¹ç‚¹ï¼š</p><ol><li><p>æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å›ºå®šçš„èº«ä»½IDï¼Œé€šè¿‡è¿™ä¸ªIDï¼Œé›†ç¾¤ä¸­çš„æˆå‘˜å¯ä»¥ç›¸äº’å‘ç°å¹¶é€šä¿¡ï¼›</p></li><li><p>é›†ç¾¤çš„è§„æ¨¡æ˜¯æ¯”è¾ƒå›ºå®šçš„ï¼Œé›†ç¾¤è§„æ¨¡ä¸èƒ½éšæ„å˜åŠ¨ï¼›</p></li><li><p>é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯æœ‰çŠ¶æ€çš„ï¼Œé€šå¸¸ä¼šæŒä¹…åŒ–æ•°æ®åˆ°æ°¸ä¹…å­˜å‚¨ä¸­ã€‚</p></li></ol><a id="more"></a><h2 id="StatefulSetç‰¹æ€§"><a href="#StatefulSetç‰¹æ€§" class="headerlink" title="StatefulSetç‰¹æ€§"></a>StatefulSetç‰¹æ€§</h2><p>é€šè¿‡StatefulSetæ­å»ºçš„é›†ç¾¤é€šå¸¸æœ‰ä»¥ä¸‹è¿™äº›ç‰¹æ€§ï¼š</p><ol><li><p>StatefulSeté‡Œçš„æ¯ä¸ªPodéƒ½æœ‰ç¨³å®šã€å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ï¼Œå¯ä»¥ç”¨æ¥å‘ç°é›†ç¾¤å†…çš„å…¶ä»–æˆå‘˜ã€‚å‡è®¾StatefulSetçš„åç§°ä¸ºnginxï¼Œé‚£ä¹ˆç¬¬1ä¸ªPodå«nginx-0ï¼Œç¬¬2ä¸ªå«nginx-1ï¼Œä»¥æ­¤ç±»æ¨ï¼›</p></li><li><p>StatefulSetæ§åˆ¶çš„Podå‰¯æœ¬çš„å¯åœé¡ºåºæ˜¯å—æ§çš„ï¼Œæ“ä½œç¬¬nä¸ªPodæ—¶ï¼Œå‰n-1ä¸ªPodå·²ç»æ˜¯è¿è¡Œä¸”å‡†å¤‡å¥½çš„çŠ¶æ€ã€‚</p></li><li><p>StatefulSeté‡Œçš„Podé‡‡ç”¨ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨å·ï¼Œé€šè¿‡PVæˆ–PVCæ¥å®ç°ï¼Œåˆ é™¤Podæ—¶é»˜è®¤ä¸ä¼šåˆ é™¤ä¸StatefulSetç›¸å…³çš„å­˜å‚¨å·ï¼ˆä¸ºäº†ä¿è¯æ•°æ®çš„å®‰å…¨ï¼‰ï¼›</p></li><li><p>é…åˆHeadless Serviceä½¿ç”¨ï¼Œç”¨äºå‘ç°å’Œæ§åˆ¶Podå®ä¾‹æ•°é‡ã€‚</p></li></ol><h2 id="StatefulSetå®è·µ"><a href="#StatefulSetå®è·µ" class="headerlink" title="StatefulSetå®è·µ"></a>StatefulSetå®è·µ</h2><p>ä¸‹é¢ä½¿ç”¨StatefulSetæ­å»ºä¸ªNginxé›†ç¾¤ï¼ŒæŒä¹…åŒ–å­˜å‚¨ä½¿ç”¨ä¸Šä¸€èŠ‚æ­å»ºçš„åç§°ä¸º<strong>managed-nfs-storage</strong>çš„StorageClassã€‚</p><p>åˆ›å»ºnginx-headless-service.ymlé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  clusterIP:</span> <span class="string">None</span> <span class="comment"># è¡¨æ˜ä¸ºHeadleass Service</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    role:</span> <span class="string">web-app</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Headless Serviceï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx-headless-service.yml</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€åˆ›å»ºnginx-statefulset.ymlé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-sc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">"nginx"</span> <span class="comment"># å¯¹åº”åˆšåˆšåˆ›å»ºçš„Headless Serviceåç§°</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      role:</span> <span class="string">web-app</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        role:</span> <span class="string">web-app</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">nginx-persistent-storage</span> <span class="comment"># å’Œä¸‹é¢çš„pvcåç§°å¯¹åº”</span></span><br><span class="line"><span class="attr">  volumeClaimTemplates:</span> <span class="comment"># pvcæ¨¡æ¿</span></span><br><span class="line"><span class="attr">    - metadata:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx-persistent-storage</span> <span class="comment"># pvcåç§°</span></span><br><span class="line"><span class="attr">      spec:</span></span><br><span class="line"><span class="attr">        storageClassName:</span> <span class="string">managed-nfs-storage</span> <span class="comment"># æŒ‡å®šStorageClassåç§°</span></span><br><span class="line"><span class="attr">        accessModes:</span> <span class="string">["ReadWriteMany"]</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            storage:</span> <span class="number">100</span><span class="string">Mi</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥StatefulSetï¼Œè§‚å¯Ÿpodçš„åˆ›å»ºè¿‡ç¨‹ï¼š</p><p><img src="img/QQæˆªå›¾20191127163115.png" alt="QQæˆªå›¾20191127163115.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œpodçš„åˆ›å»ºæ˜¯ä¸¥æ ¼one by oneçš„ï¼Œå› ä¸ºæˆ‘ä»¬å®šä¹‰çš„StatefulSetçš„åç§°ä½nginx-scï¼Œæ‰€ä»¥Podçš„åç§°åˆ†åˆ«ä½nginx-sc-0ã€nginx-sc-1å’Œnginx-sc-2ã€‚</p><p>æŸ¥çœ‹å¯¹åº”çš„PVCå’ŒPVï¼š</p><p><img src="img/QQæˆªå›¾20191127163428.png" alt="QQæˆªå›¾20191127163428.png"></p><p>çŠ¶æ€ä¸ºBoundã€‚</p><p>åˆ é™¤Podï¼Œå†æ¬¡è§‚å¯ŸPodçš„åˆ›å»ºè¿‡ç¨‹ï¼š</p><p><img src="img/QQæˆªå›¾20191127172411.png" alt="QQæˆªå›¾20191127172411.png"></p><p>å¯ä»¥çœ‹åˆ°é¡ºåºæ€§æ˜¯ä¸¥æ ¼ä¿è¯çš„ã€‚</p><p>è¿›å…¥åˆ°Podå†…éƒ¨ï¼ŒæŸ¥çœ‹å…¶hostnameï¼š</p><p><img src="img/QQæˆªå›¾20191127172632.png" alt="QQæˆªå›¾20191127172632.png"></p><p>hostnameå’Œpodåç§°ä¸€è‡´ã€‚</p><p>åˆ°192.168.33.13çš„/nfsç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°æŒ‚è½½äº†ä¸‰ä¸ªnginxç›®å½•ï¼š</p><p><img src="img/QQæˆªå›¾20191127172826.png" alt="QQæˆªå›¾20191127172826.png"></p><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;å‰é¢ä»‹ç»çš„Podç®¡ç†å¯¹è±¡ï¼Œå¦‚RC/RSã€Deploymentã€DaemonSetç­‰éƒ½æ˜¯é¢å‘æ— çŠ¶æ€æœåŠ¡çš„ï¼Œè€Œå¯¹äºæœ‰çŠ¶æ€çš„åº”ç”¨ï¼Œæ¯”å¦‚MySQLé›†ç¾¤ï¼ŒMongoDBé›†ç¾¤ç­‰ï¼Œåˆ™å¯ä»¥ä½¿ç”¨StatefulSetæ¥å®Œæˆã€‚æœ‰çŠ¶æ€çš„åº”ç”¨é›†ç¾¤é€šå¸¸æœ‰ä»¥ä¸‹è¿™äº›ç‰¹ç‚¹ï¼š&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å›ºå®šçš„èº«ä»½IDï¼Œé€šè¿‡è¿™ä¸ªIDï¼Œé›†ç¾¤ä¸­çš„æˆå‘˜å¯ä»¥ç›¸äº’å‘ç°å¹¶é€šä¿¡ï¼›&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;é›†ç¾¤çš„è§„æ¨¡æ˜¯æ¯”è¾ƒå›ºå®šçš„ï¼Œé›†ç¾¤è§„æ¨¡ä¸èƒ½éšæ„å˜åŠ¨ï¼›&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯æœ‰çŠ¶æ€çš„ï¼Œé€šå¸¸ä¼šæŒä¹…åŒ–æ•°æ®åˆ°æ°¸ä¹…å­˜å‚¨ä¸­ã€‚&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
      <category term="MongoDB" scheme="http://mrbird.cc/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes StorageClasså®è·µ</title>
    <link href="http://mrbird.cc/Kubernetes-StorageClass-Practice.html"/>
    <id>http://mrbird.cc/Kubernetes-StorageClass-Practice.html</id>
    <published>2019-11-26T06:51:06.000Z</published>
    <updated>2020-01-21T03:30:03.135Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>æ‰‹åŠ¨åˆ›å»ºPVä¸ä»…ç¹çï¼Œè¿˜å¯èƒ½é€ æˆèµ„æºæµªè´¹ã€‚æ¯”å¦‚æŸä¸ªPVå®šä¹‰çš„å­˜å‚¨ç©ºé—´ä¸º10Giï¼Œè¯¥PVè¢«æŸä¸ªå£°æ˜éœ€è¦8Giå†…å­˜çš„PVCç»‘å®šä¸Šäº†ï¼Œè¿™æ—¶å€™è¯¥PVå¤„äºBoundçŠ¶æ€ï¼Œæ— æ³•å†å’Œåˆ«çš„PVCè¿›è¡Œç»‘å®šï¼ŒPVä¸Šå‰©ä¸‹çš„2Giå†…å­˜å®é™…ä¸Šæµªè´¹çš„ã€‚StorageClasså¯ä»¥æ ¹æ®PVCçš„å£°æ˜ï¼ŒåŠ¨æ€åˆ›å»ºå¯¹åº”çš„PVï¼Œè¿™æ ·ä¸ä»…çœå»äº†åˆ›å»ºPVçš„è¿‡ç¨‹ï¼Œè¿˜å®ç°äº†å­˜å‚¨èµ„æºçš„åŠ¨æ€ä¾›åº”ã€‚</p><a id="more"></a><h2 id="StorageClassæ„æˆ"><a href="#StorageClassæ„æˆ" class="headerlink" title="StorageClassæ„æˆ"></a>StorageClassæ„æˆ</h2><p>StorageClassçš„å®šä¹‰ä¸»è¦åŒ…æ‹¬åç§°ã€åç«¯å­˜å‚¨çš„æä¾›è€…ï¼ˆprovisionerï¼‰å’Œåç«¯å­˜å‚¨çš„ç›¸å…³å‚æ•°é…ç½®ã€‚StorageClassä¸€æ—¦è¢«åˆ›å»ºå‡ºæ¥ï¼Œåˆ™å°†æ— æ³•ä¿®æ”¹ã€‚å¦‚éœ€æ›´æ”¹ï¼Œåˆ™åªèƒ½åˆ é™¤åŸStorageClassçš„å®šä¹‰é‡å»ºã€‚</p><p>ä¸¾ä¸ªç®€å•çš„StorageClassé…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">managed-nfs-storage</span> <span class="comment"># StorageClassåç§°</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span>  <span class="comment"># æŒ‡å®šå…·ä½“å­˜å‚¨çš„æä¾›è€…</span></span><br><span class="line"><span class="attr">parameters:</span> <span class="comment"># åç«¯å­˜å‚¨ç›¸å…³å‚æ•°é…ç½®</span></span><br><span class="line"><span class="attr">  archiveOnDelete:</span> <span class="string">"false"</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸åŒçš„StorageClassä¸»è¦åŒºåˆ«åœ¨äºï¼šä¸åŒçš„å­˜å‚¨æä¾›è€…éœ€è¦å¡«å†™ä¸åŒçš„å‚æ•°é…ç½®ï¼Œä¸‹é¢å®ç°ä¸ªNFSä½œä¸ºåŠ¨æ€StorageClasså­˜å‚¨çš„ä¾‹å­ã€‚</p><h2 id="åŸºäºNFSå­˜å‚¨ç±»å‹çš„å®è·µ"><a href="#åŸºäºNFSå­˜å‚¨ç±»å‹çš„å®è·µ" class="headerlink" title="åŸºäºNFSå­˜å‚¨ç±»å‹çš„å®è·µ"></a>åŸºäºNFSå­˜å‚¨ç±»å‹çš„å®è·µ</h2><p>NFSç¯å¢ƒåœ¨ä¸Šä¸€èŠ‚å·²ç»æ­å»ºå¥½äº†ï¼ŒIPä¸º192.168.33.13ï¼Œè·¯å¾„ä¸º/nfsã€‚</p><p>åœ¨masterèŠ‚ç‚¹ä¸Šå…‹éš†ç›¸å…³ä»£ç ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/kubernetes-incubator/external-storage.git</span><br></pre></td></tr></table></figure><p></p><p>åˆ‡æ¢åˆ°<code>external-storage/nfs-client/deployç›®å½•</code>ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> external-storage/nfs-client/deploy</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºRBACï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f rbac.yml</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191126155024.png" alt="QQæˆªå›¾20191126155024.png"></p><p>æ¥ç€éƒ¨ç½²NFS Client Provisionerï¼Œéƒ¨ç½²å‰ä¿®æ”¹deployment.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">Recreate</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">nfs-client-root</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">mrbird.cc/nfs</span> <span class="comment"># åç§°éšä½ å®šä¹‰</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line"><span class="attr">              value:</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.13</span> <span class="comment"># NFS æœåŠ¡IP</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">NFS_PATH</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">/nfs</span> <span class="comment"># NFS ç›®å½•</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs-client-root</span></span><br><span class="line"><span class="attr">          nfs:</span></span><br><span class="line"><span class="attr">            server:</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.13</span> <span class="comment"># NFS æœåŠ¡IP</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/nfs</span> <span class="comment"># NFS ç›®å½•</span></span><br></pre></td></tr></table></figure><p></p><p>ç„¶ååˆ›å»ºè¯¥deploymentï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f deployment.yml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹class.yamlé…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">managed-nfs-storage</span> <span class="comment"># StorageClassåç§°ï¼Œéšä½ å®šä¹‰</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">mrbird.cc/nfs</span> <span class="comment"># å’Œä¸Šé¢deploymenté‡Œå®šä¹‰çš„ä¸€è‡´</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  archiveOnDelete:</span> <span class="string">"false"</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¿™ä¸ªStorageClassï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f class.yml</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191126160143.png" alt="QQæˆªå›¾20191126160143.png"></p><p>åˆ›å»ºPVCï¼ŒPVCçš„å®šä¹‰å¯¹åº”test-claim.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">managed-nfs-storage</span> <span class="comment"># æŒ‡å®šStorageClassåç§°ï¼Œå³æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„StorageClass</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span> </span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">1</span><span class="string">Mi</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¿™ä¸ªPVC:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f <span class="built_in">test</span>-claim.yml</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191126160628.png" alt="QQæˆªå›¾20191126160628.png"></p><p>çŠ¶æ€ä¸ºBoundï¼Œè¯´æ˜å·²ç»æˆåŠŸç»‘å®šä¸Šäº†å­˜å‚¨ã€‚</p><p>æŸ¥çœ‹PVï¼Œä¼šçœ‹åˆ°ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºäº†PVï¼š <img src="img/QQæˆªå›¾20191126161957.png" alt="QQæˆªå›¾20191126161957.png"></p><p>è‡ªåŠ¨åˆ›å»ºçš„PVåç§°ä¸ºpvc-3b8c5364-aadb-4b07-a3b5-fddad280fc98ã€‚</p><p>æœ€åï¼Œä¿®æ”¹test-pod.ymlé…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">test-pod</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">busybox</span> <span class="comment"># ä¿®æ”¹ä¸ºè¿™ä¸ªï¼ŒåŸå…ˆçš„é•œåƒåœ°å€éœ€è¦ç§‘å­¦ä¸Šç½‘</span></span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"/bin/sh"</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"-c"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line"><span class="attr">    volumeMounts:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nfs-pvc</span></span><br><span class="line"><span class="attr">        mountPath:</span> <span class="string">"/mnt"</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">"Never"</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nfs-pvc</span></span><br><span class="line"><span class="attr">      persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">        claimName:</span> <span class="string">test-claim</span> <span class="comment"># æŒ‡å®šPVCåç§°ï¼Œå¯¹åº”ä¸Šé¢åˆ›å»ºçš„PVC</span></span><br></pre></td></tr></table></figure><p></p><p>è¯¥Podä¸»è¦å°±æ˜¯é€šè¿‡busyboxåœ¨/mntç›®å½•ä¸‹åˆ›å»ºäº†ä¸ªSUCCESSæ–‡ä»¶ã€‚</p><p>åˆ›å»ºè¯¥Podï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f <span class="built_in">test</span>-pod.yml</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191126160933.png" alt="QQæˆªå›¾20191126160933.png"></p><p>çŠ¶æ€ä¸ºCompletedï¼Œè¯´æ˜busyboxæˆåŠŸæ‰§è¡Œå®Œäº†å‘½ä»¤å¹¶ç»“æŸäº†ã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œåœ¨192.168.33.13çš„/nfsç›®å½•ä¸‹ä¼šçœ‹åˆ°busybox podåˆ›å»ºçš„SUCCESSæ–‡ä»¶:</p><p><img src="img/QQæˆªå›¾20191126161215.png" alt="QQæˆªå›¾20191126161215.png"></p><p>å¯ä»¥çœ‹åˆ°/nfsç›®å½•ä¸‹æ–°å¢äº†ä¸€ä¸ªç›®å½•ï¼Œç›®å½•åç§°æ ¼å¼ä¸ºï¼š[namespace]-[pvcåç§°]-[pvåç§°]ã€‚</p><p>æˆ‘ä»¬è¿˜å¯ä»¥ç©ä¸€ä¸‹å¦ä¸€ä¸ªæµ‹è¯•ï¼Œæ–°å»ºä¸€ä¸ªtest-pod-rc.ymlæ–‡ä»¶ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span> <span class="comment"># å‰¯æœ¬æ•°ä¸º2ï¼Œä¸ºäº†æµ‹è¯•å…±äº«å­˜å‚¨</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">          command:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">sh</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">-c</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">'while true; do sleep $(($RANDOM % 5 + 5)); done'</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">"/mnt"</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">          persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">            claimName:</span> <span class="string">test-claim</span> <span class="comment"># æŒ‡å®šPVCåç§°ï¼Œå¯¹åº”ä¸Šé¢åˆ›å»ºçš„PVC</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢busyboxåšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œå°±æ˜¯æ— é™æœŸä¼‘çœ ã€‚åˆ›å»ºè¯¥rcï¼š</p><p><img src="img/QQæˆªå›¾20191126164355.png" alt="QQæˆªå›¾20191126164355.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œpodåˆ†åˆ«éƒ¨ç½²åˆ°äº†node1å’Œnode2ä¸Šã€‚åˆ°node1èŠ‚ç‚¹ä¸Šï¼Œè¿›å…¥busyboxå®¹å™¨å†…éƒ¨çš„/mntç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªhelloæ–‡ä»¶ï¼š</p><p><img src="img/QQæˆªå›¾20191126164821.png" alt="QQæˆªå›¾20191126164821.png"></p><p>ç„¶ååˆ°node2èŠ‚ç‚¹ä¸Šï¼Œè¿›å…¥busyboxå®¹å™¨å†…éƒ¨/mntç›®å½•ï¼Œè§‚å¯Ÿåˆšåˆšåœ¨node1èŠ‚ç‚¹busyboxå®¹å™¨å†…éƒ¨åˆ›å»ºçš„helloæ–‡ä»¶æ˜¯å¦å·²ç»åŒæ­¥è¿‡æ¥äº†ï¼š</p><p><img src="img/QQæˆªå›¾20191126165107.png" alt="QQæˆªå›¾20191126165107.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ–‡ä»¶åŒæ­¥æˆåŠŸã€‚å¹¶ä¸”å‰é¢ä¾‹å­åˆ›å»ºSUCCESSä¹ŸåŒæ­¥è¿‡æ¥äº†ï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬æŒ‡å®šäº†åŒä¸€ä¸ªPVCã€‚</p><p>å›åˆ°NFSæœåŠ¡å™¨çš„/nfsç›®å½•ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°åˆšåˆšåˆ›å»ºçš„helloæ–‡ä»¶ï¼š</p><p><img src="img/QQæˆªå›¾20191126165229.png" alt="QQæˆªå›¾20191126165229.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;æ‰‹åŠ¨åˆ›å»ºPVä¸ä»…ç¹çï¼Œè¿˜å¯èƒ½é€ æˆèµ„æºæµªè´¹ã€‚æ¯”å¦‚æŸä¸ªPVå®šä¹‰çš„å­˜å‚¨ç©ºé—´ä¸º10Giï¼Œè¯¥PVè¢«æŸä¸ªå£°æ˜éœ€è¦8Giå†…å­˜çš„PVCç»‘å®šä¸Šäº†ï¼Œè¿™æ—¶å€™è¯¥PVå¤„äºBoundçŠ¶æ€ï¼Œæ— æ³•å†å’Œåˆ«çš„PVCè¿›è¡Œç»‘å®šï¼ŒPVä¸Šå‰©ä¸‹çš„2Giå†…å­˜å®é™…ä¸Šæµªè´¹çš„ã€‚StorageClasså¯ä»¥æ ¹æ®PVCçš„å£°æ˜ï¼ŒåŠ¨æ€åˆ›å»ºå¯¹åº”çš„PVï¼Œè¿™æ ·ä¸ä»…çœå»äº†åˆ›å»ºPVçš„è¿‡ç¨‹ï¼Œè¿˜å®ç°äº†å­˜å‚¨èµ„æºçš„åŠ¨æ€ä¾›åº”ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes PV/PVC</title>
    <link href="http://mrbird.cc/Kubernetes-PV-PVC.html"/>
    <id>http://mrbird.cc/Kubernetes-PV-PVC.html</id>
    <published>2019-11-25T01:02:49.000Z</published>
    <updated>2020-01-21T03:30:03.134Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>åœ¨Kubernetesä¸­ï¼Œæˆ‘ä»¬è™½ç„¶å¯ä»¥ä½¿ç”¨volumeå°†å®¹å™¨å†…ç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœºç›®å½•ä¸Šï¼Œä½†ç”±äºPodè°ƒåº¦çš„ä¸ç¡®å®šæ€§ï¼Œè¿™ç§æ•°æ®å­˜å‚¨æ–¹å¼æ˜¯ä¸ç‰¢é çš„ã€‚å¯¹äºæœ‰çŠ¶æ€çš„åº”ç”¨ï¼Œæˆ‘ä»¬å¸Œæœ›æ— è®ºPodè¢«è°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼Œå®ƒä»¬çš„æ•°æ®æ€»èƒ½å¤Ÿå®Œæ•´åœ°æ¢å¤ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±ä¸èƒ½ç”¨volumeæŒ‚è½½äº†ï¼Œè€Œåº”è¯¥ä½¿ç”¨â€œç½‘ç»œå…±äº«å­˜å‚¨â€ã€‚PV/PVCå°±æ˜¯ç”¨äºè§£å†³é—®é¢˜è€Œå­˜åœ¨çš„ï¼Œå®ƒä»¬å±è”½äº†åº•å±‚å­˜å‚¨å®ç°çš„ç»†èŠ‚ï¼Œä½¿å¾—æˆ‘ä»¬å¾ˆå®¹æ˜“ä¸Šæ‰‹ä½¿ç”¨ã€‚</p><a id="more"></a><h2 id="PV"><a href="#PV" class="headerlink" title="PV"></a>PV</h2><p>PersistentVolumeï¼ˆPVï¼‰æ˜¯å¯¹åº•å±‚ç½‘ç»œå…±äº«å­˜å‚¨çš„æŠ½è±¡ï¼Œå°†å…±äº«å­˜å‚¨å®šä¹‰ä¸ºä¸€ç§â€œèµ„æºâ€ï¼ŒKubernetesæ”¯æŒçš„PVç±»å‹å¦‚ä¸‹ï¼š</p><table><tr><th>ç±»å‹</th><th>æè¿°</th></tr><tr><td>AWSElasticBlockStore</td><td>AWSå…¬æœ‰äº‘æä¾›çš„ElasticBlockStore</td></tr><tr><td>AzureFile</td><td>Azureå…¬æœ‰äº‘æä¾›çš„File</td></tr><tr><td>AzureDisk</td><td>Azureå…¬æœ‰äº‘æä¾›çš„Disk</td></tr><tr><td>CephFS</td><td>ä¸€ç§å¼€æºå…±äº«å­˜å‚¨ç³»ç»Ÿ</td></tr><tr><td>FCï¼ˆFibre Channelï¼‰</td><td>å…‰çº¤å­˜å‚¨è®¾å¤‡</td></tr><tr><td>FlexVolume</td><td>ä¸€ç§æ’ä»¶å¼çš„å­˜å‚¨æœºåˆ¶</td></tr><tr><td>Flocker</td><td>ä¸€ç§å¼€æºå…±äº«å­˜å‚¨ç³»ç»Ÿ</td></tr><tr><td>GCEPersistentDisk</td><td>GCEå…¬æœ‰äº‘æä¾›çš„PersistentDisk</td></tr><tr><td>Glusterfs</td><td>ä¸€ç§å¼€æºå…±äº«å­˜å‚¨ç³»ç»Ÿ</td></tr><tr><td>HostPath</td><td>å®¿ä¸»æœºç›®å½•ï¼Œä»…ç”¨äºå•æœºæµ‹è¯•</td></tr><tr><td>iSCSI</td><td>iSCSIå­˜å‚¨è®¾å¤‡</td></tr><tr><td>Local</td><td>æœ¬åœ°å­˜å‚¨è®¾å¤‡ï¼Œä»Kubernetes 1.7ç‰ˆæœ¬å¼•å…¥ï¼Œåˆ°1.14ç‰ˆæœ¬æ—¶æ›´æ–°ä¸ºç¨³å®šç‰ˆï¼Œç›®å‰å¯ä»¥é€šè¿‡æŒ‡å®šå—ï¼ˆBlockï¼‰è®¾å¤‡æä¾›Local PVï¼Œæˆ–é€šè¿‡ç¤¾åŒºå¼€å‘çš„sig-storage-local-static-provisioneræ’ä»¶<a href="https://github.com/kubernetes-sigs/sigstorage-local-static-provisioner" target="_blank" rel="noopener">https://github.com/kubernetes-sigs/sigstorage-local-static-provisioner</a>æ¥ç®¡ç†Local PVçš„ç”Ÿå‘½å‘¨æœŸ</td></tr><tr><td>NFS</td><td>ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ</td></tr><tr><td>Portworx Volumes</td><td>Portworxæä¾›çš„å­˜å‚¨æœåŠ¡</td></tr><tr><td>Quobyte Volumes</td><td>Quobyteæä¾›çš„å­˜å‚¨æœåŠ¡</td></tr><tr><td>RBDï¼ˆCeph Block Deviceï¼‰</td><td>Cephå—å­˜å‚¨</td></tr><tr><td>ScaleIO Volumes</td><td>DellEMCçš„å­˜å‚¨è®¾å¤‡</td></tr><tr><td>StorageOS</td><td>StorageOSæä¾›çš„å­˜å‚¨æœåŠ¡</td></tr><tr><td>VsphereVolume</td><td>VMWareæä¾›çš„å­˜å‚¨ç³»ç»Ÿ</td></tr></table><p>ä¸¾ä¸ªPVé…ç½®æ–‡ä»¶ä¾‹å­ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">1</span><span class="string">Gi</span> <span class="comment"># å…·æœ‰1Giå†…å­˜</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteMany</span> <span class="comment"># å…·æœ‰è¯»å†™æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span> <span class="comment"># å›æ”¶ç­–ç•¥ï¼Œè¿™é‡Œä¸ºä¿ç•™</span></span><br><span class="line"><span class="attr">  nfs:</span> <span class="comment"># pvç±»å‹ä¸ºNFSç±»å‹</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.13</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">"/nfs"</span></span><br></pre></td></tr></table></figure><p></p><p>PVæ”¯æŒçš„accessModesæœ‰ï¼š</p><ul><li>ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œå¹¶ä¸”åªèƒ½è¢«å•ä¸ªNodeæŒ‚è½½ã€‚</li><li>ReadOnlyManyï¼ˆROXï¼‰ï¼šåªè¯»æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½ã€‚</li><li>ReadWriteManyï¼ˆRWXï¼‰ï¼šè¯»å†™æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½ã€‚</li></ul><p>ä¸åŒçš„å­˜å‚¨æä¾›è€…æ”¯æŒçš„accessModesï¼š</p><table><thead><tr><th align="left">Volume Plugin</th><th align="center">ReadWriteOnce</th><th align="center">ReadOnlyMany</th><th align="center">ReadWriteMany</th></tr></thead><tbody><tr><td align="left">AWSElasticBlockStore</td><td align="center">âœ“</td><td align="center">-</td><td align="center">-</td></tr><tr><td align="left">AzureFile</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="center">âœ“</td></tr><tr><td align="left">AzureDisk</td><td align="center">âœ“</td><td align="center">-</td><td align="center">-</td></tr><tr><td align="left">CephFS</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="center">âœ“</td></tr><tr><td align="left">Cinder</td><td align="center">âœ“</td><td align="center">-</td><td align="center">-</td></tr><tr><td align="left">CSI</td><td align="center">depends on the driver</td><td align="center">depends on the driver</td><td align="center">depends on the driver</td></tr><tr><td align="left">FC</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="center">-</td></tr><tr><td align="left">FlexVolume</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="center">depends on the driver</td></tr><tr><td align="left">Flocker</td><td align="center">âœ“</td><td align="center">-</td><td align="center">-</td></tr><tr><td align="left">GCEPersistentDisk</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="center">-</td></tr><tr><td align="left">Glusterfs</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="center">âœ“</td></tr><tr><td align="left">HostPath</td><td align="center">âœ“</td><td align="center">-</td><td align="center">-</td></tr><tr><td align="left">iSCSI</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="center">-</td></tr><tr><td align="left">Quobyte</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="center">âœ“</td></tr><tr><td align="left">NFS</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="center">âœ“</td></tr><tr><td align="left">RBD</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="center">-</td></tr><tr><td align="left">VsphereVolume</td><td align="center">âœ“</td><td align="center">-</td><td align="center">- (works when Pods are collocated)</td></tr><tr><td align="left">PortworxVolume</td><td align="center">âœ“</td><td align="center">-</td><td align="center">âœ“</td></tr><tr><td align="left">ScaleIO</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="center">-</td></tr><tr><td align="left">StorageOS</td><td align="center">âœ“</td><td align="center">-</td><td align="center">-</td></tr></tbody></table><p>PVæ”¯æŒçš„persistentVolumeReclaimPolicyæœ‰ï¼š</p><ul><li>Retainï¼Œä¸æ¸…ç†, ä¿ç•™ Volumeï¼ˆéœ€è¦æ‰‹åŠ¨æ¸…ç†ï¼‰</li><li>Recycleï¼Œåˆ é™¤æ•°æ®ï¼Œï¼ˆåªæœ‰ NFS å’Œ HostPath æ”¯æŒï¼‰</li><li>Deleteï¼Œåˆ é™¤å­˜å‚¨èµ„æºï¼Œæ¯”å¦‚åˆ é™¤ AWS EBS å·ï¼ˆåªæœ‰ AWS EBS, GCE PD, Azure Disk å’Œ Cinder æ”¯æŒï¼‰</li></ul><p>PVå£°æ˜å‘¨æœŸï¼š</p><ul><li>Availableï¼šç©ºé—²çŠ¶æ€ï¼›</li><li>Boundï¼šå·²ç»ç»‘å®šåˆ°æŸä¸ªPVCä¸Šï¼›</li><li>Releasedï¼šå¯¹åº”çš„PVCå·²ç»è¢«åˆ é™¤ï¼Œä½†èµ„æºè¿˜æ²¡æœ‰è¢«é›†ç¾¤æ”¶å›ï¼›</li><li>Failedï¼šPVè‡ªåŠ¨å›æ”¶å¤±è´¥ã€‚</li></ul><h2 id="PVC"><a href="#PVC" class="headerlink" title="PVC"></a>PVC</h2><p>PersistentVolumeClaimï¼ˆPVCï¼‰ï¼Œå¯¹å­˜å‚¨èµ„æºçš„éœ€æ±‚ç”³è¯·ï¼Œä¸»è¦åŒ…æ‹¬å­˜å‚¨ç©ºé—´è¯·æ±‚ã€è®¿é—®æ¨¡å¼ã€PVé€‰æ‹©æ¡ä»¶å’Œå­˜å‚¨ç±»åˆ«ç­‰ä¿¡æ¯çš„è®¾ç½®ã€‚åªæœ‰PVCå’ŒPVç›¸åŒ¹é…ï¼Œæ‰èƒ½ç»‘å®šä¸Šã€‚</p><p>å®šä¹‰ä¸€ä¸ªPVCé…ç½®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Gi</span><br></pre></td></tr></table></figure><p></p><p>è¯¥PVCå£°æ˜äº†éœ€è¦1Giå­˜å‚¨ç©ºé—´ï¼Œè®¿é—®æ¨¡å¼ä¸ºReadWriteManyï¼Œåˆšåˆšå®šä¹‰çš„PVç¬¦åˆè¿™ä¸ªè¦æ±‚ï¼Œæ‰€ä»¥ä¼šè¢«ç»‘å®šä¸Šã€‚</p><h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><p>å› ä¸ºNFSç±»å‹å­˜å‚¨æ¼”ç¤ºèµ·æ¥æ–¹ä¾¿ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹©ä½¿ç”¨NFSä½œä¸ºå­˜å‚¨æä¾›è€…ã€‚</p><p>åœ¨<a href="https://mrbird.cc/Kubeadm-install-Kubernetes1-16-2-cluster.html">Kubeadmå®‰è£…Kubernetes1.16.2é›†ç¾¤</a>ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ›¾åœ¨ä»¥ä¸‹è™šæ‹Ÿæœºä¸Šæ­å»ºäº†Kubernetesé›†ç¾¤:</p><table><thead><tr><th style="text-align:center">æ“ä½œç³»ç»Ÿ</th><th style="text-align:center">IP</th><th style="text-align:center">è§’è‰²</th><th style="text-align:center">CPUæ ¸å¿ƒæ•°</th><th style="text-align:center">å†…å­˜</th><th style="text-align:center">Hostname</th></tr></thead><tbody><tr><td style="text-align:center">centos7</td><td style="text-align:center">192.168.33.11</td><td style="text-align:center">master</td><td style="text-align:center">2</td><td style="text-align:center">4096M</td><td style="text-align:center">master</td></tr><tr><td style="text-align:center">centos7</td><td style="text-align:center">192.168.33.12</td><td style="text-align:center">worker</td><td style="text-align:center">2</td><td style="text-align:center">4096M</td><td style="text-align:center">node1</td></tr><tr><td style="text-align:center">centos7</td><td style="text-align:center">192.168.33.13</td><td style="text-align:center">worker</td><td style="text-align:center">2</td><td style="text-align:center">4096M</td><td style="text-align:center">node2</td></tr></tbody></table><p>ä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡Œå°±ä¸å†åˆ›å»ºæ–°çš„è™šæ‹Ÿæœºå®‰è£…NFSï¼Œç›´æ¥åœ¨192.168.33.13èŠ‚ç‚¹ä¸Šå‡†å¤‡å¥½NFSç¯å¢ƒã€‚</p><p>åœ¨192.168.33.13èŠ‚ç‚¹ä¸Šæ‰§è¡Œä»¥ä¸‹bashå‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç›®å½•</span></span><br><span class="line">mkdir /nfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹æƒé™</span></span><br><span class="line">chmod 777 /nfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºexportsæ–‡ä»¶</span></span><br><span class="line">vim /etc/exports</span><br></pre></td></tr></table></figure><p></p><p>exportså†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/nfs *(rw,insecure,sync,no_subtree_check,no_root_squash)</span><br></pre></td></tr></table></figure><p></p><p>è®©é…ç½®ç”Ÿæ•ˆï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exportfs -r</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨NFSï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> nfs</span><br><span class="line">systemctl <span class="built_in">enable</span> rpcbind</span><br><span class="line">systemctl restart nfs</span><br><span class="line">systemctl restart rpcbind</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€åœ¨masterèŠ‚ç‚¹ä¸Šï¼Œåˆ›å»ºtest-pv-pvc.ymlé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.13</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">"/nfs"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">          command:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">sh</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">-c</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">'while true; do echo hello world &gt; /mnt/index.html; sleep $(($RANDOM % 5 + 5)); done'</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">"/mnt"</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">          persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">            claimName:</span> <span class="string">nfs-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">              containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">"/usr/share/nginx/html"</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">          persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">            claimName:</span> <span class="string">nfs-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„é…ç½®æ–‡ä»¶æ•ˆæœå¯ä»¥ç”¨ä¸‹é¢è¿™å¼ å›¾è¡¨ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191125142753.png" alt="QQæˆªå›¾20191125142753.png"></p><p>ä¸»è¦è¿‡ç¨‹å°±æ˜¯busyboxé€šè¿‡nfs-pvcç»‘å®šäº†nfs-pvï¼Œç„¶åå®šæ—¶å°†hello worldå†™åˆ°å®¹å™¨å†…éƒ¨/mnt/index.htmlæ–‡ä»¶ä¸­ï¼Œè€Œå®¹å™¨å†…éƒ¨/mntå’ŒPVçš„/nfsç›®å½•æŒ‚è½½ï¼›nginxä¹Ÿé€šè¿‡nfs-pvcç»‘å®šäº†nfs-pvï¼Œå°†/nfsç›®å½•å’Œå®¹å™¨å†…éƒ¨/usr/share/nginx/htmlç›®å½•æŒ‚è½½ï¼›æˆ‘ä»¬åç»­å¯ä»¥é€šè¿‡è®¿é—®æµè§ˆå™¨<a href="http://192.168.33.11:30000/" target="_blank" rel="noopener">http://192.168.33.11:30000/</a>åœ°å€æŸ¥çœ‹æ•ˆæœã€‚</p><p>åˆ›å»ºè¯¥é…ç½®æ–‡ä»¶:</p><p><img src="img/QQæˆªå›¾20191125143031.png" alt="QQæˆªå›¾20191125143031.png"></p><p>æŸ¥çœ‹192.168.33.13è™šæ‹Ÿæœº/nfsç›®å½•ä¸‹æ˜¯å¦å·²ç»å­˜åœ¨index.htmlæ–‡ä»¶ï¼Œå¹¶æŸ¥çœ‹å†…å®¹ï¼š</p><p><img src="img/QQæˆªå›¾20191125143126.png" alt="QQæˆªå›¾20191125143126.png"></p><p>æµè§ˆå™¨è®¿é—®<a href="http://192.168.33.11:30000/" target="_blank" rel="noopener">http://192.168.33.11:30000/</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191125143416.png" alt="QQæˆªå›¾20191125143416.png"></p><p>è¯´æ˜æ•´ä¸ªæµç¨‹æ²¡é—®é¢˜ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨Kubernetesä¸­ï¼Œæˆ‘ä»¬è™½ç„¶å¯ä»¥ä½¿ç”¨volumeå°†å®¹å™¨å†…ç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœºç›®å½•ä¸Šï¼Œä½†ç”±äºPodè°ƒåº¦çš„ä¸ç¡®å®šæ€§ï¼Œè¿™ç§æ•°æ®å­˜å‚¨æ–¹å¼æ˜¯ä¸ç‰¢é çš„ã€‚å¯¹äºæœ‰çŠ¶æ€çš„åº”ç”¨ï¼Œæˆ‘ä»¬å¸Œæœ›æ— è®ºPodè¢«è°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼Œå®ƒä»¬çš„æ•°æ®æ€»èƒ½å¤Ÿå®Œæ•´åœ°æ¢å¤ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±ä¸èƒ½ç”¨volumeæŒ‚è½½äº†ï¼Œè€Œåº”è¯¥ä½¿ç”¨â€œç½‘ç»œå…±äº«å­˜å‚¨â€ã€‚PV/PVCå°±æ˜¯ç”¨äºè§£å†³é—®é¢˜è€Œå­˜åœ¨çš„ï¼Œå®ƒä»¬å±è”½äº†åº•å±‚å­˜å‚¨å®ç°çš„ç»†èŠ‚ï¼Œä½¿å¾—æˆ‘ä»¬å¾ˆå®¹æ˜“ä¸Šæ‰‹ä½¿ç”¨ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>CI/CDå®è·µç¬”è®°</title>
    <link href="http://mrbird.cc/CI-CD-Practice-Note.html"/>
    <id>http://mrbird.cc/CI-CD-Practice-Note.html</id>
    <published>2019-11-18T05:52:58.000Z</published>
    <updated>2020-01-21T03:30:03.121Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>CICDï¼ˆ<strong>C</strong>ontinuous <strong>I</strong>ntegration/<strong>C</strong>ontinuous <strong>D</strong>eploymentï¼‰ï¼ŒæŒç»­é›†æˆæŒç»­éƒ¨ç½²çš„æ„æ€ã€‚å®ŒæˆCICDå®è·µéœ€è¦Kubernetesé›†ç¾¤ï¼ŒHarborï¼ŒGitLabå’ŒJenkinsç­‰è½¯ä»¶é…åˆå®Œæˆï¼Œåœ¨å‰é¢å‡ ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å·²ç»æ­å»ºå¥½äº†Kubernetesé›†ç¾¤ï¼Œå¹¶ä¸”åœ¨masterèŠ‚ç‚¹ï¼ˆ192.168.33.11,CentOSï¼‰ä¸Šå®‰è£…å¥½äº†Harborã€GitLabå’ŒJenkinsï¼Œæœ‰éœ€è¦å¯ä»¥å‚è€ƒä¸‹ã€‚<a id="more"></a></p><h2 id="å®è·µå‡†å¤‡"><a href="#å®è·µå‡†å¤‡" class="headerlink" title="å®è·µå‡†å¤‡"></a>å®è·µå‡†å¤‡</h2><h3 id="CICDæµç¨‹å›¾"><a href="#CICDæµç¨‹å›¾" class="headerlink" title="CICDæµç¨‹å›¾"></a>CICDæµç¨‹å›¾</h3><p>CICDçš„å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191118145712.png" alt="QQæˆªå›¾20191118145712.png"></p><ol><li><p>å¼€å‘è€…å°†æœ€æ–°ä»£ç æäº¤åˆ°GitLabä»“åº“ï¼›</p></li><li><p>GitLab WebHookè§¦å‘Jenkinsæ„å»ºæµæ°´çº¿ï¼š</p><p>2.1 æ‹‰å–æœ€æ–°ä»£ç ï¼›</p><p>2.2 Mavenæ‰“åŒ…ï¼Œæ‰“åŒ…è¿‡ç¨‹ä¸­ä¼šå…ˆè¿›è¡Œå•å…ƒæµ‹è¯•ï¼›</p><p>2.3 å•å…ƒæµ‹è¯•é€šè¿‡ï¼Œæ„å»ºDockeré•œåƒï¼›</p><p>2.4 å°†æœ€æ–°é•œåƒæ¨é€åˆ°Harborï¼›</p><p>2.5 æ›´æ–°Kubernetesç›¸å…³é…ç½®é•œåƒç‰ˆæœ¬ã€‚</p></li><li><p>Kubernetesæ„ŸçŸ¥åˆ°é•œåƒæ›´æ–°ï¼Œä»Harboræ‹‰å–æœ€æ–°é•œåƒï¼Œæ»šåŠ¨å‡çº§ï¼›</p></li><li><p>å¼€å‘è€…çœ‹åˆ°æœ€æ–°çš„ä»£ç æ•ˆæœã€‚</p></li></ol><h3 id="é¡¹ç›®å‡†å¤‡"><a href="#é¡¹ç›®å‡†å¤‡" class="headerlink" title="é¡¹ç›®å‡†å¤‡"></a>é¡¹ç›®å‡†å¤‡</h3><p>è¿™é‡Œæˆ‘ä»¬åœ¨Windowsä¸Šä½¿ç”¨IDEAã€Spring Bootæ„å»ºä¸€ä¸ªç®€å•çš„Java Webé¡¹ç›®ï¼Œé¡¹ç›®åä¸ºdemoï¼Œé¡¹ç›®pomå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>åœ¨Bootå…¥å£ç±»ä¸­æ·»åŠ ä¸€ä¸ªç®€å•çš„Controlleræ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢æ–¹æ³•æä¾›äº†ä¸€ä¸ª<code>/hello</code>æ¥å£ï¼Œç®€å•è¿”å›<code>hello world</code>ä¿¡æ¯ã€‚</p><p>æ¥ç€ç¼–å†™ä¸€ä¸ªç®€å•çš„å•å…ƒæµ‹è¯•ï¼š</p><p><img src="img/QQæˆªå›¾20191118151519.png" alt="QQæˆªå›¾20191118151519.png"></p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testIndex</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mockMvc.perform(MockMvcRequestBuilders.get(<span class="string">"/hello"</span>))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.content().string(<span class="string">"hello world"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æœ€ååœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªDockerfileï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:8u212-jre</span><br><span class="line">MAINTAINER MrBird 852252810@qq.com</span><br><span class="line"></span><br><span class="line">COPY target/demo-0.0.1-SNAPSHOT.jar /demo-0.0.1-SNAPSHOT.jar</span><br><span class="line">ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;/demo-0.0.1-SNAPSHOT.jar&quot;]</span><br></pre></td></tr></table></figure><p></p><p>è‡³æ­¤ç®€å•çš„Java Webé¡¹ç›®å°±å‡†å¤‡å¥½äº†ã€‚</p><h3 id="GitLabå‡†å¤‡"><a href="#GitLabå‡†å¤‡" class="headerlink" title="GitLabå‡†å¤‡"></a>GitLabå‡†å¤‡</h3><p>æ³¨å†Œä¸€ä¸ªæ–°çš„GitLabè´¦å·ï¼Œæ¯”å¦‚mrbirdï¼Œç„¶ååœ¨GitLabæ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼Œåç§°ä¸ºDemoï¼š</p><p><img src="img/QQæˆªå›¾20191118153441.png" alt="QQæˆªå›¾20191118153441.png"></p><p>å› ä¸ºæˆ‘ä»¬åç»­éœ€è¦åœ¨Windowsä¸‹å°†é¡¹ç›®æäº¤åˆ°GitLabï¼Œå¹¶åœ¨192.168.33.11ä¸Šæ‹‰å–è¯¥é¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨Windowså’Œ192.168.33.11æœåŠ¡å™¨ä¸Šç”ŸæˆSSH Keyï¼Œå¹¶æ·»åŠ åˆ°GitLabä¸­ã€‚</p><p>åœ¨WindowsåŠ192.168.33.11è™šæ‹Ÿæœºé€šè¿‡ä¸‹é¢çš„å‘½ä»¤ç”ŸæˆSSH Keyï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">"852252810@qq.com"</span></span><br><span class="line"></span><br><span class="line">cat ~/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure><p></p><p>å°†SSH Keyæ·»åŠ åˆ°GitLabï¼š</p><p><img src="img/QQæˆªå›¾20191118153948.png" alt="QQæˆªå›¾20191118153948.png"></p><p>è¿™æ ·æˆ‘ä»¬åç»­çš„pushå’Œpullæ“ä½œå°±ä¸éœ€è¦è¾“å…¥ç”¨æˆ·åäº†ã€‚</p><p>æ¥ç€æˆ‘ä»¬å°†ä¸Šé¢åˆ›å»ºçš„Demoé¡¹ç›®æ¨é€åˆ°GitLabä¸­ï¼ˆåœ¨IDEAçš„Terminalçª—å£ä¸­æ“ä½œï¼Œä¸ªäººä¹ æƒ¯ç”¨å‘½ä»¤è¡Œï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># é…ç½®Git</span><br><span class="line">git config --global user.name &quot;mrbird&quot;</span><br><span class="line">git config --global user.email &quot;852252810@qq.com&quot;</span><br><span class="line"></span><br><span class="line"># åˆå§‹åŒ–Gitä»“åº“</span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"># commit</span><br><span class="line">git commit -am init</span><br><span class="line"></span><br><span class="line"># æ·»åŠ è¿œç¨‹ä»“åº“</span><br><span class="line">git remote add origin ssh://git@gitlab.mrbird.cc:2223/mrbird/demo.git</span><br><span class="line"></span><br><span class="line"># æ¨é€åˆ°è¿œç¨‹ä»“åº“</span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure><p></p><p>æ¨é€æˆåŠŸåï¼Œå›åˆ°GitLabé¡µé¢å¯ä»¥çœ‹åˆ°é¡¹ç›®å·²ç»æ¨é€OKäº†ï¼š</p><p><img src="img/QQæˆªå›¾20191120162821.png" alt="QQæˆªå›¾20191118154957.png"></p><h3 id="Kuberneteséƒ¨ç½²SpringBooté¡¹ç›®"><a href="#Kuberneteséƒ¨ç½²SpringBooté¡¹ç›®" class="headerlink" title="Kuberneteséƒ¨ç½²SpringBooté¡¹ç›®"></a>Kuberneteséƒ¨ç½²SpringBooté¡¹ç›®</h3><p>åœ¨192.168.33.11æœåŠ¡å™¨ä¸Šå°†åˆšåˆšçš„é¡¹ç›®ä»GitLabä¸­å…‹éš†ä¸‹æ¥:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone ssh://git@gitlab.mrbird.cc:2223/mrbird/demo.git</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ‰“åŒ…éœ€è¦Mavenç¯å¢ƒï¼Œæ‰€ä»¥æ¥ç€é…ç½®Mavenï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ä¸‹è½½Mavenå®‰è£…åŒ…</span><br><span class="line">wget http://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.2/binaries/apache-maven-3.6.2-bin.tar.gz</span><br><span class="line"></span><br><span class="line"># è§£å‹</span><br><span class="line">tar -xzvf apache-maven-3.6.2-bin.tar.gz</span><br><span class="line"></span><br><span class="line"># ä¿®æ”¹ç¯å¢ƒå˜é‡</span><br><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure><p></p><p>æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M2_HOME=/home/vagrant/apache-maven-3.6.2</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin:$M2_HOME/bin</span><br></pre></td></tr></table></figure><p></p><p>è®©ä¿®æ”¹ç”Ÿæ•ˆï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><p></p><p>éªŒè¯ä¸‹æ˜¯å¦å®‰è£…æˆåŠŸï¼š</p><p><img src="img/QQæˆªå›¾20191118164351.png" alt="QQæˆªå›¾20191118164351.png"></p><p>ç¯å¢ƒå‡†å¤‡å¥½åï¼Œå°†ç›®å½•åˆ‡æ¢åˆ°åˆšåˆš<code>git clone</code>çš„demoç›®å½•ä¸‹ï¼Œæ‰§è¡Œ<code>mvn clean package</code>å‘½ä»¤ï¼Œå®Œæˆåå¯ä»¥çœ‹åˆ°fat jarï¼š</p><p><img src="img/QQæˆªå›¾20191120162943.png" alt="QQæˆªå›¾20191118171428.png"></p><p>æ¥ç€æ‰§è¡Œ<code>docker build -t docker.mrbird.cc/febs/demo .</code>å‘½ä»¤æ„å»ºdockeré•œåƒï¼š</p><p><img src="img/QQæˆªå›¾20191119184432.png" alt="QQæˆªå›¾20191119184432.png"></p><p>æ„å»ºæˆåŠŸåæ‰§è¡Œ<code>docker push docker.mrbird.cc/febs/demo</code>å‘½ä»¤æ¨é€åˆ°Harborï¼š</p><p><img src="img/QQæˆªå›¾20191119184535.png" alt="QQæˆªå›¾20191119184535.png"></p><p>è®¿é—®Harborç®¡ç†é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°é•œåƒå·²ç»æ¨é€ä¸Šæ¥äº†ï¼š</p><p><img src="img/QQæˆªå›¾20191119184638.png" alt="QQæˆªå›¾20191119184638.png"></p><p>æ¥ç€ç¼–å†™ä¸ªç®€å•çš„Kubernetesé…ç½®æ–‡ä»¶ï¼ˆdemo.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">demo-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">demo-app</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">demo-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">demo-app</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">demo-app</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">docker.mrbird.cc/febs/demo</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            limits:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="number">500</span><span class="string">m</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">500</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="number">200</span><span class="string">m</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">200</span><span class="string">Mi</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œè¯¥é…ç½®:</p><p><img src="img/QQæˆªå›¾20191119191043.png" alt="QQæˆªå›¾20191119191043.png"></p><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="http://192.168.33.11:30000/hello" target="_blank" rel="noopener">http://192.168.33.11:30000/hello</a>:</p><p><img src="img/QQæˆªå›¾20191119192134.png" alt="QQæˆªå›¾20191119192134.png"></p><p>è‡³æ­¤Spring Booté¡¹ç›®å·²ç»æˆåŠŸè¿è¡Œåœ¨Kubernetesé›†ç¾¤ä¸­äº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹æ¼”ç¤ºå¦‚ä½•è¿›è¡ŒCICDã€‚</p><h2 id="CICDå®è·µ"><a href="#CICDå®è·µ" class="headerlink" title="CICDå®è·µ"></a>CICDå®è·µ</h2><p>å°±å¦‚ä¸Šé¢CICDæµç¨‹å›¾æ‰€ç¤ºï¼Œç¬¬ä¸€æ­¥å°†æœ¬åœ°å¼€å‘ä»£ç pushåˆ°GitLabå·²ç»å®ç°äº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹é…ç½®GitLab WebHookã€‚</p><h3 id="GitLab-WebHook"><a href="#GitLab-WebHook" class="headerlink" title="GitLab WebHook"></a>GitLab WebHook</h3><p>åœ¨Jenkinsä¸­åˆ›å»ºæµæ°´çº¿å‰ï¼Œå…ˆä¿®æ”¹ä¸¤å¤„Jenkinsé…ç½®ã€‚ç‚¹å‡»Jenkinsç®¡ç†é¡µé¢çš„<strong>ç³»ç»Ÿç®¡ç†</strong>èœå• -&gt; <strong>å…¨å±€å®‰å…¨é…ç½®</strong>ï¼š</p><p><img src="img/QQæˆªå›¾20191120091638.png" alt="QQæˆªå›¾20191120091638.png"></p><p>å…³é—­CSRFä¿æŠ¤å’Œå¼€å¯åŒ¿åç”¨æˆ·å…·æœ‰å¯è¯»æƒé™ã€‚</p><p>ç„¶åç‚¹å‡»<strong>æ–°å»ºä»»åŠ¡</strong>èœå•ï¼Œæ–°å¢ä¸€ä¸ªåç§°ä¸ºdemoçš„æµæ°´çº¿ï¼Œå‹¾é€‰<strong>è§¦å‘è¿œç¨‹æ„å»º</strong>ï¼š</p><p><img src="img/QQæˆªå›¾20191120091910.png" alt="QQæˆªå›¾20191120091910.png"></p><p>ä»¤ç‰Œè®¾ç½®ä¸º666666ï¼Œè§¦å‘åœ°å€ä¸º<code>JENKINS_URL/job/demo/build?token=TOKEN_NAME</code>ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªåœ°å€é…ç½®ä¸ºGitLabçš„WebHookä¸­ã€‚</p><p>æ‰“å¼€GitLabçš„Demoé¡¹ç›®é¡µé¢ï¼Œç‚¹å‡»å·¦ä¾§çš„è®¾ç½®èœå•ï¼š</p><p><img src="img/QQæˆªå›¾20191120092313.png" alt="QQæˆªå›¾20191120092313.png"></p><p>é€‰æ‹©integrationsï¼š</p><p><img src="img/QQæˆªå›¾20191120092425.png" alt="QQæˆªå›¾20191120092425.png"></p><p>å…¶ä¸­<code>http://192.168.33.11:8081</code>ä¸ºæˆ‘çš„Jenkinsåœ°å€ï¼Œå¯¹åº”JENKINS_URLï¼›666666æ˜¯æˆ‘ä»¬è®¾ç½®çš„ä»¤ç‰Œï¼Œå¯¹åº”TOKEN_NAMEã€‚è§¦å‘äº‹ä»¶é€‰æ‹©push eventå°±è¡Œã€‚</p><p>ä¿å­˜WebHookçš„æ—¶å€™å¦‚æœæç¤º<span style="color:red;font-weight:600">Url is blocked: Requests to the local network are not allowed</span>çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨<a href="mailto:admin@example.com" target="_blank" rel="noopener">admin@example.com</a>è´¦å·ç™»å½•GitLabï¼ˆå¯†ç å°±æ˜¯ä½ ç¬¬ä¸€æ¬¡ç™»å½•ä¿®æ”¹çš„å¯†ç ï¼‰ï¼Œç„¶åç‚¹å‡»<strong>Admin Area</strong>-&gt;<strong>Settings</strong>-&gt;<strong>Network</strong>ï¼š</p><p><img src="img/QQæˆªå›¾20191120093459.png" alt="QQæˆªå›¾20191120093459.png"></p><p>å‹¾é€‰Allow requests to the local network from web hooks and serviceså³å¯ã€‚ä¿å­˜åï¼Œé‡æ–°ä½¿ç”¨mrbirdè´¦å·ç™»å½•é‡æ–°é…ç½®WebHookå³å¯ã€‚</p><p>é…ç½®å¥½åï¼Œæµ‹è¯•ä¸€ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20191120094028.png" alt="QQæˆªå›¾20191120094028.png"></p><p>é¡µé¢å¼¹å‡ºå¦‚ä¸‹æç¤ºè¯´æ˜é…ç½®ğŸ†—ï¼š</p><p><img src="img/QQæˆªå›¾20191120094121.png" alt="QQæˆªå›¾20191120094121.png"></p><h3 id="ä»£ç æ‹‰å–"><a href="#ä»£ç æ‹‰å–" class="headerlink" title="ä»£ç æ‹‰å–"></a>ä»£ç æ‹‰å–</h3><p>Mavenæ‰“åŒ…å‰éœ€è¦å…ˆç”¨gitå‘½ä»¤å°†ä»£ç æ‹‰å–ä¸‹æ¥ã€‚ç¼–è¾‘åˆšåˆšåˆ›å»ºçš„æµæ°´çº¿ï¼Œåœ¨Pipeline scriptä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><p><img src="img/QQæˆªå›¾20191120141218.png" alt="QQæˆªå›¾20191120141218.png"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!groovy</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">  agent any</span><br><span class="line">  environment &#123;</span><br><span class="line">    REPOSITORY=<span class="string">"ssh://git@gitlab.mrbird.cc:2223/mrbird/demo.git"</span></span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">'æ‹‰å–ä»£ç '</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"ä»GitLabåœ°å€<span class="variable">$&#123;REPOSITORY&#125;</span>æ‹‰å–ä»£ç "</span></span><br><span class="line">        deleteDir()</span><br><span class="line">        git <span class="string">"<span class="variable">$&#123;REPOSITORY&#125;</span>"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>Pipeline scriptçš„åŸºæœ¬æ¨¡æ¿ä¸ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!groovy</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">  agent any</span><br><span class="line">  environment &#123;</span><br><span class="line">    // å®šä¹‰å…¨å±€å˜é‡</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">  	// å¯ä»¥å®šä¹‰å¤šä¸ªé˜¶æ®µ</span><br><span class="line">    stage(<span class="string">'é˜¶æ®µåç§°'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        // å…·ä½“æ­¥éª¤</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å›åˆ°ä¸Šé¢çš„Pipeline scriptä»£ç ï¼Œæˆ‘ä»¬ä¸»è¦åšäº†ä¸‹é¢å‡ ä»¶äº‹ï¼š</p><ol><li><p>åœ¨environmentä¸­å®šä¹‰GitLabé¡¹ç›®ä»“åº“åœ°å€å˜é‡ï¼Œæ–¹ä¾¿ä¸‹é¢ç›´æ¥å¼•ç”¨ï¼›</p></li><li><p>é€šè¿‡<code>echo</code>å‘½ä»¤è¾“å‡ºï¼Œæ–¹ä¾¿åç»­ä»æ—¥å¿—ä¸­è§‚å¯Ÿè·Ÿè¸ªï¼›</p></li><li><p>é€šè¿‡<code>deleteDir()</code>æ¸…ç©ºå·¥ä½œåŒºï¼›</p></li><li><p>é€šè¿‡<code>git &quot;${REPOSITORY}&quot;</code>ä»æŒ‡å®šGitä»“åº“æ‹‰å–ä»£ç ã€‚</p></li></ol><p>å…¶ä¸­ï¼Œä½¿ç”¨environmentä¸­çš„å˜é‡æ—¶å€™ï¼Œä¸€å®šè¦ç”¨<code>&quot;${xx}&quot;</code>çš„æ–¹å¼å¼•ç”¨ï¼›ç¬¬3ç¬¬4æ­¥çš„å‘½ä»¤å¯ä»¥é€šè¿‡æµæ°´çº¿è¯­æ³•æ¥ç”Ÿæˆï¼Œæ¯”å¦‚ç”Ÿæˆæ¸…ç©ºå½“å‰ç›®å½•çš„å‘½ä»¤ï¼š</p><p><img src="img/QQæˆªå›¾20191120141809.png" alt="QQæˆªå›¾20191120141809.png"></p><p>ç”Ÿæˆé€šè¿‡Gitæ‹‰å–ä»£ç çš„å‘½ä»¤ï¼š</p><p><img src="img/QQæˆªå›¾20191120141908.png" alt="QQæˆªå›¾20191120141908.png"></p><p>ä¿®æ”¹å¥½æµæ°´çº¿åï¼Œç‚¹å‡»<strong>ç«‹å³æ„å»º</strong>ï¼Œçœ‹çœ‹æˆ‘ä»¬çš„é…ç½®æ˜¯å¦ğŸ†—ï¼š</p><p><img src="img/20191120142110.png" alt="20191120142110.png"></p><p>ä»æ—¥å¿—æ¥çœ‹ï¼Œä»£ç æ‹‰å–æ˜¯æˆåŠŸçš„ã€‚</p><h3 id="Mavenæ‰“åŒ…å’Œå•å…ƒæµ‹è¯•"><a href="#Mavenæ‰“åŒ…å’Œå•å…ƒæµ‹è¯•" class="headerlink" title="Mavenæ‰“åŒ…å’Œå•å…ƒæµ‹è¯•"></a>Mavenæ‰“åŒ…å’Œå•å…ƒæµ‹è¯•</h3><p>Jenkins é€šè¿‡shellè„šæœ¬è°ƒç”¨mvn å‘½ä»¤çš„æ—¶å€™ï¼Œæ˜¯ä»/usr/bin æ–‡ä»¶å¤¹ä¸­æ‰¾å‘½ä»¤çš„ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦åšä¸ªè½¯é“¾æ¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /home/vagrant/apache-maven-3.6.2/bin/mvn /usr/bin/mvn</span><br></pre></td></tr></table></figure><p></p><p>æ›´æ–°æµæ°´çº¿çš„Pipeline scriptï¼Œæ·»åŠ mavenæ‰“åŒ…é˜¶æ®µå‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!groovy</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">  agent any</span><br><span class="line">  environment &#123;</span><br><span class="line">    REPOSITORY=<span class="string">"ssh://git@gitlab.mrbird.cc:2223/mrbird/demo.git"</span></span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">'æ‹‰å–ä»£ç '</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"ä»GitLabåœ°å€<span class="variable">$&#123;REPOSITORY&#125;</span>æ‹‰å–ä»£ç "</span></span><br><span class="line">        deleteDir()</span><br><span class="line">        git <span class="string">"<span class="variable">$&#123;REPOSITORY&#125;</span>"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'ä»£ç ç¼–è¯‘åŠå•å…ƒæµ‹è¯•'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"å¼€å§‹ç¼–è¯‘ä»£ç å’Œå•å…ƒæµ‹è¯•"</span></span><br><span class="line">        sh <span class="string">"mvn -U -am clean package"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>mavenæ‰“åŒ…å‰ä¼šè‡ªåŠ¨è¿è¡Œæˆ‘ä»¬åœ¨é¡¹ç›®é‡Œå†™å¥½çš„å•å…ƒæµ‹è¯•ï¼Œä¿®æ”¹åï¼Œç‚¹å‡»<strong>ç«‹å³æ„å»º</strong>ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼ˆæˆªå–å…³é”®éƒ¨åˆ†ï¼‰ï¼š</p><p><img src="img/QQæˆªå›¾20191121170401.png" alt="QQæˆªå›¾20191120154051.png"></p><p><img src="img/QQæˆªå›¾20191121170425.png" alt="QQæˆªå›¾20191120154144.png"></p><p><img src="img/QQæˆªå›¾20191121170512.png" alt="QQæˆªå›¾20191120154249.png"></p><p>å¯ä»¥çœ‹åˆ°å•å…ƒæµ‹è¯•åŠæ‰“åŒ…æˆåŠŸã€‚</p><h3 id="æ„å»ºé•œåƒåŠæ¨é€"><a href="#æ„å»ºé•œåƒåŠæ¨é€" class="headerlink" title="æ„å»ºé•œåƒåŠæ¨é€"></a>æ„å»ºé•œåƒåŠæ¨é€</h3><p>é•œåƒæ„å»ºå’Œæ¨é€æ¶‰åŠå‘½ä»¤è¾ƒå¤šï¼Œæ‰€ä»¥å¯ä»¥å®šä¹‰ä¸€ä¸ªè„šæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim build_push.sh</span><br></pre></td></tr></table></figure><p></p><p>è„šæœ¬å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">MODULE=$1</span><br><span class="line">TIME=`date &quot;+%Y%m%d%H%M&quot;`</span><br><span class="line">GIT_REVISION=`git log -1 --pretty=format:&quot;%h&quot;`</span><br><span class="line">IMAGE_NAME=docker.mrbird.cc/febs/$&#123;MODULE&#125;:$&#123;TIME&#125;_$&#123;GIT_REVISION&#125;</span><br><span class="line"></span><br><span class="line">docker build -t $&#123;IMAGE_NAME&#125; .</span><br><span class="line"></span><br><span class="line">docker push $&#123;IMAGE_NAME&#125;</span><br><span class="line"></span><br><span class="line">echo &quot;$&#123;IMAGE_NAME&#125;&quot; &gt; image_name</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢è„šæœ¬å®šä¹‰äº†ä¸‰ä¸ªå˜é‡ï¼š</p><ol><li><p>MODULEï¼Œæ¨¡å—åç§°ï¼Œç”±è„šæœ¬æ‰§è¡Œçš„æ—¶å€™ä¼ å…¥ï¼›</p></li><li><p>TIMEï¼Œæ—¶é—´å­—ç¬¦ä¸²ï¼›</p></li><li><p>GIT_REVISIONï¼Œgit æäº¤å†å²å“ˆå¸Œç çš„å‰7ä½ï¼›</p></li><li><p>IMAGE_NAMEï¼Œé•œåƒåç§°ã€‚</p></li></ol><p>è„šæœ¬åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œæ ¹æ®å½“å‰ç›®å½•çš„Dockerfileæ„å»ºDockeré•œåƒï¼Œç„¶åå°†é•œåƒæ¨é€åˆ°Harborä»“åº“ï¼Œæ¨é€åï¼Œå°†é•œåƒåç§°å†™åˆ°å½“å‰ç›®å½•ä¸‹çš„image_nameæ–‡ä»¶ä¸­ï¼ˆä¾›åç»­ä½¿ç”¨ï¼‰ã€‚</p><p>ç»™è„šæœ¬æ·»åŠ å¯æ‰§è¡Œæƒé™ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x build_push.sh</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹Pipeline scriptï¼Œæ–°å¢æ„å»ºé•œåƒåŠæ¨é€é˜¶æ®µå‘½ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#!groovy</span><br><span class="line">pipeline &#123;</span><br><span class="line">  agent any</span><br><span class="line">  environment &#123;</span><br><span class="line">    REPOSITORY=&quot;ssh://git@gitlab.mrbird.cc:2223/mrbird/demo.git&quot;</span><br><span class="line">    SCRIPT_PATH=&quot;/home/vagrant/bash&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(&apos;æ‹‰å–ä»£ç &apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo &quot;ä»GitLabåœ°å€$&#123;REPOSITORY&#125;æ‹‰å–ä»£ç &quot;</span><br><span class="line">        deleteDir()</span><br><span class="line">        git &quot;$&#123;REPOSITORY&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&apos;ä»£ç ç¼–è¯‘åŠå•å…ƒæµ‹è¯•&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo &quot;å¼€å§‹ç¼–è¯‘ä»£ç å’Œå•å…ƒæµ‹è¯•&quot;</span><br><span class="line">        sh &quot;mvn -U -am clean package&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&apos;Dockeré•œåƒæ„å»ºåŠæ¨é€&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo &quot;å¼€å§‹æ„å»ºDockeré•œåƒå¹¶æ¨é€åˆ°Harbor&quot;</span><br><span class="line">        sh &quot;$&#123;SCRIPT_PATH&#125;/build_push.sh demo&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å…¶ä¸­<code>SCRIPT_PATH</code>æ˜¯ä¸Šé¢å®šä¹‰çš„è„šæœ¬çš„è·¯å¾„ã€‚</p><p>ä¿®æ”¹å¥½Pipeline scriptï¼Œé‡æ–°ç‚¹å‡»<strong>ç«‹å³æ„å»º</strong>ï¼Œæˆªå–å’Œè¿™éƒ¨åˆ†ç›¸å…³çš„æ—¥å¿—ï¼š</p><p><img src="img/20191121184651.png" alt="20191121184651.png"></p><p>æŸ¥çœ‹é•œåƒåˆ—è¡¨ï¼š</p><p><img src="img/QQæˆªå›¾20191121184855.png" alt="QQæˆªå›¾20191121184855.png"></p><p><img src="img/QQæˆªå›¾20191121184943.png" alt="QQæˆªå›¾20191121184943.png"></p><h3 id="Kubernetes-Deploymentå‡çº§"><a href="#Kubernetes-Deploymentå‡çº§" class="headerlink" title="Kubernetes Deploymentå‡çº§"></a>Kubernetes Deploymentå‡çº§</h3><p>åœ¨<code>/home/vagrant/bash</code>ç›®å½•ä¸‹æ–°å»ºdeploy.shè„šæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">IMAGE=`cat image_name`</span><br><span class="line"></span><br><span class="line">kubectl set image deployment/demo-deployment demo=$&#123;IMAGE&#125;</span><br></pre></td></tr></table></figure><p></p><p>è„šæœ¬å†…å®¹å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡kubectlå‘½ä»¤å‡çº§ç›¸å…³Podçš„é•œåƒï¼Œé•œåƒåç§°ä»image_nameæ–‡ä»¶ä¸­è¯»å–ã€‚</p><p>ä¿®æ”¹Pipeline scriptï¼Œæ·»åŠ Kubernetes Deploymentå‡çº§é˜¶æ®µå‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!groovy</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">  agent any</span><br><span class="line">  environment &#123;</span><br><span class="line">    REPOSITORY=<span class="string">"ssh://git@gitlab.mrbird.cc:2223/mrbird/demo.git"</span></span><br><span class="line">    SCRIPT_PATH=<span class="string">"/home/vagrant/bash"</span></span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">'æ‹‰å–ä»£ç '</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"ä»GitLabåœ°å€<span class="variable">$&#123;REPOSITORY&#125;</span>æ‹‰å–ä»£ç "</span></span><br><span class="line">        deleteDir()</span><br><span class="line">        git <span class="string">"<span class="variable">$&#123;REPOSITORY&#125;</span>"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'ä»£ç ç¼–è¯‘åŠå•å…ƒæµ‹è¯•'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"å¼€å§‹ç¼–è¯‘ä»£ç å’Œå•å…ƒæµ‹è¯•"</span></span><br><span class="line">        sh <span class="string">"mvn -U -am clean package"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Dockeré•œåƒæ„å»ºåŠæ¨é€'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"å¼€å§‹æ„å»ºDockeré•œåƒå¹¶æ¨é€åˆ°Harbor"</span></span><br><span class="line">        sh <span class="string">"<span class="variable">$&#123;SCRIPT_PATH&#125;</span>/build_push.sh demo"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'æ›´æ–°Kubernetes Deployment'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"å¼€å§‹æ›´æ–°Kubernetes Deployment"</span></span><br><span class="line">        sh <span class="string">"<span class="variable">$&#123;SCRIPT_PATH&#125;</span>/deploy.sh"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹åï¼Œç‚¹å‡»<strong>ç«‹å³æ„å»º</strong>ï¼š</p><p><img src="img/QQæˆªå›¾20191121192052.png" alt="QQæˆªå›¾20191121192052.png"></p><p>è‡³æ­¤æˆ‘ä»¬æ•´æ¡CICDæµç¨‹å°±å·²ç»éƒ½é€šäº†ï¼Œä¸‹é¢æµ‹è¯•ä¸‹CICDã€‚</p><h2 id="æ•ˆæœæµ‹è¯•"><a href="#æ•ˆæœæµ‹è¯•" class="headerlink" title="æ•ˆæœæµ‹è¯•"></a>æ•ˆæœæµ‹è¯•</h2><p>å¦‚ä¸Šé¢æ‰€ç¤ºï¼Œæˆ‘ä»¬è®¿é—®<a href="http://192.168.33.11:30000/hello" target="_blank" rel="noopener">http://192.168.33.11:30000/hello</a>ï¼Œé¡µé¢è¿”å›hello worldï¼Œæˆ‘ä»¬åœ¨IDEAä¸­ä¿®æ”¹Controlleræ–¹æ³•ï¼š</p><p><img src="img/QQæˆªå›¾20191121190234.png" alt="QQæˆªå›¾20191121190234.png"></p><p>åŒæ—¶ä¿®æ”¹å•å…ƒæµ‹è¯•æ–¹æ³•ï¼š</p><p><img src="img/QQæˆªå›¾20191121190318.png" alt="QQæˆªå›¾20191121190318.png"></p><p>ä¿®æ”¹ååœ¨IDEAçš„å‘½ä»¤çª—å£è¾“å…¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git commit -am update</span><br><span class="line"></span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure><p></p><p>å°†æœ€æ–°çš„ä»£ç æäº¤åˆ°GitLabåï¼Œè¿‡ä¸€å°ä¼šåˆ·æ–°<a href="http://192.168.33.11:30000/hello" target="_blank" rel="noopener">http://192.168.33.11:30000/hello</a>ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¿®æ”¹çš„å†…å®¹å·²ç»ç”Ÿæ•ˆäº†ï¼š</p><p><img src="img/QQæˆªå›¾20191121191654.png" alt="QQæˆªå›¾20191121191654.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;CICDï¼ˆ&lt;strong&gt;C&lt;/strong&gt;ontinuous &lt;strong&gt;I&lt;/strong&gt;ntegration/&lt;strong&gt;C&lt;/strong&gt;ontinuous &lt;strong&gt;D&lt;/strong&gt;eploymentï¼‰ï¼ŒæŒç»­é›†æˆæŒç»­éƒ¨ç½²çš„æ„æ€ã€‚å®ŒæˆCICDå®è·µéœ€è¦Kubernetesé›†ç¾¤ï¼ŒHarborï¼ŒGitLabå’ŒJenkinsç­‰è½¯ä»¶é…åˆå®Œæˆï¼Œåœ¨å‰é¢å‡ ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å·²ç»æ­å»ºå¥½äº†Kubernetesé›†ç¾¤ï¼Œå¹¶ä¸”åœ¨masterèŠ‚ç‚¹ï¼ˆ192.168.33.11,CentOSï¼‰ä¸Šå®‰è£…å¥½äº†Harborã€GitLabå’ŒJenkinsï¼Œæœ‰éœ€è¦å¯ä»¥å‚è€ƒä¸‹ã€‚
    
    </summary>
    
    
      <category term="GitLab" scheme="http://mrbird.cc/tags/GitLab/"/>
    
      <category term="CI/CD" scheme="http://mrbird.cc/tags/CI-CD/"/>
    
      <category term="DevOps" scheme="http://mrbird.cc/tags/DevOps/"/>
    
      <category term="Harbor" scheme="http://mrbird.cc/tags/Harbor/"/>
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
      <category term="Jenkins" scheme="http://mrbird.cc/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>GitLab &amp; Jenkinså®‰è£…å°è®°</title>
    <link href="http://mrbird.cc/GitLab-Jenkins-Install-Note.html"/>
    <id>http://mrbird.cc/GitLab-Jenkins-Install-Note.html</id>
    <published>2019-11-15T02:07:01.000Z</published>
    <updated>2020-01-21T03:30:03.126Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>åœ¨CentOSä¸‹å®‰è£…GitLabå’ŒJenkinsã€‚<a id="more"></a></p><h2 id="å®‰è£…GitLab"><a href="#å®‰è£…GitLab" class="headerlink" title="å®‰è£…GitLab"></a>å®‰è£…GitLab</h2><p>ä¼ ç»Ÿæ–¹å¼å®‰è£…GitLabæ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨Dockerå®‰è£…GitLabï¼Œæ‹‰å–å®˜æ–¹é•œåƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure><p></p><p>é•œåƒæœ‰ç‚¹å¤§ï¼Œè€å¿ƒç­‰å¾…ã€‚æ‹‰å–å¥½åï¼Œç¼–å†™ä¸€ä¸ªå¯åŠ¨è„šæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; run_gitlab.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">docker stop gitlab</span><br><span class="line">docker rm gitlab</span><br><span class="line">docker run -d \</span><br><span class="line">    --hostname gitlab.mrbird.cc \</span><br><span class="line">    -p 8443:443 -p 8080:80 -p 2223:22 \</span><br><span class="line">    --name gitlab \</span><br><span class="line">    -v /gitlab/config:/etc/gitlab \</span><br><span class="line">    -v /gitlab/logs:/var/log/gitlab \</span><br><span class="line">    -v /gitlab/data:/var/opt/gitlab \</span><br><span class="line">    gitlab/gitlab-ce:latest</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p></p><p><code>--hostname gitlab.mrbird.cc</code>ç»‘å®šåŸŸåï¼Œç«¯å£æ˜ å°„äº†ä¸‹ï¼Œé˜²æ­¢å’Œå®¿ä¸»æœºå†²çªã€‚</p><p>æ‰§è¡Œ<code>chmod u+x run_gitlab.sh</code>æ·»åŠ å¯æ‰§è¡Œæƒé™ï¼Œç„¶åè¿è¡Œ<code>sh run_gitlab.sh</code>å¯åŠ¨GitLabã€‚</p><p>æ‰§è¡Œå¯åŠ¨è„šæœ¬åï¼Œä½¿ç”¨<code>docker logs -f gitlab</code>æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨æ¯”è¾ƒæ…¢ï¼Œå½“æ—¥å¿—å®šæ—¶è¾“å‡º<code>/metrics</code>å†…å®¹æ—¶è¯´æ˜GitLabå·²å¯åŠ¨å®Œæ¯•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">==&gt; /var/log/gitlab/gitlab-rails/sidekiq_exporter.log &lt;==</span><br><span class="line">[2019-11-03T03:35:18.170+0000] 127.0.0.1 - - [03/Nov/2019:03:35:18 UTC] &quot;GET /metrics HTTP/1.1&quot; 200 6162 &quot;-&quot; &quot;Prometheus/2.12.0&quot;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨åï¼Œä¿®æ”¹gitlab.rbæ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /gitlab/config/gitlab.rb</span><br></pre></td></tr></table></figure><p></p><p>å¼€å¯è¿™æ®µé…ç½®ï¼Œå¹¶ä¸”ç«¯å£å·æ”¹ä¸ºä¸Šé¢æŒ‡å®šçš„2223ï¼š</p><p><img src="img/QQæˆªå›¾20191116202324.png" alt="QQæˆªå›¾20191116202324.png"></p><p>ç„¶åæ‰§è¡Œ<code>sh run_gitlab.sh</code>é‡å¯å³å¯ã€‚</p><p>é‡å¯åï¼Œåœ¨è™šæ‹Ÿæœºå’Œwindowsé‡Œæ·»åŠ hostsè§£æï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.33.11 gitlab.mrbird.cc</span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="http://gitlab.mrbird.cc:8080/" target="_blank" rel="noopener">http://gitlab.mrbird.cc:8080/</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191116202636.png" alt="QQæˆªå›¾20191116202636.png"></p><p>GitLabè¿˜æ˜¯æ¯”è¾ƒå å†…å­˜çš„ï¼Œåœ¨å®‰è£…GitLabå‰è¯·ç¡®ä¿å†…å­˜å¤Ÿç”¨ğŸŒšï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker stats gitlab</span><br><span class="line"></span><br><span class="line">CONTAINER ID        NAME                CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">d8edbda28f9f        gitlab              6.80%               1.944GiB / 3.701GiB   52.54%              130kB / 2.29MB      118MB / 2.52MB      281</span><br></pre></td></tr></table></figure><p></p><h2 id="å®‰è£…Jenkins"><a href="#å®‰è£…Jenkins" class="headerlink" title="å®‰è£…Jenkins"></a>å®‰è£…Jenkins</h2><p>Jenkinsçš„è¯ï¼Œæ¨èç”¨ä¼ ç»Ÿæ–¹å¼å®‰è£…ï¼Œè¿™æ ·å®¿ä¸»æœºä¸Šå®‰è£…çš„mavenã€dockerã€kubectlç­‰å‘½ä»¤å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p><p>åœ¨å®‰è£…Jenkinsä¹‹å‰ï¼Œéœ€è¦æœ‰Javaï¼ˆæˆ‘å®‰è£…çš„æ˜¯1.8ç‰ˆæœ¬ï¼‰ç¯å¢ƒï¼Œåœ¨CentOS7ä¸Šå®‰è£…JDKçš„è¿‡ç¨‹å°±ä¸æ¼”ç¤ºäº†ï¼Œä¹‹å‰åœ¨<a href="https://mrbird.cc/FEBS-Vue-Document.html">https://mrbird.cc/FEBS-Vue-Document.html</a>ä¸­ä¹Ÿæœ‰ä»‹ç»è¿‡ã€‚å®‰è£…å¥½JDKåï¼Œä¸‹è½½Jenkins waråŒ…ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirrors.jenkins.io/war-stable/latest/jenkins.war</span><br></pre></td></tr></table></figure><p></p><p>ç¼–å†™ä¸€ä¸ªå¯åŠ¨è„šæœ¬run_jenkins.shï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim run_jenkins.sh</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">nohup java -jar jenkins.war --httpPort=8081 &amp;</span><br></pre></td></tr></table></figure><p></p><p>æˆæƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod u+x run_jenkins.sh</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨Jenkinsï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh run_jenkins.sh</span><br></pre></td></tr></table></figure><p></p><p>å½“å¯åŠ¨æ—¥å¿—è¾“å‡ºå¦‚ä¸‹å†…å®¹æ—¶ï¼Œè¯´æ˜jenkinså·²æˆåŠŸå¯åŠ¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br><span class="line"></span><br><span class="line">Jenkins initial setup is required. An admin user has been created and a password generated.</span><br><span class="line">Please use the following password to proceed to installation:</span><br><span class="line"></span><br><span class="line">6ddc10e56b574f27a360986f84da19fc</span><br><span class="line"></span><br><span class="line">This may also be found at: /root/.jenkins/secrets/initialAdminPassword</span><br><span class="line"></span><br><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br></pre></td></tr></table></figure><p></p><p>å…¶ä¸­<code>6ddc10e56b574f27a360986f84da19fc</code>ä¸ºJenkinsçš„å¯†ç ï¼Œè¯¥å¯†ç ä¹Ÿå¯ä»¥åœ¨/root/.jenkins/secrets/initialAdminPasswordæ–‡ä»¶æ‰¾åˆ°ã€‚</p><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="http://192.168.33.11:8081/" target="_blank" rel="noopener">http://192.168.33.11:8081/</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191121085911.png" alt="QQæˆªå›¾20191115145623.png"></p><p>è¾“å…¥ä¸Šé¢çš„å¯†ç ï¼Œè¿›å…¥ï¼š</p><p><img src="img/QQæˆªå›¾20191115145856.png" alt="QQæˆªå›¾20191115145856.png"></p><p>ç‚¹å‡»â€œé€‰æ‹©æ’ä»¶å®‰è£…â€ï¼Œç„¶å<strong>Pipelines and Continuous Delivery</strong>ä¸€æ ä¸­çš„æ‰€æœ‰æ’ä»¶éƒ½å‹¾é€‰ä¸Šï¼š</p><p><img src="img/QQæˆªå›¾20191115150023.png" alt="QQæˆªå›¾20191115150023.png"></p><p>ç„¶åç‚¹å‡»å®‰è£…å³å¯ï¼Œå®‰è£…ç»“æŸåï¼Œæ¥ç€åˆ›å»ºç”¨æˆ·ï¼š</p><p><img src="img/QQæˆªå›¾20191115155632.png" alt="QQæˆªå›¾20191115155632.png"></p><p>ç‚¹å‡»é‡å¯ï¼š</p><p><img src="img/QQæˆªå›¾20191115160201.png" alt="QQæˆªå›¾20191115160201.png"></p><p>ç”¨åˆšåˆšåˆ›å»ºçš„ç”¨æˆ·ç™»å½•å³å¯ï¼š</p><p><img src="img/QQæˆªå›¾20191115160710.png" alt="QQæˆªå›¾20191115160710.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨CentOSä¸‹å®‰è£…GitLabå’ŒJenkinsã€‚
    
    </summary>
    
    
      <category term="GitLab" scheme="http://mrbird.cc/tags/GitLab/"/>
    
      <category term="Jenkins" scheme="http://mrbird.cc/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>æ­å»ºDockeré•œåƒä»“åº“Harbor</title>
    <link href="http://mrbird.cc/Harbor.html"/>
    <id>http://mrbird.cc/Harbor.html</id>
    <published>2019-11-14T02:15:50.000Z</published>
    <updated>2020-01-21T03:30:03.127Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>Harboræ˜¯ä¸€æ¬¾å¼€æºçš„Dockeré•œåƒå­˜å‚¨ä»“åº“ï¼Œå…¶æ‰©å±•äº†Docker Distributionï¼Œåœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ äº†æˆ‘ä»¬å¸¸ç”¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å®‰å…¨è®¤è¯ï¼ŒRBACç”¨æˆ·æƒé™ç®¡ç†ï¼Œå¯è§†åŒ–é¡µé¢æ“ä½œç­‰åŠŸèƒ½ã€‚Harborè¿˜æ”¯æŒå¤šä¸ªHarborä»“åº“é—´çš„ç›¸äº’æ‹·è´ï¼Œä»¥å®ç°Dockeré•œåƒä»“åº“çš„é«˜å¯ç”¨ã€‚è¿™èŠ‚æˆ‘ä»¬åœ¨CentOSè™šæ‹Ÿæœºï¼ˆ192.168.33.11ï¼‰ä¸Šæ­å»ºä¸ªå•æœºç‰ˆçš„Harborä½“éªŒä¸€ä¸‹ã€‚<a id="more"></a></p><h2 id="å®‰è£…Harbor"><a href="#å®‰è£…Harbor" class="headerlink" title="å®‰è£…Harbor"></a>å®‰è£…Harbor</h2><p>åœ¨Harborçš„GitHubä»“åº“ï¼š<a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">https://github.com/goharbor/harbor/releases</a>ä¸‹è½½ç¦»çº¿ç‰ˆæœ¬ï¼ˆofflineï¼‰ï¼Œæˆ‘é€‰æ‹©çš„ç‰ˆæœ¬æ˜¯1.8.4ï¼š</p><p><img src="img/QQæˆªå›¾20191114145009.png" alt="QQæˆªå›¾20191114145009.png"></p><p>ä¸‹è½½åï¼Œå°†å‹ç¼©åŒ…harbor-offline-installer-v1.8.4.tgzä¸Šä¼ åˆ°192.168.33.11æœåŠ¡å™¨ä¸Šï¼š</p><p><img src="img/QQæˆªå›¾20191114164739.png" alt="QQæˆªå›¾20191114164739.png"></p><p>è§£å‹å‹ç¼©åŒ…ï¼š</p><p><img src="img/QQæˆªå›¾20191114164856.png" alt="QQæˆªå›¾20191114150144.png"></p><p>ä¿®æ”¹Harboré…ç½®æ–‡ä»¶ï¼š</p><p><img src="img/QQæˆªå›¾20191114164934.png" alt="QQæˆªå›¾20191114150253.png"></p><p>å°†hostnameä¿®æ”¹ä¸ºå®¿ä¸»æœºIPå³å¯ï¼š</p><p><img src="img/QQæˆªå›¾20191114165021.png" alt="QQæˆªå›¾20191114150354.png"></p><p>ç„¶åæ‰§è¡Œå½“å‰ç›®å½•ä¸‹çš„install.shè„šæœ¬è¿›è¡Œå®‰è£…ã€‚</p><p>å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š</p><p><img src="img/QQæˆªå›¾20191114150640.png" alt="QQæˆªå›¾20191114150640.png"></p><p>æ ¹æ®<a href="https://docs.docker.com/compose/install/" target="_blank" rel="noopener">https://docs.docker.com/compose/install/</a>å®‰è£…docker composeåé‡æ–°æ‰§è¡Œinstall.shè„šæœ¬ã€‚</p><p>å‡ºç°å¦‚ä¸‹ä¿¡æ¯æ—¶ï¼Œå®‰è£…æˆåŠŸ:</p><p><img src="img/QQæˆªå›¾20191114165532.png" alt="QQæˆªå›¾20191114151457.png"></p><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="http://192.168.33.11/" target="_blank" rel="noopener">http://192.168.33.11/</a>åœ°å€ï¼Œå¯ä»¥çœ‹åˆ°Harborçš„ç®¡ç†ç•Œé¢ï¼š</p><p><img src="img/QQæˆªå›¾20191114165616.png" alt="QQæˆªå›¾20191114151916.png"></p><p>é»˜è®¤çš„ç”¨æˆ·åå¯†ç ä¸ºï¼šadminï¼ŒHarbor12345ï¼Œç™»å½•åï¼š</p><p><img src="img/QQæˆªå›¾20191114165700.png" alt="QQæˆªå›¾20191114152147.png"></p><p>ä¸ºäº†åç»­æ¨é€é•œåƒæ–¹ä¾¿ï¼Œæˆ‘ä»¬éœ€è¦ç»™192.168.33.11é…ç½®åŸŸåï¼Œæ·»åŠ hostsè§£æï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.33.11 docker.mrbird.cc</span><br></pre></td></tr></table></figure><p></p><h2 id="åˆ›å»ºç”¨æˆ·å’Œé¡¹ç›®"><a href="#åˆ›å»ºç”¨æˆ·å’Œé¡¹ç›®" class="headerlink" title="åˆ›å»ºç”¨æˆ·å’Œé¡¹ç›®"></a>åˆ›å»ºç”¨æˆ·å’Œé¡¹ç›®</h2><p>åœ¨<a href="http://192.168.33.11/" target="_blank" rel="noopener">http://192.168.33.11/</a>Harborç®¡ç†ç•Œé¢ä¸‹æ–°å¢ä¸€ä¸ªç”¨æˆ·ï¼š</p><p><img src="img/QQæˆªå›¾20191114165828.png" alt="QQæˆªå›¾20191114154608.png"></p><p><img src="img/QQæˆªå›¾20191114165905.png" alt="QQæˆªå›¾20191114154646.png"></p><p>ç„¶åæ–°å¢ä¸€ä¸ªé¡¹ç›®ï¼š</p><p><img src="img/QQæˆªå›¾20191114165952.png" alt="QQæˆªå›¾20191114154755.png"></p><p><img src="img/QQæˆªå›¾20191114170013.png" alt="QQæˆªå›¾20191114154830.png"></p><p>åœ¨è¯¥é¡¹ç›®ä¸‹æ·»åŠ åˆšåˆšåˆ›å»ºçš„mrbirdç”¨æˆ·ï¼š</p><p><img src="img/QQæˆªå›¾20191114170054.png" alt="QQæˆªå›¾20191114155249.png"></p><p><img src="img/QQæˆªå›¾20191114170137.png" alt="QQæˆªå›¾20191114155318.png"></p><p>æ¥ç€åœ¨192.168.33.11ä¸Šè¿›è¡Œç™»å½•:</p><p><img src="img/QQæˆªå›¾20191114170510.png" alt="QQæˆªå›¾20191114170510.png"></p><p>ç”¨æˆ·åå’Œå¯†ç å°±æ˜¯åˆšåˆšåœ¨æ§åˆ¶å°åˆ›å»ºçš„mrbirdç”¨æˆ·å’Œå¯†ç ã€‚ä½†æ˜¯ç™»å½•å¤±è´¥äº†ï¼Œè¦ç™»å½•åˆ°http dockerä»“åº“ï¼Œéœ€è¦æ·»åŠ ä¸€äº›é…ç½®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure><p></p><p>æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><p><img src="img/QQæˆªå›¾20191114170718.png" alt="QQæˆªå›¾20191114170718.png"></p><p>é‡å¯dockerï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service docker restart</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åé‡æ–°ç™»å½•å³å¯ï¼š</p><p><img src="img/QQæˆªå›¾20191114171254.png" alt="QQæˆªå›¾20191114171254.png"></p><h2 id="æµ‹è¯•é•œåƒæ¨æ‹‰"><a href="#æµ‹è¯•é•œåƒæ¨æ‹‰" class="headerlink" title="æµ‹è¯•é•œåƒæ¨æ‹‰"></a>æµ‹è¯•é•œåƒæ¨æ‹‰</h2><p>æ‹‰å–nginx:1.17.5é•œåƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx:1.17.5</span><br></pre></td></tr></table></figure><p></p><p>æ‰“æ ‡ç­¾:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag nginx:1.17.5 docker.mrbird.cc/febs/nginx:1.17.5</span><br></pre></td></tr></table></figure><p></p><p>æ ‡ç­¾æ ¼å¼ä¸º[dockerä»“åº“åŸŸå]:[é¡¹ç›®åç§°]:[é•œåƒ]ã€‚</p><p>å°†docker.mrbird.cc/febs/nginx:1.17.5æ¨é€åˆ°Harborï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push docker.mrbird.cc/febs/nginx</span><br></pre></td></tr></table></figure><p></p><p>å›åˆ°Harboræ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°åœ¨febsé¡¹ç›®ä¸‹å·²ç»å­˜åœ¨ä¸€ä¸ªnginxé•œåƒï¼š</p><p><img src="img/QQæˆªå›¾20191114171855.png" alt="QQæˆªå›¾20191114171855.png"></p><p>åœ¨192.168.33.12æœåŠ¡å™¨ä¸Šæ·»åŠ docker.mrbird.ccçš„è§£æï¼Œç„¶åæ‹‰å–åˆšåˆšçš„é•œåƒï¼Œçœ‹çœ‹æ˜¯å¦æˆåŠŸï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.mrbird.cc/febs/nginx:1.17.5</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191114172154.png" alt="QQæˆªå›¾20191114172154.png"></p><p>æ‹‰å–æˆåŠŸã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Harboræ˜¯ä¸€æ¬¾å¼€æºçš„Dockeré•œåƒå­˜å‚¨ä»“åº“ï¼Œå…¶æ‰©å±•äº†Docker Distributionï¼Œåœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ äº†æˆ‘ä»¬å¸¸ç”¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å®‰å…¨è®¤è¯ï¼ŒRBACç”¨æˆ·æƒé™ç®¡ç†ï¼Œå¯è§†åŒ–é¡µé¢æ“ä½œç­‰åŠŸèƒ½ã€‚Harborè¿˜æ”¯æŒå¤šä¸ªHarborä»“åº“é—´çš„ç›¸äº’æ‹·è´ï¼Œä»¥å®ç°Dockeré•œåƒä»“åº“çš„é«˜å¯ç”¨ã€‚è¿™èŠ‚æˆ‘ä»¬åœ¨CentOSè™šæ‹Ÿæœºï¼ˆ192.168.33.11ï¼‰ä¸Šæ­å»ºä¸ªå•æœºç‰ˆçš„Harborä½“éªŒä¸€ä¸‹ã€‚
    
    </summary>
    
    
      <category term="Harbor" scheme="http://mrbird.cc/tags/Harbor/"/>
    
      <category term="Docker" scheme="http://mrbird.cc/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetesèµ„æºç®¡ç†</title>
    <link href="http://mrbird.cc/Kubernetes-Resource-Management.html"/>
    <id>http://mrbird.cc/Kubernetes-Resource-Management.html</id>
    <published>2019-11-09T04:52:56.000Z</published>
    <updated>2020-01-21T03:30:03.135Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>é€šè¿‡å‰é¢çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡requestså’Œlimitsç»™PodæŒ‡å®šèµ„æºé…ç½®ï¼Œä½†å¦‚æœæ¯ä¸ªPodéƒ½è¦æŒ‡å®šçš„è¯ç•¥æ˜¾ç¹çï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨LimitRangeæŒ‡å®šä¸€ä¸ªå…¨å±€çš„é»˜è®¤é…ç½®ï¼›æ­¤å¤–é€šè¿‡ResourceQuotaå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰èµ„æºé…é¢ï¼Œè¿™ä¸ªèµ„æºé…é¢å¯ä»¥ä¸ºæ¯ä¸ªå‘½åç©ºé—´éƒ½æä¾›ä¸€ä¸ªæ€»ä½“çš„èµ„æºä½¿ç”¨çš„é™åˆ¶ï¼šå®ƒå¯ä»¥é™åˆ¶å‘½åç©ºé—´ä¸­æŸç§ç±»å‹çš„å¯¹è±¡çš„æ€»æ•°ç›®ä¸Šé™ï¼Œä¹Ÿå¯ä»¥è®¾ç½®å‘½åç©ºé—´ä¸­Podå¯ä»¥ä½¿ç”¨çš„è®¡ç®—èµ„æºçš„æ€»ä¸Šé™ã€‚</p><a id="more"></a><h2 id="LimitRange"><a href="#LimitRange" class="headerlink" title="LimitRange"></a>LimitRange</h2><p>åœ¨ä½¿ç”¨LimitRangeä¹‹å‰å…ˆåˆ›å»ºä¸€ä¸ªå‘½åç©ºé—´ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: test-resource</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åå®šä¹‰LimitRangeé…ç½®ï¼ˆlimit-range.ymlï¼‰:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">limit-range-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  limits:</span></span><br><span class="line"><span class="attr">    - max:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">2</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">      min:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">200</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">6</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">      maxLimitRequestRatio:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">    - default:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">300</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">200</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">      defaultRequest:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">200</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">100</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">      max:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">      min:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">3</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">      maxLimitRequestRatio:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">Container</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥LimitRangeï¼š</p><p><img src="img/QQæˆªå›¾20191112092850.png" alt="QQæˆªå›¾20191112092850.png"></p><p>å¯ä»¥çœ‹åˆ°é…ç½®å·²ç»ç”Ÿæ•ˆäº†ã€‚ä¸‹é¢ä»‹ç»ä¸‹è¿™äº›é…ç½®çš„å«ä¹‰ï¼š</p><p>ä¸Šé¢é…ç½®åˆ†ä¸ºPodå’ŒContaineré…ç½®ï¼ŒContainerèµ„æºé…ç½®å¯¹åº”æ¯ä¸ªDockerå®¹å™¨çš„èµ„æºé…ç½®ï¼ŒPodèµ„æºé…ç½®å¯¹åº”ä¸€ä¸ªPodä¸­æ‰€æœ‰å®¹å™¨èµ„æºçš„æ€»å’Œã€‚å…¶ä¸­Podå’ŒContaineréƒ½å¯ä»¥æŒ‡å®š<code>min</code>ï¼Œ<code>max</code>å’Œ<code>maxLimitRequestRatio</code>ï¼š</p><ol><li><p><code>min</code>ï¼šæŒ‡å®šèµ„æºçš„ä¸‹é™ï¼Œå³æœ€ä½èµ„æºé…ç½®ä¸èƒ½ä½äºè¿™ä¸ªå€¼ï¼›</p></li><li><p><code>max</code>ï¼šæŒ‡å®šèµ„æºçš„ä¸Šé™ï¼Œå³æœ€é«˜èµ„æºä½¿ç”¨ä¸èƒ½é«˜äºè¿™ä¸ªå€¼ï¼›</p></li><li><p><code>maxLimitRequestRatio</code>ï¼šè¯¥å€¼ç”¨äºæŒ‡å®šrequestså’Œlimitså€¼æ¯”ä¾‹çš„ä¸Šé™ã€‚</p></li></ol><p>ç›¸è¾ƒäºPodï¼ŒContainerè¿˜å¯ä»¥æŒ‡å®š<code>defaultRequest</code>å’Œ<code>default</code>ï¼ˆå®é™…ä¸Šå°±æ˜¯<code>defaultLimit</code>ï¼Œä¸æ‡‚ä¸ºä»€ä¹ˆKubernetesä¸ç”¨è¿™ä¸ªåç§°ğŸ˜µï¼‰ï¼š</p><ol><li><p><code>defaultRequest</code>ï¼šå…¨å±€å®¹å™¨çš„é»˜è®¤<code>requests</code>å€¼ï¼›</p></li><li><p><code>default</code>ï¼šå…¨å±€å®¹å™¨çš„é»˜è®¤<code>limits</code>å€¼ã€‚</p></li></ol><p>ä¸‹é¢æˆ‘ä»¬ä¸¾å‡ ä¸ªä¾‹å­ï¼Œçœ‹çœ‹æˆ‘ä»¬åˆ›å»ºçš„LimitRangeæ˜¯å¦ç”Ÿæ•ˆã€‚</p><p>å®šä¹‰ä¸€ä¸ªPodé…ç½®æ–‡ä»¶ï¼ˆtest-default.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼š</p><p><img src="img/QQæˆªå›¾20191112094923.png" alt="QQæˆªå›¾20191112094923.png"></p><p><img src="img/QQæˆªå›¾20191112094959.png" alt="QQæˆªå›¾20191112094959.png"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨test-default.ymlä¸­å¹¶æ²¡æœ‰å®šä¹‰requestså’Œlimitsé…ç½®ï¼Œä½†æ˜¯é€šè¿‡Podå®ä¾‹çš„yamlå¯ä»¥çœ‹åˆ°å®ƒå·²ç»æŒ‡å®šäº†è¿™ä¸¤ä¸ªå€¼ï¼Œè€Œè¿™äº›æ­£æ˜¯ä¸Šé¢æˆ‘ä»¬åœ¨LimitRangeä¸­å®šä¹‰çš„é»˜è®¤å€¼ã€‚</p><p>æ¥ç€å®šä¹‰ä¸€ä¸ªæ–°çš„Podé…ç½®ï¼ˆtest-max.ymlï¼‰:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-max</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        limits:</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="number">500</span><span class="string">Mi</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼š</p><p><img src="img/QQæˆªå›¾20191112095603.png" alt="QQæˆªå›¾20191112095603.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨åˆ›å»ºçš„æ—¶å€™å°±æŠ¥é”™äº†ï¼Œå› ä¸ºä¸Šé¢çš„cpué…ç½®å³è¶…è¿‡äº†LimtRangeä¸­å®šä¹‰çš„Containerçš„cpuæœ€é«˜é…ç½®ï¼Œä¹Ÿè¶…è¿‡äº†Podçš„cpuçš„æœ€é«˜é…ç½®ã€‚</p><p>å†åˆ›å»ºä¸€ä¸ªPodé…ç½®ï¼ˆtest-ratio.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-ratio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        limits:</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="number">500</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="number">300</span><span class="string">m</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼š</p><p><img src="img/QQæˆªå›¾20191112100308.png" alt="QQæˆªå›¾20191112100308.png"></p><p>å¯ä»¥çœ‹åˆ°ä¹ŸæŠ¥é”™äº†ï¼Œå› ä¸ºrequestså’Œlimitsçš„æ¯”ä¾‹ä¸ç¬¦åˆLimitRangeçš„maxLimitRequestRatioé…ç½®ã€‚</p><p>LimitRangeçš„æµ‹è¯•å…ˆåˆ°è¿™é‡Œå§ï¼Œé€šè¿‡ä¸Šé¢ä¸‰ä¸ªä¾‹å­å¤§ä½“ä¹Ÿèƒ½æ„Ÿå—åˆ°LimitRangeçš„ä½œç”¨äº†ã€‚</p><h2 id="ResourceQuota"><a href="#ResourceQuota" class="headerlink" title="ResourceQuota"></a>ResourceQuota</h2><p>ResourceQuotaç”¨äºç®¡ç†èµ„æºé…é¢ï¼Œè¿™ä¸ªèµ„æºé…é¢å¯ä»¥ä¸ºæ¯ä¸ªå‘½åç©ºé—´éƒ½æä¾›ä¸€ä¸ªæ€»ä½“çš„èµ„æºä½¿ç”¨çš„é™åˆ¶ã€‚èµ„æºé…é¢ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªç±»å‹ï¼š</p><h3 id="è®¡ç®—èµ„æºé…é¢"><a href="#è®¡ç®—èµ„æºé…é¢" class="headerlink" title="è®¡ç®—èµ„æºé…é¢"></a>è®¡ç®—èµ„æºé…é¢</h3><table align="center"><thead><tr><th scope="col">èµ„æºåç§°</th><th scope="col">è¯´æ˜</th></tr></thead><tbody><tr><td>Cpu</td><td>æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€çš„Podï¼ŒCPU Requestsçš„æ€»å’Œä¸èƒ½è¶…è¿‡è¯¥å€¼</td></tr><tr><td>limits.cpu</td><td>æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€çš„Podï¼Œ CPU Limitsçš„æ€»å’Œä¸èƒ½è¶…è¿‡è¯¥å€¼</td></tr><tr><td>limits.memory</td><td>æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€çš„Podï¼Œå†…å­˜ Limitsçš„æ€»å’Œä¸èƒ½è¶…è¿‡è¯¥å€¼</td></tr><tr><td>Memory</td><td>æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€çš„Podï¼Œ å†…å­˜ Requestsçš„æ€»å’Œä¸èƒ½è¶…è¿‡è¯¥å€¼</td></tr><tr><td>requests.cpu</td><td>æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€çš„Podï¼ŒCPU Requestsçš„æ€»å’Œä¸èƒ½è¶…è¿‡è¯¥å€¼</td></tr><tr><td>requests.memory</td><td>æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€çš„Podï¼Œ å†…å­˜Requestsçš„æ€»å’Œä¸èƒ½è¶…è¿‡è¯¥å€¼</td></tr></tbody></table><h3 id="å­˜å‚¨èµ„æºé…é¢"><a href="#å­˜å‚¨èµ„æºé…é¢" class="headerlink" title="å­˜å‚¨èµ„æºé…é¢"></a>å­˜å‚¨èµ„æºé…é¢</h3><table><thead><tr><th scope="col">èµ„æºåç§°</th><th scope="col">è¯´æ˜</th></tr></thead><tbody><tr><td>requests.storage</td><td>æ‰€æœ‰PVCï¼Œå­˜å‚¨è¯·æ±‚æ€»é‡ä¸èƒ½è¶…è¿‡æ­¤å€¼</td></tr><tr><td>PersistentVolumeclaims</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„æŒä¹…å·çš„æ€»æ•°ä¸Šé™</td></tr><tr><td>.storageclass.storage.k8s.io/requests.storage</td><td>å’Œè¯¥å­˜å‚¨ç±»å…³è”çš„æ‰€æœ‰PVCï¼Œå­˜å‚¨è¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡æ­¤å€¼</td></tr><tr><td>.storageclass.storage.k8s.io/persistentvolumeclaims</td><td>å’Œè¯¥å­˜å‚¨ç±»å…³è”çš„æ‰€æœ‰PVCçš„æ€»å’Œ</td></tr></tbody></table><h3 id="å¯¹è±¡æ•°é‡é…é¢"><a href="#å¯¹è±¡æ•°é‡é…é¢" class="headerlink" title="å¯¹è±¡æ•°é‡é…é¢"></a>å¯¹è±¡æ•°é‡é…é¢</h3><table><thead><tr><th scope="col">èµ„æºåç§°</th><th scope="col">è¯´æ˜</th></tr></thead><tbody><tr><td>Configmaps</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„ConfigMapçš„æ€»æ•°ä¸Šé™</td></tr><tr><td><p>Pods</p></td><td><p>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„éç»ˆæ­¢çŠ¶æ€Podçš„æ€»æ•°ä¸Šé™ï¼ŒPodç»ˆæ­¢çŠ¶æ€ç­‰ä»·äºPodçš„</p><p>status.phase in(Failed, Succeeded) = true</p></td></tr><tr><td>Replicationcontrollers</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„RCçš„æ€»æ•°ä¸Šé™</td></tr><tr><td>Resourcequtas</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„èµ„æºé…é¢é¡¹çš„æ€»æ•°ä¸Šé™</td></tr><tr><td>Services</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„Serviceçš„æ€»æ•°ä¸Šé™</td></tr><tr><td>service.loadbalancers</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„è´Ÿè½½å‡è¡¡çš„æ€»æ•°ä¸Šé™</td></tr><tr><td>services.nodeports</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„NodePortçš„æ€»æ•°ä¸Šé™</td></tr><tr><td>Secrets</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„Secretçš„æ€»æ•°ä¸Šé™</td></tr></tbody></table><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>åœ¨æµ‹è¯•ResourceQuotaä¹‹å‰æˆ‘ä»¬ä¹Ÿå…ˆåˆ›å»ºä¸€ä¸ªå‘½åç©ºé—´ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">quota-ns</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºä¸ªç®€å•çš„ResourceQuotaé…ç½®ï¼ˆtest-quota.ymlï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ResourceQuota</span><br><span class="line">metadata:</span><br><span class="line">  name: test-quota</span><br><span class="line">spec:</span><br><span class="line">  hard:</span><br><span class="line">    pods: &quot;4&quot;</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥ResourceQuotaï¼š</p><p><img src="img/QQæˆªå›¾20191112104240.png" alt="QQæˆªå›¾20191112104240.png"></p><p>æ¥ç€å®šä¹‰ä¸€ä¸ªRCé…ç½®ï¼ˆnginx-rc.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥RC:</p><p><img src="img/QQæˆªå›¾20191112104507.png" alt="QQæˆªå›¾20191112104507.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»æœ‰3ä¸ªPodå®ä¾‹äº†ï¼Œå¦‚æœå°†Podæ•°é‡æ‰©å¤§åˆ°5ï¼Œçœ‹çœ‹ä¼šæ€æ ·ï¼š</p><p><img src="img/QQæˆªå›¾20191112104655.png" alt="QQæˆªå›¾20191112104655.png"></p><p>æœ€ç»ˆä¹Ÿåªä¼šæœ‰4ä¸ªPodå®ä¾‹ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸Šé¢ResourceQuotaä¸­æŒ‡å®šçš„æœ€å¤§Podæ•°é‡ä¸º4ã€‚</p><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;é€šè¿‡å‰é¢çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡requestså’Œlimitsç»™PodæŒ‡å®šèµ„æºé…ç½®ï¼Œä½†å¦‚æœæ¯ä¸ªPodéƒ½è¦æŒ‡å®šçš„è¯ç•¥æ˜¾ç¹çï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨LimitRangeæŒ‡å®šä¸€ä¸ªå…¨å±€çš„é»˜è®¤é…ç½®ï¼›æ­¤å¤–é€šè¿‡ResourceQuotaå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰èµ„æºé…é¢ï¼Œè¿™ä¸ªèµ„æºé…é¢å¯ä»¥ä¸ºæ¯ä¸ªå‘½åç©ºé—´éƒ½æä¾›ä¸€ä¸ªæ€»ä½“çš„èµ„æºä½¿ç”¨çš„é™åˆ¶ï¼šå®ƒå¯ä»¥é™åˆ¶å‘½åç©ºé—´ä¸­æŸç§ç±»å‹çš„å¯¹è±¡çš„æ€»æ•°ç›®ä¸Šé™ï¼Œä¹Ÿå¯ä»¥è®¾ç½®å‘½åç©ºé—´ä¸­Podå¯ä»¥ä½¿ç”¨çš„è®¡ç®—èµ„æºçš„æ€»ä¸Šé™ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Namespace&amp;Context</title>
    <link href="http://mrbird.cc/Kubernetes-Namespaces-Context.html"/>
    <id>http://mrbird.cc/Kubernetes-Namespaces-Context.html</id>
    <published>2019-11-08T04:53:11.000Z</published>
    <updated>2020-01-21T03:30:03.134Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>åœ¨ä¸€ä¸ªç»„ç»‡å†…éƒ¨ï¼Œä¸åŒçš„å·¥ä½œç»„å¯ä»¥åœ¨åŒä¸€ä¸ªKubernetesé›†ç¾¤ä¸­å·¥ä½œï¼ŒKubernetesé€šè¿‡å‘½åç©ºé—´å’ŒContextçš„è®¾ç½®å¯¹ä¸åŒçš„å·¥ä½œç»„è¿›è¡ŒåŒºåˆ†ï¼Œä½¿å¾—å®ƒä»¬æ—¢å¯ä»¥å…±äº«åŒä¸€ä¸ªKubernetesé›†ç¾¤çš„æœåŠ¡ï¼Œä¹Ÿèƒ½å¤Ÿäº’ä¸å¹²æ‰°ã€‚</p><a id="more"></a><h2 id="Namespaceçš„åˆ›å»º"><a href="#Namespaceçš„åˆ›å»º" class="headerlink" title="Namespaceçš„åˆ›å»º"></a>Namespaceçš„åˆ›å»º</h2><p>Kubernetesé›†ç¾¤ä¼šå¸®æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåç§°ä¸ºdefaultçš„å‘½åç©ºé—´ï¼š</p><p><img src="img/QQæˆªå›¾20191109160144.png" alt="QQæˆªå›¾20191109160144.png"></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„podã€rcã€serviceç­‰Kubernetesèµ„æºéƒ½æ˜¯ä½¿ç”¨è¿™ä¸ªå‘½åç©ºé—´ï¼Œæ­¤å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå·±çš„å‘½åç©ºé—´ã€‚</p><p>å®šä¹‰ä¸€ä¸ªå‘½åç©ºé—´é…ç½®dev-namesapce.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dev</span> <span class="comment"># devå‘½åç©ºé—´</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥å‘½åç©ºé—´ï¼š</p><p><img src="img/QQæˆªå›¾20191109160534.png" alt="QQæˆªå›¾20191109160534.png"></p><h2 id="ä½¿ç”¨Namespace"><a href="#ä½¿ç”¨Namespace" class="headerlink" title="ä½¿ç”¨Namespace"></a>ä½¿ç”¨Namespace</h2><p>ä½¿ç”¨å‘½åç©ºé—´åªéœ€è¦åœ¨åˆ›å»ºKubernetesèµ„æºå¯¹è±¡çš„æ—¶å€™æŒ‡å®šå³å¯ï¼Œæ¯”å¦‚åˆ›å»ºä¸€ä¸ªtomcat-rc.ymlï¼Œå¹¶æŒ‡å®šå‘½åç©ºé—´ä¸ºdevï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-rc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">dev</span> <span class="comment"># æŒ‡å®šå‘½åç©ºé—´</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">              hostPort:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥rcï¼š</p><p><img src="img/20191109161045.png" alt="20191109161045.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œdefalutå‘½åç©ºé—´ä¸‹å¹¶æ²¡æœ‰ä»»ä½•podï¼Œè€Œdevå‘½åç©ºé—´ä¸‹åˆ™æœ‰ä¸¤ä¸ªtomcat podå®ä¾‹ã€‚</p><div class="note danger"><p>å‘½åç©ºé—´åªæ˜¯åç§°ä¸Šçš„éš”ç¦»ï¼Œä¸åŒå‘½åç©ºé—´ä¸‹çš„podï¼Œserviceç­‰è¿˜æ˜¯å¯ä»¥ç›¸äº’è®¿é—®çš„ã€‚</p></div><h2 id="Contextçš„åˆ›å»ºå’Œä½¿ç”¨"><a href="#Contextçš„åˆ›å»ºå’Œä½¿ç”¨" class="headerlink" title="Contextçš„åˆ›å»ºå’Œä½¿ç”¨"></a>Contextçš„åˆ›å»ºå’Œä½¿ç”¨</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºContextï¼ˆä¸Šä¸‹æ–‡ï¼‰ï¼ŒæŒ‡å®šä½¿ç”¨çš„å‘½åç©ºé—´ï¼Œç„¶åä½¿ç”¨è¯¥Contextï¼Œæ¥å®Œæˆé»˜è®¤çš„å‘½åç©ºé—´åˆ‡æ¢ã€‚</p><p>åœ¨åˆ›å»ºContextå‰ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸‹Kubernetesé»˜è®¤çš„é…ç½®ï¼š</p><p><img src="img/QQæˆªå›¾20191109162819.png" alt="QQæˆªå›¾20191109162819.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰é»˜è®¤çš„Contextåç§°ä¸ºkubernetes-admin@kubernetesï¼Œç”±æ­¤å¯ä»¥æ¨æ–­ï¼Œå®ƒå’Œdefalutè¿™ä¸ªå‘½åç©ºé—´æŒ‚é’©ã€‚</p><p>åˆ›å»ºä¸€ä¸ªæ–°çš„Contextï¼Œåç§°ä¸ºctx-devï¼Œå‘½åç©ºé—´ä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„devï¼š</p><p><img src="img/QQæˆªå›¾20191109162659.png" alt="QQæˆªå›¾20191109162659.png"></p><p>å…¶ä¸­<code>/root/.kube/config</code>ä¸ºKubernetesé…ç½®ã€‚</p><p>åˆ›å»ºæˆåŠŸåï¼Œæˆ‘ä»¬ä½¿ç”¨ctx-devè¿™ä¸ªContextï¼š</p><p><img src="img/QQæˆªå›¾20191109163224.png" alt="QQæˆªå›¾20191109163224.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨ä¸éœ€è¦æŒ‡å®š<code>-n dev</code>å°±å¯ä»¥è·å–åˆ°devå‘½åç©ºé—´ä¸‹çš„podäº†ï¼Œä¹Ÿè¯å®äº†Contextçš„åˆ‡æ¢æ˜¯æˆåŠŸçš„ã€‚</p><p>å¦‚æœæƒ³è¦æ¢å¤é»˜è®¤çš„Contextï¼Œå°†ContextæŒ‡å®šä¸ºkubernetes-admin@kubernetesï¼š</p><p><img src="img/QQæˆªå›¾20191109163514.png" alt="QQæˆªå›¾20191109163514.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨ä¸€ä¸ªç»„ç»‡å†…éƒ¨ï¼Œä¸åŒçš„å·¥ä½œç»„å¯ä»¥åœ¨åŒä¸€ä¸ªKubernetesé›†ç¾¤ä¸­å·¥ä½œï¼ŒKubernetesé€šè¿‡å‘½åç©ºé—´å’ŒContextçš„è®¾ç½®å¯¹ä¸åŒçš„å·¥ä½œç»„è¿›è¡ŒåŒºåˆ†ï¼Œä½¿å¾—å®ƒä»¬æ—¢å¯ä»¥å…±äº«åŒä¸€ä¸ªKubernetesé›†ç¾¤çš„æœåŠ¡ï¼Œä¹Ÿèƒ½å¤Ÿäº’ä¸å¹²æ‰°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes ServiceåŸºç¡€</title>
    <link href="http://mrbird.cc/Kubernetes-Service-Basic.html"/>
    <id>http://mrbird.cc/Kubernetes-Service-Basic.html</id>
    <published>2019-11-07T06:30:59.000Z</published>
    <updated>2020-01-21T03:30:03.135Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>Kuberneteså¯ä»¥ä¸ºä¸€ç»„å…·æœ‰ç›¸åŒåŠŸèƒ½çš„Podæä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£åœ°å€ï¼Œå¹¶ä¸”å°†è¯·æ±‚å‡è¡¡çš„è½¬å‘åˆ°å„ä¸ªå¯¹åº”çš„Podä¸Šã€‚æœ¬èŠ‚ä¸»è¦è®°å½•Serviceçš„ä¸€äº›åŸºæœ¬ç”¨æ³•ã€‚</p><a id="more"></a><h2 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h2><p>åˆ›å»ºä¸€ä¸ªTomcat RCï¼ˆtomcat-rc.ymlï¼‰:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥RCï¼š</p><p><img src="img/QQæˆªå›¾20191109095409.png" alt="QQæˆªå›¾20191109095409.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡Node IP + Container Portåœ¨Kubernetesé›†ç¾¤ä¸­è®¿é—®Tomcatï¼š</p><p><img src="img/QQæˆªå›¾20191109095554.png" alt="QQæˆªå›¾20191109095554.png"></p><p>ç”±äºPodæ˜¯Kubernetesé›†ç¾¤èŒƒå›´å†…çš„è™šæ‹Ÿæ¦‚å¿µï¼Œé›†ç¾¤å¤–çš„å®¢æˆ·ç«¯æ— æ³•é€šè¿‡Podçš„IPå’Œç«¯å£è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥å°†Podçš„ç«¯å£å·æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œä»¥ä½¿å®¢æˆ·ç«¯åº”ç”¨èƒ½å¤Ÿé€šè¿‡ç‰©ç†æœºè®¿é—®å®¹å™¨åº”ç”¨ï¼Œä¿®æ”¹åˆšåˆšçš„tomcat-rc.ymlï¼Œæ·»åŠ hostPortï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">              hostPort:</span> <span class="number">8081</span> <span class="comment"># æ–°å¢</span></span><br></pre></td></tr></table></figure><p>æ›´æ–°è¯¥RCï¼š</p><p><img src="img/QQæˆªå›¾20191109100036.png" alt="QQæˆªå›¾20191109100036.png"></p><p>å¯ä»¥çœ‹åˆ°tomcat podè¢«åˆ†é…åˆ°äº†node1å’Œnode2ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å®¿ä¸»æœºå¤–ä½¿ç”¨<a href=""></a>æˆ–è€…<a href=""></a>è®¿é—®tomcatï¼š</p><p><img src="img/QQæˆªå›¾20191109100307.png" alt="QQæˆªå›¾20191109100307.png"></p><p>ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼ŒPodçš„IPåœ°å€æ˜¯ä¸å¯é çš„ï¼Œä¾‹å¦‚å½“Podæ‰€åœ¨çš„Nodeå‘ç”Ÿæ•…éšœæ—¶ï¼ŒPodå°†è¢«Kubernetesé‡æ–°è°ƒåº¦åˆ°å¦ä¸€ä¸ªNodeï¼ŒPodçš„IPåœ°å€å°†å‘ç”Ÿå˜åŒ–ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªtomcat podçš„ç»Ÿä¸€è®¿é—®å…¥å£ï¼Œè¿™å°±æ˜¯Serviceçš„ä½œç”¨ã€‚</p><p>åˆ›å»ºServiceæœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p><strong>1.kubectl exposeå‘½ä»¤æ¥åˆ›å»ºService</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose rc tomcat-rc</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191109100642.png" alt="QQæˆªå›¾20191109100642.png"></p><p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡Serviceçš„clusterIP + Portæ¥è®¿é—®äº†ï¼š</p><p><img src="img/QQæˆªå›¾20191109100757.png" alt="QQæˆªå›¾20191109100757.png"></p><p>Serviceåœ°å€10.1.187.222:8080å‡è¡¡çš„è´Ÿè½½åˆ°äº†ä¸¤ä¸ªtomcat podä¸Šï¼ˆ10.244.1.19:8080å’Œ10.244.4.13:8080ï¼‰</p><p><strong>2.é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º</strong></p><p>å®šä¹‰ä¸€ä¸ªtomcat-service.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8081</span> <span class="comment"># serviceç«¯å£</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">8080</span> <span class="comment"># ç›®æ ‡ç«¯å£</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span> <span class="comment"># é€‰æ‹©å™¨ï¼Œé€‰æ‹©name=tomcatçš„pod</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Serviceï¼š</p><p><img src="img/QQæˆªå›¾20191109101415.png" alt="QQæˆªå›¾20191109101415.png"></p><p>åŒæ ·ï¼ŒServiceé»˜è®¤æ˜¯ä¸èƒ½å¤–éƒ¨è®¿é—®çš„ï¼Œå¦‚æœæƒ³è®©å¤–éƒ¨èƒ½å¤Ÿè®¿é—®åˆ°tomcat serviceï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å°†Serviceçš„ç«¯å£æ˜ å°„åˆ°ç‰©ç†æœºï¼Œä¿®æ”¹ä¸Šé¢çš„tomcat-service.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span> <span class="comment"># æ–°å¢</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30000</span> <span class="comment"># æ–°å¢</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢é…ç½®é€šè¿‡è®¾ç½®nodePortï¼ˆèŒƒå›´30000-32767ï¼‰æ˜ å°„åˆ°ç‰©ç†æœºï¼ŒåŒæ—¶è®¾ç½®Serviceçš„ç±»å‹ä¸ºNodePortï¼Œåˆ›å»ºè¯¥Serviceï¼š</p><p><img src="img/QQæˆªå›¾20191109102138.png" alt="QQæˆªå›¾20191109102138.png"></p><p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å®¿ä¸»æœºçš„IP+30000è®¿é—®tomcatäº†ï¼š</p><p><img src="img/QQæˆªå›¾20191109102418.png" alt="QQæˆªå›¾20191109102418.png"></p><h2 id="è´Ÿè½½å‡è¡¡ç­–ç•¥"><a href="#è´Ÿè½½å‡è¡¡ç­–ç•¥" class="headerlink" title="è´Ÿè½½å‡è¡¡ç­–ç•¥"></a>è´Ÿè½½å‡è¡¡ç­–ç•¥</h2><p>Kubernetes Serviceæä¾›äº†ä¸¤ç§è´Ÿè½½åˆ†å‘ç­–ç•¥ï¼šRoundRobinå’ŒSessionAffinityï¼š</p><ol><li>RoundRobinï¼šè½®è¯¢æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼Œå³è½®è¯¢å°†è¯·æ±‚è½¬å‘åˆ°åç«¯çš„å„ä¸ªPodä¸Šã€‚</li><li>SessionAffinityï¼šåŸºäºå®¢æˆ·ç«¯IPåœ°å€è¿›è¡Œä¼šè¯ä¿æŒçš„æ¨¡å¼ï¼Œå³ç¬¬1æ¬¡å°†æŸä¸ªå®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚è½¬å‘åˆ°åç«¯çš„æŸä¸ªPodä¸Šï¼Œä¹‹åä»ç›¸åŒçš„å®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚éƒ½å°†è¢«è½¬å‘åˆ°åç«¯ç›¸åŒçš„Podä¸Šã€‚å¯ä»¥é€šè¿‡è®¾ç½®service.spec.sessionAffinity=ClientIPæ¥å¯ç”¨SessionAffinityç­–ç•¥ï¼š<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  sessionAffinity:</span> <span class="string">ClientIP</span> <span class="comment"># é‡‡ç”¨SessionAffinityç­–ç•¥</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="Headless-Service"><a href="#Headless-Service" class="headerlink" title="Headless Service"></a>Headless Service</h2><p>Headless Serviceä¸æä¾›ClusterIPï¼Œä»…é€šè¿‡Label Selectorå°†åç«¯çš„Podåˆ—è¡¨è¿”å›ç»™è°ƒç”¨çš„å®¢æˆ·ç«¯ã€‚</p><p>åˆ›å»ºtomcat-headless-service.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-headless-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  clusterIP:</span> <span class="string">None</span> <span class="comment"># è®¾ç½®clusterIPä¸ºNoneï¼Œè¡¨ç¤ºheadless service</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥headless serviceï¼š</p><p><img src="img/QQæˆªå›¾20191109111632.png" alt="QQæˆªå›¾20191109111632.png"></p><p><img src="img/QQæˆªå›¾20191109111800.png" alt="QQæˆªå›¾20191109111800.png"></p><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Kuberneteså¯ä»¥ä¸ºä¸€ç»„å…·æœ‰ç›¸åŒåŠŸèƒ½çš„Podæä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£åœ°å€ï¼Œå¹¶ä¸”å°†è¯·æ±‚å‡è¡¡çš„è½¬å‘åˆ°å„ä¸ªå¯¹åº”çš„Podä¸Šã€‚æœ¬èŠ‚ä¸»è¦è®°å½•Serviceçš„ä¸€äº›åŸºæœ¬ç”¨æ³•ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Podæ‰©å®¹ä¸ç¼©å®¹</title>
    <link href="http://mrbird.cc/Kubernetes-Pod-Expansion-Contraction.html"/>
    <id>http://mrbird.cc/Kubernetes-Pod-Expansion-Contraction.html</id>
    <published>2019-11-07T06:19:48.000Z</published>
    <updated>2020-01-21T03:30:03.135Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>é’ˆå¯¹ä¸åŒæ—¶æœŸæµé‡çš„å¤§å°æˆ‘ä»¬å¯ä»¥ç»™Podæ‰©ç¼©å®¹ï¼ŒKubernetesæ”¯æŒé€šè¿‡kubectlå‘½ä»¤æ‰‹åŠ¨æ‰©ç¼©å®¹ï¼Œä¹Ÿæ”¯æŒé€šè¿‡HPAè‡ªåŠ¨æ¨ªå‘æ‰©ç¼©å®¹ã€‚<a id="more"></a></p><h2 id="æ‰‹åŠ¨æ‰©ç¼©å®¹"><a href="#æ‰‹åŠ¨æ‰©ç¼©å®¹" class="headerlink" title="æ‰‹åŠ¨æ‰©ç¼©å®¹"></a>æ‰‹åŠ¨æ‰©ç¼©å®¹</h2><p>ç°æœ‰å¦‚ä¸‹deploymenté…ç½®ï¼ˆnginx-deployment.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="attr">nginx:1.7.9</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Deploymentï¼š</p><p><img src="img/QQæˆªå›¾20191108094938.png" alt="QQæˆªå›¾20191108094938.png"></p><p>æœ‰3ä¸ªnginxå®ä¾‹ï¼Œç°åœ¨ç”¨ä¸‹é¢è¿™æ¡å‘½ä»¤å°†nginxå®ä¾‹æ‰©å……åˆ°5ä¸ªï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx-deployment --replicas 5</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191108100513.png" alt="QQæˆªå›¾20191108100513.png"></p><p>ç¼©å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx-deployment --replicas 1</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191108100834.png" alt="QQæˆªå›¾20191108100834.png"></p><h2 id="HPA"><a href="#HPA" class="headerlink" title="HPA"></a>HPA</h2><p>HPAèƒ½å¤Ÿæ ¹æ®ç‰¹å®šæŒ‡æ ‡å®Œæˆç›®æ ‡Podçš„è‡ªåŠ¨æ‰©ç¼©å®¹ã€‚åˆ›å»ºä¸€ä¸ªä¸ä¸Šé¢nginx-deploymentç›¸å¯¹åº”çš„HPAï¼ˆnginx-deployment-hpa.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-deployment-hpa-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  maxReplicas:</span> <span class="number">6</span></span><br><span class="line"><span class="attr">  minReplicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  scaleTargetRef:</span></span><br><span class="line"><span class="attr">    apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">  targetCPUUtilizationPercentage:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸»è¦å‚æ•°å¦‚ä¸‹ï¼š</p><ol><li><p>scaleTargetRefï¼šç›®æ ‡ä½œç”¨å¯¹è±¡ï¼Œå¯ä»¥æ˜¯Deploymentã€ReplicationControlleræˆ–ReplicaSetã€‚</p></li><li><p>targetCPUUtilizationPercentageï¼šæœŸæœ›æ¯ä¸ªPodçš„CPUä½¿ç”¨ç‡éƒ½ä¸º50%ï¼Œè¯¥ä½¿ç”¨ç‡åŸºäºPodè®¾ç½®çš„CPU Requestå€¼è¿›è¡Œè®¡ç®—ï¼Œä¾‹å¦‚è¯¥å€¼ä¸º200mï¼Œé‚£ä¹ˆç³»ç»Ÿå°†ç»´æŒPodçš„å®é™…CPUä½¿ç”¨å€¼ä¸º100mã€‚</p></li><li><p>minReplicaså’ŒmaxReplicasï¼šPodå‰¯æœ¬æ•°é‡çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ï¼Œç³»ç»Ÿå°†åœ¨è¿™ä¸ªèŒƒå›´å†…è¿›è¡Œè‡ªåŠ¨æ‰©ç¼©å®¹æ“ä½œï¼Œå¹¶ç»´æŒæ¯ä¸ªPodçš„CPUä½¿ç”¨ç‡ä¸º50%ã€‚</p></li></ol><div class="note info"><p>ä½¿ç”¨HPAï¼Œéœ€è¦é¢„å…ˆå®‰è£…Metrics Serverï¼Œç”¨äºé‡‡é›†Podçš„CPUä½¿ç”¨ç‡ã€‚</p></div><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;é’ˆå¯¹ä¸åŒæ—¶æœŸæµé‡çš„å¤§å°æˆ‘ä»¬å¯ä»¥ç»™Podæ‰©ç¼©å®¹ï¼ŒKubernetesæ”¯æŒé€šè¿‡kubectlå‘½ä»¤æ‰‹åŠ¨æ‰©ç¼©å®¹ï¼Œä¹Ÿæ”¯æŒé€šè¿‡HPAè‡ªåŠ¨æ¨ªå‘æ‰©ç¼©å®¹ã€‚
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Podå‡çº§ä¸å›æ»š</title>
    <link href="http://mrbird.cc/Kubernetes-Pod-Upgrade-And-Rollback.html"/>
    <id>http://mrbird.cc/Kubernetes-Pod-Upgrade-And-Rollback.html</id>
    <published>2019-11-05T10:59:27.000Z</published>
    <updated>2020-01-21T03:30:03.135Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>å½“é›†ç¾¤ä¸­çš„æŸä¸ªæœåŠ¡éœ€è¦å‡çº§æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœæ­¢ç›®å‰ä¸è¯¥æœåŠ¡ç›¸å…³çš„æ‰€æœ‰Podï¼Œç„¶åä¸‹è½½æ–°ç‰ˆæœ¬é•œåƒå¹¶åˆ›å»ºæ–°çš„Podã€‚å¦‚æœé›†ç¾¤è§„æ¨¡æ¯”è¾ƒå¤§ï¼Œåˆ™è¿™ä¸ªå·¥ä½œå˜æˆäº†ä¸€ä¸ªæŒ‘æˆ˜ï¼Œè€Œä¸”å…ˆå…¨éƒ¨åœæ­¢ç„¶åé€æ­¥å‡çº§çš„æ–¹å¼ä¼šå¯¼è‡´è¾ƒé•¿æ—¶é—´çš„æœåŠ¡ä¸å¯ç”¨ã€‚Kubernetesæä¾›äº†æ»šåŠ¨å‡çº§åŠŸèƒ½æ¥è§£å†³ä¸Šè¿°é—®é¢˜ã€‚å¦‚æœåœ¨æ›´æ–°è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼Œåˆ™è¿˜å¯ä»¥é€šè¿‡å›æ»šæ“ä½œæ¢å¤Podçš„ç‰ˆæœ¬ã€‚<a id="more"></a></p><h2 id="Deploymentå‡çº§"><a href="#Deploymentå‡çº§" class="headerlink" title="Deploymentå‡çº§"></a>Deploymentå‡çº§</h2><p>ç°æœ‰å¦‚ä¸‹deploymentå®šä¹‰ï¼ˆnginx-deployment.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="attr">nginx:1.7.9</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥deploymentï¼š</p><p><img src="img/QQæˆªå›¾20191106094755.png" alt="QQæˆªå›¾20191106094755.png"></p><p>é€šè¿‡kubectlå‘½ä»¤å°†nginxçš„ç‰ˆæœ¬æ›´æ–°åˆ°1.9.1ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployment/nginx-deployment nginx=nginx:1.9.1</span><br></pre></td></tr></table></figure><p></p><p>æŸ¥çœ‹æ»šåŠ¨å‡çº§çš„è¿‡ç¨‹ï¼š</p><p><img src="img/QQæˆªå›¾20191106095447.png" alt="QQæˆªå›¾20191106095447.png"></p><p>æŸ¥çœ‹Podï¼Œä¼šå‘ç°åç§°å·²ç»æ”¹å˜äº†ï¼š</p><p><img src="img/QQæˆªå›¾20191106095549.png" alt="QQæˆªå›¾20191106095549.png"></p><p>ä¸Šè¿°æ»šåŠ¨å‡çº§çš„è¿‡ç¨‹å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191106101327.png" alt="QQæˆªå›¾20191106101327.png"></p><p>æŸ¥çœ‹Deployment nginx-deploymentçš„è¯¦ç»†äº‹ä»¶ä¿¡æ¯å¯ä»¥è¯æ˜è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe deployments/nginx-deployment</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191106100133.png" alt="QQæˆªå›¾20191106100133.png"></p><p>æŸ¥çœ‹rsï¼š</p><p><img src="img/QQæˆªå›¾20191106102115.png" alt="QQæˆªå›¾20191106102115.png"></p><p>é»˜è®¤çš„å‡çº§ç­–ç•¥ä¸ºRollingUpdateï¼ˆæ»šåŠ¨æ›´æ–°ï¼‰ï¼ŒKubernetesè¿˜æ”¯æŒRecreateï¼ˆé‡å»ºï¼‰ç­–ç•¥ï¼š</p><ol><li><p>Recreateï¼šå…ˆæ€æ‰æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„Podï¼Œç„¶ååˆ›å»ºæ–°çš„Podã€‚</p></li><li><p>RollingUpdateï¼šä»¥æ»šåŠ¨æ›´æ–°çš„æ–¹å¼æ¥é€ä¸ªæ›´æ–°Podã€‚åŒæ—¶ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®spec.strategy.rollingUpdateä¸‹çš„ä¸¤ä¸ªå‚æ•°ï¼ˆmaxUnavailableå’ŒmaxSurgeï¼‰æ¥æ§åˆ¶æ»šåŠ¨æ›´æ–°çš„è¿‡ç¨‹ã€‚</p></li></ol><p>RollingUpdateçš„ä¸¤ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š</p><ol><li><p>maxUnavailableï¼šç”¨äºæŒ‡å®šDeploymentåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ä¸å¯ç”¨çŠ¶æ€çš„Podæ•°é‡çš„ä¸Šé™ã€‚è¯¥maxUnavailableçš„æ•°å€¼å¯ä»¥æ˜¯ç»å¯¹å€¼ï¼ˆä¾‹å¦‚1ï¼‰æˆ–PodæœŸæœ›çš„å‰¯æœ¬æ•°çš„ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚10%ï¼‰ã€‚</p></li><li><p>maxSurgeï¼šç”¨äºæŒ‡å®šåœ¨Deploymentæ›´æ–°Podçš„è¿‡ç¨‹ä¸­Podæ€»æ•°è¶…è¿‡PodæœŸæœ›å‰¯æœ¬æ•°éƒ¨åˆ†çš„æœ€å¤§å€¼ã€‚è¯¥maxSurgeçš„æ•°å€¼å¯ä»¥æ˜¯ç»å¯¹å€¼ï¼ˆä¾‹å¦‚5ï¼‰æˆ–PodæœŸæœ›å‰¯æœ¬æ•°çš„ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚10%ï¼‰ã€‚</p></li></ol><div class="note info"><p>æ­¤å¤–ï¼Œé™¤äº†ä½¿ç”¨kubectlå‘½ä»¤å‡çº§å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ä¿®æ”¹deployment.ymlçš„æ–¹å¼æ¥å®Œæˆã€‚</p></div><h2 id="Deploymentå›æ»š"><a href="#Deploymentå›æ»š" class="headerlink" title="Deploymentå›æ»š"></a>Deploymentå›æ»š</h2><p>å¦‚æœå‡çº§åæ•ˆæœä¸æ»¡æ„çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†Deploymentå›æ»šåˆ°å‡çº§ä¹‹å‰ï¼Œä½¿ç”¨ä¸‹é¢è¿™æ¡å‘½ä»¤æŸ¥çœ‹æ»šåŠ¨å‡çº§çš„å†å²ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout history deployment/nginx-deployment</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191106103606.png" alt="QQæˆªå›¾20191106103606.png"></p><p>REVISIONä¸ºå‡çº§çš„å†å²ç‰ˆæœ¬ï¼Œæˆ‘ä»¬åªå®Œæˆäº†nginxä»1.7.9å‡çº§åˆ°1.9.1çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥REVISION 1è¡¨ç¤ºnginxä¸º1.7.9çš„ç‰ˆæœ¬ï¼ŒREVISION 2è¡¨ç¤ºnginxä¸º1.9.1çš„ç‰ˆæœ¬ã€‚å› ä¸ºæˆ‘ä»¬åœ¨åˆ›å»ºdeploymentçš„æ—¶å€™æ²¡æœ‰åŠ ä¸Š<code>--record=true</code>å‚æ•°ï¼Œæ‰€ä»¥CHANGE-CACSEåˆ—æ˜¯ç©ºçš„ã€‚</p><p>éœ€è¦æŸ¥çœ‹ç‰¹å®šç‰ˆæœ¬çš„è¯¦ç»†ä¿¡æ¯ï¼Œåˆ™å¯ä»¥åŠ ä¸Šâ€“revision=<n>å‚æ•°ï¼š</n></p><p><img src="img/QQæˆªå›¾20191106104520.png" alt="QQæˆªå›¾20191106104520.png"></p><p>è¦å°†nginxå›é€€åˆ°1.7.9ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥å°†REVISIONæŒ‡å®šä¸º1ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment/nginx-deployment --to-revision=1</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191106105253.png" alt="QQæˆªå›¾20191106105253.png"></p><p><img src="img/QQæˆªå›¾20191106105638.png" alt="QQæˆªå›¾20191106105638.png"></p><h2 id="æš‚åœä¸æ¢å¤"><a href="#æš‚åœä¸æ¢å¤" class="headerlink" title="æš‚åœä¸æ¢å¤"></a>æš‚åœä¸æ¢å¤</h2><p>å› ä¸ºDeploymenté…ç½®ä¸€æ—¦ä¿®æ”¹å°±ä¼šè§¦å‘å‡çº§æ“ä½œï¼Œæ‰€ä»¥å½“ä¿®æ”¹çš„åœ°æ–¹è¾ƒå¤šçš„æ—¶å€™å°±ä¼šé¢‘ç¹è§¦å‘å‡çº§ã€‚æˆ‘ä»¬å¯ä»¥å…ˆæš‚åœå‡çº§æ“ä½œï¼Œå½“æ‰€æœ‰é…ç½®éƒ½ä¿®æ”¹å¥½åå†æ¢å¤å‡çº§ã€‚</p><p>æš‚åœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout pause deployment/nginx-deployment</span><br></pre></td></tr></table></figure><p></p><p>æš‚åœåï¼Œå¯¹nginx-deploymentçš„ä¿®æ”¹ä¸ä¼šè§¦å‘å‡çº§ã€‚ä¿®æ”¹å¥½åï¼Œæ¢å¤å‡çº§ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout resume deployment/nginx-deployment</span><br></pre></td></tr></table></figure><p></p><h2 id="å…¶ä»–Podç®¡ç†å¯¹è±¡å‡çº§ç­–ç•¥"><a href="#å…¶ä»–Podç®¡ç†å¯¹è±¡å‡çº§ç­–ç•¥" class="headerlink" title="å…¶ä»–Podç®¡ç†å¯¹è±¡å‡çº§ç­–ç•¥"></a>å…¶ä»–Podç®¡ç†å¯¹è±¡å‡çº§ç­–ç•¥</h2><h3 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h3><p>DaemonSetçš„å‡çº§ç­–ç•¥åŒ…æ‹¬ä¸¤ç§ï¼šOnDeleteå’ŒRollingUpdateï¼š</p><ol><li><p>OnDeleteï¼ˆé»˜è®¤ï¼‰ï¼šåœ¨åˆ›å»ºå¥½æ–°çš„DaemonSeté…ç½®ä¹‹åï¼Œæ–°çš„Podå¹¶ä¸ä¼šè¢«è‡ªåŠ¨åˆ›å»ºï¼Œç›´åˆ°ç”¨æˆ·æ‰‹åŠ¨åˆ é™¤æ—§ç‰ˆæœ¬çš„Podï¼Œæ‰è§¦å‘æ–°å»ºæ“ä½œã€‚</p></li><li><p>RollingUpdateï¼šå’Œå‰é¢ä»‹ç»çš„ä¸€è‡´ï¼Œä¸è¿‡ä¸æ”¯æŒrolloutï¼Œåªèƒ½é€šè¿‡å°†é…ç½®æ”¹å›å»æ¥å®ç°ã€‚</p></li></ol><h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><p>æ”¯æŒRecreateã€OnDeleteå’ŒRollingUpdateã€‚</p><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;å½“é›†ç¾¤ä¸­çš„æŸä¸ªæœåŠ¡éœ€è¦å‡çº§æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœæ­¢ç›®å‰ä¸è¯¥æœåŠ¡ç›¸å…³çš„æ‰€æœ‰Podï¼Œç„¶åä¸‹è½½æ–°ç‰ˆæœ¬é•œåƒå¹¶åˆ›å»ºæ–°çš„Podã€‚å¦‚æœé›†ç¾¤è§„æ¨¡æ¯”è¾ƒå¤§ï¼Œåˆ™è¿™ä¸ªå·¥ä½œå˜æˆäº†ä¸€ä¸ªæŒ‘æˆ˜ï¼Œè€Œä¸”å…ˆå…¨éƒ¨åœæ­¢ç„¶åé€æ­¥å‡çº§çš„æ–¹å¼ä¼šå¯¼è‡´è¾ƒé•¿æ—¶é—´çš„æœåŠ¡ä¸å¯ç”¨ã€‚Kubernetesæä¾›äº†æ»šåŠ¨å‡çº§åŠŸèƒ½æ¥è§£å†³ä¸Šè¿°é—®é¢˜ã€‚å¦‚æœåœ¨æ›´æ–°è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼Œåˆ™è¿˜å¯ä»¥é€šè¿‡å›æ»šæ“ä½œæ¢å¤Podçš„ç‰ˆæœ¬ã€‚
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Podç®¡ç†å¯¹è±¡ä¸è°ƒåº¦ç­–ç•¥</title>
    <link href="http://mrbird.cc/Kubernetes-Pod-Mananger.html"/>
    <id>http://mrbird.cc/Kubernetes-Pod-Mananger.html</id>
    <published>2019-11-04T01:14:06.000Z</published>
    <updated>2020-01-21T03:30:03.135Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>åœ¨å‰é¢çš„å­¦ä¹ ä¸­æˆ‘ä»¬äº†è§£åˆ°ï¼Œåœ¨Kubernetesä¸­ï¼ŒPodç®¡ç†å¯¹è±¡ä¸»è¦æœ‰RC(RS)ã€Deploymentã€StatefulSetã€DaemonSetå’ŒJobï¼ˆCronJobï¼‰ç­‰ã€‚å…¶ä¸­RC(RS)å’ŒDeploymentçš„ç”¨æ³•å·²ç»å¤§è‡´äº†è§£ï¼Œè¿™é‡Œä¸»è¦è®°å½•ä¸‹StatefulSetã€DaemonSetå’ŒJobï¼ˆCronJobï¼‰çš„ç”¨æ³•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒPodç®¡ç†å¯¹è±¡åœ¨åˆ›å»ºPodçš„æ—¶å€™æ˜¯æ ¹æ®ç³»ç»Ÿè‡ªåŠ¨è°ƒåº¦ç®—æ³•æ¥å®Œæˆéƒ¨ç½²çš„ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®è°ƒåº¦ç­–ç•¥æ¥å®ç°Podçš„ç²¾å‡†è°ƒåº¦ã€‚</p><a id="more"></a><h2 id="Podè°ƒåº¦ç­–ç•¥"><a href="#Podè°ƒåº¦ç­–ç•¥" class="headerlink" title="Podè°ƒåº¦ç­–ç•¥"></a>Podè°ƒåº¦ç­–ç•¥</h2><h3 id="NodeSelector"><a href="#NodeSelector" class="headerlink" title="NodeSelector"></a>NodeSelector</h3><p>æˆ‘ä»¬å¯ä»¥è¯¥æŸä¸ªèŠ‚ç‚¹Nodeè®¾ç½®æ ‡ç­¾ï¼Œç„¶åé€šè¿‡NodeSelectorè®©Podè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Šã€‚</p><p>å‰é¢æ­å»ºçš„Kubernetesé›†ç¾¤æœ‰ä¸¤ä¸ªworkerèŠ‚ç‚¹node1å’Œnode2ï¼Œæˆ‘ä»¬ç»™node2æ‰“ä¸ªæ ‡ç­¾ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes node2 tier=frontend</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€å®šä¹‰ä¸€ä¸ªRCé…ç½®ï¼ˆnode-select-pod.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line"><span class="attr">        tier:</span> <span class="string">frontend</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥RCï¼Œè§‚å¯ŸPodæœ€ç»ˆè°ƒåº¦çš„èŠ‚ç‚¹ï¼š</p><p><img src="img/QQæˆªå›¾20191105202135.png" alt="å›¾ç‰‡"></p><p>å¯ä»¥çœ‹åˆ°nginx podå·²ç»æˆåŠŸè°ƒåº¦åˆ°äº†node2èŠ‚ç‚¹ä¸Šã€‚</p><p>Kubernetesä¼šç»™æ¯ä¸ªnodeè´´ä¸Šä¸€äº›é»˜è®¤çš„æ ‡ç­¾ï¼Œé€šè¿‡<code>kubectl get node node1 -o yaml</code>å¯ä»¥çœ‹åˆ°è¿™äº›é»˜è®¤çš„æ ‡ç­¾ï¼š</p><p><img src="img/QQæˆªå›¾20191105152923.png" alt="QQæˆªå›¾20191105152923.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">beta.kubernetes.io/arch: amd64</span><br><span class="line">beta.kubernetes.io/os: linux</span><br><span class="line">kubernetes.io/arch: amd64</span><br><span class="line">kubernetes.io/hostname: node1</span><br><span class="line">kubernetes.io/os: linux</span><br></pre></td></tr></table></figure><p>è¿™äº›é»˜è®¤çš„æ ‡ç­¾åœ¨ä¸‹é¢è¿™äº›è°ƒåº¦ç­–ç•¥ä¸­ä¹Ÿæ˜¯è›®å¸¸ç”¨çš„ã€‚</p><h3 id="NodeAffinity"><a href="#NodeAffinity" class="headerlink" title="NodeAffinity"></a>NodeAffinity</h3><p>Affinity[É™ËˆfÉªnÉ™ti]ï¼šäº²å’ŒåŠ›ï¼Œå–œå¥½ã€‚NodeAffinityä¸ºNodeäº²å’ŒåŠ›è°ƒåº¦ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªè§„åˆ™ï¼ˆåç§°æœ‰ç‚¹é•¿ï¼Œå¿«18cmäº†å§ï¼‰:</p><ol><li><p>RequiredDuringSchedulingIgnoredDuringExecutionï¼šå¿…é¡»æ»¡è¶³æŒ‡å®šçš„è§„åˆ™æ‰å¯ä»¥è°ƒåº¦Podï¼Œç¡¬è§„åˆ™ã€‚</p></li><li><p>PreferredDuringSchedulingIgnoredDuringExecutionï¼šè½¯è§„åˆ™ï¼Œæœ€å¥½æ»¡è¶³æ‰€åˆ—å‡ºçš„æ¡ä»¶æ‰è°ƒåº¦Podã€‚</p></li></ol><p>IgnoredDuringExecutionçš„æ„æ€æ˜¯ï¼Œå¦‚æœä¸€ä¸ªPodå·²ç»è°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šäº†ï¼Œç„¶åè¿™ä¸ªèŠ‚ç‚¹çš„æ ‡ç­¾å‘ç”Ÿäº†æ”¹å˜ï¼Œé‚£ä¹ˆä¸å½±å“å·²ç»è°ƒåº¦å¥½çš„Podï¼Œignoreã€‚</p><p>å®šä¹‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ˆnode-affinity.ymlï¼‰ï¼Œç”¨äºæ¼”ç¤ºNodeAffinityï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      affinity:</span></span><br><span class="line"><span class="attr">        nodeAffinity:</span></span><br><span class="line"><span class="attr">          requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="attr">            nodeSelectorTerms:</span></span><br><span class="line"><span class="attr">              - matchExpressions:</span></span><br><span class="line"><span class="attr">                  - key:</span> <span class="string">beta.kubernetes.io/arch</span></span><br><span class="line"><span class="attr">                    operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">                    values:</span></span><br><span class="line"><span class="bullet">                      -</span> <span class="string">amd64</span></span><br><span class="line"><span class="attr">          preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="attr">            - weight:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">              preference:</span></span><br><span class="line"><span class="attr">                matchExpressions:</span></span><br><span class="line"><span class="attr">                  - key:</span> <span class="string">disk-type</span></span><br><span class="line"><span class="attr">                    operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">                    values:</span></span><br><span class="line"><span class="bullet">                      -</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢é…ç½®ä½¿å¾—RCåœ¨è°ƒåº¦nginx podçš„æ—¶å€™éœ€è¦æ»¡è¶³ï¼šèŠ‚ç‚¹å…·æœ‰beta.kubernetes.io/arch=amd64æ ‡ç­¾ï¼Œå¦‚æœå…·æœ‰disk-type=ssdæ ‡ç­¾å°±æ›´å¥½äº†ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å¸Œæœ›nginx podè°ƒåº¦åœ¨cpuæ¶æ„ä¸ºamdï¼Œç£ç›˜ä¸ºssdçš„èŠ‚ç‚¹ä¸Šã€‚</p><p>ä¸Šé¢é…ç½®ä¸­ï¼Œæ“ä½œç¬¦<code>operator</code>é™¤äº†å¯ä»¥ä½¿ç”¨Inå¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨NotInã€Existsã€DoesNotExistã€Gtã€Ltã€‚</p><p>NodeAffinityè§„åˆ™è®¾ç½®éœ€è¦æ³¨æ„çš„å‡ ä¸ªç‚¹ï¼š</p><ol><li><p>å¦‚æœnodeAffinityæŒ‡å®šäº†å¤šä¸ªnodeSelectorTermsï¼Œé‚£ä¹ˆå…¶ä¸­ä¸€ä¸ªèƒ½å¤ŸåŒ¹é…æˆåŠŸå³å¯ï¼›</p></li><li><p>å¦‚æœåœ¨nodeSelectorTermsä¸­æœ‰å¤šä¸ªmatchExpressionsï¼Œåˆ™ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»æ»¡è¶³æ‰€æœ‰matchExpressionsæ‰èƒ½è¿è¡Œè¯¥Podã€‚</p></li></ol><p>è¿è¡Œä¸Šé¢è¿™ä¸ªé…ç½®ï¼š</p><p><img src="img/QQæˆªå›¾20191105202725.png" alt="QQæˆªå›¾20191105202725.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå› ä¸ºnode1å’Œnode2éƒ½å…·æœ‰beta.kubernetes.io/arch=amd64æ ‡ç­¾ï¼Œè€Œæ²¡æœ‰disk-type=ssdæ ‡ç­¾ï¼Œæ‰€ä»¥nginx podæœ‰å¯èƒ½è¢«è°ƒåº¦åˆ°node1ä¹Ÿæœ‰å¯èƒ½è¢«è°ƒåº¦åˆ°node2ã€‚</p><p>æˆ‘ä»¬ç»™node1æ·»åŠ disk-type=ssdæ ‡ç­¾ï¼Œé‡æ–°è¿è¡Œä¸Šé¢çš„é…ç½®æ–‡ä»¶ï¼š</p><p><img src="img/QQæˆªå›¾20191105203033.png" alt="QQæˆªå›¾20191105203033.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œnginx podè¢«è°ƒåº¦åˆ°äº†node1ä¸Šã€‚</p><h3 id="PodAffinity"><a href="#PodAffinity" class="headerlink" title="PodAffinity"></a>PodAffinity</h3><p>PodAffinityæŒ‡çš„æ˜¯Podäº²å’ŒåŠ›è°ƒåº¦è‚¡åˆ™ï¼Œæ¯”å¦‚æŸäº›èŠ‚ç‚¹å·²ç»å­˜åœ¨ä¸€äº›Podäº†ï¼Œæ–°çš„Podåœ¨è°ƒåº¦çš„æ—¶å€™å¸Œæœ›å’ŒæŒ‡å®šPodåœ¨ä¸€å°èŠ‚ç‚¹ä¸Šï¼Œäº¦æˆ–æœ‰æ„é¿å¼€å’ŒæŒ‡å®šPodåœ¨ä¸€å°èŠ‚ç‚¹ä¸Šï¼Œè¿™æ—¶å€™å°±å¯ä»¥ç”¨PodAffinityå®ç°ã€‚</p><p>NodeAffinityè§„åˆ™è®¾ç½®ä¹Ÿæ˜¯é€šè¿‡<code>requiredDuringSchedulingIgnoredDuringExecution</code>å’Œ<code>PreferredDuringSchedulingIgnoredDuringExecution</code>å®ç°çš„ã€‚æ­¤å¤–ï¼ŒNodeAffinityè¿˜éœ€è¦è®¾ç½®topologyï¼ˆæ‹“æ‰‘è§„åˆ™ï¼‰ï¼Œæ„ä¸ºè¡¨è¾¾èŠ‚ç‚¹æ‰€å±çš„topologyèŒƒå›´ï¼š</p><ol><li><p>kubernetes.io/hostnameï¼ˆèŠ‚ç‚¹æ‰€å¤„çš„æœåŠ¡å™¨ï¼‰</p></li><li><p>failure-domain.beta.kubernetes.io/zoneï¼ˆèŠ‚ç‚¹æ‰€å¤„çš„æœåŠ¡å™¨äº‘ç›˜åˆ†åŒºï¼‰</p></li><li><p>failure-domain.beta.kubernetes.io/regionï¼ˆèŠ‚ç‚¹æ‰€å¤„çš„æœåŠ¡å™¨äº‘ç›˜æ‰€åœ¨çš„åœ°åŒºï¼‰</p></li></ol><p>è¦æ¼”ç¤ºPodAffinityçš„ä½¿ç”¨ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªå‚ç…§Podï¼Œåˆ›å»ºä¸€ä¸ªå‚ç…§Podçš„é…ç½®æ–‡ä»¶ï¼ˆflag-pod.ymlï¼‰:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">flag-pod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">flag-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">flag-nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure><p></p><p>è¿™ä¸ªPodå…·æœ‰<code>tier=frontend</code>å’Œ<code>app=flag-nginx</code>æ ‡ç­¾ã€‚</p><p>åˆ›å»ºè¿™ä¸ªå‚ç…§Podï¼š</p><p><img src="img/QQæˆªå›¾20191105203331.png" alt="QQæˆªå›¾20191105203331.png"></p><p>å‚ç…§podè¿è¡Œåœ¨äº†node1èŠ‚ç‚¹ä¸Šã€‚</p><p>åˆ›å»ºå¥½åï¼Œæ¥ç€å®šä¹‰ä¸€ä¸ªæ–°çš„é…ç½®ç±»ï¼ˆpod-affinity.ymlï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-affinity</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx</span><br><span class="line">      image: nginx</span><br><span class="line">      ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">  affinity:</span><br><span class="line">    podAffinity:</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">        - labelSelector:</span><br><span class="line">            matchExpressions:</span><br><span class="line">              - key: tier</span><br><span class="line">                operator: In</span><br><span class="line">                values:</span><br><span class="line">                  - frontend</span><br><span class="line">          topologyKey: kubernetes.io/hostname</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šè¿°é…ç½®è¦æ±‚ï¼Œnginx podéœ€è¦å’Œæ ‡ç­¾åŒ…å«tier=frontendçš„Podåˆ†é…åœ¨åŒä¸€ä¸ªNodeä¸Šï¼ˆtopologyKey: kubernetes.io/hostnameï¼‰ï¼Œåˆ›å»ºè¯¥Podï¼Œè§‚å¯Ÿå®ƒè¢«è°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹ä¸Šäº†ï¼š</p><p><img src="img/QQæˆªå›¾20191105203532.png" alt="QQæˆªå›¾20191105203532.png"></p><p>podAntiAffinityå’ŒpodAffinityåˆšå¥½ç›¸åï¼Œä¸¾ä¸ªä¾‹å­ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„é…ç½®ç±»ï¼ˆpod-affinity-two.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-affinity-two</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  affinity:</span></span><br><span class="line"><span class="attr">    podAntiAffinity:</span></span><br><span class="line"><span class="attr">      requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="attr">        - labelSelector:</span></span><br><span class="line"><span class="attr">            matchExpressions:</span></span><br><span class="line"><span class="attr">              - key:</span> <span class="string">app</span></span><br><span class="line"><span class="attr">                operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">                values:</span></span><br><span class="line"><span class="bullet">                  -</span> <span class="string">flag-nginx</span></span><br><span class="line"><span class="attr">          topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢é…ç½®å¸Œæœ›nginx podä¸å’Œapp=flag-nginxçš„Podåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><p>åˆ›å»ºè¯¥Podï¼Œè§‚å¯Ÿå®ƒè¢«è°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹ä¸Šäº†ï¼š</p><p><img src="img/QQæˆªå›¾20191105203938.png" alt="QQæˆªå›¾20191105203938.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒå’Œflag-nginxå¤„äºä¸åŒçš„èŠ‚ç‚¹ï¼Œä½äºnode2ã€‚</p><h3 id="Taints-amp-Tolerations"><a href="#Taints-amp-Tolerations" class="headerlink" title="Taints &amp; Tolerations"></a>Taints &amp; Tolerations</h3><p>Taintsç”¨äºç»™èŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹ï¼Œè€ŒTolerationsç”¨äºå®šä¹‰Podå¯¹èŠ‚ç‚¹æ±¡ç‚¹çš„å®¹å¿åº¦ã€‚åœ¨Nodeä¸Šè®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªTaintä¹‹åï¼Œé™¤éPodæ˜ç¡®å£°æ˜èƒ½å¤Ÿå®¹å¿è¿™äº›æ±¡ç‚¹ï¼Œå¦åˆ™æ— æ³•åœ¨è¿™äº›Nodeä¸Šè¿è¡Œã€‚Tolerationæ˜¯Podçš„å±æ€§ï¼Œè®©Podèƒ½å¤Ÿï¼ˆæ³¨æ„ï¼Œåªæ˜¯èƒ½å¤Ÿï¼Œè€Œéå¿…é¡»ï¼‰è¿è¡Œåœ¨æ ‡æ³¨äº†Taintçš„Nodeä¸Šã€‚</p><p>ç»™èŠ‚ç‚¹è®¾ç½®æ±¡ç‚¹çš„è¯­æ³•ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes [nodeName] key=value:rule</span><br></pre></td></tr></table></figure><p></p><p>å…¶ä¸­ruleçš„å–å€¼æœ‰ï¼š</p><ol><li><p>NoScheudleï¼šä¸è°ƒåº¦ï¼›</p></li><li><p>PreferNoScheduleï¼šæœ€å¥½ä¸è¦è°ƒåº¦ï¼›</p></li><li><p>NoExecuteï¼šä¸è¿è¡Œï¼›</p></li><li><p>PreferNoExecuteï¼šæœ€å¥½ä¸è¿è¡Œã€‚</p></li></ol><p>NoScheduleå’ŒNoExecuteåŒºåˆ«ï¼š</p><ul><li>NoScheduleä¸è°ƒåº¦ï¼Œå¦‚æœæ˜¯åœ¨è°ƒåº¦åè®¾ç½®çš„æ±¡ç‚¹ï¼Œå¹¶ä¸”Podæ²¡æœ‰å®¹å¿è¯¥æ±¡ç‚¹ï¼Œä¹Ÿèƒ½ç»§ç»­æ‰§è¡Œ</li><li>NoExecuteä¸æ‰§è¡Œï¼Œå¦‚æœæ˜¯åœ¨è°ƒåº¦åè®¾ç½®çš„æ±¡ç‚¹ï¼Œå¹¶ä¸”Podæ²¡æœ‰å®¹å¿è¯¥æ±¡ç‚¹ï¼Œåˆ™ä¼šè¢«é©±é€ã€‚å¯ä»¥è®¾ç½®é©±é€æ—¶é—´<code>tolerationSeconds: xx</code>ã€‚</li></ul><p>æˆ‘ä»¬ç»™node1èŠ‚ç‚¹è®¾ç½®ä¸€ä¸ªæ±¡ç‚¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 aa=bb:NoSchedule</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åæ–°å»ºä¸€ä¸ªPodé…ç½®ç±»ï¼ˆpod-taint-test.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-taint</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  tolerations:</span></span><br><span class="line"><span class="attr">    - key:</span> <span class="string">"aa"</span></span><br><span class="line"><span class="attr">      operator:</span> <span class="string">"Equal"</span></span><br><span class="line"><span class="attr">      value:</span> <span class="string">"bb"</span></span><br><span class="line"><span class="attr">      effect:</span> <span class="string">"NoSchedule"</span></span><br></pre></td></tr></table></figure><p></p><p>Podçš„Tolerationå£°æ˜ä¸­çš„keyå’Œeffectéœ€è¦ä¸Taintçš„è®¾ç½®ä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€ï¼š</p><ol><li><p>operatorçš„å€¼æ˜¯Existsï¼ˆæ— é¡»æŒ‡å®švalueï¼‰ï¼Œå¦‚ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">......</span></span><br><span class="line"><span class="attr">  tolerations:</span></span><br><span class="line"><span class="attr">    - key:</span> <span class="string">"aa"</span></span><br><span class="line"><span class="attr">      operator:</span> <span class="string">"Exists"</span></span><br><span class="line"><span class="attr">      effect:</span> <span class="string">"NoSchedule"</span></span><br></pre></td></tr></table></figure></li><li><p>operatorçš„å€¼æ˜¯Equalå¹¶ä¸”valueç›¸ç­‰ã€‚å¦‚æœä¸æŒ‡å®šoperatorï¼Œåˆ™é»˜è®¤å€¼ä¸ºEqualã€‚</p></li></ol><p>å¦å¤–ï¼Œæœ‰å¦‚ä¸‹ä¸¤ä¸ªç‰¹ä¾‹ï¼š</p><ol><li>ç©ºçš„keyé…åˆExistsæ“ä½œç¬¦èƒ½å¤ŸåŒ¹é…æ‰€æœ‰çš„é”®å’Œå€¼ï¼›</li><li>ç©ºçš„effectåŒ¹é…æ‰€æœ‰çš„effectã€‚</li></ol><p>å›åˆ°pod-taint-test.ymlï¼Œè¯¥é…ç½®æ–‡ä»¶å®šä¹‰nginx podå¯ä»¥å®¹å¿<code>aa=bb:NoSchedule</code>è¿™ä¸ªæ±¡ç‚¹ï¼Œæ‰€ä»¥å®ƒæœ‰å¯èƒ½ä¼šè¢«è°ƒåº¦åˆ°node1ä¸Šã€‚åˆ›å»ºè¯¥Podï¼Œè§‚å¯Ÿï¼š</p><p><img src="img/QQæˆªå›¾20191105204219.png" alt="QQæˆªå›¾20191105204219.png"></p><p>è¿™æ—¶å€™åœ¨nginx podæ‰€è¿è¡Œçš„èŠ‚ç‚¹node1ä¸Šæ–°å¢ä¸€ä¸ªæ±¡ç‚¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 cc=dd:NoExecute</span><br></pre></td></tr></table></figure><p></p><p>è§‚å¯Ÿnginx podæƒ…å†µï¼š</p><p><img src="img/QQæˆªå›¾20191105204303.png" alt="QQæˆªå›¾20191105204303.png"></p><p>å¯ä»¥çœ‹åˆ°å®ƒè¢«é©±é€äº†ï¼Œå·²ç»æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„podäº†ã€‚</p><h3 id="Pod-Priority-Preemption"><a href="#Pod-Priority-Preemption" class="headerlink" title="Pod Priority Preemption"></a>Pod Priority Preemption</h3><p>æˆ‘ä»¬å¯ä»¥ç»™PodæŒ‡å®šä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§å¯ä»¥é€šè¿‡PriorityClasså¯¹è±¡åˆ›å»ºï¼Œæ¯”å¦‚åˆ›å»ºä¸€ä¸ªä¼˜å…ˆçº§ä¸º10000çš„PriorityClassï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">scheduling.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">hign-priority</span></span><br><span class="line"><span class="attr">value:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">globalDefault:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">"10000ä¼˜å…ˆçº§"</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šè¿°æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªåä¸ºhigh-priorityçš„ä¼˜å…ˆçº§ç±»åˆ«ï¼Œä¼˜å…ˆçº§ä¸º10000ï¼Œæ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆè¶Šé«˜ã€‚è¶…è¿‡ä¸€äº¿çš„æ•°å­—è¢«ç³»ç»Ÿä¿ç•™ï¼Œç”¨äºæŒ‡æ´¾ç»™ç³»ç»Ÿç»„ä»¶ã€‚</p><p>ä¼˜å…ˆçº§åˆ›å»ºåï¼Œå¯ä»¥åœ¨Podå®šä¹‰ä¸­å¼•ç”¨è¯¥ä¼˜å…ˆçº§ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  priorityClassName:</span> <span class="string">hign-priority</span></span><br></pre></td></tr></table></figure><p></p><h2 id="Podç®¡ç†å¯¹è±¡"><a href="#Podç®¡ç†å¯¹è±¡" class="headerlink" title="Podç®¡ç†å¯¹è±¡"></a>Podç®¡ç†å¯¹è±¡</h2><h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><p>Jobæ˜¯ä¸€ç§ç‰¹æ®Šçš„Podç®¡ç†å¯¹è±¡ï¼Œæ˜¯ä¸€ç§ä¸€æ¬¡æ€§Podè¿è¡Œä»»åŠ¡ï¼Œä»»åŠ¡ç»“æŸåï¼ŒPodçš„ç”Ÿå‘½å‘¨æœŸä¹Ÿå°±ç»“æŸäº†ã€‚</p><p>å®šä¹‰ä¸€ä¸ªJobé…ç½®ç±»ï¼ˆjob.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">job-ex</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">job</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">["echo",</span> <span class="string">"hello job"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure><p></p><p>Jobçš„é‡å¯ç­–ç•¥<code>restartPolicy</code>åªæ”¯æŒNeverå’ŒOnFailureã€‚</p><p>åˆ›å»ºè¿™ä¸ªJobï¼š</p><p><img src="img/QQæˆªå›¾20191105140915.png" alt="QQæˆªå›¾20191105140915.png"></p><p>æŸ¥çœ‹JobçŠ¶æ€ï¼š</p><p><img src="img/QQæˆªå›¾20191105141330.png" alt="QQæˆªå›¾20191105141330.png"></p><p>COMPLETIONS 1/1è¡¨ç¤ºæ€»å…±éœ€è¦æ‰§è¡Œ1ä¸ªä»»åŠ¡ï¼Œå…±æ‰§è¡Œå®Œ1ä¸ªä»»åŠ¡ã€‚</p><p>æŸ¥çœ‹å¯¹åº”Podçš„çŠ¶æ€ï¼š</p><p><img src="img/QQæˆªå›¾20191105141452.png" alt="QQæˆªå›¾20191105141452.png"></p><p>çŠ¶æ€ä¸ºCompletedã€‚</p><p>æŸ¥çœ‹Jobæ—¥å¿—ï¼š</p><p><img src="img/QQæˆªå›¾20191105141618.png" alt="QQæˆªå›¾20191105141618.png"></p><p>Jobè¿˜å¯ä»¥è®¾ç½®å¹¶å‘æ•°é‡å’Œæ€»Jobæ•°ï¼Œä¿®æ”¹ä¸Šé¢çš„job.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">job-ex</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  parallelism:</span> <span class="number">2</span> <span class="comment"># å¹¶å‘æ•°2</span></span><br><span class="line"><span class="attr">  completions:</span> <span class="number">6</span> <span class="comment"># æ€»çš„Jobæ•°é‡</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">job</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">["echo",</span> <span class="string">"hello job"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure><p></p><p>è¿è¡Œè¯¥Jobï¼š <img src="img/QQæˆªå›¾20191105142838.png" alt="QQæˆªå›¾20191105142838.png"></p><p>æŸ¥çœ‹Podï¼š</p><p><img src="img/QQæˆªå›¾20191105142918.png" alt="QQæˆªå›¾20191105142918.png"></p><h3 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h3><p>CronJobé¡¾åæ€ä¹‰å°±æ˜¯æ”¯æŒCronè¡¨è¾¾å¼çš„Jobï¼Œä¸è¿‡Kubernetesçš„Cronè¡¨è¾¾å¼å’Œä¼ ç»Ÿçš„Cronè¡¨è¾¾å¼ä¸å¤ªä¸€æ ·ï¼Œä¸æ”¯æŒåˆ°ç§’çº§ã€‚å…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Minutes Hours DayofMonth Month DayofWeek Year</span><br></pre></td></tr></table></figure><p></p><ol><li><p>Minutesï¼šå¯å‡ºç°<code>,</code> <code>-</code> <code>*</code> <code>/</code> è¿™4ä¸ªå­—ç¬¦ï¼Œæœ‰æ•ˆèŒƒå›´ä¸º0ï½59çš„æ•´æ•°ã€‚</p></li><li><p>Hoursï¼šå¯å‡ºç°<code>,</code> <code>-</code> <code>*</code> <code>/</code>è¿™4ä¸ªå­—ç¬¦ï¼Œ æœ‰æ•ˆèŒƒå›´ä¸º0ï½23çš„æ•´æ•°ã€‚</p></li><li><p>DayofMonthï¼šå¯å‡ºç°<code>,</code> <code>-</code> <code>*</code> <code>/</code> <code>?</code> <code>L</code> <code>W</code> <code>C</code> è¿™8ä¸ªå­—ç¬¦ï¼Œæœ‰æ•ˆèŒƒå›´ä¸º0ï½31çš„æ•´æ•°ã€‚</p></li><li><p>Monthï¼šå¯å‡ºç°<code>,</code> <code>-</code> <code>*</code> <code>/</code>è¿™4ä¸ªå­—ç¬¦ï¼Œæœ‰æ•ˆèŒƒå›´ä¸º1ï½12çš„æ•´æ•°æˆ–JANï½DECã€‚</p></li><li><p>DayofWeekï¼šå¯å‡ºç°<code>,</code> <code>-</code> <code>*</code> <code>/</code> <code>?</code> <code>L</code> <code>C</code> <code>ï¼ƒ</code>è¿™8ä¸ªå­—ç¬¦ï¼Œæœ‰æ•ˆèŒƒå›´ä¸º1ï½7çš„æ•´æ•°æˆ–SUNï½SATã€‚1è¡¨ç¤ºæ˜ŸæœŸå¤©ï¼Œ2è¡¨ç¤ºæ˜ŸæœŸä¸€ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p></li></ol><p>ä¸Šé¢ç‰¹æ®Šå­—ç¬¦çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ol><li><p><code>*</code>ï¼šè¡¨ç¤ºåŒ¹é…è¯¥åŸŸçš„ä»»æ„å€¼ï¼Œå‡å¦‚åœ¨MinutesåŸŸä½¿ç”¨<code>*</code>ï¼Œåˆ™è¡¨ç¤ºæ¯åˆ†é’Ÿéƒ½ä¼šè§¦å‘äº‹ä»¶ã€‚</p></li><li><p><code>/</code>ï¼šè¡¨ç¤ºä»èµ·å§‹æ—¶é—´å¼€å§‹è§¦å‘ï¼Œç„¶åæ¯éš”å›ºå®šæ—¶é—´è§¦å‘ä¸€æ¬¡ï¼Œä¾‹å¦‚åœ¨MinutesåŸŸè®¾ç½®ä¸º5/20ï¼Œåˆ™æ„å‘³ç€ç¬¬1æ¬¡è§¦å‘åœ¨ç¬¬5minæ—¶ï¼Œæ¥ä¸‹æ¥æ¯20minè§¦å‘ä¸€æ¬¡ï¼Œå°†åœ¨ç¬¬25minã€ç¬¬45minç­‰æ—¶åˆ»åˆ†åˆ«è§¦å‘ã€‚</p></li></ol><p>å®šä¹‰ä¸€ä¸ªCronJobçš„é…ç½®ç±»ï¼ˆcron-job.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cron-job-ex</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  schedule:</span> <span class="string">"*/1 * * * *"</span></span><br><span class="line"><span class="attr">  jobTemplate:</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      template:</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          containers:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">              image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">              command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"date;echo hello cronJob"</span><span class="string">]</span></span><br><span class="line"><span class="attr">          restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„å®šæ—¶ä»»åŠ¡æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚</p><p>åˆ›å»ºè¯¥CronJobï¼š</p><p><img src="img/QQæˆªå›¾20191105144308.png" alt="QQæˆªå›¾20191105144308.png"></p><p>è¿‡ä¸ªä¸¤ä¸‰åˆ†é’ŸæŸ¥çœ‹è¿è¡Œæƒ…å†µï¼š</p><p><img src="img/QQæˆªå›¾20191105145147.png" alt="QQæˆªå›¾20191105145147.png"></p><h3 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h3><p>DaemonSeté€‚ç”¨äºåœ¨æ¯ä¸ªNodeéƒ½éœ€è¦è¿è¡Œä¸€ä¸ªPodçš„æ—¶å€™ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼šæ¯ä¸€ä¸ªNodeä¸Šè¿è¡Œä¸€ä¸ªæ—¥å¿—é‡‡é›†ã€æ€§èƒ½ç›‘æ§çš„Podã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬ç°åœ¨éœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½éƒ¨ç½²ä¸€ä¸ªnode-exporteræ¥é‡‡é›†èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡DaemonSetæ¥å®ç°ã€‚</p><p>å®šä¹‰ä¸€ä¸ªDaemonSeté…ç½®æ–‡ä»¶ï¼ˆdaemonset.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">node-exporter-d</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">prom/node-exporter</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">9100</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥DaemonSetä¹‹å‰å…ˆåˆ é™¤ä¸Šé¢åœ¨node1èŠ‚ç‚¹ä¸Šåˆ›å»ºçš„æ±¡ç‚¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 aa:NoSchedule-</span><br><span class="line">kubectl taint nodes node1 cc:NoExecute-</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥DaemonSetï¼Œç„¶åè§‚å¯ŸPodä¿¡æ¯ï¼Œçœ‹æ˜¯å¦æ¯ä¸ªèŠ‚ç‚¹éƒ½éƒ¨ç½²äº†ä¸€ä¸ªå®ä¾‹ï¼š</p><p><img src="img/QQæˆªå›¾20191105205401.png" alt="QQæˆªå›¾20191105205401.png"></p><h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><p>ç³»ç»Ÿå­¦ä¹ PV/PVCåå†æ·±å…¥ã€‚</p><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨å‰é¢çš„å­¦ä¹ ä¸­æˆ‘ä»¬äº†è§£åˆ°ï¼Œåœ¨Kubernetesä¸­ï¼ŒPodç®¡ç†å¯¹è±¡ä¸»è¦æœ‰RC(RS)ã€Deploymentã€StatefulSetã€DaemonSetå’ŒJobï¼ˆCronJobï¼‰ç­‰ã€‚å…¶ä¸­RC(RS)å’ŒDeploymentçš„ç”¨æ³•å·²ç»å¤§è‡´äº†è§£ï¼Œè¿™é‡Œä¸»è¦è®°å½•ä¸‹StatefulSetã€DaemonSetå’ŒJobï¼ˆCronJobï¼‰çš„ç”¨æ³•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒPodç®¡ç†å¯¹è±¡åœ¨åˆ›å»ºPodçš„æ—¶å€™æ˜¯æ ¹æ®ç³»ç»Ÿè‡ªåŠ¨è°ƒåº¦ç®—æ³•æ¥å®Œæˆéƒ¨ç½²çš„ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®è°ƒåº¦ç­–ç•¥æ¥å®ç°Podçš„ç²¾å‡†è°ƒåº¦ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes PodåŸºç¡€</title>
    <link href="http://mrbird.cc/Kubernetes-Pod-Basic.html"/>
    <id>http://mrbird.cc/Kubernetes-Pod-Basic.html</id>
    <published>2019-11-03T02:50:14.000Z</published>
    <updated>2020-01-21T03:30:03.135Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>Podæ˜¯Kubernetesçš„æœ€å°è°ƒåº¦å•ä½ï¼ŒåŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚Dockerå®¹å™¨ï¼‰ï¼Œå®¹å™¨é—´å…±äº«ç½‘ç»œå’Œå­˜å‚¨ã€‚è¿™èŠ‚ä¸»è¦è®°å½•ä»€ä¹ˆæ˜¯é™æ€Podï¼ŒPodå®¹å™¨å¦‚ä½•å…±äº«å­˜å‚¨ï¼Œå¦‚ä½•ä½¿ç”¨ConfigMapç®¡ç†Podé…ç½®ï¼Œå¦‚ä½•ä½¿ç”¨Downward APIè·å–Podä¿¡æ¯ç­‰ã€‚<a id="more"></a></p><h2 id="é™æ€Pod"><a href="#é™æ€Pod" class="headerlink" title="é™æ€Pod"></a>é™æ€Pod</h2><p>é™æ€Podæ˜¯ç”±kubeletåˆ›å»ºå¹¶ç®¡ç†çš„ç‰¹æ®Šçš„Podï¼Œæ— æ³•å’ŒPodç®¡ç†å¯¹è±¡å…³è”ï¼Œå¹¶ä¸”ä¸èƒ½é€šè¿‡API Serverå…³è”ã€‚åˆ›å»ºé™æ€Podæœ‰é…ç½®æ–‡ä»¶æ–¹å¼å’ŒHTTPæ–¹å¼ï¼š</p><h3 id="é…ç½®æ–‡ä»¶æ–¹å¼"><a href="#é…ç½®æ–‡ä»¶æ–¹å¼" class="headerlink" title="é…ç½®æ–‡ä»¶æ–¹å¼"></a>é…ç½®æ–‡ä»¶æ–¹å¼</h3><p>åœ¨æ­å»ºKubernetesé›†ç¾¤çš„æ—¶å€™ï¼Œä»å¯åŠ¨MasterèŠ‚ç‚¹çš„æ—¥å¿—å¯ä»¥çœ‹å‡ºï¼Œé™æ€Podçš„ç›®å½•ä½äº<code>/etc/kubernetes/manifests</code>ï¼š</p><p>åœ¨è¯¥ç›®å½•ä¸‹åˆ›å»ºé™æ€Podæ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/manifests</span><br><span class="line">vim static-pod.yaml</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">static-pod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">static-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">static-nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><p>è¿‡äº†ä¸€ä¼šæŸ¥çœ‹Podï¼š</p><p><img src="img/QQæˆªå›¾20191103124437.png" alt="QQæˆªå›¾20191103124437.png"></p><p>äºé™æ€Podæ— æ³•é€šè¿‡API Serverç›´æ¥ç®¡ç†ï¼Œæ‰€ä»¥åœ¨Masterä¸Šå°è¯•åˆ é™¤è¿™ä¸ªPodæ—¶ï¼Œä¼šä½¿å…¶å˜æˆPendingçŠ¶æ€ï¼Œä¸”ä¸ä¼šè¢«åˆ é™¤ã€‚</p><p><img src="img/QQæˆªå›¾20191103124756.png" alt="QQæˆªå›¾20191103124756.png"></p><p>åˆ é™¤è¯¥Podçš„æ“ä½œåªèƒ½æ˜¯åˆ°å…¶æ‰€åœ¨Nodeä¸Šå°†å…¶å®šä¹‰æ–‡ä»¶static-pod.yamlä»/etc/kubernetes/manifestsç›®å½•ä¸‹åˆ é™¤ï¼š</p><p><img src="img/QQæˆªå›¾20191103124916.png" alt="QQæˆªå›¾20191103124916.png"></p><h3 id="HTTPæ–¹å¼"><a href="#HTTPæ–¹å¼" class="headerlink" title="HTTPæ–¹å¼"></a>HTTPæ–¹å¼</h3><p>è¿‡è®¾ç½®kubeletçš„å¯åŠ¨å‚æ•°<code>--manifest-url</code>ï¼Œkubeletå°†ä¼šå®šæœŸä»è¯¥URLåœ°å€ä¸‹è½½Podçš„å®šä¹‰æ–‡ä»¶ï¼Œå¹¶ä»¥.yamlæˆ–.jsonæ–‡ä»¶çš„æ ¼å¼è¿›è¡Œè§£æï¼Œç„¶ååˆ›å»ºPodã€‚</p><h2 id="Podå®¹å™¨å…±äº«Volume"><a href="#Podå®¹å™¨å…±äº«Volume" class="headerlink" title="Podå®¹å™¨å…±äº«Volume"></a>Podå®¹å™¨å…±äº«Volume</h2><p>åŒä¸€ä¸ªPodçš„å¤šä¸ªå®¹å™¨é—´å¯ä»¥å…±äº«Podçº§åˆ«çš„Volumeï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim pod-volume.yml</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-volume</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/usr/local/tomcat/logs</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">logs</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"tail -f /logs/catalina*.log"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/logs</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">logs</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">logs</span></span><br><span class="line"><span class="attr">      emptyDir:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢Podå®šä¹‰ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªPodçº§åˆ«çš„Volumeï¼Œåç§°ä¸ºlogsï¼Œç±»å‹ä¸ºemptyDirã€‚è¿™ä¸ªVolumeåŒæ—¶æŒ‚è½½åˆ°äº†tomcatçš„/usr/local/tomcat/logsç›®å½•ä¸‹ï¼Œä¹ŸæŒ‚è½½åˆ°äº†busyboxçš„/logsç›®å½•ä¸‹ã€‚</p><p>åˆ›å»ºè¯¥Podï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f pod-volume.yml</span><br></pre></td></tr></table></figure><p></p><div class="note info"><p>è¿™é‡Œçš„tomcaté•œåƒæ¯”è¾ƒå¤§ï¼Œå¤§æ¦‚æœ‰500MBå·¦å³ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºä¹‹å‰ï¼Œæœ€å¥½åœ¨Kubernetesé›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸­é…ç½®Dockeré•œåƒåŠ é€Ÿåœ°å€ã€‚</p></div><p>å½“pod-volumeçŠ¶æ€ä¸ºreadyåï¼ŒæŸ¥çœ‹busyboxçš„æ—¥å¿—ï¼š</p><p><img src="img/QQæˆªå›¾20191103143252.png" alt="QQæˆªå›¾20191103143252.png"></p><p>è¯¥æ—¥å¿—ä¸ºtomcatçš„å¯åŠ¨æ—¥å¿—ï¼Œè¯´æ˜ä¸Šé¢æŒ‚è½½çš„Volumeç”Ÿæ•ˆäº†ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹tomcat<code>/usr/local/tomcat/logs</code>ç›®å½•ä¸‹å’Œbusybox<code>/logs</code>ç›®å½•ä¸‹çš„å†…å®¹æ¥è¯æ˜è¿™ä¸€ç‚¹ï¼š</p><p><img src="img/QQæˆªå›¾20191103143458.png" alt="QQæˆªå›¾20191103143458.png"></p><h2 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h2><p>ConfigMapä»¥ä¸€ä¸ªæˆ–å¤šä¸ªkey:valueçš„å½¢å¼ä¿å­˜åœ¨Kubernetesç³»ç»Ÿä¸­ä¾›åº”ç”¨ä½¿ç”¨ï¼Œæ—¢å¯ä»¥ç”¨äºè¡¨ç¤ºä¸€ä¸ªå˜é‡çš„å€¼ï¼ˆä¾‹å¦‚version=v1ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”¨äºè¡¨ç¤ºä¸€ä¸ªå®Œæ•´é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼ˆä¾‹å¦‚<code>server.xml=&lt;?xml...&gt;...</code>ï¼‰ã€‚</p><h3 id="åˆ›å»ºConfigMap"><a href="#åˆ›å»ºConfigMap" class="headerlink" title="åˆ›å»ºConfigMap"></a>åˆ›å»ºConfigMap</h3><p>åˆ›å»ºConfigMapä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p><strong>1.é€šè¿‡ymlæ–‡ä»¶åˆ›å»º</strong></p><p>åˆ›å»º<code>simple-cm.yml</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">simple-cm</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  release:</span> <span class="string">stable</span></span><br></pre></td></tr></table></figure><p></p><p>è¯¥ConfigMapä»…åŒ…å«ä¸¤ä¸ªç®€å•çš„å€¼versionå’Œreleasesã€‚</p><p>åˆ›å»ºè¯¥ConfigMapï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f simple-cm.yml</span><br></pre></td></tr></table></figure><p></p><p>æŸ¥çœ‹è¯¥ConfigMapï¼š</p><p><img src="img/QQæˆªå›¾20191103145002.png" alt="QQæˆªå›¾20191103145002.png"></p><p>åœ¨å®šä¹‰ConfigMapçš„æ—¶å€™ï¼Œvalueé™¤äº†å¯ä»¥ä½¿ç”¨ç®€å•çš„å€¼å¤–ï¼Œè¿˜å¯ä»¥æ˜¯æ•´ä¸ªé…ç½®æ–‡ä»¶çš„å†…å®¹ã€‚</p><p>åˆ›å»º<code>file-cm.yml</code>ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">file-cm</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  serverXml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="string">    &lt;Server port="8005" shutdown="SHUTDOWN"&gt;</span></span><br><span class="line"><span class="string">      &lt;Listener className="org.apache.catalina.startup.VersionLoggerListener"/&gt;</span></span><br><span class="line"><span class="string">      &lt;Listener SSLEngine="on" className="org.apache.catalina.core.AprLifecycleListener"/&gt;</span></span><br><span class="line"><span class="string">      &lt;!-- Prevent memory leaks due to use of particular java/javax APIs--&gt;</span></span><br><span class="line"><span class="string">      &lt;Listener className="org.apache.catalina.core.JreMemoryLeakPreventionListener"/&gt;</span></span><br><span class="line"><span class="string">      &lt;Listener className="org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"/&gt;</span></span><br><span class="line"><span class="string">      &lt;Listener className="org.apache.catalina.core.ThreadLocalLeakPreventionListener"/&gt;</span></span><br><span class="line"><span class="string">      &lt;GlobalNamingResources&gt;</span></span><br><span class="line"><span class="string">        &lt;Resource auth="Container" description="User database that can be updated and saved" factory="org.apache.catalina.users.MemoryUserDatabaseFactory" name="UserDatabase" pathname="conf/tomcat-users.xml" type="org.apache.catalina.UserDatabase"/&gt;</span></span><br><span class="line"><span class="string">      &lt;/GlobalNamingResources&gt;</span></span><br><span class="line"><span class="string">      &lt;Service name="Catalina"&gt;</span></span><br><span class="line"><span class="string">        &lt;Connector connectionTimeout="20000" port="8080" protocol="HTTP/1.1" redirectPort="8443"/&gt;</span></span><br><span class="line"><span class="string">        &lt;Connector port="8009" protocol="AJP/1.3" redirectPort="8443"/&gt;</span></span><br><span class="line"><span class="string">        &lt;Engine defaultHost="localhost" name="Catalina"&gt;</span></span><br><span class="line"><span class="string">          &lt;Realm className="org.apache.catalina.realm.LockOutRealm"&gt;</span></span><br><span class="line"><span class="string">            &lt;Realm className="org.apache.catalina.realm.UserDatabaseRealm" resourceName="UserDatabase"/&gt;</span></span><br><span class="line"><span class="string">          &lt;/Realm&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          &lt;Host appBase="webapps" autoDeploy="true" name="localhost" unpackWARs="true"&gt;</span></span><br><span class="line"><span class="string">            &lt;Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs" pattern="%h %l %u %t &amp;quot;%r&amp;quot; %s %b" prefix="localhost_access_log" suffix=".txt"/&gt;</span></span><br><span class="line"><span class="string">          &lt;Context docBase="D:\Code\apache-tomcat-8.5.32\webapps\tj_certification" path="/tj_certification" reloadable="true" source="org.eclipse.jst.jee.server:tj_certification"/&gt;&lt;/Host&gt;</span></span><br><span class="line"><span class="string">        &lt;/Engine&gt;</span></span><br><span class="line"><span class="string">      &lt;/Service&gt;</span></span><br><span class="line"><span class="string">    &lt;/Server&gt;</span></span><br><span class="line"><span class="string"></span><span class="attr">  serverProperties:</span> <span class="string">"1catalina.org.apache.juli.AsyncFileHandler.level = FINE</span></span><br><span class="line"><span class="string">                     1catalina.org.apache.juli.AsyncFileHandler.directory = $&#123;catalina.base&#125;/logs</span></span><br><span class="line"><span class="string">                     1catalina.org.apache.juli.AsyncFileHandler.prefix = catalina.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     2localhost.org.apache.juli.AsyncFileHandler.level = FINE</span></span><br><span class="line"><span class="string">                     2localhost.org.apache.juli.AsyncFileHandler.directory = $&#123;catalina.base&#125;/logs</span></span><br><span class="line"><span class="string">                     2localhost.org.apache.juli.AsyncFileHandler.prefix = localhost.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     3manager.org.apache.juli.AsyncFileHandler.level = FINE</span></span><br><span class="line"><span class="string">                     3manager.org.apache.juli.AsyncFileHandler.directory = $&#123;catalina.base&#125;/logs</span></span><br><span class="line"><span class="string">                     3manager.org.apache.juli.AsyncFileHandler.prefix = manager.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     4host-manager.org.apache.juli.AsyncFileHandler.level = FINE</span></span><br><span class="line"><span class="string">                     4host-manager.org.apache.juli.AsyncFileHandler.directory = $&#123;catalina.base&#125;/logs</span></span><br><span class="line"><span class="string">                     4host-manager.org.apache.juli.AsyncFileHandler.prefix = host-manager.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     java.util.logging.ConsoleHandler.level = FINE</span></span><br><span class="line"><span class="string">                     java.util.logging.ConsoleHandler.formatter = org.apache.juli.OneLineFormatter</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     org.apache.catalina.core.ContainerBase.[Catalina].[localhost].level = INFO</span></span><br><span class="line"><span class="string">                     org.apache.catalina.core.ContainerBase.[Catalina].[localhost].handlers = 2localhost.org.apache.juli.AsyncFileHandler</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].level = INFO</span></span><br><span class="line"><span class="string">                     org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].handlers = 3manager.org.apache.juli.AsyncFileHandler</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager].level = INFO</span></span><br><span class="line"><span class="string">                     org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager].handlers = 4host-manager.org.apache.juli.AsyncFileHandler"</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥ConfigMapï¼š</p><p><img src="img/QQæˆªå›¾20191103150049.png" alt="QQæˆªå›¾20191103150049.png"></p><p><strong>2.ç›´æ¥é€šè¿‡Kubectlå‘½ä»¤åˆ›å»º</strong></p><p>é€šè¿‡kubectlå‘½ä»¤åˆ›å»ºConfigMapä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ç”¨æ³•ï¼š</p><ol><li><p>é€šè¿‡â€“from-fileå‚æ•°ä»æ–‡ä»¶ä¸­è¿›è¡Œåˆ›å»ºï¼Œå¯ä»¥æŒ‡å®škeyçš„åç§°ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªå‘½ä»¤è¡Œä¸­åˆ›å»ºåŒ…å«å¤šä¸ªkeyçš„ConfigMapï¼Œè¯­æ³•ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cerate configmap [NAME] --from-file=[key=]source --from-file=[key=]source</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡â€“from-fileå‚æ•°ä»ç›®å½•ä¸­è¿›è¡Œåˆ›å»ºï¼Œè¯¥ç›®å½•ä¸‹çš„æ¯ä¸ªé…ç½®æ–‡ä»¶åéƒ½è¢«è®¾ç½®ä¸ºkeyï¼Œæ–‡ä»¶çš„å†…å®¹è¢«è®¾ç½®ä¸ºvalueï¼Œè¯­æ³•ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cerate configmap [NAME] --from-file=config-file-dir</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨â€“from-literalæ—¶ä¼šä»æ–‡æœ¬ä¸­è¿›è¡Œåˆ›å»ºï¼Œç›´æ¥å°†æŒ‡å®šçš„key#=value#åˆ›å»ºä¸ºConfigMapçš„å†…å®¹ï¼Œè¯­æ³•ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cerate configmap [NAME] --from-literal=key1=value1 --from-literal=key2=value2</span><br></pre></td></tr></table></figure></li></ol><p>æ¯”å¦‚ä½¿ç”¨kubectlå‘½ä»¤åˆ›å»ºä¸€ä¸ªå’Œsimple-cmæ•ˆæœä¸€æ ·çš„ConfigMapï¼š</p><p><img src="img/QQæˆªå›¾20191103150859.png" alt="QQæˆªå›¾20191103150859.png"></p><p>ä½¿ç”¨kubectlå‘½ä»¤åˆ›å»ºä¸€ä¸ªå’Œfile-cmæ•ˆæœä¸€æ ·çš„ConfigMapï¼š</p><p>é¦–å…ˆåœ¨å½“å‰ç›®å½•ä¸‹å‡†å¤‡å¥½ä¸¤ä¸ªé…ç½®æ–‡ä»¶server.xmlå’Œserver.propertiesï¼š</p><p><img src="img/QQæˆªå›¾20191103151524.png" alt="QQæˆªå›¾20191103151524.png"></p><p>ç„¶åä½¿ç”¨kubectlå‘½ä»¤åˆ›å»ºï¼š</p><p><img src="img/QQæˆªå›¾20191103151751.png" alt="QQæˆªå›¾20191103151751.png"></p><h3 id="Podå®¹å™¨ä½¿ç”¨ConfigMap"><a href="#Podå®¹å™¨ä½¿ç”¨ConfigMap" class="headerlink" title="Podå®¹å™¨ä½¿ç”¨ConfigMap"></a>Podå®¹å™¨ä½¿ç”¨ConfigMap</h3><p>Podçš„å®¹å™¨è¦ä½¿ç”¨ConfigMapä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>é€šè¿‡ç¯å¢ƒå˜é‡è·å–ConfigMapä¸­çš„å†…å®¹;</li><li>é€šè¿‡VolumeæŒ‚è½½çš„æ–¹å¼å°†ConfigMapä¸­çš„å†…å®¹æŒ‚è½½ä¸ºå®¹å™¨å†…éƒ¨çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚</li></ol><p><strong>é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼</strong></p><p>åˆ›å»ºä¸€ä¸ªPodé…ç½®ï¼ˆsimple-cm-pod.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">simple-cm-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"env | grep ENV"</span><span class="string">]</span> <span class="comment"># æ‰“å°åç§°åŒ…å«ENVçš„ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ENVVERSION</span>     <span class="comment"># å®šä¹‰ç¯å¢ƒå˜é‡åç§°</span></span><br><span class="line"><span class="attr">          valueFrom:</span>           <span class="comment"># å€¼æ¥è‡ª...</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span>   <span class="comment"># ConfigMapé”®çš„å¼•ç”¨</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">version</span>     <span class="comment"># ConfigMapçš„key</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">simple-cm</span>  <span class="comment"># ConfigMapçš„åç§°</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ENVRELEASE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">release</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">simple-cm</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼Œå¹¶æŸ¥çœ‹æ—¥å¿—ï¼š</p><p><img src="img/QQæˆªå›¾20191103153532.png" alt="QQæˆªå›¾20191103153532.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå€¼å·²ç»æˆåŠŸä»ConfigMapé‡Œå»åˆ°äº†ã€‚</p><p>å¦‚æœè¦å¼•ç”¨æŸä¸ªConfigMapçš„æ‰€æœ‰å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ç§æ–¹å¼ã€‚å®šä¹‰ä¸€ä¸ªPodé…ç½®ï¼ˆsimple-cm-pod-all.uymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">simple-cm-pod-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"env"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      envFrom:</span></span><br><span class="line"><span class="attr">        - configMapRef:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">simple-cm</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼Œå¹¶æŸ¥çœ‹æ—¥å¿—ï¼š</p><p><img src="img/QQæˆªå›¾20191103154213.png" alt="QQæˆªå›¾20191103154213.png"></p><p><strong>é€šè¿‡VolumeæŒ‚è½½çš„æ–¹å¼</strong></p><p>åˆ›å»ºä¸€ä¸ªPodé…ç½®ï¼ˆfile-cm-pod.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">file-cm-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/configs</span> <span class="comment"># å®¹å™¨æŒ‚è½½ç›®å½•ä¸º/configs</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">config-vm</span> <span class="comment"># å¼•ç”¨ä¸‹é¢å®šä¹‰çš„è¿™ä¸ªVolume</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">config-vm</span>   <span class="comment"># volumeåç§°ä¸ºconfig-vm</span></span><br><span class="line"><span class="attr">      configMap:</span>        <span class="comment"># é€šè¿‡ConfigMapè·å–</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">file-cm</span>   <span class="comment"># å¼•ç”¨åç§°ä¸ºfile-cmçš„ConfigMap</span></span><br><span class="line"><span class="attr">        items:</span></span><br><span class="line"><span class="attr">          - key:</span> <span class="string">serverXml</span> <span class="comment"># ConfigMapé‡Œé…ç½®çš„key</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">server.xml</span> <span class="comment"># å€¼ä½¿ç”¨server.xmlæ–‡ä»¶è¿›è¡ŒæŒ‚è½½</span></span><br><span class="line"><span class="attr">          - key:</span> <span class="string">serverProperties</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">server.properties</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼Œå¹¶è¿›å…¥åˆ°å®¹å™¨å†…éƒ¨è§‚å¯Ÿ/configsç›®å½•ä¸‹æ–‡ä»¶å†…å®¹ï¼š</p><p><img src="img/QQæˆªå›¾20191103155731.png" alt="QQæˆªå›¾20191103155731.png"></p><p>å¯ä»¥çœ‹åˆ°åç§°ä¸ºfile-cmçš„ConfigMapå†…å®¹å·²ç»æˆåŠŸæŒ‚è½½åˆ°äº†tomcatå®¹å™¨å†…éƒ¨ã€‚</p><p>å¦‚æœåœ¨å¼•ç”¨ConfigMapæ—¶ä¸æŒ‡å®šitemsï¼Œåˆ™ä½¿ç”¨volumeMountæ–¹å¼åœ¨å®¹å™¨å†…çš„ç›®å½•ä¸‹ä¸ºæ¯ä¸ªiteméƒ½ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶åä¸ºkeyçš„æ–‡ä»¶ã€‚</p><div class="note danger"><p>åœ¨Podå¯¹ConfigMapè¿›è¡ŒæŒ‚è½½ï¼ˆvolumeMountï¼‰æ“ä½œæ—¶ï¼Œåœ¨å®¹å™¨å†…éƒ¨åªèƒ½æŒ‚è½½ä¸ºâ€œç›®å½•â€ï¼Œæ— æ³•æŒ‚è½½ä¸ºâ€œæ–‡ä»¶â€ã€‚åœ¨æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨åï¼Œåœ¨ç›®å½•ä¸‹å°†åŒ…å«ConfigMapå®šä¹‰çš„æ¯ä¸ªitemï¼Œå¦‚æœåœ¨è¯¥ç›®å½•ä¸‹åŸæ¥è¿˜æœ‰å…¶ä»–æ–‡ä»¶ï¼Œåˆ™å®¹å™¨å†…çš„è¯¥ç›®å½•å°†è¢«æŒ‚è½½çš„ConfigMap<strong>è¦†ç›–</strong>ã€‚</p></div><h2 id="Downward-API"><a href="#Downward-API" class="headerlink" title="Downward API"></a>Downward API</h2><p>Downward APIç”¨äºå°†Podç›¸å…³ä¿¡æ¯æ³¨å…¥åˆ°å®¹å™¨å†…éƒ¨ï¼Œä¸»è¦æœ‰<strong>ç¯å¢ƒå˜é‡</strong>å’Œ<strong>VolumeæŒ‚è½½</strong>ä¸¤ç§æ–¹å¼ã€‚</p><p><strong>ç¯å¢ƒå˜é‡</strong></p><p>åˆ›å»ºä¸€ä¸ªPodé…ç½®ï¼ˆdapi-pod.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dapi-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"env | grep MY_POD"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_POD_NAME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.name</span> <span class="comment"># é€šè¿‡downward apiè·å–å½“å‰podåç§°</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_POD_NAMESPACE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.namespace</span>  <span class="comment"># é€šè¿‡downward apiè·å–å½“å‰pod namespace</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_POD_IP</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">status.podIP</span>  <span class="comment"># é€šè¿‡downward apiè·å–å½“å‰pod IP</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼Œå¹¶æŸ¥çœ‹æ—¥å¿—ï¼š</p><p><img src="img/QQæˆªå›¾20191103162045.png" alt="QQæˆªå›¾20191103162045.png"></p><p>é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼è¿˜å¯ä»¥å°†å®¹å™¨çš„requestså’Œlimitsä¿¡æ¯æ³¨å…¥åˆ°å®¹å™¨çš„ç¯å¢ƒå˜é‡ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªPodé…ç½®ï¼ˆdapi-pod-container-vars.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dapi-pod-container-vars</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;do</span></span><br><span class="line">            <span class="string">echo</span> <span class="bullet">-en</span> <span class="string">'\n'</span><span class="string">;</span></span><br><span class="line">            <span class="string">printenv</span> <span class="string">MY_CPU_REQUEST</span> <span class="string">MY_CPU_LIMIT;</span></span><br><span class="line">            <span class="string">printenv</span> <span class="string">MY_MEM_REQUEST</span> <span class="string">MY_MEM_LIMIT;</span></span><br><span class="line">            <span class="string">sleep</span> <span class="number">3600</span><span class="string">;</span></span><br><span class="line">          <span class="string">done;</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="string">"32Mi"</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="string">"125m"</span></span><br><span class="line"><span class="attr">        limits:</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="string">"64Mi"</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="string">"250m"</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_CPU_REQUEST</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            resourceFieldRef:</span></span><br><span class="line"><span class="attr">              resource:</span> <span class="string">requests.cpu</span></span><br><span class="line"><span class="attr">              containerName:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_CPU_LIMIT</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            resourceFieldRef:</span></span><br><span class="line"><span class="attr">              resource:</span> <span class="string">limits.cpu</span></span><br><span class="line"><span class="attr">              containerName:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_MEM_REQUEST</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            resourceFieldRef:</span></span><br><span class="line"><span class="attr">              resource:</span> <span class="string">request.memory</span></span><br><span class="line"><span class="attr">              containerName:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_MEM_LIMIT</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            resourceFieldRef:</span></span><br><span class="line"><span class="attr">              resource:</span> <span class="string">limits.memory</span></span><br><span class="line"><span class="attr">              containerName:</span> <span class="string">busybox</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podå¹¶è§‚å¯Ÿæ—¥å¿—ï¼š</p><p><img src="img/QQæˆªå›¾20191103163059.png" alt="QQæˆªå›¾20191103163059.png"></p><p><strong>é€šè¿‡VolumeæŒ‚è½½</strong></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡Downward APIå°†Podçš„Labelï¼ŒAnnotationç­‰ä¿¡æ¯æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨æ–‡ä»¶ä¸­ï¼Œæ–°å»ºä¸€ä¸ªPodé…ç½®ï¼ˆdapi-pod-volumes.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dapi-pod-volume</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">    release:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line"><span class="attr">    builder:</span> <span class="string">mrbird</span></span><br><span class="line"><span class="attr">    blog:</span> <span class="attr">https://mrbird.cc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"sleep 36000"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/podinfo</span> <span class="comment"># æŒ‚è½½è·¯å¾„</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">pod-info</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">pod-info</span></span><br><span class="line"><span class="attr">      downwardAPI:</span> <span class="comment"># é€šè¿‡downward apiè·å–pod labelså’Œannationsä¿¡æ¯</span></span><br><span class="line"><span class="attr">        items:</span></span><br><span class="line"><span class="attr">          - path:</span> <span class="string">"labels"</span> <span class="comment"># æŒ‚è½½æ–‡ä»¶åç§°</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.labels</span> <span class="comment"># æŒ‚è½½å†…å®¹</span></span><br><span class="line"><span class="attr">          - path:</span> <span class="string">"annotation"</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.annotations</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼Œå¹¶è¿›å…¥åˆ°å®¹å™¨/podinfoç›®å½•è§‚å¯Ÿç»“æœï¼š</p><p><img src="img/QQæˆªå›¾20191103171025.png" alt="QQæˆªå›¾20191103171025.png"></p><h2 id="Podç”Ÿå‘½å‘¨æœŸ"><a href="#Podç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Podç”Ÿå‘½å‘¨æœŸ"></a>Podç”Ÿå‘½å‘¨æœŸ</h2><table><thead><tr><th>é˜¶æ®µ</th><th>æè¿°</th></tr></thead><tbody><tr><td><strong>Pending</strong></td><td>Pod å·²è¢« Kubernetes æ¥å—ï¼Œä½†å°šæœªåˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨é•œåƒã€‚è¿™åŒ…æ‹¬è¢«è°ƒåº¦ä¹‹å‰çš„æ—¶é—´ä»¥åŠé€šè¿‡ç½‘ç»œä¸‹è½½é•œåƒæ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œæ‰§è¡Œéœ€è¦ä¸€æ®µæ—¶é—´ã€‚</td></tr><tr><td><strong>Running</strong></td><td>Pod å·²ç»è¢«ç»‘å®šåˆ°äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€æœ‰å®¹å™¨å·²è¢«åˆ›å»ºã€‚è‡³å°‘ä¸€ä¸ªå®¹å™¨æ­£åœ¨è¿è¡Œï¼Œæˆ–è€…æ­£åœ¨å¯åŠ¨æˆ–é‡æ–°å¯åŠ¨ã€‚</td></tr><tr><td><strong>Succeeded</strong></td><td>æ‰€æœ‰å®¹å™¨æˆåŠŸç»ˆæ­¢ï¼Œä¹Ÿä¸ä¼šé‡å¯ã€‚</td></tr><tr><td><strong>Failed</strong></td><td>æ‰€æœ‰å®¹å™¨ç»ˆæ­¢ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨ä»¥å¤±è´¥æ–¹å¼ç»ˆæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªå®¹å™¨è¦ä¹ˆå·²é 0 çŠ¶æ€é€€å‡ºï¼Œè¦ä¹ˆè¢«ç³»ç»Ÿç»ˆæ­¢ã€‚</td></tr><tr><td><strong>Unknown</strong></td><td>ç”±äºä¸€äº›åŸå› ï¼ŒPod çš„çŠ¶æ€æ— æ³•è·å–ï¼Œé€šå¸¸æ˜¯ä¸ Pod é€šä¿¡æ—¶å‡ºé”™å¯¼è‡´çš„ã€‚</td></tr></tbody></table><p>ä¸‰ç§é‡å¯ç­–ç•¥ï¼š</p><ol><li>Alwaysï¼šå½“å®¹å™¨å¤±æ•ˆæ—¶ï¼Œç”±kubeletè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ï¼›</li><li>OnFailureï¼šå½“å®¹å™¨ç»ˆæ­¢è¿è¡Œä¸”é€€å‡ºç ä¸ä¸º0æ—¶ï¼Œç”±kubeletè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ï¼›</li><li>Neverï¼šä¸è®ºå®¹å™¨è¿è¡ŒçŠ¶æ€å¦‚ä½•ï¼Œkubeletéƒ½ä¸ä¼šé‡å¯è¯¥å®¹å™¨ã€‚</li></ol><p>ç»“åˆPodçš„çŠ¶æ€å’Œé‡å¯ç­–ç•¥ï¼Œä»¥ä¸‹ä¸ºä¸€äº›å¸¸è§çš„çŠ¶æ€è½¬æ¢åœºæ™¯ï¼š</p><table align="center" border="1" cellpadding="1" cellspacing="1"><tbody><tr><td colspan="1" rowspan="2" style="text-align:center;width:107px">PodåŒ…å«çš„å®¹å™¨æ•°</td><td colspan="1" rowspan="2" style="text-align:center;width:108px">Podå½“å‰çš„çŠ¶æ€</td><td colspan="1" rowspan="2" style="text-align:center;width:139px">å‘ç”Ÿäº‹ä»¶</td><td colspan="3" rowspan="1" style="text-align:center;width:486px">Podçš„ç»“æœçŠ¶æ€</td></tr><tr><td style="width:137px">RestarPolicy=Always</td><td style="width:162px">RestartPolicy=OnFailure</td><td style="width:180px">RestartPolicy=Never</td></tr><tr><td style="width:107px">åŒ…å«1ä¸ªå®¹å™¨</td><td style="width:108px">Running</td><td style="width:139px">å®¹å™¨æˆåŠŸé€€å‡º</td><td style="width:137px">Running</td><td style="width:162px">Succeeded</td><td style="width:180px">Succeeded</td></tr><tr><td style="width:107px">åŒ…å«1ä¸ªå®¹å™¨</td><td style="width:108px">Running</td><td style="width:139px">å®¹å™¨å¤±è´¥é€€å‡º</td><td style="width:137px">Running</td><td style="width:162px">Running</td><td style="width:180px">Failed</td></tr><tr><td style="width:107px">åŒ…å«ä¸¤ä¸ªå®¹å™¨</td><td style="width:108px">Running</td><td style="width:139px">1ä¸ªå®¹å™¨å¤±è´¥é€€å‡º</td><td style="width:137px">Running</td><td style="width:162px">Running</td><td style="width:180px">Running</td></tr><tr><td style="width:107px">åŒ…å«ä¸¤ä¸ªå®¹å™¨</td><td style="width:108px">Running</td><td style="width:139px">å®¹å™¨è¢«OOMæ€æ‰</td><td style="width:137px">Running</td><td style="width:162px">Running</td><td style="width:180px">Failed</td></tr></tbody></table><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Podæ˜¯Kubernetesçš„æœ€å°è°ƒåº¦å•ä½ï¼ŒåŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚Dockerå®¹å™¨ï¼‰ï¼Œå®¹å™¨é—´å…±äº«ç½‘ç»œå’Œå­˜å‚¨ã€‚è¿™èŠ‚ä¸»è¦è®°å½•ä»€ä¹ˆæ˜¯é™æ€Podï¼ŒPodå®¹å™¨å¦‚ä½•å…±äº«å­˜å‚¨ï¼Œå¦‚ä½•ä½¿ç”¨ConfigMapç®¡ç†Podé…ç½®ï¼Œå¦‚ä½•ä½¿ç”¨Downward APIè·å–Podä¿¡æ¯ç­‰ã€‚
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>KubernetesåŸºç¡€</title>
    <link href="http://mrbird.cc/Kubernetes-Basic.html"/>
    <id>http://mrbird.cc/Kubernetes-Basic.html</id>
    <published>2019-10-30T07:36:15.000Z</published>
    <updated>2020-01-21T03:30:03.134Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»æˆåŠŸæ­å»ºäº†Kubernetesé›†ç¾¤ï¼ŒKubernetesåŒ…å«äº†å¤§é‡çš„æ¦‚å¿µå’Œæœ¯è¯­ï¼Œæ¯”å¦‚Masterã€Nodeã€Podã€Replication Controllerã€Serviceç­‰ç­‰ï¼Œåœ¨æ·±å…¥å­¦ä¹ Kubernetesä¹‹å‰ï¼Œæœ‰å¿…è¦æ‹æ¸…Kubernetesæ¶æ„è®¾è®¡å’Œè¿™äº›æœ¯è¯­çš„å«ä¹‰ã€‚</p><a id="more"></a><h2 id="Kubernetesæ¶æ„"><a href="#Kubernetesæ¶æ„" class="headerlink" title="Kubernetesæ¶æ„"></a>Kubernetesæ¶æ„</h2><p>KubernetesåŸºæœ¬æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191030093713.png" alt="QQæˆªå›¾20191030093713.png"></p><p>ç”±ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒKubernetesé›†ç¾¤èŠ‚ç‚¹å¯åˆ†ä¸º<strong>Master</strong>å’Œ<strong>Node</strong>ï¼š</p><ul><li>Masterï¼šæŒ‡çš„æ˜¯é›†ç¾¤ä¸­çš„æ§åˆ¶èŠ‚ç‚¹ï¼Œè´Ÿè´£ç®¡ç†å’Œæ§åˆ¶æ•´ä¸ªé›†ç¾¤ã€‚åŸºæœ¬ä¸Šæˆ‘ä»¬å¯¹Kubernetesé›†ç¾¤çš„æ“ä½œéƒ½æ˜¯åœ¨MasterèŠ‚ç‚¹ä¸Šå®Œæˆçš„ï¼›</li><li>Nodeï¼šé™¤äº†Masterå¤–ï¼ŒKubernetesé›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹ç§°ä¸ºNodeã€‚æ¯ä¸ªNodeéƒ½å°†è´Ÿè´£è¿è¡ŒMasteræŒ‡æ´¾çš„Dockerå®¹å™¨ï¼Œå½“æŸä¸ªNodeå®•æœºåï¼Œè¿™äº›å·¥ä½œä¼šè¢«Masterè½¬ç§»åˆ°åˆ«çš„Nodeä¸Šã€‚</li></ul><p>MasterèŠ‚ç‚¹ä¸Šä¸»è¦åŒ…å«äº†ä»¥ä¸‹è¿™äº›å…³æ¥çš„è¿›ç¨‹:</p><ol><li><strong>API Server</strong>ï¼šæä¾›äº†HTTP Restæ¥å£çš„å…³é”®æœåŠ¡è¿›ç¨‹ï¼Œæ˜¯Kubernetesé‡Œæ‰€æœ‰èµ„æºçš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œä¹Ÿæ˜¯é›†ç¾¤æ§åˆ¶çš„å…¥å£è¿›ç¨‹ï¼›</li><li><strong>Controller Manager</strong>ï¼šè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ï¼Œæ‰©ç¼©å®¹ï¼Œæ»šåŠ¨æ›´æ–°ç­‰ç­‰ï¼›</li><li><strong>Scheduler</strong>ï¼šè´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„ç­–ç•¥æŠŠpodè°ƒåº¦åˆ°æŒ‡å®šçš„nodeèŠ‚ç‚¹ï¼›</li><li><strong>etcd</strong>ï¼šå­˜å‚¨Kubernetesé›†ç¾¤ä¿¡æ¯ã€‚</li></ol><p>NodeèŠ‚ç‚¹ä¸Šä¸»è¦åŒ…å«äº†ä»¥ä¸‹è¿™äº›å…³æ¥çš„è¿›ç¨‹:</p><ol><li><strong>kubelet</strong>ï¼šè´Ÿè´£Podå¯¹åº”çš„å®¹å™¨çš„åˆ›å»ºã€å¯åœç­‰ä»»åŠ¡ï¼›</li><li><strong>kube-proxy</strong>ï¼šå®ç°Kubernetes Serviceçš„é€šä¿¡ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„é‡è¦ç»„ä»¶ï¼›</li><li><strong>docker</strong>ï¼šDockerå¼•æ“ï¼Œè´Ÿè´£æœ¬æœºçš„å®¹å™¨åˆ›å»ºå’Œç®¡ç†å·¥ä½œï¼›</li><li><strong>pod</strong>ï¼šPodæ˜¯Kubernetesä¸­èƒ½å¤Ÿåˆ›å»ºå’Œéƒ¨ç½²çš„æœ€å°å•å…ƒï¼Œæ˜¯Kubernetesé›†ç¾¤ä¸­çš„ä¸€ä¸ªåº”ç”¨å®ä¾‹ã€‚PodåŒ…å«äº†ä¸€ä¸ªâ€œæ ¹å®¹å™¨â€Pauseå’Œå¤šä¸ªDockerå®¹å™¨ï¼›</li></ol><p>KubernetesèŠ‚ç‚¹é—´çš„ç½‘ç»œé€šä¿¡é€šè¿‡ç½‘ç»œæ’ä»¶å®ç°ï¼Œæ¯”å¦‚Flannelï¼ŒCalicoç­‰ã€‚</p><h2 id="Podç®¡ç†å¯¹è±¡"><a href="#Podç®¡ç†å¯¹è±¡" class="headerlink" title="Podç®¡ç†å¯¹è±¡"></a>Podç®¡ç†å¯¹è±¡</h2><p>Podç®¡ç†å¯¹è±¡æŒ‡çš„æ˜¯Kubernetesä¸­å¯ä»¥ç”¨äºåˆ›å»ºå’Œç®¡ç†Podçš„ç»„ä»¶ï¼Œæ¯”å¦‚RC(RS)ï¼ŒDeploymentï¼ŒStableSetç­‰ç­‰ã€‚åœ¨äº†è§£è¿™äº›ç»„ä»¶å‰ï¼Œå…ˆæ¥çœ‹çœ‹Podçš„ç»„æˆï¼š</p><p><img src="img/QQæˆªå›¾20191030105535.png" alt="QQæˆªå›¾20191030105535.png"></p><p>PodåŒ…å«ä¸€ä¸ª<strong>Pause</strong>å®¹å™¨å’Œå¤šä¸ªDockerå®¹å™¨ï¼ŒPauseå®¹å™¨ç”¨äºç®¡ç†è¿™äº›Dockerå®¹å™¨ã€‚</p><p>Podå¯ä»¥é€šè¿‡yamlæ–‡ä»¶æ¥åˆ›å»ºï¼Œä¸‹é¢ä¸¾ä¸ªç®€å•çš„ä¾‹å­:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span> <span class="comment"># kindä¸ºpodè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªpodå®šä¹‰</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-pod</span> <span class="comment"># podåç§°ä¸ºnginx-pod</span></span><br><span class="line"><span class="attr">  labels:</span> <span class="comment"># å®šä¹‰æ ‡ç­¾ä¿¡æ¯ï¼ˆlabelï¼‰</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span> </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span> <span class="comment"># å®¹å™¨åç§°</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span> <span class="comment"># åŸºäºnginxé•œåƒæ„å»º</span></span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span> <span class="comment"># é•œåƒæ‹‰å–è§„åˆ™ï¼Œä¸å­˜åœ¨åˆ™è¿œç¨‹æ‹‰å–</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span> <span class="comment"># ç«¯å£</span></span><br></pre></td></tr></table></figure><p></p><p>æ¯ä¸ªPodéƒ½åŒ…å«ä¸€ä¸ªå”¯ä¸€çš„IPåœ°å€ï¼Œç§°ä¸º<strong>Pod IP</strong>ï¼ŒKubernetesé›†ç¾¤å†…çš„ä»»æ„ä¸¤ä¸ªPodä¹‹é—´éƒ½èƒ½æ­£å¸¸é€šä¿¡ã€‚Pod IPåŠ ä¸Šä¸Šé¢å®šä¹‰çš„80ç«¯å£ï¼Œç»„æˆäº†ä¸€ä¸ª<strong>Endpoint</strong>ï¼Œä»£è¡¨æ­¤Podé‡Œçš„ä¸€ä¸ªæœåŠ¡è¿›ç¨‹çš„å¯¹å¤–é€šä¿¡åœ°å€ã€‚Podçš„ç›¸å…³å†…å®¹å­˜å‚¨åœ¨<strong>Volume</strong>ä¸­ï¼ŒPodçš„ç›¸å…³è¿è¡Œè®°å½•å¯ä»¥é€šè¿‡<strong>Event</strong>æŸ¥çœ‹ï¼š</p><p><img src="img/QQæˆªå›¾20191030113626.png" alt="QQæˆªå›¾20191030113626.png"></p><p>åœ¨å®šä¹‰Podçš„æ—¶å€™æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šèµ„æºèµ„æºé™é¢ï¼Œèµ„æºä¸»è¦åŒ…æ‹¬<strong>CPU</strong>å’Œ<strong>Memory</strong>ï¼š</p><ul><li><p>åœ¨Kubernetesä¸­ï¼Œ1mè¡¨ç¤ºåƒåˆ†ä¹‹ä¸€CPUï¼Œå³1000mè¡¨ç¤ºä¸€ä¸ªCPUï¼›</p></li><li><p>å¸¸ç”¨å•ä½æœ‰KiBã€MiBå’ŒGiBç­‰ï¼Œæ˜¯äºŒè¿›åˆ¶è¡¨ç¤ºçš„å­—èŠ‚å•ä½ï¼Œ1 KiBï¼ˆKibiByteï¼‰= 2^10 Bytes = 1024 Bytes = 8192 Bitsã€‚</p></li></ul><p>åœ¨Kubernetesé‡Œï¼Œä¸€ä¸ªè®¡ç®—èµ„æºè¿›è¡Œé…é¢é™å®šæ—¶éœ€è¦è®¾å®šä»¥ä¸‹ä¸¤ä¸ªå‚æ•°ï¼š</p><ol><li><strong>Requests</strong>ï¼šè¯¥èµ„æºçš„æœ€å°ç”³è¯·é‡ï¼Œç³»ç»Ÿå¿…é¡»æ»¡è¶³è¦æ±‚ï¼›</li><li><strong>Limits</strong>ï¼šè¯¥èµ„æºæœ€å¤§å…è®¸ä½¿ç”¨çš„é‡ï¼Œä¸èƒ½è¢«çªç ´ï¼Œå½“å®¹å™¨è¯•å›¾ä½¿ç”¨è¶…è¿‡è¿™ä¸ªé‡çš„èµ„æºæ—¶ï¼Œå¯èƒ½ä¼šè¢«Kubernetesâ€œæ€æ‰â€å¹¶é‡å¯ã€‚</li></ol><p>æ¯”å¦‚ä¿®æ”¹ä¸Šé¢çš„Podé…ç½®æ–‡ä»¶ï¼Œå®šä¹‰èµ„æºé…é¢ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span> </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-pod</span> </span><br><span class="line"><span class="attr">  labels:</span> </span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span> </span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span> </span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span> </span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="string">"64Mi"</span> <span class="comment"># è‡³å°‘éœ€è¦64MiBå†…å­˜</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="string">"200m"</span> <span class="comment"># è‡³å°‘éœ€è¦0.2ä¸ªCPU</span></span><br><span class="line"><span class="attr">        limits:</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="string">"128Mi"</span> <span class="comment"># å†…å­˜æ¶ˆè€—ä¸èƒ½å¤šäº128MiB</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="string">"500m"</span> <span class="comment"># CPUæ¶ˆè€—ä¸èƒ½å¤šäº0.5</span></span><br></pre></td></tr></table></figure><p></p><p>é™¤äº†ç›´æ¥ä½¿ç”¨Podé…ç½®æ–‡ä»¶æ¥åˆ›å»ºPodå¤–ï¼Œæ›´ä¸ºå¸¸ç”¨çš„æ˜¯ä½¿ç”¨Podç®¡ç†å¯¹è±¡RC(RS)ã€Deploymentç­‰åˆ›å»ºå’Œç®¡ç†Podã€‚</p><h3 id="RC-RS"><a href="#RC-RS" class="headerlink" title="RC(RS)"></a>RC(RS)</h3><p>RCå…¨ç§°Replication Controllerï¼ˆå‰¯æœ¬æ§åˆ¶å™¨ï¼‰,ç”¨äºæ§åˆ¶ä»»æ„æ—¶åˆ»æŒ‡å®šPodçš„æ•°é‡éƒ½ç¬¦åˆé¢„æœŸå€¼ã€‚RCé…ç½®æ–‡ä»¶ä¸€èˆ¬åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>æœŸæœ›çš„Podå‰¯æœ¬æ•°é‡ï¼›</li><li>ç”¨äºç­›é€‰Podçš„Label Selectorï¼›</li><li>åˆ›å»ºPodçš„æ¨¡æ¿ï¼ˆå½“æ•°é‡å°‘äºé¢„æœŸçš„æ—¶å€™ï¼Œç”¨è¿™ä¸ªæ¨¡æ¿åˆ›å»ºPodï¼‰ã€‚</li></ol><p>ä¸¾ä¸ªRC yamlçš„ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController # è¡¨ç¤ºRC</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-rc # RCæ§åˆ¶å™¨åç§°ä¸ºnginx-rc</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3 # æœŸæœ›Podçš„å‰¯æœ¬æ•°é‡ä¸º3</span><br><span class="line">  selector:</span><br><span class="line">    name: nginx # Labelç­›é€‰å™¨ï¼Œç­›é€‰å‡ºLabelåŒ…å«ï¼ˆname=nginxï¼‰çš„Pod</span><br><span class="line">  template: # Podåˆ›å»ºæ¨¡æ¿ï¼Œæ ¼å¼åŸºæœ¬å’Œæˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„Pod yamlä¸€è‡´</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡è¿™ä¸ªRCï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ï¼šåœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œä»»æ„æ—¶åˆ»éƒ½å­˜åœ¨3ä¸ªè¿è¡Œç€Nginxå®¹å™¨çš„Podï¼Œå³é€šè¿‡è¿™ä¸ªRCæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªNginxæ•°é‡ä¸º3çš„Nginxé›†ç¾¤ï¼ˆå…¶ä¸­ä¸€ç§å¯èƒ½æ€§ï¼‰ï¼š</p><p><img src="img/QQæˆªå›¾20191030142008.png" alt="QQæˆªå›¾20191030142008.png"></p><p>åœ¨Kubernetesçš„å‘å±•ä¸­ï¼ŒRCå‡çº§ä¸ºäº†Replica Setï¼Œä¿—ç§°RSï¼Œè¯­æ³•å¤§è‡´å’ŒRCä¸€è‡´ã€‚RSå’ŒRCæœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šRSæ‹¥æœ‰æ›´ä¸ºğŸ‚ğŸºçš„Podç­›é€‰å™¨ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">    matchExpressions:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">&#123;key:</span> <span class="string">release,</span> <span class="attr">operator:</span> <span class="string">In,</span> <span class="attr">values:</span> <span class="string">[stable,</span> <span class="string">snapshot]&#125;</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„RSç­›é€‰Podè§„åˆ™ä¸ºï¼šç­›é€‰æ ‡ç­¾åŒ…å«tierä¸ºfrontendï¼Œå¹¶ä¸”releaseçš„å€¼ä¸ºstableæˆ–è€…snapshotçš„Podã€‚</p><p>æ€»ä¹‹ï¼ŒRC(RS)çš„ä½œç”¨ä¸º:</p><ol><li>Podçš„åˆ›å»ºåŠæ•°é‡æ§åˆ¶ï¼›</li><li>é€šè¿‡æ”¹å˜RCé‡Œçš„Podå‰¯æœ¬æ•°é‡ï¼Œå¯ä»¥å®ç°Podçš„æ‰©å®¹æˆ–ç¼©å®¹ï¼›</li><li>é€šè¿‡æ”¹å˜RCé‡ŒPodæ¨¡æ¿ä¸­çš„é•œåƒç‰ˆæœ¬ï¼Œå¯ä»¥å®ç°Podçš„æ»šåŠ¨å‡çº§ã€‚</li></ol><h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>Deploymentå¯ä»¥çœ‹æˆæ˜¯RSçš„å‡çº§ç‰ˆç»„ä»¶ï¼Œå†…éƒ¨ä½¿ç”¨RSç®¡ç†Podï¼Œå’ŒRSç›¸æ¯”æœ€å¤§çš„ä¸åŒåœ¨äºDeploymentå¯ä»¥éšæ—¶æŸ¥çœ‹Podçš„éƒ¨ç½²çŠ¶æ€ã€‚Deploymentçš„yamlé…ç½®å’ŒRSå·®ä¸å¤šï¼Œä¸¾ä¸ªDeployment yamlçš„ä¾‹å­(nginx-deployment.yml):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: nginx</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br></pre></td></tr></table></figure><p></p><p>é™¤äº†kindï¼Œå…¶ä»–éƒ½å’ŒRSå·®ä¸å¤šã€‚åœ¨Kubernetesé›†ç¾¤ä¸­åˆ›å»ºè¯¥Deploymentï¼š</p><p><img src="img/QQæˆªå›¾20191030152700.png" alt="QQæˆªå›¾20191030152700.png"></p><ul><li>READYï¼šé›†ç¾¤ä¸­å‡†å¤‡å°±ç»ªçš„Podæ•°é‡ï¼›</li><li>UP-TO-DATEï¼šæœ€æ–°ç‰ˆæœ¬çš„Podçš„å‰¯æœ¬æ•°é‡ï¼Œç”¨äºæŒ‡ç¤ºåœ¨æ»šåŠ¨å‡çº§çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å¤šå°‘ä¸ªPodå‰¯æœ¬å·²ç»æˆåŠŸå‡çº§ï¼›</li><li>AVAILABLEï¼šå½“å‰é›†ç¾¤ä¸­å¯ç”¨çš„Podå‰¯æœ¬æ•°é‡ï¼Œå³é›†ç¾¤ä¸­å½“å‰å­˜æ´»çš„Podæ•°é‡ã€‚</li></ul><p>æŸ¥çœ‹RSå’ŒPodï¼š</p><p><img src="img/QQæˆªå›¾20191030153402.png" alt="QQæˆªå›¾20191030153402.png"></p><p>å¯ä»¥çœ‹åˆ°å®ƒä»¬çš„å…³ç³»ä¸ºdeployment -&gt; rs -&gt; podsï¼š</p><p><img src="img/QQæˆªå›¾20191030154129.png" alt="QQæˆªå›¾20191030154129.png"></p><h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><p>StatefulSetï¼ˆæœ‰çŠ¶æ€é›†åˆï¼‰å¯ä»¥çœ‹æˆæ˜¯Deploymentçš„ä¸€ä¸ªå˜ç§ï¼Œé€‚åˆç”¨äºæ„å»ºMySQLé›†ç¾¤ã€MongoDBé›†ç¾¤ç­‰æœ‰çŠ¶æ€çš„é›†ç¾¤ï¼Œè¿™äº›é›†ç¾¤æœ‰ä»¥ä¸‹è¿™äº›å…±åŒç‰¹ç‚¹ï¼š</p><ol><li>é›†ç¾¤è§„æ¨¡ç›¸å¯¹å›ºå®šï¼Œä¸èƒ½éšæ„å˜åŠ¨ï¼›</li><li>é›†ç¾¤ä¸­æ¯ä¸ªPodéƒ½æ˜¯æœ‰çŠ¶æ€çš„ï¼Œå³æ•°æ®ä¼šè¢«æŒä¹…åŒ–åˆ°å­˜å‚¨ä¸­ï¼›</li><li>æ¯ä¸ªPodéƒ½æœ‰å›ºå®šçš„IDã€‚</li></ol><p>StatefulSetåˆ›å»ºçš„Podé›†ç¾¤ç¬¦åˆä¸Šé¢çš„éœ€æ±‚ï¼Œå…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹:</p><ol><li>æ¯ä¸ªPodçš„åç§°åœ¨åˆ›å»ºå‰å°±å¯ä»¥ç¡®å®šä¸‹æ¥äº†ã€‚æ¯”å¦‚StatefulSetçš„åç§°ä¸ºmysqlï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªPodå«mysql-0ï¼Œç¬¬äºŒä¸ªå«mysql-1ï¼Œä»¥æ­¤ç±»æ¨ï¼›</li><li>Podçš„å¯åœè¯•æ˜¯æŒ‰ç…§é¡ºåºæ¥çš„ï¼›</li><li>Podé€šè¿‡PVæˆ–è€…PVCæ¥æŒä¹…åŒ–å­˜å‚¨ã€‚</li></ol><p>è¿™é‡Œå°±å…ˆä¸æ·±å…¥ç ”ç©¶StatefulSetäº†ï¼Œåé¢å†æ‰¾æœºä¼šç ”ç©¶ã€‚</p><h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><p>Jobæ˜¯ä¸€ç§ç‰¹æ®Šçš„Podç®¡ç†å¯¹è±¡ï¼Œæ˜¯ä¸€ç§ä¸€æ¬¡æ€§Podè¿è¡Œä»»åŠ¡ï¼Œä»»åŠ¡ç»“æŸåï¼ŒPodçš„ç”Ÿå‘½å‘¨æœŸä¹Ÿå°±ç»“æŸäº†ã€‚Kubernetesä¸­æ”¯æŒCronè¡¨è¾¾å¼çš„ä»»åŠ¡ç§°ä¸ºCronJobï¼Œåé¢æ¥è§¦åˆ°äº†å†ä»”ç»†ç ”ç©¶ğŸ˜ªã€‚</p><h2 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h2><p>å°±å¦‚ä¸Šé¢æ‰€è¯´ï¼ŒLabelå°±æ˜¯ç”¨äºç»™Podæ‰“æ ‡ç­¾ç”¨çš„ï¼Œä¾›Podç®¡ç†å¯¹è±¡ã€Serviceç­‰ç­›é€‰ä½¿ç”¨ã€‚</p><h2 id="HPA"><a href="#HPA" class="headerlink" title="HPA"></a>HPA</h2><p>é™¤äº†ä½¿ç”¨<code>kubectl scale</code>å‘½ä»¤ä¿®æ”¹Podæ•°é‡å®ç°æ‰©å®¹æˆ–è€…ç¼©å®¹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©HPAï¼ˆHorizontal Pod Autoscalingï¼ŒPodæ¨ªå‘è‡ªåŠ¨æ‰©å±•ï¼‰æ¥å®ŒæˆPodçš„è‡ªåŠ¨åŒ–æ‰©ç¼©å®¹ã€‚ä¸¾ä¸ªHPAçš„ä¾‹å­ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-hpa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  maxReplicas:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  minReplicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  scaleTargetRef:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">  targetCPUUtilizationPercentage:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢å®šä¹‰äº†ä¸€ä¸ªåä¸ºnginx-hpaçš„HPAï¼Œç›‘æ§åç§°ä¸ºnginx-deploymentçš„Deploymentä¸­çš„Podï¼Œå½“å…¶<code>targetCPUUtilizationPercentage</code>çš„å€¼å¤§äº80%æ—¶ï¼Œå°†å‘ç”ŸåŠ¨æ€æ‰©å®¹è¡Œä¸ºï¼Œå¹¶ä¸”Podçš„æ•°é‡å¿…é¡»å†3~10ä¹‹é—´ã€‚</p><p><code>targetCPUUtilizationPercentage</code>æŒ‡çš„æ˜¯Podä¸€åˆ†é’Ÿå†…CPUä½¿ç”¨ç‡çš„ç®—æ•°å¹³å‡å€¼ã€‚æ¯”å¦‚Podçš„requests cpuä¸º0.4ï¼Œå½“å‰CPUä½¿ç”¨é‡ä¸º0.3ï¼Œåˆ™CPUä½¿ç”¨ç‡ä¸º75%ã€‚æ‰€ä»¥è¦ä½¿ç”¨HPAçš„åŠŸèƒ½ï¼ŒPodå¿…é¡»æŒ‡å®šäº†requests cpuå€¼ã€‚</p><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>Serviceã€RCå’ŒPodä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191031100702.png" alt="QQæˆªå›¾20191031100702.png"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒServiceæ˜¯å¤–ç•Œè®¿é—®Podçš„æ¡¥æ¢ï¼ŒServiceé€šè¿‡Label Selectoræ¥ç­›é€‰å¤„ç¬¦åˆçš„Podï¼Œå°†è¯·æ±‚å‡è¡¡çš„è½¬å‘åˆ°ç›®æ ‡Podä¸Šã€‚å‰é¢ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡Deploymentåˆ›å»ºäº†ä¸‰ä¸ªNginx Podï¼Œä½†ç°åœ¨å¤–ç•Œå¹¶ä¸èƒ½ç›´æ¥è®¿é—®å®ƒä»¬ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªServiceæ¥å®ç°è¿™ä¸ªéœ€æ±‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx-service.yml</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30001</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢é…ç½®ä¸­<code>spec.ports</code>å®šä¹‰äº†ä¸‰ä¸ªç«¯å£ï¼Œåœ¨äº†è§£è¿™ä¸‰ä¸ªç«¯å£çš„å«ä¹‰ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹ä¸‹é¢è¿™ä¸‰ä¸ªIPçš„å«ä¹‰ï¼š</p><ol><li>Node IPï¼šNodeçš„IPåœ°å€ï¼ŒNodeæ˜¯éƒ¨ç½²åœ¨å®¿ä¸»æœºä¸Šçš„ï¼Œæ‰€ä»¥å®é™…ä¸Šå°±æ˜¯å®¿ä¸»æœºçš„IPåœ°å€ï¼Œä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼›</li><li>Pod IPï¼šPodçš„IPåœ°å€ï¼Œç”±äºåŠ¨æ€æ‰©ç¼©å®¹ã€å®•æœºè½¬ç§»ç­‰åŸå› ï¼Œè¿™ä¸ªIPç»å¸¸ä¼šå‘ç”Ÿæ”¹å˜ï¼›</li><li>Cluster IPï¼šServiceçš„IPåœ°å€ï¼Œåœ¨ä¸€ä¸ªå®Œæ•´çš„Serviceç”Ÿå‘½å‘¨æœŸå†…æ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚</li></ol><p>å…¶ä¸­<code>Pod IP</code>å’Œ<code>Cluster IP</code>æ˜¯å±äºKubernetesé›†ç¾¤èŒƒå›´å†…çš„ï¼Œå¤–ç•Œæ— æ³•ç›´æ¥è®¿é—®ã€‚</p><p>å†å›å¤´çœ‹ä¸Šé¢ä¸‰ä¸ªç«¯å£çš„å«ä¹‰ï¼š</p><ol><li>portï¼šæŒ‡å®šServiceçš„ç«¯å£å·ï¼›</li><li>targetPortï¼šç›®æ ‡Podçš„ç«¯å£ï¼Œæ ¹æ®å‰é¢nginx-deploymentçš„å®šä¹‰ï¼Œè¿™é‡Œåº”è¯¥æŒ‡å®šä¸º80ï¼›</li><li>nodePortï¼šåœ¨Nodeä¸Šå¼€å¯çš„ç›‘å¬ç«¯å£ï¼Œç”¨äºå¤–ç•Œé€šè¿‡<code>Cluster IP:nodePort</code>æ¥è®¿é—®å¯¹åº”çš„Serviceã€‚</li></ol><p>ä½¿ç”¨nodePortæ—¶ï¼Œéœ€è¦å°†Serviceçš„typeæŒ‡å®šä¸ºNodePortï¼Œå¹¶ä¸”nodePortæœ‰èŒƒå›´é™åˆ¶ï¼Œå¿…é¡»åœ¨30000-32767ä¹‹é—´ã€‚</p><p>ä½¿ç”¨<code>kubectl create -f nginx-service.yml</code>åˆ›å»ºè¯¥Serviceï¼š</p><p><img src="img/QQæˆªå›¾20191031104422.png" alt="QQæˆªå›¾20191031104422.png"></p><p>æŸ¥çœ‹Serviceå’Œendpointï¼š</p><p><img src="img/QQæˆªå›¾20191031104556.png" alt="QQæˆªå›¾20191031104556.png"></p><p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>node1 Ip:nodePort</code>æ¥è®¿é—®Nginx PodæœåŠ¡äº†ï¼š</p><p><img src="img/QQæˆªå›¾20191031104735.png" alt="QQæˆªå›¾20191031104735.png"></p><h2 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h2><p>Volumeæ˜¯Podä¸Šèƒ½å¤Ÿè¢«å¤šä¸ªDockerå®¹å™¨è®¿é—®çš„å…±äº«ç›®å½•ï¼ŒVolumeçš„ç”Ÿå‘½å‘¨æœŸå’ŒPodç›¸å…³ï¼Œä¸Dockerå®¹å™¨æ— å…³ã€‚å¯ä»¥åœ¨å®šä¹‰Podçš„æ—¶å€™æŒ‡å®šVolumeï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-pod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx-data</span></span><br><span class="line"><span class="attr">      emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/etc/nginx</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">nginx-data</span></span><br></pre></td></tr></table></figure><p></p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç°åœ¨Podé‡Œå£°æ˜ä¸€ä¸ªVolumeï¼Œç„¶ååœ¨å®¹å™¨é‡Œå¼•ç”¨è¯¥Volumeï¼Œå¹¶æŒ‚è½½åˆ°å®¹å™¨çš„æŸä¸ªç›®å½•ä¸Šã€‚</p><p>æ¯”è¾ƒå¸¸ç”¨çš„Volumeç±»å‹æœ‰ï¼š</p><ol><li><p>emptyDirï¼šä¸€ä¸ªemptyDir Volumeæ˜¯åœ¨Podåˆ†é…åˆ°Nodeæ—¶åˆ›å»ºçš„ã€‚ä»å®ƒçš„åç§°å°±å¯ä»¥çœ‹å‡ºï¼Œå®ƒçš„åˆå§‹å†…å®¹ä¸ºç©ºï¼Œå¹¶ä¸”æ— é¡»æŒ‡å®šå®¿ä¸»æœºä¸Šå¯¹åº”çš„ç›®å½•æ–‡ä»¶ï¼Œå› ä¸ºè¿™æ˜¯Kubernetesè‡ªåŠ¨åˆ†é…çš„ä¸€ä¸ªç›®å½•ï¼Œå½“Podä»Nodeä¸Šç§»é™¤æ—¶ï¼ŒemptyDirä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ°¸ä¹…åˆ é™¤ï¼›</p></li><li><p>hostPathä¸ºåœ¨Podä¸ŠæŒ‚è½½å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">"persistend-storage"</span></span><br><span class="line"><span class="attr">      hostPath:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">"/data"</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="PV-PVC"><a href="#PV-PVC" class="headerlink" title="PV,PVC"></a>PV,PVC</h2><p>PV(Persistent Volume)æ˜¯Kubernetesé›†ç¾¤ä¸­çš„æŸä¸ªç½‘ç»œå­˜å‚¨å¯¹åº”çš„ä¸€å—å­˜å‚¨ï¼Œä¸å±äºä»»ä½•Nodeï¼Œä½†å¯ä»¥åœ¨æ¯ä¸ªNodeä¸Šè®¿é—®ï¼›PVC(Persistent Volume Claimï¼ŒPVå£°æ˜)ï¼ŒæŸä¸ªPodéœ€è¦ç”¨åˆ°PVå‰ï¼Œå¿…é¡»å…ˆå®šä¹‰PVCã€‚</p><p>å®šä¸€ä¸ªNFSç±»å‹çš„PVï¼Œå£°æ˜éœ€è¦10Giå­˜å‚¨ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pv01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/somepath</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">127.17</span><span class="number">.0</span><span class="number">.2</span></span><br></pre></td></tr></table></figure><p></p><p>è¯¥PVå£°æ˜äº†127.17.0.2NFSç³»ç»Ÿä¸‹çš„/somepathç›®å½•ä½œä¸ºç½‘ç»œå­˜å‚¨ï¼Œå†…å­˜ä¸º10Giï¼Œè¯¥PVåç§°ä¸ºpv01ã€‚</p><p>accessModesæœ‰ä»¥ä¸‹ä¸‰ç§æ¨¡å¼ï¼š</p><ol><li>ReadWriteOnceï¼šè¯»å†™æƒé™ï¼Œå¹¶ä¸”åªèƒ½è¢«å•ä¸ªNodeæŒ‚è½½ï¼›</li><li>ReadOnlyManyï¼šåªè¯»æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½ï¼›</li><li>ReadWriteManyï¼šè¯»å†™æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½ã€‚</li></ol><p>æ¥ç€å®šä¹‰ä¸€ä¸ªPVCï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pvclaim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">8</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure><p></p><p>è¯¥PVCå£°æ˜äº†éœ€è¦8Giå­˜å‚¨ç©ºé—´ï¼Œåˆšåˆšå®šä¹‰çš„PVç¬¦åˆè¿™ä¸ªè¦æ±‚ï¼Œæ‰€ä»¥ä¼šè¢«ç»‘å®šä¸Šã€‚å®šä¹‰äº†PVCåï¼Œå°±å¯ä»¥åœ¨Podé‡Œå¼•ç”¨äº†ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">podpv</span></span><br><span class="line"><span class="attr">      persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">        claimName:</span> <span class="string">pvclaim</span></span><br></pre></td></tr></table></figure><p></p><p>PVå…·æœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š</p><ol><li>Availableï¼šç©ºé—²çŠ¶æ€ï¼›</li><li>Boundï¼šå·²ç»ç»‘å®šåˆ°æŸä¸ªPVCä¸Šï¼›</li><li>Releasedï¼šå¯¹åº”çš„PVCå·²ç»è¢«åˆ é™¤ï¼Œä½†èµ„æºè¿˜æ²¡æœ‰è¢«é›†ç¾¤æ”¶å›ï¼›</li><li>Failedï¼šPVè‡ªåŠ¨å›æ”¶å¤±è´¥ã€‚</li></ol><h2 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h2><p>Namespaceé¡¾åæ€ä¹‰ï¼Œå‘½åç©ºé—´ï¼Œç”¨äºèµ„æºéš”ç¦»ã€‚é»˜è®¤Kubernetesä¼šåˆ›å»ºdefaultå‘½åç©ºé—´ï¼Œå¹¶ä¸”Podï¼ŒRCç­‰éƒ½æ˜¯ç”¨è¯¥å‘½åç©ºé—´ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å®šä¹‰è‡ªå·±çš„å‘½åç©ºé—´ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">febs</span></span><br></pre></td></tr></table></figure><p></p><p>åœ¨åˆ›å»ºPodç­‰èµ„æºçš„æ—¶å€™å°±å¯ä»¥æŒ‡å®šè¯¥å‘½åç©ºé—´äº†ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-pod</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">febs</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><p></p><h2 id="Annotation"><a href="#Annotation" class="headerlink" title="Annotation"></a>Annotation</h2><p>Annotationæ˜¯ç”¨æˆ·ä»»æ„å®šä¹‰çš„é™„åŠ ä¿¡æ¯ï¼Œä¾¿äºå¤–éƒ¨å·¥å…·æŸ¥æ‰¾ï¼Œæ¯”å¦‚ç‰ˆæœ¬ä¿¡æ¯ï¼Œbuildä¿¡æ¯ç­‰ã€‚</p><h2 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h2><p>å­¦è¿‡Dockerçš„éƒ½çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŒ‚è½½ç›®å½•çš„æ–¹å¼å°†å®¿ä¸»æœºä¸­çš„é…ç½®æ–‡ä»¶æ˜ å°„åˆ°Dockerå®¹å™¨å†…ã€‚ä½†è¿™åœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œè¦æŒ‚è½½çš„é…ç½®æ–‡ä»¶è¿‡å¤šï¼Œä¸ä»…éº»çƒ¦è€Œä¸”å®¹æ˜“å‡ºé”™ï¼ŒKuberneteçš„ConfigMapå°±æ˜¯ç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚</p><p>ConfigMapå­˜å‚¨äº†å¤§é‡key-valueé…ç½®ï¼Œå­˜å‚¨åœ¨etcdä¸­ï¼Œé€šè¿‡Volumeçš„æ–¹å¼æ˜ å°„åˆ°ç›®æ ‡Podå†…ï¼Œæˆä¸ºä¸€ä»½é…ç½®æ–‡ä»¶ï¼ŒConfigMapå®è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªé…ç½®ä¸­å¿ƒã€‚</p><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»æˆåŠŸæ­å»ºäº†Kubernetesé›†ç¾¤ï¼ŒKubernetesåŒ…å«äº†å¤§é‡çš„æ¦‚å¿µå’Œæœ¯è¯­ï¼Œæ¯”å¦‚Masterã€Nodeã€Podã€Replication Controllerã€Serviceç­‰ç­‰ï¼Œåœ¨æ·±å…¥å­¦ä¹ Kubernetesä¹‹å‰ï¼Œæœ‰å¿…è¦æ‹æ¸…Kubernetesæ¶æ„è®¾è®¡å’Œè¿™äº›æœ¯è¯­çš„å«ä¹‰ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes1.16.2å®‰è£…Dashboard</title>
    <link href="http://mrbird.cc/Kubernetes1-16-2-install-Dashboard.html"/>
    <id>http://mrbird.cc/Kubernetes1-16-2-install-Dashboard.html</id>
    <published>2019-10-29T07:38:24.000Z</published>
    <updated>2020-01-21T03:30:03.136Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>Kubernetes Dashboardæ˜¯Kubernetesæä¾›çš„Webç”¨æˆ·ç•Œé¢ï¼Œé€šè¿‡Dashboardæˆ‘ä»¬å¯ä»¥å°†å®¹å™¨åŒ–çš„åº”ç”¨éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ä¸­ï¼Œå¯¹å®¹å™¨åŒ–çš„åº”ç”¨è¿›è¡Œæ•…éšœæ’é™¤ä»¥åŠé›†ç¾¤èµ„æºç®¡ç†ï¼›å¯ä»¥é€šè¿‡DashboardæŸ¥çœ‹é›†ç¾¤åº”ç”¨è¯¦æƒ…ï¼Œåˆ›å»ºæˆ–ä¿®æ”¹å•ä¸ªKubernetesèµ„æºï¼ˆä¾‹å¦‚Deploymentsï¼ŒJobsï¼ŒDaemonSetsç­‰ï¼‰ã€‚<a id="more"></a></p><h2 id="å®‰è£…Dashboard"><a href="#å®‰è£…Dashboard" class="headerlink" title="å®‰è£…Dashboard"></a>å®‰è£…Dashboard</h2><p>ä¸ŠèŠ‚æˆ‘ä»¬æ­å»ºçš„Kubernetesé›†ç¾¤ç‰ˆæœ¬ä¸º1.16.2ï¼Œæˆªè‡³ç›®å‰ä¸ºæ­¢ï¼Œä¸è¯¥ç‰ˆæœ¬å¯¹åº”çš„Dashboardç‰ˆæœ¬ä¸ºv2.0.0-beta5ï¼Œå¯ä»¥é€šè¿‡<a href="https://github.com/kubernetes/dashboard/releases" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/releases</a>æŸ¥çœ‹ï¼š</p><p><img src="img/QQæˆªå›¾20191029210946.png" alt="QQæˆªå›¾20191029210946.png"></p><p>ä¸‹è½½è¯¥ç‰ˆæœ¬çš„Dashboard yamlæ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta5/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹è¯¥é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim recommended.yaml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹çš„å†…å®¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191029211413.png" alt="QQæˆªå›¾20191029211413.png"></p><p>æ¥ç€åˆ›å»ºè¯ä¹¦ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mkdir dashboard-certs</span><br><span class="line"></span><br><span class="line">cd dashboard-certs/</span><br><span class="line"></span><br><span class="line">#åˆ›å»ºå‘½åç©ºé—´</span><br><span class="line">kubectl create namespace kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">#åˆ›å»ºkeyæ–‡ä»¶</span><br><span class="line">openssl genrsa -out dashboard.key 2048</span><br><span class="line"></span><br><span class="line">#è¯ä¹¦è¯·æ±‚</span><br><span class="line">openssl req -days 36000 -new -out dashboard.csr -key dashboard.key -subj &apos;/CN=dashboard-cert&apos;</span><br><span class="line"></span><br><span class="line">#è‡ªç­¾è¯ä¹¦</span><br><span class="line">openssl x509 -req -in dashboard.csr -signkey dashboard.key -out dashboard.crt</span><br><span class="line"></span><br><span class="line">#åˆ›å»ºkubernetes-dashboard-certså¯¹è±¡</span><br><span class="line">kubectl create secret generic kubernetes-dashboard-certs --from-file=dashboard.key --from-file=dashboard.crt -n kubernetes-dashboard</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åæ‰§è¡Œ<code>kubectl create -f ../recommended.yaml</code>å‘½ä»¤å®‰è£…Dashboardã€‚</p><p>ä½¿ç”¨<code>kubectl get service -n kubernetes-dashboard -o wide</code>å‘½ä»¤æŸ¥çœ‹æ˜¯å¦éƒ¨ç½²æˆåŠŸï¼š</p><p><img src="img/QQæˆªå›¾20191029211919.png" alt="QQæˆªå›¾20191029211919.png"></p><h2 id="åˆ›å»ºè´¦å·ä¸æˆæƒ"><a href="#åˆ›å»ºè´¦å·ä¸æˆæƒ" class="headerlink" title="åˆ›å»ºè´¦å·ä¸æˆæƒ"></a>åˆ›å»ºè´¦å·ä¸æˆæƒ</h2><p>Dashboardéƒ¨ç½²å¥½åï¼Œæ¥ç€åˆ›å»ºè´¦å·ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim dashboard-admin.yaml</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dashboard-admin</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥è´¦å·ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f dashboard-admin.yaml</span><br></pre></td></tr></table></figure><p></p><p>è´¦å·åˆ›å»ºå¥½åï¼Œæ¥ç€ä¸ºå…¶æˆæƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim dashboard-admin-bind-cluster-role.yaml</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dashboard-admin-bind-cluster-role</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dashboard-admin</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure><p></p><p>æˆæƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f dashboard-admin-bind-cluster-role.yaml</span><br></pre></td></tr></table></figure><p></p><h2 id="è®¿é—®Dashboard"><a href="#è®¿é—®Dashboard" class="headerlink" title="è®¿é—®Dashboard"></a>è®¿é—®Dashboard</h2><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="https://192.168.33.12:30008/#/login" target="_blank" rel="noopener">https://192.168.33.12:30008/#/login</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191029222406.png" alt="QQæˆªå›¾20191029222406.png"></p><p>é€‰æ‹©Tokenï¼ŒTokençš„å€¼å¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤è·å–ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep dashboard-admin | awk &apos;&#123;print $1&#125;&apos;)</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191029222542.png" alt="QQæˆªå›¾20191029222542.png"></p><p>å¤åˆ¶è¯¥Tokenåˆ°Dashboardï¼š</p><p><img src="img/QQæˆªå›¾20191029222651.png" alt="QQæˆªå›¾20191029222651.png"></p><p>ç‚¹å‡»Sign Inï¼š</p><p><img src="img/QQæˆªå›¾20191029222743.png" alt="QQæˆªå›¾20191029222743.png"></p><h2 id="å®‰è£…Metrics-Service"><a href="#å®‰è£…Metrics-Service" class="headerlink" title="å®‰è£…Metrics Service"></a>å®‰è£…Metrics Service</h2><p>ä¸Šé¢Dashboardçš„CPU Usage (cores)å’ŒMemory Usage (bytes)åˆ—æ˜¯ç©ºçš„ï¼Œè¿™æ˜¯å› ä¸ºKubernetesçš„æ—©æœŸç‰ˆæœ¬ä¾é Heapsteræ¥å®ç°å®Œæ•´çš„æ€§èƒ½æ•°æ®é‡‡é›†å’Œç›‘æ§åŠŸèƒ½ï¼ŒKubernetesä»1.8ç‰ˆæœ¬å¼€å§‹ï¼Œæ€§èƒ½æ•°æ®å¼€å§‹ä»¥Metrics APIçš„æ–¹å¼æä¾›æ ‡å‡†åŒ–æ¥å£ï¼Œå¹¶ä¸”ä»1.10ç‰ˆæœ¬å¼€å§‹å°†Heapsteræ›¿æ¢ä¸ºMetrics Serverã€‚</p><p>é¦–å…ˆåœ¨masterèŠ‚ç‚¹ä¸Šå®‰è£…gitï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install git</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åå…‹éš†Metrics Server GitHubä»“åº“ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/kubernetes-sigs/metrics-server.git</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹metrics-server-deployment.yamlï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim metrics-server/deploy/1.8+/metrics-server-deployment.yaml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹å†…å®¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191108195559.png" alt="QQæˆªå›¾20191108195559.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">          - /metrics-server</span><br><span class="line">          - --kubelet-preferred-address-types=InternalIP</span><br><span class="line">          - --kubelet-insecure-tls</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å› ä¸ºé»˜è®¤metrics serviceçš„é•œåƒåœ°å€éœ€è¦ç§‘å­¦ä¸Šç½‘æ‰èƒ½æ‹‰å–ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºä¹‹å‰ï¼Œæˆ‘ä»¬åœ¨node1å’Œnode2èŠ‚ç‚¹å…ˆæ‰§è¡Œä»¥ä¸‹æ“ä½œå‡†å¤‡é•œåƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull bluersw/metrics-server-amd64:v0.3.6</span><br><span class="line">docker tag bluersw/metrics-server-amd64:v0.3.6 k8s.gcr.io/metrics-server-amd64:v0.3.6</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åå›åˆ°masterèŠ‚ç‚¹ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f metrics-server/deploy/1.8+/</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191108195421.png" alt="QQæˆªå›¾20191108195421.png"></p><p>ç¨ç­‰ç‰‡åˆ»ï¼Œç„¶åæ‰§è¡Œ<code>kubectl top nodes</code>ä¾¿å¯ä»¥çœ‹åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„CPUå’Œå†…å­˜ä½¿ç”¨ç‡äº†ï¼š</p><p><img src="img/QQæˆªå›¾20191108195522.png" alt="QQæˆªå›¾20191108195522.png"></p><p>å›åˆ°Dashboardï¼š</p><p><img src="img/QQæˆªå›¾20191108200314.png" alt="QQæˆªå›¾20191108200314.png"></p><p><img src="img/QQæˆªå›¾2019102ddd9202540.png" alt="QQæˆªå›¾2019102ddd9202540.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Kubernetes Dashboardæ˜¯Kubernetesæä¾›çš„Webç”¨æˆ·ç•Œé¢ï¼Œé€šè¿‡Dashboardæˆ‘ä»¬å¯ä»¥å°†å®¹å™¨åŒ–çš„åº”ç”¨éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ä¸­ï¼Œå¯¹å®¹å™¨åŒ–çš„åº”ç”¨è¿›è¡Œæ•…éšœæ’é™¤ä»¥åŠé›†ç¾¤èµ„æºç®¡ç†ï¼›å¯ä»¥é€šè¿‡DashboardæŸ¥çœ‹é›†ç¾¤åº”ç”¨è¯¦æƒ…ï¼Œåˆ›å»ºæˆ–ä¿®æ”¹å•ä¸ªKubernetesèµ„æºï¼ˆä¾‹å¦‚Deploymentsï¼ŒJobsï¼ŒDaemonSetsç­‰ï¼‰ã€‚
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubeadmå®‰è£…Kubernetes1.16.2é›†ç¾¤</title>
    <link href="http://mrbird.cc/Kubeadm-install-Kubernetes1-16-2-cluster.html"/>
    <id>http://mrbird.cc/Kubeadm-install-Kubernetes1-16-2-cluster.html</id>
    <published>2019-10-28T12:49:50.000Z</published>
    <updated>2020-01-21T03:30:03.134Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --><p>Kubernetesä»1.4ç‰ˆæœ¬å¼€å§‹åå°±å¼•å…¥äº†kubeadmç”¨äºç®€åŒ–é›†ç¾¤æ­å»ºçš„è¿‡ç¨‹ï¼Œåœ¨Kubernetes 1.13ç‰ˆæœ¬ä¸­ï¼Œkubeadmå·¥å…·è¿›å…¥GAé˜¶æ®µï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒKubernetesé›†ç¾¤æ­å»ºã€‚æœ¬èŠ‚å°†ä½¿ç”¨Kubeadmæ­å»ºKubernetes1.16.2é›†ç¾¤ï¼Œå®¿ä¸»æœºé‡‡ç”¨3å°Vagrantæ„å»ºçš„Centos7è™šæ‹Ÿæœºï¼Œé…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼ˆKubernetesæ¨èå®¿ä¸»æœºæœ€ä½å†…å­˜ä¸èƒ½ä½äº2Gï¼ŒCPUæ ¸å¿ƒæ•°æœ€ä½ä¸èƒ½ä½äº2ï¼‰ï¼š<a id="more"></a></p><table><thead><tr><th style="text-align:center">æ“ä½œç³»ç»Ÿ</th><th style="text-align:center">IP</th><th style="text-align:center">è§’è‰²</th><th style="text-align:center">CPUæ ¸å¿ƒæ•°</th><th style="text-align:center">å†…å­˜</th><th style="text-align:center">Hostname</th></tr></thead><tbody><tr><td style="text-align:center">centos7</td><td style="text-align:center">192.168.33.11</td><td style="text-align:center">master</td><td style="text-align:center">2</td><td style="text-align:center">4096M</td><td style="text-align:center">master</td></tr><tr><td style="text-align:center">centos7</td><td style="text-align:center">192.168.33.12</td><td style="text-align:center">worker</td><td style="text-align:center">2</td><td style="text-align:center">4096M</td><td style="text-align:center">node1</td></tr><tr><td style="text-align:center">centos7</td><td style="text-align:center">192.168.33.13</td><td style="text-align:center">worker</td><td style="text-align:center">2</td><td style="text-align:center">4096M</td><td style="text-align:center">node2</td></tr></tbody></table><p>åˆ†äº«ä¸‹æˆ‘çš„Vagrantfileé…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Vagrant.configure("2")</span> <span class="string">do</span> <span class="string">|config|</span></span><br><span class="line">  <span class="string">config.vm.box</span> <span class="string">=</span> <span class="string">"centos/7"</span></span><br><span class="line">  <span class="string">config.vm.define</span> <span class="string">"one"</span> <span class="string">do</span> <span class="string">|one|</span></span><br><span class="line">  	<span class="string">one.vm.network</span> <span class="string">"private_network"</span><span class="string">,</span> <span class="attr">ip:</span> <span class="string">"192.168.33.11"</span></span><br><span class="line">  	<span class="string">one.vm.hostname</span> <span class="string">=</span> <span class="string">"master"</span></span><br><span class="line">  	<span class="string">one.vm.provider</span> <span class="string">"virtualbox"</span> <span class="string">do</span> <span class="string">|v|</span></span><br><span class="line">	  <span class="string">v.memory</span> <span class="string">=</span> <span class="number">4096</span></span><br><span class="line">	  <span class="string">v.cpus</span> <span class="string">=</span> <span class="number">2</span></span><br><span class="line">	<span class="string">end</span></span><br><span class="line">  <span class="string">end</span></span><br><span class="line"></span><br><span class="line">  <span class="string">config.vm.define</span> <span class="string">"two"</span> <span class="string">do</span> <span class="string">|two|</span></span><br><span class="line">  	<span class="string">two.vm.network</span> <span class="string">"private_network"</span><span class="string">,</span> <span class="attr">ip:</span> <span class="string">"192.168.33.12"</span></span><br><span class="line">  	<span class="string">two.vm.hostname</span> <span class="string">=</span> <span class="string">"node1"</span></span><br><span class="line">  	<span class="string">two.vm.provider</span> <span class="string">"virtualbox"</span> <span class="string">do</span> <span class="string">|v|</span></span><br><span class="line">	  <span class="string">v.memory</span> <span class="string">=</span> <span class="number">4096</span></span><br><span class="line">	  <span class="string">v.cpus</span> <span class="string">=</span> <span class="number">2</span></span><br><span class="line">	<span class="string">end</span></span><br><span class="line">  <span class="string">end</span></span><br><span class="line"></span><br><span class="line">  <span class="string">config.vm.define</span> <span class="string">"three"</span> <span class="string">do</span> <span class="string">|three|</span></span><br><span class="line">  	<span class="string">three.vm.network</span> <span class="string">"private_network"</span><span class="string">,</span> <span class="attr">ip:</span> <span class="string">"192.168.33.13"</span></span><br><span class="line">  	<span class="string">three.vm.hostname</span> <span class="string">=</span> <span class="string">"node2"</span></span><br><span class="line">  	<span class="string">three.vm.provider</span> <span class="string">"virtualbox"</span> <span class="string">do</span> <span class="string">|v|</span></span><br><span class="line">	  <span class="string">v.memory</span> <span class="string">=</span> <span class="number">4096</span></span><br><span class="line">	  <span class="string">v.cpus</span> <span class="string">=</span> <span class="number">2</span></span><br><span class="line">	<span class="string">end</span></span><br><span class="line">  <span class="string">end</span></span><br><span class="line"><span class="string">end</span></span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨åå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/12341234.png" alt="QQæˆªå›¾20191028210242.png"></p><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p><span style="color:red;font-weight:600">ä¸‹é¢è¿™äº›å‡†å¤‡å·¥ä½œåˆ†åˆ«åœ¨3å°æœºå™¨ä¸Šä½¿ç”¨rootè´¦å·æ“ä½œï¼š</span></p><p><strong>1.å®‰è£…å¿…è¦è½¯ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y net-tools.x86_64 vim wget</span><br></pre></td></tr></table></figure><p></p><p><strong>2.é…ç½®hostsï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.33.11 master</span><br><span class="line">192.168.33.12 node1</span><br><span class="line">192.168.33.13 node2</span><br></pre></td></tr></table></figure><p></p><p><strong>3.å…³é—­é˜²ç«å¢™ï¼š</strong></p><p>ä¸ºäº†é¿å…kubernetesçš„MasterèŠ‚ç‚¹å’Œå„ä¸ªå·¥ä½œèŠ‚ç‚¹çš„NodeèŠ‚ç‚¹é—´çš„é€šä¿¡å‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å…³é—­æœ¬åœ°æ­å»ºçš„Centosè™šæ‹Ÿæœºçš„é˜²ç«å¢™ã€‚ç”Ÿäº§ç¯å¢ƒæ¨èçš„åšæ³•æ˜¯åœ¨é˜²ç«å¢™ä¸Šé…ç½®å„ä¸ªç»„ä»¶éœ€è¦ç›¸äº’é€šä¿¡çš„ç«¯å£ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure><p></p><p><strong>4.ç¦ç”¨SELinuxï¼Œè®©å®¹å™¨å¯ä»¥é¡ºåˆ©åœ°è¯»å–ä¸»æœºæ–‡ä»¶ç³»ç»Ÿï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/^SELINUX=enforcing$/SELINUX=disabled/&apos; /etc/selinux/config</span><br></pre></td></tr></table></figure><p><strong>5.å®‰è£…18.09ç‰ˆæœ¬çš„dockerï¼š</strong></p><p>å› ä¸ºæœ¬èŠ‚éœ€è¦å®‰è£…çš„kubernetesé›†ç¾¤ç‰ˆæœ¬ä¸º1.16.2ï¼Œè€Œè¯¥ç‰ˆæœ¬çš„kubernetesæœ€é«˜æ”¯æŒçš„dockerç‰ˆæœ¬ä¸º18.09ã€‚å¯ä»¥é€šè¿‡è¯¥åœ°å€æŸ¥çœ‹kuberneteså’Œdockerçš„ç‰ˆæœ¬å¯¹åº”å…³ç³»ï¼š<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.16.md#downloads-for-v1160" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.16.md#downloads-for-v1160</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191028211129.png" alt="QQæˆªå›¾20191028211129.png"></p><p>å®‰è£…å¿…è¦ä¾èµ–:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br></pre></td></tr></table></figure><p></p><p>æ·»åŠ dockerç¨³å®šç‰ˆä»“åº“ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><p></p><p>å®‰è£…18.09ç‰ˆæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce-18.09.0 docker-ce-cli-18.09.0 containerd.io</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨dockerï¼Œå¹¶è®¾ç½®å¼€æœºè‡ªå¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker &amp;&amp; systemctl start docker</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹/etc/docker/daemon.jsonæ–‡ä»¶:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é‡å¯dockerï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p></p><p><strong>6.å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">   net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">   net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl --system</span><br></pre></td></tr></table></figure><p><strong>7.å…³é—­swap</strong></p><p>Swapæ˜¯æ“ä½œç³»ç»Ÿåœ¨å†…å­˜åƒç´§çš„æƒ…å†µç”³è¯·çš„è™šæ‹Ÿå†…å­˜ï¼ŒæŒ‰ç…§Kuberneteså®˜ç½‘çš„è¯´æ³•ï¼ŒSwapä¼šå¯¹Kubernetesçš„æ€§èƒ½é€ æˆå½±å“ï¼Œä¸æ¨èä½¿ç”¨Swapã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br></pre></td></tr></table></figure><p></p><h2 id="å®‰è£…Master"><a href="#å®‰è£…Master" class="headerlink" title="å®‰è£…Master"></a>å®‰è£…Master</h2><p>å‡†å¤‡å·¥ä½œå®Œæ¯•åï¼Œæ¥ç€å¼€å§‹åœ¨192.168.33.11 Masterè™šæ‹Ÿæœºä¸Šå®‰è£…Kubernetes Masterã€‚</p><p><strong>1.é…ç½®å›½å†…çš„kubernetesæºï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line"></span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p></p><p><strong>2.å®‰è£…kubeletã€kubeadmå’Œkubectlå·¥å…·ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure><p></p><p><strong>3.å¯åŠ¨kubeletå¹¶è®¾ç½®å¼€æœºè‡ªå¯ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure><p></p><p><strong>4.ä½¿ç”¨ä¸‹é¢è¿™æ¡å‘½ä»¤å¯åŠ¨masterï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --kubernetes-version=v1.16.2 \</span><br><span class="line">--pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">--service-cidr=10.1.0.0/16 \</span><br><span class="line">--apiserver-advertise-address=192.168.33.11 \</span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers</span><br></pre></td></tr></table></figure><p></p><p>é…ç½®å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>kubernetes-version: ç”¨äºæŒ‡å®šk8sç‰ˆæœ¬ï¼Œè¿™é‡ŒæŒ‡å®šä¸ºæœ€æ–°çš„1.16.2ç‰ˆæœ¬ï¼›</li><li>apiserver-advertise-addressï¼šç”¨äºæŒ‡å®škube-apiserverç›‘å¬çš„ipåœ°å€ï¼Œå°±æ˜¯masteræœ¬æœºIPåœ°å€ã€‚</li><li>pod-network-cidrï¼šå› ä¸ºåé¢æˆ‘ä»¬é€‰æ‹©flannelä½œä¸ºPodçš„ç½‘ç»œæ’ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æŒ‡å®šPodçš„ç½‘ç»œèŒƒå›´ä¸º10.244.0.0/16</li><li>service-cidrï¼šç”¨äºæŒ‡å®šSVCçš„ç½‘ç»œèŒƒå›´ï¼›</li><li>image-repository: å…¶ä¸­é»˜è®¤çš„é•œåƒä»“åº“k8s.gcr.ioæ²¡æœ‰ç§‘å­¦ä¸Šç½‘çš„è¯æ— æ³•è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä¿®æ”¹ä¸ºå›½å†…çš„é˜¿é‡Œé•œåƒä»“åº“registry.aliyuncs.com/google_containers</li></ul><p>å¯åŠ¨æ—¶ï¼Œéœ€è¦æ‹‰å–é•œåƒï¼Œè¿‡ç¨‹æ¯”è¾ƒç¼“æ…¢è€å¿ƒç­‰å¾…å³å¯ã€‚å¦‚æœä½ æƒ³å…ˆæ‹‰å¥½é•œåƒå†å¯åŠ¨ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>kubeadm config images list</code>å‘½ä»¤åˆ—å‡ºéœ€è¦æ‹‰å–çš„é•œåƒã€‚</p><p>å¯åŠ¨æˆåŠŸåï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹æç¤º:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.33.11:6443 --token yf7sct.o63ceq25gxdu71cd \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:bcd15ddd7432d393d3831c75ac7673f582d4e9895ff2c579c3f545d2a5d3026e</span><br></pre></td></tr></table></figure><p></p><p>æ„æ€æ˜¯ï¼Œå¦‚æœä½ æƒ³è¦érootç”¨æˆ·ä¹Ÿèƒ½ä½¿ç”¨kubectlå‘½ä»¤çš„è¯ï¼Œéœ€è¦æ‰§è¡Œä¸‹é¢è¿™äº›æ“ä½œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure><p></p><p>è€Œå¦‚æœä½ æ˜¯rootç”¨æˆ·çš„è¯ï¼Œç›´æ¥è¿è¡Œä¸‹é¢è¿™æ®µå‘½ä»¤å³å¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export KUBECONFIG=/etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure><p></p><p>è€Œä¸‹é¢è¿™æ®µåˆ™æ˜¯ç”¨äºå·¥ä½œèŠ‚ç‚¹NodeåŠ å…¥Masteré›†ç¾¤ç”¨çš„ï¼Œåé¢ä¼šä½¿ç”¨åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.33.11:6443 --token yf7sct.o63ceq25gxdu71cd \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:bcd15ddd7432d393d3831c75ac7673f582d4e9895ff2c579c3f545d2a5d3026e</span><br></pre></td></tr></table></figure><p></p><h2 id="å®‰è£…NodeèŠ‚ç‚¹ï¼ŒåŠ å…¥é›†ç¾¤"><a href="#å®‰è£…NodeèŠ‚ç‚¹ï¼ŒåŠ å…¥é›†ç¾¤" class="headerlink" title="å®‰è£…NodeèŠ‚ç‚¹ï¼ŒåŠ å…¥é›†ç¾¤"></a>å®‰è£…NodeèŠ‚ç‚¹ï¼ŒåŠ å…¥é›†ç¾¤</h2><p>æ¥ç€åœ¨192.168.33.12å’Œ192.168.33.13è™šæ‹Ÿæœºä¸Šæ“ä½œã€‚</p><p>å’Œå®‰è£…Masteræ­¥éª¤ä¸€æ ·ï¼Œå…ˆå®‰è£…å¥½kubeadmç›¸å…³å·¥å…·ï¼Œç„¶åæ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤å°†NodeåŠ å…¥åˆ°é›†ç¾¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.33.11:6443 --token yf7sct.o63ceq25gxdu71cd \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:bcd15ddd7432d393d3831c75ac7673f582d4e9895ff2c579c3f545d2a5d3026e</span><br></pre></td></tr></table></figure><p></p><p>å½“è¾“å‡ºå¦‚ä¸‹å†…å®¹æ˜¯è¯´æ˜åŠ å…¥æˆåŠŸï¼š</p><p><img src="img/QQæˆªå›¾20191028215138.png" alt="QQæˆªå›¾20191028215138.png"></p><h2 id="å®‰è£…ç½‘ç»œæ’ä»¶"><a href="#å®‰è£…ç½‘ç»œæ’ä»¶" class="headerlink" title="å®‰è£…ç½‘ç»œæ’ä»¶"></a>å®‰è£…ç½‘ç»œæ’ä»¶</h2><p>åœ¨Masterä¸Šæ‰§è¡Œkubectl get nodeså‘½ä»¤ï¼Œä¼šå‘ç°Kubernetesæç¤ºMasterä¸ºNotReadyçŠ¶æ€ï¼Œè¿™æ˜¯å› ä¸ºè¿˜æ²¡æœ‰å®‰è£…CNIç½‘ç»œæ’ä»¶ï¼š</p><p><img src="img/QQæˆªå›¾20191028215653.png" alt="QQæˆªå›¾20191028215653.png"></p><p>å¯¹äºCNIç½‘ç»œæ’ä»¶ï¼Œå¯ä»¥æœ‰è®¸å¤šé€‰æ‹©ï¼Œè¯·å‚è€ƒ<a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network</a>çš„è¯´æ˜ã€‚è¿™é‡Œæˆ‘é€‰æ‹©çš„flannelï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹kube-flannel.ymlï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kube-flannel.yml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹çš„åœ°æ–¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">containers:</span><br><span class="line">      - name: kube-flannel</span><br><span class="line">        image: quay.io/coreos/flannel:v0.11.0-amd64</span><br><span class="line">        command:</span><br><span class="line">        - /opt/bin/flanneld</span><br><span class="line">        args:</span><br><span class="line">        - --ip-masq</span><br><span class="line">        - --kube-subnet-mgr</span><br><span class="line">        - --iface=eth1 # æ–°å¢éƒ¨åˆ†</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p></p><p>Vagrant åœ¨å¤šä¸»æœºæ¨¡å¼ä¸‹æœ‰å¤šä¸ªç½‘å¡ï¼Œeth0 ç½‘å¡ç”¨äºnatè½¬å‘è®¿é—®å…¬ç½‘ï¼Œè€Œeth1ç½‘å¡æ‰æ˜¯ä¸»æœºçœŸæ­£çš„IPï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ç›´æ¥éƒ¨ç½²k8s flannel æ’ä»¶ä¼šå¯¼è‡´CoreDNSæ— æ³•å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸Šé¢è¿™æ¡é…ç½®å¼ºåˆ¶flannelä½¿ç”¨eth1ã€‚</p><p>å®‰è£…flannelï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kube-flannel.yml</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºæ—¶ï¼Œè¡¨ç¤ºå®‰è£…æˆåŠŸï¼š</p><p><img src="img/QQæˆªå›¾20191028215831.png" alt="QQæˆªå›¾20191028215831.png"></p><p>ç¨ç­‰ç‰‡åˆ»åï¼Œå†æ¬¡æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ï¼š</p><p><img src="img/QQæˆªå›¾20191028215910.png" alt="QQæˆªå›¾20191028215910.png"></p><p>å¯ä»¥çœ‹åˆ°æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ReadyçŠ¶æ€ã€‚</p><p>æ‰§è¡Œ<code>kubectl get pods --all-namespaces</code>ï¼ŒéªŒè¯Kubernetesé›†ç¾¤çš„ç›¸å…³Podæ˜¯å¦éƒ½æ­£å¸¸åˆ›å»ºå¹¶è¿è¡Œï¼š</p><p><img src="img/QQæˆªå›¾20191028220122.png" alt="QQæˆªå›¾20191028220122.png"></p><p>åˆ°è¿™é‡Œé€šè¿‡Kubeadmå®‰è£…Kubernetes 1.16.2é›†ç¾¤å·²ç»æˆåŠŸäº†ã€‚å¦‚æœå®‰è£…å¤±è´¥ï¼Œåˆ™å¯ä»¥æ‰§è¡Œ<code>kubeadm reset</code>å‘½ä»¤å°†ä¸»æœºæ¢å¤åŸçŠ¶ï¼Œé‡æ–°æ‰§è¡Œ<code>kubeadm init</code>å‘½ä»¤ï¼Œå†æ¬¡è¿›è¡Œå®‰è£…ã€‚</p><h2 id="å°è¯•ç‰›åˆ€"><a href="#å°è¯•ç‰›åˆ€" class="headerlink" title="å°è¯•ç‰›åˆ€"></a>å°è¯•ç‰›åˆ€</h2><p>ä¸ºäº†å¿«é€Ÿåœ°éªŒè¯ä¸€ä¸‹ä¸Šé¢æ­å»ºé›†ç¾¤æ˜¯å¦å¯ç”¨ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªNginx Deploymentï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx --image=nginx</span><br><span class="line"> </span><br><span class="line">kubectl expose deployment nginx --port=80 --type=NodePort</span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨å‘½ä»¤<code>kubectl get pod,svc</code>æŸ¥çœ‹æ˜¯å¦æ­£å¸¸ï¼š</p><p><img src="img/QQæˆªå›¾20191028221659.png" alt="QQæˆªå›¾20191028221659.png"></p><p>ä½¿ç”¨å‘½ä»¤<code>kubectl get pods,svc -o wide</code>æŸ¥çœ‹è¯¥Podå…·ä½“ä½äºå“ªä¸€ä¸ªèŠ‚ç‚¹ï¼š</p><p><img src="img/QQæˆªå›¾20191028221805.png" alt="QQæˆªå›¾20191028221805.png"></p><p>å¯ä»¥çœ‹åˆ°å…¶ä½äºNode2èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹IPä¸º192.168.33.13ï¼Œç«¯å£ä¸º30935ï¼Œä½¿ç”¨æµè§ˆå™¨è®¿é—®è¯¥åœ°å€ï¼š</p><p><img src="img/QQæˆªå›¾20191028221923.png" alt="QQæˆªå›¾20191028221923.png"></p><p>ä½¿ç”¨<code>kubectl get pods</code>å‘½ä»¤æŸ¥çœ‹Podçš„æƒ…å†µ:</p><p><img src="img/QQæˆªå›¾20191029202111.png" alt="QQæˆªå›¾20191029202111.png"></p><p>ä½¿ç”¨<code>kubectl delete</code>å‘½ä»¤åˆ é™¤è¿™ä¸ªPodçœ‹çœ‹ä¼šæ€æ ·ï¼š</p><p><img src="img/QQæˆªå›¾20191029202330.png" alt="QQæˆªå›¾20191029202330.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåˆšåˆšçš„åä¸ºxxxçš„Podå¤„äºTerminatingï¼ˆç»“æŸä¸­ï¼‰çš„çŠ¶æ€ï¼Œè€Œå¦ä¸€ä¸ªæ–°çš„åä¸ºxxxçš„Podæ­£å¤„äºContainerCreatingï¼ˆåˆ›å»ºä¸­ï¼‰çŠ¶æ€ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>replicas</code>çš„å€¼ä¸º1ï¼ŒKubernetesé›†ç¾¤ä¼šå§‹ç»ˆä¿æŒNginxçš„å®ä¾‹ä¸º1ã€‚</p><p>è¦åˆ é™¤Nginxå¯ä»¥é€šè¿‡åˆ é™¤deploymentæ¥å®Œæˆï¼Œä½¿ç”¨<code>kubectl get deployments</code>å‘½ä»¤æŸ¥çœ‹å½“å‰çš„deploymentï¼š</p><p><img src="img/QQæˆªå›¾20191029202412.png" alt="QQæˆªå›¾20191029202412.png"></p><p>ä½¿ç”¨å‘½ä»¤<code>kubectl delete deployment nginx</code>ï¼š</p><p><img src="img/QQæˆªå›¾20191029202439.png" alt="QQæˆªå›¾20191029202439.png"></p><p>å®é™…ä¸­æˆ‘ä»¬ä¸€èˆ¬é€šè¿‡ymlæˆ–è€…jsonæ–‡ä»¶æ¥åˆ›å»ºåº”ç”¨ï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ymlçš„æ–¹å¼åˆ›å»ºä¸€ä¸ª3å®ä¾‹çš„Nginxé›†ç¾¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx-rc.yml</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx-service.yml</span><br></pre></td></tr></table></figure><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€æ‰§è¡Œä¸‹é¢è¿™ä¸¤æ¡å‘½ä»¤å¯åŠ¨Nginxé›†ç¾¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx-rc.yml</span><br><span class="line">kubectl create -f nginx-service.yml</span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨<code>kubectl get pods</code>å‘½ä»¤æŸ¥çœ‹Podæƒ…å†µ:</p><p><img src="img/QQæˆªå›¾20191029202540.png" alt="QQæˆªå›¾20191029202540.png"></p><p>ä½¿ç”¨<code>kubectl get services</code>å‘½ä»¤æŸ¥çœ‹Serviceæƒ…å†µï¼š</p><p><img src="img/QQæˆªå›¾20191029202644.png" alt="QQæˆªå›¾20191029202644.png"></p><p>ä½¿ç”¨<code>kubectl describe svc nginx-service</code>å‘½ä»¤æŸ¥çœ‹Nginx Serviceè¯¦æƒ…ï¼š</p><p><img src="img/QQæˆªå›¾20191029202719.png" alt="QQæˆªå›¾20191029202719.png"></p><p>ä½¿ç”¨å‘½ä»¤<code>kubectl get pods,svc -o wide</code>æŸ¥çœ‹Nginx Podå…·ä½“ä½äºå“ªä¸€ä¸ªèŠ‚ç‚¹ï¼š</p><p><img src="img/QQæˆªå›¾20191029202746.png" alt="QQæˆªå›¾20191029202746.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨node1å’Œnode2èŠ‚ç‚¹ä¸Šéƒ½æœ‰Nginxçš„Podï¼Œä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="http://192.168.33.12:32631/" target="_blank" rel="noopener">http://192.168.33.12:32631/</a>æˆ–è€…<a href="http://192.168.33.13:32631/" target="_blank" rel="noopener">http://192.168.33.13:32631/</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191029202923.png" alt="QQæˆªå›¾20191029202923.png"></p><p>åˆ é™¤çš„è¯æ‰§è¡Œä¸‹é¢è¿™ä¸¤æ¡å‘½ä»¤å³å¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f nginx-service.yml</span><br><span class="line">kubectl delete -f nginx-rc.yml</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Fri Mar 06 2020 08:56:40 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Kubernetesä»1.4ç‰ˆæœ¬å¼€å§‹åå°±å¼•å…¥äº†kubeadmç”¨äºç®€åŒ–é›†ç¾¤æ­å»ºçš„è¿‡ç¨‹ï¼Œåœ¨Kubernetes 1.13ç‰ˆæœ¬ä¸­ï¼Œkubeadmå·¥å…·è¿›å…¥GAé˜¶æ®µï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒKubernetesé›†ç¾¤æ­å»ºã€‚æœ¬èŠ‚å°†ä½¿ç”¨Kubeadmæ­å»ºKubernetes1.16.2é›†ç¾¤ï¼Œå®¿ä¸»æœºé‡‡ç”¨3å°Vagrantæ„å»ºçš„Centos7è™šæ‹Ÿæœºï¼Œé…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼ˆKubernetesæ¨èå®¿ä¸»æœºæœ€ä½å†…å­˜ä¸èƒ½ä½äº2Gï¼ŒCPUæ ¸å¿ƒæ•°æœ€ä½ä¸èƒ½ä½äº2ï¼‰ï¼š
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
</feed>
