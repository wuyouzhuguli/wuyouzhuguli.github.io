<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>MrBird</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://mrbird.cc/"/>
  <updated>2020-01-21T10:30:56.818Z</updated>
  <id>http://mrbird.cc/</id>
  
  <author>
    <name>MrBird</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Spring Cloud å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹</title>
    <link href="http://mrbird.cc/book.html"/>
    <id>http://mrbird.cc/book.html</id>
    <published>2222-10-24T06:20:57.000Z</published>
    <updated>2020-01-21T10:30:56.818Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:56:00 GMT+0800 (GMT+08:00) --><p>ğŸ“–ã€Š<a href="https://www.kancloud.cn/mrbird/spring-cloud" target="_blank" rel="noopener"> Spring Cloud å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹ </a>ã€‹ä¸€æœ¬åŸºäºSpring Cloud Hoxton.RELEASE&amp;Spring Cloud Oauth2&amp;Spring Cloud Alibabaçš„å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹ä¹¦ç±ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ ä»é›¶åˆ°K8Sé›†ç¾¤éƒ¨ç½²ã€‚</p><a id="more"></a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263686" target="_blank" rel="noopener">ç¬¬ä¸€ç«  åŸºç¡€æ¡†æ¶æ­å»º</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263687" target="_blank" rel="noopener">1.1 æ¶æ„é¢„è§ˆ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263688" target="_blank" rel="noopener">1.2 æ­å»ºå¾®æœåŠ¡æ³¨å†Œä¸­å¿ƒ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263689" target="_blank" rel="noopener">1.3 æ­å»ºè®¤è¯æœåŠ¡å™¨</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263690" target="_blank" rel="noopener">1.4 æ­å»ºå¾®æœåŠ¡ç½‘å…³</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263691" target="_blank" rel="noopener">1.5 æ­å»ºå¾®æœåŠ¡æä¾›è€…ï¼ˆèµ„æºæœåŠ¡å™¨ï¼‰</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263692" target="_blank" rel="noopener">1.6 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263693" target="_blank" rel="noopener">ç¬¬äºŒç«  æ¶æ„å®Œå–„</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263694" target="_blank" rel="noopener">2.1 å‚æ•°é…ç½®åŒ–</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263695" target="_blank" rel="noopener">2.2 å¼‚å¸¸å¤„ç†</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263696" target="_blank" rel="noopener">2.3 Feignçš„ä½¿ç”¨</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263697" target="_blank" rel="noopener">2.4 å¾®æœåŠ¡é˜²æŠ¤</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263698" target="_blank" rel="noopener">2.5 è·¨åŸŸå¤„ç†</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263699" target="_blank" rel="noopener">2.6 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263700" target="_blank" rel="noopener">ç¬¬ä¸‰ç«  å®Œå–„ç™»å½•æµç¨‹</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263701" target="_blank" rel="noopener">3.1 è¡¨ç»“æ„è®¾è®¡</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263702" target="_blank" rel="noopener">3.2 å®Œå–„ç™»å½•</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263703" target="_blank" rel="noopener">3.3 æ•´åˆå›¾å½¢éªŒè¯ç </a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263704" target="_blank" rel="noopener">3.4 SentineléªŒè¯ç é™æµ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263705" target="_blank" rel="noopener">3.5 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263706" target="_blank" rel="noopener">ç¬¬å››ç«  æ•´åˆSwagger</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263707" target="_blank" rel="noopener">4.1 å®Œå–„febs-server-system</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263708" target="_blank" rel="noopener">4.2 æ¥å…¥Swagger</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263709" target="_blank" rel="noopener">4.3 Swagger OAuth2è®¤è¯</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263710" target="_blank" rel="noopener">4.4 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263711" target="_blank" rel="noopener">ç¬¬äº”ç«  æ•´åˆç¬¬ä¸‰æ–¹æœåŠ¡</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263712" target="_blank" rel="noopener">5.1 æ•´åˆSpring Boot Admin</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263713" target="_blank" rel="noopener">5.2 Sleuth Zipkiné“¾è·¯è¿½è¸ª</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263714" target="_blank" rel="noopener">5.3 logbackæ—¥å¿—æ‰“å°</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263715" target="_blank" rel="noopener">5.4 ELKæ—¥å¿—æ”¶é›†</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263716" target="_blank" rel="noopener">5.5 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263717" target="_blank" rel="noopener">ç¬¬å…­ç«  å‰ç«¯ç³»ç»Ÿä»‹ç»</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263718" target="_blank" rel="noopener">6.1 å°è£…Axios</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263719" target="_blank" rel="noopener">6.2 Vueå¯¼èˆªå®ˆå«</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263720" target="_blank" rel="noopener">6.3 åŠ¨æ€è·¯ç”±æ„å»º</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263721" target="_blank" rel="noopener">6.4 å¤„ç†ç”¨æˆ·ç™»å½•</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263722" target="_blank" rel="noopener">6.5 å¤„ç†ä»¤ç‰Œåˆ·æ–°</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263723" target="_blank" rel="noopener">6.6 è‡ªå®šä¹‰Vueæƒé™æŒ‡ä»¤</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263724" target="_blank" rel="noopener">6.7 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263725" target="_blank" rel="noopener">ç¬¬ä¸ƒç«  å¾®æœåŠ¡éƒ¨ç½²</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263726" target="_blank" rel="noopener">7.1 å¾®æœåŠ¡DokceråŒ–</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263727" target="_blank" rel="noopener">7.2 ä½¿ç”¨Docker Composeéƒ¨ç½²</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263728" target="_blank" rel="noopener">7.3 æœ¬ç« å°ç»“</a></li></ul></li><li><p><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263729" target="_blank" rel="noopener">ç¬¬å…«ç«  å¾®æœåŠ¡è¿›é˜¶</a></p><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1277531" target="_blank" rel="noopener">8.1 ä»¤ç‰Œå­˜å‚¨ç­–ç•¥</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263731" target="_blank" rel="noopener">8.2 ä½¿ç”¨Cloud Gatewayæ­å»ºç½‘å…³</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1271133" target="_blank" rel="noopener">8.3 ä½¿ç”¨Alibaba Nacosæ³¨å†Œä¸­å¿ƒ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1289434" target="_blank" rel="noopener">8.4 ä½¿ç”¨Alibaba Nacoså­˜å‚¨é…ç½®</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1333138" target="_blank" rel="noopener">8.5 æ¥å…¥Prometheus + Grafana</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1337996" target="_blank" rel="noopener">8.6 æ•´åˆskywalkingåˆ†å¸ƒå¼è¿½è¸ª</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1411735" target="_blank" rel="noopener">8.7 å‡çº§åˆ°Hoxton.RELEASE</a></li></ul></li><li><p><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426914" target="_blank" rel="noopener">ç¬¬ä¹ç«  K8Sé›†ç¾¤éƒ¨ç½²</a></p><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426916" target="_blank" rel="noopener">9.1 é›†ç¾¤ç¯å¢ƒå‡†å¤‡</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426917" target="_blank" rel="noopener">9.2 å®‰è£…ç¬¬ä¸‰æ–¹æœåŠ¡</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426918" target="_blank" rel="noopener">9.3 Kubeadmæ­å»ºK8S 1.16.2é›†ç¾¤</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426919" target="_blank" rel="noopener">9.4 NFSæœåŠ¡å™¨æ­å»º</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426920" target="_blank" rel="noopener">9.5 æ­å»ºDockeré•œåƒä»“åº“Harbor</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426921" target="_blank" rel="noopener">9.6 K8Sæ„å»ºé«˜å¯ç”¨Nacos</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426922" target="_blank" rel="noopener">9.7 K8Sæ„å»ºFEBS CloudæœåŠ¡é›†ç¾¤</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426923" target="_blank" rel="noopener">9.8 éƒ¨ç½²å‰ç«¯æµ‹è¯•</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426924" target="_blank" rel="noopener">9.9 K8Så®è·µæ€»ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456142" target="_blank" rel="noopener">ç¬¬åç«  åˆ†å¸ƒå¼äº‹åŠ¡ç ”ç©¶</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456143" target="_blank" rel="noopener">10.1 åˆ†å¸ƒå¼æ¶æ„äº‹åŠ¡æŒ‘æˆ˜</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456144" target="_blank" rel="noopener">10.2 åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456145" target="_blank" rel="noopener">10.3 åŸºäºæ¶ˆæ¯ä¸­é—´ä»¶RocketMQæ–¹æ¡ˆï¼ˆä¸€ï¼‰</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456146" target="_blank" rel="noopener">10.4 åŸºäºæ¶ˆæ¯ä¸­é—´ä»¶RocketMQæ–¹æ¡ˆï¼ˆäºŒï¼‰</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456147" target="_blank" rel="noopener">10.5 åŸºäºTX-LCNæ–¹æ¡ˆ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456148" target="_blank" rel="noopener">10.6 åŸºäºé˜¿é‡ŒSeataæ–¹æ¡ˆ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456149" target="_blank" rel="noopener">10.7 æœ¬ç« æ€»ç»“</a></li></ul></li></ul><script>$(function(){$("#comment-div").remove(),$(".post-copyright").remove(),$("#reward-div").remove(),$(".post-footer").remove()})</script><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:56:00 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;ğŸ“–ã€Š&lt;a href=&quot;https://www.kancloud.cn/mrbird/spring-cloud&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt; Spring Cloud å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹ &lt;/a&gt;ã€‹ä¸€æœ¬åŸºäºSpring Cloud Hoxton.RELEASE&amp;amp;Spring Cloud Oauth2&amp;amp;Spring Cloud Alibabaçš„å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹ä¹¦ç±ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ ä»é›¶åˆ°K8Sé›†ç¾¤éƒ¨ç½²ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Cloud" scheme="http://mrbird.cc/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Javaè®¾è®¡æ¨¡å¼å­¦ä¹ </title>
    <link href="http://mrbird.cc/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html"/>
    <id>http://mrbird.cc/Javaè®¾è®¡æ¨¡å¼.html</id>
    <published>2020-04-01T02:07:45.000Z</published>
    <updated>2020-08-03T00:55:25.747Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:56:01 GMT+0800 (GMT+08:00) --><p>ç®€å•è®°å½•Javaä¸­23ç§è®¾è®¡æ¨¡å¼çš„åº”ç”¨ï¼Œæ–¹ä¾¿åæœŸæŸ¥çœ‹ã€‚<a id="more"></a></p><h2 id="åˆ›å»ºå‹æ¨¡å¼"><a href="#åˆ›å»ºå‹æ¨¡å¼" class="headerlink" title="åˆ›å»ºå‹æ¨¡å¼"></a>åˆ›å»ºå‹æ¨¡å¼</h2><h3 id="ç®€å•å·¥å‚æ¨¡å¼"><a href="#ç®€å•å·¥å‚æ¨¡å¼" class="headerlink" title="ç®€å•å·¥å‚æ¨¡å¼"></a>ç®€å•å·¥å‚æ¨¡å¼</h3><p>ç®€å•å·¥å‚æ¨¡å¼ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´ï¼Œå¹¶ä¸å±äºè®¾è®¡æ¨¡å¼ä¸­çš„ä¸€ç§ï¼Œä¸è¿‡è¿™é‡Œè¿˜æ˜¯ç®€å•è®°å½•ä¸‹ã€‚</p><p><strong>å®šä¹‰</strong>ï¼šç”±ä¸€ä¸ªå·¥å‚å¯¹è±¡å†³å®šåˆ›å»ºå‡ºå“ªä¸€ç§ç±»å‹å®ä¾‹ã€‚å®¢æˆ·ç«¯åªéœ€ä¼ å…¥å·¥å‚ç±»çš„å‚æ•°ï¼Œæ— å¿ƒå…³å¿ƒåˆ›å»ºè¿‡ç¨‹ã€‚</p><p><strong>ä¼˜ç‚¹</strong>ï¼šå…·ä½“äº§å“ä»å®¢æˆ·ç«¯ä»£ç ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œè§£è€¦ã€‚</p><p><strong>ç¼ºç‚¹</strong>ï¼šå·¥å‚ç±»èŒè´£è¿‡é‡ï¼Œå¢åŠ æ–°çš„ç±»å‹æ—¶ï¼Œå¾—ä¿®æ”¹å·¥ç¨‹ç±»å¾—ä»£ç ï¼Œè¿èƒŒå¼€é—­åŸåˆ™ã€‚</p><p>ä¸¾ä¾‹ï¼šæ–°å»ºFruitæ°´æœæŠ½è±¡ç±»ï¼ŒåŒ…å«eatæŠ½è±¡æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Fruit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å…¶å®ç°ç±»Appleï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Apple</span> <span class="keyword">extends</span> <span class="title">Fruit</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åƒğŸ"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºåˆ›å»ºFruitçš„å·¥å‚ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Fruit <span class="title">produce</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"apple"</span>.equals(name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Apple();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºä¸ªå®¢æˆ·ç«¯æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        FruitFactory factory = <span class="keyword">new</span> FruitFactory();</span><br><span class="line">        Fruit fruit = factory.produce(<span class="string">"apple"</span>);</span><br><span class="line">        fruit.eat();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿è¡Œmainæ–¹æ³•ï¼Œè¾“å‡ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">åƒğŸ</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå®¢æˆ·ç«¯Applicationå¹¶æœªä¾èµ–å…·ä½“çš„æ°´æœç±»å‹ï¼Œåªå…³å¿ƒFruitFactoryçš„å…¥å‚ï¼Œè¿™å°±æ˜¯å®¢æˆ·ç«¯å’Œå…·ä½“äº§å“è§£è€¦çš„ä½“ç°ï¼ŒUMLå›¾å¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20191216103019.png" alt="QQæˆªå›¾20191216103019.png"></p><h3 id="å·¥å‚æ–¹æ³•æ¨¡å¼"><a href="#å·¥å‚æ–¹æ³•æ¨¡å¼" class="headerlink" title="å·¥å‚æ–¹æ³•æ¨¡å¼"></a>å·¥å‚æ–¹æ³•æ¨¡å¼</h3><p>ä¸ºäº†è§£å†³ç®€å•å·¥å‚æ¨¡å¼çš„ç¼ºç‚¹ï¼Œè¯ç”Ÿäº†å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory method patternï¼‰ã€‚</p><p><strong>å®šä¹‰</strong>ï¼šå®šä¹‰åˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å®ç°è¿™ä¸ªæ¥å£çš„ç±»æ¥å†³å®šå®ä¾‹åŒ–å“ªä¸ªç±»ï¼Œå·¥å‚æ–¹æ³•è®©ç±»çš„å®ä¾‹åŒ–æ¨è¿Ÿåˆ°äº†å­ç±»è¿›è¡Œã€‚</p><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ol><li><p>å…·ä½“äº§å“ä»å®¢æˆ·ç«¯ä»£ç ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œè§£è€¦ã€‚</p></li><li><p>åŠ å…¥æ–°çš„ç±»å‹æ—¶ï¼Œåªéœ€æ·»åŠ æ–°çš„å·¥å‚æ–¹æ³•ï¼ˆæ— éœ€ä¿®æ”¹æ—§çš„å·¥å‚æ–¹æ³•ä»£ç ï¼‰ï¼Œç¬¦åˆå¼€é—­åŸåˆ™ã€‚</p></li></ol><p><strong>ç¼ºç‚¹</strong>ï¼šç±»çš„ä¸ªæ•°å®¹æ˜“è¿‡å¤šï¼Œå¢åŠ å¤æ‚åº¦ã€‚</p><p>ä¸¾ä¾‹ï¼šæ–°å»ºFruitæŠ½è±¡ç±»ï¼ŒåŒ…å«eatæŠ½è±¡æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Fruit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºFruitFactoryæŠ½è±¡å·¥å‚ï¼Œå®šä¹‰produceFruitæŠ½è±¡æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Fruit <span class="title">produceFruit</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºFruitçš„å®ç°ç±»ï¼ŒAppleï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Apple</span> <span class="keyword">extends</span> <span class="title">Fruit</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åƒğŸ"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºFruitFactoryçš„å®ç°ç±»AppleFruitFactoryï¼Œç”¨äºç”Ÿäº§å…·ä½“ç±»å‹çš„æ°´æœ â€”â€” è‹¹æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppleFruitFactory</span> <span class="keyword">extends</span> <span class="title">FruitFactory</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Fruit <span class="title">produceFruit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Apple();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºå®¢æˆ·ç«¯Applicationæµ‹è¯•ä¸€æ³¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        FruitFactory factory = <span class="keyword">new</span> AppleFruitFactory();</span><br><span class="line">        Fruit fruit = factory.produceFruit();</span><br><span class="line">        fruit.eat();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿è¡Œmainæ–¹æ³•ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">åƒğŸ</span><br></pre></td></tr></table></figure><p></p><p>ç°åœ¨è¦æ–°å¢Bananaç±»å‹çš„æ°´æœï¼Œåªéœ€è¦æ–°å¢Bananaç±»å‹çš„å·¥å‚ç±»å³å¯ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰çš„AppleFruitFactoryä»£ç ï¼Œç¬¦åˆå¼€é—­åŸåˆ™ã€‚ä½†æ˜¯è¿™ç§æ¨¡å¼çš„ç¼ºç‚¹ä¹Ÿæ˜¾è€Œæ˜“è§ï¼Œå°±æ˜¯ç±»çš„ä¸ªæ•°å®¹æ˜“è¿‡å¤šï¼Œå¢åŠ å¤æ‚åº¦ã€‚</p><p>ä¸Šé¢ä¾‹å­UMLå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191216105317.png" alt="QQæˆªå›¾20191216105317.png"></p><h3 id="æŠ½è±¡å·¥å‚æ¨¡å¼"><a href="#æŠ½è±¡å·¥å‚æ¨¡å¼" class="headerlink" title="æŠ½è±¡å·¥å‚æ¨¡å¼"></a>æŠ½è±¡å·¥å‚æ¨¡å¼</h3><p>æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract factory patternï¼‰æä¾›äº†<strong>ä¸€ç³»åˆ—</strong>ç›¸å…³æˆ–è€…ç›¸äº’ä¾èµ–çš„å¯¹è±¡çš„æ¥å£ï¼Œå…³é”®å­—æ˜¯â€œä¸€ç³»åˆ—â€ã€‚</p><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ol><li><p>å…·ä½“äº§å“ä»å®¢æˆ·ç«¯ä»£ç ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œè§£è€¦ã€‚</p></li><li><p>å°†ä¸€ä¸ªç³»åˆ—çš„äº§å“æ—ç»Ÿä¸€åˆ°ä¸€èµ·åˆ›å»ºã€‚</p></li></ol><p><strong>ç¼ºç‚¹</strong>ï¼šæ‹“å±•æ–°çš„åŠŸèƒ½å›°éš¾ï¼Œéœ€è¦ä¿®æ”¹æŠ½è±¡å·¥å‚çš„æ¥å£ï¼›</p><p>ç»¼ä¸Šæ‰€è¿°ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼é€‚åˆé‚£äº›åŠŸèƒ½ç›¸å¯¹å›ºå®šçš„äº§å“æ—çš„åˆ›å»ºã€‚</p><p>ä¸¾ä¾‹ï¼šæ–°å»ºæ°´æœæŠ½è±¡ç±»Fruitï¼ŒåŒ…å«buyæŠ½è±¡æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Fruit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºä»·æ ¼æŠ½è±¡ç±»Priceï¼ŒåŒ…å«payæŠ½è±¡æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Price</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºæ°´æœåˆ›å»ºå·¥å‚æ¥å£FruitFactoryï¼ŒåŒ…å«è·å–æ°´æœå’Œä»·æ ¼æŠ½è±¡æ–¹æ³•ï¼ˆäº§å“æ—çš„ä½“ç°æ˜¯ï¼Œä¸€ç»„äº§å“åŒ…å«æ°´æœå’Œå¯¹åº”çš„ä»·æ ¼ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FruitFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Fruit <span class="title">getFruit</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">Price <span class="title">getPrice</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¥ä¸‹æ¥å¼€å§‹åˆ›å»ºğŸè¿™ä¸ªâ€œäº§å“æ—â€ã€‚æ–°å»ºFruitå®ç°ç±»AppleFruitï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppleFruit</span> <span class="keyword">extends</span> <span class="title">Fruit</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"è´­ä¹°ğŸ"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºå¯¹åº”çš„è‹¹æœä»·æ ¼å®ç°ApplePriceï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplePrice</span> <span class="keyword">extends</span> <span class="title">Price</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ğŸå•ä»·2å…ƒ"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºå®¢æˆ·ç«¯Applicationï¼Œæµ‹è¯•ä¸€æ³¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        FruitFactory factory = <span class="keyword">new</span> AppleFruitFactory();</span><br><span class="line">        factory.getFruit().buy();</span><br><span class="line">        factory.getPrice().pay();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è´­ä¹°ğŸ</span><br><span class="line">ğŸå•ä»·2å…ƒ</span><br></pre></td></tr></table></figure><p></p><p>å®¢æˆ·ç«¯åªéœ€è¦é€šè¿‡åˆ›å»ºAppleFruitFactoryå°±å¯ä»¥è·å¾—è‹¹æœè¿™ä¸ªäº§å“æ—çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬è‹¹æœå¯¹è±¡ï¼Œè‹¹æœä»·æ ¼ã€‚è¦æ–°å»ºğŸŒçš„äº§å“æ—ï¼Œåªéœ€è¦å®ç°FruitFactoryã€Priceå’ŒFruitæ¥å£å³å¯ã€‚è¿™ç§æ¨¡å¼çš„ç¼ºç‚¹å’Œå·¥å‚æ–¹æ³•å·®ä¸å¤šï¼Œå°±æ˜¯ç±»çš„ä¸ªæ•°å®¹æ˜“è¿‡å¤šï¼Œå¢åŠ å¤æ‚åº¦ã€‚</p><p>ä¸Šé¢ä¾‹å­UMLå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191216112922.png" alt="QQæˆªå›¾20191216112922.png"></p><h3 id="å»ºé€ è€…æ¨¡å¼"><a href="#å»ºé€ è€…æ¨¡å¼" class="headerlink" title="å»ºé€ è€…æ¨¡å¼"></a>å»ºé€ è€…æ¨¡å¼</h3><p>å»ºé€ è€…æ¨¡å¼ä¹Ÿç§°ä¸ºç”Ÿæˆå™¨æ¨¡å¼ï¼ˆBuilder Patternï¼‰ï¼Œå°†å¤æ‚å¯¹è±¡çš„å»ºé€ è¿‡ç¨‹æŠ½è±¡å‡ºæ¥ï¼ˆæŠ½è±¡ç±»åˆ«ï¼‰ï¼Œä½¿è¿™ä¸ªæŠ½è±¡è¿‡ç¨‹çš„ä¸åŒå®ç°æ–¹æ³•å¯ä»¥æ„é€ å‡ºä¸åŒè¡¨ç°ï¼ˆå±æ€§ï¼‰çš„å¯¹è±¡ã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼Œç›¸åŒçš„è¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„äº§å“ã€‚</p><p>å°†å¤æ‚å¯¹è±¡çš„å»ºé€ è¿‡ç¨‹æŠ½è±¡å‡ºæ¥ï¼ˆæŠ½è±¡ç±»åˆ«ï¼‰ï¼Œä½¿è¿™ä¸ªæŠ½è±¡è¿‡ç¨‹çš„ä¸åŒå®ç°æ–¹æ³•å¯ä»¥æ„é€ å‡ºä¸åŒè¡¨ç°ï¼ˆå±æ€§ï¼‰çš„å¯¹è±¡ã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯ï¼Œç›¸åŒçš„è¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„äº§å“ã€‚</p><p>é€‚ç”¨äºï¼š</p><ol><li>ä¸€ä¸ªå¯¹è±¡æœ‰éå¸¸å¤æ‚çš„å†…éƒ¨ç»“æ„ï¼ˆå¾ˆå¤šå±æ€§ï¼‰</li><li>æƒ³å°†å¤æ‚å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨åˆ†ç¦»ã€‚</li></ol><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ol><li>å°è£…æ€§å¥½ï¼Œåˆ›å»ºå’Œä½¿ç”¨åˆ†ç¦»</li><li>æ‹“å±•æ€§å¥½ï¼Œå»ºé€ ç±»ä¹‹é—´ç‹¬ç«‹ï¼Œä¸€å®šç¨‹åº¦ä¸Šè§£è€¦ã€‚</li></ol><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ol><li>äº§ç”Ÿå¤šä½™çš„Builderå¯¹è±¡ï¼›</li><li>äº§å“å†…éƒ¨å‘ç”Ÿå˜åŒ–ï¼Œå»ºé€ è€…éœ€è¦æ›´æ”¹ï¼Œæˆæœ¬è¾ƒå¤§ã€‚</li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p>æ–°å¢å•†é“ºç±»Shopï¼ŒåŒ…å«åç§°ï¼Œåœ°ç‚¹å’Œç±»å‹å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Shop</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String location;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Shop&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", location='"</span> + location + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", type='"</span> + type + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> location;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocation</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.location = location;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€åˆ›å»ºShopæŠ½è±¡ç”Ÿæˆå™¨ShopBuilderï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ShopBuilder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String location;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">name</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">location</span><span class="params">(String location)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">type</span><span class="params">(String type)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Shop <span class="title">build</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åŒ…å«å’ŒShopç›¸åŒçš„å±æ€§åŠå¯¹åº”çš„æŠ½è±¡æ„å»ºæ–¹æ³•ã€‚</p><p>ç»§ç»­åˆ›å»ºShopBuilderçš„å®ç°ï¼Œæ°´æœåº—æ„é€ å™¨FruitShopBuilderï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitShopBuilder</span> <span class="keyword">extends</span> <span class="title">ShopBuilder</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Shop shop = <span class="keyword">new</span> Shop();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">name</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.shop.setName(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">location</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.shop.setLocation(location);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">type</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.shop.setType(type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Shop <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºä¸ªç»é”€å•†ç±»Dealerï¼Œç”¨äºé€šè¿‡ShopBuilderæ„å»ºå…·ä½“çš„å•†åº—ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dealer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ShopBuilder builder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBuilder</span><span class="params">(ShopBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.builder = builder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Shop <span class="title">build</span><span class="params">(String name, String location, String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.builder.name(name);</span><br><span class="line">        <span class="keyword">this</span>.builder.location(location);</span><br><span class="line">        <span class="keyword">this</span>.builder.type(type);</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºä¸ªå®¢æˆ·ç«¯Applicationæµ‹è¯•ä¸€æ³¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ShopBuilder builder = <span class="keyword">new</span> FruitShopBuilder();</span><br><span class="line">        Dealer dealer = <span class="keyword">new</span> Dealer();</span><br><span class="line">        dealer.setBuilder(builder);</span><br><span class="line"></span><br><span class="line">        Shop shop = dealer.build(<span class="string">"XXæ°´æœåº—"</span>, <span class="string">"ç¦å·å¸‚XXåŒºXXè¡—XXå·"</span>, <span class="string">"æ°´æœç»è¥"</span>);</span><br><span class="line">        System.out.println(shop);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Shop&#123;name=&apos;XXæ°´æœåº—&apos;, location=&apos;ç¦å·å¸‚XXåŒºXXè¡—XXå·&apos;, type=&apos;æ°´æœç»è¥&apos;&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿™ä¸ªä¾‹å­æ˜¯å…¸å‹çš„å»ºé€ è€…æ¨¡å¼ï¼ŒUMLå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191216162813.png" alt="QQæˆªå›¾20191216162813.png"></p><p>å…¶å®å»ºé€ è€…æ¨¡å¼æ›´ä¸ºå¸¸ç”¨çš„ä¾‹å­æ˜¯ä¸‹é¢è¿™ä¸ªï¼š</p><p>åˆ›å»ºä¸€ä¸ªåº—é“ºç±»Shopï¼ŒShopé‡ŒåŒ…å«æ„é€ è¯¥Shopçš„å†…éƒ¨ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Shop</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String location;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Shop</span><span class="params">(ShopBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = builder.name;</span><br><span class="line">        <span class="keyword">this</span>.location = builder.location;</span><br><span class="line">        <span class="keyword">this</span>.type = builder.type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Shop&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", location='"</span> + location + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", type='"</span> + type + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ShopBuilder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> String location;</span><br><span class="line">        <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ShopBuilder <span class="title">name</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ShopBuilder <span class="title">location</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.location = location;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ShopBuilder <span class="title">type</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.type = type;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Shop <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Shop(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨å®¢æˆ·ç«¯æ„å»ºShopåªéœ€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Shop shop = <span class="keyword">new</span> Shop.ShopBuilder()</span><br><span class="line">                .name(<span class="string">"XXæ°´æœåº—"</span>)</span><br><span class="line">                .location(<span class="string">"ç¦å·å¸‚XXåŒºXXè¡—XXå·"</span>)</span><br><span class="line">                .type(<span class="string">"æ°´æœç»è¥"</span>)</span><br><span class="line">                .build();</span><br><span class="line">        System.out.println(shop);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿™ç§ç”¨æ³•å’ŒLombokçš„@Builderæ³¨è§£æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p><p>è¿™ä¸ªä¾‹å­çš„UMLå›¾ï¼š</p><p><img src="img/QQæˆªå›¾20191216163308.png" alt="QQæˆªå›¾20191216163308.png"></p><h3 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h3><p>å•ä¾‹æ¨¡å¼ç›®çš„æ˜¯ä¸ºäº†ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚</p><p>ä¼˜ç‚¹ï¼š</p><ol><li>å†…å­˜ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å†…å­˜å¼€é”€ï¼›</li><li>å¯ä»¥é¿å…å¯¹èµ„æºçš„å¤šé‡å ç”¨ï¼›</li><li>è®¾ç½®å…¨å±€è®¿é—®ç‚¹ï¼Œä¸¥æ ¼æ§åˆ¶è®¿é—®ã€‚</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>æ²¡æœ‰æ¥å£ï¼Œæ‹“å±•å›°éš¾ã€‚</li></ol><h4 id="æ‡’æ±‰æ¨¡å¼"><a href="#æ‡’æ±‰æ¨¡å¼" class="headerlink" title="æ‡’æ±‰æ¨¡å¼"></a>æ‡’æ±‰æ¨¡å¼</h4><p>æ‡’æ±‰æ¨¡å¼ä¸‹çš„å•ä¾‹å†™æ³•æ˜¯æœ€ç®€å•çš„ï¼Œä½†å®ƒæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazySingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazySingleton lazySingleton = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LazySingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LazySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (lazySingleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">            lazySingleton = <span class="keyword">new</span> LazySingleton();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lazySingleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ åŒæ­¥é”è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazySingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazySingleton lazySingleton = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LazySingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LazySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LazySingleton.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lazySingleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">                lazySingleton = <span class="keyword">new</span> LazySingleton();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lazySingleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä½†æ˜¯åŒæ­¥é”é”çš„æ˜¯æ•´ä¸ªç±»ï¼Œæ¯”è¾ƒæ¶ˆè€—èµ„æºï¼Œå¹¶ä¸”å³ä½¿è¿è¡Œå†…å­˜ä¸­å·²ç»å­˜åœ¨LazySingletonï¼Œè°ƒç”¨å…¶getInstanceè¿˜æ˜¯ä¼šä¸Šé”ï¼Œæ‰€ä»¥è¿™ç§å†™æ³•ä¹Ÿä¸æ˜¯å¾ˆå¥½ã€‚</p><h4 id="åŒé‡åŒæ­¥é”å•ä¾‹æ¨¡å¼"><a href="#åŒé‡åŒæ­¥é”å•ä¾‹æ¨¡å¼" class="headerlink" title="åŒé‡åŒæ­¥é”å•ä¾‹æ¨¡å¼"></a>åŒé‡åŒæ­¥é”å•ä¾‹æ¨¡å¼</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyDoubleCheckSingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazyDoubleCheckSingleton instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LazyDoubleCheckSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LazyDoubleCheckSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LazyDoubleCheckSingleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> LazyDoubleCheckSingleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¾‹å­è™½ç„¶åŠ äº†åŒæ­¥é”ï¼Œä½†å®ƒè¿˜æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚è™½ç„¶ä¸Šé¢çš„ä¾‹å­ä¸ä¼šå‡ºç°å¤šæ¬¡åˆå§‹åŒ–LazyDoubleCheckSingletonå®ä¾‹çš„æƒ…å†µï¼Œä½†æ˜¯ç”±äºæŒ‡ä»¤é‡æ’çš„åŸå› ï¼ŒæŸäº›çº¿ç¨‹å¯èƒ½ä¼šè·å–åˆ°ç©ºå¯¹è±¡ï¼Œåç»­å¯¹è¯¥å¯¹è±¡çš„æ“ä½œå°†è§¦å‘ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p><p>è¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œåªéœ€è¦é˜»æ­¢æŒ‡ä»¤é‡æ’å³å¯ï¼Œæ‰€ä»¥å¯ä»¥ç»™instanceå±æ€§åŠ ä¸Švolatileå…³é”®å­—ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyDoubleCheckSingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> LazyDoubleCheckSingleton instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LazyDoubleCheckSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LazyDoubleCheckSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LazyDoubleCheckSingleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> LazyDoubleCheckSingleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç›¸å…³åšæ–‡ï¼š<a href="/volatile.html">æ·±å…¥ç†è§£volatileå…³é”®å­—</a>ã€‚</p><p>ä¸Šé¢è¿™ç§å†™æ³•æ˜¯ä¸ä½†ç¡®ä¿äº†çº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸”å½“LazyDoubleCheckSingletonå®ä¾‹åˆ›å»ºå¥½åï¼Œåç»­å†è°ƒç”¨å…¶getInstanceæ–¹æ³•ä¸ä¼šä¸Šé”ã€‚</p><h4 id="é™æ€å†…éƒ¨ç±»å•ä¾‹æ¨¡å¼"><a href="#é™æ€å†…éƒ¨ç±»å•ä¾‹æ¨¡å¼" class="headerlink" title="é™æ€å†…éƒ¨ç±»å•ä¾‹æ¨¡å¼"></a>é™æ€å†…éƒ¨ç±»å•ä¾‹æ¨¡å¼</h4><p>çœ‹ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticInnerClassSingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">StaticInnerClassSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerClass</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> StaticInnerClassSingleton instance = <span class="keyword">new</span> StaticInnerClassSingleton();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StaticInnerClassSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> InnerClass.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸ºä»€ä¹ˆè¿™ä¸ªä¾‹å­æ˜¯å¯è¡Œçš„å‘¢ï¼Ÿä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š</p><ol><li>JVMåœ¨ç±»çš„åˆå§‹åŒ–é˜¶æ®µä¼šåŠ Classå¯¹è±¡åˆå§‹åŒ–åŒæ­¥é”ï¼ŒåŒæ­¥å¤šä¸ªçº¿ç¨‹å¯¹è¯¥ç±»çš„åˆå§‹åŒ–æ“ä½œï¼›</li><li>é™æ€å†…éƒ¨ç±»InnerClassçš„é™æ€æˆå‘˜å˜é‡instanceåœ¨æ–¹æ³•åŒºä¸­åªä¼šæœ‰ä¸€ä¸ªå®ä¾‹ã€‚</li></ol><p>åœ¨Javaè§„èŒƒä¸­ï¼Œå½“ä»¥ä¸‹è¿™äº›æƒ…å†µé¦–æ¬¡å‘ç”Ÿæ—¶ï¼ŒAç±»å°†ä¼šç«‹åˆ»è¢«åˆå§‹åŒ–ï¼š</p><ol><li>Aç±»å‹å®ä¾‹è¢«åˆ›å»ºï¼›</li><li>Aç±»ä¸­å£°æ˜çš„é™æ€æ–¹æ³•è¢«è°ƒç”¨ï¼›</li><li>Aç±»ä¸­çš„é™æ€æˆå‘˜å˜é‡è¢«èµ‹å€¼ï¼›</li><li>Aç±»ä¸­çš„é™æ€æˆå‘˜è¢«ä½¿ç”¨ï¼ˆéå¸¸é‡ï¼‰ï¼›</li></ol><h4 id="é¥¿æ±‰å•ä¾‹æ¨¡å¼"><a href="#é¥¿æ±‰å•ä¾‹æ¨¡å¼" class="headerlink" title="é¥¿æ±‰å•ä¾‹æ¨¡å¼"></a>é¥¿æ±‰å•ä¾‹æ¨¡å¼</h4><p>â€œé¥¿æ±‰â€æ„æŒ‡åœ¨ç±»åŠ è½½çš„æ—¶å€™å°±åˆå§‹åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HungrySingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> HungrySingleton instance = <span class="keyword">new</span> HungrySingleton();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HungrySingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HungrySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿™ç§æ¨¡å¼åœ¨ç±»åŠ è½½çš„æ—¶å€™å°±å®Œæˆäº†åˆå§‹åŒ–ï¼Œæ‰€ä»¥å¹¶ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨æ€§é—®é¢˜ï¼›ä½†ç”±äºä¸æ˜¯æ‡’åŠ è½½ï¼Œé¥¿æ±‰æ¨¡å¼ä¸ç®¡éœ€ä¸éœ€è¦ç”¨åˆ°å®ä¾‹éƒ½è¦å»åˆ›å»ºå®ä¾‹ï¼Œå¦‚æœåˆ›å»ºäº†ä¸ä½¿ç”¨ï¼Œåˆ™ä¼šé€ æˆå†…å­˜æµªè´¹ã€‚</p><h4 id="åºåˆ—åŒ–ç ´åå•ä¾‹æ¨¡å¼"><a href="#åºåˆ—åŒ–ç ´åå•ä¾‹æ¨¡å¼" class="headerlink" title="åºåˆ—åŒ–ç ´åå•ä¾‹æ¨¡å¼"></a>åºåˆ—åŒ–ç ´åå•ä¾‹æ¨¡å¼</h4><p>å‰é¢çš„å•ä¾‹ä¾‹å­åœ¨å®ç°åºåˆ—åŒ–æ¥å£åéƒ½èƒ½è¢«åºåˆ—åŒ–çš„æ–¹å¼ç ´åï¼Œæ¯”å¦‚HungrySingletonï¼Œè®©å…¶å®ç°åºåˆ—åŒ–æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HungrySingleton</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8073288969651806838L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> HungrySingleton instance = <span class="keyword">new</span> HungrySingleton();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HungrySingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HungrySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç„¶ååˆ›å»ºApplicationæµ‹è¯•ä¸€ä¸‹å¦‚ä½•ç ´åï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// æ¼”ç¤ºåºåˆ—åŒ–ç ´åå•ä¾‹</span></span><br><span class="line">        HungrySingleton instance = HungrySingleton.getInstance();</span><br><span class="line">        ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"file"</span>));</span><br><span class="line">        outputStream.writeObject(instance);</span><br><span class="line"></span><br><span class="line">        ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"file"</span>));</span><br><span class="line">        HungrySingleton newInstance = (HungrySingleton) inputStream.readObject();</span><br><span class="line"></span><br><span class="line">        System.out.println(instance);</span><br><span class="line">        System.out.println(newInstance);</span><br><span class="line">        System.out.println(instance == newInstance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cc.mrbird.design.pattern.creational.singleton.HungrySingleton@7f31245a</span><br><span class="line">cc.mrbird.design.pattern.creational.singleton.HungrySingleton@6d03e736</span><br><span class="line">false</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶æ˜¯å•ä¾‹æ¨¡å¼ï¼Œä½†å´æˆåŠŸåˆ›å»ºå‡ºäº†ä¸¤ä¸ªä¸ä¸€æ ·çš„å®ä¾‹ï¼Œå•ä¾‹é­åˆ°äº†ç ´åã€‚</p><p>è¦è®©ååºåˆ—åŒ–åçš„å¯¹è±¡å’Œåºåˆ—åŒ–å‰çš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„è¯ï¼Œå¯ä»¥åœ¨HungrySingletoné‡ŒåŠ ä¸ŠreadResolveæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HungrySingleton</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8073288969651806838L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> HungrySingleton instance = <span class="keyword">new</span> HungrySingleton();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HungrySingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HungrySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ–°å¢</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å†æ¬¡è¿è¡ŒApplicationçš„mainæ–¹æ³•åï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cc.mrbird.design.pattern.creational.singleton.HungrySingleton@7f31245a</span><br><span class="line">cc.mrbird.design.pattern.creational.singleton.HungrySingleton@7f31245a</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§æ–¹å¼æœ€ç»ˆååºåˆ—åŒ–å‡ºæ¥çš„å¯¹è±¡å’Œåºåˆ—åŒ–å¯¹è±¡æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚ä½†è¿™ç§æ–¹å¼ååºåˆ—åŒ–è¿‡ç¨‹å†…éƒ¨è¿˜æ˜¯ä¼šé‡æ–°åˆ›å»ºHungrySingletonå®ä¾‹ï¼Œåªä¸è¿‡å› ä¸ºHungrySingletonç±»å®šä¹‰äº†readResolveæ–¹æ³•ï¼ˆæ–¹æ³•å†…éƒ¨è¿”å›instanceå¼•ç”¨ï¼‰ï¼Œååºåˆ—åŒ–è¿‡ç¨‹ä¼šåˆ¤æ–­ç›®æ ‡ç±»æ˜¯å¦å®šä¹‰äº†readResolveè¯¥æ–¹æ³•ï¼Œæ˜¯çš„è¯åˆ™é€šè¿‡åå°„è°ƒç”¨è¯¥æ–¹æ³•ã€‚</p><h4 id="åå°„ç ´åå•ä¾‹æ¨¡å¼"><a href="#åå°„ç ´åå•ä¾‹æ¨¡å¼" class="headerlink" title="åå°„ç ´åå•ä¾‹æ¨¡å¼"></a>åå°„ç ´åå•ä¾‹æ¨¡å¼</h4><p>é™¤äº†åºåˆ—åŒ–èƒ½ç ´åå•ä¾‹å¤–ï¼Œåå°„ä¹Ÿå¯ä»¥ï¼Œä¸¾ä¸ªåå°„ç ´åHungrySingletonçš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HungrySingleton instance = HungrySingleton.getInstance();</span><br><span class="line">        <span class="comment">// åå°„åˆ›å»ºå®ä¾‹</span></span><br><span class="line">        Class&lt;HungrySingleton&gt; c = HungrySingleton.class;</span><br><span class="line">        <span class="comment">// è·å–æ„é€ å™¨</span></span><br><span class="line">        Constructor&lt;HungrySingleton&gt; constructor = c.getDeclaredConstructor();</span><br><span class="line">        <span class="comment">// æ‰“å¼€æ„é€ å™¨æƒé™</span></span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        HungrySingleton newInstance = constructor.newInstance();</span><br><span class="line"></span><br><span class="line">        System.out.println(instance);</span><br><span class="line">        System.out.println(newInstance);</span><br><span class="line">        System.out.println(instance == newInstance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cc.mrbird.design.pattern.creational.singleton.HungrySingleton@1b6d3586</span><br><span class="line">cc.mrbird.design.pattern.creational.singleton.HungrySingleton@4554617c</span><br><span class="line">false</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é€šè¿‡åå°„ç ´åäº†ç§æœ‰æ„é€ å™¨æƒé™ï¼ŒæˆåŠŸåˆ›å»ºäº†æ–°çš„å®ä¾‹ã€‚</p><p>å¯¹äºè¿™ç§æƒ…å†µï¼Œé¥¿æ±‰æ¨¡å¼ä¸‹çš„ä¾‹å­å¯ä»¥åœ¨æ„é€ å™¨ä¸­æ·»åŠ åˆ¤æ–­é€»è¾‘æ¥é˜²å¾¡ï¼ˆæ‡’æ±‰æ¨¡å¼çš„å°±æ²¡æœ‰åŠæ³•äº†ï¼‰ï¼Œæ¯”å¦‚ä¿®æ”¹HungrySingletonçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HungrySingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> HungrySingleton instance = <span class="keyword">new</span> HungrySingleton();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HungrySingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"forbidden"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HungrySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å†æ¬¡è¿è¡ŒApplicationçš„mainæ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.reflect.InvocationTargetException</span><br><span class="line">    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</span><br><span class="line">    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">    at java.lang.reflect.Constructor.newInstance(Constructor.java:423)</span><br><span class="line">    at cc.mrbird.design.pattern.creational.singleton.Application.main(Application.java:33)</span><br><span class="line">Caused by: java.lang.RuntimeException: forbidden</span><br><span class="line">    at cc.mrbird.design.pattern.creational.singleton.HungrySingleton.&lt;init&gt;(HungrySingleton.java:16)</span><br><span class="line">    ... 5 more</span><br></pre></td></tr></table></figure><p></p><h4 id="æšä¸¾å•ä¾‹æ¨¡å¼"><a href="#æšä¸¾å•ä¾‹æ¨¡å¼" class="headerlink" title="æšä¸¾å•ä¾‹æ¨¡å¼"></a>æšä¸¾å•ä¾‹æ¨¡å¼</h4><p>æšä¸¾å•ä¾‹æ¨¡å¼æ˜¯æ¨èçš„å•ä¾‹æ¨¡å¼ï¼Œå®ƒä¸ä»…å¯ä»¥é˜²å¾¡åºåˆ—åŒ–æ”»å‡»ï¼Œä¹Ÿå¯ä»¥é˜²å¾¡åå°„æ”»å‡»ã€‚ä¸¾ä¸ªæšä¸¾å•ä¾‹æ¨¡å¼çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EnumSingleton &#123;</span><br><span class="line"></span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(Object data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EnumSingleton <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>éªŒè¯ä¸‹æ˜¯å¦æ˜¯å•ä¾‹çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        EnumSingleton instance = EnumSingleton.getInstance();</span><br><span class="line">        instance.setData(<span class="keyword">new</span> Object());</span><br><span class="line">        EnumSingleton newInstance = EnumSingleton.getInstance();</span><br><span class="line"></span><br><span class="line">        System.out.println(instance);</span><br><span class="line">        System.out.println(newInstance);</span><br><span class="line">        System.out.println(instance.getData());</span><br><span class="line">        System.out.println(newInstance.getData());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTANCE</span><br><span class="line">INSTANCE</span><br><span class="line">java.lang.Object@1b6d3586</span><br><span class="line">java.lang.Object@1b6d3586</span><br></pre></td></tr></table></figure><p></p><p>æµ‹è¯•ä¸‹åºåˆ—åŒ–æ”»å‡»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        EnumSingleton instance = EnumSingleton.getInstance();</span><br><span class="line">        instance.setData(<span class="keyword">new</span> Object());</span><br><span class="line">        ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"file"</span>));</span><br><span class="line">        outputStream.writeObject(instance);</span><br><span class="line">       </span><br><span class="line">        ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"file"</span>));</span><br><span class="line">        EnumSingleton newInstance = (EnumSingleton) inputStream.readObject();</span><br><span class="line"></span><br><span class="line">        System.out.println(instance);</span><br><span class="line">        System.out.println(newInstance);</span><br><span class="line">        System.out.println(instance == newInstance);</span><br><span class="line"></span><br><span class="line">        System.out.println(instance.getData());</span><br><span class="line">        System.out.println(newInstance.getData());</span><br><span class="line">        System.out.println(instance.getData() == newInstance.getData());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSTANCE</span><br><span class="line">INSTANCE</span><br><span class="line">true</span><br><span class="line">java.lang.Object@568db2f2</span><br><span class="line">java.lang.Object@568db2f2</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°åºåˆ—åŒ–å’Œååºåˆ—åŒ–åçš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªã€‚</p><p>åŸç†ï¼šè·Ÿè¸ªObjectInputStream#readObjectæºç ï¼Œå…¶ä¸­å½“åç¼–è¯‘å¯¹è±¡ä¸ºæšä¸¾ç±»å‹æ—¶ï¼Œå°†è°ƒç”¨readEnumæ–¹æ³•ï¼š</p><p><img src="img/QQæˆªå›¾20191217155448.png" alt="QQæˆªå›¾20191217155448.png"></p><p>nameä¸ºæšä¸¾ç±»é‡Œçš„æšä¸¾å¸¸é‡ï¼Œå¯¹äºçº¿ç¨‹æ¥è¯´å®ƒæ˜¯å”¯ä¸€çš„ï¼Œå­˜åœ¨æ–¹æ³•åŒºï¼Œæ‰€ä»¥é€šè¿‡<code>Enum.valueOf((Class)cl, name)</code>æ–¹æ³•å¾—åˆ°çš„æšä¸¾å¯¹è±¡éƒ½æ˜¯åŒä¸€ä¸ªã€‚</p><p>å†æµ‹è¯•ä¸€ä¸‹åå°„æ”»å‡»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        EnumSingleton instance = EnumSingleton.getInstance();</span><br><span class="line"></span><br><span class="line">        Class&lt;EnumSingleton&gt; c = EnumSingleton.class;</span><br><span class="line">        <span class="comment">// æšä¸¾ç±»åªåŒ…å«ä¸€ä¸ª(String,int)ç±»å‹æ„é€ å™¨</span></span><br><span class="line">        Constructor&lt;EnumSingleton&gt; constructor = c.getDeclaredConstructor(String.class, <span class="keyword">int</span>.class);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        EnumSingleton newInstance = constructor.newInstance(<span class="string">"hello"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(instance == newInstance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿è¡Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.IllegalArgumentException: Cannot reflectively create enum objects</span><br><span class="line">    at java.lang.reflect.Constructor.newInstance(Constructor.java:417)</span><br><span class="line">    at cc.mrbird.design.pattern.creational.singleton.Application.main(Application.java:71)</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°æŠ›å¼‚å¸¸äº†ï¼ŒæŸ¥çœ‹Constructorç±»çš„417è¡Œä»£ç å¯ä»¥å‘ç°åŸå› ï¼š <img src="img/QQæˆªå›¾20191217160647.png" alt="QQæˆªå›¾20191217160647.png"></p><p>Javaç¦æ­¢é€šè¿‡åå°„åˆ›å»ºæšä¸¾å¯¹è±¡ã€‚</p><p>æ­£æ˜¯å› ä¸ºæšä¸¾ç±»å‹æ‹¥æœ‰è¿™äº›å¤©ç„¶çš„ä¼˜åŠ¿ï¼Œæ‰€ä»¥ç”¨å®ƒåˆ›å»ºå•ä¾‹æ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œè¿™ä¹Ÿæ˜¯Effective Javaæ¨èçš„æ–¹å¼ã€‚</p><h3 id="åŸå‹æ¨¡å¼"><a href="#åŸå‹æ¨¡å¼" class="headerlink" title="åŸå‹æ¨¡å¼"></a>åŸå‹æ¨¡å¼</h3><p>åŸå‹å®ä¾‹æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±»ï¼Œé€šè¿‡æ‹·è´è¿™äº›åŸå‹åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚</p><p>é€‚ç”¨äºï¼š</p><ol><li>ç±»åˆå§‹åŒ–æ¶ˆè€—è¾ƒå¤šèµ„æºï¼›</li><li>å¾ªç¯ä½“ä¸­ç”Ÿäº§å¤§é‡å¯¹è±¡çš„æ—¶å€™ã€‚</li></ol><p>ä¼˜ç‚¹ï¼š</p><ol><li>åŸå‹æ¨¡å¼æ€§èƒ½æ¯”ç›´æ¥newä¸€ä¸ªå¯¹è±¡æ€§èƒ½å¥½ï¼›</li><li>ç®€åŒ–åˆ›å»ºå¯¹è±¡è¿‡ç¨‹ã€‚</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>å¯¹è±¡å¿…é¡»é‡å†™Objectå…‹éš†æ–¹æ³•ï¼›</li><li>å¤æ‚å¯¹è±¡çš„å…‹éš†æ–¹æ³•å†™èµ·æ¥è¾ƒéº»çƒ¦ï¼ˆæ·±å…‹éš†ã€æµ…å…‹éš†ï¼‰</li></ol><p>ä¸¾ä¾‹ï¼šæ–°å»ºä¸€ä¸ªå­¦ç”Ÿç±»Studentï¼Œå®ç°å…‹éš†æ¥å£ï¼Œå¹¶é‡å†™Objectçš„å…‹éš†æ–¹æ³•ï¼ˆå› ä¸ºéƒ½æ˜¯ç®€å•å±æ€§ï¼Œæ‰€ä»¥æµ…å…‹éš†å³å¯ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Student&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.clone();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨Applicationä¸­æµ‹è¯•ä¸€æ³¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">        Student student = <span class="keyword">new</span> Student();</span><br><span class="line">        ArrayList&lt;Student&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            Student s = (Student) student.clone();</span><br><span class="line">            s.setName(<span class="string">"å­¦ç”Ÿ"</span> + i);</span><br><span class="line">            s.setAge(<span class="number">20</span> + i);</span><br><span class="line">            list.add(s);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Student&#123;name=<span class="string">'å­¦ç”Ÿ0'</span>, age=<span class="number">20</span>&#125;, Student&#123;name=<span class="string">'å­¦ç”Ÿ1'</span>, age=<span class="number">21</span>&#125;, Student&#123;name=<span class="string">'å­¦ç”Ÿ2'</span>, age=<span class="number">22</span>&#125;]</span><br></pre></td></tr></table></figure><p></p><p>è¿™ç§æ–¹å¼ä¼šæ¯”ç›´æ¥åœ¨å¾ªç¯ä¸­åˆ›å»ºStudentæ€§èƒ½å¥½ã€‚</p><p>å½“å¯¹è±¡åŒ…å«å¼•ç”¨ç±»å‹å±æ€§æ—¶ï¼Œéœ€è¦ä½¿ç”¨æ·±å…‹éš†ï¼Œæ¯”å¦‚StudentåŒ…å«Dateå±æ€§æ—¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getBirthday</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> birthday;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBirthday</span><span class="params">(Date birthday)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.birthday = birthday;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Student&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">", birthday="</span> + birthday +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">        Student student = (Student) <span class="keyword">super</span>.clone();</span><br><span class="line">        <span class="comment">// å¼•ç”¨ç±»å‹æ·±å…‹éš†</span></span><br><span class="line">        Date birthday = (Date) student.getBirthday().clone();</span><br><span class="line">        student.setBirthday(birthday);</span><br><span class="line">        <span class="keyword">return</span> student;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå…‹éš†ä¼šç ´åå®ç°äº†Cloneableæ¥å£çš„å•ä¾‹å¯¹è±¡ã€‚</p><h2 id="ç»“æ„å‹æ¨¡å¼"><a href="#ç»“æ„å‹æ¨¡å¼" class="headerlink" title="ç»“æ„å‹æ¨¡å¼"></a>ç»“æ„å‹æ¨¡å¼</h2><h3 id="å¤–è§‚æ¨¡å¼"><a href="#å¤–è§‚æ¨¡å¼" class="headerlink" title="å¤–è§‚æ¨¡å¼"></a>å¤–è§‚æ¨¡å¼</h3><p>å¤–è§‚æ¨¡å¼åˆå«é—¨é¢æ¨¡å¼ï¼Œæä¾›äº†ç»Ÿä¸€å¾—æ¥å£ï¼Œç”¨æ¥è®¿é—®å­ç³»ç»Ÿä¸­çš„ä¸€ç¾¤æ¥å£ã€‚</p><p>é€‚ç”¨äºï¼š</p><ol><li>å­ç³»ç»Ÿè¶Šæ¥è¶Šå¤æ‚ï¼Œå¢åŠ å¤–è§‚æ¨¡å¼æä¾›ç®€å•æ¥å£è°ƒç”¨ï¼›</li><li>æ„å»ºå¤šå±‚ç³»ç»Ÿç»“æ„ï¼Œåˆ©ç”¨å¤–è§‚å¯¹è±¡ä½œä¸ºæ¯å±‚çš„å…¥å£ï¼Œç®€åŒ–å±‚é—´è°ƒç”¨ã€‚</li></ol><p>ä¼˜ç‚¹ï¼š</p><ol><li>ç®€åŒ–äº†è°ƒç”¨è¿‡ç¨‹ï¼Œæ— éœ€äº†è§£æ·±å…¥å­ç³»ç»Ÿï¼›</li><li>å‡ä½è€¦åˆåº¦ï¼›</li><li>æ›´å¥½çš„å±‚æ¬¡åˆ’åˆ†ï¼›</li><li>ç¬¦åˆè¿ªç±³ç‰¹æ³•åˆ™ã€‚</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>å¢åŠ å­ç³»ç»Ÿï¼Œæ‹“å±•å­ç³»ç»Ÿè¡Œä¸ºå®¹æ˜“å¼•å…¥é£é™©ï¼›</li><li>ä¸ç¬¦åˆå¼€é—­åŸåˆ™ã€‚</li></ol><p>ä¸¾ä¸ªè®¢å¤–å–çš„ä¾‹å­ã€‚</p><p>åˆ›å»ºä¸€ä¸ªå¤–å–å®ä½“ç±»Takeawayï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Takeaway</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è®¢å¤–å–è¿‡ç¨‹ä¸€èˆ¬åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼šä¸‹å•ã€æ”¯ä»˜å’Œé…é€ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºä¸‰ä¸ªServiceå¯¹åº”è¿™ä¸‰ä¸ªè¿‡ç¨‹ã€‚æ–°å»ºä¸‹å•æœåŠ¡OrderServiceï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">placeAnOrder</span><span class="params">(Takeaway takeaway)</span> </span>&#123;</span><br><span class="line">        System.out.println(takeaway.getName() + <span class="string">"ä¸‹å•æˆåŠŸ"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºæ”¯ä»˜æœåŠ¡PayServiceï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">pay</span><span class="params">(Takeaway takeaway)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"å•†å“"</span> + takeaway.getName() + <span class="string">"æ”¯ä»˜æˆåŠŸ"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºé…é€æœåŠ¡DeliveryServiceï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeliveryService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delivery</span><span class="params">(Takeaway takeaway)</span> </span>&#123;</span><br><span class="line">        System.out.println(takeaway.getName() + <span class="string">"å·²ç”±éª‘æ‰‹XXæ¥å•ï¼Œè®¢å•æ´¾é€ä¸­"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åŸºäºå¤–è§‚æ¨¡å¼æ³•åˆ™ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªServiceæ¥èšåˆè¿™ä¸‰ä¸ªæœåŠ¡ï¼Œå®¢æˆ·ç«¯åªéœ€è¦å’Œè¿™ä¸ªServiceäº¤äº’å³å¯ã€‚æ–°å»ºå¤–å–æœåŠ¡TakeawayServiceï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TakeawayService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService = <span class="keyword">new</span> OrderService();</span><br><span class="line">    <span class="keyword">private</span> PayService payService = <span class="keyword">new</span> PayService();</span><br><span class="line">    <span class="keyword">private</span> DeliveryService deliveryService = <span class="keyword">new</span> DeliveryService();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeOrder</span><span class="params">(Takeaway takeaway)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (orderService.placeAnOrder(takeaway)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (payService.pay(takeaway)) &#123;</span><br><span class="line">                deliveryService.delivery(takeaway);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºä¸ªå®¢æˆ·ç«¯æµ‹è¯•ä¸€æ³¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Takeaway takeaway = <span class="keyword">new</span> Takeaway();</span><br><span class="line">        takeaway.setName(<span class="string">"æ³¡æ¤’ğŸ¸"</span>);</span><br><span class="line"></span><br><span class="line">        TakeawayService takeawayService = <span class="keyword">new</span> TakeawayService();</span><br><span class="line">        takeawayService.takeOrder(takeaway);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå®¢æˆ·ç«¯åªéœ€è¦è°ƒç”¨TakeawayServiceå³å¯ï¼Œæ— éœ€å…³ç³»å†…éƒ¨å…·ä½“ç»å†äº†å¤šå°‘ä¸ªæ­¥éª¤ï¼Œè¿è¡Œmainæ–¹æ³•è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ³¡æ¤’ğŸ¸ä¸‹å•æˆåŠŸ</span><br><span class="line">å•†å“æ³¡æ¤’ğŸ¸æ”¯ä»˜æˆåŠŸ</span><br><span class="line">æ³¡æ¤’ğŸ¸å·²ç”±éª‘æ‰‹XXæ¥å•ï¼Œè®¢å•æ´¾é€ä¸­</span><br></pre></td></tr></table></figure><p></p><p>è¯¥ä¾‹å­çš„UMLå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191218151629.png" alt="QQæˆªå›¾20191218151629.png"></p><h3 id="è£…é¥°è€…æ¨¡å¼"><a href="#è£…é¥°è€…æ¨¡å¼" class="headerlink" title="è£…é¥°è€…æ¨¡å¼"></a>è£…é¥°è€…æ¨¡å¼</h3><p>åœ¨ä¸æ”¹å˜åŸæœ‰å¯¹è±¡çš„åŸºç¡€ä¹‹ä¸Šï¼Œå°†åŠŸèƒ½é™„åŠ åˆ°å¯¹è±¡ä¸Šï¼Œæä¾›äº†æ¯”ç»§æ‰¿æ›´æœ‰å¼¹æ€§çš„æ›¿ä»£æ–¹æ¡ˆã€‚</p><p>é€‚ç”¨äºï¼š</p><ol><li>æ‹“å±•ä¸€ä¸ªç±»çš„åŠŸèƒ½ï¼›</li><li>åŠ¨æ€ç»™å¯¹è±¡æ·»åŠ åŠŸèƒ½ï¼Œå¹¶ä¸”åŠ¨æ€æ’¤é”€ã€‚</li></ol><p>ä¼˜ç‚¹ï¼š</p><ol><li>ç»§æ‰¿çš„æœ‰åŠ›è¡¥å……ï¼Œä¸æ”¹å˜åŸæœ‰å¯¹è±¡çš„æƒ…å†µä¸‹ç»™å¯¹è±¡æ‹“å±•åŠŸèƒ½ï¼›</li><li>é€šè¿‡ä½¿ç”¨ä¸åŒçš„è£…é¥°ç±»ã€ä¸åŒçš„ç»„åˆæ–¹å¼ï¼Œå®ç°ä¸åŒçš„æ•ˆæœã€‚</li><li>ç¬¦åˆå¼€é—­åŸåˆ™ã€‚</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>å¢åŠ ç¨‹åºå¤æ‚æ€§ï¼›</li></ol><p>ä¸¾ä¸ªæ°´æœæ²™æ‹‰çš„ä¾‹å­ã€‚</p><p>æ¯”å¦‚åœ¨ç‚¹æ°´æœæ²™æ‹‰å¤–å–æ—¶ï¼Œå¯ä»¥å¾€æ°´æœæ²™æ‹‰é‡ŒåŠ å„ç§æ°´æœï¼Œä»·æ ¼ä¹Ÿä¼šç›¸åº”çš„è°ƒæ•´ï¼Œè¦è®©ç¨‹åºæ”¯æŒä¸åŒæ°´æœè‡ªç”±ç»„åˆï¼Œå¹¶è®¡ç®—ç›¸åº”çš„ä»·æ ¼ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è£…é¥°è€…æ¨¡å¼æ¥å®Œæˆã€‚</p><p>å®šä¹‰ä¸€ä¸ªæŠ½è±¡çš„æ°´æœæ²™æ‹‰ç±»AbstractFruitSaladï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractFruitSalad</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">remark</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">price</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åŒ…å«å¤‡æ³¨å’Œä»·æ ¼æŠ½è±¡æ–¹æ³•ã€‚</p><p>æ¥ç€åˆ›å»ºä¸€ä¸ªæŠ½è±¡çš„è£…é¥°å™¨AbstractDecoratorï¼ˆå…³é”®ç‚¹ï¼Œç»§æ‰¿æŠ½è±¡æ°´æœæ²™æ‹‰ç±»ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDecorator</span> <span class="keyword">extends</span> <span class="title">AbstractFruitSalad</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AbstractFruitSalad fruitSalad;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractDecorator</span><span class="params">(AbstractFruitSalad fruitSalad)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fruitSalad = fruitSalad;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">remark</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fruitSalad.remark();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">price</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fruitSalad.price();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºå…·ä½“çš„æ°´æœæ²™æ‹‰ç±»FruitSaladï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitSalad</span> <span class="keyword">extends</span> <span class="title">AbstractFruitSalad</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">remark</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"æ°´æœğŸ¥—ï¼ˆæ ‡å‡†ï¼‰\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">price</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¯¥æ²™æ‹‰æ˜¯æ ‡å‡†çš„æ°´æœæ²™æ‹‰ï¼Œä»·æ ¼æ˜¯9å…ƒã€‚</p><p>å¦‚æœæˆ‘ä»¬çš„æ°´æœæ²™æ‹‰è¿˜å…è®¸å®¢æˆ·æ·»åŠ çŒ•çŒ´æ¡ƒå’Œè¥¿ç“œï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸¤ä¸ªæ–°çš„è£…é¥°å™¨ã€‚æ·»åŠ çŒ•çŒ´æ¡ƒè£…é¥°å™¨KiwiDecoratorï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KiwiDecorator</span> <span class="keyword">extends</span> <span class="title">AbstractDecorator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">KiwiDecorator</span><span class="params">(AbstractFruitSalad fruitSalad)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(fruitSalad);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">remark</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.remark() + <span class="string">"åŠ ä»½ğŸ¥åˆ‡\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">price</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.price() + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒåŠ ä¸€ä»½çŒ•çŒ´æ¡ƒéœ€è¦åœ¨åŸæœ‰åŸºç¡€ä¸ŠåŠ 2å…ƒã€‚</p><p>æ¥ç€ç»§ç»­åˆ›å»ºè¥¿ç“œè£…é¥°å™¨WaterMelonDecoratorï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaterMelonDecorator</span> <span class="keyword">extends</span> <span class="title">AbstractDecorator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaterMelonDecorator</span><span class="params">(AbstractFruitSalad fruitSalad)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(fruitSalad);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">remark</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.remark() + <span class="string">"åŠ ä»½ğŸ‰åˆ‡\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">price</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.price() + <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æœ€ååˆ›å»ºå®¢æˆ·ç«¯Applicationæµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç‚¹äº†ä»½æ°´æœæ²™æ‹‰ï¼Œå¹¶åŠ äº†ä¸¤ä»½ğŸ¥å’Œä¸€ä»½ğŸ‰ï¼Œçœ‹çœ‹æœ€ç»ˆä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ</span></span><br><span class="line">        AbstractFruitSalad fruitSalad = <span class="keyword">new</span> FruitSalad();</span><br><span class="line">        fruitSalad = <span class="keyword">new</span> KiwiDecorator(fruitSalad);</span><br><span class="line">        fruitSalad = <span class="keyword">new</span> KiwiDecorator(fruitSalad);</span><br><span class="line">        fruitSalad = <span class="keyword">new</span> WaterMelonDecorator(fruitSalad);</span><br><span class="line"></span><br><span class="line">        System.out.println(fruitSalad.remark() + <span class="string">"ä»·æ ¼æ˜¯ï¼š"</span> + fruitSalad.price());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„å†™æ³•ä¹Ÿå¯ä»¥æ”¹ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç‚¹äº†ä»½æ°´æœæ²™æ‹‰ï¼Œå¹¶åŠ äº†ä¸¤ä»½ğŸ¥å’Œä¸€ä»½ğŸ‰ï¼Œçœ‹çœ‹æœ€ç»ˆä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ</span></span><br><span class="line">        AbstractFruitSalad fruitSalad = <span class="keyword">new</span> FruitSalad();</span><br><span class="line">        fruitSalad = <span class="keyword">new</span> WaterMelonDecorator(<span class="keyword">new</span> KiwiDecorator(<span class="keyword">new</span> KiwiDecorator(fruitSalad)));</span><br><span class="line"></span><br><span class="line">        System.out.println(fruitSalad.remark() + <span class="string">"ä»·æ ¼æ˜¯ï¼š"</span> + fruitSalad.price());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æ°´æœğŸ¥—ï¼ˆæ ‡å‡†ï¼‰</span><br><span class="line">åŠ ä»½ğŸ¥åˆ‡</span><br><span class="line">åŠ ä»½ğŸ¥åˆ‡</span><br><span class="line">åŠ ä»½ğŸ‰åˆ‡</span><br><span class="line">ä»·æ ¼æ˜¯ï¼š16</span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡ä¸åŒçš„è£…é¥°å™¨è‡ªç”±ç»„åˆï¼Œæˆ‘ä»¬å¯ä»¥çµæ´»çš„ç»„è£…å‡ºå„å¼å„æ ·çš„æ°´æœæ²™æ‹‰ï¼Œè¿™æ­£æ˜¯è£…é¥°è€…æ¨¡å¼çš„ä¼˜ç‚¹ï¼Œä½†æ˜æ˜¾å¯ä»¥çœ‹å‡ºä»£ç å˜å¤æ‚äº†ã€‚</p><p>è¿™ä¸ªä¾‹å­çš„UMLå›¾å¦‚ä¸‹æ‰€ç¤º:</p><p><img src="img/QQæˆªå›¾20191218172739.png" alt="QQæˆªå›¾20191218172739.png"></p><h3 id="é€‚é…å™¨æ¨¡å¼"><a href="#é€‚é…å™¨æ¨¡å¼" class="headerlink" title="é€‚é…å™¨æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼</h3><p>å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢ä¸ºæœŸæœ›çš„å¦ä¸€ä¸ªæ¥å£ï¼Œä½¿åŸæœ¬ä¸å…¼å®¹çš„ç±»å¯ä»¥ä¸€èµ·å·¥ä½œã€‚</p><p>é€‚ç”¨äºï¼š</p><ol><li>å·²å­˜åœ¨çš„ç±»ï¼Œå®ƒçš„æ–¹æ³•å’Œéœ€æ±‚ä¸åŒ¹é…æ—¶ï¼ˆæ–¹æ³•ç»“æœç›¸åŒæˆ–è€…ç›¸ä¼¼ï¼‰</li></ol><p>ä¼˜ç‚¹:</p><ol><li>æé«˜ç±»çš„é€æ˜æ€§å’Œå¤ç”¨ï¼Œç°æœ‰çš„ç±»å¤ç”¨ä½†ä¸éœ€æ”¹å˜ï¼›</li><li>ç›®æ ‡ç±»å’Œé€‚é…å™¨ç±»è§£è€¦ï¼Œæé«˜ç¨‹åºæ‹“å±•æ€§ï¼›</li><li>ç¬¦åˆå¼€é—­åŸåˆ™ã€‚</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>é€‚é…å™¨ç¼–å†™è¿‡ç¨‹éœ€è¦å…¨é¢è€ƒè™‘ï¼Œå¯èƒ½ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§ï¼›</li><li>é™ä½ä»£ç å¯è¯»æ€§ã€‚</li></ol><p>åˆ†ä¸ºï¼šç±»é€‚é…å™¨æ¨¡å¼å’Œå¯¹è±¡é€‚é…å™¨æ¨¡å¼ã€‚</p><p>å…ˆä¸¾ä¸ªç±»é€‚é…å™¨æ¨¡å¼çš„ä¾‹å­ï¼š</p><p>å‡å¦‚é¡¹ç›®é‡ŒåŸæœ‰ä¸€æ¡æ°´æœçš„äº§å“çº¿ï¼Œæ¯”å¦‚åŒ…å«ä¸€ä¸ªæ ‘è“ç±»Raspberryï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Raspberry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRaspberry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"æ·»åŠ ç‚¹æ ‘è“"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>éšç€é¡¹ç›®çš„æ‹“å±•ï¼Œç°åœ¨æ–°å¢äº†æ°´æœæ´¾äº§å“çº¿ï¼Œæ–°å»ºPieæ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Pie</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">make</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¦å°†RaspberryåŠ å…¥åˆ°Pieäº§å“çº¿ï¼Œåˆä¸æƒ³ä¿®æ”¹Raspberryç±»çš„ä»£ç ï¼Œåˆ™å¯ä»¥åˆ›å»ºä¸€ä¸ªé€‚é…å™¨RaspberryPieAdaptorï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RaspberryPieAdaptor</span> <span class="keyword">extends</span> <span class="title">Raspberry</span> <span class="keyword">implements</span> <span class="title">Pie</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åˆ¶ä½œä¸€ä¸ªæ´¾ğŸ¥§"</span>);</span><br><span class="line">        <span class="keyword">super</span>.addRaspberry();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é€‚é…å™¨ç»§æ‰¿è¢«é€‚é…çš„ç±»ï¼Œå®ç°æ–°çš„äº§å“çº¿æ¥å£ã€‚</p><p>åœ¨Applicationé‡Œæµ‹è¯•ä¸€æ³¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Pie pie = <span class="keyword">new</span> RaspberryPieAdaptor();</span><br><span class="line">        pie.make();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">åˆ¶ä½œä¸€ä¸ªæ´¾ğŸ¥§</span><br><span class="line">æ·»åŠ ç‚¹æ ‘è“</span><br></pre></td></tr></table></figure><p></p><p>æˆåŠŸé€šè¿‡é€‚é…å™¨åˆ¶é€ äº†æ ‘è“æ´¾ã€‚ç±»é€‚é…å™¨æ¨¡å¼çš„UMLå›¾å¾ˆç®€å•ï¼š</p><p><img src="img/QQæˆªå›¾20191219105058.png" alt="QQæˆªå›¾20191219105058.png"></p><p>å¯¹è±¡é€‚é…å™¨æ¨¡å¼åªéœ€è¦å°†RaspberryPieAdaptorä¿®æ”¹ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RaspberryPieAdaptor</span> <span class="keyword">implements</span> <span class="title">Pie</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Raspberry raspberry = <span class="keyword">new</span> Raspberry();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åˆ¶ä½œä¸€ä¸ªæ´¾ğŸ¥§"</span>);</span><br><span class="line">        raspberry.addRaspberry();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿™ç§æ¨¡å¼ä¸ç›´æ¥ç»§æ‰¿è¢«é€‚é…è€…ï¼Œè€Œæ˜¯åœ¨é€‚é…å™¨é‡Œåˆ›å»ºè¢«é€‚é…è€…ã€‚è¿™ç§æ¨¡å¼çš„UMLå›¾ï¼š</p><p><img src="img/QQæˆªå›¾20191219110730.png" alt="QQæˆªå›¾20191219110730.png"></p><h3 id="äº«å…ƒæ¨¡å¼"><a href="#äº«å…ƒæ¨¡å¼" class="headerlink" title="äº«å…ƒæ¨¡å¼"></a>äº«å…ƒæ¨¡å¼</h3><p>æä¾›äº†å‡å°‘å¯¹è±¡æ•°é‡ä»è€Œæ”¹å–„åº”ç”¨æ‰€éœ€çš„å¯¹è±¡ç»“æ„çš„æ–¹å¼ï¼Œè¿ç”¨å…±äº«æŠ€æœ¯æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦çš„å¯¹è±¡ã€‚</p><p>é€‚ç”¨äºï¼š</p><ol><li>åº•å±‚ç³»ç»Ÿå¼€å‘ï¼Œè§£å†³æ€§èƒ½é—®é¢˜ï¼›</li><li>ç³»ç»Ÿæ‹¥æœ‰å¤§é‡ç›¸ä¼¼å¯¹è±¡ï¼Œéœ€è¦ç¼“å†²æ± çš„åœºæ™¯ã€‚</li></ol><p>ä¼˜ç‚¹ï¼š</p><ol><li>å‡å°‘å¯¹è±¡çš„åˆ›å»ºï¼Œé™ä½å†…å­˜å ç”¨ï¼›</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>å…³æ³¨å†…/å¤–éƒ¨çŠ¶æ€ï¼Œå…³æ³¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›</li><li>ç¨‹åºçš„é€»è¾‘å¤æ‚åŒ–ã€‚</li></ol><p>å†…éƒ¨çŠ¶æ€ï¼šç®€å•ç†è§£ä¸ºäº«å…ƒå¯¹è±¡çš„å±æ€§çŠ¶æ€ï¼Œä¸ä¼šå› ä¸ºå¤–éƒ¨çš„æ”¹å˜è€Œæ”¹å˜ï¼› å¤–éƒ¨çŠ¶æ€ï¼šç®€å•ç†è§£ä¸ºæ–¹æ³•å‚æ•°ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ–°å»ºæ´¾ğŸ¥§æ¥å£Pieï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Pie</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">make</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å…¶å®ç°ç±»æ°´æœæ´¾FruitPieï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitPie</span> <span class="keyword">implements</span> <span class="title">Pie</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime productTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FruitPie</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProductTime</span><span class="params">(LocalDateTime productTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.productTime = productTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            System.out.println(name + <span class="string">"ç”Ÿäº§æ—¶é—´ï¼š"</span> + <span class="keyword">this</span>.productTime);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åŒ…å«åç§°å’Œç”Ÿäº§æ—¥æœŸå±æ€§ï¼Œå¹¶ä¸”æœ‰ä¸ªmakeæ–¹æ³•ã€‚</p><p>æ¥ç€åˆ›å»ºç”Ÿäº§FruitPieçš„å·¥å‚FruitPieFactoryï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitPieFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HashMap&lt;String, FruitPie&gt; PIE_HASH_MAP = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FruitPie <span class="title">produce</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        FruitPie fruitPie = PIE_HASH_MAP.get(name);</span><br><span class="line">        <span class="keyword">if</span> (fruitPie == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"æ²¡æœ‰"</span> + name + <span class="string">"åˆ¶ä½œæ–¹æ³•ï¼Œå­¦ä¹ åˆ¶ä½œ..."</span>);</span><br><span class="line">            fruitPie = <span class="keyword">new</span> FruitPie(name);</span><br><span class="line">            PIE_HASH_MAP.put(name, fruitPie);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fruitPie;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä»£ç å…³é”®æ˜¯é€šè¿‡HashMapå­˜å‚¨å¯¹è±¡ã€‚</p><p>ç¼–å†™ä¸ªæµ‹è¯•ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] PIE = &#123;<span class="string">"ğŸ‡æ´¾"</span>, <span class="string">"ğŸˆæ´¾"</span>, <span class="string">"ğŸ“æ´¾"</span>, <span class="string">"ğŸ’æ´¾"</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">10</span>).forEach((i) -&gt; &#123;</span><br><span class="line">            String name = PIE[(<span class="keyword">int</span>) (Math.random() * PIE.length)];</span><br><span class="line">            FruitPie fruitPie = FruitPieFactory.produce(name);</span><br><span class="line">            fruitPie.setProductTime(LocalDateTime.now());</span><br><span class="line">            fruitPie.make();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">æ²¡æœ‰ğŸ“æ´¾åˆ¶ä½œæ–¹æ³•ï¼Œå­¦ä¹ åˆ¶ä½œ...</span><br><span class="line">ğŸ“æ´¾ç”Ÿäº§æ—¶é—´ï¼š2019-12-19T16:13:26.397</span><br><span class="line">æ²¡æœ‰ğŸ‡æ´¾åˆ¶ä½œæ–¹æ³•ï¼Œå­¦ä¹ åˆ¶ä½œ...</span><br><span class="line">ğŸ‡æ´¾ç”Ÿäº§æ—¶é—´ï¼š2019-12-19T16:13:26.498</span><br><span class="line">ğŸ‡æ´¾ç”Ÿäº§æ—¶é—´ï¼š2019-12-19T16:13:26.599</span><br><span class="line">æ²¡æœ‰ğŸ’æ´¾åˆ¶ä½œæ–¹æ³•ï¼Œå­¦ä¹ åˆ¶ä½œ...</span><br><span class="line">ğŸ’æ´¾ç”Ÿäº§æ—¶é—´ï¼š2019-12-19T16:13:26.700</span><br><span class="line">ğŸ’æ´¾ç”Ÿäº§æ—¶é—´ï¼š2019-12-19T16:13:26.800</span><br><span class="line">ğŸ’æ´¾ç”Ÿäº§æ—¶é—´ï¼š2019-12-19T16:13:26.901</span><br><span class="line">æ²¡æœ‰ğŸˆæ´¾åˆ¶ä½œæ–¹æ³•ï¼Œå­¦ä¹ åˆ¶ä½œ...</span><br><span class="line">ğŸˆæ´¾ç”Ÿäº§æ—¶é—´ï¼š2019-12-19T16:13:27.002</span><br><span class="line">ğŸ“æ´¾ç”Ÿäº§æ—¶é—´ï¼š2019-12-19T16:13:27.103</span><br><span class="line">ğŸ‡æ´¾ç”Ÿäº§æ—¶é—´ï¼š2019-12-19T16:13:27.203</span><br><span class="line">ğŸ‡æ´¾ç”Ÿäº§æ—¶é—´ï¼š2019-12-19T16:13:27.304</span><br></pre></td></tr></table></figure><p></p><p>ä»ç»“æœçœ‹ï¼Œåœ¨10æ¬¡å¾ªç¯ä¸­ï¼Œåªç”Ÿäº§äº†4ä¸ªå¯¹è±¡ï¼Œè¿™å¾ˆå¥½çš„æè¿°äº†ç³»ç»Ÿæœ‰å¤§é‡ç›¸ä¼¼å¯¹è±¡ï¼Œéœ€è¦ç¼“å†²æ± çš„åœºæ™¯ã€‚</p><p>JDKä¸­çš„å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œæ•°æ®åº“è¿æ¥æ± ç­‰éƒ½æ˜¯ç”¨çš„äº«å…ƒæ¨¡å¼ã€‚</p><h3 id="ç»„åˆæ¨¡å¼"><a href="#ç»„åˆæ¨¡å¼" class="headerlink" title="ç»„åˆæ¨¡å¼"></a>ç»„åˆæ¨¡å¼</h3><p>å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ä»¥è¡¨ç¤ºâ€œéƒ¨åˆ†-æ•´ä½“â€çš„å±‚æ¬¡ç»“æ„ï¼Œä½¿å®¢æˆ·ç«¯å¯¹å•ä¸ªå¯¹è±¡å’Œç»„åˆå¯¹è±¡ä¿æŒä¸€è‡´çš„æ–¹å¼å¤„ç†ã€‚</p><p>é€‚ç”¨äºï¼š</p><ol><li>å®¢æˆ·ç«¯å¯ä»¥å¿½ç•¥ç»„åˆå¯¹è±¡ä¸å•ä¸ªå¯¹è±¡çš„å·®å¼‚ï¼›</li><li>å¤„ç†æ ‘å½¢ç»“æ„æ•°æ®ã€‚</li></ol><p>ä¼˜ç‚¹:</p><ol><li>å±‚æ¬¡æ¸…æ™°ï¼›</li><li>å®¢æˆ·ç«¯ä¸å¿…å…³ç³»å±‚æ¬¡å·®å¼‚ï¼Œæ–¹ä¾¿æ§åˆ¶ï¼›</li><li>ç¬¦åˆå¼€é—­åŸåˆ™ã€‚</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>æ ‘å½¢å¤„ç†è¾ƒä¸ºå¤æ‚ã€‚</li></ol><p>ä¸¾ä¸ªèœå•æŒ‰é’®ç»„æˆçš„æ ‘å½¢ä¾‹å­ã€‚</p><p>æ–°å»ºèœå•æŒ‰é’®çš„ç»„åˆæŠ½è±¡ç±»AbstractMenuButtonï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMenuButton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(AbstractMenuButton abstractMenuButton)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"ä¸æ”¯æŒåˆ›å»ºæ“ä½œ"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"ä¸æ”¯æŒåç§°è·å–"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"ä¸æ”¯æŒç±»å‹è·å–"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIcon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"ä¸æ”¯æŒå›¾æ ‡"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"ä¸æ”¯æŒæ‰“å°æ“ä½œ"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç»„åˆäº†èœå•æŒ‰é’®æ“ä½œçš„åŸºæœ¬æ–¹æ³•ã€‚</p><p>æ–°å¢æŒ‰é’®ç±»Buttonï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Button</span> <span class="keyword">extends</span> <span class="title">AbstractMenuButton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Button</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"æŒ‰é’®"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(getName() + <span class="string">"ã€"</span> + getType() + <span class="string">"ã€‘"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æŒ‰é’®æ‹¥æœ‰åç§°å±æ€§ï¼Œå¹¶ä¸”æ”¯æŒåç§°è·å–ï¼Œç±»å‹è·å–å’Œæ‰“å°æ–¹æ³•ï¼Œæ‰€ä»¥é‡å†™äº†è¿™ä¸‰ä¸ªçˆ¶ç±»æ–¹æ³•ã€‚</p><p>æ¥ç€æ–°å»ºèœå•ç±»Menuï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Menu</span> <span class="keyword">extends</span> <span class="title">AbstractMenuButton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;AbstractMenuButton&gt; items = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">    <span class="keyword">private</span> Integer level;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Menu</span><span class="params">(String name, String icon, Integer level)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.icon = icon;</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(AbstractMenuButton abstractMenuButton)</span> </span>&#123;</span><br><span class="line">        items.add(abstractMenuButton);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"èœå•"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIcon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.icon;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(getIcon() + getName() + <span class="string">"ã€"</span> + getType() + <span class="string">"ã€‘"</span>);</span><br><span class="line">        <span class="keyword">for</span> (AbstractMenuButton item : items) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.level != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.level; i++) &#123;</span><br><span class="line">                    System.out.print(<span class="string">"    "</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            item.print();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>èœå•åŒ…å«åç§°ã€å›¾æ ‡å’Œå±‚çº§å±æ€§ï¼Œå¹¶ä¸”èœå•å¯ä»¥åŒ…å«ä¸‹çº§ï¼ˆæ¯”å¦‚ä¸‹çº§èœå•ï¼Œä¸‹çº§æŒ‰é’®ï¼‰ï¼Œæ‰€ä»¥å®ƒåŒ…å«ä¸€ä¸ªList<abstractmenubutton>ç±»å‹çš„å±æ€§itemsã€‚</abstractmenubutton></p><p>æ­¤å¤–ï¼Œèœå•åŒ…å«æ·»åŠ ä¸‹çº§ã€åç§°è·å–ã€ç±»å‹è·å–ã€å›¾æ ‡è·å–å’Œæ‰“å°æ–¹æ³•ã€‚</p><p>æ–°å»ºä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œæµ‹è¯•èœå•æŒ‰é’®çš„å±‚çº§ç»“æ„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Menu userMenu = <span class="keyword">new</span> Menu(<span class="string">"ç”¨æˆ·ç®¡ç†"</span>, <span class="string">"ğŸ§‘"</span>, <span class="number">2</span>);</span><br><span class="line">        Button createUser = <span class="keyword">new</span> Button(<span class="string">"æ–°å¢ç”¨æˆ·"</span>);</span><br><span class="line">        Button updateUser = <span class="keyword">new</span> Button(<span class="string">"ä¿®æ”¹ç”¨æˆ·"</span>);</span><br><span class="line">        Button deleteUser = <span class="keyword">new</span> Button(<span class="string">"åˆ é™¤ç”¨æˆ·"</span>);</span><br><span class="line">        userMenu.add(createUser);</span><br><span class="line">        userMenu.add(updateUser);</span><br><span class="line">        userMenu.add(deleteUser);</span><br><span class="line"></span><br><span class="line">        Menu logMenu = <span class="keyword">new</span> Menu(<span class="string">"æ“ä½œæ—¥å¿—"</span>, <span class="string">"ğŸ“ƒ"</span>, <span class="number">2</span>);</span><br><span class="line">        Button export = <span class="keyword">new</span> Button(<span class="string">"å¯¼å‡ºExcel"</span>);</span><br><span class="line">        logMenu.add(export);</span><br><span class="line"></span><br><span class="line">        Menu systemMenu = <span class="keyword">new</span> Menu(<span class="string">"ç³»ç»Ÿç®¡ç†"</span>, <span class="string">"ğŸ”¨"</span>, <span class="number">1</span>);</span><br><span class="line">        systemMenu.add(userMenu);</span><br><span class="line">        systemMenu.add(logMenu);</span><br><span class="line"></span><br><span class="line">        systemMenu.print();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ‰“å°è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ğŸ”¨ç³»ç»Ÿç®¡ç†ã€èœå•ã€‘</span><br><span class="line">    ğŸ§‘ç”¨æˆ·ç®¡ç†ã€èœå•ã€‘</span><br><span class="line">        æ–°å¢ç”¨æˆ·ã€æŒ‰é’®ã€‘</span><br><span class="line">        ä¿®æ”¹ç”¨æˆ·ã€æŒ‰é’®ã€‘</span><br><span class="line">        åˆ é™¤ç”¨æˆ·ã€æŒ‰é’®ã€‘</span><br><span class="line">    ğŸ“ƒæ“ä½œæ—¥å¿—ã€èœå•ã€‘</span><br><span class="line">        å¯¼å‡ºExcelã€æŒ‰é’®ã€‘</span><br></pre></td></tr></table></figure><p></p><p>UMLå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191219190427.png" alt="QQæˆªå›¾20191219190427.png"></p><h3 id="æ¡¥æ¥æ¨¡å¼"><a href="#æ¡¥æ¥æ¨¡å¼" class="headerlink" title="æ¡¥æ¥æ¨¡å¼"></a>æ¡¥æ¥æ¨¡å¼</h3><p>å°†æŠ½è±¡éƒ¨åˆ†å’Œå…·ä½“å®ç°éƒ¨åˆ†åˆ†ç¦»ï¼Œä½¿å®ƒä»¬éƒ½å¯ä»¥ç‹¬ç«‹å˜åŒ–ã€‚é€šè¿‡ç»„åˆçš„æ–¹å¼å»ºç«‹ä¸¤ä¸ªç±»ä¹‹é—´çš„å…³ç³»ï¼Œè€Œä¸æ˜¯é€šè¿‡ç»§æ‰¿ã€‚</p><p>é€‚ç”¨äºï¼š</p><ol><li>æŠ½è±¡å’Œå®ä½“å®ç°ä¹‹é—´å¢åŠ æ›´å¤šçš„çµæ´»æ€§ï¼›</li><li>ä¸€ä¸ªç±»å­˜åœ¨å¤šä¸ªç‹¬ç«‹å˜åŒ–çš„ç»´åº¦ï¼Œå¹¶ä¸”éœ€è¦ç‹¬ç«‹æ‹“å±•ï¼›</li><li>ä¸å¸Œæœ›ä½¿ç”¨ç»§æ‰¿ã€‚</li></ol><p>ä¼˜ç‚¹ï¼š</p><ol><li>åˆ†ç¦»æŠ½è±¡éƒ¨åˆ†å’Œå…·ä½“å®ç°éƒ¨åˆ†ï¼›</li><li>æé«˜äº†ç³»ç»Ÿå¯æ‹“å±•æ€§ï¼›</li><li>ç¬¦åˆå¼€é—­åŸåˆ™å’Œåˆæˆå¤ç”¨åŸåˆ™ã€‚</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>å¢åŠ äº†ç³»ç»Ÿçš„ç†è§£å’Œè®¾è®¡éš¾åº¦ï¼›</li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p>ç°æœ‰æ´¾çš„æ¥å£ç±»Pieï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Pie</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Pie <span class="title">makePie</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getType</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åŒ…å«åˆ¶ä½œæ´¾å’Œè·å–æ´¾ç±»å‹æŠ½è±¡æ–¹æ³•ã€‚</p><p>æ¥ç€åˆ›å»ºä¸¤ä¸ªPieçš„å®ç°ç±»ï¼Œè‹¹æœæ´¾AppliePieï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplePie</span> <span class="keyword">implements</span> <span class="title">Pie</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pie <span class="title">makePie</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åˆ¶ä½œè‹¹æœæ´¾ğŸğŸ¥§"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApplePie();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"æ°´æœæ´¾"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>èƒ¡èåœæ´¾CarrotPieï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CarrotPie</span> <span class="keyword">implements</span> <span class="title">Pie</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pie <span class="title">makePie</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åˆ¶ä½œèƒ¡èåœæ´¾ğŸ¥•ğŸ¥§"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CarrotPie();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"è”¬èœæ²™æ‹‰æ´¾"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€åˆ›å»ºä¸€ä¸ªåº—é“ºæŠ½è±¡ç±»Storeï¼Œé€šè¿‡å±æ€§çš„æ–¹å¼å’ŒPieç›¸å…³è”ï¼Œç›®çš„æ˜¯å¯ä»¥åœ¨ä¸åŒçš„åº—é“ºå®ç°ç±»ä¸­çµæ´»åœ°åˆ¶ä½œå„ç§æ´¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Store</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Pie pie;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Store</span><span class="params">(Pie pie)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pie = pie;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> Pie <span class="title">makePie</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>Storeå­ç±»ä¹‹ä¸€ï¼Œå±±å§†å¤§å”çš„å°åº—SamStoreï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SamStore</span> <span class="keyword">extends</span> <span class="title">Store</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SamStore</span><span class="params">(Pie pie)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(pie);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Pie <span class="title">makePie</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.print(<span class="string">"å±±å§†å¤§å”çš„å°åº—ğŸ’’"</span>);</span><br><span class="line">        <span class="keyword">return</span> pie.makePie();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>Storeå­ç±»ä¹‹äºŒï¼Œæ°å…‹çš„å°åº—JackStoreï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JackStore</span> <span class="keyword">extends</span> <span class="title">Store</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JackStore</span><span class="params">(Pie pie)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(pie);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Pie <span class="title">makePie</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.print(<span class="string">"æ°å…‹çš„å°åº—ğŸ’’"</span>);</span><br><span class="line">        <span class="keyword">return</span> pie.makePie();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œæµ‹è¯•Pieçš„å®ç°ç±»å’ŒStoreçš„ç»§æ‰¿ç±»ä¹‹é—´çš„è‡ªç”±ç»„åˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Store samStore = <span class="keyword">new</span> SamStore(<span class="keyword">new</span> ApplePie());</span><br><span class="line">        Pie samStorePie = samStore.makePie();</span><br><span class="line">        samStorePie.getType();</span><br><span class="line"></span><br><span class="line">        Store jackStore = <span class="keyword">new</span> JackStore(<span class="keyword">new</span> CarrotPie());</span><br><span class="line">        Pie jackStorePie = jackStore.makePie();</span><br><span class="line">        jackStorePie.getType();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å±±å§†å¤§å”çš„å°åº—ğŸ’’åˆ¶ä½œè‹¹æœæ´¾ğŸğŸ¥§</span><br><span class="line">æ°´æœæ´¾</span><br><span class="line">æ°å…‹çš„å°åº—ğŸ’’åˆ¶ä½œèƒ¡èåœæ´¾ğŸ¥•ğŸ¥§</span><br><span class="line">è”¬èœæ²™æ‹‰æ´¾</span><br></pre></td></tr></table></figure><p></p><p>è¿™ä¸ªä¾‹å­å¾ˆå¥½åœ°ä½“ç°äº†æ¡¥æ¥æ¨¡å¼çš„ç‰¹ç‚¹ï¼ŒUMLå›¾å¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20191220151943.png" alt="QQæˆªå›¾20191220151943.png"></p><h3 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h3><p>ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ï¼Œä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ï¼Œä»£ç†å¯¹è±¡åœ¨å®¢æˆ·ç«¯å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°äº†ä¸­ä»‹çš„ä½œç”¨ã€‚</p><p>é€‚ç”¨äºï¼š</p><ol><li>ä¿æŠ¤ç›®æ ‡å¯¹è±¡ï¼›</li><li>å¢å¼ºç›®æ ‡å¯¹è±¡ã€‚</li></ol><p>ä¼˜ç‚¹ï¼š</p><ol><li>å°†ä»£ç†å¯¹è±¡å’ŒçœŸå®è¢«è°ƒç”¨çš„ç›®æ ‡å¯¹è±¡åˆ†ç¦»ï¼›</li><li>é™ä½è€¦åˆï¼Œæ‹“å±•æ€§å¥½ï¼›</li><li>ä¿æŠ¤ç›®æ ‡å¯¹è±¡ï¼Œå¢å¼ºç›®æ ‡å¯¹è±¡ã€‚</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>é€ æˆç±»çš„æ•°ç›®å¢åŠ ï¼Œå¢åŠ å¤æ‚åº¦ï¼›</li><li>å®¢æˆ·ç«¯å’Œç›®æ ‡å¯¹è±¡å¢åŠ ä»£ç†å¯¹è±¡ï¼Œä¼šé€ æˆå¤„ç†é€Ÿåº¦å˜æ…¢ã€‚</li></ol><h4 id="é™æ€ä»£ç†"><a href="#é™æ€ä»£ç†" class="headerlink" title="é™æ€ä»£ç†"></a>é™æ€ä»£ç†</h4><p>é€šè¿‡åœ¨ä»£ç ä¸­æ˜¾å¼åœ°å®šä¹‰äº†ä¸€ä¸ªä»£ç†ç±»ï¼Œåœ¨ä»£ç†ç±»ä¸­é€šè¿‡åŒåçš„æ–¹æ³•å¯¹ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•è¿›è¡ŒåŒ…è£…ï¼Œå®¢æˆ·ç«¯é€šè¿‡è°ƒç”¨ä»£ç†ç±»çš„æ–¹æ³•æ¥è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚</p><p>ä¸¾ä¸ªé™æ€ä»£ç†çš„ä¾‹å­ï¼š</p><p>æ–°å»ºä¸€ä¸ªæ´¾çš„åˆ¶ä½œæ¥å£PieServiceï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PieServcie</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">makePie</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºå…¶å®ç°ç±»PieServiceImplï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PieServiceImpl</span> <span class="keyword">implements</span> <span class="title">PieServcie</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makePie</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åˆ¶ä½œğŸ¥—æ´¾"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¦å¯¹PieServiceImplçš„<code>makePie</code>æ–¹æ³•å¢å¼ºï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡PieServiceProxyï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PieServiceProxy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PieServcie pieServcie;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makePie</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        beforeMethod();</span><br><span class="line">        pieServcie = <span class="keyword">new</span> PieServiceImpl();</span><br><span class="line">        pieServcie.makePie();</span><br><span class="line">        afterMethod();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">beforeMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"å‡†å¤‡ææ–™"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">afterMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ä¿é²œ"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨PieServiceProxyä¸­æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå’ŒPieServcieä¸€è‡´çš„åŒåæ–¹æ³•<code>makePie</code>ï¼Œæ–¹æ³•å†…éƒ¨è°ƒç”¨äº†PieServiceImplçš„<code>makePie</code>æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨æ–¹æ³•è°ƒç”¨å‰è°ƒç”¨äº†ä»£ç†ç±»çš„<code>beforeMethod</code>æ–¹æ³•ï¼Œæ–¹æ³•è°ƒç”¨åè°ƒç”¨äº†ä»£ç†ç±»çš„<code>afterMethod</code>æ–¹æ³•ã€‚</p><p>åˆ›å»ºå®¢æˆ·ç«¯Applicationï¼Œæµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        PieServiceProxy proxy = <span class="keyword">new</span> PieServiceProxy();</span><br><span class="line">        proxy.makePie();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å‡†å¤‡ææ–™</span><br><span class="line">åˆ¶ä½œğŸ¥—æ´¾</span><br><span class="line">ä¿é²œ</span><br></pre></td></tr></table></figure><p></p><p>è¿™ä¸ªä¾‹å­çš„UMLå›¾å¦‚ä¸‹ï¼š</p><p><img src="img/QQ20200421-100633@2x.png" alt="QQ20200421-100633@2x"></p><h4 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h4><p>JDKçš„åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†æ¥å£ï¼Œé€šè¿‡æ¥å£çš„æ–¹æ³•ååœ¨åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»ä¸­è°ƒç”¨ä¸šåŠ¡å®ç°ç±»çš„åŒåæ–¹æ³•ã€‚</p><p>é™æ€ä»£ç†çš„ç¼ºç‚¹å°±æ˜¯æ¯éœ€è¦ä»£ç†ä¸€ä¸ªç±»ï¼Œå°±éœ€è¦æ‰‹å†™å¯¹åº”çš„ä»£ç†ç±»ã€‚è¿™ä¸ªé—®é¢˜å¯ä»¥ç”¨åŠ¨æ€ä»£ç†æ¥è§£å†³ã€‚ä¸¾ä¸ªåŠ¨æ€ä»£ç†çš„ä¾‹å­ï¼š</p><p>æ–°å»ºå†°æ·‡æ·‹åˆ¶ä½œæ¥å£IceCreamServiceï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IceCreamService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">makeIceCream</span><span class="params">(String fruit)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å®ç°ç±»IceCreamServiceImplï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IceCreamServiceImpl</span> <span class="keyword">implements</span> <span class="title">IceCreamService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeIceCream</span><span class="params">(String fruit)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åˆ¶ä½œ"</span> + fruit + <span class="string">"ğŸ¦"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç°åœ¨éœ€è¦å¯¹IceCreamServiceImplè¿›è¡Œä»£ç†å¢å¼ºï¼Œå¦‚æœä½¿ç”¨é™æ€ä»£ç†ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªIceCreamServiceImplProxyç±»ï¼Œä½¿ç”¨åŠ¨æ€ä»£ç†çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€ç”Ÿæˆå¯¹åº”çš„ä»£ç†ç±»ã€‚</p><p>åˆ›å»ºDynamicProxyï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»£ç†çš„ç›®æ ‡å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicProxy</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.object = object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">proxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; clazz = object.getClass();</span><br><span class="line">        <span class="comment">// ç”Ÿæˆä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(clazz.getClassLoader(),</span><br><span class="line">                clazz.getInterfaces(), <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> proxy  åŠ¨æ€ç”Ÿæˆçš„ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method ä»£ç†æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args   ä»£ç†æ–¹æ³•çš„æ–¹æ³•å‚æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ç»“æœ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åŠ¨æ€ä»£ç†ç±»é€šè¿‡å®ç°InvocationHandlerçš„<code>invoke</code>æ–¹æ³•å®ç°ï¼Œ<code>proxy</code>ç”¨äºç”Ÿæˆä»£ç†å¯¹è±¡ã€‚å‰©ä¸‹çš„æ­¥éª¤å’Œé™æ€ä»£ç†ç±»ä¼¼ï¼Œå®Œå–„DynamicProxyï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»£ç†çš„ç›®æ ‡å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicProxy</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.object = object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">proxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; clazz = object.getClass();</span><br><span class="line">        <span class="comment">// ç”Ÿæˆä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(clazz.getClassLoader(),</span><br><span class="line">                clazz.getInterfaces(), <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> proxy  åŠ¨æ€ç”Ÿæˆçš„ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method ä»£ç†æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args   ä»£ç†æ–¹æ³•çš„æ–¹æ³•å‚æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ç»“æœ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        beforeMethod(object);</span><br><span class="line">        <span class="comment">// åå°„æ‰§è¡Œä»£ç†å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•</span></span><br><span class="line">        Object result = method.invoke(object, args);</span><br><span class="line">        afterMethod(object);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">beforeMethod</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> PieServcie) &#123;</span><br><span class="line">            System.out.println(<span class="string">"å‡†å¤‡æ´¾çš„ææ–™"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> IceCreamService) &#123;</span><br><span class="line">            System.out.println(<span class="string">"å‡†å¤‡å†°æ·‡æ·‹ææ–™"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"æš‚ä¸æ”¯æŒä»£ç†"</span> + object.getClass() + <span class="string">"ç±»å‹"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">afterMethod</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> PieServcie) &#123;</span><br><span class="line">            System.out.println(<span class="string">"ä¿é²œæ´¾"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> IceCreamService) &#123;</span><br><span class="line">            System.out.println(<span class="string">"ä¿é²œå†°æ·‡æ·‹"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"æš‚ä¸æ”¯æŒä»£ç†"</span> + object.getClass() + <span class="string">"ç±»å‹"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå®¢æˆ·ç«¯Applicationæµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        PieServcie pieServiceDynamicProxy = (PieServcie) <span class="keyword">new</span> DynamicProxy(<span class="keyword">new</span> PieServiceImpl()).proxy();</span><br><span class="line">        pieServiceDynamicProxy.makePie();</span><br><span class="line">        System.out.println(<span class="string">"-----------------"</span>);</span><br><span class="line">        IceCreamService iceCreamServiceDynamicProxy = (IceCreamService) <span class="keyword">new</span> DynamicProxy(<span class="keyword">new</span> IceCreamServiceImpl()).proxy();</span><br><span class="line">        iceCreamServiceDynamicProxy.makeIceCream(<span class="string">"ğŸ“"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å‡†å¤‡æ´¾çš„ææ–™</span><br><span class="line">åˆ¶ä½œğŸ¥—æ´¾</span><br><span class="line">ä¿é²œæ´¾</span><br><span class="line">-----------------</span><br><span class="line">å‡†å¤‡å†°æ·‡æ·‹ææ–™</span><br><span class="line">åˆ¶ä½œğŸ“ğŸ¦</span><br><span class="line">ä¿é²œå†°æ·‡æ·‹</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡åŠ¨æ€ä»£ç†æˆ‘ä»¬å®ç°äº†ç›®æ ‡æ–¹æ³•å¢å¼ºï¼Œå¹¶ä¸”ä¸éœ€è¦æ‰‹å†™ç›®æ ‡ç±»çš„ä»£ç†å¯¹è±¡ã€‚</p><h4 id="CGLibä»£ç†"><a href="#CGLibä»£ç†" class="headerlink" title="CGLibä»£ç†"></a>CGLibä»£ç†</h4><p>é€šè¿‡ç»§æ‰¿æ¥å®ç°ï¼Œç”Ÿæˆçš„ä»£ç†ç±»å°±æ˜¯ç›®æ ‡å¯¹è±¡ç±»çš„å­ç±»ï¼Œé€šè¿‡é‡å†™ä¸šåŠ¡æ–¹æ³•æ¥å®ç°ä»£ç†ã€‚</p><h4 id="Springå¯¹ä»£ç†æ¨¡å¼çš„æ‹“å±•"><a href="#Springå¯¹ä»£ç†æ¨¡å¼çš„æ‹“å±•" class="headerlink" title="Springå¯¹ä»£ç†æ¨¡å¼çš„æ‹“å±•"></a>Springå¯¹ä»£ç†æ¨¡å¼çš„æ‹“å±•</h4><ol><li>å½“Beanæœ‰å®ç°æ¥å£æ—¶ï¼Œä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼›</li><li>å½“Beanæ²¡æœ‰å®ç°æ¥å£æ—¶ï¼Œä½¿ç”¨CGLibä»£ç†ã€‚</li></ol><p>å¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®å¼ºåˆ¶ä½¿ç”¨CGLibä»£ç†ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  aop:</span></span><br><span class="line"><span class="attr">    proxy-target-class:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p></p><h2 id="è¡Œä¸ºå‹æ¨¡å¼"><a href="#è¡Œä¸ºå‹æ¨¡å¼" class="headerlink" title="è¡Œä¸ºå‹æ¨¡å¼"></a>è¡Œä¸ºå‹æ¨¡å¼</h2><h3 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"></a>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h3><p>æ¨¡æ¿æ–¹æ³•æ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªæµç¨‹çš„éª¨æ¶ï¼Œç”±å¤šä¸ªæ–¹æ³•ç»„æˆã€‚å¹¶å…è®¸å­ç±»ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªæ­¥éª¤æä¾›å®ç°ã€‚ç®€è€Œè¨€ä¹‹å°±æ˜¯å…¬å…±çš„ä¸å˜çš„éƒ¨åˆ†ç”±çˆ¶ç±»ç»Ÿä¸€å®ç°ï¼Œå˜åŒ–çš„éƒ¨åˆ†ç”±å­ç±»æ¥ä¸ªæ€§åŒ–å®ç°ã€‚</p><p>ä¼˜ç‚¹ï¼š</p><ol><li>æé«˜å¤ç”¨æ€§ï¼›</li><li>æé«˜æ‹“å±•æ€§ï¼›</li><li>ç¬¦åˆå¼€é—­åŸåˆ™ã€‚</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>ç±»çš„æ•°ç›®å¢åŠ ï¼›</li><li>å¢åŠ äº†ç³»ç»Ÿå®ç°çš„å¤æ‚åº¦ï¼›</li><li>çˆ¶ç±»æ·»åŠ æ–°çš„æŠ½è±¡æ–¹æ³•ï¼Œæ‰€æœ‰å­ç±»éƒ½è¦æ”¹ä¸€éã€‚</li></ol><p>ä¸¾ä¸ªæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ä¾‹å­ã€‚å®šä¹‰ä¸€ä¸ªå¤–å–çš„æ¥å£ï¼ŒåŒ…å«ä¸‹å•ã€åˆ¶ä½œå’Œæ‰“åŒ…é…é€ä¸‰ä¸ªæ­¥éª¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Takeaway</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">order</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ä¸‹å•"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">packageSend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"æ‰“åŒ…æ´¾é€"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">needTableware</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">flow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.order();</span><br><span class="line">        <span class="keyword">this</span>.make();</span><br><span class="line">        <span class="keyword">if</span> (needTableware()) &#123;</span><br><span class="line">            System.out.println(<span class="string">"èµ é€ä¸€æ¬¡æ€§é¤å…·"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.packageSend();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å…¶ä¸­ä¸‹å•å’Œæ‰“åŒ…é…é€è¡Œä¸ºæ˜¯å›ºå®šçš„ï¼Œä¸åŒçš„æ˜¯åˆ¶ä½œè¿‡ç¨‹ï¼Œæ‰€ä»¥<code>order</code>å’Œ<code>packageSend</code>æ–¹æ³•æä¾›äº†é»˜è®¤å®ç°ï¼Œå¹¶ä¸”ç”±finalä¿®é¥°ï¼Œå­ç±»ä¸å¯é‡å†™ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡<code>needTableware</code>è¿™ä¸ªé’©å­æ–¹æ³•æ¥æ§åˆ¶æŸäº›å­ç±»çš„å®šåˆ¶åŒ–éœ€æ±‚ã€‚</p><p>æ–°å¢BarbecueTakeawayç»§æ‰¿Takeawayï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BarbecueTakeaway</span> <span class="keyword">extends</span> <span class="title">Takeaway</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> needTableware;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BarbecueTakeaway</span><span class="params">(<span class="keyword">boolean</span> needTableware)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.needTableware = needTableware;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åˆ¶ä½œçƒ¤è‚‰"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">needTableware</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.needTableware;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å¢FruitTakeawayç»§æ‰¿Takeawayï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitTakeaway</span> <span class="keyword">extends</span> <span class="title">Takeaway</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"æ°´æœé…è´§"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">needTableware</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å¢ä¸ªå®¢æˆ·ç«¯Applicationæµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Takeaway barbecue = <span class="keyword">new</span> BarbecueTakeaway(<span class="keyword">true</span>);</span><br><span class="line">        barbecue.flow();</span><br><span class="line"></span><br><span class="line">        FruitTakeaway fruit = <span class="keyword">new</span> FruitTakeaway();</span><br><span class="line">        fruit.flow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹å•</span><br><span class="line">åˆ¶ä½œçƒ¤è‚‰</span><br><span class="line">èµ é€ä¸€æ¬¡æ€§é¤å…·</span><br><span class="line">æ‰“åŒ…æ´¾é€</span><br><span class="line">ä¸‹å•</span><br><span class="line">æ°´æœé…è´§</span><br><span class="line">æ‰“åŒ…æ´¾é€</span><br></pre></td></tr></table></figure><p>UMLï¼š</p><p><img src="img/QQ20200421-153516@2x.png" alt="QQ20200421-153516@2x"></p><h3 id="è¿­ä»£å™¨æ¨¡å¼"><a href="#è¿­ä»£å™¨æ¨¡å¼" class="headerlink" title="è¿­ä»£å™¨æ¨¡å¼"></a>è¿­ä»£å™¨æ¨¡å¼</h3><p>ignore</p><h3 id="ç­–ç•¥æ¨¡å¼"><a href="#ç­–ç•¥æ¨¡å¼" class="headerlink" title="ç­–ç•¥æ¨¡å¼"></a>ç­–ç•¥æ¨¡å¼</h3><p>ç­–ç•¥æ¨¡å¼å®šä¹‰äº†ç®—æ³•å®¶æ—ï¼Œåˆ†åˆ«å°è£…èµ·æ¥ï¼Œè®©å®ƒä»¬ä¹‹é—´å¯ä»¥äº’ç›¸æ›¿æ¢ã€‚æ­¤æ¨¡å¼è®©ç®—æ³•çš„å˜åŒ–ä¸ä¼šå½±å“åˆ°ä½¿ç”¨ç®—æ³•çš„ç”¨æˆ·ã€‚ç­–ç•¥æ¨¡å¼å¸¸ç”¨äºæ¶ˆé™¤å¤§é‡çš„if elseä»£ç ã€‚</p><p>é€‚ç”¨åœºæ™¯ï¼š</p><ol><li>ç³»ç»Ÿæœ‰å¾ˆå¤šç±»ï¼Œå®ƒä»¬çš„åŒºåˆ«ä»…ä»…åœ¨äºè¡Œä¸ºä¸åŒï¼›</li><li>ä¸€ä¸ªç³»ç»Ÿéœ€è¦åŠ¨æ€åœ°åœ¨å‡ ç§ç®—æ³•ä¸­é€‰æ‹©ä¸€ç§ï¼›</li></ol><p>ä¸¾ä¸ªç­–ç•¥æ¨¡å¼çš„ä¾‹å­ï¼ˆä¿ƒé”€æ´»åŠ¨ï¼‰ï¼Œå®šä¹‰ä¸€ä¸ªä¿ƒé”€ç­–ç•¥æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PromotionStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">promotion</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å®ç°ç±»ä¹‹ä¸€ï¼ˆç­–ç•¥ä¹‹ä¸€ï¼‰ï¼Œæ»¡å‡ä¿ƒé”€ç­–ç•¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FullReductionPromotionStrategy</span> <span class="keyword">implements</span> <span class="title">PromotionStrategy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">promotion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"æ»¡1000ç«‹å‡1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å®ç°ç±»ä¹‹ä¸€ï¼ˆç­–ç•¥ä¹‹ä¸€ï¼‰ï¼Œæ‰“æŠ˜ä¿ƒé”€ç­–ç•¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscountPromotionStrategy</span> <span class="keyword">implements</span> <span class="title">PromotionStrategy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">promotion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"9.9æŠ˜é’œæƒ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯æµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿå®¢æˆ·ç«¯ä¼ é€’çš„ä¿ƒé”€ç­–ç•¥key</span></span><br><span class="line">        String promotionKey = <span class="string">"fr"</span>;</span><br><span class="line">        PromotionStrategy strategy;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"fr"</span>.equals(promotionKey)) &#123;</span><br><span class="line">            strategy = <span class="keyword">new</span> FullReductionPromotionStrategy();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"ds"</span>.equals(promotionKey)) &#123;</span><br><span class="line">            strategy = <span class="keyword">new</span> DiscountPromotionStrategy();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"æš‚ä¸æ”¯æŒè¯¥ä¿ƒé”€æ´»åŠ¨"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        strategy.promotion();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ»¡1000ç«‹å‡1</span><br></pre></td></tr></table></figure><p></p><p>ç­–ç•¥æ¨¡å¼å¸¸ç»“åˆå·¥å‚æ¨¡å¼æ¥æ¶ˆé™¤å¤§é‡çš„if elseä»£ç ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªä¿ƒé”€ç­–ç•¥çš„åˆ›å»ºå·¥å‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PromotionStrategyFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, PromotionStrategy&gt; PROMOTION_STRATEGY_MAP = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> PromotionStrategy NON_PROMOTION = () -&gt; System.out.println(<span class="string">"æ— ä¿ƒé”€æ´»åŠ¨"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        PROMOTION_STRATEGY_MAP.put(PromotionKey.FR, <span class="keyword">new</span> FullReductionPromotionStrategy());</span><br><span class="line">        PROMOTION_STRATEGY_MAP.put(PromotionKey.DS, <span class="keyword">new</span> DiscountPromotionStrategy());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">PromotionStrategyFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PromotionStrategy <span class="title">getPromotionStrategy</span><span class="params">(String promotionKey)</span> </span>&#123;</span><br><span class="line">        PromotionStrategy strategy = PROMOTION_STRATEGY_MAP.get(promotionKey);</span><br><span class="line">        <span class="keyword">return</span> strategy == <span class="keyword">null</span> ? NON_PROMOTION : strategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">interface</span> <span class="title">PromotionKey</span> </span>&#123;</span><br><span class="line">        String FR = <span class="string">"fr"</span>;</span><br><span class="line">        String DS = <span class="string">"ds"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡Mapæ¥è£…è½½ä¿ƒé”€ç­–ç•¥ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¯¹è±¡çš„é‡å¤åˆ›å»ºã€‚å¦‚æœä¸å¸Œæœ›åœ¨staticå—ä¸­ä¸€æ¬¡æ€§åˆå§‹åŒ–æ‰€æœ‰ä¿ƒé”€ç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆäº«å…ƒæ¨¡å¼æ¥æ¨è¿Ÿå¯¹è±¡åˆ›å»ºè¿‡ç¨‹ã€‚</p><p>é€šè¿‡è¿™ä¸ªå·¥å‚æ–¹æ³•ï¼Œä¸Šé¢å®¢æˆ·ç«¯ä»£ç å¯ä»¥ç®€å†™ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿå®¢æˆ·ç«¯ä¼ é€’çš„ä¿ƒé”€ç­–ç•¥key</span></span><br><span class="line">        String promotionKey = <span class="string">"fr"</span>;</span><br><span class="line">        PromotionStrategy promotionStrategy = PromotionStrategyFactory.getPromotionStrategy(promotionKey);</span><br><span class="line">        promotionStrategy.promotion();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="è§£é‡Šå™¨æ¨¡å¼"><a href="#è§£é‡Šå™¨æ¨¡å¼" class="headerlink" title="è§£é‡Šå™¨æ¨¡å¼"></a>è§£é‡Šå™¨æ¨¡å¼</h3><p>ç”¨çš„è¾ƒå°‘ï¼Œæš‚ä¸è®°å½•ã€‚</p><h3 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h3><p>è§‚å¯Ÿè€…æ¨¡å¼å®šä¹‰äº†å¯¹è±¡ä¹‹é—´çš„ä¸€å¯¹å¤šä¾èµ–ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…åŒæ—¶ç›‘å¬æŸä¸ªä¸»é¢˜å¯¹è±¡ï¼Œå½“ä¸»ä½“å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒçš„æ‰€æœ‰è§‚å¯Ÿè€…éƒ½ä¼šæ”¶åˆ°å“åº”çš„é€šçŸ¥ã€‚</p><p>ä¼˜ç‚¹ï¼š</p><ol><li>è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ä¹‹é—´å»ºç«‹ä¸€ä¸ªæŠ½è±¡çš„è€¦åˆï¼›</li><li>è§‚å¯Ÿè€…æ¨¡å¼æ”¯æŒå¹¿æ’­é€šä¿¡ã€‚</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>è§‚å¯Ÿè€…ä¹‹é—´æœ‰è¿‡å¤šçš„ç»†èŠ‚ä¾èµ–ï¼Œæé«˜æ—¶é—´æ¶ˆè€—åŠç¨‹åºå¤æ‚åº¦ï¼›</li><li>åº”é¿å…å¾ªç¯è°ƒç”¨ã€‚</li></ol><p>JDKå¯¹è§‚å¯Ÿè€…æ¨¡å¼æä¾›äº†æ”¯æŒã€‚ä¸‹é¢ä¸¾ä¸ªè§‚å¯Ÿè€…æ¨¡å¼çš„ä¾‹å­ã€‚</p><p>åˆ›å»ºä¸€ä¸ªåšå®¢ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»§æ‰¿ Observableç±»ï¼ŒBlogä¸ºè¢«è§‚å¯Ÿå¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blog</span> <span class="keyword">extends</span> <span class="title">Observable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Blog</span><span class="params">(String title)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.title = title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">comment</span><span class="params">(Comment comment)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(comment.getNickname() + <span class="string">"è¯„è®ºäº†&lt;"</span> + <span class="keyword">this</span>.title + <span class="string">"&gt; ï¼Œ"</span> +</span><br><span class="line">                <span class="string">"è¯„è®ºå†…å®¹ï¼š"</span> + comment.getValue());</span><br><span class="line">        <span class="comment">// è®¾ç½®æ ‡è¯†ä½ changed = trueï¼Œè¡¨ç¤ºè¢«è§‚å¯Ÿè€…å‘ç”Ÿäº†æ”¹å˜</span></span><br><span class="line">        setChanged();</span><br><span class="line">        <span class="comment">// é€šçŸ¥è§‚å¯Ÿè€…ï¼Œå¯ä»¥ç»™è§‚å¯Ÿè€…ä¼ é€’æ•°æ®</span></span><br><span class="line">        notifyObservers(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>Commentç±»ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Comment</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯„è®ºè€…æ˜µç§°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯„è®ºå†…å®¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Comment</span><span class="params">(String nickname, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nickname = nickname;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNickname</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nickname;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>Blogç±»æ˜¯è¢«è§‚å¯Ÿè€…å¯¹è±¡ï¼Œè¢«è§‚å¯Ÿè€…å¯¹è±¡éœ€è¦ç»§æ‰¿JDKçš„Observableç±»ï¼Œç»§æ‰¿åï¼Œè¢«è§‚å¯Ÿè€…å¯¹è±¡åŒ…å«å¦‚ä¸‹å±æ€§å’Œæ–¹æ³•ï¼š</p><p><img src="img/QQ20200511-093515@2x.png" alt="QQ20200511-093515@2x"></p><p>è¿™äº›æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨æ–¹æ³•ï¼ˆåŠ äº†synchronizedåŒæ­¥é”ï¼‰ã€‚</p><p>Blogçš„commentæ–¹æ³•ä¸­ï¼Œå½“åšå®¢æ”¶åˆ°è¯„è®ºæ—¶ï¼Œé¦–å…ˆè°ƒç”¨çˆ¶ç±»çš„setChanged()æ–¹æ³•ï¼Œè®¾ç½®æ ‡è¯†ä½ changed = trueï¼Œè¡¨ç¤ºè¢«è§‚å¯Ÿè€…å‘ç”Ÿäº†æ”¹å˜ï¼›ç„¶åè°ƒç”¨çˆ¶ç±»çš„notifyObservers(Object)æ–¹æ³•é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ã€‚</p><p>è¢«è§‚å¯Ÿè€…å¯¹è±¡åˆ›å»ºå¥½åï¼Œæˆ‘ä»¬æ¥ç€åˆ›å»ºè§‚å¯Ÿè€…ã€‚æ–°å»ºä¸€ä¸ªAuthorç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Author</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Author</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è§‚å¯Ÿè€…è¢«é€šçŸ¥åï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o   è¢«è§‚å¯Ÿè€…å¯¹è±¡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> arg è¢«è§‚å¯Ÿè€…ä¼ é€’è¿‡æ¥çš„æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span> </span>&#123;</span><br><span class="line">        Blog blog = (Blog) o;</span><br><span class="line">        Comment comment = (Comment) arg;</span><br><span class="line">        System.out.println(<span class="string">"ç³»ç»Ÿæ„ŸçŸ¥åˆ°"</span> + <span class="keyword">this</span>.name + <span class="string">"æ’°å†™çš„åšæ–‡&lt;"</span> +</span><br><span class="line">                blog.getTitle() + <span class="string">"&gt;æ”¶åˆ°äº†"</span> + comment.getNickname() +</span><br><span class="line">                <span class="string">"çš„è¯„è®ºï¼Œè¯„è®ºå†…å®¹ä¸ºï¼š"</span> + comment.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è§‚å¯Ÿè€…å¯¹è±¡éœ€è¦å®ç°JDKçš„Observerç±»ï¼Œé‡å†™updateæ–¹æ³•ã€‚å½“è¢«è§‚å¯Ÿè€…å¯¹è±¡è°ƒç”¨äº†notifyObserversæ–¹æ³•åï¼Œç›¸åº”çš„è§‚å¯Ÿè€…çš„updateæ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚</p><p>æ–°å»ºä¸€ä¸ªå®¢æˆ·ç«¯æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Blog blog = <span class="keyword">new</span> Blog(<span class="string">"Javaä»å…¥é—¨åˆ°æ”¾å¼ƒ"</span>);</span><br><span class="line">        Author author = <span class="keyword">new</span> Author(<span class="string">"MrBird"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ·»åŠ è§‚å¯Ÿè€…</span></span><br><span class="line">        blog.addObserver(author);</span><br><span class="line"></span><br><span class="line">        Comment comment = <span class="keyword">new</span> Comment(<span class="string">"Scott"</span>,</span><br><span class="line">                <span class="string">"æ„Ÿè°¢æ¥¼ä¸»çš„æ–‡ç« ï¼Œè®©æˆ‘åŠæ—¶æ”¾å¼ƒJavaï¼Œå›å®¶ç»§æ‰¿äº†åƒä¸‡å®¶äº§ã€‚"</span>);</span><br><span class="line">        blog.comment(comment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Scottè¯„è®ºäº†&lt;Javaä»å…¥é—¨åˆ°æ”¾å¼ƒ&gt; ï¼Œè¯„è®ºå†…å®¹ï¼šæ„Ÿè°¢æ¥¼ä¸»çš„æ–‡ç« ï¼Œè®©æˆ‘åŠæ—¶æ”¾å¼ƒJavaï¼Œå›å®¶ç»§æ‰¿äº†åƒä¸‡å®¶äº§ã€‚</span><br><span class="line">ç³»ç»Ÿæ„ŸçŸ¥åˆ°MrBirdæ’°å†™çš„åšæ–‡&lt;Javaä»å…¥é—¨åˆ°æ”¾å¼ƒ&gt;æ”¶åˆ°äº†Scottçš„è¯„è®ºï¼Œè¯„è®ºå†…å®¹ä¸ºï¼šæ„Ÿè°¢æ¥¼ä¸»çš„æ–‡ç« ï¼Œè®©æˆ‘åŠæ—¶æ”¾å¼ƒJavaï¼Œå›å®¶ç»§æ‰¿äº†åƒä¸‡å®¶äº§ã€‚</span><br></pre></td></tr></table></figure><p></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè§‚å¯Ÿè€…çš„updateæ–¹æ³•é‡Œçš„é€»è¾‘æœ€å¥½è¿›è¡Œå¼‚æ­¥åŒ–ï¼Œè¿™æ ·åœ¨å¹¶å‘ç¯å¢ƒä¸‹å¯ä»¥æå‡ç¨‹åºæ€§èƒ½ã€‚</p><h3 id="å¤‡å¿˜å½•æ¨¡å¼"><a href="#å¤‡å¿˜å½•æ¨¡å¼" class="headerlink" title="å¤‡å¿˜å½•æ¨¡å¼"></a>å¤‡å¿˜å½•æ¨¡å¼</h3><p>å‚è€ƒï¼š<a href="https://www.cnblogs.com/jimoer/p/9537997.html" target="_blank" rel="noopener">https://www.cnblogs.com/jimoer/p/9537997.html</a>ã€‚</p><h3 id="å‘½ä»¤æ¨¡å¼"><a href="#å‘½ä»¤æ¨¡å¼" class="headerlink" title="å‘½ä»¤æ¨¡å¼"></a>å‘½ä»¤æ¨¡å¼</h3><p>æš‚ä¸è®°å½•ã€‚</p><h3 id="ä¸­ä»‹è€…æ¨¡å¼"><a href="#ä¸­ä»‹è€…æ¨¡å¼" class="headerlink" title="ä¸­ä»‹è€…æ¨¡å¼"></a>ä¸­ä»‹è€…æ¨¡å¼</h3><p>æš‚ä¸è®°å½•ã€‚</p><h3 id="èŒè´£é“¾æ¨¡å¼"><a href="#èŒè´£é“¾æ¨¡å¼" class="headerlink" title="èŒè´£é“¾æ¨¡å¼"></a>èŒè´£é“¾æ¨¡å¼</h3><p>èŒè´£é“¾æ¨¡å¼ä¸ºè¯·æ±‚åˆ›å»ºä¸€ä¸ªæ¥æ”¶æ­¤æ¬¡è¯·æ±‚å¯¹è±¡çš„é“¾ã€‚</p><p>é€‚ç”¨äºï¼š</p><ul><li>ä¸€ä¸ªè¯·æ±‚çš„å¤„ç†éœ€è¦å¤šä¸ªå¯¹è±¡å½“ä¸­çš„ä¸€ä¸ªæˆ–å‡ ä¸ªåä½œå¤„ç†ï¼›</li></ul><p>ä¼˜ç‚¹ï¼š</p><ol><li>è¯·æ±‚çš„å‘é€è€…å’Œæ¥å—è€…ï¼ˆè¯·æ±‚çš„å¤„ç†ï¼‰è§£è€¦ï¼›</li><li>èŒè´£é“¾å¯ä»¥åŠ¨æ€çš„ç»„åˆã€‚</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>èŒè´£é“¾å¤ªé•¿æˆ–è€…å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œå½±å“æ€§èƒ½ï¼›</li><li>èŒè´£é“¾å¯èƒ½è¿‡å¤šã€‚</li></ol><p>ä¸¾ä¸ªå­—ç¬¦ä¸²æ ¡éªŒçš„ä¾‹å­ã€‚æ–°å»ºä¸€ä¸ªå­—ç¬¦ä¸²æ ¡éªŒæŠ½è±¡ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> StringValidator validator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNextValidator</span><span class="params">(StringValidator validator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.validator = validator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">(String value)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>StringValidatorç±»åŒ…å«äº†ä¸€ä¸ªè‡ªèº«ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œè¿™ä¹Ÿæ˜¯è¯¥æ¨¡å¼çš„è®¾è®¡æ ¸å¿ƒï¼Œä»¥æ­¤å½¢æˆé“¾æ¡ã€‚</p><p>åˆ›å»ºä¸€ä¸ªæ ¡éªŒå­—ç¬¦ä¸²é•¿åº¦çš„ç±»StringLengthValidatorï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringLengthValidator</span> <span class="keyword">extends</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.length() != <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"å­—ç¬¦ä¸²é•¿åº¦åˆæ³•"</span>);</span><br><span class="line">            <span class="keyword">if</span> (validator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                validator.check(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"å­—ç¬¦ä¸²é•¿åº¦ä¸åˆæ³•"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œåœ¨å­—ç¬¦ä¸²é•¿åº¦æ ¡éªŒåˆæ³•åï¼Œæˆ‘ä»¬åˆ¤æ–­çˆ¶ç±»çš„validatorå±æ€§æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™è°ƒç”¨å…¶checkæ–¹æ³•ç»§ç»­ä¸‹ä¸€æ­¥æ ¡éªŒã€‚</p><p>æ¥ç€å†æ–°å»ºä¸€ä¸ªæ ¡éªŒå­—ç¬¦ä¸²å†…å®¹çš„ç±»StringValueValidatorï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringValueValidator</span> <span class="keyword">extends</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value.contains(<span class="string">"fuck"</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">"å­—ç¬¦ä¸²å€¼ä¸åˆæ³•"</span>);</span><br><span class="line">            <span class="keyword">if</span> (validator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                validator.check(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"å­—ç¬¦ä¸²å€¼åˆæ³•"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¥—è·¯å’ŒStringLengthValidatorä¸€æ ·ã€‚æ¥ç€åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯ç±»ï¼Œæ¼”ç¤ºä¸‹å¦‚ä½•è®©æ ¡éªŒç±»å½¢æˆä¸€ä¸ªé“¾æ¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        StringValidator lengthValidator = <span class="keyword">new</span> StringLengthValidator();</span><br><span class="line">        StringValidator valueValidator = <span class="keyword">new</span> StringValueValidator();</span><br><span class="line"></span><br><span class="line">        lengthValidator.setNextValidator(valueValidator);</span><br><span class="line">        lengthValidator.check(<span class="string">"hello"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œé€šè¿‡StringValidatorçš„setNextValidatoræ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸‹ä¸€ä¸ªæ ¡éªŒç±»ï¼Œä»¥æ­¤å½¢æˆé“¾æ¡ï¼Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å­—ç¬¦ä¸²é•¿åº¦åˆæ³•</span><br><span class="line">å­—ç¬¦ä¸²å€¼åˆæ³•</span><br></pre></td></tr></table></figure><p></p><h3 id="è®¿é—®è€…æ¨¡å¼"><a href="#è®¿é—®è€…æ¨¡å¼" class="headerlink" title="è®¿é—®è€…æ¨¡å¼"></a>è®¿é—®è€…æ¨¡å¼</h3><p>æš‚ä¸è®°å½•ğŸŒš</p><h3 id="çŠ¶æ€æ¨¡å¼"><a href="#çŠ¶æ€æ¨¡å¼" class="headerlink" title="çŠ¶æ€æ¨¡å¼"></a>çŠ¶æ€æ¨¡å¼</h3><p>æš‚ä¸è®°å½•ğŸŒš</p><blockquote><p>å‚è€ƒè¿æ¥ï¼š<a href="https://zh.wikipedia.org/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F_(%E8%AE%A1%E7%AE%97%E6%9C%BA)" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F_(%E8%AE%A1%E7%AE%97%E6%9C%BA)</a></p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:56:01 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;ç®€å•è®°å½•Javaä¸­23ç§è®¾è®¡æ¨¡å¼çš„åº”ç”¨ï¼Œæ–¹ä¾¿åæœŸæŸ¥çœ‹ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Kafka APIä½¿ç”¨</title>
    <link href="http://mrbird.cc/Kafka-API%E4%BD%BF%E7%94%A8.html"/>
    <id>http://mrbird.cc/Kafka-APIä½¿ç”¨.html</id>
    <published>2020-03-29T14:08:32.000Z</published>
    <updated>2020-04-02T08:13:18.478Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p>æœ¬èŠ‚æ¼”ç¤ºå¦‚ä½•é€šè¿‡Javaä»£ç åˆ›å»ºKafkaç”Ÿäº§è€…ã€æ¶ˆè´¹è€…å’Œæ‹¦æˆªå™¨ï¼Œä¾èµ–ä½¿ç”¨<a href="https://mvnrepository.com/artifact/org.apache.kafka/kafka-clients/2.4.1" target="_blank" rel="noopener">Kafka-clients</a>ã€‚å› ä¸ºæˆ‘å®‰è£…çš„Kafkaç‰ˆæœ¬ä¸º2.4.1ï¼Œæ‰€ä»¥ä¾èµ–çš„ç‰ˆæœ¬ä¹Ÿç”¨2.4.1ï¼Œé¿å…å…¼å®¹é—®é¢˜ã€‚æ–°å¢ä¸€ä¸ªmavené¡¹ç›®ï¼Œå¼•å…¥ï¼š</p><a id="more"></a><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka-clients<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="ç”Ÿäº§è€…API"><a href="#ç”Ÿäº§è€…API" class="headerlink" title="ç”Ÿäº§è€…API"></a>ç”Ÿäº§è€…API</h2><p>Kafka çš„ Producer å‘é€æ¶ˆæ¯é‡‡ç”¨çš„æ˜¯å¼‚æ­¥å‘é€çš„æ–¹å¼ã€‚åœ¨æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°äº†ä¸¤ä¸ªçº¿ç¨‹â€”â€”main çº¿ç¨‹å’Œ Sender çº¿ç¨‹ï¼Œä»¥åŠä¸€ä¸ªçº¿ç¨‹å…±äº«å˜é‡â€”â€”RecordAccumulatorã€‚main çº¿ç¨‹å°†æ¶ˆæ¯å‘é€ç»™ RecordAccumulatorï¼ŒSender çº¿ç¨‹ä¸æ–­ä» RecordAccumulator ä¸­æ‹‰å–æ¶ˆæ¯å‘é€åˆ° Kafka brokerã€‚</p><h3 id="ç®€å•å‘é€æ•°æ®"><a href="#ç®€å•å‘é€æ•°æ®" class="headerlink" title="ç®€å•å‘é€æ•°æ®"></a>ç®€å•å‘é€æ•°æ®</h3><p>åˆ›å»º<code>ProducerDemo</code>ç±»ï¼Œç¼–å†™ä¸€ä¸ªç®€å•çš„ç”Ÿäº§è€…ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. ç”Ÿäº§è€…é…ç½®</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="comment">// æŒ‡å®škafkaåœ°å€</span></span><br><span class="line">        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092"</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šackç­‰çº§</span></span><br><span class="line">        properties.put(ProducerConfig.ACKS_CONFIG, <span class="string">"all"</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šé‡è¯•æ¬¡æ•°ï¼Œå³ç”Ÿäº§è€…å‘é€æ•°æ®åæ²¡æœ‰æ”¶åˆ°ackåº”ç­”æ—¶çš„é‡è¯•æ¬¡æ•°</span></span><br><span class="line">        properties.put(ProducerConfig.RETRIES_CONFIG, <span class="number">3</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šæ‰¹æ¬¡å¤§å° 16k = 16 * 1024</span></span><br><span class="line">        properties.put(ProducerConfig.BATCH_SIZE_CONFIG, <span class="number">16384</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šç­‰å¾…æ—¶é—´ï¼Œå•ä½æ¯«ç§’</span></span><br><span class="line">        properties.put(ProducerConfig.LINGER_MS_CONFIG, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šRecordAccumulatorç¼“å†²åŒºå¤§å° 32m = 32 * 1024 * 1024</span></span><br><span class="line">        properties.put(ProducerConfig.BUFFER_MEMORY_CONFIG, <span class="number">33554432</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šk-våºåˆ—åŒ–è§„åˆ™</span></span><br><span class="line">        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        <span class="comment">// 2. åˆ›å»ºç”Ÿäº§è€…</span></span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(properties);</span><br><span class="line">        <span class="comment">// 3. å‡†å¤‡æ•°æ®</span></span><br><span class="line">        ProducerRecord&lt;String, String&gt; record = <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"test"</span>, <span class="string">"mesage"</span>);</span><br><span class="line">        <span class="comment">// 4. å‘é€æ•°æ®ï¼ˆä¸å¸¦å›è°ƒï¼‰</span></span><br><span class="line">        producer.send(record);</span><br><span class="line">        <span class="comment">// 5. å…³é—­è¿æ¥</span></span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ— è®ºæ˜¯åˆ›å»ºç”Ÿäº§è€…è¿˜æ˜¯æ¶ˆè´¹è€…ï¼Œæˆ‘ä»¬éƒ½è¦æŒ‡å®šé…ç½®ã€‚ç”Ÿäº§è€…é…ç½®å¯ä»¥ä½¿ç”¨å¸¸é‡ç±»<code>ProducerConfig</code>æŒ‡å®šï¼Œé‡Œé¢åŒ…å«äº†ç”Ÿäº§è€…æ‰€æœ‰å¯ç”¨é…ç½®ï¼Œå¹¶ä¸”åŒ…å«å¯¹åº”çš„è§£é‡Šï¼š</p><p><img src="img/QQ20200402-103628@2x.png" alt="QQ20200402-103628@2x"></p><p>ä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸€ä¸ªkvéƒ½æ˜¯Stringç±»å‹çš„ç”Ÿäº§è€…ã€‚é…ç½®äº†Kafkaçš„åœ°å€ï¼Œackç­‰çº§ä¸ºallï¼ˆåœ¨<a href="/Kafkaç”Ÿäº§è€….html">Kafkaç”Ÿäº§è€…</a>ä¸€èŠ‚ä¸­ä»‹ç»è¿‡äº†ï¼Œä¸èµ˜è¿°ï¼‰ï¼Œé‡è¯•æ¬¡æ•°ä¸º3ã€‚å¹¶ä¸”æŒ‡å®šäº†ç”Ÿäº§è€…å‘é€æ•°æ®çš„æ‰¹æ¬¡ä¸º16kï¼Œç­‰å¾…æ—¶é—´ä¸º1msã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦ä¹ˆå‘é€çš„æ•°æ®é‡è¾¾åˆ°äº†16kï¼Œè¦ä¹ˆç­‰å¾…æ—¶é—´è¶…è¿‡äº†1msæ‰ä¼šçœŸæ­£åœ°æŠŠæ•°æ®å‘å¾€Kafkaã€‚</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜æŒ‡å®šRecordAccumulatorç¼“å†²åŒºå¤§å°ï¼Œkvåºåˆ—åŒ–è§„åˆ™é‡‡ç”¨<code>StringSerializer</code>ã€‚</p><p>Kafkaæ¶ˆæ¯ä½¿ç”¨<code>KafkaProducer</code>å¯¹è±¡è¡¨ç¤ºï¼Œä»–æœ‰6ä¸ªé‡è½½æ„é€ å™¨ï¼Œè¿™åœ¨<a href="/Kafkaç”Ÿäº§è€….html">Kafkaç”Ÿäº§è€…</a>ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œæˆ‘ä»¬æŒ‡å®šäº†ä¸»é¢˜ä¸ºtestï¼Œæ¶ˆæ¯å†…å®¹ä¸ºmessageã€‚</p><p>è¿è¡Œè¿™æ®µä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå¯åŠ¨zkå’Œkafkaï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># å¯åŠ¨zk</span><br><span class="line">sh bin/zookeeper-server-start.sh config/zookeeper.properties</span><br><span class="line"># å¯åŠ¨kafka broker</span><br><span class="line">sh bin/kafka-server-start.sh config/server.properties</span><br><span class="line"># å¯åŠ¨kafkaæ¶ˆè´¹è€…</span><br><span class="line">sh bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åè¿è¡Œä¸Šé¢çš„ç¨‹åºï¼Œè§‚å¯Ÿæ¶ˆè´¹è€…è¾“å‡ºï¼š</p><p><img src="img/QQ20200402-110459@2x.png" alt="QQ20200402-110459@2x"></p><h3 id="å¸¦å›è°ƒå‡½æ•°"><a href="#å¸¦å›è°ƒå‡½æ•°" class="headerlink" title="å¸¦å›è°ƒå‡½æ•°"></a>å¸¦å›è°ƒå‡½æ•°</h3><p><code>KafkaProducer</code>çš„<code>send</code>æ–¹æ³•å¯ä»¥åˆ¶å®šå›è°ƒå‡½æ•°ã€‚å›è°ƒå‡½æ•°ä¼šåœ¨ producer æ”¶åˆ° ack æ—¶è°ƒç”¨ï¼Œä¸ºå¼‚æ­¥è°ƒç”¨ï¼Œè¯¥æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯RecordMetadata å’Œ Exceptionï¼Œå¦‚æœ Exception ä¸º nullï¼Œè¯´æ˜æ¶ˆæ¯å‘é€æˆåŠŸï¼Œå¦‚æœException ä¸ä¸º nullï¼Œè¯´æ˜æ¶ˆæ¯å‘é€å¤±è´¥ã€‚</p><p>æ”¹é€ ä¸Šé¢çš„sendæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">// 3. å‡†å¤‡æ•°æ®</span></span><br><span class="line">ProducerRecord&lt;String, String&gt; record = <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"test"</span>, <span class="string">"callback-test"</span>);</span><br><span class="line"><span class="comment">// 4. å‘é€æ•°æ®ï¼ˆå¸¦å›è°ƒï¼‰</span></span><br><span class="line">producer.send(record, (metadata, exception) -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (exception == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å›è°ƒå‡½æ•°ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨ Producer æ”¶åˆ° ack æ—¶è°ƒç”¨ï¼Œä¸ºå¼‚æ­¥è°ƒç”¨</span></span><br><span class="line">        String result = String.format(<span class="string">"æ¶ˆæ¯å‘é€æˆåŠŸï¼Œä¸»é¢˜Topic: %s,åˆ†åŒºPartition: %s,åç§»é‡Offset: %s"</span>,</span><br><span class="line">                metadata.topic(), metadata.partition(), metadata.offset());</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"æ¶ˆæ¯å‘é€å¤±è´¥"</span>);</span><br><span class="line">        exception.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p></p><p>è¿è¡Œè¯¥æ–¹æ³•ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ¶ˆæ¯å‘é€æˆåŠŸï¼Œä¸»é¢˜Topic: test,åˆ†åŒºPartition: 0,åç§»é‡Offset: 4</span><br></pre></td></tr></table></figure><p></p><p>æ¶ˆè´¹è€…ï¼š</p><p><img src="img/QQ20200402-111752@2x.png" alt="QQ20200402-111752@2x"></p><h3 id="åŒæ­¥å‘é€"><a href="#åŒæ­¥å‘é€" class="headerlink" title="åŒæ­¥å‘é€"></a>åŒæ­¥å‘é€</h3><p>å¦‚å‰é¢æ‰€è¯´ï¼ŒKafka çš„ Producer å‘é€æ¶ˆæ¯é‡‡ç”¨çš„æ˜¯å¼‚æ­¥å‘é€çš„æ–¹å¼ï¼Œ<code>KafkaProducer</code>çš„<code>send</code>æ–¹æ³•è¿”å›<code>Future</code>å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è°ƒç”¨<code>Future</code>å¯¹è±¡çš„<code>get</code>æ–¹æ³•å®ç°åŒæ­¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3. å‡†å¤‡æ•°æ®</span></span><br><span class="line">ProducerRecord&lt;String, String&gt; record = <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"test"</span>, <span class="string">"test-sync"</span>);</span><br><span class="line"><span class="comment">// 4. å‘é€æ•°æ®ï¼ˆå¸¦å›è°ƒï¼‰</span></span><br><span class="line">Future&lt;RecordMetadata&gt; future = producer.send(record, (metadata, exception) -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (exception == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å›è°ƒå‡½æ•°ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨ Producer æ”¶åˆ° ack æ—¶è°ƒç”¨ï¼Œä¸ºå¼‚æ­¥è°ƒç”¨</span></span><br><span class="line">        String result = String.format(<span class="string">"æ¶ˆæ¯å‘é€æˆåŠŸï¼Œä¸»é¢˜Topic: %s,åˆ†åŒºPartition: %s,åç§»é‡Offset: %s"</span>,</span><br><span class="line">                metadata.topic(), metadata.partition(), metadata.offset());</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"æ¶ˆæ¯å‘é€å¤±è´¥"</span>);</span><br><span class="line">        exception.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">future.get();</span><br></pre></td></tr></table></figure><p></p><h3 id="è‡ªå®šä¹‰åˆ†åŒºå™¨"><a href="#è‡ªå®šä¹‰åˆ†åŒºå™¨" class="headerlink" title="è‡ªå®šä¹‰åˆ†åŒºå™¨"></a>è‡ªå®šä¹‰åˆ†åŒºå™¨</h3><p>è‡ªå®šä¹‰åˆ†åŒºå™¨åªéœ€è¦è¦å®ç°<code>Partitioner</code>æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPartitioner</span> <span class="keyword">implements</span> <span class="title">Partitioner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>partition</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸»é¢˜topicï¼Œkeyå€¼ï¼Œåºåˆ—åŒ–åçš„keyå€¼ï¼Œvalueå€¼ï¼Œåºåˆ—åŒ–åçš„valueå€¼ï¼ŒKafkaé›†ç¾¤clusterä¿¡æ¯ï¼Œæ¥ä¸ªæ€§åŒ–åˆ†åŒºè§„åˆ™ã€‚</p><p>è¦ä½¿ç”¨è‡ªå®šä¹‰åˆ†åŒºå™¨ï¼Œå¯é€šè¿‡é…ç½®ç±»æŒ‡å®šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŒ‡å®šè‡ªå®šä¹‰åˆ†åŒºå™¨</span></span><br><span class="line">properties.put(ProducerConfig.PARTITIONER_CLASS_CONFIG, MyPartitioner.class);</span><br></pre></td></tr></table></figure><p></p><h2 id="æ¶ˆè´¹è€…API"><a href="#æ¶ˆè´¹è€…API" class="headerlink" title="æ¶ˆè´¹è€…API"></a>æ¶ˆè´¹è€…API</h2><p>Consumer æ¶ˆè´¹æ•°æ®æ—¶çš„å¯é æ€§æ˜¯å¾ˆå®¹æ˜“ä¿è¯çš„ï¼Œå› ä¸ºæ•°æ®åœ¨ Kafka ä¸­æ˜¯æŒä¹…åŒ–çš„ï¼Œæ•…ä¸ç”¨æ‹…å¿ƒæ•°æ®ä¸¢å¤±é—®é¢˜ã€‚</p><p>ç”±äº consumer åœ¨æ¶ˆè´¹è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°æ–­ç”µå®•æœºç­‰æ•…éšœï¼Œconsumer æ¢å¤åï¼Œéœ€è¦ä»æ•…éšœå‰çš„ä½ç½®çš„ç»§ç»­æ¶ˆè´¹ï¼Œæ‰€ä»¥ consumer éœ€è¦å®æ—¶è®°å½•è‡ªå·±æ¶ˆè´¹åˆ°äº†å“ªä¸ª offsetï¼Œä»¥ä¾¿æ•…éšœæ¢å¤åç»§ç»­æ¶ˆè´¹ã€‚æ‰€ä»¥ offset çš„ç»´æŠ¤æ˜¯ Consumer æ¶ˆè´¹æ•°æ®æ˜¯å¿…é¡»è€ƒè™‘çš„é—®é¢˜ã€‚</p><h3 id="è‡ªåŠ¨æäº¤offset"><a href="#è‡ªåŠ¨æäº¤offset" class="headerlink" title="è‡ªåŠ¨æäº¤offset"></a>è‡ªåŠ¨æäº¤offset</h3><p>åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œè‡ªåŠ¨æäº¤offsetï¼Œæ¼”ç¤ºæ¶ˆæ¯æ¶ˆè´¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 1. æ¶ˆè´¹è€…é…ç½®</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092"</span>);</span><br><span class="line">        <span class="comment">// è‡ªåŠ¨æäº¤offset</span></span><br><span class="line">        properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// æäº¤offsetçš„æ—¶é—´ï¼Œå•ä½msï¼Œå³1ç§’é’Ÿæäº¤ä¸€æ¬¡</span></span><br><span class="line">        properties.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG, <span class="string">"1000"</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šk-vååºåˆ—åŒ–è§„åˆ™</span></span><br><span class="line">        properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šæ¶ˆè´¹è€…ç»„</span></span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">"my-group"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. åˆ›å»ºæ¶ˆè´¹è€…</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(properties);</span><br><span class="line">        <span class="comment">// è®¢é˜…ä¸»é¢˜</span></span><br><span class="line">        consumer.subscribe(Collections.singletonList(<span class="string">"test"</span>));</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="comment">// æ‹‰å–æ•°æ®ï¼ŒæŒ‡å®šè½®è¯¢æ—¶é—´ä¸º1ç§’</span></span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; consumerRecord : consumerRecords) &#123;</span><br><span class="line">                System.out.println(consumerRecord.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨æ¶ˆè´¹è€…ï¼Œç„¶åå†ä½¿ç”¨ç”Ÿäº§è€…å‘é€<code>mrbird</code>æ¶ˆæ¯åˆ°testä¸»é¢˜ï¼Œæ¶ˆè´¹è€…æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConsumerRecord(topic = test, partition = 0, leaderEpoch = 0, offset = 6, CreateTime = 1585811850841, serialized key size = -1, serialized value size = 6, headers = RecordHeaders(headers = [], isReadOnly = false), key = null, value = mrbird)</span><br></pre></td></tr></table></figure><p></p><h3 id="æ‰‹åŠ¨æäº¤offset"><a href="#æ‰‹åŠ¨æäº¤offset" class="headerlink" title="æ‰‹åŠ¨æäº¤offset"></a>æ‰‹åŠ¨æäº¤offset</h3><p>è™½ç„¶è‡ªåŠ¨æäº¤ offset ååˆ†ä¾¿åˆ©ï¼Œä½†ç”±äºå…¶æ˜¯åŸºäºæ—¶é—´æäº¤çš„ï¼Œå¼€å‘äººå‘˜éš¾ä»¥æŠŠæ¡ offset æäº¤çš„æ—¶æœºã€‚å› æ­¤ Kafka è¿˜æä¾›äº†æ‰‹åŠ¨æäº¤ offset çš„ APIã€‚</p><p>æ‰‹åŠ¨æäº¤ offset çš„æ–¹æ³•æœ‰ä¸¤ç§ï¼šåˆ†åˆ«æ˜¯ <strong>commitSync</strong>ï¼ˆåŒæ­¥æäº¤ï¼‰å’Œ <strong>commitAsync</strong>ï¼ˆå¼‚æ­¥æäº¤ï¼‰ã€‚ä¸¤è€…çš„ç›¸åŒç‚¹æ˜¯ï¼Œéƒ½ä¼šå°†æœ¬æ¬¡ poll çš„ä¸€æ‰¹æ•°æ®æœ€é«˜çš„åç§»é‡æäº¤ï¼›ä¸åŒç‚¹æ˜¯ï¼ŒcommitSync é˜»å¡å½“å‰çº¿ç¨‹ï¼Œä¸€ç›´åˆ°æäº¤æˆåŠŸï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨å¤±è´¥é‡è¯•ï¼ˆç”±ä¸å¯æ§å› ç´ å¯¼è‡´ï¼Œä¹Ÿä¼šå‡ºç°æäº¤å¤±è´¥ï¼‰ï¼›è€Œ commitAsync åˆ™æ²¡æœ‰å¤±è´¥é‡è¯•æœºåˆ¶ï¼Œæ•…æœ‰å¯èƒ½æäº¤å¤±è´¥ã€‚</p><p>ç”±äºåŒæ­¥æäº¤ offset æœ‰å¤±è´¥é‡è¯•æœºåˆ¶ï¼Œæ•…æ›´åŠ å¯é ï¼Œä»¥ä¸‹ä¸ºåŒæ­¥æäº¤ offset çš„ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 1. æ¶ˆè´¹è€…é…ç½®</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092"</span>);</span><br><span class="line">        <span class="comment">// å…³é—­è‡ªåŠ¨æäº¤offset</span></span><br><span class="line">        properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šk-vååºåˆ—åŒ–è§„åˆ™</span></span><br><span class="line">        properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šæ¶ˆè´¹è€…ç»„</span></span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">"my-group"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. åˆ›å»ºæ¶ˆè´¹è€…</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(properties);</span><br><span class="line">        <span class="comment">// è®¢é˜…ä¸»é¢˜</span></span><br><span class="line">        consumer.subscribe(Collections.singletonList(<span class="string">"test"</span>));</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// æ‹‰å–æ•°æ®ï¼ŒæŒ‡å®šè½®è¯¢æ—¶é—´ä¸º1ç§’</span></span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; consumerRecord : consumerRecords) &#123;</span><br><span class="line">                System.out.println(consumerRecord.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åŒæ­¥æäº¤</span></span><br><span class="line">            consumer.commitSync();</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>commitSync()</code>ä¹Ÿå¯ä»¥æŒ‡å®šè¶…æ—¶æ—¶é—´ã€‚</p><p>è™½ç„¶åŒæ­¥æäº¤ offset æ›´å¯é ä¸€äº›ï¼Œä½†æ˜¯ç”±äºå…¶ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æäº¤æˆåŠŸã€‚å› æ­¤ååé‡ä¼šæ”¶åˆ°å¾ˆå¤§çš„å½±å“ã€‚æ›´å¤šçš„æƒ…å†µä¸‹ï¼Œä¼šé€‰ç”¨å¼‚æ­¥æäº¤ offset çš„æ–¹å¼ã€‚</p><p>ä»¥ä¸‹ä¸ºå¼‚æ­¥æäº¤ offset çš„ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 1. æ¶ˆè´¹è€…é…ç½®</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092"</span>);</span><br><span class="line">        <span class="comment">// å…³é—­è‡ªåŠ¨æäº¤offset</span></span><br><span class="line">        properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// æäº¤offsetçš„æ—¶é—´ï¼Œå•ä½msï¼Œå³1ç§’é’Ÿæäº¤ä¸€æ¬¡</span></span><br><span class="line">        properties.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG, <span class="string">"1000"</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šk-vååºåˆ—åŒ–è§„åˆ™</span></span><br><span class="line">        properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šæ¶ˆè´¹è€…ç»„</span></span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">"my-group"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. åˆ›å»ºæ¶ˆè´¹è€…</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(properties);</span><br><span class="line">        <span class="comment">// è®¢é˜…ä¸»é¢˜</span></span><br><span class="line">        consumer.subscribe(Collections.singletonList(<span class="string">"test"</span>));</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="comment">// æ‹‰å–æ•°æ®ï¼ŒæŒ‡å®šè½®è¯¢æ—¶é—´ä¸º1ç§’</span></span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; consumerRecord : consumerRecords) &#123;</span><br><span class="line">                System.out.println(consumerRecord.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¼‚æ­¥æäº¤</span></span><br><span class="line">            consumer.commitAsync();</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>commitAsync()</code>å¯ä»¥æŒ‡å®šå›è°ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">consumer.commitAsync((offsets, exception) -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (exception == <span class="keyword">null</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">"æäº¤offset: "</span> + offsets + <span class="string">"æˆåŠŸ"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"æäº¤å¤±è´¥"</span>);</span><br><span class="line">        exception.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><div class="note danger">æ— è®ºæ˜¯åŒæ­¥æäº¤è¿˜æ˜¯å¼‚æ­¥æäº¤ offsetï¼Œéƒ½æœ‰å¯èƒ½ä¼šé€ æˆæ•°æ®çš„æ¼æ¶ˆè´¹æˆ–è€…é‡å¤æ¶ˆè´¹ã€‚å…ˆæäº¤ offset åæ¶ˆè´¹ï¼Œæœ‰å¯èƒ½é€ æˆæ•°æ®çš„æ¼æ¶ˆè´¹ï¼›è€Œå…ˆæ¶ˆè´¹åæäº¤ offsetï¼Œæœ‰å¯èƒ½ä¼šé€ æˆæ•°æ®çš„é‡å¤æ¶ˆè´¹ã€‚</div><h2 id="æ‹¦æˆªå™¨"><a href="#æ‹¦æˆªå™¨" class="headerlink" title="æ‹¦æˆªå™¨"></a>æ‹¦æˆªå™¨</h2><p>Producer æ‹¦æˆªå™¨(interceptor)æ˜¯åœ¨ Kafka 0.10 ç‰ˆæœ¬è¢«å¼•å…¥çš„ï¼Œinterceptor ä½¿å¾—ç”¨æˆ·åœ¨æ¶ˆæ¯å‘é€å‰ä»¥åŠ producer å›è°ƒé€»è¾‘å‰æœ‰æœºä¼šå¯¹æ¶ˆæ¯åšä¸€äº›å®šåˆ¶åŒ–éœ€æ±‚ï¼Œæ¯”å¦‚ä¿®æ”¹æ¶ˆæ¯ç­‰ã€‚åŒæ—¶ï¼Œproducer å…è®¸ç”¨æˆ·æŒ‡å®šå¤šä¸ª interceptoræŒ‰é¡ºåºå½¢æˆä¸€ä¸ªæ‹¦æˆªå™¨é“¾(interceptor chain)ã€‚Intercetpor çš„å®ç°æ¥å£æ˜¯ <code>org.apache.kafka.clients.producer.ProducerInterceptor</code>ï¼Œå…¶å®šä¹‰çš„æ–¹æ³•åŒ…æ‹¬ï¼š</p><p><img src="img/QQ20200402-154559@2x.png" alt="QQ20200402-154559@2x"></p><ul><li>configure(configs)ï¼šè·å–é…ç½®ä¿¡æ¯å’Œåˆå§‹åŒ–æ•°æ®æ—¶è°ƒç”¨ï¼›</li><li><p>onSend(ProducerRecord)ï¼šåœ¨æ¶ˆæ¯è¢«åºåˆ—åŒ–ä»¥åŠè®¡ç®—åˆ†åŒºå‰è°ƒç”¨è¯¥æ–¹æ³•ã€‚ç”¨æˆ·å¯ä»¥åœ¨è¯¥æ–¹æ³•ä¸­å¯¹æ¶ˆæ¯åšä»»ä½•æ“ä½œï¼Œä½†æœ€å¥½ä¸è¦ä¿®æ”¹æ¶ˆæ¯æ‰€å±çš„ topic å’Œåˆ†åŒºï¼Œå¦åˆ™ä¼šå½±å“ç›®æ ‡åˆ†åŒºçš„è®¡ç®—ï¼›</p></li><li><p>onAcknowledgement(RecordMetadata, Exception)ï¼šåœ¨è¿”å›ackæ—¶ï¼Œæˆ–è€…å‘é€å¤±è´¥æ—¶è°ƒç”¨è¯¥æ–¹æ³•ã€‚</p></li><li>closeï¼šå…³é—­ interceptorï¼Œä¸»è¦ç”¨äºæ‰§è¡Œä¸€äº›èµ„æºæ¸…ç†å·¥ä½œã€‚</li></ul><p>ä¸‹é¢ä¸¾ä¸ªè‡ªå®šä¹‰æ‹¦æˆªå™¨çš„ä¾‹å­ï¼šå®šä¹‰ä¸€ä¸ªæ‹¦æˆªå™¨é“¾ï¼ŒåŒ…å«ä¸¤ä¸ªæ‹¦æˆªå™¨<code>MessageFormatInterceptor</code>å’Œ<code>CountInterceptor</code>ï¼Œåˆ†åˆ«ç”¨äºæ¶ˆæ¯åŠ å·¥å’Œç»Ÿè®¡æ¶ˆæ¯å‘é€æˆåŠŸå’Œå¤±è´¥çš„ç¬”æ•°ã€‚</p><p>å®šä¹‰<code>MessageFormatInterceptor</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageFormatInterceptor</span> <span class="keyword">implements</span> <span class="title">ProducerInterceptor</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProducerRecord&lt;String, String&gt; <span class="title">onSend</span><span class="params">(ProducerRecord&lt;String, String&gt; record)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProducerRecord&lt;&gt;(record.topic(), record.partition(), record.timestamp(), record.key(),</span><br><span class="line">                System.currentTimeMillis() + <span class="string">" - "</span> + record.value());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAcknowledgement</span><span class="params">(RecordMetadata metadata, Exception exception)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å®šä¹‰<code>CountInterceptor</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountInterceptor</span> <span class="keyword">implements</span> <span class="title">ProducerInterceptor</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> errorCounter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> successCounter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProducerRecord&lt;String, String&gt; <span class="title">onSend</span><span class="params">(ProducerRecord&lt;String, String&gt; record)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> record;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAcknowledgement</span><span class="params">(RecordMetadata metadata, Exception exception)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (exception == <span class="keyword">null</span>) &#123;</span><br><span class="line">            successCounter++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            errorCounter++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"æˆåŠŸç¬”æ•°: "</span> + successCounter);</span><br><span class="line">        System.out.println(<span class="string">"å¤±è´¥ç¬”æ•°: "</span> + errorCounter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å…¶å®è¿™ä¸¤ä¸ªåŠŸèƒ½å®Œå…¨å¯ä»¥ç”±ä¸€ä¸ªè¿‡æ»¤å™¨æ¥å®Œæˆï¼Œè¿™é‡Œä»…ä»…æ˜¯ä¸ºäº†æ¼”ç¤ºè¿‡æ»¤å™¨é“¾ã€‚</p><p>åœ¨ç”Ÿäº§è€…é…ç½®ä¸­æŒ‡å®šè¿™ä¸ªè¿‡æ»¤å™¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. ç”Ÿäº§è€…é…ç½®</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="comment">// æŒ‡å®škafkaåœ°å€</span></span><br><span class="line">        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092"</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šackç­‰çº§</span></span><br><span class="line">        properties.put(ProducerConfig.ACKS_CONFIG, <span class="string">"all"</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šé‡è¯•æ¬¡æ•°ï¼Œå³ç”Ÿäº§è€…å‘é€æ•°æ®åæ²¡æœ‰æ”¶åˆ°ackåº”ç­”æ—¶çš„é‡è¯•æ¬¡æ•°</span></span><br><span class="line">        properties.put(ProducerConfig.RETRIES_CONFIG, <span class="number">3</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šæ‰¹æ¬¡å¤§å° 16k = 16 * 1024</span></span><br><span class="line">        properties.put(ProducerConfig.BATCH_SIZE_CONFIG, <span class="number">16384</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šç­‰å¾…æ—¶é—´ï¼Œå•ä½æ¯«ç§’</span></span><br><span class="line">        properties.put(ProducerConfig.LINGER_MS_CONFIG, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šRecordAccumulatorç¼“å†²åŒºå¤§å° 32m = 32 * 1024 * 1024</span></span><br><span class="line">        properties.put(ProducerConfig.BUFFER_MEMORY_CONFIG, <span class="number">33554432</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šk-våºåˆ—åŒ–è§„åˆ™</span></span><br><span class="line">        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        <span class="comment">// æŒ‡å®šè¿‡æ»¤å™¨é“¾</span></span><br><span class="line">        properties.put(ProducerConfig.INTERCEPTOR_CLASSES_CONFIG, Arrays.asList(<span class="string">"cc.mrbird.kafka.MessageFormatInterceptor"</span>, <span class="string">"cc.mrbird.kafka.CountInterceptor"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. åˆ›å»ºç”Ÿäº§è€…</span></span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(properties);</span><br><span class="line">        <span class="comment">// 3. å‡†å¤‡æ•°æ®</span></span><br><span class="line">        ProducerRecord&lt;String, String&gt; record = <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"test"</span>, <span class="string">"kafka"</span>);</span><br><span class="line">        <span class="comment">// 4. å‘é€æ•°æ®</span></span><br><span class="line">        producer.send(record);</span><br><span class="line">        <span class="comment">// 5. å…³é—­è¿æ¥</span></span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç¨‹åºï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æˆåŠŸç¬”æ•°: 1</span><br><span class="line">å¤±è´¥ç¬”æ•°: 0</span><br></pre></td></tr></table></figure><p></p><p>æ¶ˆè´¹è€…ï¼š</p><p><img src="img/QQ20200402-160619@2x.png" alt="QQ20200402-160619@2x"></p><blockquote><p>ã€Œå°šç¡…è°·å¤§æ•°æ®æŠ€æœ¯ä¹‹ Kafkaã€ å­¦ä¹ ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;æœ¬èŠ‚æ¼”ç¤ºå¦‚ä½•é€šè¿‡Javaä»£ç åˆ›å»ºKafkaç”Ÿäº§è€…ã€æ¶ˆè´¹è€…å’Œæ‹¦æˆªå™¨ï¼Œä¾èµ–ä½¿ç”¨&lt;a href=&quot;https://mvnrepository.com/artifact/org.apache.kafka/kafka-clients/2.4.1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Kafka-clients&lt;/a&gt;ã€‚å› ä¸ºæˆ‘å®‰è£…çš„Kafkaç‰ˆæœ¬ä¸º2.4.1ï¼Œæ‰€ä»¥ä¾èµ–çš„ç‰ˆæœ¬ä¹Ÿç”¨2.4.1ï¼Œé¿å…å…¼å®¹é—®é¢˜ã€‚æ–°å¢ä¸€ä¸ªmavené¡¹ç›®ï¼Œå¼•å…¥ï¼š&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kafka" scheme="http://mrbird.cc/tags/Kafka/"/>
    
  </entry>
  
  <entry>
    <title>Kafkaæ¶ˆè´¹è€…</title>
    <link href="http://mrbird.cc/Kafka%E6%B6%88%E8%B4%B9%E8%80%85.html"/>
    <id>http://mrbird.cc/Kafkaæ¶ˆè´¹è€….html</id>
    <published>2020-03-28T14:07:33.000Z</published>
    <updated>2020-04-01T09:09:54.508Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p>Kafkaæ¶ˆè´¹è€…é‡‡ç”¨pullæ‹‰æ¨¡å¼ä»brokerä¸­æ¶ˆè´¹æ•°æ®ã€‚ä¸ä¹‹ç›¸å¯¹çš„pushï¼ˆæ¨ï¼‰æ¨¡å¼å¾ˆéš¾é€‚åº”æ¶ˆè´¹é€Ÿç‡ä¸åŒçš„æ¶ˆè´¹è€…ï¼Œå› ä¸ºæ¶ˆæ¯å‘é€é€Ÿç‡æ˜¯ç”± broker å†³å®šçš„ã€‚å®ƒçš„ç›®æ ‡æ˜¯å°½å¯èƒ½ä»¥æœ€å¿«é€Ÿåº¦ä¼ é€’æ¶ˆæ¯ï¼Œä½†æ˜¯è¿™æ ·å¾ˆå®¹æ˜“é€ æˆ consumer æ¥ä¸åŠå¤„ç†æ¶ˆæ¯ã€‚è€Œ pull æ¨¡å¼åˆ™å¯ä»¥æ ¹æ® consumer çš„æ¶ˆè´¹èƒ½åŠ›ä»¥é€‚å½“çš„é€Ÿç‡æ¶ˆè´¹æ¶ˆæ¯ã€‚pull æ¨¡å¼ä¸è¶³ä¹‹å¤„æ˜¯ï¼Œå¦‚æœ kafka æ²¡æœ‰æ•°æ®ï¼Œæ¶ˆè´¹è€…å¯èƒ½ä¼šé™·å…¥å¾ªç¯ä¸­ï¼Œä¸€ç›´è¿”å›ç©ºæ•°æ®ã€‚é’ˆå¯¹è¿™ä¸€ç‚¹ï¼ŒKafka çš„æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ•°æ®æ—¶ä¼šä¼ å…¥ä¸€ä¸ªæ—¶é•¿å‚æ•° timeoutï¼Œå¦‚æœå½“å‰æ²¡æœ‰æ•°æ®å¯ä¾›æ¶ˆè´¹ï¼Œconsumer ä¼šç­‰å¾…ä¸€æ®µæ—¶é—´ä¹‹åå†è¿”å›ï¼Œè¿™æ®µæ—¶é•¿å³ä¸º timeoutã€‚</p><a id="more"></a><h2 id="æ¶ˆè´¹è€…ç»„"><a href="#æ¶ˆè´¹è€…ç»„" class="headerlink" title="æ¶ˆè´¹è€…ç»„"></a>æ¶ˆè´¹è€…ç»„</h2><p>æ¶ˆè´¹è€…ç»„ï¼ˆconsumer groupï¼‰ä¸æ¶ˆè´¹è€…ä¹‹é—´å¯†åˆ‡ç›¸å…³ã€‚åœ¨Kafkaä¸­ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥å…±åŒæ„æˆä¸€ä¸ªæ¶ˆè´¹è€…ç»„ï¼Œè€Œä¸€ä¸ªæ¶ˆè´¹è€…åªèƒ½ä»å²äºä¸€ä¸ªæ¶ˆè´¹è€…ç»„ï¼Œæ¶ˆè´¹è€…ç»„æœ€ä¸ºé‡è¦çš„ä¸€ä¸ªåŠŸèƒ½æ˜¯å®ç°å¹¿æ’­ä¸å•æ’­çš„åŠŸèƒ½ã€‚ä¸€ä¸ªæ¶ˆè´¹è€…ç»„å¯ä»¥ç¡®ä¿å…¶æ‰€è®¢é˜…çš„Topicçš„æ¯ä¸ªåˆ†åŒºåªèƒ½è¢«ä»å±äºè¯¥æ¶ˆè´¹è€…ç»„ä¸­çš„å”¯ä¸€ä¸€ä¸ªæ¶ˆè´¹è€…æ‰€æ¶ˆè´¹ï¼›å¦‚æœä¸åŒçš„æ¶ˆè´¹è€…ç»„è®¢é˜…äº†åŒä¸€ä¸ªTopicï¼Œé‚£ä¹ˆè¿™äº›æ¶ˆè´¹è€…ç»„ä¹‹é—´æ˜¯å½¼æ­¤ç‹¬ç«‹çš„ï¼Œä¸ä¼šå—åˆ°ç›¸äº’çš„å¹²æ‰°ã€‚</p><div class="note info">å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›ä¸€æ¡æ¶ˆæ€å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…æ‰€æ¶ˆè´¹ï¼Œé‚£ä¹ˆå¯ä»¥å°†è¿™äº›æ¶ˆè´¹è€…æ”¾åˆ°ä¸åŒçš„æ¶ˆè´¹è€…ç»„ä¸­ï¼Œè¿™å®é™…ä¸Šå°±æ˜¯å¹¿æ’­çš„æ•ˆæœï¼›å¦‚æœå¸Œæœ›ä¸€æ¡æ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ‰€æ¶ˆè´¹ï¼Œé‚£ä¹ˆå¯ä»¥å°†è¿™äº›æ¶ˆè´¹è€…æ”¾åˆ°åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­ï¼Œè¿™å®é™…ä¸Šå°±æ˜¯å•æ’­çš„æ•ˆæœã€‚</div><h2 id="åˆ†åŒºåˆ†é…ç­–ç•¥"><a href="#åˆ†åŒºåˆ†é…ç­–ç•¥" class="headerlink" title="åˆ†åŒºåˆ†é…ç­–ç•¥"></a>åˆ†åŒºåˆ†é…ç­–ç•¥</h2><p>ä¸€ä¸ª consumer group ä¸­æœ‰å¤šä¸ª consumerï¼Œä¸€ä¸ª topic æœ‰å¤šä¸ª partitionï¼Œæ‰€ä»¥å¿…ç„¶ä¼šæ¶‰åŠåˆ° partition çš„åˆ†é…é—®é¢˜ï¼Œå³ç¡®å®šé‚£ä¸ª partition ç”±å“ªä¸ª consumer æ¥æ¶ˆè´¹ã€‚</p><p>Kafka æœ‰ä¸¤ç§åˆ†é…ç­–ç•¥ï¼Œä¸€æ˜¯ RoundRobinï¼Œä¸€æ˜¯ Rangeã€‚</p><h3 id="RoundRobin"><a href="#RoundRobin" class="headerlink" title="RoundRobin"></a>RoundRobin</h3><p>RoundRobinå³è½®è¯¢çš„æ„æ€ï¼Œæ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªä¸‰ä¸ªæ¶ˆè´¹è€…ConsumerAã€ConsumerBå’ŒConsumerCç»„æˆçš„æ¶ˆè´¹è€…ç»„ï¼ŒåŒæ—¶æ¶ˆè´¹TopicAä¸»é¢˜æ¶ˆæ¯ï¼ŒTopicAåˆ†ä¸º7ä¸ªåˆ†åŒºï¼Œå¦‚æœé‡‡ç”¨RoundRobinåˆ†é…ç­–ç•¥ï¼Œè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200401-145222@2x.png" alt="QQ20200401-145222@2x"></p><p>è¿™ç§è½®è¯¢çš„æ–¹å¼åº”è¯¥å¾ˆå¥½ç†è§£ã€‚ä½†å¦‚æœæ¶ˆè´¹è€…ç»„æ¶ˆè´¹å¤šä¸ªä¸»é¢˜çš„å¤šä¸ªåˆ†åŒºï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿæ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªä¸¤ä¸ªæ¶ˆè´¹è€…ConsumerAå’ŒConsumerBç»„æˆçš„æ¶ˆè´¹è€…ç»„ï¼ŒåŒæ—¶æ¶ˆè´¹TopicAå’ŒTopicBä¸»é¢˜æ¶ˆæ¯ï¼Œå¦‚æœé‡‡ç”¨RoundRobinåˆ†é…ç­–ç•¥ï¼Œè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200401-150317@2x.png" alt="QQ20200401-150317@2x"></p><blockquote><p>æ³¨ï¼šTAP0è¡¨ç¤ºTopicA Partition0åˆ†åŒºæ•°æ®ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p></blockquote><p>è¿™ç§æƒ…å†µä¸‹ï¼Œé‡‡ç”¨RoundRobinç®—æ³•åˆ†é…ï¼Œå¤šä¸ªä¸»é¢˜ä¼šè¢«å½“åšä¸€ä¸ªæ•´ä½“æ¥çœ‹ï¼Œè¿™ä¸ªæ•´ä½“åŒ…å«äº†å„è‡ªçš„Partitionï¼Œæ¯”å¦‚åœ¨<a href="https://mvnrepository.com/artifact/org.apache.kafka/kafka-clients/2.4.1" target="_blank" rel="noopener">Kafka-clients</a>ä¾èµ–ä¸­ï¼Œä¸ä¹‹å¯¹åº”çš„å¯¹è±¡ä¸º<code>TopicPartition</code>ã€‚æ¥ç€å°†è¿™äº›<code>TopicPartition</code>æ ¹æ®å…¶å“ˆå¸Œå€¼è¿›è¡Œæ’åºï¼Œæ’åºåé‡‡ç”¨è½®è¯¢çš„æ–¹å¼åˆ†é…ç»™æ¶ˆè´¹è€…ã€‚</p><p>ä½†è¿™ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼šå‡å¦‚ä¸Šå›¾ä¸­çš„æ¶ˆè´¹è€…ç»„ä¸­ï¼ŒConsumerAåªè®¢é˜…äº†TopicAä¸»é¢˜ï¼ŒConsumerBåªè®¢é˜…äº†TopicBä¸»é¢˜ï¼Œé‡‡ç”¨RoundRobinè½®è¯¢ç®—æ³•åï¼Œå¯èƒ½ä¼šå‡ºç°ConsumerAæ¶ˆè´¹äº†TopicBä¸»é¢˜åˆ†åŒºé‡Œçš„æ¶ˆæ¯ï¼ŒConsumerBæ¶ˆè´¹äº†TopicAä¸»é¢˜åˆ†åŒºé‡Œçš„æ¶ˆæ¯ã€‚</p><div class="note info">ç»¼ä¸Šæ‰€è¿°ï¼ŒRoundRobinç®—æ³•åªé€‚ç”¨äºæ¶ˆè´¹è€…ç»„ä¸­æ¶ˆè´¹è€…è®¢é˜…çš„ä¸»é¢˜ç›¸åŒçš„æƒ…å†µã€‚åŒæ—¶ä¼šå‘ç°ï¼Œé‡‡ç”¨RoundRobinç®—æ³•ï¼Œæ¶ˆè´¹è€…ç»„é‡Œçš„æ¶ˆè´¹è€…ä¹‹é—´æ¶ˆè´¹çš„æ¶ˆæ¯ä¸ªæ•°æœ€å¤šç›¸å·®1ä¸ªã€‚</div><h3 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h3><p>Kafkaé»˜è®¤é‡‡ç”¨Rangeåˆ†é…ç­–ç•¥ï¼ŒRangeé¡¾åæ€ä¹‰å°±æ˜¯æŒ‰èŒƒå›´åˆ’åˆ†çš„æ„æ€ã€‚</p><p>æ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªä¸‰ä¸ªæ¶ˆè´¹è€…ConsumerAã€ConsumerBå’ŒConsumerCç»„æˆçš„æ¶ˆè´¹è€…ç»„ï¼ŒåŒæ—¶æ¶ˆè´¹TopicAä¸»é¢˜æ¶ˆæ¯ï¼ŒTopicAåˆ†ä¸º7ä¸ªåˆ†åŒºï¼Œå¦‚æœé‡‡ç”¨Rangeåˆ†é…ç­–ç•¥ï¼Œè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200401-152904@2x.png" alt="QQ20200401-152904@2x"></p><p>å‡å¦‚ç°åœ¨æœ‰ä¸€ä¸ªä¸¤ä¸ªæ¶ˆè´¹è€…ConsumerAå’ŒConsumerBç»„æˆçš„æ¶ˆè´¹è€…ç»„ï¼ŒåŒæ—¶æ¶ˆè´¹TopicAå’ŒTopicBä¸»é¢˜æ¶ˆæ¯ï¼Œå¦‚æœé‡‡ç”¨Rangeåˆ†é…ç­–ç•¥ï¼Œè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200401-153300@2x.png" alt="QQ20200401-153300@2x"></p><p>Rangeç®—æ³•å¹¶ä¸ä¼šæŠŠå¤šä¸ªä¸»é¢˜åˆ†åŒºå½“æˆä¸€ä¸ªæ•´ä½“ã€‚</p><div class="note info">ä»ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºRangeç®—æ³•çš„ä¸€ä¸ªå¼Šç«¯ï¼šé‚£å°±æ˜¯åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„å†…çš„æ¶ˆè´¹è€…æ¶ˆè´¹çš„æ¶ˆæ¯æ•°é‡ç›¸å·®å¯èƒ½è¾ƒå¤§ã€‚</div><h2 id="offsetç»´æŠ¤"><a href="#offsetç»´æŠ¤" class="headerlink" title="offsetç»´æŠ¤"></a>offsetç»´æŠ¤</h2><p>offsetç”±æ¶ˆæ¯çš„ä¸»é¢˜Topic+åˆ†åŒºPartitionå’Œæ¶ˆè´¹è€…ç»„åç§°å”¯ä¸€ç¡®å®šã€‚</p><p>ç”±äº consumer åœ¨æ¶ˆè´¹è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°æ–­ç”µå®•æœºç­‰æ•…éšœï¼Œconsumer æ¢å¤åï¼Œéœ€è¦ä»æ•… éšœå‰çš„ä½ç½®çš„ç»§ç»­æ¶ˆè´¹ï¼Œæ‰€ä»¥ consumer éœ€è¦å®æ—¶è®°å½•è‡ªå·±æ¶ˆè´¹åˆ°äº†å“ªä¸ª offsetï¼Œä»¥ä¾¿æ•…éšœæ¢ å¤åç»§ç»­æ¶ˆè´¹ã€‚</p><p>Kafka 0.9 ç‰ˆæœ¬ä¹‹å‰ï¼Œconsumer é»˜è®¤å°† offset ä¿å­˜åœ¨ Zookeeper ä¸­ï¼Œä» 0.9 ç‰ˆæœ¬å¼€å§‹ï¼Œ consumer é»˜è®¤å°† offset ä¿å­˜åœ¨ Kafka ä¸€ä¸ªå†…ç½®çš„ topic ä¸­ï¼Œè¯¥ topic ä¸º__consumer_offsetsã€‚</p><blockquote><p>ã€Œå°šç¡…è°·å¤§æ•°æ®æŠ€æœ¯ä¹‹ Kafkaã€ å­¦ä¹ ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Kafkaæ¶ˆè´¹è€…é‡‡ç”¨pullæ‹‰æ¨¡å¼ä»brokerä¸­æ¶ˆè´¹æ•°æ®ã€‚ä¸ä¹‹ç›¸å¯¹çš„pushï¼ˆæ¨ï¼‰æ¨¡å¼å¾ˆéš¾é€‚åº”æ¶ˆè´¹é€Ÿç‡ä¸åŒçš„æ¶ˆè´¹è€…ï¼Œå› ä¸ºæ¶ˆæ¯å‘é€é€Ÿç‡æ˜¯ç”± broker å†³å®šçš„ã€‚å®ƒçš„ç›®æ ‡æ˜¯å°½å¯èƒ½ä»¥æœ€å¿«é€Ÿåº¦ä¼ é€’æ¶ˆæ¯ï¼Œä½†æ˜¯è¿™æ ·å¾ˆå®¹æ˜“é€ æˆ consumer æ¥ä¸åŠå¤„ç†æ¶ˆæ¯ã€‚è€Œ pull æ¨¡å¼åˆ™å¯ä»¥æ ¹æ® consumer çš„æ¶ˆè´¹èƒ½åŠ›ä»¥é€‚å½“çš„é€Ÿç‡æ¶ˆè´¹æ¶ˆæ¯ã€‚pull æ¨¡å¼ä¸è¶³ä¹‹å¤„æ˜¯ï¼Œå¦‚æœ kafka æ²¡æœ‰æ•°æ®ï¼Œæ¶ˆè´¹è€…å¯èƒ½ä¼šé™·å…¥å¾ªç¯ä¸­ï¼Œä¸€ç›´è¿”å›ç©ºæ•°æ®ã€‚é’ˆå¯¹è¿™ä¸€ç‚¹ï¼ŒKafka çš„æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ•°æ®æ—¶ä¼šä¼ å…¥ä¸€ä¸ªæ—¶é•¿å‚æ•° timeoutï¼Œå¦‚æœå½“å‰æ²¡æœ‰æ•°æ®å¯ä¾›æ¶ˆè´¹ï¼Œconsumer ä¼šç­‰å¾…ä¸€æ®µæ—¶é—´ä¹‹åå†è¿”å›ï¼Œè¿™æ®µæ—¶é•¿å³ä¸º timeoutã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kafka" scheme="http://mrbird.cc/tags/Kafka/"/>
    
  </entry>
  
  <entry>
    <title>Kafkaç”Ÿäº§è€…</title>
    <link href="http://mrbird.cc/Kafka%E7%94%9F%E4%BA%A7%E8%80%85.html"/>
    <id>http://mrbird.cc/Kafkaç”Ÿäº§è€….html</id>
    <published>2020-03-26T14:07:25.000Z</published>
    <updated>2020-04-01T11:40:08.244Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p>Kafkaç”Ÿäº§è€…ç”¨äºç”Ÿäº§æ¶ˆæ¯ã€‚é€šè¿‡å‰é¢çš„å†…å®¹æˆ‘ä»¬çŸ¥é“ï¼ŒKafkaçš„topicå¯ä»¥æœ‰å¤šä¸ªåˆ†åŒºï¼Œé‚£ä¹ˆç”Ÿäº§è€…å¦‚ä½•å°†è¿™äº›æ•°æ®å¯é åœ°å‘é€åˆ°è¿™äº›åˆ†åŒºï¼Ÿç”Ÿäº§è€…å‘é€æ•°æ®çš„ä¸åŒçš„åˆ†åŒºçš„ä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿé’ˆå¯¹è¿™ä¸¤ä¸ªç–‘é—®ï¼Œè¿™èŠ‚ç®€å•è®°å½•ä¸‹ã€‚</p><a id="more"></a><h2 id="ä¸ºä½•è¦åˆ†åŒº"><a href="#ä¸ºä½•è¦åˆ†åŒº" class="headerlink" title="ä¸ºä½•è¦åˆ†åŒº"></a>ä¸ºä½•è¦åˆ†åŒº</h2><ol><li><p>æ–¹ä¾¿åœ¨é›†ç¾¤ä¸­æ‰©å±•ï¼Œæ¯ä¸ªåˆ†åŒºPartitionå¯ä»¥é€šè¿‡è°ƒæ•´ä»¥é€‚åº”å®ƒæ‰€åœ¨çš„æœºå™¨ï¼Œè€Œä¸€ä¸ª topicåˆå¯ä»¥æœ‰å¤šä¸ªPartitionç»„æˆï¼Œå› æ­¤æ•´ä¸ªé›†ç¾¤å°±å¯ä»¥é€‚åº”ä»»æ„å¤§å°çš„æ•°æ®äº†ï¼›</p></li><li><p>å¯ä»¥æé«˜å¹¶å‘ï¼Œå› ä¸ºKafkaå¯ä»¥ä»¥Partitionä¸ºå•ä½è¿›è¡Œè¯»å†™ã€‚</p></li></ol><h2 id="ç”Ÿäº§è€…å‘é€æ•°æ®åˆ°ä¸åŒåˆ†åŒºçš„ä¾æ®"><a href="#ç”Ÿäº§è€…å‘é€æ•°æ®åˆ°ä¸åŒåˆ†åŒºçš„ä¾æ®" class="headerlink" title="ç”Ÿäº§è€…å‘é€æ•°æ®åˆ°ä¸åŒåˆ†åŒºçš„ä¾æ®"></a>ç”Ÿäº§è€…å‘é€æ•°æ®åˆ°ä¸åŒåˆ†åŒºçš„ä¾æ®</h2><p>ä»¥<a href="https://mvnrepository.com/artifact/org.apache.kafka/kafka-clients/2.4.1" target="_blank" rel="noopener">Kafka-clients</a>ä¾èµ–ä¸ºä¾‹ï¼Œç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯é€šè¿‡<code>ProducerRecord</code>å¯¹è±¡è¡¨ç¤ºï¼Œå…¶é‡è½½äº†6ä¸ªæ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ProducerRecord</span> <span class="params">(String topic, Integer partition, Long timestamp, K key, V value, Iterable&lt;Header&gt; headers)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ProducerRecord</span> <span class="params">(String topic, Integer partition, Long timestamp, K key, V value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ProducerRecord</span> <span class="params">(String topic, Integer partition, K key, V value, Iterable&lt;Header&gt; headers)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ProducerRecord</span> <span class="params">(String topic, Integer partition, K key, V value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ProducerRecord</span> <span class="params">(String topic, K key, V value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ProducerRecord</span> <span class="params">(String topic, V value)</span></span></span><br></pre></td></tr></table></figure><ol><li><p>æŒ‡æ˜ partition çš„æƒ…å†µä¸‹ï¼Œç›´æ¥å°†æŒ‡æ˜çš„å€¼ç›´æ¥ä½œä¸º partiton å€¼ï¼›</p></li><li><p>æ²¡æœ‰æŒ‡æ˜ partition å€¼ä½†æœ‰ key çš„æƒ…å†µä¸‹ï¼Œå°† key çš„ hash å€¼ä¸ topic çš„ partition æ•°è¿›è¡Œå–ä½™å¾—åˆ° partition å€¼ã€‚æ‰€ä»¥ï¼Œå¦‚æœå¸Œæœ›æŸç»„æ¶ˆæ¯åœ¨Kafkaé›†ç¾¤å…¨å±€æœ‰åºï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šç›¸åŒçš„æ¶ˆæ¯keyæ¥å®ç°ï¼›</p></li><li><p>æ—¢æ²¡æœ‰ partition å€¼åˆæ²¡æœ‰ key å€¼çš„æƒ…å†µä¸‹ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶éšæœºç”Ÿæˆä¸€ä¸ªæ•´æ•°ï¼ˆå é¢æ¯æ¬¡è°ƒç”¨åœ¨è¿™ä¸ªæ•´æ•°ä¸Šè‡ªå¢ï¼‰ï¼Œå°†è¿™ä¸ªå€¼ä¸ topic å¯ç”¨çš„ partition æ€»æ•°å–ä½™å¾—åˆ° partition å€¼ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ round-robin ç®—æ³•ã€‚</p></li></ol><h2 id="æ•°æ®å¯é æ€§çš„ä¿è¯"><a href="#æ•°æ®å¯é æ€§çš„ä¿è¯" class="headerlink" title="æ•°æ®å¯é æ€§çš„ä¿è¯"></a>æ•°æ®å¯é æ€§çš„ä¿è¯</h2><p>æ•°æ®å¯é æ€§æŒ‡çš„æ˜¯ï¼š producer å‘é€çš„æ•°æ®ï¼Œèƒ½å¯é çš„å‘é€åˆ°æŒ‡å®šçš„ topicã€‚</p><h3 id="ack"><a href="#ack" class="headerlink" title="ack"></a>ack</h3><p>topic çš„æ¯ä¸ª partition æ”¶åˆ° producer å‘é€çš„æ•°æ®åï¼Œéƒ½éœ€è¦å‘ producer å‘é€ <strong><span style="color:red">ack</span></strong>ï¼ˆ<strong>acknowledgement</strong> ç¡®è®¤æ”¶åˆ°ï¼‰ï¼Œå¦‚æœ producer æ”¶åˆ° ackï¼Œå°±ä¼šè¿›è¡Œä¸‹ä¸€è½®çš„å‘é€ï¼Œå¦åˆ™é‡æ–°å‘é€æ•°æ®ã€‚</p><p>å‰¯æœ¬åŒæ­¥ç­–ç•¥ä¸»è¦æœ‰å¦‚ä¸‹ä¸¤ç§ï¼š</p><table><tr><th>ç­–ç•¥</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr><tr><td>åŠæ•°ä»¥ä¸Šå®ŒæˆåŒæ­¥ï¼Œå°±å‘é€ ack</td><td>å»¶è¿Ÿä½</td><td>é€‰ä¸¾æ–°çš„ leader æ—¶ï¼Œå®¹å¿ n å°èŠ‚ç‚¹çš„æ•…éšœï¼Œéœ€è¦ 2n+1 ä¸ªå‰¯æœ¬</td></tr><tr><td>å…¨éƒ¨å®ŒæˆåŒæ­¥ï¼Œæ‰å‘é€ack</td><td>é€‰ä¸¾æ–°çš„ leader æ—¶ï¼Œå®¹å¿ n å°èŠ‚ç‚¹çš„æ•…éšœï¼Œéœ€è¦ n+1 ä¸ªå‰¯æœ¬</td><td>å»¶è¿Ÿé«˜</td></tr></table><p>Kafka é€‰æ‹©äº†ç¬¬äºŒç§æ–¹æ¡ˆï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><ol><li>åŒæ ·ä¸ºäº†å®¹å¿ n å°èŠ‚ç‚¹çš„æ•…éšœï¼Œç¬¬ä¸€ç§æ–¹æ¡ˆéœ€è¦ 2n+1 ä¸ªå‰¯æœ¬ï¼Œè€Œç¬¬äºŒç§æ–¹æ¡ˆåªéœ€è¦ n+1 ä¸ªå‰¯æœ¬ï¼Œè€Œ Kafka çš„æ¯ä¸ªåˆ†åŒºéƒ½æœ‰å¤§é‡çš„æ•°æ®ï¼Œç¬¬ä¸€ç§æ–¹æ¡ˆä¼šé€ æˆå¤§é‡æ•°æ®çš„å†—ä½™ã€‚</li><li>è™½ç„¶ç¬¬äºŒç§æ–¹æ¡ˆçš„ç½‘ç»œå»¶è¿Ÿä¼šæ¯”è¾ƒé«˜ï¼Œä½†ç½‘ç»œå»¶è¿Ÿå¯¹ Kafka çš„å½±å“è¾ƒå°ã€‚</li></ol><p>å¯¹äºæŸäº›ä¸å¤ªé‡è¦çš„æ•°æ®ï¼Œå¯¹æ•°æ®çš„å¯é æ€§è¦æ±‚ä¸æ˜¯å¾ˆé«˜ï¼Œèƒ½å¤Ÿå®¹å¿æ•°æ®çš„å°‘é‡ä¸¢å¤±ï¼Œ æ‰€ä»¥æ²¡å¿…è¦ç­‰æ‰€æœ‰ follower å…¨éƒ¨æ¥æ”¶æˆåŠŸï¼Œäºæ˜¯ Kafka ä¸ºç”¨æˆ·æä¾›äº†ä¸‰ç§å¯é æ€§çº§åˆ«ï¼Œç”¨æˆ·æ ¹æ®å¯¹å¯é æ€§å’Œå»¶è¿Ÿçš„è¦æ±‚è¿›è¡Œæƒè¡¡ï¼Œ é€‰æ‹©ä»¥ä¸‹çš„acks å‚æ•°é…ç½®ï¼š</p><ul><li><p>0ï¼šproducer ä¸ç­‰å¾… broker çš„ ackï¼Œè¿™ä¸€æ“ä½œæä¾›äº†ä¸€ä¸ªæœ€ä½çš„å»¶è¿Ÿï¼Œbroker ä¸€æ¥æ”¶åˆ°è¿˜ æ²¡æœ‰å†™å…¥ç£ç›˜å°±å·²ç»è¿”å›ï¼Œå½“ broker æ•…éšœæ—¶æœ‰å¯èƒ½<span style="color:red">ä¸¢å¤±æ•°æ®</span>ï¼›</p></li><li><p>1ï¼šproducer ç­‰å¾… broker çš„ ackï¼Œpartition çš„ leader è½ç›˜æˆåŠŸåè¿”å› ackï¼Œå¦‚æœåœ¨ follower åŒæ­¥æˆåŠŸä¹‹å‰ leader æ•…éšœï¼Œé‚£ä¹ˆå°†ä¼š<span style="color:red">ä¸¢å¤±æ•°æ®</span>ï¼›</p></li><li><p>-1ï¼ˆallï¼‰ï¼šproducer ç­‰å¾… broker çš„ ackï¼Œpartition çš„ leader å’Œ follower å…¨éƒ¨è½ç›˜æˆåŠŸåæ‰ è¿”å› ackã€‚ä½†æ˜¯å¦‚æœåœ¨ follower åŒæ­¥å®Œæˆåï¼Œbroker å‘é€ ack ä¹‹å‰ï¼Œleader å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆä¼šé€ æˆ<span style="color:red">æ•°æ®é‡å¤</span>ã€‚</p></li></ul><h3 id="ISR"><a href="#ISR" class="headerlink" title="ISR"></a>ISR</h3><p>ç”±äºKafkaå‰¯æœ¬åŒæ­¥ç­–ç•¥é€‰æ‹©çš„æ˜¯è¡¨æ ¼ä¸­çš„ç¬¬äºŒç§ï¼Œå³ç­‰å¾…æ‰€æœ‰followerå‰¯æœ¬åŒæ­¥å®Œæˆï¼Œæ‰å‘é€ackï¼Œé‚£ä¹ˆå°±ä¼šå¸¦æ¥å¦‚ä¸‹é—®é¢˜ï¼Œè®¾æƒ³ä¸‹ï¼šleader æ”¶åˆ°æ•°æ®ï¼Œæ‰€æœ‰ follower éƒ½å¼€å§‹åŒæ­¥æ•°æ®ï¼Œ ä½†æœ‰ä¸€ä¸ª followerï¼Œå› ä¸ºæŸç§æ•…éšœï¼Œè¿Ÿè¿Ÿä¸èƒ½ä¸ leader è¿›è¡ŒåŒæ­¥ï¼Œé‚£ leader å°±è¦ä¸€ç›´ç­‰ä¸‹å»ï¼Œ ç›´åˆ°å®ƒå®ŒæˆåŒæ­¥ï¼Œæ‰èƒ½å‘é€ ackã€‚è¿™ä¸ªé—®é¢˜æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p><p>Leader ç»´æŠ¤äº†ä¸€ä¸ªåŠ¨æ€çš„ <strong>in-sync replica set</strong> (<span style="color:red">ISR</span>)ï¼Œæ„ä¸ºå’Œ leader ä¿æŒåŒæ­¥çš„ follower é›† åˆã€‚å½“ ISR ä¸­çš„ follower å®Œæˆæ•°æ®çš„åŒæ­¥ä¹‹åï¼Œleader å°±ä¼šç»™ follower å‘é€ ackã€‚å¦‚æœ follower é•¿æ—¶é—´æœªå‘ leader åŒæ­¥æ•°æ® ï¼Œ åˆ™è¯¥ follower å°†è¢«è¸¢å‡ºISR ï¼Œ è¯¥æ—¶é—´é˜ˆå€¼ç”±<code>replica.lag.time.max.ms</code>å‚æ•°è®¾å®šã€‚Leader å‘ç”Ÿæ•…éšœä¹‹åï¼Œå°±ä¼šä» ISR ä¸­é€‰ä¸¾æ–°çš„ leaderã€‚</p><h3 id="æ•°æ®ä¸€è‡´æ€§é—®é¢˜"><a href="#æ•°æ®ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="æ•°æ®ä¸€è‡´æ€§é—®é¢˜"></a>æ•°æ®ä¸€è‡´æ€§é—®é¢˜</h3><p>ç”±äºæˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯Kafkaé›†ç¾¤ä¸­æ¯æ—¶æ¯åˆ»followerçš„é•¿åº¦éƒ½å’Œleaderä¸€è‡´ï¼ˆå³æ•°æ®åŒæ­¥æ˜¯æœ‰æ—¶å»¶çš„ï¼‰ï¼Œé‚£ä¹ˆå½“leaderæŒ‚æ‰é€‰ä¸¾æŸä¸ªfollowerä¸ºæ–°çš„leaderçš„æ—¶å€™ï¼ˆåŸå…ˆæŒ‚æ‰çš„leaderæ¢å¤äº†æˆä¸ºäº†followerï¼‰ï¼Œå¯èƒ½ä¼šå‡ºç°leaderçš„æ•°æ®æ¯”followerè¿˜å°‘çš„æƒ…å†µã€‚ä¸ºäº†è§£å†³è¿™ç§æ•°æ®é‡ä¸ä¸€è‡´å¸¦æ¥çš„æ··ä¹±æƒ…å†µï¼ŒKafkaæå‡ºäº†ä»¥ä¸‹æ¦‚å¿µï¼š</p><p><img src="img/QQ20200401-093957@2x.png" alt="QQ20200401-093957@2x"></p><ul><li>LEOï¼ˆLog End Offsetï¼‰ï¼šæŒ‡çš„æ˜¯æ¯ä¸ªå‰¯æœ¬æœ€åä¸€ä¸ªoffsetï¼›</li><li>HWï¼ˆHigh Watherï¼‰ï¼šæŒ‡çš„æ˜¯æ¶ˆè´¹è€…èƒ½è§åˆ°çš„æœ€å¤§çš„ offsetï¼ŒISR é˜Ÿåˆ—ä¸­æœ€å°çš„ LEOã€‚</li></ul><div class="note danger">æ¶ˆè´¹è€…å’Œleaderé€šä¿¡æ—¶ï¼Œåªèƒ½æ¶ˆè´¹HWä¹‹å‰çš„æ•°æ®ï¼ŒHWä¹‹åçš„æ•°æ®å¯¹æ¶ˆè´¹è€…ä¸å¯è§ã€‚</div><p>é’ˆå¯¹è¿™ä¸ªè§„åˆ™ï¼š</p><ul><li><p><strong>å½“followerå‘ç”Ÿæ•…éšœæ—¶</strong>ï¼šfollower å‘ç”Ÿæ•…éšœåä¼šè¢«ä¸´æ—¶è¸¢å‡º ISRï¼Œå¾…è¯¥ follower æ¢å¤åï¼Œfollower ä¼šè¯»å–æœ¬åœ°ç£ç›˜è®°å½•çš„ä¸Šæ¬¡çš„ HWï¼Œå¹¶å°† log æ–‡ä»¶é«˜äº HW çš„éƒ¨åˆ†æˆªå–æ‰ï¼Œä» HW å¼€å§‹å‘ leader è¿›è¡ŒåŒæ­¥ã€‚ç­‰è¯¥ follower çš„ LEO å¤§äºç­‰äºè¯¥ Partition çš„ HWï¼Œå³ follower è¿½ä¸Š leader ä¹‹åï¼Œå°±å¯ä»¥é‡æ–°åŠ å…¥ ISR äº†ã€‚</p></li><li><p><strong>å½“leaderå‘ç”Ÿæ•…éšœæ—¶</strong>ï¼šleader å‘ç”Ÿæ•…éšœä¹‹åï¼Œä¼šä» ISR ä¸­é€‰å‡ºä¸€ä¸ªæ–°çš„ leaderï¼Œä¹‹åï¼Œä¸ºä¿è¯å¤šä¸ªå‰¯æœ¬ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Œå…¶ä½™çš„ follower ä¼šå…ˆå°†å„è‡ªçš„ log æ–‡ä»¶é«˜äº HW çš„éƒ¨åˆ†æˆªæ‰ï¼Œç„¶åä»æ–°çš„ leader åŒæ­¥æ•°æ®ã€‚</p></li></ul><div class="note danger">æ‰€ä»¥æ•°æ®ä¸€è‡´æ€§å¹¶ä¸èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±æˆ–è€…ä¸é‡å¤ï¼Œè¿™æ˜¯ç”±ackæ§åˆ¶çš„ã€‚HWè§„åˆ™åªèƒ½ä¿è¯å‰¯æœ¬ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼</div><h3 id="Exactly-Once"><a href="#Exactly-Once" class="headerlink" title="Exactly Once"></a>Exactly Once</h3><p>å°†æœåŠ¡å™¨çš„ ACK çº§åˆ«è®¾ç½®ä¸º-1ï¼Œå¯ä»¥ä¿è¯ Producer åˆ° Server ä¹‹é—´ä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œå³ <strong>At Least Once</strong> è¯­ä¹‰ã€‚ç›¸å¯¹çš„ï¼Œå°†æœåŠ¡å™¨ ACK çº§åˆ«è®¾ç½®ä¸º 0ï¼Œå¯ä»¥ä¿è¯ç”Ÿäº§è€…æ¯æ¡æ¶ˆæ¯åªä¼šè¢« å‘é€ä¸€æ¬¡ï¼Œå³ <strong>At Most Once</strong> è¯­ä¹‰ã€‚</p><p>At Least Once å¯ä»¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®ä¸é‡å¤ï¼›ç›¸å¯¹çš„ï¼ŒAt Least Once å¯ä»¥ä¿è¯æ•°æ®ä¸é‡å¤ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€‚ä½†æ˜¯ï¼Œå¯¹äºä¸€äº›éå¸¸é‡è¦çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´ äº¤æ˜“æ•°æ®ï¼Œä¸‹æ¸¸æ•°æ®æ¶ˆè´¹è€…è¦æ±‚æ•°æ®æ—¢ä¸é‡å¤ä¹Ÿä¸ä¸¢å¤±ï¼Œå³ <strong>Exactly Once</strong> è¯­ä¹‰ã€‚åœ¨ 0.11 ç‰ˆ æœ¬ä»¥å‰çš„ Kafkaï¼Œå¯¹æ­¤æ˜¯æ— èƒ½ä¸ºåŠ›çš„ï¼Œåªèƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œå†åœ¨ä¸‹æ¸¸æ¶ˆè´¹è€…å¯¹æ•°æ®åšå…¨å±€ å»é‡ã€‚å¯¹äºå¤šä¸ªä¸‹æ¸¸åº”ç”¨çš„æƒ…å†µï¼Œæ¯ä¸ªéƒ½éœ€è¦å•ç‹¬åšå…¨å±€å»é‡ï¼Œè¿™å°±å¯¹æ€§èƒ½é€ æˆäº†å¾ˆå¤§å½±å“ã€‚ 0.11 ç‰ˆæœ¬çš„ Kafkaï¼Œå¼•å…¥äº†ä¸€é¡¹é‡å¤§ç‰¹æ€§ï¼š<strong>å¹‚ç­‰æ€§</strong>ã€‚æ‰€è°“çš„å¹‚ç­‰æ€§å°±æ˜¯æŒ‡ Producer ä¸è®º å‘ Server å‘é€å¤šå°‘æ¬¡é‡å¤æ•°æ®ï¼ŒServer ç«¯éƒ½åªä¼šæŒä¹…åŒ–ä¸€æ¡ã€‚å¹‚ç­‰æ€§ç»“åˆ At Least Once è¯­ ä¹‰ï¼Œå°±æ„æˆäº† Kafka çš„ Exactly Once è¯­ä¹‰ã€‚å³ï¼š</p><div style="text-align:center;font-weight:600;margin:1rem auto">At Least Once + å¹‚ç­‰æ€§ = Exactly Once</div><p>è¦å¯ç”¨å¹‚ç­‰æ€§ï¼Œåªéœ€è¦å°† Producer çš„å‚æ•°ä¸­ <code>enable.idompotence</code> è®¾ç½®ä¸º true å³å¯ã€‚Kafka çš„å¹‚ç­‰æ€§å®ç°å…¶å®å°±æ˜¯å°†åŸæ¥ä¸‹æ¸¸éœ€è¦åšçš„å»é‡æ”¾åœ¨äº†æ•°æ®ä¸Šæ¸¸ã€‚å¼€å¯å¹‚ç­‰æ€§çš„ Producer åœ¨ åˆå§‹åŒ–çš„æ—¶å€™ä¼šè¢«åˆ†é…ä¸€ä¸ª <strong>PID</strong>ï¼Œå‘å¾€åŒä¸€ Partition çš„æ¶ˆæ¯ä¼šé™„å¸¦ Sequence Numberã€‚è€Œ Broker ç«¯ä¼šå¯¹&lt;PID, Partition, SeqNumber&gt;åšç¼“å­˜ï¼Œå½“å…·æœ‰ç›¸åŒä¸»é”®çš„æ¶ˆæ¯æäº¤æ—¶ï¼ŒBroker åª ä¼šæŒä¹…åŒ–ä¸€æ¡ã€‚</p><div class="note danger">ä½†æ˜¯ Produceré‡å¯åï¼Œå…¶ PID å°±ä¼šå˜åŒ–ï¼ŒåŒæ—¶ä¸åŒçš„ Partition ä¹Ÿå…·æœ‰ä¸åŒä¸»é”®ï¼Œæ‰€ä»¥å¹‚ç­‰æ€§æ— æ³•ä¿è¯è·¨ åˆ†åŒºè·¨ä¼šè¯çš„ Exactly Onceã€‚</div><h2 id="ç”Ÿäº§è€…äº‹åŠ¡"><a href="#ç”Ÿäº§è€…äº‹åŠ¡" class="headerlink" title="ç”Ÿäº§è€…äº‹åŠ¡"></a>ç”Ÿäº§è€…äº‹åŠ¡</h2><p>Kafka ä» 0.11 ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†äº‹åŠ¡æ”¯æŒã€‚äº‹åŠ¡å¯ä»¥ä¿è¯ Kafka åœ¨ Exactly Once è¯­ä¹‰çš„åŸºç¡€ä¸Šï¼Œç”Ÿäº§å’Œæ¶ˆè´¹å¯ä»¥è·¨åˆ†åŒºå’Œä¼šè¯ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚</p><p>ä¸ºäº†å®ç°è·¨åˆ†åŒºè·¨ä¼šè¯çš„äº‹åŠ¡ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ Transaction IDï¼Œå¹¶å°† Producerè·å¾—çš„PID å’ŒTransaction ID ç»‘å®šã€‚è¿™æ ·å½“Producer é‡å¯åå°±å¯ä»¥é€šè¿‡æ­£åœ¨è¿›è¡Œçš„ Transaction ID è·å¾—åŸæ¥çš„ PIDã€‚</p><p>ä¸ºäº†ç®¡ç† Transactionï¼ŒKafka å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ç»„ä»¶ Transaction Coordinatorã€‚Producer å°±æ˜¯é€šè¿‡å’Œ Transaction Coordinator äº¤äº’è·å¾— Transaction ID å¯¹åº”çš„ä»»åŠ¡çŠ¶æ€ã€‚Transaction Coordinator è¿˜è´Ÿè´£å°†äº‹åŠ¡æ‰€æœ‰å†™å…¥ Kafka çš„ä¸€ä¸ªå†…éƒ¨ Topicï¼Œè¿™æ ·å³ä½¿æ•´ä¸ªæœåŠ¡é‡å¯ï¼Œç”±äºäº‹åŠ¡çŠ¶æ€å¾—åˆ°ä¿å­˜ï¼Œè¿›è¡Œä¸­çš„äº‹åŠ¡çŠ¶æ€å¯ä»¥å¾—åˆ°æ¢å¤ï¼Œä»è€Œç»§ç»­è¿›è¡Œã€‚</p><blockquote><p>ã€Œå°šç¡…è°·å¤§æ•°æ®æŠ€æœ¯ä¹‹ Kafkaã€ å­¦ä¹ ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Kafkaç”Ÿäº§è€…ç”¨äºç”Ÿäº§æ¶ˆæ¯ã€‚é€šè¿‡å‰é¢çš„å†…å®¹æˆ‘ä»¬çŸ¥é“ï¼ŒKafkaçš„topicå¯ä»¥æœ‰å¤šä¸ªåˆ†åŒºï¼Œé‚£ä¹ˆç”Ÿäº§è€…å¦‚ä½•å°†è¿™äº›æ•°æ®å¯é åœ°å‘é€åˆ°è¿™äº›åˆ†åŒºï¼Ÿç”Ÿäº§è€…å‘é€æ•°æ®çš„ä¸åŒçš„åˆ†åŒºçš„ä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿé’ˆå¯¹è¿™ä¸¤ä¸ªç–‘é—®ï¼Œè¿™èŠ‚ç®€å•è®°å½•ä¸‹ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kafka" scheme="http://mrbird.cc/tags/Kafka/"/>
    
  </entry>
  
  <entry>
    <title>Kafkaå­˜å‚¨æœºåˆ¶</title>
    <link href="http://mrbird.cc/Kafka%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6.html"/>
    <id>http://mrbird.cc/Kafkaå­˜å‚¨æœºåˆ¶.html</id>
    <published>2020-03-25T14:07:16.000Z</published>
    <updated>2020-03-31T08:03:54.301Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p>Kafkaä¸­æ¶ˆæ¯æ˜¯ä»¥topicè¿›è¡Œåˆ†ç±»çš„ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯ï¼Œéƒ½æ˜¯é¢å‘topicã€‚topicæ˜¯é€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œè€Œpartitionæ˜¯ç‰©ç†ä¸Šçš„æ¦‚å¿µï¼Œæ¯ä¸ªpartitionå¯¹åº”äºä¸€ä¸ªlogæ–‡ä»¶ï¼Œè¯¥logæ–‡ä»¶ä¸­å­˜å‚¨çš„å°±æ˜¯producerç”Ÿäº§çš„æ•°æ®ã€‚Producerç”Ÿäº§çš„æ•°æ®ä¼šè¢«ä¸æ–­è¿½åŠ åˆ°è¯¥logæ–‡ä»¶æœ«ç«¯ï¼Œä¸”æ¯æ¡æ•°æ®éƒ½æœ‰è‡ªå·±çš„offsetã€‚æ¶ˆè´¹è€…ç»„ä¸­çš„æ¯ä¸ªæ¶ˆè´¹è€…ï¼Œéƒ½ä¼šå®æ—¶è®°å½•è‡ªå·±æ¶ˆè´¹åˆ°äº†å“ªä¸ªoffsetï¼Œä»¥ä¾¿å‡ºé”™æ¢å¤æ—¶ï¼Œä»ä¸Šæ¬¡çš„ä½ç½®ç»§ç»­æ¶ˆè´¹ã€‚<a id="more"></a></p><h2 id="topicæ„æˆ"><a href="#topicæ„æˆ" class="headerlink" title="topicæ„æˆ"></a>topicæ„æˆ</h2><p>åœ¨Kafkaä¸­ï¼Œä¸€ä¸ªtopicå¯ä»¥åˆ†ä¸ºå¤šä¸ªpartitionï¼Œä¸€ä¸ªpartitionåˆ†ä¸ºå¤šä¸ªsegmentï¼Œæ¯ä¸ªsegmentå¯¹åº”ä¸¤ä¸ªæ–‡ä»¶ï¼š.indexå’Œ.logæ–‡ä»¶ï¼š</p><p><img src="img/QQ20200330-183300@2x.png" alt="QQ20200330-183300@2x"></p><h2 id="æ¶ˆæ¯å­˜å‚¨åŸç†"><a href="#æ¶ˆæ¯å­˜å‚¨åŸç†" class="headerlink" title="æ¶ˆæ¯å­˜å‚¨åŸç†"></a>æ¶ˆæ¯å­˜å‚¨åŸç†</h2><p>ç”±äºç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯ä¼šä¸æ–­è¿½åŠ åˆ°logæ–‡ä»¶æœ«å°¾ï¼Œä¸ºé˜²æ­¢logæ–‡ä»¶è¿‡å¤§å¯¼è‡´æ•°æ®å®šä½æ•ˆç‡ä½ä¸‹ï¼ŒKafkaé‡‡å–äº†<strong>åˆ†ç‰‡</strong>å’Œ<strong>ç´¢å¼•</strong>æœºåˆ¶ï¼Œå°†æ¯ä¸ªpartitionåˆ†ä¸ºå¤šä¸ªsegmentã€‚å¦‚å‰é¢æ‰€è¯´ï¼Œæ¯ä¸ªsegmentå¯¹åº”.indexæ–‡ä»¶å’Œ.logæ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶ä½äºä¸€ä¸ªä»¥ç‰¹å®šè§„åˆ™å‘½åçš„æ–‡ä»¶å¤¹ä¸‹ï¼Œè¯¥æ–‡ä»¶å¤¹çš„å‘½å è§„åˆ™ä¸ºï¼štopic åç§° + åˆ†åŒºåºå·ã€‚</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚åˆ›å»ºäº†ä¸€ä¸ªåç§°ä¸ºtestçš„topicï¼Œè¯¥topicåªæœ‰ä¸€ä¸ªåˆ†åŒºï¼Œæ‰€ä»¥åœ¨Kafkaæ—¥ä¼šå¿—ç›®å½•ä¸‹ä¼šæœ‰ä¸ªåä¸ºtest-0çš„æ–‡ä»¶å¤¹ï¼š</p><p><img src="img/QQ20200330-183839@2x.png" alt="QQ20200330-183839@2x"></p><p>è¿™äº›æ–‡ä»¶çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><table><thead><tr><th>ç±»åˆ«</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>.index</td><td>åç§»é‡ç´¢å¼•æ–‡ä»¶ï¼Œå­˜å‚¨æ•°æ®å¯¹åº”çš„åç§»é‡</td></tr><tr><td>.timestamp</td><td>æ—¶é—´æˆ³ç´¢å¼•æ–‡ä»¶</td></tr><tr><td>.log</td><td>æ—¥å¿—æ–‡ä»¶ï¼Œå­˜å‚¨ç”Ÿäº§è€…ç”Ÿäº§çš„æ•°æ®</td></tr><tr><td>.snaphot</td><td>å¿«ç…§æ–‡ä»¶</td></tr><tr></tr><tr><td>Leader-epoch-checkpoint</td><td>ä¿å­˜äº†æ¯ä¸€ä»»leaderå¼€å§‹å†™å…¥æ¶ˆæ¯æ—¶çš„offsetï¼Œä¼šå®šæ—¶æ›´æ–°ã€‚ followerè¢«é€‰ä¸ºleaderæ—¶ä¼šæ ¹æ®è¿™ä¸ªç¡®å®šå“ªäº›æ¶ˆæ¯å¯ç”¨</td></tr></tbody></table><p>indexå’Œlogæ–‡ä»¶ä»¥å½“å‰segmentçš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„åç§»é‡offsetå‘½åã€‚åç§»é‡offsetæ˜¯ä¸€ä¸ª64ä½çš„é•¿æ•´å½¢æ•°ï¼Œå›ºå®šæ˜¯20ä½æ•°å­—ï¼Œé•¿åº¦æœªè¾¾åˆ°ï¼Œç”¨0è¿›è¡Œå¡«è¡¥ï¼Œç´¢å¼•æ–‡ä»¶å’Œæ—¥å¿—æ–‡ä»¶éƒ½ç”±è¯¥ä½œä¸ºæ–‡ä»¶åå‘½åè§„åˆ™ã€‚æ‰€ä»¥ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬çš„åç§»é‡æ˜¯ä»0å¼€å§‹çš„ï¼Œ.indexå’Œ.logæ–‡ä»¶åç§°éƒ½ä¸º00000000000000000000ã€‚</p><p>ä¸ŠèŠ‚ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ç”Ÿäº§è€…å‘é€äº†helloå’Œworldä¸¤ä¸ªæ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸‹.logæ–‡ä»¶ä¸‹æ˜¯å¦æœ‰è¿™ä¸¤æ¡æ•°æ®ï¼š</p><p><img src="img/QQ20200331-151427@2x.png" alt="QQ20200331-151427@2x"></p><p>å†…å®¹å­˜åœ¨ä¸€äº›â€ä¹±ç â€œï¼Œå› ä¸ºæ•°æ®æ˜¯ç»è¿‡åºåˆ—åŒ–å‹ç¼©çš„ã€‚</p><p>é‚£ä¹ˆæ•°æ®æ–‡ä»¶.logå¤§å°æœ‰é™åˆ¶å—ï¼Œèƒ½ä¿å­˜å¤šä¹…æ—¶é—´ï¼Ÿè¿™äº›æˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡Kafkaç›®å½•ä¸‹conf/server.propertiesé…ç½®æ–‡ä»¶ä¿®æ”¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># logæ–‡ä»¶å­˜å‚¨æ—¶é—´ï¼Œå•ä½ä¸ºå°æ—¶ï¼Œè¿™é‡Œè®¾ç½®ä¸º1å‘¨</span><br><span class="line">log.retention.hours=168</span><br><span class="line"></span><br><span class="line"># logæ–‡ä»¶å¤§å°çš„æœ€å¤§å€¼ï¼Œè¿™é‡Œä¸º1gï¼Œè¶…è¿‡è¿™ä¸ªå€¼ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„segmentï¼ˆä¹Ÿå°±æ˜¯æ–°çš„.indexå’Œ.logæ–‡ä»¶ï¼‰</span><br><span class="line">log.segment.bytes=1073741824</span><br></pre></td></tr></table></figure><p></p><p>æ¯”å¦‚ï¼Œå½“ç”Ÿäº§è€…ç”Ÿäº§æ•°æ®é‡è¾ƒå¤šï¼Œä¸€ä¸ªsegmentå­˜å‚¨ä¸ä¸‹è§¦å‘åˆ†ç‰‡æ—¶ï¼Œåœ¨æ—¥å¿—topicç›®å½•ä¸‹ä½ ä¼šçœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹æ‰€ç¤ºçš„æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">00000000000000000000.index</span><br><span class="line">00000000000000000000.log</span><br><span class="line">00000000000000170410.index</span><br><span class="line">00000000000000170410.log</span><br><span class="line">00000000000000239430.index</span><br><span class="line">00000000000000239430.log</span><br></pre></td></tr></table></figure><p></p><p>ä¸‹å›¾å±•ç¤ºäº†KafkaæŸ¥æ‰¾æ•°æ®çš„è¿‡ç¨‹ï¼š</p><p><img src="img/QQ20200331-155820@2x.png" alt="QQ20200331-155820@2x"></p><p>æ¯”å¦‚ç°åœ¨è¦æŸ¥æ‰¾åç§»é‡offsetä¸º3çš„æ¶ˆæ¯ï¼Œæ ¹æ®.indexæ–‡ä»¶å‘½åæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œoffsetä¸º3çš„ç´¢å¼•åº”è¯¥ä»0000000000000000000<span style="color:red">0</span>.indexé‡ŒæŸ¥æ‰¾ã€‚æ ¹æ®ä¸Šå›¾æ‰€ç¤ºï¼Œå…¶å¯¹åº”çš„ç´¢å¼•åœ°å€ä¸º756~911ï¼Œæ‰€ä»¥Kafkaå°†è¯»å–0000000000000000000<span style="color:red">0</span>.log 756~911åŒºé—´çš„æ•°æ®ã€‚</p><blockquote><p>ã€Œå°šç¡…è°·å¤§æ•°æ®æŠ€æœ¯ä¹‹ Kafkaã€ å­¦ä¹ ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Kafkaä¸­æ¶ˆæ¯æ˜¯ä»¥topicè¿›è¡Œåˆ†ç±»çš„ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯ï¼Œéƒ½æ˜¯é¢å‘topicã€‚topicæ˜¯é€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œè€Œpartitionæ˜¯ç‰©ç†ä¸Šçš„æ¦‚å¿µï¼Œæ¯ä¸ªpartitionå¯¹åº”äºä¸€ä¸ªlogæ–‡ä»¶ï¼Œè¯¥logæ–‡ä»¶ä¸­å­˜å‚¨çš„å°±æ˜¯producerç”Ÿäº§çš„æ•°æ®ã€‚Producerç”Ÿäº§çš„æ•°æ®ä¼šè¢«ä¸æ–­è¿½åŠ åˆ°è¯¥logæ–‡ä»¶æœ«ç«¯ï¼Œä¸”æ¯æ¡æ•°æ®éƒ½æœ‰è‡ªå·±çš„offsetã€‚æ¶ˆè´¹è€…ç»„ä¸­çš„æ¯ä¸ªæ¶ˆè´¹è€…ï¼Œéƒ½ä¼šå®æ—¶è®°å½•è‡ªå·±æ¶ˆè´¹åˆ°äº†å“ªä¸ªoffsetï¼Œä»¥ä¾¿å‡ºé”™æ¢å¤æ—¶ï¼Œä»ä¸Šæ¬¡çš„ä½ç½®ç»§ç»­æ¶ˆè´¹ã€‚
    
    </summary>
    
    
      <category term="Kafka" scheme="http://mrbird.cc/tags/Kafka/"/>
    
  </entry>
  
  <entry>
    <title>Kafkaå…¥é—¨</title>
    <link href="http://mrbird.cc/Kafka%E5%85%A5%E9%97%A8.html"/>
    <id>http://mrbird.cc/Kafkaå…¥é—¨.html</id>
    <published>2020-03-24T12:07:52.000Z</published>
    <updated>2020-04-01T11:45:55.460Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p><a href="http://kafka.apache.org/" target="_blank" rel="noopener">Kafka</a>æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ï¼Œä¸»è¦åº”ç”¨äºå¤§æ•°æ®å®æ—¶å¤„ç†é¢†åŸŸã€‚</p><a id="more"></a><h2 id="æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼"><a href="#æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼"></a>æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼</h2><ol><li>ç‚¹å¯¹ç‚¹æ¨¡å¼ï¼ˆä¸€å¯¹ä¸€ï¼Œæ¶ˆè´¹è€…ä¸»åŠ¨æ‹‰å–æ•°æ®ï¼Œæ¶ˆæ¯æ”¶åˆ°åæ¶ˆæ¯æ¸…é™¤ï¼‰ã€‚</li></ol><p>æ¶ˆæ¯ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯å‘é€åˆ°Queueä¸­ï¼Œç„¶åæ¶ˆæ¯æ¶ˆè´¹è€…ä»Queueä¸­å–å‡ºå¹¶ä¸”æ¶ˆè´¹æ¶ˆæ¯ã€‚ æ¶ˆæ¯è¢«æ¶ˆè´¹ä»¥åï¼Œqueue ä¸­ä¸å†æœ‰å­˜å‚¨ï¼Œæ‰€ä»¥æ¶ˆæ¯æ¶ˆè´¹è€…ä¸å¯èƒ½æ¶ˆè´¹åˆ°å·²ç»è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚ Queue æ”¯æŒå­˜åœ¨å¤šä¸ªæ¶ˆè´¹è€…ï¼Œä½†æ˜¯å¯¹ä¸€ä¸ªæ¶ˆæ¯è€Œè¨€ï¼Œåªä¼šæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹ã€‚</p><p><img src="img/QQ20200324-202328@2x.png" alt="QQ20200324-202328@2x"></p><ol start="2"><li>å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼ˆä¸€å¯¹å¤šï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ä¹‹åä¸ä¼šæ¸…é™¤æ¶ˆæ¯ï¼‰ã€‚</li></ol><p>æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆå‘å¸ƒï¼‰å°†æ¶ˆæ¯å‘å¸ƒåˆ° topic ä¸­ï¼ŒåŒæ—¶æœ‰å¤šä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆè®¢é˜…ï¼‰æ¶ˆè´¹è¯¥æ¶ˆæ¯ã€‚å’Œç‚¹å¯¹ç‚¹æ–¹å¼ä¸åŒï¼Œå‘å¸ƒåˆ° topic çš„æ¶ˆæ¯ä¼šè¢«æ‰€æœ‰è®¢é˜…è€…æ¶ˆè´¹ã€‚</p><p><img src="img/QQ20200324-203201@2x.png" alt="QQ20200324-203103@2x"></p><p>Kafkaå±äºç¬¬2ç§æ¨¡å¼ã€‚</p><h2 id="Kafkaæ¶æ„"><a href="#Kafkaæ¶æ„" class="headerlink" title="Kafkaæ¶æ„"></a>Kafkaæ¶æ„</h2><p><img src="img/QQ20200324-210522@2x.png" alt="QQ20200324-210522@2x"></p><ol><li>Producer ï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå°±æ˜¯å‘ kafka broker å‘æ¶ˆæ¯çš„å®¢æˆ·ç«¯ï¼›</li><li>Consumer ï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå‘ kafka broker å–æ¶ˆæ¯çš„å®¢æˆ·ç«¯ï¼›</li><li>Consumer Group ï¼ˆCGï¼‰ï¼šæ¶ˆè´¹è€…ç»„ï¼Œç”±å¤šä¸ª consumer ç»„æˆã€‚<span style="color:red">æ¶ˆè´¹è€…ç»„å†…æ¯ä¸ªæ¶ˆè´¹è€…è´Ÿè´£æ¶ˆè´¹ä¸åŒåˆ†åŒºçš„æ•°æ®ï¼Œä¸€ä¸ªåˆ†åŒºåªèƒ½ç”±æ¶ˆè´¹è€…ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼›æ¶ˆè´¹è€…ç»„ä¹‹é—´äº’ä¸å½±å“ã€‚</span>æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½å±äºæŸä¸ªæ¶ˆè´¹è€…ç»„ï¼Œå³æ¶ˆè´¹è€…ç»„æ˜¯é€»è¾‘ä¸Šçš„ä¸€ä¸ªè®¢é˜…è€…ï¼›</li><li>Broker ï¼šä¸€å° kafka æœåŠ¡å™¨å°±æ˜¯ä¸€ä¸ª brokerã€‚ä¸€ä¸ªé›†ç¾¤ç”±å¤šä¸ª broker ç»„æˆã€‚ä¸€ä¸ª brokerå¯ä»¥å®¹çº³å¤šä¸ªtopicï¼›</li><li>Topic ï¼šå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é¢å‘çš„éƒ½æ˜¯ä¸€ä¸ª topicï¼›</li><li>Partitionï¼šä¸ºäº†å®ç°æ‰©å±•æ€§ï¼Œä¸€ä¸ªéå¸¸å¤§çš„ topic å¯ä»¥åˆ†å¸ƒåˆ°å¤šä¸ª brokerï¼ˆå³æœåŠ¡å™¨ï¼‰ä¸Šï¼Œä¸€ä¸ª topic å¯ä»¥åˆ†ä¸ºå¤šä¸ª partitionï¼Œæ¯ä¸ª partition æ˜¯ä¸€ä¸ªæœ‰åºçš„é˜Ÿåˆ—ï¼›</li><li>Replicaï¼šå‰¯æœ¬ï¼Œä¸ºä¿è¯é›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¸Šçš„ partition æ•°æ®ä¸ä¸¢å¤±ï¼Œä¸” kafka ä»ç„¶èƒ½å¤Ÿç»§ç»­å·¥ä½œï¼Œkafkaæä¾›äº†å‰¯æœ¬æœºåˆ¶ï¼Œä¸€ä¸ª topic çš„æ¯ä¸ªåˆ†åŒºéƒ½æœ‰è‹¥å¹²ä¸ªå‰¯æœ¬ï¼Œä¸€ä¸ª leader å’Œè‹¥å¹²ä¸ª followerã€‚</li><li>leaderï¼šæ¯ä¸ªåˆ†åŒºå¤šä¸ªå‰¯æœ¬çš„â€œä¸»â€ï¼Œç”Ÿäº§è€…å‘é€æ•°æ®çš„å¯¹è±¡ï¼Œä»¥åŠæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®çš„å¯¹è±¡éƒ½æ˜¯ leaderã€‚</li><li>followerï¼šæ¯ä¸ªåˆ†åŒºå¤šä¸ªå‰¯æœ¬ä¸­çš„â€œä»â€ï¼Œå®æ—¶ä» leader ä¸­åŒæ­¥æ•°æ®ï¼Œä¿æŒå’Œ leader æ•°æ®çš„åŒæ­¥ã€‚leader å‘ç”Ÿæ•…éšœæ—¶ï¼ŒæŸä¸ª follower ä¼šæˆä¸ºæ–°çš„followerã€‚</li></ol><p>å¯¹äºæ¯ä¸€ä¸ªtopicï¼Œ Kafkaé›†ç¾¤éƒ½ä¼šç»´æŒä¸€ä¸ªåˆ†åŒºæ—¥å¿—ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200331-150027@2x.png" alt="QQ20200331-150027@2x"></p><p>æ¯ä¸ªåˆ†åŒºéƒ½æ˜¯æœ‰åºä¸”é¡ºåºä¸å¯å˜çš„è®°å½•é›†ï¼Œå¹¶ä¸”ä¸æ–­åœ°è¿½åŠ åˆ°ç»“æ„åŒ–çš„commit logæ–‡ä»¶ã€‚åˆ†åŒºä¸­çš„æ¯ä¸€ä¸ªè®°å½•éƒ½ä¼šåˆ†é…ä¸€ä¸ªidå·æ¥è¡¨ç¤ºé¡ºåºï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºoffsetï¼Œoffsetç”¨æ¥å”¯ä¸€çš„æ ‡è¯†åˆ†åŒºä¸­æ¯ä¸€æ¡è®°å½•ã€‚</p><p>Kafkaæ¯ä¸ªåˆ†åŒºçš„æ•°æ®æ˜¯ä¸¥æ ¼æœ‰åºçš„ï¼Œä½†å¤šåˆ†åŒºä¹‹é—´ä¸èƒ½ç¡®ä¿æœ‰åºã€‚</p><h2 id="å®‰è£…ä¸å¯åŠ¨"><a href="#å®‰è£…ä¸å¯åŠ¨" class="headerlink" title="å®‰è£…ä¸å¯åŠ¨"></a>å®‰è£…ä¸å¯åŠ¨</h2><p>æ¼”ç¤ºåœ¨unixç¯å¢ƒä¸‹å®‰è£…ä¸å¯åŠ¨Kafkaã€‚Kafkaä¸‹è½½åœ°å€ï¼š<a href="http://kafka.apache.org/downloadsï¼Œé€‰æ‹©äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½ï¼ˆBinary" target="_blank" rel="noopener">http://kafka.apache.org/downloadsï¼Œé€‰æ‹©äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½ï¼ˆBinary</a> downloadsï¼‰ï¼Œç„¶åè§£å‹å³å¯ã€‚</p><p>Kafkaçš„é…ç½®æ–‡ä»¶ä½äºconfigç›®å½•ä¸‹ï¼Œå› ä¸ºKafkaé›†æˆäº†Zookeeperï¼Œæ‰€ä»¥configç›®å½•ä¸‹é™¤äº†æœ‰Kafkaçš„é…ç½®æ–‡ä»¶server.propertieså¤–ï¼Œè¿˜å¯ä»¥çœ‹åˆ°ä¸€ä¸ªZookeeperé…ç½®æ–‡ä»¶zookeeper.propertiesã€‚</p><p>åœ¨å¯åŠ¨Kafkaå’ŒZookeeperä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåœ¨Kafkaè§£å‹ç›®å½•ä¸‹åˆ›å»ºå¦‚ä¸‹ä¸¤ä¸ªæ—¥å¿—ç›®å½•ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /Users/mrbird/software/kafka_2.4.1/logs/kafka-logs mkdir /Users/mrbird/software/kafka_2.4.1/logs/zk-logs</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«ç”¨äºå­˜æ”¾Kafkaå’ŒZookeeperæ—¥å¿—ã€‚</p><p>ä¿®æ”¹config/zookeeper.propertiesï¼š</p><p><img src="img/QQ20200324-213631@2x.png" alt="QQ20200324-213631@2x"></p><p>ä¿®æ”¹config/server.properties</p><p><img src="img/QQ20200324-213803@2x.png" alt="QQ20200324-213803@2x"> <img src="img/QQ20200324-213840@2x.png" alt="QQ20200324-213840@2x"></p><p>server.propertiesæ›´å¤šå¯ç”¨é…ç½®åŠå«ä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#broker çš„å…¨å±€å”¯ä¸€ç¼–å·ï¼Œä¸èƒ½é‡å¤</span></span><br><span class="line"><span class="string">broker.id=0</span></span><br><span class="line"><span class="comment">#åˆ é™¤ topic åŠŸèƒ½ä½¿èƒ½</span></span><br><span class="line"><span class="string">delete.topic.enable=true</span></span><br><span class="line"><span class="comment">#å¤„ç†ç½‘ç»œè¯·æ±‚çš„çº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="string">num.network.threads=3</span></span><br><span class="line"><span class="comment">#ç”¨æ¥å¤„ç†ç£ç›˜ IO çš„ç°æˆæ•°é‡</span></span><br><span class="line"><span class="string">num.io.threads=8</span></span><br><span class="line"><span class="comment">#å‘é€å¥—æ¥å­—çš„ç¼“å†²åŒºå¤§å°</span></span><br><span class="line"><span class="string">socket.send.buffer.bytes=102400</span></span><br><span class="line"><span class="comment">#æ¥æ”¶å¥—æ¥å­—çš„ç¼“å†²åŒºå¤§å°</span></span><br><span class="line"><span class="string">socket.receive.buffer.bytes=102400</span></span><br><span class="line"><span class="comment">#è¯·æ±‚å¥—æ¥å­—çš„ç¼“å†²åŒºå¤§å°</span></span><br><span class="line"><span class="string">socket.request.max.bytes=104857600</span></span><br><span class="line"><span class="comment">#topic åœ¨å½“å‰ broker ä¸Šçš„åˆ†åŒºä¸ªæ•°</span></span><br><span class="line"><span class="string">num.partitions=1</span></span><br><span class="line"><span class="comment">#ç”¨æ¥æ¢å¤å’Œæ¸…ç† data ä¸‹æ•°æ®çš„çº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="string">num.recovery.threads.per.data.dir=1</span></span><br><span class="line"><span class="comment">#segment æ–‡ä»¶ä¿ç•™çš„æœ€é•¿æ—¶é—´ï¼Œè¶…æ—¶å°†è¢«åˆ é™¤</span></span><br><span class="line"><span class="string">log.retention.hours=168</span></span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹å¥½åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¯åŠ¨Kafkaäº†ã€‚</p><p><strong>1.å¯åŠ¨Zookeeper</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/zookeeper-server-start.sh config/zookeeper.properties</span><br></pre></td></tr></table></figure><p></p><p>å¦‚æœè¦åœ¨åå°å¯åŠ¨Zookeeperï¼Œåˆ™å¯ä»¥ä½¿ç”¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/zookeeper-server-start.sh -daemon config/zookeeper.properties</span><br></pre></td></tr></table></figure><p></p><p><strong>2.å¯åŠ¨Kafka</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/kafka-server-start.sh config/server.properties</span><br></pre></td></tr></table></figure><p></p><p><strong>3.åˆ›å»ºtopic</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/kafka-topics.sh --zookeeper localhost:2181 --create --replication-factor 1 --partitions 1 --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p></p><ul><li>â€“create åˆ›å»º</li><li>â€“topic æŒ‡å®š topic å</li><li>â€“replication-factor å®šä¹‰å‰¯æœ¬æ•°</li><li>â€“partitions å®šä¹‰åˆ†åŒºæ•°</li></ul><p>ä¸Šé¢åˆ›å»ºäº†ä¸€ä¸ªåç§°ä¸ºtestçš„topicï¼Œå‰¯æœ¬æ•°å’Œåˆ†åŒºæ•°éƒ½æ˜¯1ã€‚</p><p><strong>4.å¯åŠ¨ç”Ÿäº§è€…</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/kafka-console-producer.sh --broker-list localhost:9092 --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p></p><p>9092ä¸ºç”Ÿäº§è€…çš„é»˜è®¤ç«¯å£å·ï¼ŒæŒ‡å®štopicä¸ºåˆšåˆšåˆ›å»ºçš„testã€‚</p><p><strong>5.å¯åŠ¨æ¶ˆè´¹è€…</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic <span class="built_in">test</span> --from-beginning</span><br></pre></td></tr></table></figure><p></p><p>â€“from-beginningï¼šä¼šæŠŠä¸»é¢˜ä¸­ä»¥å¾€æ‰€æœ‰çš„æ•°æ®éƒ½è¯»å–å‡ºæ¥ã€‚</p><p>å¯åŠ¨å¥½ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åæˆ‘ä»¬åœ¨ç”Ÿäº§è€…é‡Œç”Ÿäº§å‡ æ¡æ•°æ®:</p><p><img src="img/QQ20200324-220247@2x.png" alt="QQ20200324-220247@2x"></p><p>æ¶ˆè´¹è€…æˆåŠŸæ¥æ”¶åˆ°æ•°æ®ï¼š</p><p><img src="img/QQ20200324-220314@2x.png" alt="QQ20200324-220314@2x"></p><h2 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h2><p>æŸ¥çœ‹å½“å‰æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰ topicï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/kafka-topics.sh --zookeeper localhsot:2181 --list</span><br></pre></td></tr></table></figure><p></p><p>åˆ é™¤ topicï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/kafka-topics.sh --zookeeper localhost:2181 --delete --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p></p><p>éœ€è¦ server.properties ä¸­è®¾ç½®<code>delete.topic.enable=true</code>å¦åˆ™åªæ˜¯æ ‡è®°åˆ é™¤ã€‚</p><p>æŸ¥çœ‹æŸä¸ª Topic çš„è¯¦æƒ…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/kafka-topics.sh --zookeeper localhost:2181 --describe --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹åˆ†åŒºæ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/kafka-topics.sh --zookeeper localhost:2181 --alter --topic <span class="built_in">test</span> --partitions 2</span><br></pre></td></tr></table></figure><p></p><h2 id="ZKçš„ä½œç”¨"><a href="#ZKçš„ä½œç”¨" class="headerlink" title="ZKçš„ä½œç”¨"></a>ZKçš„ä½œç”¨</h2><p>Kafka é›†ç¾¤ä¸­æœ‰ä¸€ä¸ª broker ä¼šè¢«é€‰ä¸¾ä¸º Controllerï¼Œè´Ÿè´£ç®¡ç†é›†ç¾¤ broker çš„ä¸Šä¸‹çº¿ï¼Œæ‰€æœ‰ topic çš„åˆ†åŒºå‰¯æœ¬åˆ†é…å’Œ leader é€‰ä¸¾ç­‰å·¥ä½œã€‚Controller çš„ç®¡ç†å·¥ä½œéƒ½æ˜¯ä¾èµ–äº Zookeeper çš„ã€‚</p><blockquote><p>ã€Œå°šç¡…è°·å¤§æ•°æ®æŠ€æœ¯ä¹‹ Kafkaã€ å­¦ä¹ ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;&lt;a href=&quot;http://kafka.apache.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Kafka&lt;/a&gt;æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ï¼Œä¸»è¦åº”ç”¨äºå¤§æ•°æ®å®æ—¶å¤„ç†é¢†åŸŸã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kafka" scheme="http://mrbird.cc/tags/Kafka/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Alibaba Sentinel @SentinelResource</title>
    <link href="http://mrbird.cc/Spring-Cloud-Alibaba-Sentinel-SentinelResource.html"/>
    <id>http://mrbird.cc/Spring-Cloud-Alibaba-Sentinel-SentinelResource.html</id>
    <published>2020-03-19T08:16:07.000Z</published>
    <updated>2020-03-20T08:50:13.262Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:56:00 GMT+0800 (GMT+08:00) --><p>Sentinelæä¾›äº†<a href="https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81" target="_blank" rel="noopener">@SentinelResource</a>æ³¨è§£ç”¨äºå®šä¹‰èµ„æºï¼Œå¹¶æä¾›å¯é€‰çš„å¼‚å¸¸å›é€€å’ŒBlockå›é€€ã€‚å¼‚å¸¸å›é€€æŒ‡çš„æ˜¯<code>@SentinelResource</code>æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•å‘ç”ŸJavaå¼‚å¸¸æ—¶çš„å›é€€å¤„ç†ï¼›Blockå›é€€æŒ‡çš„æ˜¯å½“<code>@SentinelResource</code>èµ„æºè®¿é—®ä¸ç¬¦åˆSentinelæ§åˆ¶å°å®šä¹‰çš„è§„åˆ™æ—¶çš„å›é€€ï¼ˆé»˜è®¤è¿”å›Blocked by Sentinel (flow limiting)ï¼‰ã€‚è¿™èŠ‚ç®€å•è®°å½•ä¸‹è¯¥æ³¨è§£çš„ç”¨æ³•ã€‚</p><a id="more"></a><h2 id="æ¡†æ¶æ­å»º"><a href="#æ¡†æ¶æ­å»º" class="headerlink" title="æ¡†æ¶æ­å»º"></a>æ¡†æ¶æ­å»º</h2><p>ä½¿ç”¨IDEAåˆ›å»ºä¸€ä¸ªmavené¡¹ç›®ï¼ŒartifactIdä¸ºspring-cloud-alibaba-sentinelresourceï¼Œç„¶ååœ¨å…¶ä¸‹é¢åˆ›å»ºä¸¤ä¸ªModuleï¼ˆSpring Booté¡¹ç›®ï¼‰ï¼ŒartifactIdåˆ†åˆ«ä¸ºconsumerå’Œproviderï¼Œå……å½“æœåŠ¡æ¶ˆè´¹ç«¯å’ŒæœåŠ¡æä¾›ç«¯ï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200320-145134.png" alt="QQ20200320-145134"></p><p>spring-cloud-alibaba-sentinelresourceçš„pomå†…å®¹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-sentinelresource<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>provider<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">com-alibaba-cloud.version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">com-alibaba-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;com-alibaba-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>å¼•å…¥äº†spring-boot-starter-webå’Œspring-cloud-alibaba-nacos-discovery NacosæœåŠ¡æ³¨å†Œå‘ç°ä¾èµ–ã€‚</p><p>providerçš„pomçš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-sentinelresource<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../pom.xml<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>provider<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>æœåŠ¡æä¾›è€…<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>consumerçš„pomå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-sentinelresource<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../pom.xml<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>æœåŠ¡æ¶ˆè´¹è€…<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºè¦æ¼”ç¤ºåœ¨æ¶ˆè´¹ç«¯ä½¿ç”¨<code>@SentinelResource</code>æ³¨è§£ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼•å…¥äº†spring-cloud-starter-alibaba-sentinelä¾èµ–ã€‚</p><p>providerçš„é…ç½®æ–‡ä»¶application.ymlå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">provider</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="attr">localhost:8848</span></span><br></pre></td></tr></table></figure><p></p><p>é…ç½®äº†ç«¯å£å·ï¼ŒæœåŠ¡åå’Œnacosåœ°å€ã€‚</p><p>consumerçš„é…ç½®æ–‡ä»¶application.ymlå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9091</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">consumer</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line"><span class="attr">    sentinel:</span></span><br><span class="line"><span class="attr">      transport:</span></span><br><span class="line"><span class="attr">        dashboard:</span> <span class="attr">localhost:8080</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">8719</span></span><br></pre></td></tr></table></figure><p></p><p>é…ç½®äº†ç«¯å£å·ï¼ŒæœåŠ¡åï¼Œnacosåœ°å€å’Œsentinelæ§åˆ¶å°åœ°å€ç­‰ã€‚</p><h2 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h2><p>æˆ‘ä»¬åœ¨providerä¸‹æ·»åŠ ä¸€ä¸ªRESTèµ„æºã€‚åœ¨providerçš„cc.mrbird.providerç›®å½•ä¸‹æ–°å»ºcontrolleråŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>GoodsController</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"goods"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"buy/&#123;name&#125;/&#123;count&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">buy</span><span class="params">(@PathVariable String name, @PathVariable Integer count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"è´­ä¹°%dä»½%s"</span>, count, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€åœ¨consumerç«¯é€šè¿‡Ribbonæ¶ˆè´¹è¿™ä¸ªèµ„æºã€‚åœ¨consumerçš„å¯åŠ¨ç±»<code>ConsumerApplication</code>é‡Œæ³¨å†Œ<code>RestTemplate</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨consumerçš„cc.mrbird.consumerä¸‹æ–°å»ºcontrolleråŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>BuyController</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuyController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"buy/&#123;name&#125;/&#123;count&#125;"</span>)</span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"buy"</span>, fallback = <span class="string">"buyFallback"</span>, blockHandler = <span class="string">"buyBlock"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">buy</span><span class="params">(@PathVariable String name, @PathVariable Integer count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (count &gt;= <span class="number">20</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"è´­ä¹°æ•°é‡è¿‡å¤š"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"miband"</span>.equalsIgnoreCase(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"å·²å”®ç½„"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        params.put(<span class="string">"name"</span>, name);</span><br><span class="line">        params.put(<span class="string">"count"</span>, count);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.restTemplate.getForEntity(<span class="string">"http://provider/goods/buy/&#123;name&#125;/&#123;count&#125;"</span>, String.class, params).getBody();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼‚å¸¸å›é€€</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">buyFallback</span><span class="params">(@PathVariable String name, @PathVariable Integer count, Throwable throwable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"ã€è¿›å…¥fallbackæ–¹æ³•ã€‘è´­ä¹°%dä»½%så¤±è´¥ï¼Œ%s"</span>, count, name, throwable.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sentinelå›é€€</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">buyBlock</span><span class="params">(@PathVariable String name, @PathVariable Integer count, BlockException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"ã€è¿›å…¥blockHandleræ–¹æ³•ã€‘è´­ä¹°%dä»½%så¤±è´¥ï¼Œå½“å‰è´­ä¹°äººæ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•"</span>, count, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨<code>buy</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡Ribbonçš„<code>RestTemplate</code>è®¿é—®providerçš„<code>/goods/buy</code>æ¥å£ã€‚å½“countå‚æ•°å¤§äº20æˆ–è€…nameå‚æ•°çš„å€¼ä¸ºmibandçš„æ—¶å€™ï¼Œæ–¹æ³•å°†æŠ›å‡ºå¼‚å¸¸ã€‚<code>buy</code>æ–¹æ³•ä¸Šä½¿ç”¨<code>@SentinelResource</code>æ³¨è§£æ ‡æ³¨ï¼Œæ ‡è¯†ä¸ºä¸€ä¸ªsentinelèµ„æºï¼Œèµ„æºåç§°ä¸ºbuyï¼Œå¹¶ä¸”é…ç½®äº†fallbackæ–¹æ³•å’ŒblockHandleræ–¹æ³•ã€‚</p><p>å¦‚å‰é¢æ‰€è¯´ï¼Œå½“<code>buy</code>æ–¹æ³•æœ¬èº«æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œä¼šè¿›å…¥fallbackæŒ‡å®šçš„å›é€€æ–¹æ³•ä¸­ï¼›å½“<code>buy</code>æ–¹æ³•è°ƒç”¨ä¸ç¬¦åˆsentinelæ§åˆ¶å°è§„å®šçš„è§„åˆ™ï¼ˆå¦‚æµæ§è§„åˆ™ï¼Œé™çº§è§„åˆ™ç­‰ï¼‰æ—¶ï¼Œä¼šè¿›å…¥blockHanderæŒ‡å®šçš„blockæ–¹æ³•ä¸­ã€‚ä¸ºäº†ç¡®ä¿æˆåŠŸåœ°è¿›å…¥å›é€€æ–¹æ³•ï¼ˆæˆåŠŸåå°„ï¼‰ï¼Œå®ƒä»¬å¿…é¡»æ»¡è¶³ä»¥ä¸‹è§„åˆ™ï¼š</p><ul><li>å‡½æ•°è®¿é—®èŒƒå›´éœ€è¦æ˜¯<code>public</code>ï¼›</li><li>Fallbackå‡½æ•°ï¼Œå‡½æ•°ç­¾åä¸åŸå‡½æ•°ä¸€è‡´æˆ–æœ«å°¾åŠ ä¸€ä¸ª<code>Throwable</code>ç±»å‹çš„å‚æ•°ï¼›</li><li>Blockå¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œå‚æ•°æœ€åå¤šä¸€ä¸ª<code>BlockException</code>ï¼Œå…¶ä½™ä¸åŸå‡½æ•°ä¸€è‡´ã€‚</li></ul><p>å¯åŠ¨providerã€consumerã€nacoså’Œsentinelæ§åˆ¶å°ï¼Œæµè§ˆå™¨è®¿é—®ï¼š<a href="http://localhost:9091/buy/ipad/2" target="_blank" rel="noopener">http://localhost:9091/buy/ipad/2</a>ï¼š</p><p><img src="img/QQ20200320-151518.png" alt="QQ20200320-151518"></p><p>æˆ‘ä»¬åœ¨sentinelæ§åˆ¶å°ä¸­æ·»åŠ å¦‚ä¸‹æµæ§è§„åˆ™ï¼š</p><p><img src="img/QQ20200320-151651@2x.png" alt="QQ20200320-151651@2x.png"></p><p>QPSé˜ˆå€¼ä¸º2ã€‚</p><p>ç„¶åå¿«é€Ÿè®¿é—®<a href="http://localhost:9091/buy/ipad/2" target="_blank" rel="noopener">http://localhost:9091/buy/ipad/2</a>ï¼š</p><p><img src="img/QQ20200320-152106@2x.png" alt="QQ20200320-152106@2x"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æ–¹æ³•è®¿é—®ä¸ç¬¦åˆsentinelæ§åˆ¶å°è§„åˆ™æ—¶ï¼Œè¿›å…¥çš„æ˜¯blockHandleræŒ‡å®šçš„å›é€€æ–¹æ³•ã€‚</p><p>å¦‚æœè®¿é—®ï¼š<a href="http://localhost:9091/buy/ipad/21" target="_blank" rel="noopener">http://localhost:9091/buy/ipad/21</a></p><p><img src="img/QQ20200320-152155@2x.png" alt="QQ20200320-152155@2x"> æˆ–è€…ï¼š<a href="http://localhost:9091/buy/miband/2" target="_blank" rel="noopener">http://localhost:9091/buy/miband/2</a></p><p><img src="img/QQ20200320-152224@2x.png" alt="QQ20200320-152224@2x"></p><p>æ–¹æ³•è‡ªèº«æŠ›å‡ºå¼‚å¸¸å¼•å‘å›é€€ï¼Œè¿›å…¥çš„æ˜¯fallbackæŒ‡å®šçš„å›é€€æ–¹æ³•ã€‚</p><h2 id="å…¶ä»–å±æ€§"><a href="#å…¶ä»–å±æ€§" class="headerlink" title="å…¶ä»–å±æ€§"></a>å…¶ä»–å±æ€§</h2><p>åœ¨å½“å‰ç±»ä¸­ç¼–å†™å›é€€æ–¹æ³•ä¼šä½¿å¾—ä»£ç å˜å¾—å†—ä½™è€¦åˆåº¦é«˜ï¼Œæˆ‘ä»¬å¯ä»¥å°†å›é€€æ–¹æ³•æŠ½å–å‡ºæ¥åˆ°ä¸€ä¸ªæŒ‡å®šç±»ä¸­ã€‚</p><p>åœ¨cc.mrbird.consumeråŒ…ä¸‹æ–°å»ºrevealåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>BuyBlockHandler</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuyBlockHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sentinelå›é€€</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">buyBlock</span><span class="params">(@PathVariable String name, @PathVariable Integer count, BlockException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"ã€è¿›å…¥blockHandleræ–¹æ³•ã€‘è´­ä¹°%dä»½%så¤±è´¥ï¼Œå½“å‰è´­ä¹°äººæ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•"</span>, count, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åªæ˜¯å°†<code>buyBlock</code>æ–¹æ³•æŒªåˆ°äº†<code>BuyBlockHandler</code>ä¸­ï¼Œä¸è¿‡è¿™é‡Œçš„æ–¹æ³•å¿…é¡»æ˜¯<code>static</code>çš„ã€‚</p><p>æ¥ç€æ–°å»º<code>BuyFallBack</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuyFallBack</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼‚å¸¸å›é€€</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">buyFallback</span><span class="params">(@PathVariable String name, @PathVariable Integer count, Throwable throwable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"ã€è¿›å…¥fallbackæ–¹æ³•ã€‘è´­ä¹°%dä»½%så¤±è´¥ï¼Œ%s"</span>, count, name, throwable.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿™æ ·<code>BuyController</code>çš„ä»£ç å°±å¯ä»¥ç²¾ç®€ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuyController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"buy/&#123;name&#125;/&#123;count&#125;"</span>)</span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"buy"</span>,</span><br><span class="line">            fallback = <span class="string">"buyFallback"</span>,</span><br><span class="line">            fallbackClass = BuyFallBack.class,</span><br><span class="line">            blockHandler = <span class="string">"buyBlock"</span>,</span><br><span class="line">            blockHandlerClass = BuyBlockHandler.class</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">buy</span><span class="params">(@PathVariable String name, @PathVariable Integer count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (count &gt;= <span class="number">20</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"è´­ä¹°æ•°é‡è¿‡å¤š"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"miband"</span>.equalsIgnoreCase(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"å·²å”®ç½„"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        params.put(<span class="string">"name"</span>, name);</span><br><span class="line">        params.put(<span class="string">"count"</span>, count);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.restTemplate.getForEntity(<span class="string">"http://provider/goods/buy/&#123;name&#125;/&#123;count&#125;"</span>, String.class, params).getBody();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>fallbackClass</code>å’Œ<code>blockHandlerClass</code>æŒ‡å®šå›é€€æ–¹æ³•æ‰€åœ¨çš„ç±»ã€‚</p><p>æ­¤å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥å½“é‡åˆ°æŸä¸ªç±»å‹çš„å¼‚å¸¸æ—¶ï¼Œä¸è¿›è¡Œå›é€€ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuyController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"buy/&#123;name&#125;/&#123;count&#125;"</span>)</span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"buy"</span>,</span><br><span class="line">            fallback = <span class="string">"buyFallback"</span>,</span><br><span class="line">            fallbackClass = BuyFallBack.class,</span><br><span class="line">            blockHandler = <span class="string">"buyBlock"</span>,</span><br><span class="line">            blockHandlerClass = BuyBlockHandler.class,</span><br><span class="line">            exceptionsToIgnore = NullPointerException.class</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">buy</span><span class="params">(@PathVariable String name, @PathVariable Integer count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (count &gt;= <span class="number">20</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"è´­ä¹°æ•°é‡è¿‡å¤š"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"miband"</span>.equalsIgnoreCase(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"å·²å”®ç½„"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        params.put(<span class="string">"name"</span>, name);</span><br><span class="line">        params.put(<span class="string">"count"</span>, count);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.restTemplate.getForEntity(<span class="string">"http://provider/goods/buy/&#123;name&#125;/&#123;count&#125;"</span>, String.class, params).getBody();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>exceptionsToIgnore</code>æŒ‡å®šï¼Œå½“é‡åˆ°ç©ºæŒ‡é’ˆå¼‚å¸¸æ—¶ï¼Œä¸å›é€€ã€‚</p><p>é‡å¯consumerï¼Œæµè§ˆå™¨è®¿é—®ï¼š<a href="http://localhost:9091/buy/miband/2" target="_blank" rel="noopener">http://localhost:9091/buy/miband/2</a>ï¼š</p><p><img src="img/QQ20200320-153530@2x.png" alt="QQ20200320-153530@2x"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ¬¡å¹¶æ²¡æœ‰è¿›è¡Œå›é€€ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›error pageã€‚</p><blockquote><p>æœ¬èŠ‚æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/78.spring-cloud-alibaba-sentinelresource" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/78.spring-cloud-alibaba-sentinelresource</a></p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:56:00 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Sentinelæä¾›äº†&lt;a href=&quot;https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;@SentinelResource&lt;/a&gt;æ³¨è§£ç”¨äºå®šä¹‰èµ„æºï¼Œå¹¶æä¾›å¯é€‰çš„å¼‚å¸¸å›é€€å’ŒBlockå›é€€ã€‚å¼‚å¸¸å›é€€æŒ‡çš„æ˜¯&lt;code&gt;@SentinelResource&lt;/code&gt;æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•å‘ç”ŸJavaå¼‚å¸¸æ—¶çš„å›é€€å¤„ç†ï¼›Blockå›é€€æŒ‡çš„æ˜¯å½“&lt;code&gt;@SentinelResource&lt;/code&gt;èµ„æºè®¿é—®ä¸ç¬¦åˆSentinelæ§åˆ¶å°å®šä¹‰çš„è§„åˆ™æ—¶çš„å›é€€ï¼ˆé»˜è®¤è¿”å›Blocked by Sentinel (flow limiting)ï¼‰ã€‚è¿™èŠ‚ç®€å•è®°å½•ä¸‹è¯¥æ³¨è§£çš„ç”¨æ³•ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Cloud" scheme="http://mrbird.cc/tags/Spring-Cloud/"/>
    
      <category term="Spring Cloud Alibaba" scheme="http://mrbird.cc/tags/Spring-Cloud-Alibaba/"/>
    
      <category term="Sentinel" scheme="http://mrbird.cc/tags/Sentinel/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Alibaba Sentinelæ§åˆ¶å°è¯¦è§£</title>
    <link href="http://mrbird.cc/Sentinel%E6%8E%A7%E5%88%B6%E5%8F%B0%E8%AF%A6%E8%A7%A3.html"/>
    <id>http://mrbird.cc/Sentinelæ§åˆ¶å°è¯¦è§£.html</id>
    <published>2020-03-18T08:15:38.000Z</published>
    <updated>2020-03-20T08:49:57.585Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p><a href="https://github.com/alibaba/Sentinel" target="_blank" rel="noopener">Sentinel</a>æä¾›ä¸€ä¸ªè½»é‡çº§çš„å¼€æºæ§åˆ¶å°ï¼Œå®ƒæä¾›æœºå™¨å‘ç°ä»¥åŠå¥åº·æƒ…å†µç®¡ç†ã€ç›‘æ§ï¼ˆå•æœºå’Œé›†ç¾¤ï¼‰ï¼Œè§„åˆ™ç®¡ç†å’Œæ¨é€çš„åŠŸèƒ½ã€‚æœ¬èŠ‚å°†è¯¦ç»†è®°å½•ä½•å¦‚é€šè¿‡Sentinelæ§åˆ¶å°æ§åˆ¶Sentinelå®¢æˆ·ç«¯çš„å„ç§è¡Œä¸ºã€‚Sentinelæ§åˆ¶å°çš„åŠŸèƒ½ä¸»è¦åŒ…æ‹¬ï¼šæµé‡æ§åˆ¶ã€é™çº§æ§åˆ¶ã€çƒ­ç‚¹é…ç½®ã€ç³»ç»Ÿè§„åˆ™å’Œæˆæƒè§„åˆ™ç­‰ã€‚</p><a id="more"></a><h2 id="å®‰è£…æ§åˆ¶å°"><a href="#å®‰è£…æ§åˆ¶å°" class="headerlink" title="å®‰è£…æ§åˆ¶å°"></a>å®‰è£…æ§åˆ¶å°</h2><p>Sentinelæ§åˆ¶å°ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/releases</a>ï¼Œæœ¬èŠ‚æˆ‘ä»¬ä¸‹è½½sentinel-dashboard-1.7.1.jarç‰ˆæœ¬ï¼Œä¸‹è½½å¥½åä½¿ç”¨<code>java -jar sentinel-dashboard-1.7.1.jar</code>å‘½ä»¤å¯åŠ¨å³å¯ï¼Œé»˜è®¤çš„ç«¯å£å·ä¸º8080ï¼š</p><p><img src="img/QQ20200319-092904@2x.png" alt="QQ20200319-092904@2x"></p><p>è´¦å·å¯†ç éƒ½æ˜¯sentinelã€‚</p><p>æ›´å¤šå¯ç”¨çš„å¯åŠ¨å‚æ•°é…ç½®ï¼š</p><ul><li><code>Dsentinel.dashboard.auth.username=sentinel</code>ç”¨äºæŒ‡å®šæ§åˆ¶å°çš„ç™»å½•ç”¨æˆ·åä¸º sentinelï¼›</li><li><code>Dsentinel.dashboard.auth.password=123456</code>ç”¨äºæŒ‡å®šæ§åˆ¶å°çš„ç™»å½•å¯†ç ä¸º 123456ï¼Œå¦‚æœçœç•¥è¿™ä¸¤ä¸ªå‚æ•°ï¼Œé»˜è®¤ç”¨æˆ·å’Œå¯†ç å‡ä¸º sentinelï¼›</li><li><p><code>Dserver.servlet.session.timeout=7200</code>ç”¨äºæŒ‡å®š Spring Boot æœåŠ¡ç«¯ session çš„è¿‡æœŸæ—¶é—´ï¼Œå¦‚ 7200 è¡¨ç¤º 7200 ç§’ï¼›60m è¡¨ç¤º 60 åˆ†é’Ÿï¼Œé»˜è®¤ä¸º 30 åˆ†é’Ÿï¼›</p></li><li><p><code>-Dcsp.sentinel.dashboard.server=consoleIp:port</code>æŒ‡å®šæ§åˆ¶å°åœ°å€å’Œç«¯å£ã€‚</p></li></ul><h2 id="æ­å»ºå®¢æˆ·ç«¯"><a href="#æ­å»ºå®¢æˆ·ç«¯" class="headerlink" title="æ­å»ºå®¢æˆ·ç«¯"></a>æ­å»ºå®¢æˆ·ç«¯</h2><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼ŒartifactIdä¸ºspring-cloud-alibaba-sentinel-dashboard-guideï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200319-094028@2x.png" alt="QQ20200319-094028@2x"></p><p>é¡¹ç›®pomå†…å®¹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-sentinel-dashboard-guide<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>spring-cloud-alibaba-sentinel-dashboard-guide<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">com-alibaba-cloud.version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">com-alibaba-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;com-alibaba-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>å¼•å…¥äº†spring-cloud-starter-alibaba-sentinelå’Œspring-boot-starter-webä¾èµ–ã€‚</p><p>æ¥ç€åœ¨cc.mrbird.sentinelç›®å½•ä¸‹æ–°å»ºcontrolleråŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>TestController</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"test1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æœ€ååœ¨é¡¹ç›®é…ç½®æ–‡ä»¶application.ymlä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">my-project</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    sentinel:</span></span><br><span class="line"><span class="attr">      transport:</span></span><br><span class="line"><span class="attr">        dashboard:</span> <span class="attr">localhost:8080</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">8719</span></span><br></pre></td></tr></table></figure><p></p><ul><li><p><code>spring.cloud.sentinel.transport.dashboard</code>ï¼ŒæŒ‡å®šäº†sentinelæ§åˆ¶å°çš„ipå’Œç«¯å£åœ°å€ï¼›</p></li><li><p><code>spring.cloud.sentinel.transport.port</code>ï¼Œsentinelå®¢æˆ·ç«¯å’Œæ§åˆ¶å°é€šä¿¡çš„ç«¯å£ï¼Œé»˜è®¤ä¸º8719ï¼Œå¦‚æœè¿™ä¸ªç«¯å£å·²ç»è¢«å ç”¨ï¼Œé‚£ä¹ˆsentinelä¼šè‡ªåŠ¨ä»8719å¼€å§‹ä¾æ¬¡+1æ‰«æï¼Œç›´åˆ°æ‰¾åˆ°æœªè¢«å ç”¨çš„ç«¯å£ã€‚</p></li></ul><p>å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨æµè§ˆå™¨å¤šæ¬¡è®¿é—®ï¼š<a href="http://localhost:8081/test1" target="_blank" rel="noopener">http://localhost:8081/test1</a>ï¼Œç„¶åç™»å½•sentinelæ§åˆ¶å°ï¼š</p><p><img src="img/QQ20200319-100041@2x.png" alt="QQ20200319-100041@2x"></p><p>åœ¨ç°‡ç‚¹é“¾è·¯ä¸­å¯ä»¥çœ‹åˆ°åˆšåˆšé‚£ç¬”è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å®ƒè¿›è¡Œæµæ§ã€é™çº§ã€æˆæƒã€çƒ­ç‚¹ç­‰é…ç½®ï¼ˆæ§åˆ¶å°æ˜¯æ‡’åŠ è½½çš„ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•è¯·æ±‚ï¼Œé‚£ä¹ˆæ§åˆ¶å°ä¹Ÿä¸ä¼šæœ‰ä»»ä½•å†…å®¹ï¼‰ã€‚</p><h2 id="æµæ§è§„åˆ™"><a href="#æµæ§è§„åˆ™" class="headerlink" title="æµæ§è§„åˆ™"></a>æµæ§è§„åˆ™</h2><p>åœ¨ç°‡ç‚¹é“¾è·¯åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»<code>/test1</code>åé¢çš„æµæ§æŒ‰é’®ï¼š</p><p><img src="img/QQ20200319-100633@2x.png" alt="QQ20200319-100633@2x"></p><ul><li>èµ„æºåï¼šæ ‡è¯†èµ„æºçš„å”¯ä¸€åç§°ï¼Œé»˜è®¤ä¸ºè¯·æ±‚è·¯å¾„ï¼Œä¹Ÿå¯ä»¥åœ¨å®¢æˆ·ç«¯ä¸­ä½¿ç”¨<code>SentinelResource</code>é…ç½®ï¼›</li><li>é’ˆå¯¹æ¥æºï¼šSentinelå¯ä»¥é’ˆå¯¹æœåŠ¡è°ƒç”¨è€…è¿›è¡Œé™æµï¼Œå¡«å†™å¾®æœåŠ¡åç§°å³<code>spring.application.name</code>ï¼Œé»˜è®¤ä¸ºdefaultï¼Œä¸åŒºåˆ†æ¥æºï¼›</li><li><p>é˜ˆå€¼ç±»å‹ã€å•æœºé˜ˆå€¼ï¼š</p><ul><li>QPSï¼ˆQueries-per-secondï¼Œæ¯ç§’é’Ÿçš„è¯·æ±‚æ•°é‡ï¼‰ï¼šå½“è°ƒç”¨è¯¥apiçš„QPSè¾¾åˆ°é˜ˆå€¼çš„æ—¶å€™ï¼Œè¿›è¡Œé™æµï¼›</li><li>çº¿ç¨‹æ•°ï¼šå½“è°ƒç”¨è¯¥apiçš„çº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼çš„æ—¶å€™ï¼Œè¿›è¡Œé™æµã€‚</li></ul></li><li><p>æ˜¯å¦é›†ç¾¤ï¼šé»˜è®¤ä¸é›†ç¾¤ï¼›</p></li><li><p>æµæ§æ¨¡å¼ï¼š</p><ul><li>ç›´æ¥ï¼šå½“apiè°ƒç”¨è¾¾åˆ°é™æµæ¡ä»¶çš„æ—¶ï¼Œç›´æ¥é™æµï¼›</li><li>å…³è”ï¼šå½“å…³è”çš„èµ„æºè¯·æ±‚è¾¾åˆ°é˜ˆå€¼çš„æ—¶å€™ï¼Œé™æµè‡ªå·±ï¼›</li><li>é“¾è·¯ï¼šåªè®°å½•æŒ‡å®šé“¾è·¯ä¸Šçš„æµé‡ï¼ˆæŒ‡å®šèµ„æºä»å…¥å£èµ„æºè¿›æ¥çš„æµé‡ï¼Œå¦‚æœè¾¾åˆ°é˜ˆå€¼ï¼Œåˆ™è¿›è¡Œé™æµï¼‰ã€‚</li></ul></li><li><p>æµæ§æ•ˆæœï¼š</p><ul><li>å¿«é€Ÿå¤±è´¥ï¼šç›´æ¥å¤±è´¥ï¼›</li><li>Warm Upï¼šæ ¹æ®codeFactorï¼ˆå†·åŠ è½½å› å­ï¼Œé»˜è®¤å€¼ä¸º3ï¼‰çš„å€¼ï¼Œä»é˜ˆå€¼/codeFactorï¼Œç»è¿‡é¢„çƒ­æ—¶é•¿ï¼Œæ‰è¾¾åˆ°è®¾ç½®çš„QPSé˜ˆå€¼ï¼›</li><li>æ’é˜Ÿç­‰å¾…ï¼šåŒ€é€Ÿæ’é˜Ÿï¼Œè®©è¯·æ±‚åŒ€é€Ÿé€šè¿‡ï¼Œé˜ˆå€¼ç±»å‹å¿…é¡»è®¾ç½®ä¸ºQPSï¼Œå¦åˆ™æ— æ•ˆã€‚</li></ul></li></ul><h3 id="QPSç›´æ¥å¤±è´¥"><a href="#QPSç›´æ¥å¤±è´¥" class="headerlink" title="QPSç›´æ¥å¤±è´¥"></a>QPSç›´æ¥å¤±è´¥</h3><p>æ¼”ç¤ºä¸‹QPSç›´æ¥å¤±è´¥è®¾ç½®åŠæ•ˆæœã€‚ç‚¹å‡»ç°‡ç‚¹é“¾è·¯åˆ—è¡¨ä¸­<code>/test1</code>è¯·æ±‚åé¢çš„æµæ§æŒ‰é’®ï¼š</p><p><img src="img/QQ20200319-103726@2x.png" alt="QQ20200319-103726@2x"></p><p>ä¸Šé¢è®¾ç½®çš„æ•ˆæœæ˜¯ï¼Œ1ç§’é’Ÿå†…è¯·æ±‚/test1èµ„æºçš„æ¬¡æ•°è¾¾åˆ°2æ¬¡ä»¥ä¸Šçš„æ—¶å€™ï¼Œè¿›è¡Œé™æµã€‚</p><p>ç‚¹å‡»æ–°å¢æŒ‰é’®åï¼Œåˆ—è¡¨ä¼šè·³è½¬åˆ°â€æµæ§è§„åˆ™â€èœå•ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œè®¾ç½®æµæ§è§„åˆ™ï¼Œä¸è¿‡ä¸€èˆ¬è¿˜æ˜¯ä¹ æƒ¯ç›´æ¥åœ¨ç°‡ç‚¹é“¾è·¯åˆ—è¡¨ä¸­ç›´æ¥é€‰ä¸­èµ„æºæ·»åŠ æµæ§è§„åˆ™ã€‚æ–°å¢åï¼Œæˆ‘ä»¬è®¿é—®<a href="http://localhost:8081/test1" target="_blank" rel="noopener">http://localhost:8081/test1</a>ï¼Œçœ‹çœ‹æ•ˆæœï¼š</p><p><img src="img/2020-03-19 10.47.02.gif" alt="2020-03-19 10.47.02.gif"></p><p>å½“æ‰‹é€Ÿå¿«ç‚¹çš„æ—¶å€™ï¼ˆ1ç§’è¶…è¿‡2æ¬¡ï¼‰ï¼Œé¡µé¢è¿”å›Blocked by Sentinel (flow limiting)ã€‚</p><h3 id="çº¿ç¨‹æ•°ç›´æ¥å¤±è´¥"><a href="#çº¿ç¨‹æ•°ç›´æ¥å¤±è´¥" class="headerlink" title="çº¿ç¨‹æ•°ç›´æ¥å¤±è´¥"></a>çº¿ç¨‹æ•°ç›´æ¥å¤±è´¥</h3><p>æ”¹é€ ä¸‹<code>TestController</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"test1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è®©æ–¹æ³•ä¼‘çœ 1ç§’ï¼Œæ›´å®¹æ˜“å‡ºç°æ•ˆæœã€‚é‡å¯é¡¹ç›®ï¼Œç„¶ååœ¨sentinelæ§åˆ¶å°ä¸­æ·»åŠ å¦‚ä¸‹æµæ§è§„åˆ™ï¼š</p><p><img src="img/QQ20200319-105234@2x.png" alt="QQ20200319-105234@2x"></p><p>å¤šæ¬¡è®¿é—®<a href="http://localhost:8081/test1" target="_blank" rel="noopener">http://localhost:8081/test1</a>ï¼Œæ•ˆæœï¼š</p><p><img src="img/2020-03-19 10.57.46.gif" alt="2020-03-19 10.57.46.gif"></p><h3 id="å…³è”"><a href="#å…³è”" class="headerlink" title="å…³è”"></a>å…³è”</h3><p>æ”¹é€ <code>TestController</code>ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„apiæ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"test1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"test2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é‡å¯é¡¹ç›®ï¼Œæµè§ˆå™¨ä¸­è®¿é—®ä¸‹è¿™ä¸¤ä¸ªè¯·æ±‚ï¼Œç„¶ååœ¨sentinelæ§åˆ¶å°ç°‡ç‚¹é“¾è·¯åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»test1åçš„æµæ§æŒ‰é’®ï¼š</p><p><img src="img/QQ20200319-110332@2x.png" alt="QQ20200319-110332@2x"></p><p>ä¸Šè¿°æµæ§è§„åˆ™è¡¨ç¤ºï¼šå½“1ç§’å†…è®¿é—®/test2çš„æ¬¡æ•°å¤§äº2çš„æ—¶å€™ï¼Œé™æµ/test1ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨postmanæ¥å¯†é›†è®¿é—®/test2ï¼Œç„¶åæˆ‘ä»¬æ‰‹åŠ¨æµè§ˆå™¨è¯·æ±‚/test1ï¼Œçœ‹çœ‹æ•ˆæœã€‚postmanè®¾ç½®å¦‚ä¸‹è§„åˆ™ï¼š</p><p><img src="img/QQ20200319-111530@2x.png" alt="QQ20200319-111530@2x"></p><p>ç„¶åç‚¹å‡»RunæŒ‰é’®ï¼Œæˆ‘ä»¬å›åˆ°æµè§ˆå™¨ï¼Œè®¿é—®ï¼š<a href="http://localhost:8081/test1" target="_blank" rel="noopener">http://localhost:8081/test1</a>ï¼š</p><p><img src="img/2020-03-19 11.17.11.gif" alt="2020-03-19 11.17.11.gif"></p><p>å¯ä»¥çœ‹åˆ°/test1å·²ç»è¢«é™æµäº†ã€‚</p><h3 id="é“¾è·¯"><a href="#é“¾è·¯" class="headerlink" title="é“¾è·¯"></a>é“¾è·¯</h3><p>åœ¨æ¼”ç¤ºé“¾è·¯é™æµä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ”¹é€ æ”¹é€ sentinelå®¢æˆ·ç«¯ä»£ç ã€‚åœ¨é¡¹ç›®çš„cc.mrbird.sentinelç›®å½•ä¸‹æ–°å»ºserviceåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>HelloService</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SentinelResource</span>(<span class="string">"hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>@SentinelResource(&quot;hello&quot;)</code>å°†è¯¥æ–¹æ³•æ ‡è¯†ä¸ºä¸€ä¸ªsentinelèµ„æºï¼Œåç§°ä¸ºhelloã€‚</p><p>æ¥ç€åœ¨<code>TestController</code>ä¸­ä½¿ç”¨è¯¥èµ„æºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HelloService helloService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"test1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test1 "</span> + helloService.hello();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"test2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test2 "</span> + helloService.hello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é‡å¯é¡¹ç›®ï¼Œåœ¨æµè§ˆå™¨ä¸­å¤šæ¬¡è®¿é—®è¿™ä¸¤ä¸ªapiï¼Œç„¶åæŸ¥çœ‹sentinelæ§åˆ¶å°ç°‡ç‚¹é“¾è·¯ï¼š</p><p><img src="img/c.png" alt="QQ20200319-151619@2x"></p><p>ç„¶åç‚¹å‡»helloèµ„æºåé¢çš„æµæ§æŒ‰é’®ï¼š</p><p><img src="img/QQ20200319-151704@2x.png" alt="QQ20200319-151704@2x"></p><p>ä¸Šè¿°é…ç½®çš„æ„æ€æ˜¯ï¼Œå½“é€šè¿‡/test1è®¿é—®helloçš„æ—¶å€™ï¼ŒQPSå¤§äº1åˆ™è¿›è¡Œé™æµï¼›è¨€å¤–ä¹‹æ„å°±æ˜¯/test2è®¿é—®helloè¯·æ±‚å¹¶ä¸å—å½±å“ã€‚</p><p>ä½†æ˜¯å®é™…æµ‹è¯•å¹¶æ²¡æœ‰ç”Ÿæ•ˆğŸ˜¡ï¼Œå…·ä½“å¯ä»¥å‚è€ƒissueï¼š<a href="https://github.com/alibaba/Sentinel/issues/1213" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/issues/1213</a>ã€‚</p><h3 id="é¢„çƒ­Warm-Up"><a href="#é¢„çƒ­Warm-Up" class="headerlink" title="é¢„çƒ­Warm Up"></a>é¢„çƒ­Warm Up</h3><p>æµæ§æ•ˆæœé™¤äº†ç›´æ¥å¤±è´¥å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©é¢„çƒ­Warm Upã€‚</p><div class="note info">Warm Upï¼ˆRuleConstant.CONTROL_BEHAVIOR_WARM_UPï¼‰æ–¹å¼ï¼Œå³é¢„çƒ­/å†·å¯åŠ¨æ–¹å¼ã€‚å½“ç³»ç»Ÿé•¿æœŸå¤„äºä½æ°´ä½çš„æƒ…å†µä¸‹ï¼Œå½“æµé‡çªç„¶å¢åŠ æ—¶ï¼Œç›´æ¥æŠŠç³»ç»Ÿæ‹‰å‡åˆ°é«˜æ°´ä½å¯èƒ½ç¬é—´æŠŠç³»ç»Ÿå‹å®ã€‚é€šè¿‡â€å†·å¯åŠ¨â€ï¼Œè®©é€šè¿‡çš„æµé‡ç¼“æ…¢å¢åŠ ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…é€æ¸å¢åŠ åˆ°é˜ˆå€¼ä¸Šé™ï¼Œç»™å†·ç³»ç»Ÿä¸€ä¸ªé¢„çƒ­çš„æ—¶é—´ï¼Œé¿å…å†·ç³»ç»Ÿè¢«å‹å®ã€‚</div><p>sentinelå®¢æˆ·ç«¯çš„é»˜è®¤å†·åŠ è½½å› å­coldFactorä¸º3ï¼Œå³è¯·æ±‚QPSä» threshold / 3 å¼€å§‹ï¼Œç»é¢„çƒ­æ—¶é•¿é€æ¸å‡è‡³è®¾å®šçš„QPSé˜ˆå€¼ã€‚</p><p>æ¯”å¦‚ï¼š</p><p><img src="img/QQ20200319-152842@2x.png" alt="QQ20200319-152842@2x"></p><p>ä¸Šé¢çš„é…ç½®æ„æ€æ˜¯ï¼šå¯¹äº/test1èµ„æºï¼Œä¸€å¼€å§‹çš„QPSé˜ˆå€¼ä¸º3ï¼ˆ10/3ï¼‰ï¼Œç»è¿‡10ç§’åï¼ŒQPSé˜ˆå€¼è¾¾åˆ°10ï¼Œè¿‡ç¨‹ç±»ä¼¼äºä¸‹å›¾ï¼š</p><p><img src="img/QQ20200319-153013@2x.png" alt="QQ20200319-153013@2x"></p><p>æ•ˆæœæˆ‘å°±ä¸æ¼”ç¤ºäº†ï¼Œå¤§æ¦‚æ•ˆæœå°±æ˜¯ä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="http://localhost:8081/test1" target="_blank" rel="noopener">http://localhost:8081/test1</a>ï¼Œä»¥æœ€å¿«çš„æ‰‹é€Ÿç‚¹åˆ·æ–°ï¼Œä¸€å¼€å§‹ä¼šå¸¸çœ‹åˆ°Blocked by Sentinel (flow limiting)çš„æç¤ºï¼Œ10ç§’åå‡ ä¹ä¸å†å‡ºç°ï¼ˆå› ä¸ºä½ çš„æ‰‹é€Ÿå¾ˆéš¾è¾¾åˆ°1ç§’10ä¸‹ï¼‰ã€‚</p><h3 id="æ’é˜Ÿç­‰å¾…"><a href="#æ’é˜Ÿç­‰å¾…" class="headerlink" title="æ’é˜Ÿç­‰å¾…"></a>æ’é˜Ÿç­‰å¾…</h3><p>æ’é˜Ÿç­‰å¾…æ–¹å¼ä¸ä¼šæ‹’ç»è¯·æ±‚ï¼Œè€Œæ˜¯ä¸¥æ ¼æ§åˆ¶è¯·æ±‚é€šè¿‡çš„é—´éš”æ—¶é—´ï¼Œä¹Ÿå³æ˜¯è®©è¯·æ±‚ä»¥å‡åŒ€çš„é€Ÿåº¦é€šè¿‡ã€‚</p><p>ä¿®æ”¹<code>TestController</code>çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"test1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"test1"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é‡å¯é¡¹ç›®ï¼Œæµè§ˆå™¨è®¿é—®<a href="localhost:8081/test1" target="_blank" rel="noopener">localhost:8081/test1</a>ï¼Œç„¶åç‚¹å‡»sentinelæ§åˆ¶å°ç°‡ç‚¹é“¾è·¯åˆ—è¡¨çš„/test1æµæ§æŒ‰é’®ï¼š</p><p><img src="img/QQ20200319-161608@2x.png" alt="QQ20200319-161608@2x"></p><p>ä¸Šè¿°é…ç½®çš„å«ä¹‰æ˜¯ï¼Œè®¿é—®/test1è¯·æ±‚æ¯ç§’é’Ÿæœ€å¤šåªèƒ½1æ¬¡ï¼Œè¶…è¿‡çš„è¯·æ±‚æ’é˜Ÿç­‰å¾…ï¼Œç­‰å¾…è¶…è¿‡1000æ¯«ç§’åˆ™è¶…æ—¶ã€‚æ–°å¢è¯¥è§„åˆ™åï¼Œå¤šæ¬¡å¿«é€Ÿè®¿é—®<a href="localhost:8081/test1" target="_blank" rel="noopener">localhost:8081/test1</a>ï¼Œsentinelå®¢æˆ·ç«¯æ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2020-03-18 16:17:23.247  INFO 44688 --- [nio-8081-exec-2] c.m.sentinel.controller.TestController   : test1</span><br><span class="line">2020-03-18 16:17:24.250  INFO 44688 --- [nio-8081-exec-6] c.m.sentinel.controller.TestController   : test1</span><br><span class="line">2020-03-18 16:17:25.251  INFO 44688 --- [nio-8081-exec-5] c.m.sentinel.controller.TestController   : test1</span><br><span class="line">2020-03-18 16:17:26.251  INFO 44688 --- [nio-8081-exec-7] c.m.sentinel.controller.TestController   : test1</span><br><span class="line">2020-03-18 16:17:27.251  INFO 44688 --- [nio-8081-exec-8] c.m.sentinel.controller.TestController   : test1</span><br></pre></td></tr></table></figure><p></p><p>æ¯ç¬”è¯·æ±‚æ—¶é—´é—´éš”1ç§’ã€‚</p><h2 id="é™çº§è§„åˆ™"><a href="#é™çº§è§„åˆ™" class="headerlink" title="é™çº§è§„åˆ™"></a>é™çº§è§„åˆ™</h2><p>é™çº§é…ç½®é¡µé¢ï¼š</p><p><img src="img/QQ20200319-164303@2x.png" alt="QQ20200319-164303@2x"></p><p>é™çº§ç­–ç•¥åˆ†ä¸º3ç§ï¼š</p><ul><li>RTï¼Œå¹³å‡å“åº”æ—¶é—´ (DEGRADE_GRADE_RT)ï¼šå½“ 1s å†…æŒç»­è¿›å…¥ 5 ä¸ªè¯·æ±‚ï¼Œå¯¹åº”æ—¶åˆ»çš„å¹³å‡å“åº”æ—¶é—´ï¼ˆç§’çº§ï¼‰å‡è¶…è¿‡é˜ˆå€¼ï¼ˆcountï¼Œä»¥ ms ä¸ºå•ä½ï¼‰ï¼Œé‚£ä¹ˆåœ¨æ¥ä¸‹çš„æ—¶é—´çª—å£ï¼ˆDegradeRule ä¸­çš„ timeWindowï¼Œä»¥ s ä¸ºå•ä½ï¼‰ä¹‹å†…ï¼Œå¯¹è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šè‡ªåŠ¨åœ°ç†”æ–­ï¼ˆæŠ›å‡º DegradeExceptionï¼‰ã€‚æ³¨æ„ Sentinel é»˜è®¤ç»Ÿè®¡çš„ RT ä¸Šé™æ˜¯ 4900 msï¼Œè¶…å‡ºæ­¤é˜ˆå€¼çš„éƒ½ä¼šç®—ä½œ 4900 msï¼Œè‹¥éœ€è¦å˜æ›´æ­¤ä¸Šé™å¯ä»¥é€šè¿‡å¯åŠ¨é…ç½®é¡¹ <code>-Dcsp.sentinel.statistic.max.rt=xxx</code> æ¥é…ç½®ã€‚</li><li>å¼‚å¸¸æ¯”ä¾‹ (DEGRADE_GRADE_EXCEPTION_RATIO)ï¼šå½“èµ„æºçš„æ¯ç§’è¯·æ±‚é‡ &gt;= 5ï¼Œå¹¶ä¸”æ¯ç§’å¼‚å¸¸æ€»æ•°å é€šè¿‡é‡çš„æ¯”å€¼è¶…è¿‡é˜ˆå€¼ï¼ˆDegradeRule ä¸­çš„ countï¼‰ä¹‹åï¼Œèµ„æºè¿›å…¥é™çº§çŠ¶æ€ï¼Œå³åœ¨æ¥ä¸‹çš„æ—¶é—´çª—å£ï¼ˆDegradeRule ä¸­çš„ timeWindowï¼Œä»¥ s ä¸ºå•ä½ï¼‰ä¹‹å†…ï¼Œå¯¹è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šè‡ªåŠ¨åœ°è¿”å›ã€‚å¼‚å¸¸æ¯”ç‡çš„é˜ˆå€¼èŒƒå›´æ˜¯ [0.0, 1.0]ï¼Œä»£è¡¨ 0% - 100%ã€‚</li><li>å¼‚å¸¸æ•° (DEGRADE_GRADE_EXCEPTION_COUNT)ï¼šå½“èµ„æºè¿‘ 1 åˆ†é’Ÿçš„å¼‚å¸¸æ•°ç›®è¶…è¿‡é˜ˆå€¼ä¹‹åä¼šè¿›è¡Œç†”æ–­ã€‚æ³¨æ„ç”±äºç»Ÿè®¡æ—¶é—´çª—å£æ˜¯åˆ†é’Ÿçº§åˆ«çš„ï¼Œè‹¥ timeWindow å°äº 60sï¼Œåˆ™ç»“æŸç†”æ–­çŠ¶æ€åä»å¯èƒ½å†è¿›å…¥ç†”æ–­çŠ¶æ€ã€‚</li></ul><h3 id="RT"><a href="#RT" class="headerlink" title="RT"></a>RT</h3><p>ä¿®æ”¹<code>TestController</code>çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"test1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    	<span class="comment">// ä¼‘çœ 1ç§’</span></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é‡å¯é¡¹ç›®ï¼Œæµè§ˆå™¨è®¿é—®<a href="localhost:8081/test1" target="_blank" rel="noopener">localhost:8081/test1</a>ï¼Œç„¶åç‚¹å‡»sentinelæ§åˆ¶å°ç°‡ç‚¹é“¾è·¯åˆ—è¡¨çš„/test1é™çº§æŒ‰é’®ï¼š</p><p><img src="img/QQ20200319-171421@2x.png" alt="QQ20200319-171421@2x"></p><p>ä¸Šé¢é…ç½®çš„å«ä¹‰æ˜¯ï¼šå¦‚æœ/test1çš„QPSå¤§äº5ï¼Œå¹¶ä¸”å¹³å‡å“åº”æ—¶é—´ï¼ˆä»¥ç§’çº§ç»Ÿè®¡ï¼‰å¤§äº500ï¼ˆRTï¼‰æ¯«ç§’ï¼Œé‚£ä¹ˆåœ¨æœªæ¥çš„1ç§’é’Ÿï¼ˆæ—¶é—´çª—å£ï¼‰å†…ï¼Œsentinelæ–­è·¯å™¨æ‰“å¼€ï¼Œè¯¥apiæ¥å£ä¸å¯ç”¨ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨JMeteræ¨¡æ‹Ÿå¹¶å‘è®¿é—®æƒ…å½¢ï¼š</p><p><img src="img/QQ20200319-171907@2x.png" alt="QQ20200319-171907@2x"></p><p><img src="img/QQ20200319-171941@2x.png" alt="QQ20200319-171941@2x"></p><p>ä¸Šé¢çš„QPSä¸º10ï¼Œè€Œä¸”æˆ‘ä»¬çš„/test1æ¥å£å“åº”æ—¶é—´åœ¨1ç§’å·¦å³ï¼Œæ ¹æ®æˆ‘ä»¬ä¸Šé¢é…ç½®çš„é™çº§è§„åˆ™ï¼Œè‚¯å®šä¼šè§¦å‘é™çº§ï¼Œä½¿ç”¨JMeteræµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="img/QQ20200319-172138@2x.png" alt="QQ20200319-172138@2x"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºå¾ˆå¿«å°±è§¦å‘äº†é™çº§ï¼Œæ–­è·¯å™¨æ‰“å¼€ï¼Œåç»­çš„è¯·æ±‚éƒ½è¿”å›äº†Blocked by Sentinel (flow limiting)ã€‚åœæ‰JMeterï¼Œæµè§ˆå™¨è®¿é—®<a href="localhost:8081/test1" target="_blank" rel="noopener">localhost:8081/test1</a></p><p><img src="img/QQ20200319-172646@2x.png" alt="QQ20200319-172646@2x"></p><p>é™çº§è§„åˆ™ä¸å†ç¬¦åˆï¼Œæ‰€ä»¥æ–­è·¯å™¨åˆä¸Šï¼Œè¯·æ±‚æ­£å¸¸å“åº”ã€‚</p><h3 id="å¼‚å¸¸æ¯”ä¾‹"><a href="#å¼‚å¸¸æ¯”ä¾‹" class="headerlink" title="å¼‚å¸¸æ¯”ä¾‹"></a>å¼‚å¸¸æ¯”ä¾‹</h3><p>ä¿®æ”¹<code>TestController</code>çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"test1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="comment">// æ¯æ¬¡è¯·æ±‚éƒ½æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"æœåŠ¡å¼‚å¸¸"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é‡å¯é¡¹ç›®ï¼Œæµè§ˆå™¨è®¿é—®<a href="localhost:8081/test1" target="_blank" rel="noopener">localhost:8081/test1</a>ï¼Œç„¶åç‚¹å‡»sentinelæ§åˆ¶å°ç°‡ç‚¹é“¾è·¯åˆ—è¡¨çš„/test1é™çº§æŒ‰é’®ï¼š</p><p><img src="img/QQ20200319-173124@2x.png" alt="QQ20200319-173124@2x"></p><p>ä¸Šé¢çš„é…ç½®å«ä¹‰æ˜¯ï¼šå¦‚æœ/test1çš„QPSå¤§äº5ï¼Œå¹¶ä¸”æ¯ç§’é’Ÿçš„è¯·æ±‚å¼‚å¸¸æ¯”ä¾‹å¤§äº0.5çš„è¯ï¼Œé‚£ä¹ˆåœ¨æœªæ¥çš„1ç§’é’Ÿï¼ˆæ—¶é—´çª—å£ï¼‰å†…ï¼Œsentinelæ–­è·¯å™¨æ‰“å¼€ï¼Œè¯¥apiæ¥å£ä¸å¯ç”¨ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ç§’å†…æœ‰10ä¸ªè¯·æ±‚è¿›æ¥ï¼Œè¶…è¿‡5ä¸ªä»¥ä¸Šéƒ½å‡ºé”™ï¼Œé‚£ä¹ˆä¼šè§¦å‘ç†”æ–­ï¼Œ1ç§’é’Ÿå†…è¿™ä¸ªæ¥å£ä¸å¯ç”¨ã€‚</p><p>è¿˜æ˜¯ä½¿ç”¨ä¸Šé¢çš„JMeteræµ‹è¯•ï¼Œå¼€å¯JMeteråï¼Œä½¿ç”¨æµè§ˆå™¨è®¿é—®ï¼š<a href="http://localhost:8081/test1" target="_blank" rel="noopener">http://localhost:8081/test1</a></p><p><img src="img/QQ20200319-173524@2x.png" alt="QQ20200319-173524@2x"></p><p>å…³æ‰JMeteråï¼Œå†æ¬¡è®¿é—®<a href="http://localhost:8081/test1" target="_blank" rel="noopener">http://localhost:8081/test1</a>ï¼š</p><p><img src="img/QQ20200319-173631@2x.png" alt="QQ20200319-173631@2x"></p><h3 id="å¼‚å¸¸æ•°"><a href="#å¼‚å¸¸æ•°" class="headerlink" title="å¼‚å¸¸æ•°"></a>å¼‚å¸¸æ•°</h3><p>å¥–åŠç­–ç•¥ä¸ºå¼‚å¸¸æ•°æ—¶è¡¨ç¤ºï¼šå½“æŒ‡å®šæ—¶é—´çª—å£å†…ï¼Œè¯·æ±‚å¼‚å¸¸æ•°å¤§äºç­‰äºæŸä¸ªå€¼æ—¶ï¼Œè§¦å‘é™çº§ã€‚æ¯”å¦‚æœ‰å¦‚ä¸‹è§„åˆ™ï¼š</p><p><img src="img/QQ20200319-182819@2x.png" alt="QQ20200319-182819@2x"></p><p>ä¸Šé¢çš„è§„åˆ™è¡¨ç¤ºï¼šåœ¨70ç§’å†…ï¼Œè®¿é—®/test1è¯·æ±‚å¼‚å¸¸çš„æ¬¡æ•°å¤§äºç­‰äº5ï¼Œåˆ™è§¦å‘é™çº§ã€‚æµ‹è¯•ä¸€æ³¢ï¼š</p><p><img src="img/2020-03-19 18.28.50.gif" alt="2020-03-19 18.28.50.gif"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“ç¬¬5æ¬¡è®¿é—®çš„æ—¶å€™æˆåŠŸè§¦å‘äº†é™çº§ã€‚</p><h2 id="çƒ­ç‚¹è§„åˆ™"><a href="#çƒ­ç‚¹è§„åˆ™" class="headerlink" title="çƒ­ç‚¹è§„åˆ™"></a>çƒ­ç‚¹è§„åˆ™</h2><p>çƒ­ç‚¹å³ç»å¸¸è®¿é—®çš„æ•°æ®ã€‚å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¸Œæœ›ç»Ÿè®¡æŸä¸ªçƒ­ç‚¹æ•°æ®ä¸­è®¿é—®é¢‘æ¬¡æœ€é«˜çš„æ•°æ®ï¼Œå¹¶å¯¹å…¶è®¿é—®è¿›è¡Œé™åˆ¶ã€‚</p><p>æ¯”å¦‚åœ¨<code>TestController</code>ä¸­æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"buy"</span>)</span><br><span class="line"><span class="meta">@SentinelResource</span>(value = <span class="string">"buy"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">buy</span><span class="params">(String goodName, Integer count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ä¹°"</span> + count + <span class="string">"ä»½"</span> + goodName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯¹è¿™ä¸ªèµ„æºæ·»åŠ çƒ­ç‚¹è§„åˆ™ï¼š</p><p><img src="img/QQ20200319-185115@2x.png" alt="QQ20200319-185115@2x"></p><p>ä¸Šé¢çš„é…ç½®å«ä¹‰æ˜¯ï¼šå¯¹buyèµ„æºæ·»åŠ çƒ­ç‚¹è§„åˆ™ï¼Œå½“ç¬¬0ä¸ªå‚æ•°çš„å€¼ä¸ºmibandçš„æ—¶å€™QPSé˜ˆå€¼ä¸º10ï¼Œå¦åˆ™ä¸º1ã€‚æ­¤å¤–ï¼Œå¦‚æœç¬¬0ä¸ªå‚æ•°ä¸ä¼ ï¼Œé‚£ä¹ˆè¿™ç¬”è¯·æ±‚ä¸å—è¯¥çƒ­ç‚¹è§„åˆ™é™åˆ¶ã€‚æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="img/2020-03-19 18.58.12.gif" alt="2020-03-19 18.58.12.gif"></p><h2 id="ç³»ç»Ÿè§„åˆ™"><a href="#ç³»ç»Ÿè§„åˆ™" class="headerlink" title="ç³»ç»Ÿè§„åˆ™"></a>ç³»ç»Ÿè§„åˆ™</h2><p>ç³»ç»Ÿè§„åˆ™åˆ™æ˜¯é’ˆå¯¹æ•´ä¸ªç³»ç»Ÿè®¾ç½®é™æµè§„åˆ™ï¼Œå¹¶ä¸é’ˆå¯¹æŸä¸ªèµ„æºï¼Œè®¾ç½®é¡µé¢å¦‚ä¸‹ï¼š</p><p><img src="img/QQ20200319-190751@2x.png" alt="QQ20200319-190751@2x"></p><p>é˜ˆå€¼ç±»å‹åŒ…å«ä»¥ä¸‹äº”ç§ï¼š</p><ul><li>Load è‡ªé€‚åº”ï¼ˆä»…å¯¹ Linux/Unix-like æœºå™¨ç”Ÿæ•ˆï¼‰ï¼šç³»ç»Ÿçš„ load1 ä½œä¸ºå¯å‘æŒ‡æ ‡ï¼Œè¿›è¡Œè‡ªé€‚åº”ç³»ç»Ÿä¿æŠ¤ã€‚å½“ç³»ç»Ÿ load1 è¶…è¿‡è®¾å®šçš„å¯å‘å€¼ï¼Œä¸”ç³»ç»Ÿå½“å‰çš„å¹¶å‘çº¿ç¨‹æ•°è¶…è¿‡ä¼°ç®—çš„ç³»ç»Ÿå®¹é‡æ—¶æ‰ä¼šè§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼ˆBBR é˜¶æ®µï¼‰ã€‚ç³»ç»Ÿå®¹é‡ç”±ç³»ç»Ÿçš„ maxQps <em>minRt ä¼°ç®—å¾—å‡ºã€‚è®¾å®šå‚è€ƒå€¼ä¸€èˆ¬æ˜¯ CPU cores </em>2.5ã€‚</li><li>CPU usageï¼ˆ1.5.0+ ç‰ˆæœ¬ï¼‰ï¼šå½“ç³»ç»Ÿ CPU ä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼ˆå–å€¼èŒƒå›´ 0.0-1.0ï¼‰ï¼Œæ¯”è¾ƒçµæ•ã€‚</li><li>å¹³å‡ RTï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹³å‡ RT è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚</li><li>å¹¶å‘çº¿ç¨‹æ•°ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹¶å‘çº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚</li><li>å…¥å£ QPSï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„ QPS è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚</li></ul><p>æ¯”è¾ƒç›´è§‚å°±ä¸æ¼”ç¤ºäº†ã€‚</p><h2 id="æˆæƒè§„åˆ™"><a href="#æˆæƒè§„åˆ™" class="headerlink" title="æˆæƒè§„åˆ™"></a>æˆæƒè§„åˆ™</h2><p>æˆæƒè§„åˆ™ç”¨äºé…ç½®èµ„æºçš„é»‘ç™½åå•ï¼š</p><p><img src="img/QQ20200319-191154@2x.png" alt="QQ20200319-191154@2x"></p><p>ä¸Šè¿°é…ç½®è¡¨ç¤ºï¼šåªæœ‰appAå’ŒappBæ‰èƒ½è®¿é—®helloèµ„æºã€‚</p><div class="note danger">sentinelæ§åˆ¶å°è§„åˆ™ä¼šåœ¨å®¢æˆ·ç«¯é‡å¯åä¸¢å¤±ï¼Œå¯ä»¥é…åˆnacosç­‰è¿›è¡Œé…ç½®æŒä¹…åŒ–ï¼Œå…·ä½“å¯ä»¥å‚è€ƒäº‘å¤§ä½¬çš„åšå®¢ï¼š<a href="https://www.sonake.com/2019/12/16/Sentinel-Nacos%E5%AE%9E%E7%8E%B0%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96/" target="_blank" rel="noopener">https://www.sonake.com/2019/12/16/Sentinel-Nacos%E5%AE%9E%E7%8E%B0%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96/</a>ã€‚</div><blockquote><p>å‚è€ƒé“¾æ¥ <a href="https://github.com/alibaba/Sentinel/wiki" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/wiki</a></p></blockquote><blockquote><p>æœ¬èŠ‚æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/77.spring-cloud-alibaba-sentinel-dashboard-guide" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/77.spring-cloud-alibaba-sentinel-dashboard-guide</a>ã€‚</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/alibaba/Sentinel&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Sentinel&lt;/a&gt;æä¾›ä¸€ä¸ªè½»é‡çº§çš„å¼€æºæ§åˆ¶å°ï¼Œå®ƒæä¾›æœºå™¨å‘ç°ä»¥åŠå¥åº·æƒ…å†µç®¡ç†ã€ç›‘æ§ï¼ˆå•æœºå’Œé›†ç¾¤ï¼‰ï¼Œè§„åˆ™ç®¡ç†å’Œæ¨é€çš„åŠŸèƒ½ã€‚æœ¬èŠ‚å°†è¯¦ç»†è®°å½•ä½•å¦‚é€šè¿‡Sentinelæ§åˆ¶å°æ§åˆ¶Sentinelå®¢æˆ·ç«¯çš„å„ç§è¡Œä¸ºã€‚Sentinelæ§åˆ¶å°çš„åŠŸèƒ½ä¸»è¦åŒ…æ‹¬ï¼šæµé‡æ§åˆ¶ã€é™çº§æ§åˆ¶ã€çƒ­ç‚¹é…ç½®ã€ç³»ç»Ÿè§„åˆ™å’Œæˆæƒè§„åˆ™ç­‰ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Cloud" scheme="http://mrbird.cc/tags/Spring-Cloud/"/>
    
      <category term="Spring Cloud Alibaba" scheme="http://mrbird.cc/tags/Spring-Cloud-Alibaba/"/>
    
      <category term="Sentinel" scheme="http://mrbird.cc/tags/Sentinel/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Alibaba Nacosé…ç½®ä¸­å¿ƒ</title>
    <link href="http://mrbird.cc/Spring-Cloud-Alibaba-Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.html"/>
    <id>http://mrbird.cc/Spring-Cloud-Alibaba-Nacosé…ç½®ä¸­å¿ƒ.html</id>
    <published>2020-03-13T07:53:34.000Z</published>
    <updated>2020-03-19T01:19:50.166Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:56:00 GMT+0800 (GMT+08:00) --><p>ä¸Šä¸€èŠ‚<a href="Spring-Cloud-Alibaba-Nacosæ³¨å†Œä¸­å¿ƒ.html">Spring Cloud Alibaba Nacosæ³¨å†Œä¸­å¿ƒ</a>è®°å½•äº†Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„ä½¿ç”¨æ–¹å¼ï¼Œè¿™èŠ‚ç»§ç»­è®°å½•ä¸‹Nacosä½œä¸ºé…ç½®ä¸­å¿ƒçš„ä½¿ç”¨æ–¹å¼ã€‚æœ¬èŠ‚ä½¿ç”¨çš„Spring Cloudç‰ˆæœ¬ä¸ºHoxton.SR3ï¼ŒSpring Cloud Alibabaç‰ˆæœ¬ä¸º2.2.0.RELEASEï¼ŒSpring Bootç‰ˆæœ¬ä¸º2.2.3.RELEASEã€‚</p><a id="more"></a><h2 id="æ¡†æ¶æ­å»º"><a href="#æ¡†æ¶æ­å»º" class="headerlink" title="æ¡†æ¶æ­å»º"></a>æ¡†æ¶æ­å»º</h2><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼ŒartifactIdä¸ºspring-cloud-alibaba-nacos-configï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200313-161613@2x.png" alt="QQ20200313-161613@2x"></p><p>é¡¹ç›®çš„pomå†…å®¹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>spring-cloud-alibaba-nacos-config<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">com-alibaba-cloud.version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">com-alibaba-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;com-alibaba-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºè¿™èŠ‚è®°å½•çš„æ˜¯Nacosä½œä¸ºé…ç½®ä¸­å¿ƒçš„åŠŸèƒ½ï¼Œæ‰€ä»¥å¼•å…¥çš„æ˜¯<code>spring-cloud-alibaba-nacos-config</code>ä¾èµ–ã€‚</p><h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p>åœ¨é¡¹ç›®é…ç½®æ–‡ä»¶application.ymlä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">my-project</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢é…ç½®æŒ‡å®šåº”ç”¨ç«¯å£ä¸º8080ï¼Œåº”ç”¨åç§°ä¸ºmy-projectã€‚</p><p>æ¥ç€åœ¨resourcesç›®å½•ä¸‹æ–°å»ºé…ç½®æ–‡ä»¶bootstrap.ymlï¼Œåœ¨é‡Œé¢æ·»åŠ å¦‚ä¸‹Nacos configé…ç½®ï¼ˆå¿…é¡»åœ¨bootstrap.ymlä¸­é…ç½®ï¼Œbootstrap.ymlä¼˜å…ˆçº§æ¯”application.ymlé«˜ï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line"><span class="attr">        file-extension:</span> <span class="string">yaml</span></span><br></pre></td></tr></table></figure><p></p><ul><li><p><code>spring.cloud.nacos.config.server-addr</code>é…ç½®äº†Nacosé…ç½®ä¸­å¿ƒçš„åœ°å€ï¼Œä¹Ÿå¯ä»¥é€šè¿‡<code>spring.cloud.nacos.server-addr</code>æŒ‡å®šï¼Œå®ƒä»¬ä¸¤ä¸ªæ˜¯ç­‰ä»·çš„ï¼›</p></li><li><p><code>spring.cloud.nacos.config.file-extension</code>æŒ‡å®šå¾…ä¼šåœ¨Nacosé…ç½®ä¸­å¿ƒè¯»å–çš„é…ç½®çš„æ ¼å¼ä¸ºyamlæ ¼å¼ã€‚</p></li></ul><p>æˆ‘ä»¬å›åˆ°Nacosæ§åˆ¶å°<a href="http://localhost:8848/nacos" target="_blank" rel="noopener">http://localhost:8848/nacos</a>ï¼Œåœ¨é…ç½®åˆ—è¡¨ä¸­æ–°å»ºä¸€ä¸ªé…ç½®ï¼š</p><p><img src="img/QQ20200316-091128@2x.png" alt="QQ20200316-091128@2x"></p><p><img src="img/QQ20200316-091434@2x.png" alt="QQ20200316-091434@2x"></p><p>æˆ‘ä»¬æ–°å»ºäº†ä¸€ä¸ªmy-project.yamlé…ç½®ï¼ˆdataIdä¸ºmy-project.yamlï¼Œgroupä¸ºDEFAULT_GROUPï¼Œå®ƒä»¬çš„å…·ä½“å«ä¹‰ä¸‹é¢ä¼šä»‹ç»åˆ°ï¼‰ï¼Œé…ç½®äº†<code>message: &#39;hello nacos config&#39;</code>ï¼Œåˆ›å»ºå¥½åï¼Œç‚¹å‡»å‘å¸ƒå³å¯ã€‚</p><p>æ¥ç€å›åˆ°æˆ‘ä»¬çš„é¡¹ç›®ï¼Œåœ¨cc.mrbird.nacosç›®å½•ä¸‹æ–°å»ºcontrolleråŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>TestController</code>ç”¨äºæµ‹è¯•é…ç½®è·å–è§„åˆ™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;message:null&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"message"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç æˆ‘ä»¬ä»åˆšåˆšåœ¨Nacosæ§åˆ¶å°é…ç½®çš„é…ç½®æ–‡ä»¶ä¸­è·å–<code>message</code>é…ç½®çš„å€¼ï¼Œ<code>@RefreshScope</code>ç”¨äºåˆ·æ–°é…ç½®ï¼Œå³æˆ‘ä»¬åœ¨Nacosæ§åˆ¶å°ä¿®æ”¹äº†ç›¸å…³é…ç½®ç‚¹å‡»å‘å¸ƒåï¼Œæˆ‘ä»¬çš„åº”ç”¨èƒ½å¤Ÿåœ¨ä¸é‡å¯çš„æƒ…å†µä¸‹è·å–åˆ°æœ€æ–°çš„é…ç½®ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š<a href="http://localhost:8080/message" target="_blank" rel="noopener">http://localhost:8080/message</a>ï¼š</p><p><img src="img/QQ20200316-092401@2x.png" alt="QQ20200316-092401@2x"></p><p>é…ç½®è·å–æˆåŠŸï¼Œåœ¨Nacosæ§åˆ¶å°ä¸­å°†<code>message</code>å€¼ä¿®æ”¹ä¸º<code>hello world</code>åå‘å¸ƒï¼Œå†æ¬¡è®¿é—®<a href="http://localhost:8080/message" target="_blank" rel="noopener">http://localhost:8080/message</a>ï¼š</p><p><img src="img/QQ20200316-092754@2x.png" alt="QQ20200316-092754@2x"></p><h2 id="è·å–é…ç½®è§„åˆ™"><a href="#è·å–é…ç½®è§„åˆ™" class="headerlink" title="è·å–é…ç½®è§„åˆ™"></a>è·å–é…ç½®è§„åˆ™</h2><p>Nacosé…ç½®ä¸­å¿ƒé€šè¿‡namespaceã€dataIdå’Œgroupæ¥å”¯ä¸€ç¡®å®šä¸€æ¡é…ç½®ã€‚</p><ol><li>namespaceï¼Œå³å‘½åç©ºé—´ã€‚é»˜è®¤çš„å‘½åç©ºé—´ä¸ºpublicï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Nacosæ§åˆ¶å°ä¸­æ–°å»ºå‘½åç©ºé—´ï¼›</li><li><p>dataIdï¼Œå³é…ç½®æ–‡ä»¶åç§°ï¼ŒdataIdçš„æ‹¼æ¥æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$&#123;prefix&#125;</span> <span class="bullet">-</span> <span class="string">$&#123;spring.profiles.active&#125;</span> <span class="string">.</span> <span class="string">$&#123;file-extension&#125;</span></span><br></pre></td></tr></table></figure><ul><li><p><code>prefix</code>é»˜è®¤ä¸º<code>pring.application.name</code>çš„å€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹<code>spring.cloud.nacos.config.prefix</code>æ¥é…ç½®ï¼›</p></li><li><p><code>spring.profiles.active</code>å³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„<code>profile</code>ã€‚<strong>æ³¨æ„ï¼Œå½“<code>spring.profiles.active</code>ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„è¿æ¥ç¬¦<code>-</code>ä¹Ÿå°†ä¸å­˜åœ¨ï¼ŒdataIdçš„æ‹¼æ¥æ ¼å¼å˜æˆ<code>${prefix}.${file-extension}</code></strong>ï¼›</p></li><li><p><code>file-extension</code>ä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹<code>spring.cloud.nacos.config.file-extension</code>æ¥é…ç½®ã€‚</p></li></ul></li><li><p>groupï¼Œå³é…ç½®åˆ†ç»„ï¼Œé»˜è®¤ä¸ºDEFAULT_GROUPï¼Œå¯ä»¥é€šè¿‡<code>spring.cloud.nacos.config.group</code>é…ç½®ã€‚</p></li></ol><p>æ‰€ä»¥æ ¹æ®è¿™äº›è§„åˆ™ï¼Œä¸Šé¢ç¤ºä¾‹ä¸­æˆ‘ä»¬çš„åº”ç”¨åç§°<code>spring.application.name</code>ä¸ºmy-projectï¼Œ<code>spring.cloud.nacos.config.file-extension</code>çš„å€¼ä¸ºyamlï¼Œæ²¡æœ‰æŒ‡å®š<code>spring.profiles.active</code>ï¼Œäºæ˜¯dataIdä¸ºmy-project.yamlï¼Œåˆ†ç»„ä¸ºé»˜è®¤çš„DEFAULT_GROUPï¼Œå‘½åç©ºé—´ä¸ºé»˜è®¤çš„publicã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨Nacosæ§åˆ¶å°ä¸­æ–°å»ºé…ç½®æ—¶çš„æ ¹æ®ã€‚</p><h2 id="é…ç½®åˆ’åˆ†å®æˆ˜"><a href="#é…ç½®åˆ’åˆ†å®æˆ˜" class="headerlink" title="é…ç½®åˆ’åˆ†å®æˆ˜"></a>é…ç½®åˆ’åˆ†å®æˆ˜</h2><p>Nacosé…ç½®ä¸­å¿ƒçš„namespaceã€dataIdå’Œgroupå¯ä»¥æ–¹ä¾¿çµæ´»åœ°åˆ’åˆ†é…ç½®ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªé¡¹ç›®éœ€è¦å¼€å‘ï¼Œé¡¹ç›®åç§°ä¸ºfebsï¼Œé¡¹ç›®å¼€å‘äººå‘˜åˆ†ä¸ºä¸¤ä¸ªç»„ï¼šGROUP_Aå’ŒGROUP_Bï¼Œé¡¹ç›®åˆ†ä¸ºä¸‰ä¸ªç¯å¢ƒï¼šå¼€å‘ç¯å¢ƒdevã€æµ‹è¯•ç¯å¢ƒtestå’Œç”Ÿäº§ç¯å¢ƒprodã€‚</p><p>å‡å¦‚ç°åœ¨GROUP_Aç»„çš„ç»„é•¿éœ€è¦åœ¨Nacosä¸­æ–°å»ºä¸€ä¸ªå¼€å‘ç¯å¢ƒçš„febsé¡¹ç›®é…ç½®ï¼Œé‚£ä¹ˆä»–å¯ä»¥è¿™æ ·åšï¼š</p><ol><li>åœ¨Nacosæ§åˆ¶å°ä¸­æ–°å»ºä¸€ä¸ªåç§°ä¸ºfebsçš„å‘½åç©ºé—´ï¼š</li></ol><p><img src="img/QQ20200316-094921@2x.png" alt="QQ20200316-094921@2x"></p><p><img src="img/QQ20200316-094952@2x.png" alt="QQ20200316-094952@2x"></p><p><img src="img/QQ20200316-095015@2x.png" alt="QQ20200316-095015@2x"></p><p>æ–°å»ºfebså‘½åç©ºé—´åï¼Œä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€æ ‡è¯†è¯¥å‘½åç©ºé—´çš„å‘½åç©ºé—´id<code>2ef2186e-078c-4904-8643-ff5e90555456</code>ã€‚</p><ol start="2"><li>åœ¨Nacosæ§åˆ¶å°ä¸­æ–°å»ºä¸€ä¸ªé…ç½®ï¼š</li></ol><p><img src="img/QQ20200316-100032@2x.png" alt="QQ20200316-100032@2x"></p><p><img src="img/QQ20200316-095417@2x.png" alt="QQ20200316-095417@2x"></p><ol start="3"><li>æœ€ååœ¨febsé¡¹ç›®çš„bootstrap.ymlé…ç½®æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®å³å¯ï¼š<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  profiles:</span></span><br><span class="line"><span class="attr">    active:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line"><span class="attr">        file-extension:</span> <span class="string">yaml</span></span><br><span class="line"><span class="attr">        prefix:</span> <span class="string">febs</span></span><br><span class="line"><span class="attr">        namespace:</span> <span class="string">'2ef2186e-078c-4904-8643-ff5e90555456'</span></span><br><span class="line"><span class="attr">        group:</span> <span class="string">GROUP_A</span></span><br></pre></td></tr></table></figure></li></ol><p><img src="img/QQ20200316-100224@2x.png" alt="QQ20200316-100224@2x"></p><h2 id="é…ç½®å›æ»š"><a href="#é…ç½®å›æ»š" class="headerlink" title="é…ç½®å›æ»š"></a>é…ç½®å›æ»š</h2><p>Nacosä¸­ï¼Œä¿®æ”¹é…ç½®ç‚¹å‡»å‘å¸ƒåä¼šåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„å†å²ç‰ˆæœ¬å¿«ç…§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Nacosæ§åˆ¶å°çš„å†å²ç‰ˆæœ¬åˆ—è¡¨ä¸­æ‰¾åˆ°è¿™äº›å¿«ç…§ï¼š</p><p><img src="img/QQ20200316-100425@2x.png" alt="QQ20200316-100425@2x"></p><p>ç‚¹å‡»å›æ»šæŒ‰é’®å³å¯å°†é…ç½®æ¢å¤åˆ°æŒ‡å®šçš„ç‰ˆæœ¬ã€‚</p><h2 id="è·å–å¤šä¸ªé…ç½®"><a href="#è·å–å¤šä¸ªé…ç½®" class="headerlink" title="è·å–å¤šä¸ªé…ç½®"></a>è·å–å¤šä¸ªé…ç½®</h2><p>é™¤äº†é€šè¿‡ä¸Šé¢çš„æ–¹å¼æŒ‡å®šä¸€ä¸ªå”¯ä¸€é…ç½®å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åŒæ—¶è·å–å¤šä¸ªé…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œæ¯”å¦‚ï¼Œå°†é¡¹ç›®çš„bootstrap.ymlå†…å®¹ä¿®æ”¹ä¸ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line"><span class="attr">        extension-configs:</span></span><br><span class="line"><span class="attr">          - dataId:</span> <span class="string">ext-config-one.yaml</span></span><br><span class="line"><span class="attr">            group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">            refresh:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          - dataId:</span> <span class="string">ext-config-two.yaml</span></span><br><span class="line"><span class="attr">            group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">            refresh:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p></p><ul><li><p><code>spring.cloud.nacos.config.extension-configs[n].dataId</code>ï¼ŒæŒ‡å®šå¤šä¸ªé…ç½®çš„dataIdï¼Œå¿…é¡»åŒ…å«æ–‡ä»¶æ ¼å¼ï¼Œæ”¯æŒpropertiesã€yamlæˆ–ymlï¼›</p></li><li><p><code>spring.cloud.nacos.config.extension-configs[n].group</code>ï¼ŒæŒ‡å®šåˆ†ç»„ï¼›</p></li><li><p><code>spring.cloud.nacos.config.extension-configs[n].refresh</code>ï¼Œæ˜¯å¦æ”¯æŒåˆ·æ–°ã€‚</p></li></ul><p>ä¸Šé¢çš„é…ç½®ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«ä»DEFAULT_GROUPä¸­è·å–äº†<code>ext-config-one.yaml</code>å’Œ<code>ext-config-two.yaml</code>é…ç½®å†…å®¹ï¼Œå¹¶ä¸”<code>ext-config-one.yaml</code>æ”¯æŒåˆ·æ–°ï¼Œ<code>ext-config-two.yaml</code>ä¸æ”¯æŒåˆ·æ–°ã€‚</p><div class="note danger">æ²¡æœ‰namespaceçš„é…ç½®ï¼Œè¨€å¤–ä¹‹æ„å°±æ˜¯Nacosç›®å‰è¿˜ä¸æ”¯æŒå¤šä¸ªé…ç½®æŒ‡å®šä¸åŒçš„å‘½åç©ºé—´ã€‚</div><p>æˆ‘ä»¬åœ¨Nacosæ§åˆ¶å°ä¸­æ–°å»ºè¿™ä¸¤ä¸ªé…ç½®ï¼š</p><p><img src="img/QQ20200316-105741@2x.png" alt="QQ20200316-105741@2x"></p><p><code>ext-config-one.yaml</code>é…ç½®å†…å®¹ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ext1:</span> <span class="string">'hello'</span></span><br></pre></td></tr></table></figure><p></p><p><code>ext-config-two.yaml</code>é…ç½®å†…å®¹ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ext2:</span> <span class="string">'world'</span></span><br></pre></td></tr></table></figure><p></p><p>åœ¨é¡¹ç›®çš„<code>TestController</code>ä¸­æ·»åŠ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;ext1:null&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String ext1;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;ext2:null&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String ext2;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"multi"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">multiConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"ext1: %s ext2: %s"</span>, ext1, ext2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨é¡¹ç›®ï¼Œæµè§ˆå™¨è®¿é—®ï¼š<a href="http://localhost:8080/multi" target="_blank" rel="noopener">http://localhost:8080/multi</a>ï¼š</p><p><img src="img/QQ20200316-112930@2x.png" alt="QQ20200316-112930@2x"></p><p>å°†<code>ext1</code>çš„å€¼ä¿®æ”¹ä¸º<code>nice</code>ï¼Œ<code>ext2</code>çš„å€¼ä¿®æ”¹ä¸º<code>job</code>ï¼š</p><p><img src="img/QQ20200316-113120@2x.png" alt="QQ20200316-113120@2x"></p><p>å¯ä»¥çœ‹åˆ°<code>ext1</code>çš„å€¼æ›´æ–°äº†ï¼Œ<code>ext2</code>æ²¡æœ‰æ›´æ–°ã€‚</p><h2 id="å¤šé…ç½®å…±äº«"><a href="#å¤šé…ç½®å…±äº«" class="headerlink" title="å¤šé…ç½®å…±äº«"></a>å¤šé…ç½®å…±äº«</h2><p>å¤šé…ç½®å…±äº«å…¶å®å’Œè·å–å¤šä¸ªæ–‡ä»¶é…ç½®ä½œç”¨å·®ä¸å¤šï¼Œä¸‹é¢æ¼”ç¤ºä¸‹å¤šé…ç½®å…±äº«ã€‚</p><p>å°†bootstrap.ymlé…ç½®ä¿®æ”¹ä¸ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line"><span class="attr">        shared-configs:</span> <span class="string">ext-config-one.yaml,ext-config-two.yaml</span></span><br></pre></td></tr></table></figure><p></p><p><code>spring.cloud.nacos.config.shared-configs</code>æŒ‡å®šäº†å…±äº«<code>ext-config-one.yaml</code>å’Œ<code>ext-config-two.yaml</code>çš„é…ç½®ã€‚</p><p>é‡å¯é¡¹ç›®ï¼Œè®¿é—®<a href="http://localhost:8080/multi" target="_blank" rel="noopener">http://localhost:8080/multi</a>ï¼š</p><p><img src="img/QQ20200316-134742@2x.png" alt="QQ20200316-134742@2x"></p><p>ä¹Ÿå¯ä»¥æ­£å¸¸è·å–ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯å¤šé…ç½®å…±äº«è¿˜æ˜¯è·å–å¤šä¸ªé…ç½®ï¼Œè¦å®Œæˆçš„äº‹æƒ…æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡å®ƒä»¬éƒ½æœ‰å„è‡ªçš„å±€é™æ€§ã€‚å¤šé…ç½®å…±äº«æ— æ³•æŒ‡å®šåˆ†ç»„ã€æ— æ³•æŒ‡å®šå‘½åç©ºé—´ã€æ— æ³•é…ç½®æ˜¯å¦åˆ·æ–°ï¼›è·å–å¤šä¸ªé…ç½®ç›¸å¯¹è¾ƒä¸ºçµæ´»ï¼Œä¸è¿‡ä¹Ÿä¸èƒ½é…ç½®å‘½åç©ºé—´ã€‚å…·ä½“ç›¸å…³çš„è®¨è®ºå¯ä»¥å‚è€ƒï¼š<a href="https://github.com/alibaba/spring-cloud-alibaba/issues/141" target="_blank" rel="noopener">https://github.com/alibaba/spring-cloud-alibaba/issues/141</a></p><h2 id="å¸¸ç”¨é…ç½®"><a href="#å¸¸ç”¨é…ç½®" class="headerlink" title="å¸¸ç”¨é…ç½®"></a>å¸¸ç”¨é…ç½®</h2><table><thead><tr><th>é…ç½®é¡¹</th><th>key</th><th>é»˜è®¤å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>æœåŠ¡ç«¯åœ°å€</td><td>spring.cloud.nacos.config.server-addr</td><td></td><td></td></tr><tr><td>DataIdå‰ç¼€</td><td>spring.cloud.nacos.config.prefix</td><td></td><td>spring.application.name</td></tr><tr><td>Group</td><td>spring.cloud.nacos.config.group</td><td>DEFAULT_GROUP</td><td></td></tr><tr><td>dataIDåç¼€åŠå†…å®¹æ–‡ä»¶æ ¼å¼</td><td>spring.cloud.nacos.config.file-extension</td><td>properties</td><td>dataIdçš„åç¼€ï¼ŒåŒæ—¶ä¹Ÿæ˜¯é…ç½®å†…å®¹çš„æ–‡ä»¶æ ¼å¼ï¼Œç›®å‰åªæ”¯æŒ properties</td></tr><tr><td>é…ç½®å†…å®¹çš„ç¼–ç æ–¹å¼</td><td>spring.cloud.nacos.config.encode</td><td>UTF-8</td><td>é…ç½®çš„ç¼–ç </td></tr><tr><td>è·å–é…ç½®çš„è¶…æ—¶æ—¶é—´</td><td>spring.cloud.nacos.config.timeout</td><td>3000</td><td>å•ä½ä¸º ms</td></tr><tr><td>é…ç½®çš„å‘½åç©ºé—´</td><td>spring.cloud.nacos.config.namespace</td><td></td><td>å¸¸ç”¨åœºæ™¯ä¹‹ä¸€æ˜¯ä¸åŒç¯å¢ƒçš„é…ç½®çš„åŒºåˆ†éš”ç¦»ï¼Œä¾‹å¦‚å¼€å‘æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„èµ„æºéš”ç¦»ç­‰ã€‚</td></tr><tr><td>AccessKey</td><td>spring.cloud.nacos.config.access-key</td><td></td><td></td></tr><tr><td>SecretKey</td><td>spring.cloud.nacos.config.secret-key</td><td></td><td></td></tr><tr><td>ç›¸å¯¹è·¯å¾„</td><td>spring.cloud.nacos.config.context-path</td><td></td><td>æœåŠ¡ç«¯ API çš„ç›¸å¯¹è·¯å¾„</td></tr><tr><td>æ¥å…¥ç‚¹</td><td>spring.cloud.nacos.config.endpoint</td><td></td><td>åœ°åŸŸçš„æŸä¸ªæœåŠ¡çš„å…¥å£åŸŸåï¼Œé€šè¿‡æ­¤åŸŸåå¯ä»¥åŠ¨æ€åœ°æ‹¿åˆ°æœåŠ¡ç«¯åœ°å€</td></tr><tr><td>æ˜¯å¦å¼€å¯ç›‘å¬å’Œè‡ªåŠ¨åˆ·æ–°</td><td>spring.cloud.nacos.config.refresh.enabled</td><td>true</td><td></td></tr></tbody></table><p>å‚è€ƒé“¾æ¥ï¼š</p><p><a href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-examples/nacos-example/nacos-config-example/readme-zh.md" target="_blank" rel="noopener">https://github.com/alibaba/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-examples/nacos-example/nacos-config-example/readme-zh.md</a></p><p><a href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_nacos_config" target="_blank" rel="noopener">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_nacos_config</a></p><blockquote><p>æœ¬èŠ‚æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/75.spring-cloud-alibaba-nacos-config" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/75.spring-cloud-alibaba-nacos-config</a>ã€‚</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:56:00 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;ä¸Šä¸€èŠ‚&lt;a href=&quot;Spring-Cloud-Alibaba-Nacosæ³¨å†Œä¸­å¿ƒ.html&quot;&gt;Spring Cloud Alibaba Nacosæ³¨å†Œä¸­å¿ƒ&lt;/a&gt;è®°å½•äº†Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„ä½¿ç”¨æ–¹å¼ï¼Œè¿™èŠ‚ç»§ç»­è®°å½•ä¸‹Nacosä½œä¸ºé…ç½®ä¸­å¿ƒçš„ä½¿ç”¨æ–¹å¼ã€‚æœ¬èŠ‚ä½¿ç”¨çš„Spring Cloudç‰ˆæœ¬ä¸ºHoxton.SR3ï¼ŒSpring Cloud Alibabaç‰ˆæœ¬ä¸º2.2.0.RELEASEï¼ŒSpring Bootç‰ˆæœ¬ä¸º2.2.3.RELEASEã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Cloud" scheme="http://mrbird.cc/tags/Spring-Cloud/"/>
    
      <category term="Spring Cloud Alibaba" scheme="http://mrbird.cc/tags/Spring-Cloud-Alibaba/"/>
    
      <category term="Nacos" scheme="http://mrbird.cc/tags/Nacos/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Alibaba Nacosæ³¨å†Œä¸­å¿ƒ</title>
    <link href="http://mrbird.cc/Spring-Cloud-Alibaba-Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83.html"/>
    <id>http://mrbird.cc/Spring-Cloud-Alibaba-Nacosæ³¨å†Œä¸­å¿ƒ.html</id>
    <published>2020-03-13T07:53:20.000Z</published>
    <updated>2020-03-19T01:20:00.196Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:56:00 GMT+0800 (GMT+08:00) --><p><a href="https://nacos.io/zh-cn/index.html" target="_blank" rel="noopener">Nacos</a>æ˜¯ä¸€æ¬¾é›†æœåŠ¡æ³¨å†Œå‘ç°ã€æœåŠ¡é…ç½®å’Œç®¡ç†äºä¸€èº«çš„å¼€æºè½¯ä»¶ï¼Œè¿™èŠ‚ä¸»è¦è®°å½•Nacosçš„æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½çš„ä½¿ç”¨ã€‚å€ŸåŠ©Spring Cloud Alibaba Nacos Discoveryï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°ä½¿ç”¨Spring Cloudç¼–ç¨‹æ¨¡å‹ä½“éªŒNacosçš„æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½ã€‚æœ¬èŠ‚ä½¿ç”¨çš„Spring Cloudç‰ˆæœ¬ä¸ºHoxton.SR3ï¼ŒSpring Cloud Alibabaç‰ˆæœ¬ä¸º2.2.0.RELEASEï¼ŒSpring Bootç‰ˆæœ¬ä¸º2.2.3.RELEASEã€‚</p><a id="more"></a><h2 id="Nacoså®‰è£…"><a href="#Nacoså®‰è£…" class="headerlink" title="Nacoså®‰è£…"></a>Nacoså®‰è£…</h2><p>å› ä¸ºSpring Cloud Alibaba 2.2.0.RELEASEå†…ç½®çš„Nacos clientç‰ˆæœ¬ä¸º1.1.4ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬çš„Nacosã€‚Nacosä¸‹è½½åœ°å€ï¼š<a href="https://github.com/alibaba/nacos/releases" target="_blank" rel="noopener">https://github.com/alibaba/nacos/releases</a>ï¼Œé€‰æ‹©nacos-server-1.1.4.zip ä¸‹è½½å¹¶è§£å‹ï¼š</p><p><img src="img/QQ20200313-095737@2x.png" alt="QQ20200313-095737@2x"></p><p>è§£å‹åï¼Œæ‰“å¼€confç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œåœ¨æœ«å°¾æ·»åŠ æ•°æ®æºé…ç½®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.platform=mysql</span><br><span class="line">db.num=<span class="number">1</span></span><br><span class="line">db.url<span class="number">.0</span>=jdbc:mysql:<span class="comment">//localhost:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span></span><br><span class="line">db.user=root</span><br><span class="line">db.password=<span class="number">123456</span></span><br></pre></td></tr></table></figure><p></p><p>ç„¶ååœ¨MySQLæ•°æ®åº“ä¸­æ–°å»ºnacosæ•°æ®åº“ï¼Œå¹¶å¯¼å…¥Nacosè§£å‹åŒ…confç›®å½•ä¸‹çš„nacos-mysql.sqlè„šæœ¬ï¼Œå¯¼å…¥åï¼Œåº“è¡¨å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200313-100402@2x.png" alt="QQ20200313-100402@2x"></p><p>æ•°æ®å±‚å‡†å¤‡å¥½åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯åŠ¨Nacosäº†ã€‚ç¬”è€…çš„ç”µè„‘ä¸ºMacï¼Œæ‰€ä»¥è¿™é‡Œä»¥Unixç¯å¢ƒä¸ºä¾‹ã€‚ç»ˆç«¯åˆ‡æ¢åˆ°Nacosè§£å‹ç›®å½•ä¸‹çš„binç›®å½•ï¼Œç„¶åæ‰§è¡Œ<code>sh startup.sh -m standalone</code>å¯åŠ¨å•æœºç‰ˆNacosã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªrun.shè„šæœ¬ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/bin/bash</span></span><br><span class="line">sh shutdown.sh</span><br><span class="line">sh startup.sh -m standalone</span><br><span class="line">tail -10f /Users/mrbird/Desktop/nacos/logs/start.out</span><br></pre></td></tr></table></figure><p></p><p>å…¶ä¸­<code>/Users/mrbird/Desktop/nacos</code>ä¸ºæˆ‘çš„Nacosè§£å‹ç›®å½•ã€‚å¯åŠ¨åï¼Œæµè§ˆå™¨è®¿é—®ï¼š<a href="http://localhost:8848/nacos/#/login" target="_blank" rel="noopener">http://localhost:8848/nacos/#/login</a>ï¼š</p><p><img src="img/QQ20200313-101410@2x.png" alt="QQ20200313-101410@2x"></p><p>è¯´æ˜Nacoså¯åŠ¨æˆåŠŸï¼Œè´¦å·å¯†ç éƒ½ä¸ºnacosã€‚</p><h2 id="æ¡†æ¶æ­å»º"><a href="#æ¡†æ¶æ­å»º" class="headerlink" title="æ¡†æ¶æ­å»º"></a>æ¡†æ¶æ­å»º</h2><p>ä½¿ç”¨IDEAåˆ›å»ºä¸€ä¸ªmavené¡¹ç›®ï¼ŒartifactIdä¸ºspring-cloud-alibaba-nacos-registerï¼Œç„¶ååœ¨å…¶ä¸‹é¢åˆ›å»ºä¸¤ä¸ªModuleï¼ˆSpring Booté¡¹ç›®ï¼‰ï¼ŒartifactIdåˆ†åˆ«ä¸ºconsumerå’Œproviderï¼Œå……å½“æœåŠ¡æ¶ˆè´¹ç«¯å’ŒæœåŠ¡æä¾›ç«¯ï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200313-103900@2x.png" alt="QQ20200313-103900@2x"></p><p>spring-cloud-alibaba-nacos-registerçš„pomå†…å®¹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-nacos-register<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>provider<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">com-alibaba-cloud.version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">com-alibaba-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;com-alibaba-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºæœ¬èŠ‚æ¼”ç¤ºçš„æ˜¯Nacosçš„æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½ï¼Œæ‰€ä»¥å¼•å…¥çš„æ˜¯<code>spring-cloud-alibaba-nacos-discovery</code>ä¾èµ–ã€‚</p><p>providerçš„pomçš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-nacos-register<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../pom.xml<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>provider<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>æœåŠ¡æä¾›ç«¯<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>consumerçš„pomå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-nacos-register<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../pom.xml<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>æœåŠ¡æ¶ˆè´¹ç«¯<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><h2 id="Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒ"><a href="#Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒ" class="headerlink" title="Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒ"></a>Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒ</h2><p>åœ¨providerçš„cc.mrbird.providerç›®å½•ä¸‹æ–°å»ºcontrolleråŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>HelloController</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"provide"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"&#123;message&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(@PathVariable String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"hello %s"</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æä¾›äº†ä¸€ä¸ªRESTæ¥å£ï¼Œä¾›consumerè°ƒç”¨ã€‚</p><p>ç„¶ååœ¨providerçš„é¡¹ç›®é…ç½®æ–‡ä»¶application.ymlé‡Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">provider</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="attr">localhost:8848</span></span><br></pre></td></tr></table></figure><p></p><ul><li><code>server.port</code>ï¼ŒprovideræœåŠ¡ç«¯å£ä¸º8001ï¼›</li><li><code>spring.application.name</code>ï¼ŒæœåŠ¡åç§°ä¸ºprovider</li><li><code>spring.cloud.nacos.server-addr</code>ï¼ŒæŒ‡å®šNacosæ³¨å†Œä¸­å¿ƒçš„åœ°å€ã€‚</li></ul><p>providerä»£ç å‡†å¤‡å¥½åï¼Œæ¥ç€åœ¨consumeré¡¹ç›®çš„cc.mrbird.consumerç›®å½•ä¸‹æ–°å»ºcontrolleråŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>ConsumeController</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"consume"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumeController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancerClient;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"hello/&#123;message&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(@PathVariable String message)</span> </span>&#123;</span><br><span class="line">        ServiceInstance serviceInstance = loadBalancerClient.choose(<span class="string">"provider"</span>);</span><br><span class="line">        String path = String.format(<span class="string">"http://%s:%s/provide/%s"</span>, serviceInstance.getHost(), serviceInstance.getPort(), message);</span><br><span class="line">        String result = restTemplate.getForObject(path, String.class);</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"%s from %s %s"</span>, result, serviceInstance.getHost(), serviceInstance.getPort());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸º<code>spring-cloud-alibaba-nacos-discovery</code>å†…ç½®äº†Ribbonï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥æ³¨å…¥<code>LoadBalancerClient</code>ï¼Œ<code>RestTemplate</code>æˆ‘ä»¬ç¨åå†é…ç½®ã€‚<code>hello()</code>æ–¹æ³•ä¸­æˆ‘ä»¬é€šè¿‡æœåŠ¡æä¾›è€…çš„åç§°providerï¼ˆå³provideré¡¹ç›®é…ç½®çš„<code>spring.application.name</code>ï¼‰ä»Nacosæ³¨å†Œä¸­å¿ƒä¸­è·å–å¯¹åº”çš„æœåŠ¡å®ä¾‹ï¼Œç„¶åè®¿é—®å…¶æä¾›çš„<code>/provide/{message} GET</code>æœåŠ¡ã€‚è¿™äº›åœ¨<a href="Spring-Cloud-Ribbon-LoadBalance.html">Spring Cloud Ribbonå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡</a>ä¸€èŠ‚ä¸­éƒ½ä»‹ç»è¿‡äº†ï¼Œæœ‰ä¸æ‡‚çš„å¯ä»¥å‚é˜…ä¸‹ã€‚</p><p>æ¥ç€åœ¨consumeré¡¹ç›®çš„cc.mrbird.consumerç›®å½•ä¸‹æ–°å»ºconfigureåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>ConsumerConfigure</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerConfigure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç é…ç½®äº†<code>RestTemplate</code> Beanã€‚</p><p>æœ€ååœ¨consumeré¡¹ç›®çš„é…ç½®æ–‡ä»¶application.ymlä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">consumer</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="attr">localhost:8848</span></span><br></pre></td></tr></table></figure><p></p><p>é…ç½®å’Œprovideré¡¹ç›®ç±»ä¼¼ï¼Œä¸å†èµ˜è¿°ã€‚</p><p>åˆ†åˆ«å¯åŠ¨providerå’Œconsumeré¡¹ç›®ï¼š</p><p><img src="img/QQ20200313-122632@2x.png" alt="QQ20200313-122632@2x"></p><p>è§‚å¯ŸNacosæ§åˆ¶å°æœåŠ¡åˆ—è¡¨ï¼š</p><p><img src="img/QQ20200313-122748@2x.png" alt="QQ20200313-122748@2x"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªæœåŠ¡éƒ½æ³¨å†Œè¿›æ¥äº†ã€‚æ¥ç€æµè§ˆå™¨è®¿é—®ï¼š<a href="http://localhost:9001/consume/hello/nacos" target="_blank" rel="noopener">http://localhost:9001/consume/hello/nacos</a>ï¼š</p><p><img src="img/QQ20200313-122916@2x.png" alt="QQ20200313-122916@2x"></p><p>è°ƒç”¨æˆåŠŸï¼Œè¯´æ˜æœåŠ¡å‘ç°æˆåŠŸã€‚</p><h2 id="æµ‹è¯•è´Ÿè½½å‡è¡¡"><a href="#æµ‹è¯•è´Ÿè½½å‡è¡¡" class="headerlink" title="æµ‹è¯•è´Ÿè½½å‡è¡¡"></a>æµ‹è¯•è´Ÿè½½å‡è¡¡</h2><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨ProviderApplicationä¸Šå³é”®é€‰æ‹©Copy Configurationâ€¦ï¼š</p><p><img src="img/QQ20200313-123539@2x.png" alt="QQ20200313-123539@2x"></p><p>ç„¶åæŒ‰ç…§ä¸‹å›¾æ‰€ç¤ºå¡«å†™ç›¸å…³å†…å®¹ï¼š</p><p><img src="img/QQ20200313-123806@2x.png" alt="QQ20200313-123806@2x"></p><p>ç‚¹å‡»okä¿å­˜åï¼Œå¯åŠ¨å®ƒï¼š</p><p><img src="img/QQ20200313-123912@2x.png" alt="QQ20200313-123912@2x"></p><p>è§‚å¯ŸNacosæ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°providerå·²ç»æœ‰ä¸¤ä¸ªå®ä¾‹äº†ï¼š</p><p><img src="img/QQ20200313-124004@2x.png" alt="QQ20200313-124004@2x"></p><p>ç„¶åå¤šæ¬¡è®¿é—®ï¼š<a href="http://localhost:9001/consume/hello/nacos" target="_blank" rel="noopener">http://localhost:9001/consume/hello/nacos</a>ï¼Œå¯ä»¥çœ‹åˆ°è¯·æ±‚æ˜¯å‡è¡¡çš„ï¼ˆé»˜è®¤ä¸ºè½®è¯¢ç®—æ³•ï¼‰ï¼š</p><p><img src="img/2020-03-13 12.54.05.gif" alt="2020-03-13 12.54.05.gif"></p><h2 id="Nacosæ³¨å†Œä¸­å¿ƒé…ç½®"><a href="#Nacosæ³¨å†Œä¸­å¿ƒé…ç½®" class="headerlink" title="Nacosæ³¨å†Œä¸­å¿ƒé…ç½®"></a>Nacosæ³¨å†Œä¸­å¿ƒé…ç½®</h2><p>æ›´å¤šå¯ç”¨Nacos Descoveryé…ç½®ï¼š</p><table><thead><tr><th>é…ç½®é¡¹</th><th>Key</th><th>é»˜è®¤å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>æœåŠ¡ç«¯åœ°å€</td><td>spring.cloud.nacos.discovery.server-addr</td><td>æ— </td><td>Nacos Server å¯åŠ¨ç›‘å¬çš„ipåœ°å€å’Œç«¯å£</td></tr><tr><td>æœåŠ¡å</td><td>spring.cloud.nacos.discovery.service</td><td>${spring.application.name}</td><td>ç»™å½“å‰çš„æœåŠ¡å‘½å</td></tr><tr><td>æœåŠ¡åˆ†ç»„</td><td>spring.cloud.nacos.discovery.group</td><td>DEFAULT_GROUP</td><td>è®¾ç½®æœåŠ¡æ‰€å¤„çš„åˆ†ç»„</td></tr><tr><td>æƒé‡</td><td>spring.cloud.nacos.discovery.weight</td><td>1</td><td>å–å€¼èŒƒå›´ 1 åˆ° 100ï¼Œæ•°å€¼è¶Šå¤§ï¼Œæƒé‡è¶Šå¤§</td></tr><tr><td>ç½‘å¡å</td><td>spring.cloud.nacos.discovery.network-interface</td><td>æ— </td><td>å½“IPæœªé…ç½®æ—¶ï¼Œæ³¨å†Œçš„IPä¸ºæ­¤ç½‘å¡æ‰€å¯¹åº”çš„IPåœ°å€ï¼Œå¦‚æœæ­¤é¡¹ä¹Ÿæœªé…ç½®ï¼Œåˆ™é»˜è®¤å–ç¬¬ä¸€å—ç½‘å¡çš„åœ°å€</td></tr><tr><td>æ³¨å†Œçš„IPåœ°å€</td><td>spring.cloud.nacos.discovery.ip</td><td>æ— </td><td>ä¼˜å…ˆçº§æœ€é«˜</td></tr><tr><td>æ³¨å†Œçš„ç«¯å£</td><td>spring.cloud.nacos.discovery.port</td><td>-1</td><td>é»˜è®¤æƒ…å†µä¸‹ä¸ç”¨é…ç½®ï¼Œä¼šè‡ªåŠ¨æ¢æµ‹</td></tr><tr><td>å‘½åç©ºé—´</td><td>spring.cloud.nacos.discovery.namespace</td><td>æ— </td><td>å¸¸ç”¨åœºæ™¯ä¹‹ä¸€æ˜¯ä¸åŒç¯å¢ƒçš„æ³¨å†Œçš„åŒºåˆ†éš”ç¦»ï¼Œä¾‹å¦‚å¼€å‘æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„èµ„æºï¼ˆå¦‚é…ç½®ã€æœåŠ¡ï¼‰éš”ç¦»ç­‰ã€‚</td></tr><tr><td>AccessKey</td><td>spring.cloud.nacos.discovery.access-key</td><td>æ— </td><td>å½“è¦ä¸Šé˜¿é‡Œäº‘æ—¶ï¼Œé˜¿é‡Œäº‘ä¸Šé¢çš„ä¸€ä¸ªäº‘è´¦å·å</td></tr><tr><td>SecretKey</td><td>spring.cloud.nacos.discovery.secret-key</td><td>æ— </td><td>å½“è¦ä¸Šé˜¿é‡Œäº‘æ—¶ï¼Œé˜¿é‡Œäº‘ä¸Šé¢çš„ä¸€ä¸ªäº‘è´¦å·å¯†ç </td></tr><tr><td>Metadata</td><td>spring.cloud.nacos.discovery.metadata</td><td>æ— </td><td>ä½¿ç”¨Mapæ ¼å¼é…ç½®ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è‡ªå®šä¹‰ä¸€äº›å’ŒæœåŠ¡ç›¸å…³çš„å…ƒæ•°æ®ä¿¡æ¯</td></tr><tr><td>æ—¥å¿—æ–‡ä»¶å</td><td>spring.cloud.nacos.discovery.log-name</td><td>æ— </td><td></td></tr><tr><td>é›†ç¾¤</td><td>spring.cloud.nacos.discovery.cluster-name</td><td>DEFAULT</td><td>é…ç½®æˆNacosé›†ç¾¤åç§°</td></tr><tr><td>æ¥å…¥ç‚¹</td><td>spring.cloud.nacos.discovery.enpoint</td><td>UTF-8</td><td>åœ°åŸŸçš„æŸä¸ªæœåŠ¡çš„å…¥å£åŸŸåï¼Œé€šè¿‡æ­¤åŸŸåå¯ä»¥åŠ¨æ€åœ°æ‹¿åˆ°æœåŠ¡ç«¯åœ°å€</td></tr><tr><td>æ˜¯å¦é›†æˆRibbon</td><td>ribbon.nacos.enabled</td><td>true</td><td>ä¸€èˆ¬éƒ½è®¾ç½®æˆtrueå³å¯</td></tr><tr><td>æ˜¯å¦å¼€å¯Nacos Watch</td><td>spring.cloud.nacos.discovery.watch.enabled</td><td>true</td><td>å¯ä»¥è®¾ç½®æˆfalseæ¥å…³é—­ watch</td></tr></tbody></table><blockquote><p>æœ¬èŠ‚æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/74.spring-cloud-alibaba-nacos-register" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/74.spring-cloud-alibaba-nacos-register</a>ã€‚</p></blockquote><blockquote><p>å‚è€ƒè‡ªå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_nacos_discovery" target="_blank" rel="noopener">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_nacos_discovery</a></p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:56:00 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;&lt;a href=&quot;https://nacos.io/zh-cn/index.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Nacos&lt;/a&gt;æ˜¯ä¸€æ¬¾é›†æœåŠ¡æ³¨å†Œå‘ç°ã€æœåŠ¡é…ç½®å’Œç®¡ç†äºä¸€èº«çš„å¼€æºè½¯ä»¶ï¼Œè¿™èŠ‚ä¸»è¦è®°å½•Nacosçš„æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½çš„ä½¿ç”¨ã€‚å€ŸåŠ©Spring Cloud Alibaba Nacos Discoveryï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°ä½¿ç”¨Spring Cloudç¼–ç¨‹æ¨¡å‹ä½“éªŒNacosçš„æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½ã€‚æœ¬èŠ‚ä½¿ç”¨çš„Spring Cloudç‰ˆæœ¬ä¸ºHoxton.SR3ï¼ŒSpring Cloud Alibabaç‰ˆæœ¬ä¸º2.2.0.RELEASEï¼ŒSpring Bootç‰ˆæœ¬ä¸º2.2.3.RELEASEã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Cloud" scheme="http://mrbird.cc/tags/Spring-Cloud/"/>
    
      <category term="Spring Cloud Alibaba" scheme="http://mrbird.cc/tags/Spring-Cloud-Alibaba/"/>
    
      <category term="Nacos" scheme="http://mrbird.cc/tags/Nacos/"/>
    
  </entry>
  
  <entry>
    <title>Spring Batchå¼‚å¸¸å¤„ç†</title>
    <link href="http://mrbird.cc/Spring-Batch%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.html"/>
    <id>http://mrbird.cc/Spring-Batchå¼‚å¸¸å¤„ç†.html</id>
    <published>2020-03-12T03:55:03.000Z</published>
    <updated>2020-03-12T03:35:05.139Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p>Spring Batchå¤„ç†ä»»åŠ¡è¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿäº†å¼‚å¸¸ï¼Œé»˜è®¤æœºåˆ¶æ˜¯é©¬ä¸Šåœæ­¢ä»»åŠ¡æ‰§è¡Œï¼ŒæŠ›å‡ºç›¸åº”å¼‚å¸¸ï¼Œå¦‚æœä»»åŠ¡è¿˜åŒ…å«æœªæ‰§è¡Œçš„æ­¥éª¤ä¹Ÿä¸ä¼šè¢«æ‰§è¡Œã€‚è¦æ”¹å˜è¿™ä¸ªé»˜è®¤è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®å¼‚å¸¸é‡è¯•å’Œå¼‚å¸¸è·³è¿‡æœºåˆ¶ã€‚<strong>å¼‚å¸¸è·³è¿‡</strong>ï¼šé‡åˆ°å¼‚å¸¸çš„æ—¶å€™ä¸å¸Œæœ›ç»“æŸä»»åŠ¡ï¼Œè€Œæ˜¯è·³è¿‡è¿™ä¸ªå¼‚å¸¸ï¼Œç»§ç»­æ‰§è¡Œï¼›<strong>å¼‚å¸¸é‡è¯•</strong>ï¼šé‡åˆ°å¼‚å¸¸çš„æ—¶å€™ç»è¿‡æŒ‡å®šæ¬¡æ•°çš„é‡è¯•ï¼Œå¦‚æœè¿˜æ˜¯å¤±è´¥çš„è¯ï¼Œæ‰ä¼šåœæ­¢ä»»åŠ¡ã€‚é™¤äº†è¿™ä¸¤ä¸ªç‰¹æ€§å¤–ï¼Œæœ¬æ–‡ä¹Ÿä¼šè®°å½•ä¸€äº›åˆ«çš„ç‰¹æ€§ã€‚</p><a id="more"></a><h2 id="æ¡†æ¶æ­å»º"><a href="#æ¡†æ¶æ­å»º" class="headerlink" title="æ¡†æ¶æ­å»º"></a>æ¡†æ¶æ­å»º</h2><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º2.2.4.RELEASEï¼ŒartifactIdä¸ºspring-batch-exceptionï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200311-170619@2x.png" alt="QQ20200311-170619@2x"></p><p>å‰©ä¸‹çš„æ•°æ®åº“å±‚çš„å‡†å¤‡ï¼Œé¡¹ç›®é…ç½®ï¼Œä¾èµ–å¼•å…¥å’Œ<a href="/Spring-Batchå…¥é—¨.html">Spring Batchå…¥é—¨</a>æ–‡ç« ä¸­çš„æ¡†æ¶æ­å»ºæ­¥éª¤ä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¼”ç¤ºä¸‹ï¼Œé»˜è®¤æƒ…å†µä¸‹Spring Batchå¤„ç†ä»»åŠ¡é‡åˆ°å¼‚å¸¸æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚</p><p>åœ¨cc.mrbird.batchç›®å½•ä¸‹æ–°å»ºjobåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>DefaultExceptionJobDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultExceptionJobDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">defaultExceptionJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"defaultExceptionJob"</span>)</span><br><span class="line">                .start(</span><br><span class="line">                    stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                        .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                            <span class="comment">// è·å–æ‰§è¡Œä¸Šä¸‹æ–‡</span></span><br><span class="line">                            ExecutionContext executionContext = chunkContext.getStepContext().getStepExecution().getExecutionContext();</span><br><span class="line">                            <span class="keyword">if</span> (executionContext.containsKey(<span class="string">"success"</span>)) &#123;</span><br><span class="line">                                System.out.println(<span class="string">"ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"</span>);</span><br><span class="line">                                <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                String errorMessage = <span class="string">"å¤„ç†ä»»åŠ¡è¿‡ç¨‹å‘ç”Ÿå¼‚å¸¸"</span>;</span><br><span class="line">                                System.out.println(errorMessage);</span><br><span class="line">                                executionContext.put(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(errorMessage);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;).build()</span><br><span class="line">                ).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨Stepçš„<code>tasklet()</code>æ–¹æ³•ä¸­è·å–äº†æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”åˆ¤æ–­æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­æ˜¯å¦åŒ…å«key<code>success</code>ï¼Œå¦‚æœåŒ…å«ï¼Œåˆ™ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼›å¦‚æœä¸åŒ…å«ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼ˆæŠ›å‡ºå¼‚å¸¸å‰ï¼Œåœ¨æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­æ·»åŠ <code>success</code>keyï¼‰ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2020-03-11 17:12:50.253  INFO 38673 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=defaultExceptionJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-11 17:12:50.323  INFO 38673 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">å¤„ç†ä»»åŠ¡è¿‡ç¨‹å‘ç”Ÿå¼‚å¸¸</span><br><span class="line">2020-03-11 17:12:50.352 ERROR 38673 --- [           main] o.s.batch.core.step.AbstractStep         : Encountered an error executing step step in job defaultExceptionJob</span><br><span class="line"></span><br><span class="line">java.lang.RuntimeException: å¤„ç†ä»»åŠ¡è¿‡ç¨‹å‘ç”Ÿå¼‚å¸¸</span><br><span class="line">	at cc.mrbird.batch.job.DefaultExceptionJobDemo.lambda$defaultExceptionJob$0(DefaultExceptionJobDemo.java:38) ~[classes/:na]</span><br><span class="line">	at org.springframework.batch.core.step.tasklet.TaskletStep$ChunkTransactionCallback.doInTransaction(TaskletStep.java:407) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.tasklet.TaskletStep$ChunkTransactionCallback.doInTransaction(TaskletStep.java:331) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.transaction.support.TransactionTemplate.execute(TransactionTemplate.java:140) ~[spring-tx-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.tasklet.TaskletStep$2.doInChunkContext(TaskletStep.java:273) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring Batchå¤„ç†ä»»åŠ¡è¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿäº†å¼‚å¸¸ä¼šé©¬ä¸Šåœæ­¢ä»»åŠ¡çš„æ‰§è¡Œã€‚</p><p>å†æ¬¡å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2020-03-11 17:14:03.184  INFO 38691 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=defaultExceptionJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-11 17:14:03.264  INFO 38691 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ</span><br><span class="line">2020-03-11 17:14:03.302  INFO 38691 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 37ms</span><br><span class="line">2020-03-11 17:14:03.326  INFO 38691 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=defaultExceptionJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 120ms</span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºåœ¨ä¸Šæ¬¡ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸å‰ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­æ·»åŠ <code>success</code>keyï¼ˆé…åˆMySQLæŒä¹…åŒ–ï¼Œä¸ä¼šå› é¡¹ç›®å¯åŠ¨è€Œä¸¢å¤±ï¼‰ã€‚</p><h2 id="å¼‚å¸¸é‡è¯•"><a href="#å¼‚å¸¸é‡è¯•" class="headerlink" title="å¼‚å¸¸é‡è¯•"></a>å¼‚å¸¸é‡è¯•</h2><p>Spring Batchå…è®¸æˆ‘ä»¬é…ç½®ä»»åŠ¡åœ¨é‡åˆ°æŒ‡å®šå¼‚å¸¸æ—¶è¿›è¡ŒæŒ‡å®šæ¬¡æ•°çš„é‡è¯•ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰å¼‚å¸¸ã€‚åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºexceptionåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>MyJobExecutionException</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJobExecutionException</span> <span class="keyword">extends</span>  <span class="title">Exception</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7168487913507656106L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyJobExecutionException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç„¶ååœ¨jobåŒ…ä¸‹æ–°å»º<code>RetryExceptionJobDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">retryExceptionJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"retryExceptionJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;String, String&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(listItemReader())</span><br><span class="line">                .processor(myProcessor())</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .faultTolerant() <span class="comment">// é…ç½®é”™è¯¯å®¹å¿</span></span><br><span class="line">                .retry(MyJobExecutionException.class) <span class="comment">// é…ç½®é‡è¯•çš„å¼‚å¸¸ç±»å‹</span></span><br><span class="line">                .retryLimit(<span class="number">3</span>) <span class="comment">// é‡è¯•3æ¬¡ï¼Œä¸‰æ¬¡è¿‡åè¿˜æ˜¯å¼‚å¸¸çš„è¯ï¼Œåˆ™ä»»åŠ¡ä¼šç»“æŸï¼Œ</span></span><br><span class="line">                <span class="comment">// å¼‚å¸¸çš„æ¬¡æ•°ä¸ºreaderï¼Œprocessorå’Œwriterä¸­çš„æ€»æ•°ï¼Œè¿™é‡Œä»…åœ¨processoré‡Œæ¼”ç¤ºå¼‚å¸¸é‡è¯•</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ListItemReader&lt;String&gt; <span class="title">listItemReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;String&gt; datas = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">5</span>).forEach(i -&gt; datas.add(String.valueOf(i)));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ListItemReader&lt;&gt;(datas);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ItemProcessor&lt;String, String&gt; <span class="title">myProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ItemProcessor&lt;String, String&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">process</span><span class="params">(String item)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"å½“å‰å¤„ç†çš„æ•°æ®ï¼š"</span> + item);</span><br><span class="line">                <span class="keyword">if</span> (count &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> item;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> MyJobExecutionException(<span class="string">"ä»»åŠ¡å¤„ç†å‡ºé”™"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨<code>step()</code>æ–¹æ³•ä¸­ï¼Œ<code>faultTolerant()</code>è¡¨ç¤ºå¼€å¯å®¹é”™åŠŸèƒ½ï¼Œ<code>retry(MyJobExecutionException.class)</code>è¡¨ç¤ºé‡åˆ°<code>MyJobExecutionException</code>å¼‚å¸¸æ—¶è¿›è¡Œé‡è¯•ï¼Œ<code>retryLimit(3)</code>è¡¨ç¤ºå¦‚æœç¬¬ä¸‰æ¬¡é‡è¯•è¿˜æ˜¯å¤±è´¥çš„è¯ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œç»“æŸä»»åŠ¡ã€‚</p><p>é€šè¿‡å‰é¢çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œæ­¥éª¤StepåŒ…æ‹¬<code>ItemReader</code>ã€<code>ItemWriter</code>å’Œ<code>ItemProcessor</code>ï¼Œä¸Šé¢é…ç½®çš„é”™è¯¯å®¹å¿æ˜¯é’ˆå¯¹æ•´ä¸ªStepçš„ï¼Œæ‰€ä»¥å®¹å¿çš„å¼‚å¸¸æ¬¡æ•°åº”è¯¥æ˜¯readerï¼Œprocessorå’Œwriterä¸­çš„æ€»æ•°ï¼Œä¸Šé¢çš„ä¾‹å­ä»…åœ¨processoré‡Œæ¼”ç¤ºå¼‚å¸¸é‡è¯•ã€‚</p><p><code>myProcessor()</code>çš„ä»£ç é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨å‰ä¸¤æ¬¡çš„æ—¶å€™æŠ›å‡º<code>MyJobExecutionException(&quot;ä»»åŠ¡å¤„ç†å‡ºé”™&quot;)</code>å¼‚å¸¸ï¼ˆ<code>count &lt; 2</code>ï¼‰ï¼Œç¬¬ä¸‰æ¬¡çš„æ—¶å€™æ­£å¸¸è¿”å›itemï¼ˆ<code>count = 2 &gt;= 2</code>ï¼‰ï¼Œæ‰€ä»¥ç†è®ºä¸Šä¸Šé¢çš„ä»»åŠ¡åœ¨é‡è¯•ä¸¤æ¬¡ä¹‹åæ­£å¸¸è¿è¡Œã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">2020-03-12 09:04:53.359  INFO 40522 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=retryExceptionJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-12 09:04:53.415  INFO 40522 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š0</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š0</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š0</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š1</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š2</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š3</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š4</span><br><span class="line">4</span><br><span class="line">2020-03-12 09:04:53.498  INFO 40522 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 83ms</span><br><span class="line">2020-03-12 09:04:53.522  INFO 40522 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=retryExceptionJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 152ms</span><br></pre></td></tr></table></figure><p></p><p>ç»“æœç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p><p>å‡å¦‚é€šè¿‡<code>retryLimit(2)</code>å°†é‡è¯•æ¬¡æ•°è®¾ç½®ä¸º2ï¼Œå¹¶ä¿®æ”¹ä»»åŠ¡çš„åç§°ä¸º<code>retryExceptionJob1</code>ï¼Œå¯åŠ¨é¡¹ç›®çœ‹çœ‹è¿è¡Œç»“æœå¦‚ä½•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">v2020-03-12 09:06:48.855  INFO 40610 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=retryExceptionJob1]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-12 09:06:48.933  INFO 40610 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š0</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š0</span><br><span class="line">2020-03-12 09:06:48.979 ERROR 40610 --- [           main] o.s.batch.core.step.AbstractStep         : Encountered an error executing step step in job retryExceptionJob1</span><br><span class="line"></span><br><span class="line">org.springframework.retry.RetryException: Non-skippable exception in recoverer while processing; nested exception is cc.mrbird.batch.exception.MyJobExecutionException: ä»»åŠ¡å¤„ç†å‡ºé”™</span><br><span class="line">    at org.springframework.batch.core.step.item.FaultTolerantChunkProcessor$2.recover(FaultTolerantChunkProcessor.java:289) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.retry.support.RetryTemplate.handleRetryExhausted(RetryTemplate.java:512) ~[spring-retry-1.2.5.RELEASE.jar:na]</span><br><span class="line">    at org.springframework.retry.support.RetryTemplate.doExecute(RetryTemplate.java:351) ~[spring-retry-1.2.5.RELEASE.jar:na]</span><br><span class="line">    at org.springframework.retry.support.RetryTemplate.execute(RetryTemplate.java:211) ~[spring-retry-1.2.5.RELEASE.jar:na]</span><br><span class="line">    at org.springframework.batch.core.step.item.BatchRetryTemplate.execute(BatchRetryTemplate.java:217) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.step.item.FaultTolerantChunkProcessor.transform(FaultTolerantChunkProcessor.java:298) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.step.item.SimpleChunkProcessor.process(SimpleChunkProcessor.java:210) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.step.item.ChunkOrientedTasklet.execute(ChunkOrientedTasklet.java:77) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.step.tasklet.TaskletStep$ChunkTransactionCallback.doInTransaction(TaskletStep.java:407) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.step.tasklet.TaskletStep$ChunkTransactionCallback.doInTransaction(TaskletStep.java:331) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.transaction.support.TransactionTemplate.execute(TransactionTemplate.java:140) ~[spring-tx-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.step.tasklet.TaskletStep$2.doInChunkContext(TaskletStep.java:273) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.scope.context.StepContextRepeatCallback.doInIteration(StepContextRepeatCallback.java:82) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.repeat.support.RepeatTemplate.getNextResult(RepeatTemplate.java:375) ~[spring-batch-infrastructure-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.repeat.support.RepeatTemplate.executeInternal(RepeatTemplate.java:215) ~[spring-batch-infrastructure-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.repeat.support.RepeatTemplate.iterate(RepeatTemplate.java:145) ~[spring-batch-infrastructure-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.step.tasklet.TaskletStep.doExecute(TaskletStep.java:258) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.step.AbstractStep.execute(AbstractStep.java:208) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.job.SimpleStepHandler.handleStep(SimpleStepHandler.java:148) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.job.AbstractJob.handleStep(AbstractJob.java:410) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.job.SimpleJob.doExecute(SimpleJob.java:136) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.job.AbstractJob.execute(AbstractJob.java:319) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.launch.support.SimpleJobLauncher$1.run(SimpleJobLauncher.java:147) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.core.task.SyncTaskExecutor.execute(SyncTaskExecutor.java:50) [spring-core-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.launch.support.SimpleJobLauncher.run(SimpleJobLauncher.java:140) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_231]</span><br><span class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_231]</span><br><span class="line">    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_231]</span><br><span class="line">    at java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_231]</span><br><span class="line">    at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:344) [spring-aop-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">    at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:198) [spring-aop-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163) [spring-aop-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.configuration.annotation.SimpleBatchConfiguration$PassthruAdvice.invoke(SimpleBatchConfiguration.java:127) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186) [spring-aop-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">    at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:212) [spring-aop-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">    at com.sun.proxy.$Proxy46.run(Unknown Source) [na:na]</span><br><span class="line">    at org.springframework.boot.autoconfigure.batch.JobLauncherCommandLineRunner.execute(JobLauncherCommandLineRunner.java:192) [spring-boot-autoconfigure-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">    at org.springframework.boot.autoconfigure.batch.JobLauncherCommandLineRunner.executeLocalJobs(JobLauncherCommandLineRunner.java:166) [spring-boot-autoconfigure-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">    at org.springframework.boot.autoconfigure.batch.JobLauncherCommandLineRunner.launchJobFromProperties(JobLauncherCommandLineRunner.java:153) [spring-boot-autoconfigure-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">    at org.springframework.boot.autoconfigure.batch.JobLauncherCommandLineRunner.run(JobLauncherCommandLineRunner.java:148) [spring-boot-autoconfigure-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">    at org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:784) [spring-boot-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">    at org.springframework.boot.SpringApplication.callRunners(SpringApplication.java:768) [spring-boot-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">    at org.springframework.boot.SpringApplication.run(SpringApplication.java:322) [spring-boot-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">    at org.springframework.boot.SpringApplication.run(SpringApplication.java:1226) [spring-boot-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">    at org.springframework.boot.SpringApplication.run(SpringApplication.java:1215) [spring-boot-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">    at cc.mrbird.batch.SpringBatchExceptionApplication.main(SpringBatchExceptionApplication.java:12) [classes/:na]</span><br><span class="line">Caused by: cc.mrbird.batch.exception.MyJobExecutionException: ä»»åŠ¡å¤„ç†å‡ºé”™</span><br><span class="line">    at cc.mrbird.batch.job.RetryExceptionJobDemo$1.process(RetryExceptionJobDemo.java:64) ~[classes/:na]</span><br><span class="line">    at cc.mrbird.batch.job.RetryExceptionJobDemo$1.process(RetryExceptionJobDemo.java:55) ~[classes/:na]</span><br><span class="line">    at org.springframework.batch.core.step.item.SimpleChunkProcessor.doProcess(SimpleChunkProcessor.java:134) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.batch.core.step.item.FaultTolerantChunkProcessor$1.doWithRetry(FaultTolerantChunkProcessor.java:233) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">    at org.springframework.retry.support.RetryTemplate.doExecute(RetryTemplate.java:287) ~[spring-retry-1.2.5.RELEASE.jar:na]</span><br><span class="line">    ... 43 common frames omitted</span><br><span class="line"></span><br><span class="line">2020-03-12 09:06:48.989  INFO 40610 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 56ms</span><br><span class="line">2020-03-12 09:06:49.019  INFO 40610 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=retryExceptionJob1]] completed with the following parameters: [&#123;&#125;] and the following status: [FAILED] in 152ms</span><br></pre></td></tr></table></figure><p></p><p>å¼‚å¸¸æ¬¡æ•°è¶…è¿‡äº†é‡è¯•æ¬¡æ•°ï¼Œæ‰€ä»¥æŠ›å‡ºäº†å¼‚å¸¸ã€‚</p><h2 id="å¼‚å¸¸è·³è¿‡"><a href="#å¼‚å¸¸è·³è¿‡" class="headerlink" title="å¼‚å¸¸è·³è¿‡"></a>å¼‚å¸¸è·³è¿‡</h2><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨Stepä¸­é…ç½®å¼‚å¸¸è·³è¿‡ï¼Œå³é‡åˆ°æŒ‡å®šç±»å‹å¼‚å¸¸æ—¶å¿½ç•¥è·³è¿‡å®ƒï¼Œåœ¨jobåŒ…ä¸‹æ–°å»º<code>SkipExceptionJobDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SkipExceptionJobDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">skipExceptionJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"skipExceptionJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;String, String&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(listItemReader())</span><br><span class="line">                .processor(myProcessor())</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .faultTolerant() <span class="comment">// é…ç½®é”™è¯¯å®¹å¿</span></span><br><span class="line">                .skip(MyJobExecutionException.class) <span class="comment">// é…ç½®è·³è¿‡çš„å¼‚å¸¸ç±»å‹</span></span><br><span class="line">                .skipLimit(<span class="number">1</span>) <span class="comment">// æœ€å¤šè·³è¿‡1æ¬¡ï¼Œ1æ¬¡è¿‡åè¿˜æ˜¯å¼‚å¸¸çš„è¯ï¼Œåˆ™ä»»åŠ¡ä¼šç»“æŸï¼Œ</span></span><br><span class="line">                <span class="comment">// å¼‚å¸¸çš„æ¬¡æ•°ä¸ºreaderï¼Œprocessorå’Œwriterä¸­çš„æ€»æ•°ï¼Œè¿™é‡Œä»…åœ¨processoré‡Œæ¼”ç¤ºå¼‚å¸¸è·³è¿‡</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ListItemReader&lt;String&gt; <span class="title">listItemReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;String&gt; datas = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">5</span>).forEach(i -&gt; datas.add(String.valueOf(i)));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ListItemReader&lt;&gt;(datas);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ItemProcessor&lt;String, String&gt; <span class="title">myProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> item -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"å½“å‰å¤„ç†çš„æ•°æ®ï¼š"</span> + item);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"2"</span>.equals(item)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> MyJobExecutionException(<span class="string">"ä»»åŠ¡å¤„ç†å‡ºé”™"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> item;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨<code>step()</code>æ–¹æ³•ä¸­ï¼Œ<code>faultTolerant()</code>è¡¨ç¤ºå¼€å¯å®¹é”™åŠŸèƒ½ï¼Œ<code>skip(MyJobExecutionException.class)</code>è¡¨ç¤ºé‡åˆ°<code>MyJobExecutionException</code>å¼‚å¸¸æ—¶è·³è¿‡ï¼Œ<code>skipLimit(1)</code>è¡¨ç¤ºåªè·³è¿‡ä¸€æ¬¡ã€‚</p><p><code>myProcessor()</code>çš„é€»è¾‘æ˜¯ï¼Œå½“å¤„ç†çš„itemå€¼ä¸ºâ€2â€œçš„æ—¶å€™ï¼ŒæŠ›å‡º<code>MyJobExecutionException(&quot;ä»»åŠ¡å¤„ç†å‡ºé”™&quot;)</code>å¼‚å¸¸ã€‚</p><p>æ­¤å¤–æˆ‘ä»¬è¿˜å¯ä»¥é…ç½®<code>SkipListener</code>ç±»å‹ç›‘å¬å™¨ï¼Œåœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºlisteneråŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>MySkipListener</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySkipListener</span> <span class="keyword">implements</span> <span class="title">SkipListener</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSkipInRead</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åœ¨è¯»å–æ•°æ®çš„æ—¶å€™é‡åˆ°å¼‚å¸¸å¹¶è·³è¿‡ï¼Œå¼‚å¸¸ï¼š"</span> + t.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSkipInWrite</span><span class="params">(String item, Throwable t)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åœ¨è¾“å‡ºæ•°æ®çš„æ—¶å€™é‡åˆ°å¼‚å¸¸å¹¶è·³è¿‡ï¼Œå¾…è¾“å‡ºæ•°æ®ï¼š"</span> + item + <span class="string">"ï¼Œå¼‚å¸¸ï¼š"</span> + t.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSkipInProcess</span><span class="params">(String item, Throwable t)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åœ¨å¤„ç†æ•°æ®çš„æ—¶å€™é‡åˆ°å¼‚å¸¸å¹¶è·³è¿‡ï¼Œå¾…è¾“å‡ºæ•°æ®ï¼š"</span> + item + <span class="string">"ï¼Œå¼‚å¸¸ï¼š"</span> + t.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åå°†å®ƒæ³¨å…¥åˆ°<code>SkipExceptionJobDemo</code>ï¼Œå¹¶é…ç½®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SkipExceptionJobDemo</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MySkipListener mySkipListener;</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;String, String&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(listItemReader())</span><br><span class="line">                .processor(myProcessor())</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .faultTolerant() <span class="comment">// é…ç½®é”™è¯¯å®¹å¿</span></span><br><span class="line">                .skip(MyJobExecutionException.class) <span class="comment">// é…ç½®è·³è¿‡çš„å¼‚å¸¸ç±»å‹</span></span><br><span class="line">                .skipLimit(<span class="number">1</span>) <span class="comment">// æœ€å¤šè·³è¿‡1æ¬¡ï¼Œ1æ¬¡è¿‡åè¿˜æ˜¯å¼‚å¸¸çš„è¯ï¼Œåˆ™ä»»åŠ¡ä¼šç»“æŸï¼Œ</span></span><br><span class="line">                <span class="comment">// å¼‚å¸¸çš„æ¬¡æ•°ä¸ºreaderï¼Œprocessorå’Œwriterä¸­çš„æ€»æ•°ï¼Œè¿™é‡Œä»…åœ¨processoré‡Œæ¼”ç¤ºå¼‚å¸¸è·³è¿‡</span></span><br><span class="line">                .listener(mySkipListener)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2020-03-12 09:23:33.528  INFO 40759 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=skipExceptionJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-12 09:23:33.664  INFO 40759 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š0</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š1</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š2</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š3</span><br><span class="line">3</span><br><span class="line">åœ¨å¤„ç†æ•°æ®çš„æ—¶å€™é‡åˆ°å¼‚å¸¸å¹¶è·³è¿‡ï¼Œå¾…è¾“å‡ºæ•°æ®ï¼š2ï¼Œå¼‚å¸¸ï¼šä»»åŠ¡å¤„ç†å‡ºé”™</span><br><span class="line">å½“å‰å¤„ç†çš„æ•°æ®ï¼š4</span><br><span class="line">4</span><br><span class="line">2020-03-12 09:23:33.854  INFO 40759 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 190ms</span><br><span class="line">2020-03-12 09:23:33.885  INFO 40759 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=skipExceptionJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 324ms</span><br></pre></td></tr></table></figure><p></p><h2 id="äº‹åŠ¡é—®é¢˜"><a href="#äº‹åŠ¡é—®é¢˜" class="headerlink" title="äº‹åŠ¡é—®é¢˜"></a>äº‹åŠ¡é—®é¢˜</h2><p>ä¸€æ¬¡Setpåˆ†ä¸ºReaderã€Processorå’ŒWriterä¸‰ä¸ªé˜¶æ®µï¼Œè¿™äº›é˜¶æ®µç»Ÿç§°ä¸ºItemã€‚é»˜è®¤æƒ…å†µä¸‹å¦‚æœé”™è¯¯ä¸æ˜¯å‘ç”Ÿåœ¨Readeré˜¶æ®µï¼Œé‚£ä¹ˆæ²¡å¿…è¦å†å»é‡æ–°è¯»å–ä¸€æ¬¡æ•°æ®ã€‚ä½†æ˜¯æŸäº›åœºæ™¯ä¸‹éœ€è¦Readeréƒ¨åˆ†ä¹Ÿéœ€è¦é‡æ–°æ‰§è¡Œï¼Œæ¯”å¦‚Readeræ˜¯ä»ä¸€ä¸ªJMSé˜Ÿåˆ—ä¸­æ¶ˆè´¹æ¶ˆæ¯ï¼Œå½“å‘ç”Ÿå›æ»šçš„æ—¶å€™æ¶ˆæ¯ä¹Ÿä¼šåœ¨é˜Ÿåˆ—ä¸Šé‡æ”¾ï¼Œå› æ­¤ä¹Ÿè¦å°†Readerçº³å…¥åˆ°å›æ»šçš„äº‹ç‰©ä¸­ï¼Œæ ¹æ®è¿™ä¸ªåœºæ™¯å¯ä»¥ä½¿ç”¨<code>readerIsTransactionalQueue()</code>æ¥é…ç½®æ•°æ®é‡è¯»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">            .&lt;String, String&gt;chunk(<span class="number">2</span>)</span><br><span class="line">            .reader(listItemReader())</span><br><span class="line">            .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">            .readerIsTransactionalQueue() <span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—æ•°æ®é‡è¯»</span></span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬è¿˜å¯ä»¥åœ¨Stepä¸­æ‰‹åŠ¨é…ç½®äº‹åŠ¡å±æ€§ï¼Œäº‹ç‰©çš„å±æ€§åŒ…æ‹¬éš”ç¦»ç­‰çº§ï¼ˆisolationï¼‰ã€ä¼ æ’­æ–¹å¼ï¼ˆpropagationï¼‰ä»¥åŠè¿‡æœŸæ—¶é—´ï¼ˆtimeoutï¼‰ç­‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DefaultTransactionAttribute attribute = <span class="keyword">new</span> DefaultTransactionAttribute();</span><br><span class="line">    attribute.setPropagationBehavior(Propagation.REQUIRED.value());</span><br><span class="line">    attribute.setIsolationLevel(Isolation.DEFAULT.value());</span><br><span class="line">    attribute.setTimeout(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">            .&lt;String, String&gt;chunk(<span class="number">2</span>)</span><br><span class="line">            .reader(listItemReader())</span><br><span class="line">            .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">            .transactionAttribute(attribute)</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="é‡å¯æœºåˆ¶"><a href="#é‡å¯æœºåˆ¶" class="headerlink" title="é‡å¯æœºåˆ¶"></a>é‡å¯æœºåˆ¶</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»åŠ¡æ‰§è¡Œå®Œæ¯•çš„çŠ¶æ€ä¸º<code>COMPLETED</code>ï¼Œå†æ¬¡å¯åŠ¨é¡¹ç›®ï¼Œè¯¥ä»»åŠ¡çš„Stepä¸ä¼šå†æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®<code>allowStartIfComplete(true)</code>æ¥å®ç°æ¯æ¬¡é¡¹ç›®é‡æ–°å¯åŠ¨éƒ½å°†æ‰§è¡Œè¿™ä¸ªStepï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">            .&lt;String, String&gt;chunk(<span class="number">2</span>)</span><br><span class="line">            .reader(listItemReader())</span><br><span class="line">            .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">            .allowStartIfComplete(<span class="keyword">true</span>)</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æŸäº›Stepå¯èƒ½ç”¨äºå¤„ç†ä¸€äº›å…ˆå†³çš„ä»»åŠ¡ï¼Œæ‰€ä»¥å½“Jobå†æ¬¡é‡å¯æ—¶è¿™Stepå°±æ²¡å¿…è¦å†æ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡è®¾ç½®<code>startLimit()</code>æ¥é™å®šæŸä¸ªStepé‡å¯çš„æ¬¡æ•°ã€‚å½“è®¾ç½®ä¸º1æ—¶å€™è¡¨ç¤ºä»…ä»…è¿è¡Œä¸€æ¬¡ï¼Œè€Œå‡ºç°é‡å¯æ—¶å°†ä¸å†æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">            .&lt;String, String&gt;chunk(<span class="number">2</span>)</span><br><span class="line">            .reader(listItemReader())</span><br><span class="line">            .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">            .startLimit(<span class="number">1</span>)</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>éƒ¨åˆ†å†…å®¹å‚è€ƒè‡ªï¼š<a href="https://blog.csdn.net/sswltt/article/details/103817645" target="_blank" rel="noopener">https://blog.csdn.net/sswltt/article/details/103817645</a></p><blockquote><p>æœ¬ç« æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/72.spring-batch-exception" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/72.spring-batch-exception</a>ã€‚</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Spring Batchå¤„ç†ä»»åŠ¡è¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿäº†å¼‚å¸¸ï¼Œé»˜è®¤æœºåˆ¶æ˜¯é©¬ä¸Šåœæ­¢ä»»åŠ¡æ‰§è¡Œï¼ŒæŠ›å‡ºç›¸åº”å¼‚å¸¸ï¼Œå¦‚æœä»»åŠ¡è¿˜åŒ…å«æœªæ‰§è¡Œçš„æ­¥éª¤ä¹Ÿä¸ä¼šè¢«æ‰§è¡Œã€‚è¦æ”¹å˜è¿™ä¸ªé»˜è®¤è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®å¼‚å¸¸é‡è¯•å’Œå¼‚å¸¸è·³è¿‡æœºåˆ¶ã€‚&lt;strong&gt;å¼‚å¸¸è·³è¿‡&lt;/strong&gt;ï¼šé‡åˆ°å¼‚å¸¸çš„æ—¶å€™ä¸å¸Œæœ›ç»“æŸä»»åŠ¡ï¼Œè€Œæ˜¯è·³è¿‡è¿™ä¸ªå¼‚å¸¸ï¼Œç»§ç»­æ‰§è¡Œï¼›&lt;strong&gt;å¼‚å¸¸é‡è¯•&lt;/strong&gt;ï¼šé‡åˆ°å¼‚å¸¸çš„æ—¶å€™ç»è¿‡æŒ‡å®šæ¬¡æ•°çš„é‡è¯•ï¼Œå¦‚æœè¿˜æ˜¯å¤±è´¥çš„è¯ï¼Œæ‰ä¼šåœæ­¢ä»»åŠ¡ã€‚é™¤äº†è¿™ä¸¤ä¸ªç‰¹æ€§å¤–ï¼Œæœ¬æ–‡ä¹Ÿä¼šè®°å½•ä¸€äº›åˆ«çš„ç‰¹æ€§ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
      <category term="Spring Batch" scheme="http://mrbird.cc/tags/Spring-Batch/"/>
    
  </entry>
  
  <entry>
    <title>Spring Batchä»»åŠ¡è°ƒåº¦</title>
    <link href="http://mrbird.cc/Spring-Batch%E4%BD%9C%E4%B8%9A%E8%B0%83%E5%BA%A6.html"/>
    <id>http://mrbird.cc/Spring-Batchä½œä¸šè°ƒåº¦.html</id>
    <published>2020-03-12T03:49:46.000Z</published>
    <updated>2020-03-12T07:56:44.252Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p>åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é…ç½®çš„ä»»åŠ¡éƒ½æ˜¯åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™è‡ªåŠ¨è¿è¡Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡<code>JobLauncher</code>æˆ–è€…<code>JobOperator</code>æ‰‹åŠ¨æ§åˆ¶ä»»åŠ¡çš„è¿è¡Œæ—¶æœºï¼Œè¿™èŠ‚è®°å½•ä¸‹å®ƒä»¬çš„ç”¨æ³•ã€‚</p><a id="more"></a><h2 id="æ¡†æ¶æ­å»º"><a href="#æ¡†æ¶æ­å»º" class="headerlink" title="æ¡†æ¶æ­å»º"></a>æ¡†æ¶æ­å»º</h2><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º2.2.4.RELEASEï¼ŒartifactIdä¸ºspring-batch-launcherï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200312-095759@2x.png" alt="QQ20200312-095759@2x"></p><p>å‰©ä¸‹çš„æ•°æ®åº“å±‚çš„å‡†å¤‡ï¼Œé¡¹ç›®é…ç½®ï¼Œä¾èµ–å¼•å…¥å’Œ<a href="/Spring-Batchå…¥é—¨.html">Spring Batchå…¥é—¨</a>æ–‡ç« ä¸­çš„æ¡†æ¶æ­å»ºæ­¥éª¤ä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚</p><p>æ­¤å¤–ï¼Œæœ¬èŠ‚æˆ‘ä»¬éœ€è¦æ¼”ç¤ºåœ¨Controlleré‡Œé€šè¿‡<code>JobLauncher</code>æˆ–è€…<code>JobOperator</code>è°ƒåº¦ä»»åŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€åœ¨pomé‡Œå¼•å…¥webä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>ç„¶åå‡†å¤‡ä¸ªä»»åŠ¡ï¼Œç”¨äºåç»­æµ‹è¯•ã€‚åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºjobåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>MyJob</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJob</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">job</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"job"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    StepExecution stepExecution = chunkContext.getStepContext().getStepExecution();</span><br><span class="line">                    Map&lt;String, JobParameter&gt; parameters = stepExecution.getJobParameters().getParameters();</span><br><span class="line">                    System.out.println(parameters.get(<span class="string">"message"</span>).getValue());</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;)</span><br><span class="line">                .listener(<span class="keyword">this</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨<code>step()</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡æ‰§è¡Œä¸Šä¸‹æ–‡è·å–äº†keyä¸º<code>message</code>çš„å‚æ•°å€¼ã€‚</p><h2 id="JobLauncher"><a href="#JobLauncher" class="headerlink" title="JobLauncher"></a>JobLauncher</h2><p>åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºcontrolleråŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>JobController</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"job"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Job job;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobLauncher jobLauncher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"launcher/&#123;message&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">launcher</span><span class="params">(@PathVariable String message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        JobParameters parameters = <span class="keyword">new</span> JobParametersBuilder()</span><br><span class="line">                .addString(<span class="string">"message"</span>, message)</span><br><span class="line">                .toJobParameters();</span><br><span class="line">        <span class="comment">// å°†å‚æ•°ä¼ é€’ç»™ä»»åŠ¡</span></span><br><span class="line">        jobLauncher.run(job, parameters);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ³¨å…¥äº†<code>JobLauncher</code>å’Œä¸Šé¢é…ç½®çš„<code>Job</code>ï¼Œç„¶åé€šè¿‡<code>JobLauncher</code>çš„<code>run(Job job, JobParameters jobParameters)</code>æ–¹æ³•è¿è¡ŒæŒ‡å®šçš„ä»»åŠ¡Jobï¼Œå¹¶ä¸”ä¼ é€’äº†å‚æ•°ã€‚</p><p>è¦å…³é—­Spring Batchå¯åŠ¨é¡¹ç›®è‡ªåŠ¨è¿è¡Œä»»åŠ¡çš„æœºåˆ¶ï¼Œéœ€è¦åœ¨é¡¹ç›®é…ç½®æ–‡ä»¶application.ymlä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  batch:</span></span><br><span class="line"><span class="attr">    job:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨é¡¹ç›®ï¼Œåœ¨æµè§ˆå™¨åœ°å€æ è®¿é—®ï¼š<a href="http://localhost:8080/job/launcher/hello" target="_blank" rel="noopener">http://localhost:8080/job/launcher/hello</a>ï¼š</p><p><img src="img/QQ20200312-102457@2x.png" alt="QQ20200312-102457@2x"></p><p>é¡¹ç›®æ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2020-03-12 10:24:31.547  INFO 41266 --- [nio-8080-exec-4] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=job]] launched with the following parameters: [&#123;message=hello&#125;]</span><br><span class="line">2020-03-12 10:24:31.583  INFO 41266 --- [nio-8080-exec-4] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">hello</span><br><span class="line">2020-03-12 10:24:31.610  INFO 41266 --- [nio-8080-exec-4] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 27ms</span><br><span class="line">2020-03-12 10:24:31.632  INFO 41266 --- [nio-8080-exec-4] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=job]] completed with the following parameters: [&#123;message=hello&#125;] and the following status: [COMPLETED] in 76ms</span><br></pre></td></tr></table></figure><p></p><p>æ­¤å¤–ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šåŒæ ·çš„å‚æ•°ï¼ŒåŒæ ·çš„ä»»åŠ¡å†æ¬¡è¿è¡Œçš„æ—¶å€™å°†æŠ›å‡º<code>JobInstanceAlreadyCompleteException</code>å¼‚å¸¸ï¼Œæ¯”å¦‚åœ¨æµè§ˆå™¨ä¸­å†æ¬¡è®¿é—®<a href="http://localhost:8080/job/launcher/hello" target="_blank" rel="noopener">http://localhost:8080/job/launcher/hello</a>ï¼Œé¡¹ç›®æ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.batch.core.repository.JobInstanceAlreadyCompleteException: A job instance already exists and is complete for parameters=&#123;message=hello&#125;.  If you want to run this job again, change the parameters.</span><br><span class="line">	at org.springframework.batch.core.repository.support.SimpleJobRepository.createJobExecution(SimpleJobRepository.java:131) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_231]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_231]</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_231]</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_231]</span><br><span class="line">	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:344) ~[spring-aop-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">	...</span><br></pre></td></tr></table></figure><p></p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨ä»»åŠ¡è°ƒåº¦çš„æ—¶å€™ï¼Œåº”é¿å…å‚æ•°é‡å¤ã€‚</p><h2 id="JobOperator"><a href="#JobOperator" class="headerlink" title="JobOperator"></a>JobOperator</h2><p>åœ¨<code>JobController</code>é‡Œæ·»åŠ ä¸€ä¸ªæ–°çš„ç«¯ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"job"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobOperator jobOperator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"operator/&#123;message&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">operator</span><span class="params">(@PathVariable String message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// ä¼ é€’ä»»åŠ¡åç§°ï¼Œå‚æ•°ä½¿ç”¨ kvæ–¹å¼</span></span><br><span class="line">        jobOperator.start(<span class="string">"job"</span>, <span class="string">"message="</span> + message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ³¨å…¥äº†<code>JobOperator</code>ï¼Œ<code>JobOperator</code>çš„<code>start(String jobName, String parameters)</code>æ–¹æ³•ä¼ å…¥çš„æ˜¯ä»»åŠ¡çš„åç§°ï¼ˆä»»åŠ¡åœ¨Spring IOCå®¹å™¨ä¸­çš„åç§°ï¼‰,å¹¶ä¸”å‚æ•°ä½¿ç”¨key-valueçš„æ–¹å¼ä¼ é€’ã€‚</p><p>è¦é€šè¿‡ä»»åŠ¡åç§°è·å–åˆ°ç›¸åº”çš„Beanï¼Œè¿˜éœ€è¦æ·»åŠ ä¸€ä¸ªé¢å¤–çš„é…ç½®ã€‚åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºconfigureåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>JobConfigure</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobConfigure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨å†ŒJobRegistryBeanPostProcessor bean</span></span><br><span class="line"><span class="comment">     * ç”¨äºå°†ä»»åŠ¡åç§°å’Œå®é™…çš„ä»»åŠ¡å…³è”èµ·æ¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobRegistryBeanPostProcessor <span class="title">processor</span><span class="params">(JobRegistry jobRegistry, ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        JobRegistryBeanPostProcessor postProcessor = <span class="keyword">new</span> JobRegistryBeanPostProcessor();</span><br><span class="line">        postProcessor.setJobRegistry(jobRegistry);</span><br><span class="line">        postProcessor.setBeanFactory(applicationContext.getAutowireCapableBeanFactory());</span><br><span class="line">        <span class="keyword">return</span> postProcessor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¦‚æœæ²¡æœ‰è¿™æ®µé…ç½®ï¼Œåœ¨ä»»åŠ¡è°ƒåº¦çš„æ—¶å€™å°†æŠ¥<span style="color:red">org.springframework.batch.core.launch.NoSuchJobException: No job configuration with the name [job] was registered</span>ã€‚</p><p>å¯åŠ¨ä»»åŠ¡ï¼Œæµè§ˆå™¨è®¿é—®ï¼š<a href="http://localhost:8080/job/operator/mrbird" target="_blank" rel="noopener">http://localhost:8080/job/operator/mrbird</a>ï¼š</p><p><img src="img/QQ20200312-105134@2x.png" alt="QQ20200312-105134@2x"></p><p>é¡¹ç›®æ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2020-03-12 10:51:20.174  INFO 41405 --- [nio-8080-exec-2] o.s.b.c.l.support.SimpleJobOperator      : Checking status of job with name=job</span><br><span class="line">2020-03-12 10:51:20.183  INFO 41405 --- [nio-8080-exec-2] o.s.b.c.l.support.SimpleJobOperator      : Attempting to launch job with name=job and parameters=message=mrbird</span><br><span class="line">2020-03-12 10:51:20.239  INFO 41405 --- [nio-8080-exec-2] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=job]] launched with the following parameters: [&#123;message=mrbird&#125;]</span><br><span class="line">2020-03-12 10:51:20.293  INFO 41405 --- [nio-8080-exec-2] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">mrbird</span><br><span class="line">2020-03-12 10:51:20.324  INFO 41405 --- [nio-8080-exec-2] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 31ms</span><br><span class="line">2020-03-12 10:51:20.344  INFO 41405 --- [nio-8080-exec-2] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=job]] completed with the following parameters: [&#123;message=mrbird&#125;] and the following status: [COMPLETED] in 83ms</span><br></pre></td></tr></table></figure><p></p><p><code>JobOperator</code>åŒ…å«äº†è®¸å¤šå®ç”¨çš„æ–¹æ³•ï¼š</p><p><img src="img/QQ20200312-105318@2x.png" alt="QQ20200312-105318@2x"></p><p>å…·ä½“å¯ä»¥è‡ªå·±å°è¯•ç©ä¸€ç©ã€‚</p><blockquote><p>æœ¬èŠ‚æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/73.spring-batch-launcher" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/73.spring-batch-launcher</a>ã€‚</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é…ç½®çš„ä»»åŠ¡éƒ½æ˜¯åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™è‡ªåŠ¨è¿è¡Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡&lt;code&gt;JobLauncher&lt;/code&gt;æˆ–è€…&lt;code&gt;JobOperator&lt;/code&gt;æ‰‹åŠ¨æ§åˆ¶ä»»åŠ¡çš„è¿è¡Œæ—¶æœºï¼Œè¿™èŠ‚è®°å½•ä¸‹å®ƒä»¬çš„ç”¨æ³•ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
      <category term="Spring Batch" scheme="http://mrbird.cc/tags/Spring-Batch/"/>
    
  </entry>
  
  <entry>
    <title>Spring Batchç›‘å¬å™¨</title>
    <link href="http://mrbird.cc/Spring-Batch%E7%9B%91%E5%90%AC%E5%99%A8.html"/>
    <id>http://mrbird.cc/Spring-Batchç›‘å¬å™¨.html</id>
    <published>2020-03-09T03:55:27.000Z</published>
    <updated>2020-03-12T03:34:45.802Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p>Spring Batchæä¾›äº†å¤šç§ç›‘å¬å™¨Listenerï¼Œç”¨äºåœ¨ä»»åŠ¡å¤„ç†è¿‡ç¨‹ä¸­è§¦å‘æˆ‘ä»¬çš„é€»è¾‘ä»£ç ã€‚å¸¸ç”¨çš„ç›‘å¬å™¨æ ¹æ®ç²’åº¦ä»ç²—åˆ°ç»†åˆ†åˆ«æœ‰ï¼šJobçº§åˆ«çš„ç›‘å¬å™¨<code>JobExecutionListener</code>ã€Stepçº§åˆ«çš„ç›‘å¬å™¨<code>StepExecutionListener</code>ã€Chunkç›‘å¬å™¨<code>ChunkListener</code>ã€ItemReaderç›‘å¬å™¨<code>ItemReadListener</code>ã€ItemWriterç›‘å¬å™¨<code>ItemWriteListener</code>å’ŒItemProcessorç›‘å¬å™¨<code>ItemProcessListener</code>ç­‰ã€‚å…·ä½“å¯ä»¥å‚è€ƒä¸‹è¡¨ï¼š</p><a id="more"></a><table><tr><th>ç›‘å¬å™¨</th><th>å…·ä½“è¯´æ˜</th></tr><tr><td>JobExecutionListener</td><td>åœ¨Jobå¼€å§‹ä¹‹å‰(beforeJob)å’Œä¹‹å(aflerJob)è§¦å‘</td></tr><tr><td>StepExecutionListener</td><td>åœ¨Stepå¼€å§‹ä¹‹å‰(beforeStep)å’Œä¹‹å(afterStep)è§¦å‘</td></tr><tr><td>ChunkListener</td><td>åœ¨ Chunk å¼€å§‹ä¹‹å‰(beforeChunk),ä¹‹å(afterChunk)å’Œé”™è¯¯å(afterChunkError)è§¦å‘</td></tr><tr><td>ItemReadListener</td><td>åœ¨ Read å¼€å§‹ä¹‹å‰(beforeRead&gt;,ä¹‹å(afterRead)å’Œé”™è¯¯å(onReadError)è§¦å‘</td></tr><tr><td>ItemProcessListener</td><td>åœ¨ Processor å¼€å§‹ä¹‹å‰(beforeProcess),ä¹‹å(afterProcess)å’Œé”™è¯¯å(onProcessError)è§¦å‘</td></tr><tr><td>ItemWriterListener</td><td>åœ¨ Writer å¼€å§‹ä¹‹å‰(beforeWrite),ä¹‹å(afterWrite)å’Œé”™è¯¯å(onWriteError)è§¦å‘</td></tr></table><h2 id="æ¡†æ¶æ­å»º"><a href="#æ¡†æ¶æ­å»º" class="headerlink" title="æ¡†æ¶æ­å»º"></a>æ¡†æ¶æ­å»º</h2><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º2.2.4.RELEASEï¼ŒartifactIdä¸ºspring-batch-listenerï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200309-160923@2x.png" alt="QQ20200309-160923@2x"></p><p>å‰©ä¸‹çš„æ•°æ®åº“å±‚çš„å‡†å¤‡ï¼Œé¡¹ç›®é…ç½®ï¼Œä¾èµ–å¼•å…¥å’Œ<a href="/Spring-Batchå…¥é—¨.html">Spring Batchå…¥é—¨</a>æ–‡ç« ä¸­çš„æ¡†æ¶æ­å»ºæ­¥éª¤ä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚</p><h2 id="ç›‘å¬å™¨æ¼”ç¤º"><a href="#ç›‘å¬å™¨æ¼”ç¤º" class="headerlink" title="ç›‘å¬å™¨æ¼”ç¤º"></a>ç›‘å¬å™¨æ¼”ç¤º</h2><p>æ¯ç§ç›‘å¬å™¨éƒ½å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼ä½¿ç”¨ï¼š</p><ol><li>æ¥å£å®ç°ï¼›</li><li>æ³¨è§£é©±åŠ¨ã€‚</li></ol><p>å…ˆæ¥çœ‹çœ‹é€šè¿‡å®ç°æ¥å£çš„æ–¹å¼ä½¿ç”¨ç›‘å¬å™¨ã€‚åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºlisteneråŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>MyJobExecutionListener</code>ï¼Œå®ç°<code>JobExecutionListener</code>æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJobExecutionListener</span> <span class="keyword">implements</span> <span class="title">JobExecutionListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeJob</span><span class="params">(JobExecution jobExecution)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before job execute: "</span> + jobExecution.getJobInstance().getJobName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterJob</span><span class="params">(JobExecution jobExecution)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"after job execute: "</span> + jobExecution.getJobInstance().getJobName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢å®ç°çš„ä¸¤ä¸ªæ–¹æ³•å¾ˆç›´è§‚äº†ï¼Œè§¦å‘æ—¶æœºåˆ†åˆ«ä¸ºä»»åŠ¡æ‰§è¡Œå‰å’Œä»»åŠ¡æ‰§è¡Œåã€‚</p><p>æ¥ç€çœ‹çœ‹å¦‚ä½•ä½¿ç”¨æ³¨è§£é©±åŠ¨ä½¿ç”¨ç›‘å¬å™¨ã€‚åœ¨listeneråŒ…ä¸‹æ–°å»º<code>MyStepExecutionListener</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyStepExecutionListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeStep</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">breforeStep</span><span class="params">(StepExecution stepExecution)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before step execute: "</span> + stepExecution.getStepName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterStep</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterStep</span><span class="params">(StepExecution stepExecution)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"after step execute: "</span> + stepExecution.getStepName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡æ³¨è§£çš„æ–¹å¼ä¸éœ€è¦å®ç°æ¥å£ï¼Œè€Œæ˜¯åœ¨å¯¹åº”çš„æ–¹æ³•ä¸Šé€šè¿‡è¯¸å¦‚<code>@BeforeStep</code>ã€<code>@AfterStep</code>ç­‰æ³¨è§£æ ‡æ³¨å³å¯ï¼Œä¸è¿‡æ–¹æ³•çš„ç­¾åå¿…é¡»ç¬¦åˆæ³¨è§£çš„è¦æ±‚ï¼Œå¦åˆ™ä¼šåå°„å¤±è´¥ã€‚æ¯”å¦‚ï¼ŒæŸ¥çœ‹<code>@BeforeStep</code>çš„æºç ï¼š</p><p><img src="img/QQ20200309-162830@2x.png" alt="QQ20200309-162830@2x"></p><p>ç›‘å¬å™¨çš„åˆ›å»ºå¤§è‡´å°±è¿™ä¸¤ç§å§¿åŠ¿äº†ï¼Œä¸‹é¢çš„ä¾‹å­ä¸åœ¨è¯¦ç»†è¯´æ˜ï¼Œç›´æ¥è´´ä»£ç ã€‚</p><p>åœ¨listeneråŒ…ä¸‹ç»§ç»­åˆ›å»º<code>MyChunkListener</code>ã€<code>MyItemReaderListener</code>ã€<code>MyItemProcessListener</code>å’Œ<code>MyItemWriterListener</code>ã€‚</p><p><code>MyChunkListener</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyChunkListener</span> <span class="keyword">implements</span> <span class="title">ChunkListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeChunk</span><span class="params">(ChunkContext context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before chunk: "</span> + context.getStepContext().getStepName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterChunk</span><span class="params">(ChunkContext context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"after chunk: "</span> + context.getStepContext().getStepName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterChunkError</span><span class="params">(ChunkContext context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before chunk error: "</span> + context.getStepContext().getStepName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>MyItemReaderListener</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyItemReaderListener</span> <span class="keyword">implements</span> <span class="title">ItemReadListener</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeRead</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before read"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterRead</span><span class="params">(String item)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"after read: "</span> + item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReadError</span><span class="params">(Exception ex)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"on read error: "</span> + ex.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>MyItemProcessListener</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyItemProcessListener</span> <span class="keyword">implements</span> <span class="title">ItemProcessListener</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeProcess</span><span class="params">(String item)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before process: "</span> + item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterProcess</span><span class="params">(String item, String result)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"after process: "</span> + item + <span class="string">" result: "</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onProcessError</span><span class="params">(String item, Exception e)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"on process error: "</span> + item + <span class="string">" , error message: "</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>MyItemWriterListener</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyItemWriterListener</span> <span class="keyword">implements</span> <span class="title">ItemWriteListener</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeWrite</span><span class="params">(List&lt;? extends String&gt; items)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before write: "</span> + items);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterWrite</span><span class="params">(List&lt;? extends String&gt; items)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"after write: "</span> + items);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWriteError</span><span class="params">(Exception exception, List&lt;? extends String&gt; items)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"on write error: "</span> + items + <span class="string">" , error message: "</span> + exception.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å‡†å¤‡å¥½è¿™äº›ç›‘å¬å™¨åï¼Œæˆ‘ä»¬åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºjobåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>ListenerTestJobDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListenerTestJobDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyJobExecutionListener myJobExecutionListener;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyStepExecutionListener myStepExecutionListener;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyChunkListener myChunkListener;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyItemReaderListener myItemReaderListener;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyItemProcessListener myItemProcessListener;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyItemWriterListener myItemWriterListener;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">listenerTestJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"listenerTestJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .listener(myJobExecutionListener)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .listener(myStepExecutionListener)</span><br><span class="line">                .&lt;String, String&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .faultTolerant()</span><br><span class="line">                .listener(myChunkListener)</span><br><span class="line">                .reader(reader())</span><br><span class="line">                .listener(myItemReaderListener)</span><br><span class="line">                .processor(processor())</span><br><span class="line">                .listener(myItemProcessListener)</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .listener(myItemWriterListener)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ItemReader&lt;String&gt; <span class="title">reader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; data = Arrays.asList(<span class="string">"java"</span>, <span class="string">"c++"</span>, <span class="string">"javascript"</span>, <span class="string">"python"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> simpleReader(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ItemProcessor&lt;String, String&gt; <span class="title">processor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> item -&gt; item + <span class="string">" language"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">simpleReader</span> <span class="keyword">implements</span> <span class="title">ItemReader</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Iterator&lt;String&gt; iterator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">simpleReader</span><span class="params">(List&lt;String&gt; data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iterator = data.iterator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> iterator.hasNext() ? iterator.next() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç æˆ‘ä»¬åœ¨ç›¸åº”çš„ä½ç½®é…ç½®äº†ç›‘å¬å™¨ï¼ˆé…ç½®chunkç›‘å¬å™¨çš„æ—¶å€™ï¼Œå¿…é¡»é…ç½®<code>faultTolerant()</code>ï¼‰ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">2020-03-09 17:08:34.439  INFO 20165 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=listenerTestJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">before job execute: listenerTestJob3</span><br><span class="line">2020-03-09 17:08:34.495  INFO 20165 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">before step execute: step</span><br><span class="line">before chunk: step</span><br><span class="line">before read</span><br><span class="line">after read: java</span><br><span class="line">before read</span><br><span class="line">after read: c++</span><br><span class="line">before process: java</span><br><span class="line">after process: java result: java language</span><br><span class="line">before process: c++</span><br><span class="line">after process: c++ result: c++ language</span><br><span class="line">before write: [java language, c++ language]</span><br><span class="line">java language</span><br><span class="line">c++ language</span><br><span class="line">after write: [java language, c++ language]</span><br><span class="line">after chunk: step</span><br><span class="line">before chunk: step</span><br><span class="line">before read</span><br><span class="line">after read: javascript</span><br><span class="line">before read</span><br><span class="line">after read: python</span><br><span class="line">before process: javascript</span><br><span class="line">after process: javascript result: javascript language</span><br><span class="line">before process: python</span><br><span class="line">after process: python result: python language</span><br><span class="line">before write: [javascript language, python language]</span><br><span class="line">javascript language</span><br><span class="line">python language</span><br><span class="line">after write: [javascript language, python language]</span><br><span class="line">after chunk: step</span><br><span class="line">before chunk: step</span><br><span class="line">before read</span><br><span class="line">after chunk: step</span><br><span class="line">after step execute: step</span><br><span class="line">2020-03-09 17:08:34.546  INFO 20165 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 51ms</span><br><span class="line">after job execute: listenerTestJob3</span><br><span class="line">2020-03-09 17:08:34.566  INFO 20165 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=listenerTestJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 105ms</span><br></pre></td></tr></table></figure><p></p><p>ä»ä¸Šé¢çš„è¿è¡Œç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š</p><ol><li><p>è¯å®äº†<code>chunk(2)</code>è¡¨ç¤ºæ¯ä¸€æ‰¹å¤„ç†2ä¸ªæ•°æ®å—ï¼›</p></li><li><p>Stepé‡Œçš„æ‰§è¡Œé¡ºåºæ˜¯read -&gt; process -&gt; writerã€‚</p></li></ol><h2 id="èšåˆç›‘å¬å™¨"><a href="#èšåˆç›‘å¬å™¨" class="headerlink" title="èšåˆç›‘å¬å™¨"></a>èšåˆç›‘å¬å™¨</h2><p>æ¯ç§ç›‘å¬å™¨å¯ä»¥é€šè¿‡å¯¹åº”çš„èšåˆç±»ç»„åˆåœ¨ä¸€èµ·ï¼Œæ¯”å¦‚æœ‰å¤šä¸ª<code>JobExecutionListener</code>ï¼Œåˆ™å¯ä»¥ä½¿ç”¨<code>CompositeJobExecutionListener</code>èšåˆå®ƒä»¬ã€‚ä¸Šé¢ä»‹ç»çš„è¿™å‡ ç§ç›‘å¬å™¨éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„<code>CompositeXXXListener</code>èšåˆç±»ï¼Œè¿™é‡Œåªæ¼”ç¤º<code>CompositeJobExecutionListener</code>ï¼Œå‰©ä¸‹çš„ä»¥æ­¤ç±»æ¨ã€‚</p><p>åœ¨jobåŒ…ä¸‹æ–°å»º<code>CompositeJobExecutionListenerJobDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompositeJobExecutionListenerJobDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">compositeJobExecutionListenerJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"compositeJobExecutionListenerJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .listener(compositeJobExecutionListener())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .tasklet((contribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤...."</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CompositeJobExecutionListener <span class="title">compositeJobExecutionListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CompositeJobExecutionListener listener = <span class="keyword">new</span> CompositeJobExecutionListener();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»»åŠ¡ç›‘å¬å™¨1</span></span><br><span class="line">        JobExecutionListener jobExecutionListenerOne = <span class="keyword">new</span> JobExecutionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeJob</span><span class="params">(JobExecution jobExecution)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"ä»»åŠ¡ç›‘å¬å™¨Oneï¼Œbefore job execute: "</span> + jobExecution.getJobInstance().getJobName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterJob</span><span class="params">(JobExecution jobExecution)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"ä»»åŠ¡ç›‘å¬å™¨Oneï¼Œafter job execute: "</span> + jobExecution.getJobInstance().getJobName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// ä»»åŠ¡ç›‘å¬å™¨2</span></span><br><span class="line">        JobExecutionListener jobExecutionListenerTwo = <span class="keyword">new</span> JobExecutionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeJob</span><span class="params">(JobExecution jobExecution)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"ä»»åŠ¡ç›‘å¬å™¨Twoï¼Œbefore job execute: "</span> + jobExecution.getJobInstance().getJobName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterJob</span><span class="params">(JobExecution jobExecution)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"ä»»åŠ¡ç›‘å¬å™¨Twoï¼Œafter job execute: "</span> + jobExecution.getJobInstance().getJobName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// èšåˆ</span></span><br><span class="line">        listener.setListeners(Arrays.asList(jobExecutionListenerOne, jobExecutionListenerTwo));</span><br><span class="line">        <span class="keyword">return</span> listener;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2020-03-09 17:26:47.533  INFO 20310 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=compositeJobExecutionListenerJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">ä»»åŠ¡ç›‘å¬å™¨Oneï¼Œbefore job execute: compositeJobExecutionListenerJob</span><br><span class="line">ä»»åŠ¡ç›‘å¬å™¨Twoï¼Œbefore job execute: compositeJobExecutionListenerJob</span><br><span class="line">2020-03-09 17:26:47.603  INFO 20310 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤....</span><br><span class="line">2020-03-09 17:26:47.660  INFO 20310 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 57ms</span><br><span class="line">ä»»åŠ¡ç›‘å¬å™¨Twoï¼Œafter job execute: compositeJobExecutionListenerJob</span><br><span class="line">ä»»åŠ¡ç›‘å¬å™¨Oneï¼Œafter job execute: compositeJobExecutionListenerJob</span><br><span class="line">2020-03-09 17:26:47.693  INFO 20310 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=compositeJobExecutionListenerJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 129ms</span><br></pre></td></tr></table></figure><p></p><p>é™¤äº†æœ¬æ–‡ä»‹ç»çš„è¿™å‡ ä¸ªç›‘å¬å™¨å¤–ï¼Œè¿˜æœ‰ä¸€äº›å’Œå¼‚å¸¸å¤„ç†ç›¸å…³çš„ç›‘å¬å™¨ï¼Œä¼šåœ¨åç»­çš„æ–‡ç« ä¸­æåˆ°ã€‚</p><blockquote><p>æœ¬æ–‡æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/71.spring-batch-listener" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/71.spring-batch-listener</a>ã€‚</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Spring Batchæä¾›äº†å¤šç§ç›‘å¬å™¨Listenerï¼Œç”¨äºåœ¨ä»»åŠ¡å¤„ç†è¿‡ç¨‹ä¸­è§¦å‘æˆ‘ä»¬çš„é€»è¾‘ä»£ç ã€‚å¸¸ç”¨çš„ç›‘å¬å™¨æ ¹æ®ç²’åº¦ä»ç²—åˆ°ç»†åˆ†åˆ«æœ‰ï¼šJobçº§åˆ«çš„ç›‘å¬å™¨&lt;code&gt;JobExecutionListener&lt;/code&gt;ã€Stepçº§åˆ«çš„ç›‘å¬å™¨&lt;code&gt;StepExecutionListener&lt;/code&gt;ã€Chunkç›‘å¬å™¨&lt;code&gt;ChunkListener&lt;/code&gt;ã€ItemReaderç›‘å¬å™¨&lt;code&gt;ItemReadListener&lt;/code&gt;ã€ItemWriterç›‘å¬å™¨&lt;code&gt;ItemWriteListener&lt;/code&gt;å’ŒItemProcessorç›‘å¬å™¨&lt;code&gt;ItemProcessListener&lt;/code&gt;ç­‰ã€‚å…·ä½“å¯ä»¥å‚è€ƒä¸‹è¡¨ï¼š&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
      <category term="Spring Batch" scheme="http://mrbird.cc/tags/Spring-Batch/"/>
    
  </entry>
  
  <entry>
    <title>Spring Batchå¤„ç†æ•°æ®</title>
    <link href="http://mrbird.cc/Spring-Batch%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE.html"/>
    <id>http://mrbird.cc/Spring-Batchå¤„ç†æ•°æ®.html</id>
    <published>2020-03-09T03:54:47.000Z</published>
    <updated>2020-03-12T03:34:22.630Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p>åœ¨Spring Batchä¸­ï¼Œ<code>ItemReader</code>æ¥å£ç”¨äºè¯»å–æ•°æ®ï¼Œ<code>ItemWriter</code>æ¥å£ç”¨äºè¾“å‡ºæ•°æ®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>ItemProcessor</code>æ¥å£å®ç°æ•°æ®çš„å¤„ç†ï¼ŒåŒ…æ‹¬ï¼šæ•°æ®æ ¡éªŒï¼Œæ•°æ®è¿‡æ»¤å’Œæ•°æ®è½¬æ¢ç­‰ã€‚æ•°æ®å¤„ç†çš„æ—¶æœºå‘ç”Ÿäº<code>ItemReader</code>è¯»å–æ•°æ®ä¹‹åï¼Œ<code>ItemWriter</code>è¾“å‡ºæ•°æ®ä¹‹å‰ã€‚æœ¬èŠ‚è®°å½•ä¸‹Spring Batchä¸­<code>ItemProcessor</code>çš„ä½¿ç”¨ã€‚</p><a id="more"></a><h2 id="æ¡†æ¶æ­å»º"><a href="#æ¡†æ¶æ­å»º" class="headerlink" title="æ¡†æ¶æ­å»º"></a>æ¡†æ¶æ­å»º</h2><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º2.2.4.RELEASEï¼ŒartifactIdä¸ºspring-batch-itemprocessorï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200309-135557@2x.png" alt="QQ20200309-135557@2x"></p><p>å‰©ä¸‹çš„æ•°æ®åº“å±‚çš„å‡†å¤‡ï¼Œé¡¹ç›®é…ç½®ï¼Œä¾èµ–å¼•å…¥å’Œ<a href="/Spring-Batchå…¥é—¨.html">Spring Batchå…¥é—¨</a>æ–‡ç« ä¸­çš„æ¡†æ¶æ­å»ºæ­¥éª¤ä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚</p><p>åœ¨ä»‹ç»Spring Batch ItemProcessorä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå‡†å¤‡ä¸ªç®€å•çš„æ•°æ®è¯»å–æºã€‚åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºentityåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>TestData</code>å®ä½“ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestData</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String field1;</span><br><span class="line">    <span class="keyword">private</span> String field2;</span><br><span class="line">    <span class="keyword">private</span> String field3;</span><br><span class="line">    <span class="comment">// get,set,toStringç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºreaderåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹åˆ›å»º<code>ItemReaderConfigure</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemReaderConfigure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListItemReader&lt;TestData&gt; <span class="title">simpleReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;TestData&gt; data = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        TestData testData1 = <span class="keyword">new</span> TestData();</span><br><span class="line">        testData1.setId(<span class="number">1</span>);</span><br><span class="line">        testData1.setField1(<span class="string">"11"</span>);</span><br><span class="line">        testData1.setField2(<span class="string">"12"</span>);</span><br><span class="line">        testData1.setField3(<span class="string">"13"</span>);</span><br><span class="line">        data.add(testData1);</span><br><span class="line">        TestData testData2 = <span class="keyword">new</span> TestData();</span><br><span class="line">        testData2.setId(<span class="number">2</span>);</span><br><span class="line">        testData2.setField1(<span class="string">"21"</span>);</span><br><span class="line">        testData2.setField2(<span class="string">"22"</span>);</span><br><span class="line">        testData2.setField3(<span class="string">"23"</span>);</span><br><span class="line">        data.add(testData2);</span><br><span class="line">        TestData testData3 = <span class="keyword">new</span> TestData();</span><br><span class="line">        testData3.setId(<span class="number">3</span>);</span><br><span class="line">        testData3.setField1(<span class="string">"31"</span>);</span><br><span class="line">        testData3.setField2(<span class="string">"32"</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œç”¨äºåé¢æ ¼å¼æ ¡éªŒæ¼”ç¤º</span></span><br><span class="line">        testData3.setField3(<span class="string">""</span>);</span><br><span class="line">        data.add(testData3);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ListItemReader&lt;&gt;(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢æ³¨å†Œäº†ä¸€ä¸ª<code>ItemReader</code>ç±»å‹çš„Beanï¼Œåç»­éƒ½ç”¨å®ƒä½œä¸ºè¯»å–æ•°æ®çš„æ¥æºã€‚</p><h2 id="æ ¼å¼æ ¡éªŒ"><a href="#æ ¼å¼æ ¡éªŒ" class="headerlink" title="æ ¼å¼æ ¡éªŒ"></a>æ ¼å¼æ ¡éªŒ</h2><p><code>ItemProcessor</code>çš„å®ç°ç±»<code>ValidatingItemProcessor</code>å¯ä»¥ç”¨äºæ•°æ®æ ¼å¼æ ¡éªŒã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºjobåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>ValidatingItemProcessorDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatingItemProcessorDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListItemReader&lt;TestData&gt; simpleReader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">validatingItemProcessorJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"validatingItemProcessorJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(simpleReader)</span><br><span class="line">                .processor(validatingItemProcessor())</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ValidatingItemProcessor&lt;TestData&gt; <span class="title">validatingItemProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ValidatingItemProcessor&lt;TestData&gt; processor = <span class="keyword">new</span> ValidatingItemProcessor&lt;&gt;();</span><br><span class="line">        processor.setValidator(value -&gt; &#123;</span><br><span class="line">            <span class="comment">// å¯¹æ¯ä¸€æ¡æ•°æ®è¿›è¡Œæ ¡éªŒ</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">""</span>.equals(value.getField3())) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœfield3çš„å€¼ä¸ºç©ºä¸²ï¼Œåˆ™æŠ›å¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">"field3çš„å€¼ä¸åˆæ³•"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> processor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡<code>ValidatingItemProcessor</code>æˆ‘ä»¬å¯¹<code>ItemReader</code>è¯»å–çš„æ¯ä¸€æ¡æ•°æ®è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœfield3çš„å€¼ä¸ºç©ºä¸²çš„è¯ï¼Œåˆ™æŠ›å‡º<code>ValidationException(&quot;field3çš„å€¼ä¸åˆæ³•&quot;)</code>å¼‚å¸¸ã€‚<code>ItemProcessor</code>é€šè¿‡æ­¥éª¤åˆ›å»ºå·¥å‚çš„<code>processor()</code>è®¾ç½®ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—çš„æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">2020-03-09 14:18:47.186  INFO 17967 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=validatingItemProcessorJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-09 14:18:47.252  INFO 17967 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">TestData&#123;id=1, field1=&apos;11&apos;, field2=&apos;12&apos;, field3=&apos;13&apos;&#125;</span><br><span class="line">TestData&#123;id=2, field1=&apos;21&apos;, field2=&apos;22&apos;, field3=&apos;23&apos;&#125;</span><br><span class="line">2020-03-09 14:18:47.300 ERROR 17967 --- [           main] o.s.batch.core.step.AbstractStep         : Encountered an error executing step step in job validatingItemProcessorJob</span><br><span class="line"></span><br><span class="line">org.springframework.batch.item.validator.ValidationException: field3çš„å€¼ä¸åˆæ³•</span><br><span class="line">	at cc.mrbird.batch.entity.job.ValidatingItemProcessorDemo.lambda$validatingItemProcessor$1(ValidatingItemProcessorDemo.java:50) ~[classes/:na]</span><br><span class="line">	at org.springframework.batch.item.validator.ValidatingItemProcessor.process(ValidatingItemProcessor.java:84) ~[spring-batch-infrastructure-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.item.SimpleChunkProcessor.doProcess(SimpleChunkProcessor.java:134) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.item.SimpleChunkProcessor.transform(SimpleChunkProcessor.java:319) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.item.SimpleChunkProcessor.process(SimpleChunkProcessor.java:210) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.item.ChunkOrientedTasklet.execute(ChunkOrientedTasklet.java:77) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.tasklet.TaskletStep$ChunkTransactionCallback.doInTransaction(TaskletStep.java:407) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.tasklet.TaskletStep$ChunkTransactionCallback.doInTransaction(TaskletStep.java:331) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.transaction.support.TransactionTemplate.execute(TransactionTemplate.java:140) ~[spring-tx-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.tasklet.TaskletStep$2.doInChunkContext(TaskletStep.java:273) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.scope.context.StepContextRepeatCallback.doInIteration(StepContextRepeatCallback.java:82) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.repeat.support.RepeatTemplate.getNextResult(RepeatTemplate.java:375) ~[spring-batch-infrastructure-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.repeat.support.RepeatTemplate.executeInternal(RepeatTemplate.java:215) ~[spring-batch-infrastructure-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.repeat.support.RepeatTemplate.iterate(RepeatTemplate.java:145) ~[spring-batch-infrastructure-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.tasklet.TaskletStep.doExecute(TaskletStep.java:258) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.AbstractStep.execute(AbstractStep.java:208) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.job.SimpleStepHandler.handleStep(SimpleStepHandler.java:148) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.job.AbstractJob.handleStep(AbstractJob.java:410) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.job.SimpleJob.doExecute(SimpleJob.java:136) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.job.AbstractJob.execute(AbstractJob.java:319) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.launch.support.SimpleJobLauncher$1.run(SimpleJobLauncher.java:147) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.core.task.SyncTaskExecutor.execute(SyncTaskExecutor.java:50) [spring-core-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.launch.support.SimpleJobLauncher.run(SimpleJobLauncher.java:140) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_231]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_231]</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_231]</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_231]</span><br><span class="line">	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:344) [spring-aop-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:198) [spring-aop-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163) [spring-aop-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.configuration.annotation.SimpleBatchConfiguration$PassthruAdvice.invoke(SimpleBatchConfiguration.java:127) [spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186) [spring-aop-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">	at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:212) [spring-aop-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">	at com.sun.proxy.$Proxy46.run(Unknown Source) [na:na]</span><br><span class="line">	at org.springframework.boot.autoconfigure.batch.JobLauncherCommandLineRunner.execute(JobLauncherCommandLineRunner.java:192) [spring-boot-autoconfigure-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">	at org.springframework.boot.autoconfigure.batch.JobLauncherCommandLineRunner.executeLocalJobs(JobLauncherCommandLineRunner.java:166) [spring-boot-autoconfigure-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">	at org.springframework.boot.autoconfigure.batch.JobLauncherCommandLineRunner.launchJobFromProperties(JobLauncherCommandLineRunner.java:153) [spring-boot-autoconfigure-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">	at org.springframework.boot.autoconfigure.batch.JobLauncherCommandLineRunner.run(JobLauncherCommandLineRunner.java:148) [spring-boot-autoconfigure-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:784) [spring-boot-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.callRunners(SpringApplication.java:768) [spring-boot-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:322) [spring-boot-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1226) [spring-boot-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1215) [spring-boot-2.2.5.RELEASE.jar:2.2.5.RELEASE]</span><br><span class="line">	at cc.mrbird.batch.SpringBatchItemprocessorApplication.main(SpringBatchItemprocessorApplication.java:12) [classes/:na]</span><br><span class="line"></span><br><span class="line">2020-03-09 14:18:47.307  INFO 17967 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 55ms</span><br><span class="line">2020-03-09 14:18:47.335  INFO 17967 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=validatingItemProcessorJob]] completed with the following parameters: [&#123;&#125;] and the following status: [FAILED] in 127ms</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ä»»åŠ¡å¤„ç†è¿‡ç¨‹ä¸­æŠ›å‡ºäº†é¢„æœŸå¼‚å¸¸ï¼Œå…³äºä»»åŠ¡å¤„ç†ä¸­å¦‚ä½•å¤„ç†å¼‚å¸¸ï¼Œå¯ä»¥å‚è€ƒåç»­çš„æ–‡ç« ã€‚</p><p>é™¤äº†ä½¿ç”¨è¿™ç§æ–¹å¼å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨<code>BeanValidatingItemProcessor</code>æ ¡éªŒä½¿ç”¨JSR-303æ³¨è§£æ ‡æ³¨çš„å®ä½“ç±»ã€‚æ¯”å¦‚ï¼Œåœ¨TestDataç±»çš„field3å±æ€§ä¸Šæ·»åŠ <code>@NotBlank</code>æ³¨è§£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestData</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String field1;</span><br><span class="line">    <span class="keyword">private</span> String field2;</span><br><span class="line">    <span class="meta">@NotBlank</span></span><br><span class="line">    <span class="keyword">private</span> String field3;</span><br><span class="line">    <span class="comment">// get,set,toStringç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨è¯¥æ³¨è§£éœ€è¦åœ¨pomä¸­æ·»åŠ <code>spring-boot-starter-validation</code>ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>ç„¶ååœ¨jobåŒ…ä¸‹æ–°å»º<code>BeanValidatingItemProcessorDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanValidatingItemProcessorDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListItemReader&lt;TestData&gt; simpleReader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">beanValidatingItemProcessorJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"beanValidatingItemProcessorJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(simpleReader)</span><br><span class="line">                .processor(beanValidatingItemProcessor())</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> BeanValidatingItemProcessor&lt;TestData&gt; <span class="title">beanValidatingItemProcessor</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        BeanValidatingItemProcessor&lt;TestData&gt; beanValidatingItemProcessor = <span class="keyword">new</span> BeanValidatingItemProcessor&lt;&gt;();</span><br><span class="line">        <span class="comment">// å¼€å¯è¿‡æ»¤ï¼Œä¸ç¬¦åˆè§„åˆ™çš„æ•°æ®è¢«è¿‡æ»¤æ‰ï¼›</span></span><br><span class="line">        beanValidatingItemProcessor.setFilter(<span class="keyword">true</span>);</span><br><span class="line">        beanValidatingItemProcessor.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> beanValidatingItemProcessor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨é¡¹ç›®åï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2020-03-09 14:31:14.813  INFO 18100 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=beanValidatingItemProcessorJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-09 14:31:14.873  INFO 18100 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">TestData&#123;id=1, field1=&apos;11&apos;, field2=&apos;12&apos;, field3=&apos;13&apos;&#125;</span><br><span class="line">TestData&#123;id=2, field1=&apos;21&apos;, field2=&apos;22&apos;, field3=&apos;23&apos;&#125;</span><br><span class="line">2020-03-09 14:31:14.959  INFO 18100 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 85ms</span><br><span class="line">2020-03-09 14:31:14.980  INFO 18100 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=beanValidatingItemProcessorJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 145ms</span><br><span class="line">2020-03-09 14:31:15.069  INFO 18100 --- [           main]</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸ç¬¦åˆè§„åˆ™çš„æ•°æ®å·²ç»è¢«æ’é™¤äº†ã€‚å¦‚æœä¸å¼€å¯è¿‡æ»¤<code>beanValidatingItemProcessor.setFilter(false)</code>ï¼Œé‚£ä¹ˆåœ¨é‡åˆ°ä¸ç¬¦åˆæ³¨è§£æ ¡éªŒè§„åˆ™çš„æ•°æ®ï¼Œå°†æŠ›å‡ºå¦‚ä¸‹å¼‚å¸¸ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.batch.item.validator.ValidationException: Validation failed for TestData&#123;id=3, field1=&apos;31&apos;, field2=&apos;32&apos;, field3=&apos;&apos;&#125;: </span><br><span class="line">Field error in object &apos;item&apos; on field &apos;field3&apos;: rejected value []; codes [NotBlank.item.field3,NotBlank.field3,NotBlank.java.lang.String,NotBlank]; arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [item.field3,field3]; arguments []; default message [field3]]; default message [ä¸èƒ½ä¸ºç©º]</span><br><span class="line">	at org.springframework.batch.item.validator.SpringValidator.validate(SpringValidator.java:54) ~[spring-batch-infrastructure-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.item.validator.ValidatingItemProcessor.process(ValidatingItemProcessor.java:84) ~[spring-batch-infrastructure-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.item.SimpleChunkProcessor.doProcess(SimpleChunkProcessor.java:134) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	at org.springframework.batch.core.step.item.SimpleChunkProcessor.transform(SimpleChunkProcessor.java:319) ~[spring-batch-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span><br><span class="line">	...</span><br></pre></td></tr></table></figure><p></p><h2 id="æ•°æ®è¿‡æ»¤"><a href="#æ•°æ®è¿‡æ»¤" class="headerlink" title="æ•°æ®è¿‡æ»¤"></a>æ•°æ®è¿‡æ»¤</h2><p>é€šè¿‡è‡ªå®šä¹‰<code>ItemProcessor</code>çš„å®ç°ç±»ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç®€å•åœ°å®ç°æ•°æ®è¿‡æ»¤ã€‚åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºprocessoråŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>TestDataFilterItemProcessor</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDataFilterItemProcessor</span> <span class="keyword">implements</span> <span class="title">ItemProcessor</span>&lt;<span class="title">TestData</span>, <span class="title">TestData</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TestData <span class="title">process</span><span class="params">(TestData item)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è¿”å›nullï¼Œä¼šè¿‡æ»¤æ‰è¿™æ¡æ•°æ®</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>.equals(item.getField3()) ? <span class="keyword">null</span> : item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>TestDataFilterItemProcessor</code>å®ç°äº†<code>ItemProcessor</code>çš„<code>process()</code>æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•å†…ç¼–å†™å…·ä½“çš„æ ¡éªŒé€»è¾‘ï¼Œä¸Šé¢ä»£ç åˆ¤æ–­TestDataçš„field3æ˜¯å¦ä¸ºç©ºä¸²ï¼Œæ˜¯çš„è¯è¿”å›nullï¼ˆè¿”å›nullä¼šè¿‡æ»¤æ‰è¿™æ¡æ•°æ®ï¼‰ã€‚</p><p>æ¥ç€åœ¨jobåŒ…ä¸‹æ–°å»º<code>TestDataFilterItemProcessorDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDataFilterItemProcessorDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListItemReader&lt;TestData&gt; simpleReader;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestDataFilterItemProcessor testDataFilterItemProcessor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">testDataFilterItemProcessorJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"testDataFilterItemProcessorJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(simpleReader)</span><br><span class="line">                .processor(testDataFilterItemProcessor)</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2020-03-09 15:03:30.932  INFO 18690 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=testDataFilterItemProcessorJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-09 15:03:30.973  INFO 18690 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">TestData&#123;id=1, field1=&apos;11&apos;, field2=&apos;12&apos;, field3=&apos;13&apos;&#125;</span><br><span class="line">TestData&#123;id=2, field1=&apos;21&apos;, field2=&apos;22&apos;, field3=&apos;23&apos;&#125;</span><br><span class="line">2020-03-09 15:03:31.012  INFO 18690 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 39ms</span><br><span class="line">2020-03-09 15:03:31.037  INFO 18690 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=testDataFilterItemProcessorJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 95ms</span><br></pre></td></tr></table></figure><p></p><h2 id="æ•°æ®è½¬æ¢"><a href="#æ•°æ®è½¬æ¢" class="headerlink" title="æ•°æ®è½¬æ¢"></a>æ•°æ®è½¬æ¢</h2><p>åœ¨processoråŒ…ä¸‹æ–°å»ºä¸€ä¸ª<code>ItemProcessor</code>å®ç°ç±»<code>TestDataTransformItemPorcessor</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDataTransformItemPorcessor</span> <span class="keyword">implements</span> <span class="title">ItemProcessor</span>&lt;<span class="title">TestData</span>, <span class="title">TestData</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TestData <span class="title">process</span><span class="params">(TestData item)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// field1å€¼æ‹¼æ¥ hello</span></span><br><span class="line">        item.setField1(item.getField1() + <span class="string">" hello"</span>);</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨jobåŒ…ä¸‹æ–°å»º<code>TestDataTransformItemPorcessorDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDataTransformItemPorcessorDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListItemReader&lt;TestData&gt; simpleReader;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestDataTransformItemPorcessor testDataTransformItemPorcessor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">testDataTransformItemPorcessorJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"testDataTransformItemPorcessorJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(simpleReader)</span><br><span class="line">                .processor(testDataTransformItemPorcessor)</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2020-03-09 15:08:55.628  INFO 18775 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=testDataTransformItemPorcessorJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-09 15:08:55.694  INFO 18775 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">TestData&#123;id=1, field1=&apos;11 hello&apos;, field2=&apos;12&apos;, field3=&apos;13&apos;&#125;</span><br><span class="line">TestData&#123;id=2, field1=&apos;21 hello&apos;, field2=&apos;22&apos;, field3=&apos;23&apos;&#125;</span><br><span class="line">TestData&#123;id=3, field1=&apos;31 hello&apos;, field2=&apos;32&apos;, field3=&apos;&apos;&#125;</span><br><span class="line">2020-03-09 15:08:55.757  INFO 18775 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 63ms</span><br><span class="line">2020-03-09 15:08:55.781  INFO 18775 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=testDataTransformItemPorcessorJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 144ms</span><br></pre></td></tr></table></figure><p></p><h2 id="èšåˆå¤„ç†"><a href="#èšåˆå¤„ç†" class="headerlink" title="èšåˆå¤„ç†"></a>èšåˆå¤„ç†</h2><p>åœ¨åˆ›å»ºStepçš„æ—¶å€™ï¼Œé™¤äº†åˆ¶å®šä¸€ä¸ª<code>ItemProcess</code>å¤–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>CompositeItemProcessor</code>èšåˆå¤šä¸ªprocessorå¤„ç†è¿‡ç¨‹ã€‚</p><p>åœ¨jobåŒ…ä¸‹æ–°å»º<code>CompositeItemProcessorDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompositeItemProcessorDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListItemReader&lt;TestData&gt; simpleReader;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestDataFilterItemProcessor testDataFilterItemProcessor;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestDataTransformItemPorcessor testDataTransformItemPorcessor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">compositeItemProcessorJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"compositeItemProcessorJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(simpleReader)</span><br><span class="line">                .processor(compositeItemProcessor())</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CompositeItemProcessorç»„åˆå¤šç§ä¸­é—´å¤„ç†å™¨</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CompositeItemProcessor&lt;TestData, TestData&gt; <span class="title">compositeItemProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CompositeItemProcessor&lt;TestData, TestData&gt; processor = <span class="keyword">new</span> CompositeItemProcessor&lt;&gt;();</span><br><span class="line">        List&lt;ItemProcessor&lt;TestData, TestData&gt;&gt; processors = Arrays.asList(testDataFilterItemProcessor, testDataTransformItemPorcessor);</span><br><span class="line">        <span class="comment">// ä»£ç†ä¸¤ä¸ªprocessor</span></span><br><span class="line">        processor.setDelegates(processors);</span><br><span class="line">        <span class="keyword">return</span> processor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>CompositeItemProcessor</code>èšåˆäº†å‰é¢å®šä¹‰çš„è¿ä¸ªprocessorï¼š<code>TestDataFilterItemProcessor</code>å’Œ<code>TestDataTransformItemPorcessor</code>ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2020-03-09 15:21:24.960  INFO 18882 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=compositeItemProcessorJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-09 15:21:25.005  INFO 18882 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">TestData&#123;id=1, field1=&apos;11 hello&apos;, field2=&apos;12&apos;, field3=&apos;13&apos;&#125;</span><br><span class="line">TestData&#123;id=2, field1=&apos;21 hello&apos;, field2=&apos;22&apos;, field3=&apos;23&apos;&#125;</span><br><span class="line">2020-03-09 15:21:25.065  INFO 18882 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 60ms</span><br><span class="line">2020-03-09 15:21:25.104  INFO 18882 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=compositeItemProcessorJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 128ms</span><br></pre></td></tr></table></figure><p></p><p>ä»ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®ä¸ä½†è¿›è¡Œäº†è¿‡æ»¤ï¼Œè¿˜è¿›è¡Œäº†è½¬æ¢ï¼ˆæ‹¼æ¥helloï¼‰ã€‚</p><blockquote><p>æœ¬èŠ‚æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/70.spring-batch-itemprocessor" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/70.spring-batch-itemprocessor</a>ã€‚</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨Spring Batchä¸­ï¼Œ&lt;code&gt;ItemReader&lt;/code&gt;æ¥å£ç”¨äºè¯»å–æ•°æ®ï¼Œ&lt;code&gt;ItemWriter&lt;/code&gt;æ¥å£ç”¨äºè¾“å‡ºæ•°æ®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡&lt;code&gt;ItemProcessor&lt;/code&gt;æ¥å£å®ç°æ•°æ®çš„å¤„ç†ï¼ŒåŒ…æ‹¬ï¼šæ•°æ®æ ¡éªŒï¼Œæ•°æ®è¿‡æ»¤å’Œæ•°æ®è½¬æ¢ç­‰ã€‚æ•°æ®å¤„ç†çš„æ—¶æœºå‘ç”Ÿäº&lt;code&gt;ItemReader&lt;/code&gt;è¯»å–æ•°æ®ä¹‹åï¼Œ&lt;code&gt;ItemWriter&lt;/code&gt;è¾“å‡ºæ•°æ®ä¹‹å‰ã€‚æœ¬èŠ‚è®°å½•ä¸‹Spring Batchä¸­&lt;code&gt;ItemProcessor&lt;/code&gt;çš„ä½¿ç”¨ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
      <category term="Spring Batch" scheme="http://mrbird.cc/tags/Spring-Batch/"/>
    
  </entry>
  
  <entry>
    <title>Spring Batchè¾“å‡ºæ•°æ®</title>
    <link href="http://mrbird.cc/Spring-Batch%E8%BE%93%E5%87%BA%E6%95%B0%E6%8D%AE.html"/>
    <id>http://mrbird.cc/Spring-Batchè¾“å‡ºæ•°æ®.html</id>
    <published>2020-03-07T03:54:32.000Z</published>
    <updated>2020-03-12T03:33:54.800Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p>Spring Batchè¾“å‡ºæ•°æ®é€šè¿‡ItemWriteræ¥å£çš„å®ç°ç±»æ¥å®Œæˆï¼ŒåŒ…æ‹¬FlatFileItemWriteræ–‡æœ¬æ•°æ®è¾“å‡ºã€StaxEventItemWriter XMLæ–‡ä»¶æ•°æ®è¾“å‡ºã€JsonItemWriter JSONæ–‡ä»¶æ•°æ®è¾“å‡ºã€JdbcBatchItemWriteræ•°æ®åº“æ•°æ®æ’å…¥ç­‰å®ç°ï¼Œæ›´å¤šå¯ç”¨çš„å®ç°å¯ä»¥å‚è€ƒï¼š<a href="https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/appendix.html#itemWritersAppendix" target="_blank" rel="noopener">https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/appendix.html#itemWritersAppendix</a>ï¼Œæœ¬æ–‡åªä»‹ç»è¿™å››ç§æ¯”è¾ƒå¸¸ç”¨çš„è¾“å‡ºæ•°æ®æ–¹å¼ã€‚</p><a id="more"></a><h2 id="æ¡†æ¶æ­å»º"><a href="#æ¡†æ¶æ­å»º" class="headerlink" title="æ¡†æ¶æ­å»º"></a>æ¡†æ¶æ­å»º</h2><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º2.2.4.RELEASEï¼ŒartifactIdä¸ºspring-batch-itemwriterï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200309-092102@2x.png" alt="QQ20200309-092102@2x"></p><p>å‰©ä¸‹çš„æ•°æ®åº“å±‚çš„å‡†å¤‡ï¼Œé¡¹ç›®é…ç½®ï¼Œä¾èµ–å¼•å…¥å’Œ<a href="/Spring-Batchå…¥é—¨.html">Spring Batchå…¥é—¨</a>æ–‡ç« ä¸­çš„æ¡†æ¶æ­å»ºæ­¥éª¤ä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚</p><p>åœ¨ä»‹ç»Spring Batchæ•°æ®è¾“å‡ºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå‡†å¤‡ä¸ªç®€å•çš„æ•°æ®è¯»å–æºã€‚åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºentityåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>TestData</code>å®ä½“ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestData</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String field1;</span><br><span class="line">    <span class="keyword">private</span> String field2;</span><br><span class="line">    <span class="keyword">private</span> String field3;</span><br><span class="line">    <span class="comment">// get,set,toStringç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºreaderåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹åˆ›å»º<code>ItemReaderConfigure</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemReaderConfigure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListItemReader&lt;TestData&gt; <span class="title">simpleReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;TestData&gt; data = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        TestData testData1 = <span class="keyword">new</span> TestData();</span><br><span class="line">        testData1.setId(<span class="number">1</span>);</span><br><span class="line">        testData1.setField1(<span class="string">"11"</span>);</span><br><span class="line">        testData1.setField2(<span class="string">"12"</span>);</span><br><span class="line">        testData1.setField3(<span class="string">"13"</span>);</span><br><span class="line">        data.add(testData1);</span><br><span class="line">        TestData testData2 = <span class="keyword">new</span> TestData();</span><br><span class="line">        testData2.setId(<span class="number">2</span>);</span><br><span class="line">        testData2.setField1(<span class="string">"21"</span>);</span><br><span class="line">        testData2.setField2(<span class="string">"22"</span>);</span><br><span class="line">        testData2.setField3(<span class="string">"23"</span>);</span><br><span class="line">        data.add(testData2);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ListItemReader&lt;&gt;(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢æ³¨å†Œäº†ä¸€ä¸ªItemReaderç±»å‹çš„Beanï¼Œåç»­éƒ½ç”¨å®ƒä½œä¸ºè¯»å–æ•°æ®çš„æ¥æºã€‚</p><h2 id="è¾“å‡ºæ–‡æœ¬æ•°æ®"><a href="#è¾“å‡ºæ–‡æœ¬æ•°æ®" class="headerlink" title="è¾“å‡ºæ–‡æœ¬æ•°æ®"></a>è¾“å‡ºæ–‡æœ¬æ•°æ®</h2><p>åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºjobåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>FileItemWriterDemo</code>ï¼Œç”¨äºæµ‹è¯•Spring Batchè¾“å‡ºæ•°æ®åˆ°æ–‡æœ¬æ–‡ä»¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileItemWriterDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListItemReader&lt;TestData&gt; simpleReader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">fileItemWriterJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"fileItemWriterJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(simpleReader)</span><br><span class="line">                .writer(fileItemWriter())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> FlatFileItemWriter&lt;TestData&gt; <span class="title">fileItemWriter</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        FlatFileItemWriter&lt;TestData&gt; writer = <span class="keyword">new</span> FlatFileItemWriter&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        FileSystemResource file = <span class="keyword">new</span> FileSystemResource(<span class="string">"/Users/mrbird/Desktop/file"</span>);</span><br><span class="line">        Path path = Paths.get(file.getPath());</span><br><span class="line">        <span class="keyword">if</span> (!Files.exists(path)) &#123;</span><br><span class="line">            Files.createFile(path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®¾ç½®è¾“å‡ºæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        writer.setResource(file); </span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŠŠè¯»åˆ°çš„æ¯ä¸ªTestDataå¯¹è±¡è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²</span></span><br><span class="line">        LineAggregator&lt;TestData&gt; aggregator = item -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">                <span class="keyword">return</span> mapper.writeValueAsString(item);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        writer.setLineAggregator(aggregator);</span><br><span class="line">        writer.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼ŒStepä¸­çš„Readerä½¿ç”¨çš„æ˜¯æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„<code>simpleReader</code>ï¼Œæ–‡æœ¬æ•°æ®è¾“å‡ºä½¿ç”¨çš„æ˜¯<code>FlatFileItemWriter</code>ã€‚<code>fileItemWriter()</code>æ–¹æ³•çš„ä»£ç è¾ƒä¸ºç®€å•ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p><p>å¯åŠ¨é¡¹ç›®åï¼Œåœ¨<code>/Users/mrbird/Desktop</code>ç›®å½•ä¸‹ï¼ˆä¹Ÿå°±æ˜¯æˆ‘çš„ç”µè„‘æ¡Œé¢ä¸Šï¼‰ä¼šå¤šå‡ºä¸ªfileæ–‡ä»¶ï¼š</p><p><img src="img/QQ20200309-094315@2x.png" alt="QQ20200309-094315@2x"></p><h2 id="è¾“å‡ºxmlæ•°æ®"><a href="#è¾“å‡ºxmlæ•°æ®" class="headerlink" title="è¾“å‡ºxmlæ•°æ®"></a>è¾“å‡ºxmlæ•°æ®</h2><p>åŒæ ·çš„ï¼Œxmlæ ¼å¼æ•°æ®è¾“å‡ºéœ€è¦å€ŸåŠ©spring-oxmæ¡†æ¶ï¼Œåœ¨pomä¸­å¼•å…¥ç›¸å…³ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-oxm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.thoughtworks.xstream<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xstream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.11.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>ç„¶ååœ¨jobåŒ…ä¸‹æ–°å»º<code>XmlFileItemWriterDemo</code>ï¼Œç”¨äºæµ‹è¯•Spring Batchè¾“å‡ºæ•°æ®åˆ°xmlæ–‡ä»¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlFileItemWriterDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListItemReader&lt;TestData&gt; simpleReader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">xmlFileItemWriterJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"xmlFileItemWriterJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(simpleReader)</span><br><span class="line">                .writer(xmlFileItemWriter())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> StaxEventItemWriter&lt;TestData&gt; <span class="title">xmlFileItemWriter</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        StaxEventItemWriter&lt;TestData&gt; writer = <span class="keyword">new</span> StaxEventItemWriter&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šè¿‡XStreamMarshallerå°†TestDataè½¬æ¢ä¸ºxml</span></span><br><span class="line">        XStreamMarshaller marshaller = <span class="keyword">new</span> XStreamMarshaller();</span><br><span class="line"></span><br><span class="line">        Map&lt;String,Class&lt;TestData&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        map.put(<span class="string">"test"</span>, TestData.class);</span><br><span class="line"></span><br><span class="line">        marshaller.setAliases(map); <span class="comment">// è®¾ç½®xmlæ ‡ç­¾</span></span><br><span class="line"></span><br><span class="line">        writer.setRootTagName(<span class="string">"tests"</span>); <span class="comment">// è®¾ç½®æ ¹æ ‡ç­¾</span></span><br><span class="line">        writer.setMarshaller(marshaller);</span><br><span class="line"></span><br><span class="line">        FileSystemResource file = <span class="keyword">new</span> FileSystemResource(<span class="string">"/Users/mrbird/Desktop/file.xml"</span>);</span><br><span class="line">        Path path = Paths.get(file.getPath());</span><br><span class="line">        <span class="keyword">if</span> (!Files.exists(path)) &#123;</span><br><span class="line">            Files.createFile(path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        writer.setResource(file); <span class="comment">// è®¾ç½®ç›®æ ‡æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>xmlç±»å‹æ–‡ä»¶è¾“å‡ºä½¿ç”¨çš„æ˜¯<code>StaxEventItemWriter</code>ã€‚</p><p>å¯åŠ¨é¡¹ç›®åï¼Œåœ¨<code>/Users/mrbird/Desktop</code>ç›®å½•ä¸‹ä¼šå¤šå‡ºä¸ªfile.xmlæ–‡ä»¶ï¼š</p><p><img src="img/QQ20200309-095332@2x.png" alt="QQ20200309-095332@2x"></p><h2 id="è¾“å‡ºJSONæ•°æ®"><a href="#è¾“å‡ºJSONæ•°æ®" class="headerlink" title="è¾“å‡ºJSONæ•°æ®"></a>è¾“å‡ºJSONæ•°æ®</h2><p>åœ¨jobåŒ…ä¸‹æ–°å»º<code>JsonFileItemWriterDemo</code>ï¼Œç”¨äºæµ‹è¯•Spring Batchè¾“å‡ºæ•°æ®åˆ°jsonæ–‡ä»¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonFileItemWriterDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListItemReader&lt;TestData&gt; simpleReader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">jsonFileItemWriterJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"jsonFileItemWriterJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(simpleReader)</span><br><span class="line">                .writer(jsonFileItemWriter())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> JsonFileItemWriter&lt;TestData&gt; <span class="title">jsonFileItemWriter</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// æ–‡ä»¶è¾“å‡ºç›®æ ‡åœ°å€</span></span><br><span class="line">        FileSystemResource file = <span class="keyword">new</span> FileSystemResource(<span class="string">"/Users/mrbird/Desktop/file.json"</span>);</span><br><span class="line">        Path path = Paths.get(file.getPath());</span><br><span class="line">        <span class="keyword">if</span> (!Files.exists(path)) &#123;</span><br><span class="line">            Files.createFile(path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°†å¯¹è±¡è½¬æ¢ä¸ºjson</span></span><br><span class="line">        JacksonJsonObjectMarshaller&lt;TestData&gt; marshaller = <span class="keyword">new</span> JacksonJsonObjectMarshaller&lt;&gt;();</span><br><span class="line">        JsonFileItemWriter&lt;TestData&gt; writer = <span class="keyword">new</span> JsonFileItemWriter&lt;&gt;(file, marshaller);</span><br><span class="line">        <span class="comment">// è®¾ç½®åˆ«å</span></span><br><span class="line">        writer.setName(<span class="string">"testDatasonFileItemWriter"</span>);</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>jsonç±»å‹æ–‡ä»¶è¾“å‡ºä½¿ç”¨çš„æ˜¯<code>JsonFileItemWriter</code>ã€‚</p><p>å¯åŠ¨é¡¹ç›®åï¼Œåœ¨<code>/Users/mrbird/Desktop</code>ç›®å½•ä¸‹ä¼šå¤šå‡ºä¸ªfile.jsonæ–‡ä»¶ï¼š</p><p><img src="img/QQ20200309-100359@2x.png" alt="QQ20200309-100359@2x"></p><h2 id="è¾“å‡ºæ•°æ®åˆ°æ•°æ®åº“"><a href="#è¾“å‡ºæ•°æ®åˆ°æ•°æ®åº“" class="headerlink" title="è¾“å‡ºæ•°æ®åˆ°æ•°æ®åº“"></a>è¾“å‡ºæ•°æ®åˆ°æ•°æ®åº“</h2><p>åœ¨jobåŒ…ä¸‹æ–°å»º<code>DatabaseItemWriterDemo</code>ï¼Œç”¨äºæµ‹è¯•Spring Batchè¾“å‡ºæ•°æ®åˆ°æ•°æ®åº“ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseItemWriterDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListItemReader&lt;TestData&gt; simpleReader;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">datasourceItemWriterJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"datasourceItemWriterJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(simpleReader)</span><br><span class="line">                .writer(dataSourceItemWriter())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ItemWriter&lt;TestData&gt; <span class="title">dataSourceItemWriter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ItemWriterçš„å®ç°ç±»ä¹‹ä¸€ï¼Œmysqlæ•°æ®åº“æ•°æ®å†™å…¥ä½¿ç”¨JdbcBatchItemWriterï¼Œ</span></span><br><span class="line">        <span class="comment">// å…¶ä»–å®ç°ï¼šMongoItemWriter,Neo4jItemWriterç­‰</span></span><br><span class="line">        JdbcBatchItemWriter&lt;TestData&gt; writer = <span class="keyword">new</span> JdbcBatchItemWriter&lt;&gt;();</span><br><span class="line">        writer.setDataSource(dataSource); <span class="comment">// è®¾ç½®æ•°æ®æº</span></span><br><span class="line"></span><br><span class="line">        String sql = <span class="string">"insert into TEST(id,field1,field2,field3) values (:id,:field1,:field2,:field3)"</span>;</span><br><span class="line">        writer.setSql(sql); <span class="comment">// è®¾ç½®æ’å…¥sqlè„šæœ¬</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ˜ å°„TestDataå¯¹è±¡å±æ€§åˆ°å ä½ç¬¦ä¸­çš„å±æ€§</span></span><br><span class="line">        BeanPropertyItemSqlParameterSourceProvider&lt;TestData&gt; provider = <span class="keyword">new</span> BeanPropertyItemSqlParameterSourceProvider&lt;&gt;();</span><br><span class="line">        writer.setItemSqlParameterSourceProvider(provider);</span><br><span class="line"></span><br><span class="line">        writer.afterPropertiesSet(); <span class="comment">// è®¾ç½®ä¸€äº›é¢å¤–å±æ€§</span></span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>MySQLå…³ç³»å‹æ•°æ®æ•°æ®å†™å…¥ä½¿ç”¨çš„æ˜¯<code>JdbcBatchItemWriter</code>ã€‚åœ¨æµ‹è¯•ä¹‹å‰ï¼Œå…ˆæ¸…ç©ºspringbatchæ•°æ®åº“TESTè¡¨æ•°æ®ï¼Œç„¶åå¯åŠ¨é¡¹ç›®ï¼Œå¯åŠ¨åï¼ŒTESTè¡¨è®°å½•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200309-102006@2x.png" alt="QQ20200309-102006@2x"></p><h2 id="å¤šæ–‡æœ¬è¾“å‡º"><a href="#å¤šæ–‡æœ¬è¾“å‡º" class="headerlink" title="å¤šæ–‡æœ¬è¾“å‡º"></a>å¤šæ–‡æœ¬è¾“å‡º</h2><p>å¤šæ–‡æœ¬è¾“å‡ºå’Œä¸Šä¸€èŠ‚ä»‹ç»çš„å¤šæ–‡æœ¬æ•°æ®è¯»å–ç±»ä¼¼ï¼Œéƒ½æ˜¯éœ€è¦é€šè¿‡ä»£ç†æ¥å®Œæˆã€‚æˆ‘ä»¬æ¨¡æ‹Ÿä¸ªåŒæ—¶è¾“å‡ºxmlæ ¼å¼å’Œæ™®é€šæ–‡æœ¬æ ¼å¼çš„ä¾‹å­ã€‚</p><p>åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºwriteråŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>ItemWriterConfigure</code>é…ç½®ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemWriterConfigure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FlatFileItemWriter&lt;TestData&gt; <span class="title">fileItemWriter</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        FlatFileItemWriter&lt;TestData&gt; writer = <span class="keyword">new</span> FlatFileItemWriter&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        FileSystemResource file = <span class="keyword">new</span> FileSystemResource(<span class="string">"/Users/mrbird/Desktop/file"</span>);</span><br><span class="line">        Path path = Paths.get(file.getPath());</span><br><span class="line">        <span class="keyword">if</span> (!Files.exists(path)) &#123;</span><br><span class="line">            Files.createFile(path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        writer.setResource(file); <span class="comment">// è®¾ç½®ç›®æ ‡æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŠŠè¯»åˆ°çš„æ¯ä¸ªTestDataå¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span></span><br><span class="line">        LineAggregator&lt;TestData&gt; aggregator = item -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">                <span class="keyword">return</span> mapper.writeValueAsString(item);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        writer.setLineAggregator(aggregator);</span><br><span class="line">        writer.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> StaxEventItemWriter&lt;TestData&gt; <span class="title">xmlFileItemWriter</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StaxEventItemWriter&lt;TestData&gt; writer = <span class="keyword">new</span> StaxEventItemWriter&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šè¿‡XStreamMarshallerå°†TestDataè½¬æ¢ä¸ºxml</span></span><br><span class="line">        XStreamMarshaller marshaller = <span class="keyword">new</span> XStreamMarshaller();</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Class&lt;TestData&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        map.put(<span class="string">"test"</span>, TestData.class);</span><br><span class="line"></span><br><span class="line">        marshaller.setAliases(map); <span class="comment">// è®¾ç½®xmlæ ‡ç­¾</span></span><br><span class="line"></span><br><span class="line">        writer.setRootTagName(<span class="string">"tests"</span>); <span class="comment">// è®¾ç½®æ ¹æ ‡ç­¾</span></span><br><span class="line">        writer.setMarshaller(marshaller);</span><br><span class="line"></span><br><span class="line">        FileSystemResource file = <span class="keyword">new</span> FileSystemResource(<span class="string">"/Users/mrbird/Desktop/file.xml"</span>);</span><br><span class="line">        Path path = Paths.get(file.getPath());</span><br><span class="line">        <span class="keyword">if</span> (!Files.exists(path)) &#123;</span><br><span class="line">            Files.createFile(path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        writer.setResource(file); <span class="comment">// è®¾ç½®ç›®æ ‡æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„é…ç½®ç±»ä¸­ï¼Œé…ç½®äº†<code>FlatFileItemWriter</code>å’Œ<code>StaxEventItemWriter</code>ç±»å‹çš„ItemWriter Beanï¼Œä»£ç æ­¥éª¤å’Œå‰é¢ä»‹ç»çš„ä¸€è‡´ã€‚</p><p>ç„¶ååœ¨jobåŒ…ä¸‹æ–°å»º<code>MultiFileItemWriteDemo</code>ï¼Œç”¨äºæµ‹è¯•å¤šæ–‡æœ¬è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiFileItemWriteDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListItemReader&lt;TestData&gt; simpleReader;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemStreamWriter&lt;TestData&gt; fileItemWriter;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemStreamWriter&lt;TestData&gt; xmlFileItemWriter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">multiFileItemWriterJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"multiFileItemWriterJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(simpleReader)</span><br><span class="line">                .writer(classifierMultiFileItemWriter())</span><br><span class="line">                .stream(fileItemWriter)</span><br><span class="line">                .stream(xmlFileItemWriter)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†æ•°æ®åˆ†ç±»ï¼Œç„¶ååˆ†åˆ«è¾“å‡ºåˆ°å¯¹åº”çš„æ–‡ä»¶(æ­¤æ—¶éœ€è¦å°†writeræ³¨å†Œåˆ°iocå®¹å™¨ï¼Œå¦åˆ™æŠ¥</span></span><br><span class="line">    <span class="comment">// WriterNotOpenException: Writer must be open before it can be written to)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ClassifierCompositeItemWriter&lt;TestData&gt; <span class="title">classifierMultiFileItemWriter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ClassifierCompositeItemWriter&lt;TestData&gt; writer = <span class="keyword">new</span> ClassifierCompositeItemWriter&lt;&gt;();</span><br><span class="line">        writer.setClassifier((Classifier&lt;TestData, ItemWriter&lt;? <span class="keyword">super</span> TestData&gt;&gt;) testData -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// idèƒ½è¢«2æ•´é™¤åˆ™è¾“å‡ºåˆ°æ™®é€šæ–‡æœ¬ï¼Œå¦åˆ™è¾“å‡ºåˆ°xmlæ–‡æœ¬</span></span><br><span class="line">                <span class="keyword">return</span> testData.getId() % <span class="number">2</span> == <span class="number">0</span> ? fileItemWriter : xmlFileItemWriter;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>ClassifierCompositeItemWriter</code>å¯ä»¥è®¾ç½®ä¸åŒæ¡ä»¶ä¸‹ä½¿ç”¨ä¸åŒçš„ItemWriterè¾“å‡ºæ•°æ®ï¼Œæ­¤å¤–åœ¨Stepä¸­ï¼Œè¿˜éœ€é€šè¿‡<code>StepBuilderFactory</code>çš„<code>stream()</code>æ–¹æ³•ä¼ å…¥ä½¿ç”¨åˆ°çš„ItemWriterï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ³¨å…¥çš„æ—¶å€™ï¼Œç±»å‹åº”é€‰æ‹©ItemStreamWriterï¼‰ã€‚</p><p>åœ¨å¯åŠ¨é¡¹ç›®å‰ï¼Œå…ˆåˆ æ‰<code>/Users/mrbird/Desktop</code>ç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚åˆ æ‰åï¼Œå¯åŠ¨é¡¹ç›®ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="img/QQ20200309-110058@2x.png" alt="QQ20200309-110058@2x"></p><p><img src="img/QQ20200309-110519@2x.png" alt="QQ20200309-110519@2x"></p><p>å¦‚æœä¸æƒ³ç”¨åˆ†ç±»ï¼Œå¸Œæœ›æ‰€æœ‰æ•°æ®éƒ½è¾“å‡ºåˆ°å¯¹åº”æ ¼å¼çš„æ–‡æœ¬ä¸­ï¼Œåˆ™å¯ä»¥ä½¿ç”¨<code>CompositeItemWriter</code>ä½œä¸ºä»£ç†è¾“å‡ºï¼Œä¿®æ”¹<code>MultiFileItemWriteDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiFileItemWriteDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListItemReader&lt;TestData&gt; simpleReader;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemStreamWriter&lt;TestData&gt; fileItemWriter;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemStreamWriter&lt;TestData&gt; xmlFileItemWriter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">multiFileItemWriterJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"multiFileItemWriterJob2"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(simpleReader)</span><br><span class="line">                .writer(multiFileItemWriter())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å‡ºæ•°æ®åˆ°å¤šä¸ªæ–‡ä»¶</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CompositeItemWriter&lt;TestData&gt; <span class="title">multiFileItemWriter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨CompositeItemWriterä»£ç†</span></span><br><span class="line">        CompositeItemWriter&lt;TestData&gt; writer = <span class="keyword">new</span> CompositeItemWriter&lt;&gt;();</span><br><span class="line">        <span class="comment">// è®¾ç½®å…·ä½“å†™ä»£ç†</span></span><br><span class="line">        writer.setDelegates(Arrays.asList(fileItemWriter, xmlFileItemWriter));</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨å¯åŠ¨é¡¹ç›®å‰ï¼Œå…ˆåˆ æ‰<code>/Users/mrbird/Desktop</code>ç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚åˆ æ‰åï¼Œå¯åŠ¨é¡¹ç›®ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="img/QQ20200309-111155@2x.png" alt="QQ20200309-111155@2x"></p><blockquote><p>æœ¬èŠ‚æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/69.spring-batch-itemwriter" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/69.spring-batch-itemwriter</a>ã€‚</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Spring Batchè¾“å‡ºæ•°æ®é€šè¿‡ItemWriteræ¥å£çš„å®ç°ç±»æ¥å®Œæˆï¼ŒåŒ…æ‹¬FlatFileItemWriteræ–‡æœ¬æ•°æ®è¾“å‡ºã€StaxEventItemWriter XMLæ–‡ä»¶æ•°æ®è¾“å‡ºã€JsonItemWriter JSONæ–‡ä»¶æ•°æ®è¾“å‡ºã€JdbcBatchItemWriteræ•°æ®åº“æ•°æ®æ’å…¥ç­‰å®ç°ï¼Œæ›´å¤šå¯ç”¨çš„å®ç°å¯ä»¥å‚è€ƒï¼š&lt;a href=&quot;https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/appendix.html#itemWritersAppendix&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/appendix.html#itemWritersAppendix&lt;/a&gt;ï¼Œæœ¬æ–‡åªä»‹ç»è¿™å››ç§æ¯”è¾ƒå¸¸ç”¨çš„è¾“å‡ºæ•°æ®æ–¹å¼ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
      <category term="Spring Batch" scheme="http://mrbird.cc/tags/Spring-Batch/"/>
    
  </entry>
  
  <entry>
    <title>Spring Batchè¯»å–æ•°æ®</title>
    <link href="http://mrbird.cc/Spring-Batch%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE.html"/>
    <id>http://mrbird.cc/Spring-Batchè¯»å–æ•°æ®.html</id>
    <published>2020-03-07T03:54:13.000Z</published>
    <updated>2020-03-12T03:33:33.735Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p>Spring Batchè¯»å–æ•°æ®é€šè¿‡ItemReaderæ¥å£çš„å®ç°ç±»æ¥å®Œæˆï¼ŒåŒ…æ‹¬FlatFileItemReaderæ–‡æœ¬æ•°æ®è¯»å–ã€StaxEventItemReader XMLæ–‡ä»¶æ•°æ®è¯»å–ã€JsonItemReader JSONæ–‡ä»¶æ•°æ®è¯»å–ã€JdbcPagingItemReaderæ•°æ®åº“åˆ†é¡µæ•°æ®è¯»å–ç­‰å®ç°ï¼Œæ›´å¤šå¯ç”¨çš„å®ç°å¯ä»¥å‚è€ƒï¼š<a href="https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/appendix.html#itemReadersAppendix" target="_blank" rel="noopener">https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/appendix.html#itemReadersAppendix</a>ï¼Œæœ¬æ–‡åªä»‹ç»è¿™å››ç§æ¯”è¾ƒå¸¸ç”¨çš„è¯»å–æ•°æ®æ–¹å¼ã€‚</p><a id="more"></a><h2 id="æ¡†æ¶æ­å»º"><a href="#æ¡†æ¶æ­å»º" class="headerlink" title="æ¡†æ¶æ­å»º"></a>æ¡†æ¶æ­å»º</h2><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º2.2.4.RELEASEï¼ŒartifactIdä¸ºspring-batch-itemreaderï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200307-104004@2x.png" alt="QQ20200307-104004@2x"></p><p>å‰©ä¸‹çš„æ•°æ®åº“å±‚çš„å‡†å¤‡ï¼Œé¡¹ç›®é…ç½®ï¼Œä¾èµ–å¼•å…¥å’Œ<a href="/Spring-Batchå…¥é—¨.html">Spring Batchå…¥é—¨</a>æ–‡ç« ä¸­çš„æ¡†æ¶æ­å»ºæ­¥éª¤ä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚</p><h2 id="ç®€å•æ•°æ®è¯»å–"><a href="#ç®€å•æ•°æ®è¯»å–" class="headerlink" title="ç®€å•æ•°æ®è¯»å–"></a>ç®€å•æ•°æ®è¯»å–</h2><p>å‰é¢æåˆ°ï¼ŒSpring Batchè¯»å–æ•°æ®æ˜¯é€šè¿‡ItemReaderæ¥å£çš„å®ç°ç±»æ¥å®Œæˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªItemReaderçš„å®ç°ç±»ï¼Œå®ç°ç®€å•æ•°æ®çš„è¯»å–ã€‚</p><p>åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºreaderåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»ºItemReaderæ¥å£çš„å®ç°ç±»<code>MySimpleIteamReader</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySimpleIteamReader</span> <span class="keyword">implements</span> <span class="title">ItemReader</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Iterator&lt;String&gt; iterator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MySimpleIteamReader</span><span class="params">(List&lt;String&gt; data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iterator = data.iterator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ•°æ®ä¸€ä¸ªæ¥ç€ä¸€ä¸ªè¯»å–</span></span><br><span class="line">        <span class="keyword">return</span> iterator.hasNext() ? iterator.next() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ³›å‹æŒ‡å®šè¯»å–æ•°æ®çš„æ ¼å¼ï¼Œè¿™é‡Œè¯»å–çš„æ˜¯Stringç±»å‹çš„Listï¼Œ<code>read()</code>æ–¹æ³•çš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯éå†é›†åˆæ•°æ®ã€‚</p><p>æ¥ç€åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºjobåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>MySimpleItemReaderDemo</code>ç±»ï¼Œç”¨äºæµ‹è¯•æˆ‘ä»¬å®šä¹‰çš„<code>MySimpleIteamReader</code>ï¼Œ<code>MySimpleItemReaderDemo</code>ç±»ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySimpleItemReaderDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">mySimpleItemReaderJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"mySimpleItemReaderJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;String, String&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(mySimpleItemReader())</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))  <span class="comment">// ç®€å•è¾“å‡ºï¼Œåé¢å†è¯¦ç»†ä»‹ç»writer</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ItemReader&lt;String&gt; <span class="title">mySimpleItemReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; data = Arrays.asList(<span class="string">"java"</span>, <span class="string">"c++"</span>, <span class="string">"javascript"</span>, <span class="string">"python"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MySimpleIteamReader(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>mySimpleItemReader()</code>æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ª<code>MySimpleIteamReader</code>ï¼Œå¹¶ä¸”ä¼ å…¥äº†Listæ•°æ®ã€‚ä¸Šé¢ä»£ç å¤§ä½“å’Œä¸Šä¸€èŠ‚ä¸­ä»‹ç»çš„å·®ä¸å¤šï¼Œæœ€ä¸»è¦çš„åŒºåˆ«å°±æ˜¯Stepçš„åˆ›å»ºè¿‡ç¨‹ç¨æœ‰ä¸åŒã€‚</p><p>åœ¨<code>MySimpleItemReaderDemo</code>ç±»ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>StepBuilderFactory</code>åˆ›å»ºæ­¥éª¤Stepï¼Œä¸è¿‡ä¸å†æ˜¯ä½¿ç”¨<code>tasklet()</code>æ–¹æ³•åˆ›å»ºï¼Œè€Œæ˜¯ä½¿ç”¨<code>chunk()</code>æ–¹æ³•ã€‚chunkå­—é¢ä¸Šçš„æ„æ€æ˜¯â€œå—â€çš„æ„æ€ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºæ•°æ®å—ï¼Œæ³›å‹<code>&lt;String, String&gt;</code>ç”¨äºæŒ‡å®šè¯»å–çš„æ•°æ®å’Œè¾“å‡ºçš„æ•°æ®ç±»å‹ï¼Œæ„é€ å™¨å…¥å‚æŒ‡å®šäº†æ•°æ®å—çš„å¤§å°ï¼Œæ¯”å¦‚æŒ‡å®šä¸º2æ—¶è¡¨ç¤ºæ¯å½“è¯»å–2ç»„æ•°æ®ååšä¸€æ¬¡æ•°æ®è¾“å‡ºå¤„ç†ã€‚æ¥ç€<code>reader()</code>æ–¹æ³•æŒ‡å®šè¯»å–æ•°æ®çš„æ–¹å¼ï¼Œè¯¥æ–¹æ³•æ¥æ”¶<code>ItemReader</code>çš„å®ç°ç±»ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„<code>MySimpleIteamReader</code>ã€‚<code>writer()</code>æ–¹æ³•æŒ‡å®šæ•°æ®è¾“å‡ºæ–¹å¼ï¼Œå› ä¸ºè¿™å—ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œæ‰€ä»¥å…ˆç®€å•éå†è¾“å‡ºå³å¯ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2020-03-07 11:17:32.303  INFO 28381 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=mySimpleItemReaderJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-07 11:17:32.369  INFO 28381 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">java</span><br><span class="line">c++</span><br><span class="line">javascript</span><br><span class="line">python</span><br><span class="line">2020-03-07 11:17:32.428  INFO 28381 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 59ms</span><br><span class="line">2020-03-07 11:17:32.451  INFO 28381 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=mySimpleItemReaderJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 125ms</span><br></pre></td></tr></table></figure><p></p><h2 id="æ–‡æœ¬æ•°æ®è¯»å–"><a href="#æ–‡æœ¬æ•°æ®è¯»å–" class="headerlink" title="æ–‡æœ¬æ•°æ®è¯»å–"></a>æ–‡æœ¬æ•°æ®è¯»å–</h2><p>Spring Batchè¯»å–æ–‡æœ¬ç±»å‹æ•°æ®å¯ä»¥é€šè¿‡<code>FlatFileItemReader</code>å®ç°ï¼Œåœ¨æ¼”ç¤ºæ€ä¹ˆä½¿ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå‡†å¤‡å¥½æ•°æ®æ–‡ä»¶ã€‚</p><p>åœ¨resourcesç›®å½•ä¸‹æ–°å»ºfileæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// æ¼”ç¤ºæ–‡ä»¶æ•°æ®è¯»å–</span><br><span class="line">1,11,12,13</span><br><span class="line">2,21,22,23</span><br><span class="line">3,31,32,33</span><br><span class="line">4,41,42,43</span><br><span class="line">5,51,52,53</span><br><span class="line">6,61,62,63</span><br></pre></td></tr></table></figure><p></p><p>fileçš„æ•°æ®æ˜¯ä¸€è¡Œä¸€è¡Œä»¥é€—å·åˆ†éš”çš„æ•°æ®ï¼ˆåœ¨æ‰¹å¤„ç†ä¸šåŠ¡ä¸­ï¼Œæ–‡æœ¬ç±»å‹çš„æ•°æ®æ–‡ä»¶ä¸€èˆ¬éƒ½æ˜¯æœ‰ä¸€å®šè§„å¾‹çš„ï¼‰ã€‚åœ¨æ–‡æœ¬æ•°æ®è¯»å–çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†è¯»å–çš„æ•°æ®è½¬æ¢ä¸ºPOJOå¯¹è±¡å­˜å‚¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„POJOå¯¹è±¡ã€‚åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºentityåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>TestData</code>ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestData</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String field1;</span><br><span class="line">    <span class="keyword">private</span> String field2;</span><br><span class="line">    <span class="keyword">private</span> String field3;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get,set,toStringç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºfileæ–‡æœ¬ä¸­çš„ä¸€è¡Œæ•°æ®ç»è¿‡é€—å·åˆ†éš”åä¸º1ã€11ã€12ã€13ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºçš„ä¸ä¹‹å¯¹åº”çš„POJO TestDataåŒ…å«4ä¸ªå±æ€§idã€field1ã€field2å’Œfield3ã€‚</p><p>æ¥ç€åœ¨jobåŒ…ä¸‹æ–°å»º<code>FileItemReaderDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileItemReaderDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡åˆ›å»ºå·¥å‚</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="comment">// æ­¥éª¤åˆ›å»ºå·¥å‚</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">fileItemReaderJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"fileItemReaderJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(fileItemReader())</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ItemReader&lt;TestData&gt; <span class="title">fileItemReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FlatFileItemReader&lt;TestData&gt; reader = <span class="keyword">new</span> FlatFileItemReader&lt;&gt;();</span><br><span class="line">        reader.setResource(<span class="keyword">new</span> ClassPathResource(<span class="string">"file"</span>)); <span class="comment">// è®¾ç½®æ–‡ä»¶èµ„æºåœ°å€</span></span><br><span class="line">        reader.setLinesToSkip(<span class="number">1</span>); <span class="comment">// å¿½ç•¥ç¬¬ä¸€è¡Œ</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// AbstractLineTokenizerçš„ä¸‰ä¸ªå®ç°ç±»ä¹‹ä¸€ï¼Œä»¥å›ºå®šåˆ†éš”ç¬¦å¤„ç†è¡Œæ•°æ®è¯»å–,</span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨é»˜è®¤æ„é€ å™¨çš„æ—¶å€™ï¼Œä½¿ç”¨é€—å·ä½œä¸ºåˆ†éš”ç¬¦ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æœ‰å‚æ„é€ å™¨æ¥æŒ‡å®šåˆ†éš”ç¬¦</span></span><br><span class="line">        DelimitedLineTokenizer tokenizer = <span class="keyword">new</span> DelimitedLineTokenizer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®å±æ€§åï¼Œç±»ä¼¼äºè¡¨å¤´</span></span><br><span class="line">        tokenizer.setNames(<span class="string">"id"</span>, <span class="string">"field1"</span>, <span class="string">"field2"</span>, <span class="string">"field3"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†æ¯è¡Œæ•°æ®è½¬æ¢ä¸ºTestDataå¯¹è±¡</span></span><br><span class="line">        DefaultLineMapper&lt;TestData&gt; mapper = <span class="keyword">new</span> DefaultLineMapper&lt;&gt;();</span><br><span class="line">        <span class="comment">// è®¾ç½®LineTokenizer</span></span><br><span class="line">        mapper.setLineTokenizer(tokenizer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®æ˜ å°„æ–¹å¼ï¼Œå³è¯»å–åˆ°çš„æ–‡æœ¬æ€ä¹ˆè½¬æ¢ä¸ºå¯¹åº”çš„POJO</span></span><br><span class="line">        mapper.setFieldSetMapper(fieldSet -&gt; &#123;</span><br><span class="line">            TestData data = <span class="keyword">new</span> TestData();</span><br><span class="line">            data.setId(fieldSet.readInt(<span class="string">"id"</span>));</span><br><span class="line">            data.setField1(fieldSet.readString(<span class="string">"field1"</span>));</span><br><span class="line">            data.setField2(fieldSet.readString(<span class="string">"field2"</span>));</span><br><span class="line">            data.setField3(fieldSet.readString(<span class="string">"field3"</span>));</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;);</span><br><span class="line">        reader.setLineMapper(mapper);</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨<code>fileItemReader()</code>æ–¹æ³•é‡Œç¼–å†™äº†å…·ä½“çš„æ–‡æœ¬æ•°æ®è¯»å–ä»£ç ï¼Œè¿‡ç¨‹å‚è€ƒæ³¨é‡Šå³å¯ã€‚<code>DelimitedLineTokenizer</code>åˆ†éš”ç¬¦è¡Œå¤„ç†å™¨çš„é»˜è®¤æ„é€ å™¨æºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200307-115347@2x.png" alt="QQ20200307-115347@2x"></p><p>å¸¸é‡<code>DELIMITER_COMMA</code>çš„å€¼ä¸º<code>public static final String DELIMITER_COMMA = &quot;,&quot;;</code>ï¼Œå‡å¦‚æˆ‘ä»¬çš„æ•°æ®å¹¶ä¸æ˜¯ç”¨é€—å·åˆ†éš”ï¼Œè€Œæ˜¯ç”¨<code>|</code>ç­‰å­—ç¬¦åˆ†éš”çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨å®ƒçš„æœ‰å‚æ„é€ å™¨æŒ‡å®šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DelimitedLineTokenizer tokenizer = <span class="keyword">new</span> DelimitedLineTokenizer(<span class="string">"|"</span>);</span><br></pre></td></tr></table></figure><p><code>DelimitedLineTokenizer</code>æ˜¯<code>AbstractLineTokenizer</code>ä¸‰ä¸ªå®ç°ç±»ä¹‹ä¸€ï¼š</p><p><img src="img/QQ20200307-115730@2x.png" alt="QQ20200307-115730@2x"></p><p>é¡¾åæ€ä¹‰ï¼Œ<code>FixedLengthTokenizer</code>é€šè¿‡æŒ‡å®šçš„å›ºå®šé•¿åº¦æ¥æˆªå–æ•°æ®ï¼Œ<code>RegexLineTokenizer</code>é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é…æ•°æ®ï¼Œè¿™é‡Œå°±ä¸æ¼”ç¤ºäº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±ç©ç©ã€‚</p><p>ç¼–å†™å¥½<code>FileItemReaderDemo</code>åï¼Œå¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2020-03-07 12:06:11.876  INFO 29042 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=fileItemReaderJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-07 12:06:11.937  INFO 29042 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">TestData&#123;id=1, field1=&apos;11&apos;, field2=&apos;12&apos;, field3=&apos;13&apos;&#125;</span><br><span class="line">TestData&#123;id=2, field1=&apos;21&apos;, field2=&apos;22&apos;, field3=&apos;23&apos;&#125;</span><br><span class="line">TestData&#123;id=3, field1=&apos;31&apos;, field2=&apos;32&apos;, field3=&apos;33&apos;&#125;</span><br><span class="line">TestData&#123;id=4, field1=&apos;41&apos;, field2=&apos;42&apos;, field3=&apos;43&apos;&#125;</span><br><span class="line">TestData&#123;id=5, field1=&apos;51&apos;, field2=&apos;52&apos;, field3=&apos;53&apos;&#125;</span><br><span class="line">TestData&#123;id=6, field1=&apos;61&apos;, field2=&apos;62&apos;, field3=&apos;63&apos;&#125;</span><br><span class="line">2020-03-07 12:06:12.020  INFO 29042 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 83ms</span><br><span class="line">2020-03-07 12:06:12.044  INFO 29042 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=fileItemReaderJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 146ms</span><br></pre></td></tr></table></figure><p></p><h2 id="æ•°æ®åº“æ•°æ®è¯»å–"><a href="#æ•°æ®åº“æ•°æ®è¯»å–" class="headerlink" title="æ•°æ®åº“æ•°æ®è¯»å–"></a>æ•°æ®åº“æ•°æ®è¯»å–</h2><p>åœ¨æ¼”ç¤ºä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå‡†å¤‡å¥½æµ‹è¯•æ•°æ®ã€‚åœ¨springbatchæ•°æ®åº“ä¸­æ–°å»ºä¸€å¼ TESTè¡¨ï¼ŒSQLè¯­å¥å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for TEST</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`TEST`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`TEST`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'ID'</span>,</span><br><span class="line">  <span class="string">`field1`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'å­—æ®µä¸€'</span>,</span><br><span class="line">  <span class="string">`field2`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'å­—æ®µäºŒ'</span>,</span><br><span class="line">  <span class="string">`field3`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'å­—æ®µä¸‰'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of TEST</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`TEST`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'11'</span>, <span class="string">'12'</span>, <span class="string">'13'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`TEST`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">'21'</span>, <span class="string">'22'</span>, <span class="string">'23'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`TEST`</span> <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">'31'</span>, <span class="string">'32'</span>, <span class="string">'33'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`TEST`</span> <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">'41'</span>, <span class="string">'42'</span>, <span class="string">'43'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`TEST`</span> <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="string">'51'</span>, <span class="string">'52'</span>, <span class="string">'53'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`TEST`</span> <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="string">'61'</span>, <span class="string">'62'</span>, <span class="string">'63'</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><p></p><p>TESTè¡¨çš„å­—æ®µå’Œä¸Šé¢åˆ›å»ºçš„<code>TestData</code>å®ä½“ç±»ä¸€è‡´ã€‚</p><p>ç„¶ååœ¨jobåŒ…ä¸‹æ–°å»º<code>DataSourceItemReaderDemo</code>ç±»ï¼Œæµ‹è¯•ä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceItemReaderDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="comment">// æ³¨å…¥æ•°æ®æº</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">dataSourceItemReaderJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"dataSourceItemReaderJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(dataSourceItemReader())</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ItemReader&lt;TestData&gt; <span class="title">dataSourceItemReader</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        JdbcPagingItemReader&lt;TestData&gt; reader = <span class="keyword">new</span> JdbcPagingItemReader&lt;&gt;();</span><br><span class="line">        reader.setDataSource(dataSource); <span class="comment">// è®¾ç½®æ•°æ®æº</span></span><br><span class="line">        reader.setFetchSize(<span class="number">5</span>); <span class="comment">// æ¯æ¬¡å–å¤šå°‘æ¡è®°å½•</span></span><br><span class="line">        reader.setPageSize(<span class="number">5</span>); <span class="comment">// è®¾ç½®æ¯é¡µæ•°æ®é‡</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŒ‡å®šsqlæŸ¥è¯¢è¯­å¥ select id,field1,field2,field3 from TEST</span></span><br><span class="line">        MySqlPagingQueryProvider provider = <span class="keyword">new</span> MySqlPagingQueryProvider();</span><br><span class="line">        provider.setSelectClause(<span class="string">"id,field1,field2,field3"</span>); <span class="comment">//è®¾ç½®æŸ¥è¯¢å­—æ®µ</span></span><br><span class="line">        provider.setFromClause(<span class="string">"from TEST"</span>); <span class="comment">// è®¾ç½®ä»å“ªå¼ è¡¨æŸ¥è¯¢</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†è¯»å–åˆ°çš„æ•°æ®è½¬æ¢ä¸ºTestDataå¯¹è±¡</span></span><br><span class="line">        reader.setRowMapper((resultSet, rowNum) -&gt; &#123;</span><br><span class="line">            TestData data = <span class="keyword">new</span> TestData();</span><br><span class="line">            data.setId(resultSet.getInt(<span class="number">1</span>));</span><br><span class="line">            data.setField1(resultSet.getString(<span class="number">2</span>)); <span class="comment">// è¯»å–ç¬¬ä¸€ä¸ªå­—æ®µï¼Œç±»å‹ä¸ºString</span></span><br><span class="line">            data.setField2(resultSet.getString(<span class="number">3</span>));</span><br><span class="line">            data.setField3(resultSet.getString(<span class="number">4</span>));</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Order&gt; sort = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        sort.put(<span class="string">"id"</span>, Order.ASCENDING);</span><br><span class="line">        provider.setSortKeys(sort); <span class="comment">// è®¾ç½®æ’åº,é€šè¿‡id å‡åº</span></span><br><span class="line"></span><br><span class="line">        reader.setQueryProvider(provider);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®namedParameterJdbcTemplateç­‰å±æ€§</span></span><br><span class="line">        reader.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>dataSourceItemReader()</code>æ–¹æ³•ä¸­çš„ä¸»è¦æ­¥éª¤å°±æ˜¯ï¼šé€šè¿‡<code>JdbcPagingItemReader</code>è®¾ç½®å¯¹åº”çš„æ•°æ®æºï¼Œç„¶åè®¾ç½®æ•°æ®é‡ã€è·å–æ•°æ®çš„sqlè¯­å¥ã€æ’åºè§„åˆ™å’ŒæŸ¥è¯¢ç»“æœä¸POJOçš„æ˜ å°„è§„åˆ™ç­‰ã€‚æ–¹æ³•æœ«å°¾ä¹‹æ‰€ä»¥éœ€è¦è°ƒç”¨<code>JdbcPagingItemReader</code>çš„<code>afterPropertiesSet()</code>æ–¹æ³•æ˜¯å› ä¸ºéœ€è¦è®¾ç½®JDBCæ¨¡æ¿ï¼ˆ<code>afterPropertiesSet()</code>æ–¹æ³•æºç ï¼‰ï¼š</p><p><img src="img/QQ20200307-155834@2x.png" alt="QQ20200307-155834@2x"></p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2020-03-07 16:01:05.366  INFO 30264 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=dataSourceItemReaderJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-07 16:01:05.420  INFO 30264 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">TestData&#123;id=1, field1=&apos;11&apos;, field2=&apos;12&apos;, field3=&apos;13&apos;&#125;</span><br><span class="line">TestData&#123;id=2, field1=&apos;21&apos;, field2=&apos;22&apos;, field3=&apos;23&apos;&#125;</span><br><span class="line">TestData&#123;id=3, field1=&apos;31&apos;, field2=&apos;32&apos;, field3=&apos;33&apos;&#125;</span><br><span class="line">TestData&#123;id=4, field1=&apos;41&apos;, field2=&apos;42&apos;, field3=&apos;43&apos;&#125;</span><br><span class="line">TestData&#123;id=5, field1=&apos;51&apos;, field2=&apos;52&apos;, field3=&apos;53&apos;&#125;</span><br><span class="line">TestData&#123;id=6, field1=&apos;61&apos;, field2=&apos;62&apos;, field3=&apos;63&apos;&#125;</span><br><span class="line">2020-03-07 16:01:05.512  INFO 30264 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 92ms</span><br><span class="line">2020-03-07 16:01:05.534  INFO 30264 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=dataSourceItemReaderJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 147ms</span><br></pre></td></tr></table></figure><p></p><h2 id="XMLæ•°æ®è¯»å–"><a href="#XMLæ•°æ®è¯»å–" class="headerlink" title="XMLæ•°æ®è¯»å–"></a>XMLæ•°æ®è¯»å–</h2><p>Spring Batchå€ŸåŠ©Spring OXMå¯ä»¥è½»æ¾åœ°å®ç°xmlæ ¼å¼æ•°æ®æ–‡ä»¶è¯»å–ã€‚åœ¨resourcesç›®å½•ä¸‹æ–°å»ºfile.xmlï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tests</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">test</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field1</span>&gt;</span>11<span class="tag">&lt;/<span class="name">field1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field2</span>&gt;</span>12<span class="tag">&lt;/<span class="name">field2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field3</span>&gt;</span>13<span class="tag">&lt;/<span class="name">field3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">test</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field1</span>&gt;</span>21<span class="tag">&lt;/<span class="name">field1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field2</span>&gt;</span>22<span class="tag">&lt;/<span class="name">field2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field3</span>&gt;</span>23<span class="tag">&lt;/<span class="name">field3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">test</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>3<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field1</span>&gt;</span>31<span class="tag">&lt;/<span class="name">field1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field2</span>&gt;</span>32<span class="tag">&lt;/<span class="name">field2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field3</span>&gt;</span>33<span class="tag">&lt;/<span class="name">field3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">test</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>4<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field1</span>&gt;</span>41<span class="tag">&lt;/<span class="name">field1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field2</span>&gt;</span>42<span class="tag">&lt;/<span class="name">field2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field3</span>&gt;</span>43<span class="tag">&lt;/<span class="name">field3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">test</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>5<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field1</span>&gt;</span>51<span class="tag">&lt;/<span class="name">field1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field2</span>&gt;</span>52<span class="tag">&lt;/<span class="name">field2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field3</span>&gt;</span>53<span class="tag">&lt;/<span class="name">field3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">test</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>6<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field1</span>&gt;</span>61<span class="tag">&lt;/<span class="name">field1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field2</span>&gt;</span>62<span class="tag">&lt;/<span class="name">field2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field3</span>&gt;</span>63<span class="tag">&lt;/<span class="name">field3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tests</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>xmlæ–‡ä»¶å†…å®¹ç”±ä¸€ç»„ä¸€ç»„çš„<code>&lt;test&gt;&lt;/test&gt;</code>æ ‡ç­¾ç»„æˆï¼Œ<code>&lt;test&gt;</code>æ ‡ç­¾åˆåŒ…å«å››ç»„å­æ ‡ç­¾ï¼Œæ ‡ç­¾åç§°å’Œ<code>TestData</code>å®ä½“ç±»å±æ€§ä¸€ä¸€å¯¹åº”ã€‚</p><p>å‡†å¤‡å¥½xmlæ–‡ä»¶åï¼Œæˆ‘ä»¬åœ¨pomä¸­å¼•å…¥spring-oxmä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-oxm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.thoughtworks.xstream<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xstream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.11.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€åœ¨jobåŒ…ä¸‹æ–°å»º<code>XmlFileItemReaderDemo</code>ï¼Œæ¼”ç¤ºxmlæ–‡ä»¶æ•°æ®è·å–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlFileItemReaderDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">xmlFileItemReaderJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"xmlFileItemReaderJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(xmlFileItemReader())</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ItemReader&lt;TestData&gt; <span class="title">xmlFileItemReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StaxEventItemReader&lt;TestData&gt; reader = <span class="keyword">new</span> StaxEventItemReader&lt;&gt;();</span><br><span class="line">        reader.setResource(<span class="keyword">new</span> ClassPathResource(<span class="string">"file.xml"</span>)); <span class="comment">// è®¾ç½®xmlæ–‡ä»¶æº</span></span><br><span class="line">        reader.setFragmentRootElementName(<span class="string">"test"</span>); <span class="comment">// æŒ‡å®šxmlæ–‡ä»¶çš„æ ¹æ ‡ç­¾</span></span><br><span class="line">        <span class="comment">// å°†xmlæ•°æ®è½¬æ¢ä¸ºTestDataå¯¹è±¡</span></span><br><span class="line">        XStreamMarshaller marshaller = <span class="keyword">new</span> XStreamMarshaller();</span><br><span class="line">        <span class="comment">// æŒ‡å®šéœ€è¦è½¬æ¢çš„ç›®æ ‡æ•°æ®ç±»å‹</span></span><br><span class="line">        Map&lt;String, Class&lt;TestData&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        map.put(<span class="string">"test"</span>, TestData.class);</span><br><span class="line">        marshaller.setAliases(map);</span><br><span class="line"></span><br><span class="line">        reader.setUnmarshaller(marshaller);</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨<code>xmlFileItemReader()</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>StaxEventItemReader</code>è¯»å–xmlæ–‡ä»¶ï¼Œä»£ç è¾ƒç®€å•ï¼Œçœ‹æ³¨é‡Šå³å¯ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">020-03-07 16:23:47.775  INFO 30450 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=xmlFileItemReaderJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-07 16:23:47.820  INFO 30450 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">TestData&#123;id=1, field1=&apos;11&apos;, field2=&apos;12&apos;, field3=&apos;13&apos;&#125;</span><br><span class="line">TestData&#123;id=2, field1=&apos;21&apos;, field2=&apos;22&apos;, field3=&apos;23&apos;&#125;</span><br><span class="line">TestData&#123;id=3, field1=&apos;31&apos;, field2=&apos;32&apos;, field3=&apos;33&apos;&#125;</span><br><span class="line">TestData&#123;id=4, field1=&apos;41&apos;, field2=&apos;42&apos;, field3=&apos;43&apos;&#125;</span><br><span class="line">TestData&#123;id=5, field1=&apos;51&apos;, field2=&apos;52&apos;, field3=&apos;53&apos;&#125;</span><br><span class="line">TestData&#123;id=6, field1=&apos;61&apos;, field2=&apos;62&apos;, field3=&apos;63&apos;&#125;</span><br><span class="line">2020-03-07 16:23:47.961  INFO 30450 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 140ms</span><br><span class="line">2020-03-07 16:23:47.984  INFO 30450 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=xmlFileItemReaderJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 200ms</span><br></pre></td></tr></table></figure><p></p><h2 id="JSONæ•°æ®è¯»å–"><a href="#JSONæ•°æ®è¯»å–" class="headerlink" title="JSONæ•°æ®è¯»å–"></a>JSONæ•°æ®è¯»å–</h2><p>åœ¨resourcesç›®å½•ä¸‹æ–°å»ºfile.jsonæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"field1"</span>: <span class="string">"11"</span>,</span><br><span class="line">    <span class="attr">"field2"</span>: <span class="string">"12"</span>,</span><br><span class="line">    <span class="attr">"field3"</span>: <span class="string">"13"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"field1"</span>: <span class="string">"21"</span>,</span><br><span class="line">    <span class="attr">"field2"</span>: <span class="string">"22"</span>,</span><br><span class="line">    <span class="attr">"field3"</span>: <span class="string">"23"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"field1"</span>: <span class="string">"31"</span>,</span><br><span class="line">    <span class="attr">"field2"</span>: <span class="string">"32"</span>,</span><br><span class="line">    <span class="attr">"field3"</span>: <span class="string">"33"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p></p><p>JSONå¯¹è±¡å±æ€§å’ŒTestDataå¯¹è±¡å±æ€§ä¸€ä¸€å¯¹åº”ã€‚åœ¨jobåŒ…ä¸‹æ–°å»º<code>JSONFileItemReaderDemo</code>ï¼Œç”¨äºæµ‹è¯•JSONæ–‡ä»¶æ•°æ®è¯»å–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JSONFileItemReaderDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">jsonFileItemReaderJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"jsonFileItemReaderJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(jsonItemReader())</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ItemReader&lt;TestData&gt; <span class="title">jsonItemReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®jsonæ–‡ä»¶åœ°å€</span></span><br><span class="line">        ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">"file.json"</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½®jsonæ–‡ä»¶è½¬æ¢çš„ç›®æ ‡å¯¹è±¡ç±»å‹</span></span><br><span class="line">        JacksonJsonObjectReader&lt;TestData&gt; jacksonJsonObjectReader = <span class="keyword">new</span> JacksonJsonObjectReader&lt;&gt;(TestData.class);</span><br><span class="line">        JsonItemReader&lt;TestData&gt; reader = <span class="keyword">new</span> JsonItemReader&lt;&gt;(resource, jacksonJsonObjectReader);</span><br><span class="line">        <span class="comment">// ç»™readerè®¾ç½®ä¸€ä¸ªåˆ«å</span></span><br><span class="line">        reader.setName(<span class="string">"testDataJsonItemReader"</span>);</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2020-03-07 16:40:52.508  INFO 30599 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=jsonFileItemReaderJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-07 16:40:52.554  INFO 30599 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">TestData&#123;id=1, field1=&apos;11&apos;, field2=&apos;12&apos;, field3=&apos;13&apos;&#125;</span><br><span class="line">TestData&#123;id=2, field1=&apos;21&apos;, field2=&apos;22&apos;, field3=&apos;23&apos;&#125;</span><br><span class="line">TestData&#123;id=3, field1=&apos;31&apos;, field2=&apos;32&apos;, field3=&apos;33&apos;&#125;</span><br><span class="line">2020-03-07 16:40:52.622  INFO 30599 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 67ms</span><br><span class="line">2020-03-07 16:40:52.642  INFO 30599 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=jsonFileItemReaderJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 124ms</span><br></pre></td></tr></table></figure><p></p><h2 id="å¤šæ–‡æœ¬æ•°æ®è¯»å–"><a href="#å¤šæ–‡æœ¬æ•°æ®è¯»å–" class="headerlink" title="å¤šæ–‡æœ¬æ•°æ®è¯»å–"></a>å¤šæ–‡æœ¬æ•°æ®è¯»å–</h2><p>å¤šæ–‡æœ¬çš„æ•°æ®è¯»å–æœ¬è´¨è¿˜æ˜¯å•æ–‡ä»¶æ•°æ®è¯»å–ï¼ŒåŒºåˆ«å°±æ˜¯å¤šæ–‡ä»¶è¯»å–éœ€è¦åœ¨å•æ–‡ä»¶è¯»å–çš„æ–¹å¼ä¸Šè®¾ç½®ä¸€å±‚ä»£ç†ã€‚</p><p>åœ¨resourcesç›®å½•ä¸‹æ–°å»ºä¸¤ä¸ªæ–‡ä»¶file1å’Œfile2ï¼Œfile1å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// æ¼”ç¤ºæ–‡ä»¶æ•°æ®è¯»å–</span><br><span class="line">1,11,12,13</span><br><span class="line">2,21,22,23</span><br><span class="line">3,31,32,33</span><br><span class="line">4,41,42,43</span><br><span class="line">5,51,52,53</span><br><span class="line">6,61,62,63</span><br></pre></td></tr></table></figure><p></p><p>file2å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// æ¼”ç¤ºæ–‡ä»¶æ•°æ®è¯»å–</span><br><span class="line">7,71,72,73</span><br><span class="line">8,81,82,83</span><br></pre></td></tr></table></figure><p></p><p>ç„¶ååœ¨jobåŒ…ä¸‹æ–°å»º<code>MultiFileIteamReaderDemo</code>ï¼Œæ¼”ç¤ºå¤šæ–‡ä»¶æ•°æ®è¯»å–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiFileIteamReaderDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">multiFileItemReaderJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"multiFileItemReaderJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .&lt;TestData, TestData&gt;chunk(<span class="number">2</span>)</span><br><span class="line">                .reader(multiFileItemReader())</span><br><span class="line">                .writer(list -&gt; list.forEach(System.out::println))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ItemReader&lt;TestData&gt; <span class="title">multiFileItemReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MultiResourceItemReader&lt;TestData&gt; reader = <span class="keyword">new</span> MultiResourceItemReader&lt;&gt;();</span><br><span class="line">        reader.setDelegate(fileItemReader()); <span class="comment">// è®¾ç½®æ–‡ä»¶è¯»å–ä»£ç†ï¼Œæ–¹æ³•å¯ä»¥ä½¿ç”¨å‰é¢æ–‡ä»¶è¯»å–ä¸­çš„ä¾‹å­</span></span><br><span class="line"></span><br><span class="line">        Resource[] resources = <span class="keyword">new</span> Resource[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ClassPathResource(<span class="string">"file1"</span>),</span><br><span class="line">                <span class="keyword">new</span> ClassPathResource(<span class="string">"file2"</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        reader.setResources(resources); <span class="comment">// è®¾ç½®å¤šæ–‡ä»¶æº</span></span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> FlatFileItemReader&lt;TestData&gt; <span class="title">fileItemReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FlatFileItemReader&lt;TestData&gt; reader = <span class="keyword">new</span> FlatFileItemReader&lt;&gt;();</span><br><span class="line">        reader.setLinesToSkip(<span class="number">1</span>); <span class="comment">// å¿½ç•¥ç¬¬ä¸€è¡Œ</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// AbstractLineTokenizerçš„ä¸‰ä¸ªå®ç°ç±»ä¹‹ä¸€ï¼Œä»¥å›ºå®šåˆ†éš”ç¬¦å¤„ç†è¡Œæ•°æ®è¯»å–,</span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨é»˜è®¤æ„é€ å™¨çš„æ—¶å€™ï¼Œä½¿ç”¨é€—å·ä½œä¸ºåˆ†éš”ç¬¦ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æœ‰å‚æ„é€ å™¨æ¥æŒ‡å®šåˆ†éš”ç¬¦</span></span><br><span class="line">        DelimitedLineTokenizer tokenizer = <span class="keyword">new</span> DelimitedLineTokenizer();</span><br><span class="line">        <span class="comment">// è®¾ç½®å±å§“åï¼Œç±»ä¼¼äºè¡¨å¤´</span></span><br><span class="line">        tokenizer.setNames(<span class="string">"id"</span>, <span class="string">"field1"</span>, <span class="string">"field2"</span>, <span class="string">"field3"</span>);</span><br><span class="line">        <span class="comment">// å°†æ¯è¡Œæ•°æ®è½¬æ¢ä¸ºTestDataå¯¹è±¡</span></span><br><span class="line">        DefaultLineMapper&lt;TestData&gt; mapper = <span class="keyword">new</span> DefaultLineMapper&lt;&gt;();</span><br><span class="line">        mapper.setLineTokenizer(tokenizer);</span><br><span class="line">        <span class="comment">// è®¾ç½®æ˜ å°„æ–¹å¼</span></span><br><span class="line">        mapper.setFieldSetMapper(fieldSet -&gt; &#123;</span><br><span class="line">            TestData data = <span class="keyword">new</span> TestData();</span><br><span class="line">            data.setId(fieldSet.readInt(<span class="string">"id"</span>));</span><br><span class="line">            data.setField1(fieldSet.readString(<span class="string">"field1"</span>));</span><br><span class="line">            data.setField2(fieldSet.readString(<span class="string">"field2"</span>));</span><br><span class="line">            data.setField3(fieldSet.readString(<span class="string">"field3"</span>));</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        reader.setLineMapper(mapper);</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­<code>fileItemReader()</code>æ–¹æ³•åœ¨<strong>æ–‡æœ¬æ•°æ®è¯»å–</strong>ä¸­ä»‹ç»è¿‡äº†ï¼Œå¤šæ–‡ä»¶è¯»å–çš„å…³é”®åœ¨äº<code>multiFileItemReader()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•é€šè¿‡<code>MultiResourceItemReader</code>å¯¹è±¡è®¾ç½®äº†å¤šä¸ªæ–‡ä»¶çš„ç›®æ ‡åœ°å€ï¼Œå¹¶ä¸”å°†å•æ–‡ä»¶çš„è¯»å–æ–¹å¼è®¾ç½®ä¸ºä»£ç†ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2020-03-07 16:55:24.480  INFO 30749 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=multiFileItemReaderJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-07 16:55:24.536  INFO 30749 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">TestData&#123;id=1, field1=&apos;11&apos;, field2=&apos;12&apos;, field3=&apos;13&apos;&#125;</span><br><span class="line">TestData&#123;id=2, field1=&apos;21&apos;, field2=&apos;22&apos;, field3=&apos;23&apos;&#125;</span><br><span class="line">TestData&#123;id=3, field1=&apos;31&apos;, field2=&apos;32&apos;, field3=&apos;33&apos;&#125;</span><br><span class="line">TestData&#123;id=4, field1=&apos;41&apos;, field2=&apos;42&apos;, field3=&apos;43&apos;&#125;</span><br><span class="line">TestData&#123;id=5, field1=&apos;51&apos;, field2=&apos;52&apos;, field3=&apos;53&apos;&#125;</span><br><span class="line">TestData&#123;id=6, field1=&apos;61&apos;, field2=&apos;62&apos;, field3=&apos;63&apos;&#125;</span><br><span class="line">TestData&#123;id=7, field1=&apos;71&apos;, field2=&apos;72&apos;, field3=&apos;73&apos;&#125;</span><br><span class="line">TestData&#123;id=8, field1=&apos;81&apos;, field2=&apos;82&apos;, field3=&apos;83&apos;&#125;</span><br><span class="line">2020-03-07 16:55:24.617  INFO 30749 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 81ms</span><br><span class="line">2020-03-07 16:55:24.643  INFO 30749 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=multiFileItemReaderJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 153ms</span><br></pre></td></tr></table></figure><p></p><blockquote><p>æœ¬èŠ‚æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/68.spring-batch-itemreader" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/68.spring-batch-itemreader</a>ã€‚</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Spring Batchè¯»å–æ•°æ®é€šè¿‡ItemReaderæ¥å£çš„å®ç°ç±»æ¥å®Œæˆï¼ŒåŒ…æ‹¬FlatFileItemReaderæ–‡æœ¬æ•°æ®è¯»å–ã€StaxEventItemReader XMLæ–‡ä»¶æ•°æ®è¯»å–ã€JsonItemReader JSONæ–‡ä»¶æ•°æ®è¯»å–ã€JdbcPagingItemReaderæ•°æ®åº“åˆ†é¡µæ•°æ®è¯»å–ç­‰å®ç°ï¼Œæ›´å¤šå¯ç”¨çš„å®ç°å¯ä»¥å‚è€ƒï¼š&lt;a href=&quot;https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/appendix.html#itemReadersAppendix&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/appendix.html#itemReadersAppendix&lt;/a&gt;ï¼Œæœ¬æ–‡åªä»‹ç»è¿™å››ç§æ¯”è¾ƒå¸¸ç”¨çš„è¯»å–æ•°æ®æ–¹å¼ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
      <category term="Spring Batch" scheme="http://mrbird.cc/tags/Spring-Batch/"/>
    
  </entry>
  
  <entry>
    <title>Spring Batchå…¥é—¨</title>
    <link href="http://mrbird.cc/Spring-Batch%E5%85%A5%E9%97%A8.html"/>
    <id>http://mrbird.cc/Spring-Batchå…¥é—¨.html</id>
    <published>2020-03-06T03:53:53.000Z</published>
    <updated>2020-03-12T03:33:09.813Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --><p>ä¼ä¸šä¸­ç»å¸¸ä¼šæœ‰éœ€è¦æ‰¹å¤„ç†æ‰èƒ½å®Œæˆçš„ä¸šåŠ¡æ“ä½œï¼Œæ¯”å¦‚ï¼šè‡ªåŠ¨åŒ–åœ°å¤„ç†å¤§æ‰¹é‡å¤æ‚çš„æ•°æ®ï¼Œå¦‚æœˆç»“è®¡ç®—ï¼›é‡å¤æ€§åœ°å¤„ç†å¤§æ‰¹é‡æ•°æ®ï¼Œå¦‚è´¹ç‡è®¡ç®—ï¼›å……å½“å†…éƒ¨ç³»ç»Ÿå’Œå¤–éƒ¨ç³»ç»Ÿçš„æ•°æ®çº½å¸¦ï¼Œä¸­é—´éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ ¼å¼åŒ–ï¼Œæ ¡éªŒï¼Œè½¬æ¢å¤„ç†ç­‰ã€‚</p><p>Spring Batchæ˜¯ä¸€ä¸ªè½»é‡çº§ä½†åŠŸèƒ½åˆååˆ†å…¨é¢çš„æ‰¹å¤„ç†æ¡†æ¶ï¼Œæœ¬èŠ‚æˆ‘ä»¬å°†é€šè¿‡ä¸€äº›ç®€å•çš„ä¾‹å­æ¥å…¥é—¨Spring Batchã€‚</p><a id="more"></a><h2 id="æ¡†æ¶æ­å»º"><a href="#æ¡†æ¶æ­å»º" class="headerlink" title="æ¡†æ¶æ­å»º"></a>æ¡†æ¶æ­å»º</h2><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º2.2.4.RELEASEï¼ŒartifactIdä¸ºspring-batch-startï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200306-095608@2x.png" alt="QQ20200306-095608@2x"></p><p>ç„¶ååœ¨pomä¸­å¼•å…¥Spring Batchã€MySQLå’ŒJDBCä¾èµ–ï¼Œå¼•å…¥åpomå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-batch-start<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>spring-batch-start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-batch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>åœ¨ç¼–å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•äº†è§£ä¸‹Spring Batchçš„ç»„æˆï¼š</p><p><img src="img/QQ20200306-095955@2x.png" alt="QQ20200306-095955@2x"></p><p>Spring Batché‡Œæœ€åŸºæœ¬çš„å•å…ƒå°±æ˜¯ä»»åŠ¡Jobï¼Œä¸€ä¸ªJobç”±è‹¥å¹²ä¸ªæ­¥éª¤Stepç»„æˆã€‚ä»»åŠ¡å¯åŠ¨å™¨Job Launcherè´Ÿè´£è¿è¡ŒJobï¼Œä»»åŠ¡å­˜å‚¨ä»“åº“Job Repositoryå­˜å‚¨ç€Jobçš„æ‰§è¡ŒçŠ¶æ€ï¼Œå‚æ•°å’Œæ—¥å¿—ç­‰ä¿¡æ¯ã€‚Jobå¤„ç†ä»»åŠ¡åˆå¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»ï¼šæ•°æ®è¯»å–Item Readerã€æ•°æ®ä¸­é—´å¤„ç†Item Processorå’Œæ•°æ®è¾“å‡ºItem Writerã€‚</p><p>ä»»åŠ¡å­˜å‚¨ä»“åº“å¯ä»¥æ˜¯å…³ç³»å‹æ•°æ®åº“MySQLï¼Œéå…³ç³»å‹æ•°æ®åº“MongoDBæˆ–è€…ç›´æ¥å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæœ¬ç¯‡ä½¿ç”¨çš„æ˜¯MySQLä½œä¸ºä»»åŠ¡å­˜å‚¨ä»“åº“ã€‚</p><p>æ–°å»ºä¸€ä¸ªåç§°ä¸ºspringbatchçš„MySQLæ•°æ®åº“ï¼Œç„¶åå¯¼å…¥org.springframework.batch.coreç›®å½•ä¸‹çš„schema-mysql.sqlæ–‡ä»¶ï¼š</p><p><img src="img/QQ20200306-102358@2x.png" alt="QQ20200306-102358@2x"> <img src="img/QQ20200306-102828@2x.png" alt="QQ20200306-102828@2x"></p><p>å¯¼å…¥åï¼Œåº“è¡¨å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200306-102603@2x.png" alt="QQ20200306-102603@2x"></p><p>ç„¶ååœ¨é¡¹ç›®çš„é…ç½®æ–‡ä»¶application.ymlé‡Œæ·»åŠ MySQLç›¸å…³é…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">jdbc:mysql://127.0.0.1:3306/springbatch</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€åœ¨Spring Bootçš„å…¥å£ç±»ä¸Šæ·»åŠ <code>@EnableBatchProcessing</code>æ³¨è§£ï¼Œè¡¨ç¤ºå¼€å¯Spring Batchæ‰¹å¤„ç†åŠŸèƒ½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableBatchProcessing</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBatchStartApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringBatchStartApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è‡³æ­¤ï¼ŒåŸºæœ¬æ¡†æ¶æ­å»ºå¥½äº†ï¼Œä¸‹é¢å¼€å§‹é…ç½®ä¸€ä¸ªç®€å•çš„ä»»åŠ¡ã€‚</p><h2 id="ç¼–å†™ç¬¬ä¸€ä¸ªä»»åŠ¡"><a href="#ç¼–å†™ç¬¬ä¸€ä¸ªä»»åŠ¡" class="headerlink" title="ç¼–å†™ç¬¬ä¸€ä¸ªä»»åŠ¡"></a>ç¼–å†™ç¬¬ä¸€ä¸ªä»»åŠ¡</h2><p>åœ¨cc.mrbird.batchç›®å½•ä¸‹æ–°å»ºjobåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»ºä¸€ä¸ªFirstJobDemoç±»ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstJobDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">firstJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"firstJob"</span>)</span><br><span class="line">                .start(step())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step"</span>)</span><br><span class="line">                .tasklet((contribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤...."</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ³¨å…¥äº†<code>JobBuilderFactory</code>ä»»åŠ¡åˆ›å»ºå·¥å‚å’Œ<code>StepBuilderFactory</code>æ­¥éª¤åˆ›å»ºå·¥å‚ï¼Œåˆ†åˆ«ç”¨äºåˆ›å»ºä»»åŠ¡Jobå’Œæ­¥éª¤Stepã€‚<code>JobBuilderFactory</code>çš„<code>get</code>æ–¹æ³•ç”¨äºåˆ›å»ºä¸€ä¸ªæŒ‡å®šåç§°çš„ä»»åŠ¡ï¼Œ<code>start</code>æ–¹æ³•æŒ‡å®šä»»åŠ¡çš„å¼€å§‹æ­¥éª¤ï¼Œæ­¥éª¤é€šè¿‡<code>StepBuilderFactory</code>æ„å»ºã€‚</p><p>æ­¥éª¤Stepç”±è‹¥å¹²ä¸ªå°ä»»åŠ¡Taskletç»„æˆï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡<code>tasklet</code>æ–¹æ³•åˆ›å»ºã€‚<code>tasklet</code>æ–¹æ³•æ¥æ”¶ä¸€ä¸ª<code>Tasklet</code>ç±»å‹å‚æ•°ï¼Œ<code>Tasklet</code>æ˜¯ä¸€ä¸ªå‡½æ•°æ˜¯æ¥å£ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Tasklet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">RepeatStatus <span class="title">execute</span><span class="params">(StepContribution contribution, ChunkContext chunkContext)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨lambdaè¡¨è¾¾å¼åˆ›å»ºä¸€ä¸ªåŒ¿åå®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(contribution, chunkContext) -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤...."</span>);</span><br><span class="line">    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¯¥åŒ¿åå®ç°å¿…é¡»è¿”å›ä¸€ä¸ªæ˜ç¡®çš„æ‰§è¡ŒçŠ¶æ€ï¼Œè¿™é‡Œè¿”å›<code>RepeatStatus.FINISHED</code>è¡¨ç¤ºè¯¥å°ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œæ­£å¸¸ç»“æŸã€‚</p><p>æ­¤å¤–ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬é…ç½®çš„ä»»åŠ¡Jobå¿…é¡»æ³¨å†Œåˆ°Spring IOCå®¹å™¨ä¸­ï¼Œå¹¶ä¸”ä»»åŠ¡çš„åç§°å’Œæ­¥éª¤çš„åç§°ç»„æˆå”¯ä¸€ã€‚æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡åç§°ä¸ºfirstJobï¼Œæ­¥éª¤çš„åç§°ä¸ºstepï¼Œå¦‚æœå­˜åœ¨åˆ«çš„ä»»åŠ¡å’Œæ­¥éª¤ç»„åˆä¹Ÿå«è¿™ä¸ªåç§°çš„è¯ï¼Œåˆ™ä¼šæ‰§è¡Œå¤±è´¥ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">2020-03-06 11:01:11.785  INFO 17324 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=firstJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-06 11:01:11.846  INFO 17324 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤....</span><br><span class="line">2020-03-06 11:01:11.886  INFO 17324 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step] executed in 40ms</span><br><span class="line">2020-03-06 11:01:11.909  INFO 17324 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=firstJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 101ms</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œä»»åŠ¡æˆåŠŸæ‰§è¡Œäº†ï¼Œæ•°æ®åº“çš„åº“è¡¨ä¹Ÿå°†è®°å½•ç›¸å…³è¿è¡Œæ—¥å¿—ã€‚</p><div class="note danger">é‡æ–°å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°å¹¶ä¸ä¼šå†æ¬¡æ‰“å°å‡ºä»»åŠ¡æ‰§è¡Œæ—¥å¿—ï¼Œå› ä¸ºJobåç§°å’Œ Stepåç§°ç»„æˆå”¯ä¸€ï¼Œæ‰§è¡Œå®Œçš„ä¸å¯é‡å¤çš„ä»»åŠ¡ï¼Œä¸ä¼šå†æ¬¡æ‰§è¡Œã€‚</div><h2 id="å¤šæ­¥éª¤ä»»åŠ¡"><a href="#å¤šæ­¥éª¤ä»»åŠ¡" class="headerlink" title="å¤šæ­¥éª¤ä»»åŠ¡"></a>å¤šæ­¥éª¤ä»»åŠ¡</h2><p>ä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡ä¸€èˆ¬åŒ…å«å¤šä¸ªæ­¥éª¤ï¼Œä¸‹é¢ä¸¾ä¸ªå¤šæ­¥éª¤ä»»åŠ¡çš„ä¾‹å­ã€‚åœ¨jobåŒ…ä¸‹æ–°å»º<code>MultiStepJobDemo</code>ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiStepJobDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">multiStepJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"multiStepJob"</span>)</span><br><span class="line">                .start(step1())</span><br><span class="line">                .next(step2())</span><br><span class="line">                .next(step3())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step1"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤ä¸€æ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step2"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤äºŒæ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step3"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤ä¸‰æ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>step1()</code>ã€<code>step2()</code>å’Œ<code>step3()</code>ä¸‰ä¸ªæ–¹æ³•åˆ›å»ºäº†ä¸‰ä¸ªæ­¥éª¤ã€‚Jobé‡Œè¦ä½¿ç”¨è¿™äº›æ­¥éª¤ï¼Œåªéœ€è¦é€šè¿‡<code>JobBuilderFactory</code>çš„<code>start</code>æ–¹æ³•æŒ‡å®šç¬¬ä¸€ä¸ªæ­¥éª¤ï¼Œç„¶åé€šè¿‡<code>next</code>æ–¹æ³•ä¸æ–­åœ°æŒ‡å®šä¸‹ä¸€ä¸ªæ­¥éª¤å³å¯ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2020-03-06 13:52:52.188  INFO 18472 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=multiStepJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-06 13:52:52.222  INFO 18472 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step1]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤ä¸€æ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 13:52:52.251  INFO 18472 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step1] executed in 29ms</span><br><span class="line">2020-03-06 13:52:52.292  INFO 18472 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step2]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤äºŒæ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 13:52:52.323  INFO 18472 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step2] executed in 30ms</span><br><span class="line">2020-03-06 13:52:52.375  INFO 18472 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step3]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤ä¸‰æ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 13:52:52.405  INFO 18472 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step3] executed in 29ms</span><br><span class="line">2020-03-06 13:52:52.428  INFO 18472 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=multiStepJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 231ms</span><br></pre></td></tr></table></figure><p></p><p>ä¸‰ä¸ªæ­¥éª¤ä¾æ¬¡æ‰§è¡ŒæˆåŠŸã€‚</p><p>å¤šä¸ªæ­¥éª¤åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¹Ÿå¯ä»¥é€šè¿‡ä¸Šä¸€ä¸ªæ­¥éª¤çš„æ‰§è¡ŒçŠ¶æ€æ¥å†³å®šæ˜¯å¦æ‰§è¡Œä¸‹ä¸€ä¸ªæ­¥éª¤ï¼Œä¿®æ”¹ä¸Šé¢çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiStepJobDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">multiStepJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"multiStepJob2"</span>)</span><br><span class="line">                .start(step1())</span><br><span class="line">                .on(ExitStatus.COMPLETED.getExitCode()).to(step2())</span><br><span class="line">                .from(step2())</span><br><span class="line">                .on(ExitStatus.COMPLETED.getExitCode()).to(step3())</span><br><span class="line">                .from(step3()).end()</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step1"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤ä¸€æ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step2"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤äºŒæ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step3"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤ä¸‰æ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>multiStepJob()</code>æ–¹æ³•çš„å«ä¹‰æ˜¯ï¼šmultiStepJob2ä»»åŠ¡å…ˆæ‰§è¡Œstep1ï¼Œå½“step1çŠ¶æ€ä¸ºå®Œæˆæ—¶ï¼Œæ¥ç€æ‰§è¡Œstep2ï¼Œå½“step2çš„çŠ¶æ€ä¸ºå®Œæˆæ—¶ï¼Œæ¥ç€æ‰§è¡Œstep3ã€‚<code>ExitStatus.COMPLETED</code>å¸¸é‡è¡¨ç¤ºä»»åŠ¡é¡ºåˆ©æ‰§è¡Œå®Œæ¯•ï¼Œæ­£å¸¸é€€å‡ºï¼Œè¯¥ç±»è¿˜åŒ…å«ä»¥ä¸‹å‡ ç§é€€å‡ºçŠ¶æ€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExitStatus</span> <span class="keyword">implements</span> <span class="title">Serializable</span>, <span class="title">Comparable</span>&lt;<span class="title">ExitStatus</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Convenient constant value representing unknown state - assumed not</span></span><br><span class="line"><span class="comment">     * continuable.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ExitStatus UNKNOWN = <span class="keyword">new</span> ExitStatus(<span class="string">"UNKNOWN"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Convenient constant value representing continuable state where processing</span></span><br><span class="line"><span class="comment">     * is still taking place, so no further action is required. Used for</span></span><br><span class="line"><span class="comment">     * asynchronous execution scenarios where the processing is happening in</span></span><br><span class="line"><span class="comment">     * another thread or process and the caller is not required to wait for the</span></span><br><span class="line"><span class="comment">     * result.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ExitStatus EXECUTING = <span class="keyword">new</span> ExitStatus(<span class="string">"EXECUTING"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Convenient constant value representing finished processing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ExitStatus COMPLETED = <span class="keyword">new</span> ExitStatus(<span class="string">"COMPLETED"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Convenient constant value representing job that did no processing (e.g.</span></span><br><span class="line"><span class="comment">     * because it was already complete).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ExitStatus NOOP = <span class="keyword">new</span> ExitStatus(<span class="string">"NOOP"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Convenient constant value representing finished processing with an error.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ExitStatus FAILED = <span class="keyword">new</span> ExitStatus(<span class="string">"FAILED"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Convenient constant value representing finished processing with</span></span><br><span class="line"><span class="comment">     * interrupted status.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ExitStatus STOPPED = <span class="keyword">new</span> ExitStatus(<span class="string">"STOPPED"</span>);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2020-03-06 14:21:49.384  INFO 18745 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [FlowJob: [name=multiStepJob2]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-06 14:21:49.427  INFO 18745 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step1]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤ä¸€æ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 14:21:49.456  INFO 18745 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step1] executed in 29ms</span><br><span class="line">2020-03-06 14:21:49.501  INFO 18745 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step2]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤äºŒæ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 14:21:49.527  INFO 18745 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step2] executed in 26ms</span><br><span class="line">2020-03-06 14:21:49.576  INFO 18745 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step3]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤ä¸‰æ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 14:21:49.604  INFO 18745 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step3] executed in 28ms</span><br><span class="line">2020-03-06 14:21:49.629  INFO 18745 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [FlowJob: [name=multiStepJob2]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 238ms</span><br></pre></td></tr></table></figure><p></p><h2 id="Flowçš„ç”¨æ³•"><a href="#Flowçš„ç”¨æ³•" class="headerlink" title="Flowçš„ç”¨æ³•"></a>Flowçš„ç”¨æ³•</h2><p>Flowçš„ä½œç”¨å°±æ˜¯å¯ä»¥å°†å¤šä¸ªæ­¥éª¤Stepç»„åˆåœ¨ä¸€èµ·ç„¶åå†ç»„è£…åˆ°ä»»åŠ¡Jobä¸­ã€‚ä¸¾ä¸ªFlowçš„ä¾‹å­ï¼Œåœ¨jobåŒ…ä¸‹æ–°å»º<code>FlowJobDemo</code>ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowJobDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">flowJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"flowJob"</span>)</span><br><span class="line">                .start(flow())</span><br><span class="line">                .next(step3())</span><br><span class="line">                .end()</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step1"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤ä¸€æ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step2"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤äºŒæ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step3"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤ä¸‰æ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªflowå¯¹è±¡ï¼ŒåŒ…å«è‹¥å¹²ä¸ªstep</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Flow <span class="title">flow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FlowBuilder&lt;Flow&gt;(<span class="string">"flow"</span>)</span><br><span class="line">                .start(step1())</span><br><span class="line">                .next(step2())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>FlowBuilder</code>å°†step1å’Œstep2ç»„åˆåœ¨ä¸€èµ·ï¼Œåˆ›å»ºäº†ä¸€ä¸ªåä¸ºflowçš„Flowï¼Œç„¶åå†å°†å…¶èµ‹ç»™ä»»åŠ¡Jobã€‚ä½¿ç”¨Flowå’ŒStepæ„å»ºJobçš„åŒºåˆ«æ˜¯ï¼ŒJobæµç¨‹ä¸­åŒ…å«Flowç±»å‹çš„æ—¶å€™éœ€è¦åœ¨<code>build()</code>æ–¹æ³•å‰è°ƒç”¨<code>end()</code>æ–¹æ³•ã€‚</p><p>å¯åŠ¨ç¨‹åºï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2020-03-06 14:36:42.621  INFO 18865 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [FlowJob: [name=flowJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-06 14:36:42.667  INFO 18865 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step1]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤ä¸€æ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 14:36:42.697  INFO 18865 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step1] executed in 30ms</span><br><span class="line">2020-03-06 14:36:42.744  INFO 18865 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step2]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤äºŒæ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 14:36:42.771  INFO 18865 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step2] executed in 27ms</span><br><span class="line">2020-03-06 14:36:42.824  INFO 18865 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step3]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤ä¸‰æ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 14:36:42.850  INFO 18865 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step3] executed in 25ms</span><br><span class="line">2020-03-06 14:36:42.874  INFO 18865 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [FlowJob: [name=flowJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 245ms</span><br></pre></td></tr></table></figure><p></p><h2 id="å¹¶è¡Œæ‰§è¡Œ"><a href="#å¹¶è¡Œæ‰§è¡Œ" class="headerlink" title="å¹¶è¡Œæ‰§è¡Œ"></a>å¹¶è¡Œæ‰§è¡Œ</h2><p>ä»»åŠ¡ä¸­çš„æ­¥éª¤é™¤äº†å¯ä»¥ä¸²è¡Œæ‰§è¡Œï¼ˆä¸€ä¸ªæ¥ç€ä¸€ä¸ªæ‰§è¡Œï¼‰å¤–ï¼Œè¿˜å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œå¹¶è¡Œæ‰§è¡Œåœ¨ç‰¹å®šçš„ä¸šåŠ¡éœ€æ±‚ä¸‹å¯ä»¥æä¾›ä»»åŠ¡æ‰§è¡Œæ•ˆç‡ã€‚</p><p>å°†ä»»åŠ¡å¹¶è¡ŒåŒ–åªéœ€ä¸¤ä¸ªç®€å•æ­¥éª¤ï¼š</p><ol><li>å°†æ­¥éª¤Stepè½¬æ¢ä¸ºFlowï¼›</li><li>ä»»åŠ¡Jobä¸­æŒ‡å®šå¹¶è¡ŒFlowã€‚</li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨jobåŒ…ä¸‹æ–°å»º<code>SplitJobDemo</code>ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplitJobDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">splitJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"splitJob"</span>)</span><br><span class="line">                .start(flow1())</span><br><span class="line">                .split(<span class="keyword">new</span> SimpleAsyncTaskExecutor()).add(flow2())</span><br><span class="line">                .end()</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step1"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤ä¸€æ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step2"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤äºŒæ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step3"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤ä¸‰æ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Flow <span class="title">flow1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FlowBuilder&lt;Flow&gt;(<span class="string">"flow1"</span>)</span><br><span class="line">                .start(step1())</span><br><span class="line">                .next(step2())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Flow <span class="title">flow2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FlowBuilder&lt;Flow&gt;(<span class="string">"flow2"</span>)</span><br><span class="line">                .start(step3())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªFlowï¼šflow1ï¼ˆåŒ…å«step1å’Œstep2ï¼‰å’Œflow2ï¼ˆåŒ…å«step3ï¼‰ã€‚ç„¶åé€šè¿‡<code>JobBuilderFactory</code>çš„<code>split</code>æ–¹æ³•ï¼ŒæŒ‡å®šä¸€ä¸ªå¼‚æ­¥æ‰§è¡Œå™¨ï¼Œå°†flow1å’Œflow2å¼‚æ­¥æ‰§è¡Œï¼ˆä¹Ÿå°±æ˜¯å¹¶è¡Œï¼‰ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2020-03-06 15:25:43.602  INFO 19449 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [FlowJob: [name=splitJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-06 15:25:43.643  INFO 19449 --- [cTaskExecutor-1] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step3]</span><br><span class="line">2020-03-06 15:25:43.650  INFO 19449 --- [cTaskExecutor-2] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step1]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤ä¸‰æ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">æ‰§è¡Œæ­¥éª¤ä¸€æ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 15:25:43.673  INFO 19449 --- [cTaskExecutor-2] o.s.batch.core.step.AbstractStep         : Step: [step1] executed in 23ms</span><br><span class="line">2020-03-06 15:25:43.674  INFO 19449 --- [cTaskExecutor-1] o.s.batch.core.step.AbstractStep         : Step: [step3] executed in 31ms</span><br><span class="line">2020-03-06 15:25:43.714  INFO 19449 --- [cTaskExecutor-2] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step2]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤äºŒæ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 15:25:43.738  INFO 19449 --- [cTaskExecutor-2] o.s.batch.core.step.AbstractStep         : Step: [step2] executed in 24ms</span><br><span class="line">2020-03-06 15:25:43.758  INFO 19449 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [FlowJob: [name=splitJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 146ms</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°step3å¹¶æ²¡æœ‰åœ¨step2åæ‰æ‰§è¡Œï¼Œè¯´æ˜æ­¥éª¤å·²ç»æ˜¯å¹¶è¡ŒåŒ–çš„ï¼ˆå¼€å¯å¹¶è¡ŒåŒ–åï¼Œå¹¶è¡Œçš„æ­¥éª¤æ‰§è¡Œé¡ºåºå¹¶ä¸èƒ½100%ç¡®å®šï¼Œå› ä¸ºçº¿ç¨‹è°ƒåº¦å…·æœ‰ä¸ç¡®å®šæ€§ï¼‰ã€‚</p><h2 id="ä»»åŠ¡å†³ç­–å™¨"><a href="#ä»»åŠ¡å†³ç­–å™¨" class="headerlink" title="ä»»åŠ¡å†³ç­–å™¨"></a>ä»»åŠ¡å†³ç­–å™¨</h2><p>å†³ç­–å™¨çš„ä½œç”¨å°±æ˜¯å¯ä»¥æŒ‡å®šç¨‹åºåœ¨ä¸åŒçš„æƒ…å†µä¸‹è¿è¡Œä¸åŒçš„ä»»åŠ¡æµç¨‹ï¼Œæ¯”å¦‚ä»Šå¤©æ˜¯å‘¨æœ«ï¼Œåˆ™è®©ä»»åŠ¡æ‰§è¡Œstep1å’Œstep2ï¼Œå¦‚æœæ˜¯å·¥ä½œæ—¥ï¼Œåˆ™ä¹‹å¿ƒstep1å’Œstep3ã€‚</p><p>ä½¿ç”¨å†³ç­–å™¨å‰ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªå†³ç­–å™¨çš„å®ç°ã€‚åœ¨cc.mrbird.batchåŒ…ä¸‹æ–°å»ºdecideråŒ…ï¼Œç„¶ååˆ›å»º<code>MyDecider</code>ç±»ï¼Œå®ç°<code>JobExecutionDecider</code>æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDecider</span> <span class="keyword">implements</span> <span class="title">JobExecutionDecider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FlowExecutionStatus <span class="title">decide</span><span class="params">(JobExecution jobExecution, StepExecution stepExecution)</span> </span>&#123;</span><br><span class="line">        LocalDate now = LocalDate.now();</span><br><span class="line">        DayOfWeek dayOfWeek = now.getDayOfWeek();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dayOfWeek == DayOfWeek.SATURDAY || dayOfWeek == DayOfWeek.SUNDAY) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FlowExecutionStatus(<span class="string">"weekend"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FlowExecutionStatus(<span class="string">"workingDay"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>MyDecider</code>å®ç°<code>JobExecutionDecider</code>æ¥å£çš„<code>decide</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›<code>FlowExecutionStatus</code>ã€‚ä¸Šé¢çš„é€»è¾‘æ˜¯ï¼šåˆ¤æ–­ä»Šå¤©æ˜¯å¦æ˜¯å‘¨æœ«ï¼Œå¦‚æœæ˜¯ï¼Œè¿”å›<code>FlowExecutionStatus(&quot;weekend&quot;)</code>çŠ¶æ€ï¼Œå¦åˆ™è¿”å›<code>FlowExecutionStatus(&quot;workingDay&quot;)</code>çŠ¶æ€ã€‚</p><p>ä¸‹é¢æ¼”ç¤ºå¦‚ä½•åœ¨ä»»åŠ¡Jobé‡Œä½¿ç”¨å†³ç­–å™¨ã€‚åœ¨jobåŒ…ä¸‹æ–°å»º<code>DeciderJobDemo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeciderJobDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyDecider myDecider;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">deciderJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"deciderJob"</span>)</span><br><span class="line">                .start(step1())</span><br><span class="line">                .next(myDecider)</span><br><span class="line">                .from(myDecider).on(<span class="string">"weekend"</span>).to(step2())</span><br><span class="line">                .from(myDecider).on(<span class="string">"workingDay"</span>).to(step3())</span><br><span class="line">                .from(step3()).on(<span class="string">"*"</span>).to(step4())</span><br><span class="line">                .end()</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step1"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤ä¸€æ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step2"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤äºŒæ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step3"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤ä¸‰æ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">step4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory.get(<span class="string">"step4"</span>)</span><br><span class="line">                .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"æ‰§è¡Œæ­¥éª¤å››æ“ä½œã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                &#125;).build();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ³¨å…¥äº†è‡ªå®šä¹‰å†³ç­–å™¨<code>MyDecider</code>ï¼Œç„¶ååœ¨<code>jobDecider()</code>æ–¹æ³•é‡Œä½¿ç”¨äº†è¯¥å†³ç­–å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Job <span class="title">deciderJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"deciderJob"</span>)</span><br><span class="line">            .start(step1())</span><br><span class="line">            .next(myDecider)</span><br><span class="line">            .from(myDecider).on(<span class="string">"weekend"</span>).to(step2())</span><br><span class="line">            .from(myDecider).on(<span class="string">"workingDay"</span>).to(step3())</span><br><span class="line">            .from(step3()).on(<span class="string">"*"</span>).to(step4())</span><br><span class="line">            .end()</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿™æ®µä»£ç çš„å«ä¹‰æ˜¯ï¼šä»»åŠ¡deciderJobé¦–å…ˆæ‰§è¡Œstep1ï¼Œç„¶åæŒ‡å®šè‡ªå®šä¹‰å†³ç­–å™¨ï¼Œå¦‚æœå†³ç­–å™¨è¿”å›weekendï¼Œé‚£ä¹ˆæ‰§è¡Œstep2ï¼Œå¦‚æœå†³ç­–å™¨è¿”å›workingDayï¼Œé‚£ä¹ˆæ‰§è¡Œstep3ã€‚å¦‚æœæ‰§è¡Œäº†step3ï¼Œé‚£ä¹ˆæ— è®ºstep3çš„ç»“æœæ˜¯ä»€ä¹ˆï¼Œéƒ½å°†æ‰§è¡Œstep4ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2020-03-06 16:09:10.541  INFO 19873 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [FlowJob: [name=deciderJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-06 16:09:10.609  INFO 19873 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step1]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤ä¸€æ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 16:09:10.641  INFO 19873 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step1] executed in 32ms</span><br><span class="line">2020-03-06 16:09:10.692  INFO 19873 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step3]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤ä¸‰æ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 16:09:10.723  INFO 19873 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step3] executed in 31ms</span><br><span class="line">2020-03-06 16:09:10.769  INFO 19873 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [step4]</span><br><span class="line">æ‰§è¡Œæ­¥éª¤å››æ“ä½œã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 16:09:10.797  INFO 19873 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [step4] executed in 27ms</span><br><span class="line">2020-03-06 16:09:10.818  INFO 19873 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [FlowJob: [name=deciderJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 256ms</span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºä»Šå¤©æ˜¯2020å¹´03æœˆ06æ—¥æ˜ŸæœŸäº”ï¼Œæ˜¯å·¥ä½œæ—¥ï¼Œæ‰€ä»¥ä»»åŠ¡æ‰§è¡Œäº†step1ã€step3å’Œstep4ã€‚</p><h2 id="ä»»åŠ¡åµŒå¥—"><a href="#ä»»åŠ¡åµŒå¥—" class="headerlink" title="ä»»åŠ¡åµŒå¥—"></a>ä»»åŠ¡åµŒå¥—</h2><p>ä»»åŠ¡Jobé™¤äº†å¯ä»¥ç”±Stepæˆ–è€…Flowæ„æˆå¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†å¤šä¸ªä»»åŠ¡Jobè½¬æ¢ä¸ºç‰¹æ®Šçš„Stepï¼Œç„¶åå†èµ‹ç»™å¦ä¸€ä¸ªä»»åŠ¡Jobï¼Œè¿™å°±æ˜¯ä»»åŠ¡çš„åµŒå¥—ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨jobåŒ…ä¸‹æ–°å»º<code>NestedJobDemo</code>ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NestedJobDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobLauncher jobLauncher;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobRepository jobRepository;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PlatformTransactionManager platformTransactionManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çˆ¶ä»»åŠ¡</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">parentJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"parentJob"</span>)</span><br><span class="line">                .start(childJobOneStep())</span><br><span class="line">                .next(childJobTwoStep())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ä»»åŠ¡è½¬æ¢ä¸ºç‰¹æ®Šçš„æ­¥éª¤</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">childJobOneStep</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JobStepBuilder(<span class="keyword">new</span> StepBuilder(<span class="string">"childJobOneStep"</span>))</span><br><span class="line">                .job(childJobOne())</span><br><span class="line">                .launcher(jobLauncher)</span><br><span class="line">                .repository(jobRepository)</span><br><span class="line">                .transactionManager(platformTransactionManager)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ä»»åŠ¡è½¬æ¢ä¸ºç‰¹æ®Šçš„æ­¥éª¤</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Step <span class="title">childJobTwoStep</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JobStepBuilder(<span class="keyword">new</span> StepBuilder(<span class="string">"childJobTwoStep"</span>))</span><br><span class="line">                .job(childJobTwo())</span><br><span class="line">                .launcher(jobLauncher)</span><br><span class="line">                .repository(jobRepository)</span><br><span class="line">                .transactionManager(platformTransactionManager)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­ä»»åŠ¡ä¸€</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Job <span class="title">childJobOne</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"childJobOne"</span>)</span><br><span class="line">                .start(</span><br><span class="line">                    stepBuilderFactory.get(<span class="string">"childJobOneStep"</span>)</span><br><span class="line">                            .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                                System.out.println(<span class="string">"å­ä»»åŠ¡ä¸€æ‰§è¡Œæ­¥éª¤ã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                                <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                            &#125;).build()</span><br><span class="line">                ).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­ä»»åŠ¡äºŒ</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Job <span class="title">childJobTwo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"childJobTwo"</span>)</span><br><span class="line">                .start(</span><br><span class="line">                    stepBuilderFactory.get(<span class="string">"childJobTwoStep"</span>)</span><br><span class="line">                            .tasklet((stepContribution, chunkContext) -&gt; &#123;</span><br><span class="line">                                System.out.println(<span class="string">"å­ä»»åŠ¡äºŒæ‰§è¡Œæ­¥éª¤ã€‚ã€‚ã€‚"</span>);</span><br><span class="line">                                <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">                            &#125;).build()</span><br><span class="line">                ).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>childJobOne()</code>å’Œ<code>childJobTwo()</code>æ–¹æ³•åˆ›å»ºäº†ä¸¤ä¸ªä»»åŠ¡Jobï¼Œè¿™é‡Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå‰é¢éƒ½ä»‹ç»è¿‡ã€‚å…³é”®åœ¨äº<code>childJobOneStep()</code>æ–¹æ³•å’Œ<code>childJobTwoStep()</code>æ–¹æ³•ã€‚åœ¨<code>childJobOneStep()</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>JobStepBuilder</code>æ„å»ºäº†ä¸€ä¸ªåç§°ä¸º<code>childJobOneStep</code>çš„Stepï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªä»»åŠ¡å‹Stepçš„æ„é€ å·¥å‚ï¼Œå¯ä»¥å°†ä»»åŠ¡è½¬æ¢ä¸ºâ€œç‰¹æ®Šâ€çš„æ­¥éª¤ã€‚åœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¼ å…¥ä»»åŠ¡æ‰§è¡Œå™¨JobLauncherã€ä»»åŠ¡ä»“åº“JobRepositoryå’Œäº‹åŠ¡ç®¡ç†å™¨PlatformTransactionManagerã€‚</p><p>å°†ä»»åŠ¡è½¬æ¢ä¸ºç‰¹æ®Šçš„æ­¥éª¤åï¼Œå°†å…¶èµ‹ç»™çˆ¶ä»»åŠ¡parentJobå³å¯ï¼Œæµç¨‹å’Œå‰é¢ä»‹ç»çš„ä¸€è‡´ã€‚</p><p>é…ç½®å¥½åï¼Œå¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">2020-03-06 16:58:39.771  INFO 21588 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=parentJob]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-06 16:58:39.812  INFO 21588 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [childJobOneStep]</span><br><span class="line">2020-03-06 16:58:39.866  INFO 21588 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=childJobOne]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-06 16:58:39.908  INFO 21588 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [childJobOneStep]</span><br><span class="line">å­ä»»åŠ¡ä¸€æ‰§è¡Œæ­¥éª¤ã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 16:58:39.940  INFO 21588 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [childJobOneStep] executed in 32ms</span><br><span class="line">2020-03-06 16:58:39.960  INFO 21588 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=childJobOne]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 86ms</span><br><span class="line">2020-03-06 16:58:39.983  INFO 21588 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [childJobOneStep] executed in 171ms</span><br><span class="line">2020-03-06 16:58:40.019  INFO 21588 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [childJobTwoStep]</span><br><span class="line">2020-03-06 16:58:40.067  INFO 21588 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=childJobTwo]] launched with the following parameters: [&#123;&#125;]</span><br><span class="line">2020-03-06 16:58:40.102  INFO 21588 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [childJobTwoStep]</span><br><span class="line">å­ä»»åŠ¡äºŒæ‰§è¡Œæ­¥éª¤ã€‚ã€‚ã€‚</span><br><span class="line">2020-03-06 16:58:40.130  INFO 21588 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [childJobTwoStep] executed in 28ms</span><br><span class="line">2020-03-06 16:58:40.152  INFO 21588 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=childJobTwo]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 75ms</span><br><span class="line">2020-03-06 16:58:40.157  INFO 21588 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [childJobTwoStep] executed in 138ms</span><br><span class="line">2020-03-06 16:58:40.177  INFO 21588 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=parentJob]] completed with the following parameters: [&#123;&#125;] and the following status: [COMPLETED] in 398ms</span><br></pre></td></tr></table></figure><p></p><blockquote><p>æœ¬èŠ‚æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/67.spring-batch-start" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/67.spring-batch-start</a>ã€‚</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:55:59 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;ä¼ä¸šä¸­ç»å¸¸ä¼šæœ‰éœ€è¦æ‰¹å¤„ç†æ‰èƒ½å®Œæˆçš„ä¸šåŠ¡æ“ä½œï¼Œæ¯”å¦‚ï¼šè‡ªåŠ¨åŒ–åœ°å¤„ç†å¤§æ‰¹é‡å¤æ‚çš„æ•°æ®ï¼Œå¦‚æœˆç»“è®¡ç®—ï¼›é‡å¤æ€§åœ°å¤„ç†å¤§æ‰¹é‡æ•°æ®ï¼Œå¦‚è´¹ç‡è®¡ç®—ï¼›å……å½“å†…éƒ¨ç³»ç»Ÿå’Œå¤–éƒ¨ç³»ç»Ÿçš„æ•°æ®çº½å¸¦ï¼Œä¸­é—´éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ ¼å¼åŒ–ï¼Œæ ¡éªŒï¼Œè½¬æ¢å¤„ç†ç­‰ã€‚&lt;/p&gt;&lt;p&gt;Spring Batchæ˜¯ä¸€ä¸ªè½»é‡çº§ä½†åŠŸèƒ½åˆååˆ†å…¨é¢çš„æ‰¹å¤„ç†æ¡†æ¶ï¼Œæœ¬èŠ‚æˆ‘ä»¬å°†é€šè¿‡ä¸€äº›ç®€å•çš„ä¾‹å­æ¥å…¥é—¨Spring Batchã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
      <category term="Spring Batch" scheme="http://mrbird.cc/tags/Spring-Batch/"/>
    
  </entry>
  
  <entry>
    <title>Spring Bootæ•´åˆWebSocket</title>
    <link href="http://mrbird.cc/Spring-Boot%E6%95%B4%E5%90%88WebSocket.html"/>
    <id>http://mrbird.cc/Spring-Bootæ•´åˆWebSocket.html</id>
    <published>2020-02-16T09:49:34.000Z</published>
    <updated>2020-03-18T00:58:33.282Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:56:00 GMT+0800 (GMT+08:00) --><p>æœ¬èŠ‚ç®€å•ä»‹ç»ä¸‹å¦‚ä½•åœ¨Spring Bootå¼•å…¥WebSocketï¼Œå®ç°ç®€å•çš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å»ºç«‹é•¿è¿æ¥å¹¶äº’å‘é€æ–‡æœ¬æ¶ˆæ¯ã€‚</p><a id="more"></a><h2 id="æ¡†æ¶æ­å»º"><a href="#æ¡†æ¶æ­å»º" class="headerlink" title="æ¡†æ¶æ­å»º"></a>æ¡†æ¶æ­å»º</h2><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼ŒartifactIdä¸ºspring-boot-websocket-socketjsï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20200316-183958@2x.png" alt="QQ20200316-183958@2x"></p><p>é¡¹ç›®çš„pomå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-websocket-socketjs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>spring-boot-websocket-socketjs<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>å¼•å…¥äº†spring-boot-starter-websocketå’Œspring-boot-starter-webä¾èµ–ã€‚</p><h2 id="æ„å»ºæœåŠ¡ç«¯"><a href="#æ„å»ºæœåŠ¡ç«¯" class="headerlink" title="æ„å»ºæœåŠ¡ç«¯"></a>æ„å»ºæœåŠ¡ç«¯</h2><p>åœ¨cc.mrbird.socketç›®å½•ä¸‹æ–°å»ºhandleråŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>MyStringWebSocketHandler</code>ç»§æ‰¿<code>TextWebSocketHandler</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyStringWebSocketHandler</span> <span class="keyword">extends</span> <span class="title">TextWebSocketHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"å’Œå®¢æˆ·ç«¯å»ºç«‹è¿æ¥"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleTransportError</span><span class="params">(WebSocketSession session, Throwable exception)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        session.close(CloseStatus.SERVER_ERROR);</span><br><span class="line">        log.error(<span class="string">"è¿æ¥å¼‚å¸¸"</span>, exception);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus status)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.afterConnectionClosed(session, status);</span><br><span class="line">        log.info(<span class="string">"å’Œå®¢æˆ·ç«¯æ–­å¼€è¿æ¥"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handleTextMessage</span><span class="params">(WebSocketSession session, TextMessage message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// è·å–åˆ°å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ¶ˆæ¯</span></span><br><span class="line">        String receiveMessage = message.getPayload();</span><br><span class="line">        log.info(receiveMessage);</span><br><span class="line">        <span class="comment">// å‘é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯</span></span><br><span class="line">        session.sendMessage(<span class="keyword">new</span> TextMessage(fakeAi(receiveMessage)));</span><br><span class="line">        <span class="comment">// å…³é—­è¿æ¥</span></span><br><span class="line">        <span class="comment">// session.close(CloseStatus.NORMAL);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">fakeAi</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span> || <span class="string">""</span>.equals(input)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"ä½ è¯´ä»€ä¹ˆï¼Ÿæ²¡å¬æ¸…ï¸"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> input.replace(<span class="string">'ä½ '</span>, <span class="string">'æˆ‘'</span>)</span><br><span class="line">                .replace(<span class="string">"å—"</span>, <span class="string">""</span>)</span><br><span class="line">                .replace(<span class="string">'?'</span>, <span class="string">'!'</span>)</span><br><span class="line">                .replace(<span class="string">'ï¼Ÿ'</span>, <span class="string">'ï¼'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¯¥ç±»é‡å†™äº†çˆ¶ç±»<code>AbstractWebSocketHandler</code>çš„å››ä¸ªæ–¹æ³•ï¼š</p><p><img src="img/QQ20200316-185332@2x.png" alt="QQ20200316-185332@2x"></p><ul><li><p>afterConnectionEstablishedï¼Œå’Œå®¢æˆ·ç«¯é“¾æ¥æˆåŠŸçš„æ—¶å€™è§¦å‘è¯¥æ–¹æ³•ï¼›</p></li><li><p>handleTransportErrorï¼Œå’Œå®¢æˆ·ç«¯è¿æ¥å¤±è´¥çš„æ—¶å€™è§¦å‘è¯¥æ–¹æ³•ï¼›</p></li><li><p>afterConnectionClosedï¼Œå’Œå®¢æˆ·ç«¯æ–­å¼€è¿æ¥çš„æ—¶å€™è§¦å‘è¯¥æ–¹æ³•ï¼›</p></li><li><p>handleTextMessageï¼Œå’Œå®¢æˆ·ç«¯å»ºç«‹è¿æ¥åï¼Œå¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ã€‚</p></li></ul><p><code>WebSocketSession</code>å¯¹è±¡ä»£è¡¨æ¯ä¸ªå®¢æˆ·ç«¯ä¼šè¯ï¼ŒåŒ…å«è®¸å¤šå®ç”¨æ–¹æ³•ï¼š</p><p><img src="img/QQ20200316-185851@2x.png" alt="QQ20200316-185851@2x"></p><p>æ–¹æ³•è§åçŸ¥æ„ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚</p><p>æ­¤å¤–ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç›®çš„æ˜¯å®ç°å’Œå®¢æˆ·ç«¯çš„é€šä¿¡ï¼Œå¹¶ä¸”å†…å®¹ä¸ºæ–‡æœ¬å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§æ‰¿çš„æ˜¯<code>TextWebSocketHandler</code>ï¼›å¦‚æœä¼ è¾“çš„æ˜¯äºŒè¿›åˆ¶å†…å®¹ï¼Œåˆ™å¯ä»¥ç»§æ‰¿<code>BinaryWebSocketHandler</code>ï¼Œæ›´å¤šä¿¡æ¯å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹<code>WebSocketHandler</code>çš„å­ç±»ã€‚</p><p>æ¥ç€åœ¨cc.mrbird.socketç›®å½•ä¸‹æ–°å»ºconfigureåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»º<code>WebSocketServerConfigure</code>é…ç½®ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketServerConfigure</span> <span class="keyword">implements</span> <span class="title">WebSocketConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyStringWebSocketHandler myStringWebSocketHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addHandler(myStringWebSocketHandler, <span class="string">"/connect"</span>).withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>@EnableWebSocket</code>ç”¨äºå¼€å¯WebSocketç›¸å…³åŠŸèƒ½ï¼Œæˆ‘ä»¬æ³¨å…¥äº†ä¸Šé¢åˆ›å»ºçš„MyStringWebSocketHandlerï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°äº†<code>WebSocketHandlerRegistry</code>ã€‚</p><p>ä¸Šé¢ä»£ç çš„å«ä¹‰æ˜¯ï¼Œå½“å®¢æˆ·ç«¯é€šè¿‡<code>/connect</code>urlå’ŒæœåŠ¡ç«¯è¿æ¥é€šä¿¡æ—¶ï¼Œä½¿ç”¨<code>MyStringWebSocketHandler</code>å¤„ç†ä¼šè¯ã€‚<code>withSockJS</code>çš„å«ä¹‰æ˜¯ï¼Œé€šä¿¡çš„å®¢æˆ·ç«¯æ˜¯é€šè¿‡SockJSå®ç°çš„ï¼Œä¸‹é¢ä¼šä»‹ç»åˆ°ã€‚</p><h2 id="æ„å»ºå®¢æˆ·ç«¯"><a href="#æ„å»ºå®¢æˆ·ç«¯" class="headerlink" title="æ„å»ºå®¢æˆ·ç«¯"></a>æ„å»ºå®¢æˆ·ç«¯</h2><p><a href="https://github.com/sockjs/sockjs-client" target="_blank" rel="noopener">SockJS</a>æ˜¯ä¸€ä¸ªJSæ’ä»¶ï¼Œç”¨äºæ„å»ºWebSocketï¼Œå…¼å®¹æ€§å¥½ã€‚</p><p>åœ¨resourcesç›®å½•ä¸‹æ–°å»ºstaticåŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»ºclient.htmlï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebSocketå®¢æˆ·ç«¯<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/sockjs-client/0.3.4/sockjs.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"https://cdn.bootcss.com/twitter-bootstrap/4.4.1/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.jumbotron</span> &#123;</span></span><br><span class="line"><span class="undefined">        width: 100%;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">    <span class="selector-id">#text</span> &#123;</span></span><br><span class="line"><span class="undefined">        height: 3rem;</span></span><br><span class="line"><span class="undefined">        font-size: 1rem;</span></span><br><span class="line"><span class="undefined">        line-height: 3rem;</span></span><br><span class="line"><span class="undefined">        margin: 1rem;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.btn</span> &#123;</span></span><br><span class="line"><span class="undefined">        margin-right: 5px;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">    <span class="selector-id">#connect</span> &#123;</span></span><br><span class="line"><span class="undefined">        margin-left: 1rem;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">    <span class="selector-id">#log</span> &#123;</span></span><br><span class="line"><span class="undefined">        margin: 1rem 0 0 1rem;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"jumbotron"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"è¯·è¾“å…¥ä½ æƒ³ä¼ è¾“çš„å†…å®¹"</span> <span class="attr">id</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"col-lg-12"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"è¿æ¥"</span> <span class="attr">class</span>=<span class="string">"btn btn-info"</span> <span class="attr">id</span>=<span class="string">"connect"</span> <span class="attr">onclick</span>=<span class="string">"connect()"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"å‘é€"</span> <span class="attr">class</span>=<span class="string">"btn btn-success"</span> <span class="attr">id</span>=<span class="string">"sent"</span> <span class="attr">disabled</span>=<span class="string">"disabled"</span> <span class="attr">onclick</span>=<span class="string">"sent()"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"æ–­å¼€"</span> <span class="attr">class</span>=<span class="string">"btn btn-danger"</span> <span class="attr">id</span>=<span class="string">"disconnect"</span> <span class="attr">disabled</span>=<span class="string">"disabled"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">onclick</span>=<span class="string">"disconnect()"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"log"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>èŠå¤©è®°å½•:<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> text = <span class="built_in">document</span>.querySelector(<span class="string">'#text'</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> connectBtn = <span class="built_in">document</span>.querySelector(<span class="string">"#connect"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> sentBtn = <span class="built_in">document</span>.querySelector(<span class="string">"#sent"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> disconnectBtn = <span class="built_in">document</span>.querySelector(<span class="string">"#disconnect"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> logDiv = <span class="built_in">document</span>.querySelector(<span class="string">"#log"</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> ws = <span class="literal">null</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> targetUri = <span class="string">"/connect"</span>;</span></span><br><span class="line"><span class="javascript">        ws = <span class="keyword">new</span> SockJS(targetUri);</span></span><br><span class="line"><span class="javascript">        ws.onopen = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            setConnected(<span class="literal">true</span>);</span></span><br><span class="line"><span class="javascript">            log(<span class="string">'å’ŒæœåŠ¡ç«¯è¿æ¥æˆåŠŸï¼'</span>);</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="javascript">        ws.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            log(<span class="string">'æœåŠ¡ç«¯è¯´ï¼š'</span> + event.data);</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="javascript">        ws.onclose = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            setConnected(<span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript">            log(<span class="string">'å’ŒæœåŠ¡ç«¯æ–­å¼€è¿æ¥ï¼'</span>)</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">sent</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (ws != <span class="literal">null</span>) &#123;</span></span><br><span class="line"><span class="undefined">            ws.send(text.value);</span></span><br><span class="line"><span class="javascript">            log(<span class="string">'å®¢æˆ·ç«¯è¯´ï¼š'</span> + text.value);</span></span><br><span class="line"><span class="javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">            log(<span class="string">'è¯·å…ˆå»ºç«‹è¿æ¥ï¼'</span>)</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">disconnect</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (ws != <span class="literal">null</span>) &#123;</span></span><br><span class="line"><span class="undefined">            ws.close();</span></span><br><span class="line"><span class="javascript">            ws = <span class="literal">null</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        setConnected(<span class="literal">false</span>);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">value</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> content = <span class="built_in">document</span>.createElement(<span class="string">'p'</span>);</span></span><br><span class="line"><span class="undefined">        content.innerHTML = value;</span></span><br><span class="line"><span class="undefined">        logDiv.appendChild(content);</span></span><br><span class="line"><span class="javascript">        text.value = <span class="string">''</span>;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">setConnected</span>(<span class="params">connected</span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">        connectBtn.disabled = connected;</span></span><br><span class="line"><span class="undefined">        disconnectBtn.disabled = !connected;</span></span><br><span class="line"><span class="undefined">        sentBtn.disabled = !connected;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>htmlï¼Œcssé‚£äº›éƒ½ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯æˆ‘ä»¬å¼•å…¥äº†<code>SockJS</code>åº“ã€‚åœ¨<code>connect()</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>new SockJS(/connect)</code>å’Œä¸Šé¢çš„æœåŠ¡ç«¯å»ºç«‹äº†Socketé€šä¿¡ã€‚<code>SockJS</code>å¯¹è±¡åŒ…å«å‡ ä¸ªå¸¸ç”¨çš„å®ç”¨æ–¹æ³•ï¼š</p><ul><li><p><code>onopen</code>ï¼Œå’ŒæœåŠ¡ç«¯è®²äº†è¿æ¥åçš„å›è°ƒæ–¹æ³•ï¼›</p></li><li><p><code>onmessage</code>ï¼ŒæœåŠ¡ç«¯è¿”å›æ¶ˆæ¯æ—¶çš„å›è°ƒæ–¹æ³•ï¼›</p></li><li><p><code>onclose</code>ï¼Œå’ŒæœåŠ¡ç«¯æ–­å¼€è¿æ¥çš„å›è°ƒæ–¹æ³•ï¼›</p></li><li><p><code>send</code>ï¼Œå‘é€æ¶ˆæ¯ç»™æœåŠ¡ç«¯ï¼›</p></li><li><p><code>close</code>ï¼Œæ–­å¼€å’ŒæœåŠ¡ç«¯çš„è¿æ¥ã€‚</p></li></ul><p>ä¸Šé¢çš„JSè¾ƒä¸ºç®€å•ï¼Œå…¶ä»–é€»è¾‘è‡ªå·±çœ‹çœ‹å§ã€‚</p><h2 id="é€šä¿¡æµ‹è¯•"><a href="#é€šä¿¡æµ‹è¯•" class="headerlink" title="é€šä¿¡æµ‹è¯•"></a>é€šä¿¡æµ‹è¯•</h2><p>å¯åŠ¨é¡¹ç›®ï¼Œæµè§ˆå™¨è®¿é—®ï¼š<a href="http://localhost:8080/client.html" target="_blank" rel="noopener">http://localhost:8080/client.html</a>ï¼š</p><p><img src="img/QQ20200316-191957@2x.png" alt="QQ20200316-191957@2x"></p><blockquote><p>æºç è¿æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/76.spring-boot-websocket-socketjs" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/76.spring-boot-websocket-socketjs</a>ã€‚</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:56:00 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;æœ¬èŠ‚ç®€å•ä»‹ç»ä¸‹å¦‚ä½•åœ¨Spring Bootå¼•å…¥WebSocketï¼Œå®ç°ç®€å•çš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å»ºç«‹é•¿è¿æ¥å¹¶äº’å‘é€æ–‡æœ¬æ¶ˆæ¯ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
      <category term="WebSocket" scheme="http://mrbird.cc/tags/WebSocket/"/>
    
      <category term="SockJS" scheme="http://mrbird.cc/tags/SockJS/"/>
    
  </entry>
  
  <entry>
    <title>è‡ªå®šä¹‰Spring Boot Starter</title>
    <link href="http://mrbird.cc/%E8%87%AA%E5%AE%9A%E4%B9%89Spring-Boot-Starter.html"/>
    <id>http://mrbird.cc/è‡ªå®šä¹‰Spring-Boot-Starter.html</id>
    <published>2020-02-10T04:05:00.000Z</published>
    <updated>2020-02-10T04:05:43.910Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Aug 03 2020 08:56:00 GMT+0800 (GMT+08:00) --><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Aug 03 2020 08:56:00 GMT+0800 (GMT+08:00) --&gt;&lt;!-- rebuild by neat --&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
  </entry>
  
</feed>
