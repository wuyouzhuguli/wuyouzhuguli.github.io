<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>MrBird</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://mrbird.cc/"/>
  <updated>2020-01-21T10:30:56.818Z</updated>
  <id>http://mrbird.cc/</id>
  
  <author>
    <name>MrBird</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Spring Cloud å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹</title>
    <link href="http://mrbird.cc/book.html"/>
    <id>http://mrbird.cc/book.html</id>
    <published>2222-10-24T06:20:57.000Z</published>
    <updated>2020-01-21T10:30:56.818Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --><p>ğŸ“–ã€Š<a href="https://www.kancloud.cn/mrbird/spring-cloud" target="_blank" rel="noopener"> Spring Cloud å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹ </a>ã€‹ä¸€æœ¬åŸºäºSpring Cloud Hoxton.RELEASE&amp;Spring Cloud Oauth2&amp;Spring Cloud Alibabaçš„å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹ä¹¦ç±ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ ä»é›¶åˆ°K8Sé›†ç¾¤éƒ¨ç½²ã€‚</p><a id="more"></a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263686" target="_blank" rel="noopener">ç¬¬ä¸€ç«  åŸºç¡€æ¡†æ¶æ­å»º</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263687" target="_blank" rel="noopener">1.1 æ¶æ„é¢„è§ˆ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263688" target="_blank" rel="noopener">1.2 æ­å»ºå¾®æœåŠ¡æ³¨å†Œä¸­å¿ƒ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263689" target="_blank" rel="noopener">1.3 æ­å»ºè®¤è¯æœåŠ¡å™¨</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263690" target="_blank" rel="noopener">1.4 æ­å»ºå¾®æœåŠ¡ç½‘å…³</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263691" target="_blank" rel="noopener">1.5 æ­å»ºå¾®æœåŠ¡æä¾›è€…ï¼ˆèµ„æºæœåŠ¡å™¨ï¼‰</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263692" target="_blank" rel="noopener">1.6 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263693" target="_blank" rel="noopener">ç¬¬äºŒç«  æ¶æ„å®Œå–„</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263694" target="_blank" rel="noopener">2.1 å‚æ•°é…ç½®åŒ–</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263695" target="_blank" rel="noopener">2.2 å¼‚å¸¸å¤„ç†</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263696" target="_blank" rel="noopener">2.3 Feignçš„ä½¿ç”¨</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263697" target="_blank" rel="noopener">2.4 å¾®æœåŠ¡é˜²æŠ¤</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263698" target="_blank" rel="noopener">2.5 è·¨åŸŸå¤„ç†</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263699" target="_blank" rel="noopener">2.6 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263700" target="_blank" rel="noopener">ç¬¬ä¸‰ç«  å®Œå–„ç™»å½•æµç¨‹</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263701" target="_blank" rel="noopener">3.1 è¡¨ç»“æ„è®¾è®¡</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263702" target="_blank" rel="noopener">3.2 å®Œå–„ç™»å½•</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263703" target="_blank" rel="noopener">3.3 æ•´åˆå›¾å½¢éªŒè¯ç </a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263704" target="_blank" rel="noopener">3.4 SentineléªŒè¯ç é™æµ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263705" target="_blank" rel="noopener">3.5 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263706" target="_blank" rel="noopener">ç¬¬å››ç«  æ•´åˆSwagger</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263707" target="_blank" rel="noopener">4.1 å®Œå–„febs-server-system</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263708" target="_blank" rel="noopener">4.2 æ¥å…¥Swagger</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263709" target="_blank" rel="noopener">4.3 Swagger OAuth2è®¤è¯</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263710" target="_blank" rel="noopener">4.4 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263711" target="_blank" rel="noopener">ç¬¬äº”ç«  æ•´åˆç¬¬ä¸‰æ–¹æœåŠ¡</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263712" target="_blank" rel="noopener">5.1 æ•´åˆSpring Boot Admin</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263713" target="_blank" rel="noopener">5.2 Sleuth Zipkiné“¾è·¯è¿½è¸ª</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263714" target="_blank" rel="noopener">5.3 logbackæ—¥å¿—æ‰“å°</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263715" target="_blank" rel="noopener">5.4 ELKæ—¥å¿—æ”¶é›†</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263716" target="_blank" rel="noopener">5.5 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263717" target="_blank" rel="noopener">ç¬¬å…­ç«  å‰ç«¯ç³»ç»Ÿä»‹ç»</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263718" target="_blank" rel="noopener">6.1 å°è£…Axios</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263719" target="_blank" rel="noopener">6.2 Vueå¯¼èˆªå®ˆå«</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263720" target="_blank" rel="noopener">6.3 åŠ¨æ€è·¯ç”±æ„å»º</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263721" target="_blank" rel="noopener">6.4 å¤„ç†ç”¨æˆ·ç™»å½•</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263722" target="_blank" rel="noopener">6.5 å¤„ç†ä»¤ç‰Œåˆ·æ–°</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263723" target="_blank" rel="noopener">6.6 è‡ªå®šä¹‰Vueæƒé™æŒ‡ä»¤</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263724" target="_blank" rel="noopener">6.7 æœ¬ç« å°ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263725" target="_blank" rel="noopener">ç¬¬ä¸ƒç«  å¾®æœåŠ¡éƒ¨ç½²</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263726" target="_blank" rel="noopener">7.1 å¾®æœåŠ¡DokceråŒ–</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263727" target="_blank" rel="noopener">7.2 ä½¿ç”¨Docker Composeéƒ¨ç½²</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263728" target="_blank" rel="noopener">7.3 æœ¬ç« å°ç»“</a></li></ul></li><li><p><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263729" target="_blank" rel="noopener">ç¬¬å…«ç«  å¾®æœåŠ¡è¿›é˜¶</a></p><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1277531" target="_blank" rel="noopener">8.1 ä»¤ç‰Œå­˜å‚¨ç­–ç•¥</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1263731" target="_blank" rel="noopener">8.2 ä½¿ç”¨Cloud Gatewayæ­å»ºç½‘å…³</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1271133" target="_blank" rel="noopener">8.3 ä½¿ç”¨Alibaba Nacosæ³¨å†Œä¸­å¿ƒ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1289434" target="_blank" rel="noopener">8.4 ä½¿ç”¨Alibaba Nacoså­˜å‚¨é…ç½®</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1333138" target="_blank" rel="noopener">8.5 æ¥å…¥Prometheus + Grafana</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1337996" target="_blank" rel="noopener">8.6 æ•´åˆskywalkingåˆ†å¸ƒå¼è¿½è¸ª</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1411735" target="_blank" rel="noopener">8.7 å‡çº§åˆ°Hoxton.RELEASE</a></li></ul></li><li><p><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426914" target="_blank" rel="noopener">ç¬¬ä¹ç«  K8Sé›†ç¾¤éƒ¨ç½²</a></p><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426916" target="_blank" rel="noopener">9.1 é›†ç¾¤ç¯å¢ƒå‡†å¤‡</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426917" target="_blank" rel="noopener">9.2 å®‰è£…ç¬¬ä¸‰æ–¹æœåŠ¡</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426918" target="_blank" rel="noopener">9.3 Kubeadmæ­å»ºK8S 1.16.2é›†ç¾¤</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426919" target="_blank" rel="noopener">9.4 NFSæœåŠ¡å™¨æ­å»º</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426920" target="_blank" rel="noopener">9.5 æ­å»ºDockeré•œåƒä»“åº“Harbor</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426921" target="_blank" rel="noopener">9.6 K8Sæ„å»ºé«˜å¯ç”¨Nacos</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426922" target="_blank" rel="noopener">9.7 K8Sæ„å»ºFEBS CloudæœåŠ¡é›†ç¾¤</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426923" target="_blank" rel="noopener">9.8 éƒ¨ç½²å‰ç«¯æµ‹è¯•</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1426924" target="_blank" rel="noopener">9.9 K8Så®è·µæ€»ç»“</a></li></ul></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456142" target="_blank" rel="noopener">ç¬¬åç«  åˆ†å¸ƒå¼äº‹åŠ¡ç ”ç©¶</a><ul><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456143" target="_blank" rel="noopener">10.1 åˆ†å¸ƒå¼æ¶æ„äº‹åŠ¡æŒ‘æˆ˜</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456144" target="_blank" rel="noopener">10.2 åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456145" target="_blank" rel="noopener">10.3 åŸºäºæ¶ˆæ¯ä¸­é—´ä»¶RocketMQæ–¹æ¡ˆï¼ˆä¸€ï¼‰</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456146" target="_blank" rel="noopener">10.4 åŸºäºæ¶ˆæ¯ä¸­é—´ä»¶RocketMQæ–¹æ¡ˆï¼ˆäºŒï¼‰</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456147" target="_blank" rel="noopener">10.5 åŸºäºTX-LCNæ–¹æ¡ˆ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456148" target="_blank" rel="noopener">10.6 åŸºäºé˜¿é‡ŒSeataæ–¹æ¡ˆ</a></li><li><a href="https://www.kancloud.cn/mrbird/spring-cloud/1456149" target="_blank" rel="noopener">10.7 æœ¬ç« æ€»ç»“</a></li></ul></li></ul><script>$(function(){$("#comment-div").remove(),$(".post-copyright").remove(),$("#reward-div").remove(),$(".post-footer").remove()})</script><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;ğŸ“–ã€Š&lt;a href=&quot;https://www.kancloud.cn/mrbird/spring-cloud&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt; Spring Cloud å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹ &lt;/a&gt;ã€‹ä¸€æœ¬åŸºäºSpring Cloud Hoxton.RELEASE&amp;amp;Spring Cloud Oauth2&amp;amp;Spring Cloud Alibabaçš„å¾®æœåŠ¡æƒé™ç³»ç»Ÿæ­å»ºæ•™ç¨‹ä¹¦ç±ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ ä»é›¶åˆ°K8Sé›†ç¾¤éƒ¨ç½²ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Cloud" scheme="http://mrbird.cc/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>LinkedHashSetæºç è§£æ</title>
    <link href="http://mrbird.cc/LinkedHashSet%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html"/>
    <id>http://mrbird.cc/LinkedHashSetæºç è§£æ.html</id>
    <published>2020-09-03T03:25:12.000Z</published>
    <updated>2021-02-25T10:33:02.819Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:20 GMT+0800 (GMT+08:00) --><p>æˆ‘ä»¬çŸ¥é“ï¼ŒHashSetå†…éƒ¨ä½¿ç”¨HashMapå­˜å‚¨å…ƒç´ ï¼Œæ‰€ä»¥HashSetéå†æ•°æ®æ—¶æ˜¯æ— åºçš„ï¼Œè¦ä¿è¯æ’å…¥çš„å…ƒç´ æœ‰åºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨LinkedHashSetã€‚æœ¬èŠ‚è®°å½•LinkedHashSetæºç è§£æï¼ŒåŸºäºJDK1.8ã€‚</p><a id="more"></a><p>LinkedHashSetç±»å±‚çº§å…³ç³»å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20210225-182300@2x.png" alt="QQ20210225-182300@2x"></p><p>LinkedHashSetç»§æ‰¿è‡ªHashSetã€‚æŸ¥çœ‹LinkedHashSetçš„æ„é€ æ–¹æ³•æºç ä¼šå‘ç°å†…éƒ¨éƒ½æ˜¯è°ƒç”¨çˆ¶ç±»çš„<code>HashSet(int initialCapacity, float loadFactor, boolean dummy)</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HashSet(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor, <span class="keyword">boolean</span> dummy) &#123;</span><br><span class="line">    map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(initialCapacity, loadFactor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>dummyå‚æ•°æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œä»…ç”¨äºå’Œåˆ«çš„å…¥å‚ä¸º(int,float)çš„æ„é€ å™¨åŒºåˆ†å¼€ã€‚æ–¹æ³•å†…éƒ¨åˆ›å»ºçš„æ˜¯LinkedHashMapï¼Œæ‰€ä»¥LinkedHashSetå°±æ˜¯ç”¨LinkedHashMapæ¥ä¿è¯æ’å…¥å…ƒç´ æœ‰åºçš„ï¼Œå¯¹LinkedHashMapä¸ç†Ÿæ‚‰çš„è¯·å‚è€ƒ<a href="/LinkedHashMapæºç è§£æ.html">LinkedHashMapæºç è§£æ</a>ã€‚</p><p>ä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬è¿˜å¯ä»¥å‘ç°ï¼ŒLinkedHashSetæ— æ³•æ”¹å˜linkedHashMapçš„accessOrderå±æ€§å€¼ï¼Œæ‰€ä»¥åœ¨LinkedHashSetä¸­ï¼Œå…ƒç´ çš„é¡ºåºåªèƒ½å’Œæ’å…¥é¡ºåºä¸€è‡´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashSet&lt;String&gt; set = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">set.add(<span class="string">"apple"</span>);</span><br><span class="line">set.add(<span class="string">"orange"</span>);</span><br><span class="line">set.add(<span class="string">"watermelon"</span>);</span><br><span class="line">set.add(<span class="string">"strawberry"</span>);</span><br><span class="line">System.out.println(set);</span><br></pre></td></tr></table></figure><p>è¾“å‡ºé¡ºåºå’Œæ’å…¥é¡ºåºä¸€è‡´ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[apple, orange, watermelon, strawberry]</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:20 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;æˆ‘ä»¬çŸ¥é“ï¼ŒHashSetå†…éƒ¨ä½¿ç”¨HashMapå­˜å‚¨å…ƒç´ ï¼Œæ‰€ä»¥HashSetéå†æ•°æ®æ—¶æ˜¯æ— åºçš„ï¼Œè¦ä¿è¯æ’å…¥çš„å…ƒç´ æœ‰åºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨LinkedHashSetã€‚æœ¬èŠ‚è®°å½•LinkedHashSetæºç è§£æï¼ŒåŸºäºJDK1.8ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>LinkedHashMapæºç è§£æ</title>
    <link href="http://mrbird.cc/LinkedHashMap%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html"/>
    <id>http://mrbird.cc/LinkedHashMapæºç è§£æ.html</id>
    <published>2020-09-02T03:24:36.000Z</published>
    <updated>2021-02-25T11:04:52.965Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:20 GMT+0800 (GMT+08:00) --><p>HashMapå…ƒç´ æ’å…¥æ˜¯æ— åºçš„ï¼Œä¸ºäº†è®©éå†é¡ºåºå’Œæ’å…¥é¡ºåºä¸€è‡´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨LinkedHashMapï¼Œå…¶å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥å­˜å‚¨å…ƒç´ é¡ºåºï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡accessOrderå±æ€§æ§åˆ¶éé¡ºåºä¸ºæ’å…¥é¡ºåºæˆ–è€…ä¸ºè®¿é—®é¡ºåºã€‚æœ¬èŠ‚å°†è®°å½•LinkedHashMapçš„å†…éƒ¨å®ç°åŸç†ï¼ŒåŸºäºJDK1.8ï¼Œå¹¶ä¸”ç”¨LinkedHashMapå®ç°ä¸€ä¸ªç®€å•çš„LRUã€‚</p><a id="more"></a><h2 id="ç±»ç»“æ„"><a href="#ç±»ç»“æ„" class="headerlink" title="ç±»ç»“æ„"></a>ç±»ç»“æ„</h2><p>LinkedHashMapç±»å±‚çº§å…³ç³»å›¾ï¼š</p><p><img src="img/QQ20210225-143918@2x.png" alt="QQ20210225-143918@2x"></p><p>LinkedHashMapç»§æ‰¿è‡ªHashMapï¼Œå¤§éƒ¨åˆ†æ–¹æ³•éƒ½æ˜¯ç›´æ¥ä½¿ç”¨HashMapçš„ã€‚æ¥ç€æŸ¥çœ‹æˆå‘˜å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒå‘é“¾è¡¨çš„å¤´éƒ¨èŠ‚ç‚¹ï¼ˆæœ€æ—©æ’å…¥çš„ï¼Œå¹´çºªæœ€å¤§çš„èŠ‚ç‚¹ï¼‰</span></span><br><span class="line"><span class="keyword">transient</span> LinkedHashMap.Entry&lt;K,V&gt; head;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒå‘é“¾è¡¨çš„å°¾éƒ¨èŠ‚ç‚¹ï¼ˆæœ€æ–°æ’å…¥çš„ï¼Œå¹´çºªæœ€å°çš„èŠ‚ç‚¹ï¼‰</span></span><br><span class="line"><span class="keyword">transient</span> LinkedHashMap.Entry&lt;K,V&gt; tail;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºæ§åˆ¶è®¿é—®é¡ºåºï¼Œä¸ºtrueæ—¶ï¼ŒæŒ‰æ’å…¥é¡ºåºï¼›ä¸ºfalseæ—¶ï¼ŒæŒ‰è®¿é—®é¡ºåº</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> accessOrder;</span><br></pre></td></tr></table></figure><p></p><p>headå’Œtailä½¿ç”¨transientä¿®é¥°ï¼ŒåŸå› åœ¨ä»‹ç»<a href="/Java-HashMapåº•å±‚å®ç°åŸç†.html">HashMapæºç </a>çš„æ—¶å€™åˆ†æè¿‡ã€‚</p><p>LinkedHashMapç»§æ‰¿è‡ªHashMapï¼Œæ‰€ä»¥å†…éƒ¨å­˜å‚¨æ•°æ®çš„æ–¹å¼å’ŒHashMapä¸€æ ·ï¼Œä½¿ç”¨æ•°ç»„åŠ é“¾è¡¨ï¼ˆçº¢é»‘æ ‘ï¼‰çš„ç»“æ„å­˜å‚¨æ•°æ®ï¼ŒLinkedHashMapå’ŒHashMapç›¸æ¯”ï¼Œé¢å¤–çš„ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œç”¨äºå­˜å‚¨èŠ‚ç‚¹çš„é¡ºåºã€‚è¿™ä¸ªåŒå‘é“¾è¡¨çš„ç±»å‹ä¸ºLinkedHashMap.Entryï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMap</span>.<span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    Entry&lt;K,V&gt; before, after;</span><br><span class="line">    Entry(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">super</span>(hash, key, value, next);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>LinkedHashMap.Entryç±»å±‚çº§å…³ç³»å›¾ï¼š</p><p><img src="img/QQ20210225-145250@2x.png" alt="QQ20210225-145250@2x"></p><p>LinkedHashMap.Entryç»§æ‰¿è‡ªHashMapçš„Nodeç±»ï¼Œæ–°å¢äº†beforeå’Œafterå±æ€§ï¼Œç”¨äºç»´æŠ¤å‰ç»§å’Œåç»§èŠ‚ç‚¹ï¼Œä»¥æ­¤å½¢æˆåŒå‘é“¾è¡¨ã€‚</p><h2 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h2><p>LinkedHashMapçš„æ„é€ å‡½æ•°å…¶å®æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œå°±æ˜¯è°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨åˆå§‹åŒ–HashMapçš„è¿‡ç¨‹ï¼Œåªä¸è¿‡é¢å¤–å¤šäº†åˆå§‹åŒ–LinkedHashMapçš„accessOrderå±æ€§çš„æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(initialCapacity, loadFactor);</span><br><span class="line">    accessOrder = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(initialCapacity);</span><br><span class="line">    accessOrder = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    accessOrder = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    accessOrder = <span class="keyword">false</span>;</span><br><span class="line">    putMapEntries(m, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">float</span> loadFactor,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">boolean</span> accessOrder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(initialCapacity, loadFactor);</span><br><span class="line">    <span class="keyword">this</span>.accessOrder = accessOrder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h2><p>åœ¨åˆ†æLinkedHashMapæ–¹æ³•å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡ä¾‹å­æ„Ÿå—ä¸‹LinkedHashMapçš„ç‰¹æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashMap&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(<span class="number">16</span>, <span class="number">0.75f</span>, <span class="keyword">false</span>);</span><br><span class="line">map.put(<span class="string">"1"</span>, <span class="string">"a"</span>);</span><br><span class="line">map.put(<span class="string">"6"</span>, <span class="string">"b"</span>);</span><br><span class="line">map.put(<span class="string">"3"</span>, <span class="string">"c"</span>);</span><br><span class="line">System.out.println(map);</span><br><span class="line"></span><br><span class="line">map.get(<span class="string">"6"</span>);</span><br><span class="line">System.out.println(map);</span><br><span class="line"></span><br><span class="line">map.put(<span class="string">"4"</span>, <span class="string">"d"</span>);</span><br><span class="line">System.out.println(map);</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="number">1</span>=a, <span class="number">6</span>=b, <span class="number">3</span>=c&#125;</span><br><span class="line">&#123;<span class="number">1</span>=a, <span class="number">6</span>=b, <span class="number">3</span>=c&#125;</span><br><span class="line">&#123;<span class="number">1</span>=a, <span class="number">6</span>=b, <span class="number">3</span>=c, <span class="number">4</span>=d&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°å…ƒç´ çš„è¾“å‡ºé¡ºåºå°±æ˜¯æˆ‘ä»¬æ’å…¥çš„é¡ºåºã€‚</p><p>å°†accessOrderå±æ€§æ”¹ä¸ºtrueï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="number">1</span>=a, <span class="number">6</span>=b, <span class="number">3</span>=c&#125;</span><br><span class="line">&#123;<span class="number">1</span>=a, <span class="number">3</span>=c, <span class="number">6</span>=b&#125;</span><br><span class="line">&#123;<span class="number">1</span>=a, <span class="number">3</span>=c, <span class="number">6</span>=b, <span class="number">4</span>=d&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸€å¼€å§‹è¾“å‡º<code>{1=a, 6=b, 3=c}</code>ã€‚å½“æˆ‘ä»¬é€šè¿‡getæ–¹æ³•è®¿é—®keyä¸º6çš„é”®å€¼å¯¹åï¼Œç¨‹åºè¾“å‡º<code>{1=a, 3=c, 6=b}</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“accessOrderå±æ€§ä¸ºtrueæ—¶ï¼Œå…ƒç´ æŒ‰è®¿é—®é¡ºåºæ’åˆ—ï¼Œå³æœ€è¿‘è®¿é—®çš„å…ƒç´ ä¼šè¢«ç§»åŠ¨åˆ°åŒå‘åˆ—è¡¨çš„æœ«å°¾ã€‚æ‰€è°“çš„â€œè®¿é—®â€å¹¶ä¸æ˜¯åªæœ‰getæ–¹æ³•ï¼Œç¬¦åˆâ€œè®¿é—®â€ä¸€è¯çš„æ“ä½œæœ‰putã€putIfAbsentã€getã€getOrDefaultã€computeã€computeIfAbsentã€computeIfPresentå’Œmergeæ–¹æ³•ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡æ–¹æ³•æºç çš„åˆ†æå°±èƒ½æ¸…æ¥šåœ°çŸ¥é“LinkedHashMapæ˜¯å¦‚ä½•æ§åˆ¶å…ƒç´ è®¿é—®é¡ºåºçš„ã€‚</p><h2 id="æ–¹æ³•è§£æ"><a href="#æ–¹æ³•è§£æ" class="headerlink" title="æ–¹æ³•è§£æ"></a>æ–¹æ³•è§£æ</h2><h3 id="put-K-key-V-value"><a href="#put-K-key-V-value" class="headerlink" title="put(K key, V value)"></a>put(K key, V value)</h3><p>LinkedHashMapå¹¶æ²¡æœ‰é‡å†™put(K key, V value)æ–¹æ³•ï¼Œç›´æ¥ä½¿ç”¨HashMapçš„put(K key, V value)æ–¹æ³•ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œæ—¢ç„¶LinkedHashMapæ²¡æœ‰é‡å†™put(K key, V value)ï¼Œé‚£å®ƒæ˜¯å¦‚ä½•é€šè¿‡å†…éƒ¨çš„åŒå‘é“¾è¡¨ç»´æŠ¤å…ƒç´ é¡ºåºçš„ï¼Ÿæˆ‘ä»¬æŸ¥çœ‹put(K key, V value)æ–¹æ³•æºç å°±èƒ½å‘ç°åŸå› ï¼ˆå› ä¸ºput(K key, V value)æºç åœ¨<a href="/Java-HashMapåº•å±‚å®ç°åŸç†.html">Java-HashMapåº•å±‚å®ç°åŸç†</a>ä¸€èŠ‚ä¸­å·²ç»å‰–æè¿‡ï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬åªåœ¨å’ŒLinkedHashMapåŠŸèƒ½ç›¸å…³çš„ä»£ç ä¸Šæ·»åŠ æ³¨é‡Šï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">// åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            <span class="comment">// æ–¹æ³•å†…éƒ¨åŒ…å«newTreeNodeçš„æ“ä½œ</span></span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            <span class="comment">// èŠ‚ç‚¹è®¿é—®åç»­æ“ä½œ</span></span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹æ’å…¥åç»­æ“ä½œ</span></span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>newNodeæ–¹æ³•ç”¨äºåˆ›å»ºé“¾è¡¨èŠ‚ç‚¹ï¼ŒLinkedHashMapé‡å†™äº†newNodeæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Node&lt;K,V&gt; <span class="title">newNode</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºLinkedHashMap.Entryå®ä¾‹</span></span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; p =</span><br><span class="line">        <span class="keyword">new</span> LinkedHashMap.Entry&lt;K,V&gt;(hash, key, value, e);</span><br><span class="line">    <span class="comment">// å°†æ–°èŠ‚ç‚¹æ”¾å…¥LinkedHashMapç»´æŠ¤çš„åŒå‘é“¾è¡¨å°¾éƒ¨</span></span><br><span class="line">    linkNodeLast(p);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">linkNodeLast</span><span class="params">(LinkedHashMap.Entry&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; last = tail;</span><br><span class="line">    tail = p;</span><br><span class="line">    <span class="comment">// å¦‚æœå°¾èŠ‚ç‚¹ä¸ºç©ºï¼Œè¯´æ˜åŒå‘é“¾è¡¨æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥å°†è¯¥èŠ‚ç‚¹èµ‹å€¼ç»™å¤´èŠ‚ç‚¹ï¼ŒåŒå‘é“¾è¡¨å¾—ä»¥åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (last == <span class="keyword">null</span>)</span><br><span class="line">        head = p;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦åˆ™å°†è¯¥èŠ‚ç‚¹æ”¾åˆ°åŒå‘é“¾è¡¨çš„å°¾éƒ¨</span></span><br><span class="line">        p.before = last;</span><br><span class="line">        last.after = p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºLinkedHashMapå®ä¾‹ï¼Œputæ“ä½œå†…éƒ¨åˆ›å»ºçš„çš„èŠ‚ç‚¹ç±»å‹ä¸ºLinkedHashMap.Entryï¼Œé™¤äº†å¾€HashMapå†…éƒ¨tableæ’å…¥æ•°æ®å¤–ï¼Œè¿˜å¾€LinkedHashMapçš„åŒå‘é“¾è¡¨å°¾éƒ¨æ’å…¥äº†æ•°æ®ã€‚</p><p>å¦‚æœæ˜¯å¾€çº¢é»‘æ ‘ç»“æ„æ’å…¥æ•°æ®ï¼Œé‚£ä¹ˆputå°†è°ƒç”¨putTreeValæ–¹æ³•å¾€çº¢é»‘æ ‘é‡Œæ’å…¥èŠ‚ç‚¹ï¼ŒputTreeValæ–¹æ³•å†…éƒ¨é€šè¿‡newTreeNodeæ–¹æ³•åˆ›å»ºæ ‘èŠ‚ç‚¹ã€‚LinkedHashMapé‡å†™äº†newTreeNodeæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TreeNode&lt;K,V&gt; <span class="title">newTreeNode</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºTreeNodeå®ä¾‹</span></span><br><span class="line">    TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;(hash, key, value, next);</span><br><span class="line">    <span class="comment">// å°†æ–°èŠ‚ç‚¹æ”¾å…¥LinkedHashMapç»´æŠ¤çš„åŒå‘é“¾è¡¨å°¾éƒ¨</span></span><br><span class="line">    linkNodeLast(p);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>èŠ‚ç‚¹ç±»å‹ä¸ºTreeNodeï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å‹æ˜¯åœ¨å“ªé‡Œå®šä¹‰çš„å‘¢ï¼Ÿå…¶å®TreeNodeä¸ºHashMapé‡Œå®šä¹‰çš„ï¼ŒæŸ¥çœ‹å…¶æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; parent;  <span class="comment">// red-black tree links</span></span><br><span class="line">    TreeNode&lt;K,V&gt; left;</span><br><span class="line">    TreeNode&lt;K,V&gt; right;</span><br><span class="line">    TreeNode&lt;K,V&gt; prev;    <span class="comment">// needed to unlink next upon deletion</span></span><br><span class="line">    <span class="keyword">boolean</span> red;</span><br><span class="line">    TreeNode(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">super</span>(hash, key, val, next);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>TreeNodeç»§æ‰¿è‡ªLinkedHashMap.Entryï¼š</p><p><img src="img/QQ20210225-160155@2x.png" alt="QQ20210225-160155@2x"></p><p>æ‰€ä»¥TreeNodeä¹ŸåŒ…å«beforeå’Œafterå±æ€§ï¼Œå³ä½¿æ’å…¥çš„èŠ‚ç‚¹ç±»å‹ä¸ºTreeNodeï¼Œä¾æ—§å¯ä»¥ç”¨LinkedHashMapåŒå‘é“¾è¡¨ç»´æŠ¤èŠ‚ç‚¹é¡ºåºã€‚</p><p>åœ¨putæ–¹æ³•ä¸­ï¼Œå¦‚æœæ’å…¥çš„keyå·²ç»å­˜åœ¨çš„è¯ï¼Œè¿˜ä¼šæ‰§è¡ŒafterNodeAccessæ“ä½œï¼Œè¯¥æ–¹æ³•åœ¨HashMapä¸­ä¸ºç©ºæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeAccess</span><span class="params">(Node&lt;K,V&gt; p)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure><p></p><p>afterNodeAccessæ–¹æ³•é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å½“èŠ‚ç‚¹è¢«è®¿é—®åæ‰§è¡ŒæŸäº›æ“ä½œã€‚LinkedHashMapé‡å†™äº†è¿™ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeAccess</span><span class="params">(Node&lt;K,V&gt; e)</span> </span>&#123; <span class="comment">// move node to last</span></span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; last;</span><br><span class="line">    <span class="comment">// å¦‚æœaccessOrderå±æ€§ä¸ºtrueï¼Œå¹¶ä¸”å½“å‰èŠ‚ç‚¹ä¸æ˜¯åŒå‘é“¾è¡¨çš„å°¾èŠ‚ç‚¹çš„è¯æ‰§è¡Œifå†…é€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span> (accessOrder &amp;&amp; (last = tail) != e) &#123;</span><br><span class="line">        <span class="comment">// è¿™éƒ¨åˆ†é€»è¾‘ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å°†å½“å‰èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒå‘é“¾è¡¨çš„å°¾éƒ¨ï¼Œå¹¶ä¸”æ”¹å˜ç›¸å…³èŠ‚ç‚¹çš„å‰ç»§åç»§å…³ç³»</span></span><br><span class="line">        LinkedHashMap.Entry&lt;K,V&gt; p =</span><br><span class="line">            (LinkedHashMap.Entry&lt;K,V&gt;)e, b = p.before, a = p.after;</span><br><span class="line">        p.after = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="keyword">null</span>)</span><br><span class="line">            head = a;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            b.after = a;</span><br><span class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>)</span><br><span class="line">            a.before = b;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            last = b;</span><br><span class="line">        <span class="keyword">if</span> (last == <span class="keyword">null</span>)</span><br><span class="line">            head = p;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            p.before = last;</span><br><span class="line">            last.after = p;</span><br><span class="line">        &#125;</span><br><span class="line">        tail = p;</span><br><span class="line">        ++modCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ‰€ä»¥å½“accessOrderä¸ºtrueæ—¶å€™ï¼Œè°ƒç”¨LinkedHashMapçš„putæ–¹æ³•ï¼Œæ’å…¥ç›¸åŒkeyå€¼çš„é”®å€¼å¯¹æ—¶ï¼Œè¯¥é”®å€¼å¯¹ä¼šè¢«ç§»åŠ¨åˆ°å°¾éƒ¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashMap&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(<span class="number">16</span>, <span class="number">0.75f</span>, <span class="keyword">true</span>);</span><br><span class="line">map.put(<span class="string">"1"</span>, <span class="string">"a"</span>);</span><br><span class="line">map.put(<span class="string">"6"</span>, <span class="string">"b"</span>);</span><br><span class="line">map.put(<span class="string">"3"</span>, <span class="string">"c"</span>);</span><br><span class="line">System.out.println(map);</span><br><span class="line">map.put(<span class="string">"6"</span>, <span class="string">"b"</span>);</span><br><span class="line">System.out.println(map);</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;1=a, 6=b, 3=c&#125;</span><br><span class="line">&#123;1=a, 3=c, 6=b&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨putæ–¹æ³•å°¾éƒ¨ï¼Œè¿˜è°ƒç”¨äº†afterNodeInsertionæ–¹æ³•ï¼Œæ–¹æ³•é¡¾åæ€ä¹‰ï¼Œç”¨äºæ’å…¥èŠ‚ç‚¹åæ‰§è¡ŒæŸäº›æ“ä½œï¼Œè¯¥æ–¹æ³•åœ¨HashMapä¸­ä¹Ÿæ˜¯ç©ºæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeInsertion</span><span class="params">(<span class="keyword">boolean</span> evict)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure><p></p><p>LinkedHashMapé‡å†™äº†è¯¥æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œevictä¸ºtrue</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeInsertion</span><span class="params">(<span class="keyword">boolean</span> evict)</span> </span>&#123; <span class="comment">// possibly remove eldest</span></span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; first;</span><br><span class="line">    <span class="comment">// å¦‚æœå¤´éƒ¨èŠ‚ç‚¹ä¸ä¸ºç©ºå¹¶ä¸”removeEldestEntryè¿”å›trueçš„è¯</span></span><br><span class="line">    <span class="keyword">if</span> (evict &amp;&amp; (first = head) != <span class="keyword">null</span> &amp;&amp; removeEldestEntry(first)) &#123;</span><br><span class="line">        <span class="comment">// è·å–å¤´éƒ¨èŠ‚ç‚¹çš„key</span></span><br><span class="line">        K key = first.key;</span><br><span class="line">        <span class="comment">// è°ƒç”¨çˆ¶ç±»HashMapçš„removeNodeæ–¹æ³•ï¼Œåˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">        removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;K,V&gt; eldest)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åœ¨LinkedHashMapä¸­ï¼Œè¯¥æ–¹æ³•æ°¸è¿œè¿”å›false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»§æ‰¿LinkedHashMapçš„æ–¹å¼é‡å†™removeEldestEntryæ–¹æ³•ï¼Œä»¥æ­¤å®ç°LRUï¼Œä¸‹é¢å†åšå®ç°ã€‚</p><p>ä½ å¯èƒ½ä¼šé—®ï¼ŒremoveNodeåˆ é™¤çš„æ˜¯HashMapçš„tableä¸­çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç”¨äºç»´æŠ¤èŠ‚ç‚¹é¡ºåºçš„åŒå‘é“¾è¡¨ä¸æ˜¯ä¹Ÿåº”è¯¥åˆ é™¤å¤´éƒ¨èŠ‚ç‚¹å—ï¼Ÿä¸ºä»€ä¹ˆä¸Šé¢ä»£ç æ²¡æœ‰çœ‹åˆ°è¿™éƒ¨åˆ†æ“ä½œï¼Ÿå…¶å®å½“ä½ æŸ¥çœ‹removeNodeæ–¹æ³•çš„æºç å°±èƒ½çœ‹åˆ°è¿™éƒ¨åˆ†æ“ä½œäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">removeNode</span><span class="params">(<span class="keyword">int</span> hash, Object key, Object value,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">boolean</span> matchValue, <span class="keyword">boolean</span> movable)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, index;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (p = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt; node = <span class="keyword">null</span>, e; K k; V v;</span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            node = p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((e = p.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                        ((k = e.key) == key ||</span><br><span class="line">                         (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                        node = e;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    p = e;</span><br><span class="line">                &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (node != <span class="keyword">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||</span><br><span class="line">                             (value != <span class="keyword">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (node <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class="keyword">this</span>, tab, movable);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (node == p)</span><br><span class="line">                tab[index] = node.next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p.next = node.next;</span><br><span class="line">            ++modCount;</span><br><span class="line">            --size;</span><br><span class="line">            <span class="comment">// èŠ‚ç‚¹åˆ é™¤åï¼Œæ‰§è¡Œåç»­æ“ä½œ</span></span><br><span class="line">            afterNodeRemoval(node);</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>afterNodeRemovalæ–¹æ³•é¡¾åæ€ä¹‰ï¼Œç”¨äºèŠ‚ç‚¹åˆ é™¤åæ‰§è¡Œåç»­æ“ä½œã€‚è¯¥æ–¹æ³•åœ¨HashMapä¸­ä¸ºç©ºæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeRemoval</span><span class="params">(Node&lt;K,V&gt; p)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure><p></p><p>LinkedHashMapé‡å†™äº†è¯¥æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ”¹å˜èŠ‚ç‚¹çš„å‰ç»§åç»§å¼•ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeRemoval</span><span class="params">(Node&lt;K,V&gt; e)</span> </span>&#123; <span class="comment">// unlink</span></span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; p =</span><br><span class="line">        (LinkedHashMap.Entry&lt;K,V&gt;)e, b = p.before, a = p.after;</span><br><span class="line">    p.before = p.after = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="keyword">null</span>)</span><br><span class="line">        head = a;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        b.after = a;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="keyword">null</span>)</span><br><span class="line">        tail = b;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        a.before = b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡è¯¥æ–¹æ³•ï¼Œæˆ‘ä»¬å°±ä»LinkedHashMapçš„åŒå‘é“¾è¡¨ä¸­åˆ é™¤äº†å¤´éƒ¨ç»“ç‚¹ã€‚</p><blockquote><p>å…¶å®é€šè¿‡putæ–¹æ³•æˆ‘ä»¬å°±å·²ç»ææ¸…æ¥šäº†LinkedHashMapå†…éƒ¨æ˜¯å¦‚ä½•é€šè¿‡åŒå‘é“¾è¡¨ç»´æŠ¤é”®å€¼å¯¹é¡ºåºçš„ï¼Œä½†ä¸ºäº†è®©æ–‡ç« æ›´é¥±æ»¡ä¸€ç‚¹ï¼Œä¸‹é¢ç»§ç»­åˆ†æå‡ ä¸ªæ–¹æ³•æºç ã€‚</p></blockquote><h2 id="get-Object-key"><a href="#get-Object-key" class="headerlink" title="get(Object key)"></a>get(Object key)</h2><p>LinkedHashMapé‡å†™äº†HashMapçš„getæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// å¤šäº†è¿™ä¸€æ­¥æ“ä½œï¼Œå½“accessOrderå±æ€§ä¸ºtrueæ—¶ï¼Œå°†keyå¯¹åº”çš„é”®å€¼å¯¹èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒå‘åˆ—è¡¨çš„å°¾éƒ¨</span></span><br><span class="line">    <span class="keyword">if</span> (accessOrder)</span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">    <span class="keyword">return</span> e.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="remove-Object-key"><a href="#remove-Object-key" class="headerlink" title="remove(Object key)"></a>remove(Object key)</h2><p>LinkedHashMapæ²¡æœ‰é‡å†™removeæ–¹æ³•ï¼ŒæŸ¥çœ‹HashMapçš„removeæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="comment">// è°ƒç”¨removeNodeåˆ é™¤èŠ‚ç‚¹ï¼ŒremoveNodeæ–¹æ³•å†…éƒ¨è°ƒç”¨äº†afterNodeRemovalæ–¹æ³•ï¼Œä¸Šé¢ä»‹ç»put</span></span><br><span class="line">    <span class="comment">// æ–¹æ³•æ—¶åˆ†æè¿‡äº†ï¼Œæ‰€ä»¥ä¸å†èµ˜è¿°</span></span><br><span class="line">    <span class="keyword">return</span> (e = removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>)) == <span class="keyword">null</span> ?</span><br><span class="line">        <span class="keyword">null</span> : e.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="è¿­ä»£å™¨"><a href="#è¿­ä»£å™¨" class="headerlink" title="è¿­ä»£å™¨"></a>è¿­ä»£å™¨</h2><p>æ—¢ç„¶LinkedHashMapå†…éƒ¨é€šè¿‡åŒå‘é“¾è¡¨ç»´æŠ¤é”®å€¼å¯¹é¡ºåºçš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥çŒœæµ‹éå†LinkedHashMapå®é™…å°±æ˜¯éå†LinkedHashMapç»´æŠ¤çš„åŒå‘é“¾è¡¨ï¼š</p><p>æŸ¥çœ‹LinkedHashMapç±»entrySetæ–¹æ³•çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet() &#123;</span><br><span class="line">    Set&lt;Map.Entry&lt;K,V&gt;&gt; es;</span><br><span class="line">    <span class="comment">// åˆ›å»ºLinkedEntrySet</span></span><br><span class="line">    <span class="keyword">return</span> (es = entrySet) == <span class="keyword">null</span> ? (entrySet = <span class="keyword">new</span> LinkedEntrySet()) : es;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedEntrySet</span> <span class="keyword">extends</span> <span class="title">AbstractSet</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span>                 </span>&#123; <span class="keyword">return</span> size; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span>               </span>&#123; LinkedHashMap.<span class="keyword">this</span>.clear(); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Iterator&lt;Map.Entry&lt;K,V&gt;&gt; iterator() &#123;</span><br><span class="line">        <span class="comment">// è¿­ä»£å™¨ç±»å‹ä¸ºLinkedEntryIterator</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LinkedEntryIterator();</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LinkedEntryIteratorç»§æ‰¿è‡ªLinkedHashIterator</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedEntryIterator</span> <span class="keyword">extends</span> <span class="title">LinkedHashIterator</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// nextæ–¹æ³•å†…éƒ¨è°ƒç”¨LinkedHashIteratorçš„nextNodeæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Map.<span class="function">Entry&lt;K,V&gt; <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> nextNode(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedHashIterator</span> </span>&#123;</span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; next;</span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; current;</span><br><span class="line">    <span class="keyword">int</span> expectedModCount;</span><br><span class="line"></span><br><span class="line">    LinkedHashIterator() &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–æ—¶ï¼Œå°†åŒå‘é“¾è¡¨çš„å¤´éƒ¨èŠ‚ç‚¹èµ‹å€¼ç»™nextï¼Œè¯´æ˜éå†LinkedHashMapæ˜¯ä»</span></span><br><span class="line">        <span class="comment">// LinkedHashMapçš„åŒå‘é“¾è¡¨å¤´éƒ¨å¼€å§‹çš„</span></span><br><span class="line">        next = head;</span><br><span class="line">        <span class="comment">// åŒæ ·ä¹Ÿæœ‰å¿«é€Ÿå¤±è´¥çš„ç‰¹æ€§</span></span><br><span class="line">        expectedModCount = modCount;</span><br><span class="line">        current = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> next != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> LinkedHashMap.<span class="function">Entry&lt;K,V&gt; <span class="title">nextNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LinkedHashMap.Entry&lt;K,V&gt; e = next;</span><br><span class="line">        <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">        current = e;</span><br><span class="line">        <span class="comment">// ä¸æ–­è·å–å½“å‰èŠ‚ç‚¹çš„afterèŠ‚ç‚¹ï¼Œéå†</span></span><br><span class="line">        next = e.after;</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šè¿°ä»£ç ç¬¦åˆæˆ‘ä»¬çš„çŒœæµ‹ã€‚</p><h2 id="LRUç®€å•å®ç°"><a href="#LRUç®€å•å®ç°" class="headerlink" title="LRUç®€å•å®ç°"></a>LRUç®€å•å®ç°</h2><p>LRUï¼ˆLeast Recently Usedï¼‰æŒ‡çš„æ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œæ˜¯ä¸€ç§ç¼“å­˜æ·˜æ±°ç®—æ³•ï¼Œå“ªä¸ªæœ€è¿‘ä¸æ€ä¹ˆç”¨äº†å°±æ·˜æ±°æ‰ã€‚</p><p>æˆ‘ä»¬çŸ¥é“LinkedHashMapå†…çš„removeEldestEntryæ–¹æ³•å›ºå®šè¿”å›falseï¼Œå¹¶ä¸ä¼šæ‰§è¡Œå…ƒç´ åˆ é™¤æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»§æ‰¿LinkedHashMapï¼Œé‡å†™removeEldestEntryæ–¹æ³•æ¥å®ç°LRUã€‚</p><p>å‡å¦‚æˆ‘ä»¬ç°åœ¨æœ‰å¦‚ä¸‹éœ€æ±‚ï¼š</p><p>ç”¨LinkedHashMapå®ç°ç¼“å­˜ï¼Œç¼“å­˜æœ€å¤šåªèƒ½å­˜å‚¨5ä¸ªå…ƒç´ ï¼Œå½“å…ƒç´ ä¸ªæ•°è¶…è¿‡5çš„æ—¶å€™ï¼Œåˆ é™¤ï¼ˆæ·˜æ±°ï¼‰é‚£äº›æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®ï¼Œä»…ä¿å­˜çƒ­ç‚¹æ•°æ®ã€‚</p><p>æ–°å»ºLRUCacheç±»ï¼Œç»§æ‰¿LinkedHashMapï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LRUCache</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¼“å­˜å…è®¸çš„æœ€å¤§å®¹é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxSize;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRUCache</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxSize)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// accessOrderå¿…é¡»ä¸ºtrue</span></span><br><span class="line">        <span class="keyword">super</span>(initialCapacity, <span class="number">0.75f</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">this</span>.maxSize = maxSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;K, V&gt; eldest)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å½“é”®å€¼å¯¹ä¸ªæ•°è¶…è¿‡æœ€å¤§å®¹é‡æ—¶ï¼Œè¿”å›trueï¼Œè§¦å‘åˆ é™¤æ“ä½œ</span></span><br><span class="line">        <span class="keyword">return</span> size() &gt; maxSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        LRUCache&lt;String, String&gt; cache = <span class="keyword">new</span> LRUCache&lt;&gt;(<span class="number">5</span>, <span class="number">5</span>);</span><br><span class="line">        cache.put(<span class="string">"1"</span>, <span class="string">"a"</span>);</span><br><span class="line">        cache.put(<span class="string">"2"</span>, <span class="string">"b"</span>);</span><br><span class="line">        cache.put(<span class="string">"3"</span>, <span class="string">"c"</span>);</span><br><span class="line">        cache.put(<span class="string">"4"</span>, <span class="string">"d"</span>);</span><br><span class="line">        cache.put(<span class="string">"5"</span>, <span class="string">"e"</span>);</span><br><span class="line">        cache.put(<span class="string">"6"</span>, <span class="string">"f"</span>);</span><br><span class="line">        System.out.println(cache);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="number">2</span>=b, <span class="number">3</span>=c, <span class="number">4</span>=d, <span class="number">5</span>=e, <span class="number">6</span>=f&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°æœ€æ—©æ’å…¥çš„1=aå·²ç»è¢«åˆ é™¤äº†ã€‚</p><p>é€šè¿‡LinkedHashMapå®ç°LRUè¿˜æ˜¯æŒºå¸¸è§çš„ï¼Œæ¯”å¦‚logbackæ¡†æ¶çš„LRUMessageCacheï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LRUMessageCache</span> <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> cacheSize;</span><br><span class="line"></span><br><span class="line">    LRUMessageCache(<span class="keyword">int</span> cacheSize) &#123;</span><br><span class="line">        <span class="keyword">super</span>((<span class="keyword">int</span>) (cacheSize * (<span class="number">4.0f</span> / <span class="number">3</span>)), <span class="number">0.75f</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (cacheSize &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cache size cannot be smaller than 1"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.cacheSize = cacheSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getMessageCountAndThenIncrement</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// don't insert null elements</span></span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Integer i;</span><br><span class="line">        <span class="comment">// LinkedHashMap is not LinkedHashMap. See also LBCLASSIC-255</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            i = <span class="keyword">super</span>.get(msg);</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="keyword">null</span>) &#123;</span><br><span class="line">                i = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                i = i + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.put(msg, i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// called indirectly by get() or put() which are already supposed to be</span></span><br><span class="line">    <span class="comment">// called from within a synchronized block</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry eldest)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (size() &gt; cacheSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:20 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;HashMapå…ƒç´ æ’å…¥æ˜¯æ— åºçš„ï¼Œä¸ºäº†è®©éå†é¡ºåºå’Œæ’å…¥é¡ºåºä¸€è‡´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨LinkedHashMapï¼Œå…¶å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥å­˜å‚¨å…ƒç´ é¡ºåºï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡accessOrderå±æ€§æ§åˆ¶éé¡ºåºä¸ºæ’å…¥é¡ºåºæˆ–è€…ä¸ºè®¿é—®é¡ºåºã€‚æœ¬èŠ‚å°†è®°å½•LinkedHashMapçš„å†…éƒ¨å®ç°åŸç†ï¼ŒåŸºäºJDK1.8ï¼Œå¹¶ä¸”ç”¨LinkedHashMapå®ç°ä¸€ä¸ªç®€å•çš„LRUã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>HashTableæºç è§£æ</title>
    <link href="http://mrbird.cc/HashTable%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html"/>
    <id>http://mrbird.cc/HashTableæºç è§£æ.html</id>
    <published>2020-08-27T03:25:38.000Z</published>
    <updated>2021-02-25T03:16:52.783Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:19 GMT+0800 (GMT+08:00) --><p>HashTableæ˜¯Mapæ¥å£çº¿ç¨‹å®‰å…¨å®ç°ç‰ˆæœ¬ï¼Œæ•°æ®ç»“æ„å’Œæ–¹æ³•å®ç°ä¸HashMapç±»ä¼¼ï¼Œæœ¬æ–‡è®°å½•HashTableæºç è§£æï¼ŒåŸºäºJDK1.8ã€‚<a id="more"></a></p><h2 id="ç±»ç»“æ„"><a href="#ç±»ç»“æ„" class="headerlink" title="ç±»ç»“æ„"></a>ç±»ç»“æ„</h2><p>HashTableç±»å±‚çº§å…³ç³»å›¾ï¼š <img src="img/QQ20210224-141934@2x.png" alt="QQ20210224-141934@2x"></p><p>ä¸»è¦æˆå‘˜å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†…éƒ¨é‡‡ç”¨Entryæ•°ç»„å­˜å‚¨é”®å€¼å¯¹æ•°æ®ï¼ŒEntryå®é™…ä¸ºå•å‘é“¾è¡¨çš„è¡¨å¤´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Entry&lt;?,?&gt;[] table;</span><br><span class="line"><span class="comment">// HashTableé‡Œé”®å€¼å¯¹ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> count;</span><br><span class="line"><span class="comment">// æ‰©å®¹é˜ˆå€¼ï¼Œå½“è¶…è¿‡è¿™ä¸ªå€¼æ—¶ï¼Œè¿›è¡Œæ‰©å®¹æ“ä½œï¼Œè®¡ç®—æ–¹å¼ä¸ºï¼šæ•°ç»„å®¹é‡*åŠ è½½å› å­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> threshold;</span><br><span class="line"><span class="comment">// åŠ è½½å› å­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">float</span> loadFactor;</span><br><span class="line"><span class="comment">// ç”¨äºå¿«é€Ÿå¤±è´¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> modCount = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p></p><p>tableå±æ€§é€šè¿‡transientä¿®é¥°ï¼ŒåŸå› åœ¨ä»‹ç»<a href="/Java-HashMapåº•å±‚å®ç°åŸç†.html">HashMapæºç </a>çš„æ—¶å€™åˆ†æè¿‡ã€‚</p><p>Entryä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Entry&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Entry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, Entry&lt;K,V&gt; next)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.hash = hash;</span><br><span class="line">        <span class="keyword">this</span>.key =  key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>Entryä¸ºå•å‘é“¾è¡¨èŠ‚ç‚¹ï¼ŒHashTableé‡‡ç”¨æ•°ç»„åŠ é“¾è¡¨çš„æ–¹å¼å­˜å‚¨æ•°æ®ï¼Œä¸è¿‡æ²¡æœ‰ç±»ä¼¼äºHashMapä¸­å½“é“¾è¡¨è¿‡é•¿æ—¶è½¬æ¢ä¸ºçº¢é»‘æ ‘çš„æ“ä½œã€‚</p><h2 id="æ–¹æ³•è§£æ"><a href="#æ–¹æ³•è§£æ" class="headerlink" title="æ–¹æ³•è§£æ"></a>æ–¹æ³•è§£æ</h2><h3 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®æŒ‡å®šå®¹é‡å’ŒåŠ è½½å› å­ï¼Œåˆå§‹åŒ–HashTable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Hashtable</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal Capacity: "</span>+</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal Load: "</span>+loadFactor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity==<span class="number">0</span>)</span><br><span class="line">        <span class="comment">// å®¹é‡æœ€å°ä¸º1</span></span><br><span class="line">        initialCapacity = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">    table = <span class="keyword">new</span> Entry&lt;?,?&gt;[initialCapacity];</span><br><span class="line">    <span class="comment">// åˆå§‹æ‰©å®¹é˜ˆå€¼</span></span><br><span class="line">    threshold = (<span class="keyword">int</span>)Math.min(initialCapacity * loadFactor, MAX_ARRAY_SIZE + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æŒ‡å®šå®¹é‡åˆå§‹HashTableï¼ŒåŠ è½½å› å­ä¸º0.75</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Hashtable</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(initialCapacity, <span class="number">0.75f</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰‹åŠ¨æŒ‡å®šæ•°ç»„åˆå§‹å®¹é‡ä¸º11ï¼ŒåŠ è½½å› å­ä¸º0.75</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Hashtable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(<span class="number">11</span>, <span class="number">0.75f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="put-K-key-V-value"><a href="#put-K-key-V-value" class="headerlink" title="put(K key, V value)"></a>put(K key, V value)</h3><p><code>put(K key, V value)</code>æ·»åŠ æŒ‡å®šé”®å€¼å¯¹ï¼Œé”®å’Œå€¼éƒ½ä¸èƒ½ä¸ºnullï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹æ³•synchronizedä¿®é¥°ï¼Œçº¿ç¨‹å®‰å…¨</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Make sure the value is not null</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">    Entry&lt;?,?&gt; tab[] = table;</span><br><span class="line">    <span class="comment">// å¾—åˆ°keyçš„å“ˆå¸Œå€¼</span></span><br><span class="line">    <span class="keyword">int</span> hash = key.hashCode();</span><br><span class="line">    <span class="comment">// å¾—åˆ°è¯¥keyå­˜åœ¨åˆ°æ•°ç»„ä¸­çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="comment">// å¾—åˆ°è¯¥ä¸‹æ ‡å¯¹åº”çš„Entry</span></span><br><span class="line">    Entry&lt;K,V&gt; entry = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥ä¸‹æ ‡çš„Entryä¸ä¸ºnullï¼Œåˆ™è¿›è¡Œé“¾è¡¨éå†</span></span><br><span class="line">    <span class="keyword">for</span>(; entry != <span class="keyword">null</span> ; entry = entry.next) &#123;</span><br><span class="line">        <span class="comment">// éå†é“¾è¡¨ï¼Œå¦‚æœå­˜åœ¨keyç›¸ç­‰çš„èŠ‚ç‚¹ï¼Œåˆ™æ›¿æ¢è¿™ä¸ªèŠ‚ç‚¹çš„å€¼ï¼Œå¹¶è¿”å›æ—§å€¼</span></span><br><span class="line">        <span class="keyword">if</span> ((entry.hash == hash) &amp;&amp; entry.key.equals(key)) &#123;</span><br><span class="line">            V old = entry.value;</span><br><span class="line">            entry.value = value;</span><br><span class="line">            <span class="keyword">return</span> old;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ•°ç»„ä¸‹æ ‡å¯¹åº”çš„èŠ‚ç‚¹ä¸ºç©ºï¼Œæˆ–è€…éå†é“¾è¡¨åå‘ç°æ²¡æœ‰å’Œè¯¥keyç›¸ç­‰çš„èŠ‚ç‚¹ï¼Œåˆ™æ‰§è¡Œæ’å…¥æ“ä½œ</span></span><br><span class="line">    addEntry(hash, key, value, index);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ¨¡æ•°+1</span></span><br><span class="line">    modCount++;</span><br><span class="line"></span><br><span class="line">    Entry&lt;?,?&gt; tab[] = table;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt;= threshold) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœcountå¤§äºç­‰äºæ‰©å®¹é˜ˆå€¼ï¼Œåˆ™è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">        rehash();</span><br><span class="line"></span><br><span class="line">        tab = table;</span><br><span class="line">        <span class="comment">// æ‰©å®¹åï¼Œé‡æ–°è®¡ç®—è¯¥keyåœ¨æ‰©å®¹åtableé‡Œçš„ä¸‹æ ‡</span></span><br><span class="line">        hash = key.hashCode();</span><br><span class="line">        index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Creates the new entry.</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="comment">// é‡‡ç”¨å¤´æ’çš„æ–¹å¼æ’å…¥ï¼Œindexä½ç½®çš„èŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹çš„nextèŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// æ–°èŠ‚ç‚¹å–ä»£indeä½ç½®èŠ‚ç‚¹</span></span><br><span class="line">    Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;) tab[index];</span><br><span class="line">    tab[index] = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, e);</span><br><span class="line">    <span class="comment">// count+1</span></span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="rehash"><a href="#rehash" class="headerlink" title="rehash()"></a>rehash()</h3><p><code>rehash</code>æ‰©å®¹æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">rehash</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æš‚å­˜æ—§çš„tableå’Œå®¹é‡</span></span><br><span class="line">    <span class="keyword">int</span> oldCapacity = table.length;</span><br><span class="line">    Entry&lt;?,?&gt;[] oldMap = table;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–°å®¹é‡ä¸ºæ—§å®¹é‡çš„2n+1å€</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = (oldCapacity &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ–°å®¹é‡æ˜¯å¦è¶…è¿‡æœ€å¤§å®¹é‡</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ—§å®¹é‡å·²ç»æ˜¯æœ€å¤§å®¹é‡å¤§è¯ï¼Œå°±ä¸æ‰©å®¹äº†</span></span><br><span class="line">        <span class="keyword">if</span> (oldCapacity == MAX_ARRAY_SIZE)</span><br><span class="line">            <span class="comment">// Keep running with MAX_ARRAY_SIZE buckets</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// æ–°å®¹é‡æœ€å¤§å€¼åªèƒ½æ˜¯MAX_ARRAY_SIZE</span></span><br><span class="line">        newCapacity = MAX_ARRAY_SIZE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç”¨æ–°å®¹é‡åˆ›å»ºä¸€ä¸ªæ–°Entryæ•°ç»„</span></span><br><span class="line">    Entry&lt;?,?&gt;[] newMap = <span class="keyword">new</span> Entry&lt;?,?&gt;[newCapacity];</span><br><span class="line">    <span class="comment">// æ¨¡æ•°+1</span></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// é‡æ–°è®¡ç®—ä¸‹æ¬¡æ‰©å®¹é˜ˆå€¼</span></span><br><span class="line">    threshold = (<span class="keyword">int</span>)Math.min(newCapacity * loadFactor, MAX_ARRAY_SIZE + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// å°†æ–°Entryæ•°ç»„èµ‹å€¼ç»™table</span></span><br><span class="line">    table = newMap;</span><br><span class="line">    <span class="comment">// éå†æ•°ç»„å’Œé“¾è¡¨ï¼Œè¿›è¡Œæ–°tableèµ‹å€¼æ“ä½œ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = oldCapacity ; i-- &gt; <span class="number">0</span> ;) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K,V&gt; old = (Entry&lt;K,V&gt;)oldMap[i] ; old != <span class="keyword">null</span> ; ) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; e = old;</span><br><span class="line">            old = old.next;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> index = (e.hash &amp; <span class="number">0x7FFFFFFF</span>) % newCapacity;</span><br><span class="line">            e.next = (Entry&lt;K,V&gt;)newMap[index];</span><br><span class="line">            newMap[index] = e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="get-Object-key"><a href="#get-Object-key" class="headerlink" title="get(Object key)"></a>get(Object key)</h3><p><code>get(Object key)</code>è·å–æŒ‡å®škeyå¯¹åº”çš„valueï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Entry&lt;?,?&gt; tab[] = table;</span><br><span class="line">    <span class="keyword">int</span> hash = key.hashCode();</span><br><span class="line">    <span class="comment">// æ ¹æ®keyå“ˆå¸Œå¾—åˆ°indexï¼Œéå†é“¾è¡¨å–å€¼</span></span><br><span class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (V)e.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>synchronizedä¿®é¥°ï¼Œçº¿ç¨‹å®‰å…¨ã€‚</p><h3 id="remove-Object-key"><a href="#remove-Object-key" class="headerlink" title="remove(Object key)"></a>remove(Object key)</h3><p><code>remove(Object key)</code>åˆ é™¤æŒ‡å®škeyï¼Œè¿”å›å¯¹åº”çš„valueï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Entry&lt;?,?&gt; tab[] = table;</span><br><span class="line">    <span class="keyword">int</span> hash = key.hashCode();</span><br><span class="line">    <span class="comment">// è·å–keyå¯¹åº”çš„index</span></span><br><span class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="comment">// éå†é“¾è¡¨ï¼Œå¦‚æœæ‰¾åˆ°keyç›¸ç­‰çš„èŠ‚ç‚¹ï¼Œåˆ™æ”¹å˜å‰ç»§å’Œåç»§èŠ‚ç‚¹çš„å…³ç³»ï¼Œå¹¶åˆ é™¤ç›¸åº”å¼•ç”¨ï¼Œè®©GCå›æ”¶</span></span><br><span class="line">    Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">    <span class="keyword">for</span>(Entry&lt;K,V&gt; prev = <span class="keyword">null</span> ; e != <span class="keyword">null</span> ; prev = e, e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">            modCount++;</span><br><span class="line">            <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">                prev.next = e.next;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                tab[index] = e.next;</span><br><span class="line">            &#125;</span><br><span class="line">            count--;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>synchronizedä¿®é¥°ï¼Œçº¿ç¨‹å®‰å…¨ã€‚</p><blockquote><p>å‰©ä¸‹æ–¹æ³•æœ‰å…´è¶£è‡ªå·±é˜…è¯»æºç ï¼Œpublicæ–¹æ³•éƒ½ç”¨synchronizedä¿®é¥°ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œå¹¶å‘ç¯å¢ƒä¸‹ï¼Œå¤šçº¿ç¨‹ç«äº‰å¯¹è±¡é”ï¼Œæ•ˆç‡ä½ï¼Œä¸æ¨èä½¿ç”¨ã€‚çº¿ç¨‹å®‰å…¨çš„Mapæ¨èä½¿ç”¨ConcurrentHashMapã€‚</p></blockquote><h2 id="å’ŒHashMapå¯¹æ¯”"><a href="#å’ŒHashMapå¯¹æ¯”" class="headerlink" title="å’ŒHashMapå¯¹æ¯”"></a>å’ŒHashMapå¯¹æ¯”</h2><ol><li><p>çº¿ç¨‹æ˜¯å¦å®‰å…¨ï¼šHashMapæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼ŒHashTableæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›HashTableå†…éƒ¨çš„æ–¹æ³•åŸºæœ¬éƒ½ç»è¿‡ synchronizedä¿®é¥°ï¼›</p></li><li><p>å¯¹Null key å’ŒNull valueçš„æ”¯æŒï¼šHashMapä¸­ï¼Œnullå¯ä»¥ä½œä¸ºé”®ï¼Œè¿™æ ·çš„é”®åªæœ‰ä¸€ä¸ªï¼Œå¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªé”®æ‰€å¯¹åº”çš„å€¼ä¸ºnullï¼›HashTableä¸­keyå’Œvalueéƒ½ä¸èƒ½ä¸ºnullï¼Œå¦åˆ™æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ï¼›</p></li><li><p>åˆå§‹å®¹é‡å¤§å°å’Œæ¯æ¬¡æ‰©å……å®¹é‡å¤§å°çš„ä¸åŒï¼š</p><p>3.1. åˆ›å»ºæ—¶å¦‚æœä¸æŒ‡å®šå®¹é‡åˆå§‹å€¼ï¼ŒHashtableé»˜è®¤çš„åˆå§‹å¤§å°ä¸º11ï¼Œä¹‹åæ¯æ¬¡æ‰©å®¹ï¼Œå®¹é‡å˜ä¸ºåŸæ¥çš„2n+1ã€‚HashMapé»˜è®¤çš„åˆå§‹åŒ–å¤§å°ä¸º16ã€‚ä¹‹åæ¯æ¬¡æ‰©å……ï¼Œå®¹é‡å˜ä¸ºåŸæ¥çš„2å€ï¼›</p><p>3.2. åˆ›å»ºæ—¶å¦‚æœç»™å®šäº†å®¹é‡åˆå§‹å€¼ï¼Œé‚£ä¹ˆHashtableä¼šç›´æ¥ä½¿ç”¨ä½ ç»™å®šçš„å¤§å°ï¼Œè€ŒHashMapä¼šå°†å…¶æ‰©å…… ä¸º2çš„å¹‚æ¬¡æ–¹å¤§å°ã€‚</p></li><li><p>åº•å±‚æ•°æ®ç»“æ„ï¼šJDK1.8åŠä»¥åçš„HashMapåœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶æœ‰äº†è¾ƒå¤§çš„å˜åŒ–ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰æ—¶ï¼Œå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ï¼ŒHashtableæ²¡æœ‰è¿™æ ·çš„æœºåˆ¶ã€‚</p></li></ol><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:19 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;HashTableæ˜¯Mapæ¥å£çº¿ç¨‹å®‰å…¨å®ç°ç‰ˆæœ¬ï¼Œæ•°æ®ç»“æ„å’Œæ–¹æ³•å®ç°ä¸HashMapç±»ä¼¼ï¼Œæœ¬æ–‡è®°å½•HashTableæºç è§£æï¼ŒåŸºäºJDK1.8ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>CopyOnWriteArraySetæºç è§£æ</title>
    <link href="http://mrbird.cc/CopyOnWriteArraySet%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html"/>
    <id>http://mrbird.cc/CopyOnWriteArraySetæºç è§£æ.html</id>
    <published>2020-08-26T01:23:21.000Z</published>
    <updated>2021-02-24T02:33:19.756Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:19 GMT+0800 (GMT+08:00) --><p>CopyOnWriteArraySetä¸ºçº¿ç¨‹å®‰å…¨çš„Setå®ç°ï¼Œæœ¬æ–‡è®°å½•CopyOnWriteArraySetæºç è§£æï¼ŒåŸºäºJDK1.8ã€‚<a id="more"></a></p><h2 id="ç±»ç»“æ„"><a href="#ç±»ç»“æ„" class="headerlink" title="ç±»ç»“æ„"></a>ç±»ç»“æ„</h2><p>å…ˆæ¥çœ‹ä¸‹CopyOnWriteArraySetçš„ç±»å±‚çº§å…³ç³»å›¾ï¼š</p><p><img src="img/QQ20210224-101418@2x.png" alt="QQ20210224-101418@2x"></p><p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚å†æ¥çœ‹çœ‹å†…éƒ¨å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°±ä¸€ä¸ªå±æ€§ï¼ŒCopyOnWriteArraySetå†…éƒ¨é‡‡ç”¨CopyOnWriteArrayListå­˜å‚¨å…ƒç´ </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> CopyOnWriteArrayList&lt;E&gt; al;</span><br></pre></td></tr></table></figure><p></p><p>å’ŒHashSetä¸ä¸€æ ·çš„æ˜¯ï¼ŒCopyOnWriteArraySetå†…éƒ¨é‡‡ç”¨CopyOnWriteArrayListå­˜å‚¨å…ƒç´ ï¼Œè¿™ä¹Ÿæ˜¯CopyOnWriteArraySetåå­—çš„ç”±æ¥ï¼Œå› ä¸ºCopyOnWriteArrayListæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒCopyOnWriteArraySetçš„æ–¹æ³•éƒ½æ˜¯åŸºäºCopyOnWriteArrayListå®ç°çš„ï¼Œæ‰€ä»¥CopyOnWriteArraySetè‡ªç„¶è€Œç„¶ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒåŒæ ·çš„ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸‹è·å–æ•°æ®æ˜¯å¼±ä¸€è‡´æ€§çš„ï¼</p><h2 id="æ–¹æ³•è§£æ"><a href="#æ–¹æ³•è§£æ" class="headerlink" title="æ–¹æ³•è§£æ"></a>æ–¹æ³•è§£æ</h2><h3 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç©ºå‚æ„é€ å‡½æ•°ï¼Œå®é™…å°±æ˜¯åˆå§‹åŒ–CopyOnWriteArrayList</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CopyOnWriteArraySet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    al = <span class="keyword">new</span> CopyOnWriteArrayList&lt;E&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼ å…¥é›†åˆå¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CopyOnWriteArraySet</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// åˆ†ä¸¤ç§æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">if</span> (c.getClass() == CopyOnWriteArraySet.class) &#123;</span><br><span class="line">    	<span class="comment">// å¦‚æœé›†åˆå°±æ˜¯CopyOnWriteArraySetç±»å‹ï¼Œè¯´æ˜æ•°æ®æ˜¯ä¸é‡å¤çš„</span></span><br><span class="line">    	<span class="comment">// ç›´æ¥å…¨éƒ¨æ·»åŠ åˆ°CopyOnWriteArrayListä¸­</span></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) CopyOnWriteArraySet&lt;E&gt; cc =</span><br><span class="line">            (CopyOnWriteArraySet&lt;E&gt;)c;</span><br><span class="line">        al = <span class="keyword">new</span> CopyOnWriteArrayList&lt;E&gt;(cc.al);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="comment">// å¦åˆ™è°ƒç”¨addAllAbsentæ·»åŠ æ‰€æœ‰å½“å‰é›†åˆä¸­ä¸å­˜åœ¨çš„å…ƒç´ ï¼Œç¡®ä¿æ•°æ®çš„å”¯ä¸€æ€§</span></span><br><span class="line">        al = <span class="keyword">new</span> CopyOnWriteArrayList&lt;E&gt;();</span><br><span class="line">        al.addAllAbsent(c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="add-E-e"><a href="#add-E-e" class="headerlink" title="add(E e)"></a>add(E e)</h3><p><code>add(E e)</code>æ·»åŠ æŒ‡å®šå…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// å®é™…è°ƒç”¨CopyOnWriteArrayListçš„addIfAbsentæ–¹æ³•</span></span><br><span class="line">	<span class="comment">// å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ ï¼Œè¿”å›trueï¼›å…ƒç´ å­˜åœ¨ï¼Œåˆ™ä¸æ·»åŠ ï¼Œè¿”å›false</span></span><br><span class="line">    <span class="keyword">return</span> al.addIfAbsent(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒCopyOnWriteArraySetçš„addæ–¹æ³•é€šè¿‡è°ƒç”¨CopyOnWriteArrayListçš„addIfAbsentæ¥ç¡®ä¿å…ƒç´ ä¸é‡å¤ï¼Œä»¥æ»¡è¶³Setçš„ç‰¹æ€§ã€‚</p><h3 id="å‰©ä¸‹æ–¹æ³•ç•¥"><a href="#å‰©ä¸‹æ–¹æ³•ç•¥" class="headerlink" title="å‰©ä¸‹æ–¹æ³•ç•¥"></a>å‰©ä¸‹æ–¹æ³•ç•¥</h3><p>å‰©ä¸‹æ–¹æ³•éƒ½æ¯”è¾ƒç®€å•ï¼Œéƒ½æ˜¯ç›´æ¥è°ƒç”¨CopyOnWriteArrayListæ–¹æ³•å®ç°ï¼Œæ„Ÿå…´è¶£è‡ªå·±é˜…è¯»æºç ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:19 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;CopyOnWriteArraySetä¸ºçº¿ç¨‹å®‰å…¨çš„Setå®ç°ï¼Œæœ¬æ–‡è®°å½•CopyOnWriteArraySetæºç è§£æï¼ŒåŸºäºJDK1.8ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>HashSetæºç è§£æ</title>
    <link href="http://mrbird.cc/HashSet%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html"/>
    <id>http://mrbird.cc/HashSetæºç è§£æ.html</id>
    <published>2020-08-25T03:20:47.000Z</published>
    <updated>2021-02-25T03:14:28.506Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:19 GMT+0800 (GMT+08:00) --><p>æœ¬æ–‡è®°å½•HashSetæºç è§£æï¼ŒåŸºäºJDK1.8ã€‚<a id="more"></a></p><h2 id="ç±»ç»“æ„"><a href="#ç±»ç»“æ„" class="headerlink" title="ç±»ç»“æ„"></a>ç±»ç»“æ„</h2><p>HashSetç±»å±‚çº§å…³ç³»å›¾ï¼š</p><p><img src="img/QQ20210224-094138@2x.png" alt="QQ20210224-094138@2x"></p><p>HashSetå®ç°äº†Setæ¥å£ï¼Œä¸ºä»€ä¹ˆå«HashSetï¼Ÿå› ä¸ºHashSetå†…éƒ¨é‡‡ç”¨å“ˆå¸Œè¡¨ï¼ˆå®é™…å°±æ˜¯HashMapï¼‰æ¥å­˜å‚¨ä¸é‡å¤çš„æ•°æ®ï¼ŒæŸ¥çœ‹HashSetå†…éƒ¨å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨HashMapå­˜å‚¨æ•°æ®ï¼ŒHashSetçš„æ•°æ®å®é™…ä¸ºHashMapçš„key</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> HashMap&lt;E,Object&gt; map;</span><br><span class="line"><span class="comment">// HashMap valueå ä½ç¬¦</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object PRESENT = <span class="keyword">new</span> Object();</span><br></pre></td></tr></table></figure><p></p><p>HashMapçš„keyæ˜¯ä¸å…è®¸é‡å¤çš„ï¼Œè¿™ä¹Ÿæ­£å¥½ç¬¦åˆSetçš„ç‰¹æ€§ã€‚å› ä¸ºHashSetå†…éƒ¨é‡‡ç”¨HashMapå­˜å‚¨æ•°æ®ï¼Œæ‰€ä»¥HashSetå¯ä»¥å­˜å‚¨nullå€¼ï¼Œæ”¯æŒå¿«é€Ÿå¤±è´¥ï¼Œéçº¿ç¨‹å®‰å…¨ã€‚</p><p>mapå±æ€§é€šè¿‡transientä¿®é¥°ï¼ŒåŸå› åœ¨ä»‹ç»<a href="/Java-HashMapåº•å±‚å®ç°åŸç†.html">HashMapæºç </a>çš„æ—¶å€™åˆ†æè¿‡ã€‚</p><h2 id="æ–¹æ³•è§£æ"><a href="#æ–¹æ³•è§£æ" class="headerlink" title="æ–¹æ³•è§£æ"></a>æ–¹æ³•è§£æ</h2><h3 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç©ºå‚æ„é€ å‡½æ•°ï¼Œå†…éƒ¨åˆå§‹åŒ–mapå±æ€§</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼ å…¥é›†åˆå¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–mapï¼Œè®¡ç®—mapçš„å®¹é‡</span></span><br><span class="line">    <span class="comment">// è®¡ç®—å…¬å¼ä¸º c.size/0.75f + 1ï¼Œå¦‚æœå€¼å°äº16ï¼Œåˆ™å–å€¼16ã€‚</span></span><br><span class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;(Math.max((<span class="keyword">int</span>) (c.size()/.<span class="number">75f</span>) + <span class="number">1</span>, <span class="number">16</span>));</span><br><span class="line">    <span class="comment">// å°†é›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ æ·»åŠ è¿›å»</span></span><br><span class="line">    addAll(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰‹åŠ¨æŒ‡å®šå®¹é‡å’ŒåŠ è½½å› å­</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;(initialCapacity, loadFactor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰‹åŠ¨æŒ‡å®šå®¹é‡</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;(initialCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåˆ›å»ºHashSetçš„æœ¬è´¨å°±æ˜¯åˆå§‹åŒ–HashMapã€‚</p><h3 id="add-E-e"><a href="#add-E-e" class="headerlink" title="add(E e)"></a>add(E e)</h3><p><code>add(E e)</code>æ·»åŠ æŒ‡å®šå…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¾€mapé‡Œæ·»åŠ å…ƒç´ ï¼Œå¦‚æœkeyå·²ç»å­˜åœ¨åˆ™è¿”å›falseï¼Œå¦åˆ™è¿”å›true</span></span><br><span class="line">    <span class="keyword">return</span> map.put(e, PRESENT)==<span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="contains-Object-o"><a href="#contains-Object-o" class="headerlink" title="contains(Object o)"></a>contains(Object o)</h3><p><code>contains(Object o)</code>åˆ¤æ–­æ˜¯å¦åŒ…å«æŒ‡å®šå…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æœ¬è´¨å°±æ˜¯åˆ¤æ–­mapä¸­æ˜¯å¦åŒ…å«è¯¥key</span></span><br><span class="line">    <span class="keyword">return</span> map.containsKey(o);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="size"><a href="#size" class="headerlink" title="size()"></a>size()</h3><p><code>size()</code>è·å–å…ƒç´ ä¸ªæ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æœ¬è´¨å°±æ˜¯è·å–mapçš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">return</span> map.size();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="isEmpty"><a href="#isEmpty" class="headerlink" title="isEmpty()"></a>isEmpty()</h3><p><code>isEmpty()</code>åˆ¤æ–­é›†åˆæ˜¯å¦ä¸ºç©ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æœ¬è´¨å°±æ˜¯åˆ¤æ–­mapæ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">return</span> map.isEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="remove-Object-o"><a href="#remove-Object-o" class="headerlink" title="remove(Object o)"></a>remove(Object o)</h3><p><code>remove(Object o)</code>åˆ é™¤æŒ‡å®šå…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æœ¬è´¨å°±æ˜¯é€šè¿‡keyåˆ é™¤mapä¸­çš„å…ƒç´ ï¼Œå¦‚æœè¯¥keyå­˜åœ¨ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false</span></span><br><span class="line">    <span class="keyword">return</span> map.remove(o)==PRESENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="clear"><a href="#clear" class="headerlink" title="clear()"></a>clear()</h3><p><code>clear()</code>æ¸…ç©ºé›†åˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æœ¬è´¨å°±æ˜¯æ¸…ç©ºmap</span></span><br><span class="line">    map.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="iterator"><a href="#iterator" class="headerlink" title="iterator()"></a>iterator()</h3><p><code>iterator()</code>è·å–è¿­ä»£å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æœ¬è´¨å°±æ˜¯è·å–map keyçš„è¿­ä»£å™¨</span></span><br><span class="line">    <span class="keyword">return</span> map.keySet().iterator();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:19 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;æœ¬æ–‡è®°å½•HashSetæºç è§£æï¼ŒåŸºäºJDK1.8ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>CopyOnWriteArrayListæºç è§£æ</title>
    <link href="http://mrbird.cc/CopyOnWriteArrayList%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html"/>
    <id>http://mrbird.cc/CopyOnWriteArrayListæºç è§£æ.html</id>
    <published>2020-08-18T03:23:44.000Z</published>
    <updated>2021-02-22T03:19:30.011Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:19 GMT+0800 (GMT+08:00) --><p>CopyOnWriteArrayListä¸ºçº¿ç¨‹å®‰å…¨çš„ArrayListï¼Œè¿™èŠ‚åˆ†æä¸‹CopyOnWriteArrayListçš„æºç ï¼ŒåŸºäºJDK1.8ã€‚<a id="more"></a></p><h2 id="ç±»ç»“æ„"><a href="#ç±»ç»“æ„" class="headerlink" title="ç±»ç»“æ„"></a>ç±»ç»“æ„</h2><p>CopyOnWriteArrayListç±»å…³ç³»å›¾ï¼š</p><p><img src="img/QQ20210222-095256@2x.png" alt="QQ20210222-095256@2x"></p><p>CopyOnWriteArrayListå®ç°äº†Listæ¥å£çš„æ‰€æœ‰æ–¹æ³•ï¼Œä¸»è¦åŒ…å«å¦‚ä¸‹ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯é‡å…¥é”ï¼Œç”¨äºå¯¹å†™æ“ä½œåŠ é”</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">transient</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Objectç±»å‹æ•°ç»„ï¼Œå­˜æ”¾æ•°æ®ï¼Œvolatileä¿®é¥°ï¼Œç›®çš„æ˜¯ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªå­—æ®µçš„ä¿®æ”¹å¦å¤–ä¸€ä¸ªçº¿ç¨‹ç«‹å³å¯è§</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Object[] array;</span><br></pre></td></tr></table></figure><p></p><p>CopyOnWriteArrayListä¸­å¹¶æ²¡æœ‰å’Œå®¹é‡æœ‰å…³çš„å±æ€§æˆ–è€…å¸¸é‡ï¼Œä¸‹é¢é€šè¿‡å¯¹ä¸€äº›å¸¸ç”¨æ–¹æ³•çš„æºç è§£æï¼Œå°±å¯ä»¥çŸ¥é“åŸå› ã€‚</p><h2 id="æ–¹æ³•è§£æ"><a href="#æ–¹æ³•è§£æ" class="headerlink" title="æ–¹æ³•è§£æ"></a>æ–¹æ³•è§£æ</h2><h3 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h3><p><code>CopyOnWriteArrayList()</code>ç©ºå‚æ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CopyOnWriteArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setArray(<span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setArray</span><span class="params">(Object[] a)</span> </span>&#123;</span><br><span class="line">    array = a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ— å‚æ„é€ å‡½æ•°ç›´æ¥åˆ›å»ºäº†ä¸€ä¸ªé•¿åº¦ä¸º0çš„Objectæ•°ç»„ã€‚</p><p><code>CopyOnWriteArrayList(Collection&lt;? extends E&gt; c)</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CopyOnWriteArrayList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    Object[] elements;</span><br><span class="line">    <span class="keyword">if</span> (c.getClass() == CopyOnWriteArrayList.class)</span><br><span class="line">        <span class="comment">// å¦‚æœé›†åˆç±»å‹å°±æ˜¯CopyOnWriteArrayListï¼Œåˆ™ç›´æ¥å°†å…¶arrayèµ‹å€¼ç»™å½“å‰CopyOnWriteArrayList</span></span><br><span class="line">        elements = ((CopyOnWriteArrayList&lt;?&gt;)c).getArray();</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸æ˜¯CopyOnWriteArrayListç±»å‹ï¼Œåˆ™å°†é›†åˆè½¬æ¢ä¸ºæ•°ç»„</span></span><br><span class="line">        elements = c.toArray();</span><br><span class="line">        <span class="comment">// å°±å¦‚ArrayListæºç åˆ†ææ‰€è¿°é‚£æ ·ï¼Œc.toArray()è¿”å›ç±»å‹ä¸ä¸€å®šæ˜¯Object[].classï¼Œæ‰€ä»¥éœ€è¦è½¬æ¢</span></span><br><span class="line">        <span class="keyword">if</span> (elements.getClass() != Object[].class)</span><br><span class="line">            elements = Arrays.copyOf(elements, elements.length, Object[].class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®arrayå€¼</span></span><br><span class="line">    setArray(elements);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>CopyOnWriteArrayList(E[] toCopyIn)</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CopyOnWriteArrayList</span><span class="params">(E[] toCopyIn)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å…¥å‚ä¸ºæ•°ç»„ï¼Œæ‹·è´ä¸€ä»½èµ‹å€¼ç»™array</span></span><br><span class="line">    setArray(Arrays.copyOf(toCopyIn, toCopyIn.length, Object[].class));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="add-E-e"><a href="#add-E-e" class="headerlink" title="add(E e)"></a>add(E e)</h3><p><code>add(E e)</code>å¾€CopyOnWriteArrayListæœ«å°¾æ·»åŠ å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å¯é‡å…¥é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    <span class="comment">// ä¸Šé”ï¼ŒåŒä¸€æ—¶é—´å†…åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰arrayå±æ€§å€¼</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="comment">// è·å–å½“å‰arrayæ•°ç»„é•¿åº¦</span></span><br><span class="line">        <span class="keyword">int</span> len = elements.length;</span><br><span class="line">        <span class="comment">// å¤åˆ¶ä¸€ä»½æ–°æ•°ç»„ï¼Œæ–°æ•°ç»„é•¿åº¦ä¸ºå½“å‰arrayæ•°ç»„é•¿åº¦+1</span></span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// åœ¨æ–°æ•°ç»„æœ«å°¾æ·»åŠ å…ƒç´ </span></span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        <span class="comment">// æ–°æ•°ç»„èµ‹å€¼ç»™arrayå±æ€§</span></span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é”é‡Šæ”¾</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Object[] getArray() &#123;</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œaddæ“ä½œé€šè¿‡ReentrantLockæ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚é€šè¿‡addæ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºCopyOnWriteArrayListä¿®æ”¹æ“ä½œçš„åŸºæœ¬æ€æƒ³ä¸ºï¼šå¤åˆ¶ä¸€ä»½æ–°çš„æ•°ç»„ï¼Œæ–°æ•°ç»„é•¿åº¦åˆšå¥½èƒ½å¤Ÿå®¹çº³ä¸‹éœ€è¦æ·»åŠ çš„å…ƒç´ ï¼›åœ¨æ–°æ•°ç»„é‡Œè¿›è¡Œæ“ä½œï¼›æœ€åå°†æ–°æ•°ç»„èµ‹å€¼ç»™arrayå±æ€§ï¼Œæ›¿æ¢æ—§æ•°ç»„ã€‚è¿™ç§æ€æƒ³ä¹Ÿç§°ä¸ºâ€œå†™æ—¶å¤åˆ¶â€ï¼Œæ‰€ä»¥ç§°ä¸ºCopyOnWriteArrayListã€‚</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°CopyOnWriteArrayListä¸­å¹¶æ²¡æœ‰ç±»ä¼¼äºArrayListçš„growæ–¹æ³•æ‰©å®¹çš„æ“ä½œã€‚</p><h3 id="add-int-index-E-element"><a href="#add-int-index-E-element" class="headerlink" title="add(int index, E element)"></a>add(int index, E element)</h3><p><code>add(int index, E element)</code>æŒ‡å®šä¸‹æ ‡æ·»åŠ æŒ‡å®šå…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å¯é‡å…¥é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    <span class="comment">// ä¸Šé”ï¼ŒåŒä¸€æ—¶é—´å†…åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰arrayå±æ€§å€¼</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">         <span class="comment">// è·å–å½“å‰arrayæ•°ç»„é•¿åº¦</span></span><br><span class="line">        <span class="keyword">int</span> len = elements.length;</span><br><span class="line">        <span class="comment">// ä¸‹æ ‡æ£€æŸ¥</span></span><br><span class="line">        <span class="keyword">if</span> (index &gt; len || index &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(<span class="string">"Index: "</span>+index+</span><br><span class="line">                                                <span class="string">", Size: "</span>+len);</span><br><span class="line">        Object[] newElements;</span><br><span class="line">        <span class="keyword">int</span> numMoved = len - index;</span><br><span class="line">        <span class="keyword">if</span> (numMoved == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// numMovedä¸º0ï¼Œè¯´æ˜æ˜¯åœ¨æœ«å°¾æ·»åŠ ï¼Œè¿‡ç¨‹å’Œadd(E e)æ–¹æ³•ä¸€è‡´</span></span><br><span class="line">            newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦åˆ™åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œæ•°ç»„é•¿åº¦ä¸ºæ—§æ•°ç»„é•¿åº¦å€¼+1</span></span><br><span class="line">            newElements = <span class="keyword">new</span> Object[len + <span class="number">1</span>];</span><br><span class="line">            <span class="comment">// åˆ†ä¸¤æ¬¡å¤åˆ¶ï¼Œåˆ†åˆ«å°†indexä¹‹å‰å’Œindex+1ä¹‹åçš„å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­</span></span><br><span class="line">            System.arraycopy(elements, <span class="number">0</span>, newElements, <span class="number">0</span>, index);</span><br><span class="line">            System.arraycopy(elements, index, newElements, index + <span class="number">1</span>,</span><br><span class="line">                             numMoved);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åœ¨æ–°æ•°ç»„çš„indexä½ç½®æ·»åŠ æŒ‡å®šå…ƒç´ </span></span><br><span class="line">        newElements[index] = element;</span><br><span class="line">        <span class="comment">// æ–°æ•°ç»„èµ‹å€¼ç»™arrayå±æ€§ï¼Œæ›¿æ¢æ—§æ•°ç»„</span></span><br><span class="line">        setArray(newElements);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é”é‡Šæ”¾</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="set-int-index-E-element"><a href="#set-int-index-E-element" class="headerlink" title="set(int index, E element)"></a>set(int index, E element)</h3><p><code>set(int index, E element)</code>è®¾ç½®æŒ‡å®šä½ç½®çš„å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å¯é‡å…¥é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    <span class="comment">// ä¸Šé”ï¼ŒåŒä¸€æ—¶é—´å†…åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	<span class="comment">// è·å–å½“å‰arrayå±æ€§å€¼</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="comment">// è·å–å½“å‰arrayæŒ‡å®šindexä¸‹æ ‡å€¼</span></span><br><span class="line">        E oldValue = get(elements, index);</span><br><span class="line">        <span class="keyword">if</span> (oldValue != element) &#123;</span><br><span class="line">        	<span class="comment">// å¦‚æœæ–°å€¼å’Œæ—§å€¼ä¸ç›¸ç­‰</span></span><br><span class="line">            <span class="keyword">int</span> len = elements.length;</span><br><span class="line">            <span class="comment">// å¤åˆ¶ä¸€ä»½æ–°æ•°ç»„ï¼Œé•¿åº¦å’Œæ—§æ•°ç»„ä¸€è‡´</span></span><br><span class="line">            Object[] newElements = Arrays.copyOf(elements, len);</span><br><span class="line">            <span class="comment">// ä¿®æ”¹æ–°æ•°ç»„indexä¸‹æ ‡å€¼</span></span><br><span class="line">            newElements[index] = element;</span><br><span class="line">            <span class="comment">// æ–°æ•°ç»„èµ‹å€¼ç»™arrayå±æ€§ï¼Œæ›¿æ¢æ—§æ•°ç»„</span></span><br><span class="line">            setArray(newElements);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å³ä½¿æ–°å€¼å’Œæ—§å€¼ä¸€è‡´ï¼Œä¸ºäº†ç¡®ä¿volatileè¯­ä¹‰ï¼Œéœ€è¦é‡æ–°è®¾ç½®array</span></span><br><span class="line">            setArray(elements);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    	<span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">get</span><span class="params">(Object[] a, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (E) a[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="remove-int-index"><a href="#remove-int-index" class="headerlink" title="remove(int index)"></a>remove(int index)</h3><p><code>remove(int index)</code>åˆ é™¤æŒ‡å®šä¸‹æ ‡å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å¯é‡å…¥é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    <span class="comment">// ä¸Šé”ï¼ŒåŒä¸€æ—¶é—´å†…åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	<span class="comment">// è·å–å½“å‰arrayå±æ€§å€¼</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="comment">// è·å–å½“å‰arrayé•¿åº¦</span></span><br><span class="line">        <span class="keyword">int</span> len = elements.length;</span><br><span class="line">        <span class="comment">// è·å–æ—§å€¼</span></span><br><span class="line">        E oldValue = get(elements, index);</span><br><span class="line">        <span class="keyword">int</span> numMoved = len - index - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (numMoved == <span class="number">0</span>)</span><br><span class="line">        	<span class="comment">// å¦‚æœåˆ é™¤çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œåˆ™å°†å½“å‰arrayè®¾ç½®ä¸ºæ–°æ•°ç»„</span></span><br><span class="line">        	<span class="comment">// æ–°æ•°ç»„é•¿åº¦ä¸ºæ—§æ•°ç»„é•¿åº¦-1ï¼Œè¿™æ ·åˆšå¥½æˆªå»äº†æœ€åä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">            setArray(Arrays.copyOf(elements, len - <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">        	<span class="comment">// åˆ†æ®µå¤åˆ¶ï¼Œå°†indexå‰çš„å…ƒç´ å’Œindex+1åçš„å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„</span></span><br><span class="line">        	<span class="comment">// æ–°æ•°ç»„é•¿åº¦ä¸ºæ—§æ•°ç»„é•¿åº¦-1</span></span><br><span class="line">            Object[] newElements = <span class="keyword">new</span> Object[len - <span class="number">1</span>];</span><br><span class="line">            System.arraycopy(elements, <span class="number">0</span>, newElements, <span class="number">0</span>, index);</span><br><span class="line">            System.arraycopy(elements, index + <span class="number">1</span>, newElements, index,</span><br><span class="line">                             numMoved);</span><br><span class="line">            <span class="comment">// è®¾ç½®array</span></span><br><span class="line">            setArray(newElements);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    	<span class="comment">// é”é‡Šæ”¾</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><div class="note info">å¯ä»¥çœ‹åˆ°ï¼ŒCopyOnWriteArrayListä¸­çš„å¢åˆ æ”¹æ“ä½œéƒ½æ˜¯åœ¨æ–°æ•°ç»„ä¸­è¿›è¡Œçš„ï¼Œå¹¶ä¸”é€šè¿‡åŠ é”çš„æ–¹å¼ç¡®ä¿åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæ“ä½œï¼Œæ“ä½œå®Œåèµ‹å€¼ç»™arrayå±æ€§ï¼Œæ›¿æ¢æ—§æ•°ç»„ï¼Œæ—§æ•°ç»„å¤±å»äº†å¼•ç”¨ï¼Œæœ€ç»ˆç”±GCå›æ”¶ã€‚</div><h3 id="get-int-index"><a href="#get-int-index" class="headerlink" title="get(int index)"></a>get(int index)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> get(getArray(), index);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> Object[] getArray() &#123;</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>get(int index)</code>æ“ä½œæ˜¯åˆ†ä¸¤æ­¥è¿›è¡Œçš„ï¼š</p><ol><li>é€šè¿‡<code>getArray()</code>è·å–arrayå±æ€§å€¼ï¼›</li><li>è·å–arrayæ•°ç»„indexä¸‹æ ‡å€¼ã€‚</li></ol><p>è¿™ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰åŠ é”ï¼Œæ‰€ä»¥åœ¨å¹¶å‘ç¯å¢ƒä¸‹å¯èƒ½å‡ºç°å¦‚ä¸‹æƒ…å†µï¼š</p><ol><li>çº¿ç¨‹1è°ƒç”¨<code>get(int index)</code>æ–¹æ³•è·å–å€¼ï¼Œå†…éƒ¨é€šè¿‡<code>getArray()</code>æ–¹æ³•è·å–åˆ°äº†arrayå±æ€§å€¼ï¼›</li><li>çº¿ç¨‹2è°ƒç”¨CopyOnWriteArrayListçš„å¢åˆ æ”¹æ–¹æ³•ï¼Œå†…éƒ¨é€šè¿‡<code>setArray</code>æ–¹æ³•ä¿®æ”¹äº†arrayå±æ€§çš„å€¼ï¼›</li><li>çº¿ç¨‹1è¿˜æ˜¯ä»æ—§çš„arrayæ•°ç»„ä¸­å–å€¼ã€‚</li></ol><p><strong>æ‰€ä»¥<code>get</code>æ–¹æ³•æ˜¯å¼±ä¸€è‡´æ€§çš„</strong>ã€‚</p><h3 id="size"><a href="#size" class="headerlink" title="size()"></a>size()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getArray().length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>size()</code>æ–¹æ³•è¿”å›å½“å‰arrayå±æ€§é•¿åº¦ï¼Œå› ä¸ºCopyOnWriteArrayListä¸­çš„arrayæ•°ç»„æ¯æ¬¡å¤åˆ¶éƒ½åˆšå¥½èƒ½å¤Ÿå®¹çº³ä¸‹æ‰€æœ‰å…ƒç´ ï¼Œå¹¶ä¸åƒArrayListé‚£æ ·ä¼šé¢„ç•™ä¸€å®šçš„ç©ºé—´ã€‚æ‰€ä»¥CopyOnWriteArrayListä¸­å¹¶æ²¡æœ‰sizeå±æ€§ï¼Œå…ƒç´ çš„ä¸ªæ•°å’Œæ•°ç»„çš„é•¿åº¦æ˜¯ç›¸ç­‰çš„ã€‚</p><h3 id="è¿­ä»£å™¨"><a href="#è¿­ä»£å™¨" class="headerlink" title="è¿­ä»£å™¨"></a>è¿­ä»£å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> COWIterator&lt;E&gt;(getArray(), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">COWIterator</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">ListIterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/** Snapshot of the array */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] snapshot;</span><br><span class="line">    <span class="comment">/** Index of element to be returned by subsequent call to next.  */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> cursor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">COWIterator</span><span class="params">(Object[] elements, <span class="keyword">int</span> initialCursor)</span> </span>&#123;</span><br><span class="line">        cursor = initialCursor;</span><br><span class="line">        snapshot = elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cursor &lt; snapshot.length;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿­ä»£å™¨ä¹Ÿæ˜¯å¼±ä¸€è‡´æ€§çš„ï¼Œå¹¶æ²¡æœ‰åœ¨é”ä¸­è¿›è¡Œã€‚å¦‚æœå…¶ä»–çº¿ç¨‹æ²¡æœ‰å¯¹CopyOnWriteArrayListè¿›è¡Œå¢åˆ æ”¹çš„æ“ä½œï¼Œé‚£ä¹ˆsnapshotè¿˜æ˜¯åˆ›å»ºè¿­ä»£å™¨æ—¶è·å–çš„arrayï¼Œä½†æ˜¯å¦‚æœå…¶ä»–çº¿ç¨‹å¯¹CopyOnWriteArrayListè¿›è¡Œäº†å¢åˆ æ”¹çš„æ“ä½œï¼Œæ—§çš„æ•°ç»„ä¼šè¢«æ–°çš„æ•°ç»„ç»™æ›¿æ¢æ‰ï¼Œä½†æ˜¯snapshotè¿˜æ˜¯åŸæ¥æ—§çš„æ•°ç»„çš„å¼•ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CopyOnWriteArrayList&lt;String&gt; list = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">list.add(<span class="string">"hello"</span>);</span><br><span class="line">Iterator&lt;String&gt; iterator = list.iterator();</span><br><span class="line">list.add(<span class="string">"world"</span>);</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">    System.out.println(iterator.next());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºç»“æœä»…ä¸ºhelloã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol><li>CopyOnWriteArrayListä½“ç°äº†å†™æ—¶å¤åˆ¶çš„æ€æƒ³ï¼Œå¢åˆ æ”¹æ“ä½œéƒ½æ˜¯åœ¨å¤åˆ¶çš„æ–°æ•°ç»„ä¸­è¿›è¡Œçš„ï¼›</li><li>CopyOnWriteArrayListçš„å–å€¼æ–¹æ³•æ˜¯å¼±ä¸€è‡´æ€§çš„ï¼Œæ— æ³•ç¡®ä¿å®æ—¶å–åˆ°æœ€æ–°çš„æ•°æ®ï¼›</li><li>CopyOnWriteArrayListçš„å¢åˆ æ”¹æ–¹æ³•é€šè¿‡å¯é‡å…¥é”ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼›</li><li>CopyOnWriteArrayListçº¿ç¨‹å®‰å…¨ä½“ç°åœ¨å¤šçº¿ç¨‹å¢åˆ æ”¹ä¸ä¼šæŠ›å‡º<code>java.util.ConcurrentModificationException</code>å¼‚å¸¸ï¼Œå¹¶ä¸èƒ½ç¡®ä¿æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼›</li><li>åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹CopyOnWriteArrayListè¿›è¡Œå¢åˆ æ”¹æ“ä½œï¼Œè€Œè¯»æ“ä½œæ²¡æœ‰é™åˆ¶ï¼Œå¹¶ä¸” CopyOnWriteArrayListå¢åˆ æ”¹æ“ä½œéƒ½éœ€è¦å¤åˆ¶ä¸€ä»½æ–°æ•°ç»„ï¼Œå¢åŠ äº†å†…å­˜æ¶ˆè€—ï¼Œæ‰€ä»¥CopyOnWriteArrayListé€‚åˆè¯»å¤šå†™å°‘çš„æƒ…å†µã€‚</li></ol><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:19 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;CopyOnWriteArrayListä¸ºçº¿ç¨‹å®‰å…¨çš„ArrayListï¼Œè¿™èŠ‚åˆ†æä¸‹CopyOnWriteArrayListçš„æºç ï¼ŒåŸºäºJDK1.8ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Vectoræºç è§£æ</title>
    <link href="http://mrbird.cc/Vector%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html"/>
    <id>http://mrbird.cc/Vectoræºç è§£æ.html</id>
    <published>2020-08-10T03:19:59.000Z</published>
    <updated>2021-02-22T05:51:57.236Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --><p>Vectorå’ŒArrayListéå¸¸ç›¸ä¼¼ï¼Œå®ƒä»¬éƒ½å®ç°äº†ç›¸åŒçš„æ¥å£ï¼Œç»§æ‰¿ç›¸åŒçš„ç±»ï¼Œå°±è¿æ–¹æ³•çš„å®ç°ä¹Ÿéå¸¸ç±»ä¼¼ã€‚å’ŒArrayListä¸åŒçš„æ˜¯ï¼ŒVectoræ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå…³é”®æ–¹æ³•ä¸Šéƒ½åŠ äº†synchronizedåŒæ­¥é”ï¼Œ<strong>ç”±äºVectoræ•ˆç‡ä¸é«˜ï¼Œæ‰€ä»¥ä½¿ç”¨çš„è¾ƒå°‘ï¼Œè¦ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„ArrayListï¼Œæ¨èCopyOnWriteArrayList</strong>ï¼Œåç»­å†åšåˆ†æï¼Œè¿™é‡Œä»…è®°å½•ä¸‹Vectoræºç ï¼ŒåŸºäºJDK1.8ã€‚</p><a id="more"></a><h2 id="ç±»ç»“æ„"><a href="#ç±»ç»“æ„" class="headerlink" title="ç±»ç»“æ„"></a>ç±»ç»“æ„</h2><p>Vectorçš„ç±»å…³ç³»å›¾å’ŒArrayListä¸€è‡´ï¼š</p><p><img src="img/QQ20210220-163414@2x.png" alt="QQ20210220-163414@2x"></p><p>Vectorå¯ä»¥å­˜æ”¾ä»»æ„ç±»å‹å…ƒç´ ï¼ˆåŒ…æ‹¬nullï¼‰ï¼Œå…è®¸é‡å¤ï¼Œå’ŒArrayListä¸€è‡´ï¼Œå†…éƒ¨é‡‡ç”¨Objectç±»å‹æ•°ç»„å­˜æ”¾æ•°æ®ï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæˆå‘˜å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Objectæ•°ç»„ï¼Œå­˜æ”¾æ•°æ®</span></span><br><span class="line"><span class="keyword">protected</span> Object[] elementData;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ƒç´ ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> elementCount;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“æ•°ç»„å®¹é‡ä¸è¶³æ—¶ï¼Œå®¹é‡å¢åŠ capacityIncrementï¼Œå¦‚æœcapacityIncrementä¸º0ï¼Œåˆ™æ‰©å®¹ä¸º2å€</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> capacityIncrement;</span><br></pre></td></tr></table></figure><p></p><h2 id="æ–¹æ³•è§£æ"><a href="#æ–¹æ³•è§£æ" class="headerlink" title="æ–¹æ³•è§£æ"></a>æ–¹æ³•è§£æ</h2><h3 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Vector</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> capacityIncrement)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal Capacity: "</span>+</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    <span class="keyword">this</span>.elementData = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">    <span class="keyword">this</span>.capacityIncrement = capacityIncrement;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Vector</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(initialCapacity, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Vector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>new Vector()</code>åˆ›å»ºVectoré›†åˆæ—¶ï¼Œç›´æ¥åˆ›å»ºäº†ä¸€ä¸ªå®¹é‡ä¸º10çš„Objectæ•°ç»„ï¼ˆå’ŒArrayListä¸åŒï¼ŒArrayListå†…éƒ¨æ•°ç»„åˆå§‹å®¹é‡ä¸º0ï¼Œåªæœ‰åœ¨æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™æ‰æ‰©å®¹ä¸º10ï¼‰ï¼Œå¹¶ä¸”capacityIncrementä¸º0ï¼Œæ„å‘³ç€å®¹é‡ä¸è¶³æ—¶ï¼Œæ–°æ•°ç»„å®¹é‡ä¸ºæ—§æ•°ç»„å®¹é‡çš„2å€ã€‚</p><h3 id="add-E-e"><a href="#add-E-e" class="headerlink" title="add(E e)"></a>add(E e)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    ensureCapacityHelper(elementCount + <span class="number">1</span>);</span><br><span class="line">    elementData[elementCount++] = e;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityHelper</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">    <span class="comment">// capacityIncrementä¸º0çš„è¯ï¼Œæ–°å®¹é‡ä¸ºæ—§å®¹é‡çš„2å€ï¼Œä¸ä¸º0ï¼Œåˆ™æ–°å®¹é‡ä¸ºæ—§å®¹é‡+capacityIncrement</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = oldCapacity + ((capacityIncrement &gt; <span class="number">0</span>) ?</span><br><span class="line">                                     capacityIncrement : oldCapacity);</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">    <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?</span><br><span class="line">        Integer.MAX_VALUE :</span><br><span class="line">        MAX_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ·»åŠ é€»è¾‘å’ŒArrayListçš„addæ–¹æ³•å¤§ä½“ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äºæ‰©å®¹ç­–ç•¥æœ‰äº›ä¸åŒï¼Œå¹¶ä¸”æ–¹æ³•ä½¿ç”¨synchronizedå…³é”®å­—ä¿®é¥°ã€‚</p><h3 id="set-int-index-E-element"><a href="#set-int-index-E-element" class="headerlink" title="set(int index, E element)"></a>set(int index, E element)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> E <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= elementCount)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArrayIndexOutOfBoundsException(index);</span><br><span class="line"></span><br><span class="line">    E oldValue = elementData(index);</span><br><span class="line">    elementData[index] = element;</span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€»è¾‘å’ŒArrayListçš„setæ–¹æ³•ä¸€è‡´ï¼Œæ–¹æ³•ä½¿ç”¨synchronizedå…³é”®å­—ä¿®é¥°ã€‚</p><h3 id="get-int-index"><a href="#get-int-index" class="headerlink" title="get(int index)"></a>get(int index)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= elementCount)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArrayIndexOutOfBoundsException(index);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> elementData(index);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">E <span class="title">elementData</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (E) elementData[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€»è¾‘å’ŒArrayListçš„getæ–¹æ³•ä¸€è‡´ï¼Œæ–¹æ³•ä½¿ç”¨synchronizedå…³é”®å­—ä¿®é¥°ã€‚</p><h3 id="remove-int-index"><a href="#remove-int-index" class="headerlink" title="remove(int index)"></a>remove(int index)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= elementCount)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArrayIndexOutOfBoundsException(index);</span><br><span class="line">    E oldValue = elementData(index);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numMoved = elementCount - index - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</span><br><span class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    elementData[--elementCount] = <span class="keyword">null</span>; <span class="comment">// Let gc do its work</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€»è¾‘å’ŒArrayListçš„removeæ–¹æ³•ä¸€è‡´ï¼Œæ–¹æ³•ä½¿ç”¨synchronizedå…³é”®å­—ä¿®é¥°ã€‚</p><h3 id="trimToSize"><a href="#trimToSize" class="headerlink" title="trimToSize()"></a>trimToSize()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">trimToSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">    <span class="keyword">if</span> (elementCount &lt; oldCapacity) &#123;</span><br><span class="line">        elementData = Arrays.copyOf(elementData, elementCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€»è¾‘å’ŒArrayListçš„trimToSizeæ–¹æ³•ä¸€è‡´ï¼Œæ–¹æ³•ä½¿ç”¨synchronizedå…³é”®å­—ä¿®é¥°ã€‚</p><blockquote><p>å‰©ä¸‹çš„æ–¹æ³•æºç è‡ªå·±æŸ¥çœ‹ï¼Œå¤§ä½“å’ŒArrayListæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚Vectorçš„æ–¹æ³•éƒ½ç”¨synchronizedå…³é”®å­—æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è®¿é—®æ­¤å¯¹è±¡ï¼Œåœ¨çº¿ç¨‹ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹æ³•æ•ˆç‡éå¸¸ä½ï¼Œæ‰€ä»¥å®é™…å¹¶ä¸æ¨èä½¿ç”¨Vectorã€‚</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Vectorå’ŒArrayListéå¸¸ç›¸ä¼¼ï¼Œå®ƒä»¬éƒ½å®ç°äº†ç›¸åŒçš„æ¥å£ï¼Œç»§æ‰¿ç›¸åŒçš„ç±»ï¼Œå°±è¿æ–¹æ³•çš„å®ç°ä¹Ÿéå¸¸ç±»ä¼¼ã€‚å’ŒArrayListä¸åŒçš„æ˜¯ï¼ŒVectoræ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå…³é”®æ–¹æ³•ä¸Šéƒ½åŠ äº†synchronizedåŒæ­¥é”ï¼Œ&lt;strong&gt;ç”±äºVectoræ•ˆç‡ä¸é«˜ï¼Œæ‰€ä»¥ä½¿ç”¨çš„è¾ƒå°‘ï¼Œè¦ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„ArrayListï¼Œæ¨èCopyOnWriteArrayList&lt;/strong&gt;ï¼Œåç»­å†åšåˆ†æï¼Œè¿™é‡Œä»…è®°å½•ä¸‹Vectoræºç ï¼ŒåŸºäºJDK1.8ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>ArrayList &amp; LinkedListæºç è§£æ</title>
    <link href="http://mrbird.cc/LinkedList-ArrayList%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html"/>
    <id>http://mrbird.cc/LinkedList-ArrayListæºç è§£æ.html</id>
    <published>2020-08-08T03:19:59.000Z</published>
    <updated>2021-02-20T09:04:19.226Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:20 GMT+0800 (GMT+08:00) --><p>æœ¬æ–‡è®°å½•ArrayList &amp; LinkedListæºç è§£æï¼ŒåŸºäºJDK1.8ã€‚<a id="more"></a></p><h2 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h2><p>ArrayListå®ç°äº†Listæ¥å£çš„æ‰€æœ‰æ–¹æ³•ï¼Œå¯ä»¥çœ‹æˆæ˜¯â€œé•¿åº¦å¯è°ƒèŠ‚çš„æ•°ç»„â€ï¼Œå¯ä»¥åŒ…å«ä»»ä½•ç±»å‹æ•°æ®ï¼ˆåŒ…æ‹¬nullï¼Œå¯é‡å¤ï¼‰ã€‚ArrayListå¤§ä½“å’ŒVectorä¸€è‡´ï¼Œå”¯ä¸€åŒºåˆ«æ˜¯ArrayListéçº¿ç¨‹å®‰å…¨ï¼ŒVectorçº¿ç¨‹å®‰å…¨ï¼Œä½†Vectorçº¿ç¨‹å®‰å…¨çš„ä»£ä»·è¾ƒå¤§ï¼Œæ¨èä½¿ç”¨CopyOnWriteArrayListï¼Œåé¢æ–‡ç« å†åšè®°å½•ã€‚</p><h3 id="ç±»ç»“æ„"><a href="#ç±»ç»“æ„" class="headerlink" title="ç±»ç»“æ„"></a>ç±»ç»“æ„</h3><p>ArrayListç±»å±‚çº§å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQ20210219-143407@2x.png" alt="QQ20210219-143407@2x"></p><p>ArrayListé¢å¤–å®ç°äº†RandomAccessæ¥å£ï¼Œå…³äºRandomAccessæ¥å£çš„ä½œç”¨ä¸‹é¢å†åšè®¨è®ºã€‚</p><p>ArrayListç±»ä¸»è¦åŒ…å«å¦‚ä¸‹ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">RandomAccess</span>, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">transient</span> Object[] elementData;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>elementDataä¸ºObjectç±»å‹æ•°ç»„ï¼Œç”¨äºå­˜æ”¾ArrayListæ•°æ®ï¼›sizeè¡¨ç¤ºæ•°ç»„å…ƒç´ ä¸ªæ•°ï¼ˆå¹¶éæ•°ç»„å®¹é‡ï¼‰ã€‚</p><p>ArrayListç±»è¿˜åŒ…å«äº†ä¸€äº›å¸¸é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">RandomAccess</span>, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// æ•°ç»„é»˜è®¤åˆå§‹åŒ–å®¹é‡ä¸º10</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºç©ºæ•°ç»„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line">    <span class="comment">// ä¹Ÿæ˜¯ç©ºæ•°ç»„ï¼Œå’ŒEMPTY_ELEMENTDATAåŒºåˆ†å¼€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="æ–¹æ³•è§£æ"><a href="#æ–¹æ³•è§£æ" class="headerlink" title="æ–¹æ³•è§£æ"></a>æ–¹æ³•è§£æ</h3><h4 id="çŸ¥è¯†å‚¨å¤‡"><a href="#çŸ¥è¯†å‚¨å¤‡" class="headerlink" title="çŸ¥è¯†å‚¨å¤‡"></a>çŸ¥è¯†å‚¨å¤‡</h4><p>Arraysç±»çš„<code>copyOf(U[] original, int newLength, Class&lt;? extends T[]&gt; newType)</code>æ–¹æ³•ç”¨äºå¤åˆ¶æŒ‡å®šæ•°ç»„originalåˆ°æ–°æ•°ç»„ï¼Œæ–°æ•°ç»„çš„é•¿åº¦ä¸ºnewLengthï¼Œæ–°æ•°ç»„å…ƒç´ ç±»å‹ä¸ºnewTypeã€‚</p><ol><li>å¦‚æœæ–°æ•°ç»„çš„é•¿åº¦å¤§äºæ—§æ•°ç»„ï¼Œé‚£ä¹ˆå¤šå‡ºçš„é‚£éƒ¨åˆ†ç”¨nullå¡«å……ï¼›</li><li>å¦‚æœæ–°æ•°ç»„çš„é•¿åº¦å°äºæ—§æ•°ç»„ï¼Œé‚£ä¹ˆå°‘çš„é‚£éƒ¨åˆ†ç›´æ¥æˆªå–æ‰ã€‚</li></ol><p>ä¸¾ä¸¤ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Long[] array1 = <span class="keyword">new</span> Long[]&#123;<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>&#125;;</span><br><span class="line">Object[] array2 = Arrays.copyOf(array1, <span class="number">5</span>, Object[].class);</span><br><span class="line">System.out.println(Arrays.toString(array2)); <span class="comment">// [1, 2, 3, null, null]</span></span><br><span class="line"></span><br><span class="line">Object[] array3 = Arrays.copyOf(array1, <span class="number">1</span>, Object[].class);</span><br><span class="line">System.out.println(Arrays.toString(array3)); <span class="comment">// [1]</span></span><br></pre></td></tr></table></figure><p></p><p>é‡è½½æ–¹æ³•<code>copyOf(T[] original, int newLength)</code>ç”¨äºå¤åˆ¶æŒ‡å®šæ•°ç»„originalåˆ°æ–°æ•°ç»„ï¼Œæ–°æ•°ç»„çš„é•¿åº¦ä¸ºnewLengthï¼Œæ–°æ•°ç»„å…ƒç´ ç±»å‹å’Œæ—§æ•°ç»„ä¸€è‡´ã€‚</p><p><code>copyOf</code>æ–¹æ³•å†…éƒ¨è°ƒç”¨Systemç±»çš„nativeæ–¹æ³•<code>arraycopy(Object src, int srcPos,Object dest, int destPos, int length)</code>ï¼š</p><ol><li><code>src</code>ï¼šéœ€è¦è¢«æ‹·è´çš„æ—§æ•°ç»„ï¼›</li><li><code>srcPos</code>ï¼šæ—§æ•°ç»„å¼€å§‹æ‹·è´çš„èµ·å§‹ä½ç½®ï¼›</li><li><code>dest</code>ï¼šæ‹·è´ç›®æ ‡æ•°ç»„ï¼›</li><li><code>destPos</code>ï¼šç›®æ ‡æ•°ç»„çš„èµ·å§‹æ‹·è´ä½ç½®ï¼›</li><li><code>length</code>ï¼šæ‹·è´çš„é•¿åº¦ã€‚</li></ol><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Long[] array1 = <span class="keyword">new</span> Long[]&#123;<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>&#125;;</span><br><span class="line">Object[] array2 = <span class="keyword">new</span> Object[<span class="number">5</span>];</span><br><span class="line">System.arraycopy(array1, <span class="number">0</span>, array2, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">System.out.println(Arrays.toString(array2)); <span class="comment">// [1, 2, 3, null, null]</span></span><br></pre></td></tr></table></figure><p></p><p>æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Long[] array1 = <span class="keyword">new</span> Long[]&#123;<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line">System.arraycopy(array1, index, array1, index + <span class="number">1</span>, <span class="number">3</span> - index);</span><br><span class="line">array1[index] = <span class="number">0L</span>;</span><br><span class="line">System.out.println(Arrays.toString(array1)); <span class="comment">// [1, 0, 2, 3, null, null]</span></span><br></pre></td></tr></table></figure><p></p><h4 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h4><p><code>public ArrayList(int initialCapacity)</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.elementData = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal Capacity: "</span>+</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºå®¹é‡å¤§å°ä¸ºinitialCapacityçš„ArrayListï¼Œå¦‚æœinitialCapacityå°äº0ï¼Œåˆ™æŠ›å‡ºIllegalArgumentExceptionå¼‚å¸¸ï¼›å¦‚æœinitialCapacityä¸º0ï¼Œåˆ™elementDataä¸ºEMPTY_ELEMENTDATAã€‚</p><p><code>public ArrayList()</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç©ºå‚æ„é€ å‡½æ•°ï¼ŒelementDataä¸ºDEFAULTCAPACITY_EMPTY_ELEMENTDATAã€‚</p><p><code>public ArrayList(Collection&lt;? extends E&gt; c)</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    elementData = c.toArray();</span><br><span class="line">    <span class="keyword">if</span> ((size = elementData.length) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// c.toArray might (incorrectly) not return Object[] (see 6260652)</span></span><br><span class="line">        <span class="keyword">if</span> (elementData.getClass() != Object[].class)</span><br><span class="line">            elementData = Arrays.copyOf(elementData, size, Object[].class);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// replace with empty array.</span></span><br><span class="line">        <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºä¸€ä¸ªåŒ…å«æŒ‡å®šé›†åˆcæ•°æ®çš„ArrayListã€‚ä¸Šé¢ä¸ºä»€ä¹ˆè¦å¤šæ­¤ä¸€ä¸¾ä½¿ç”¨<code>Arrays.copyOf(elementData, size, Object[].class)</code>å¤åˆ¶ä¸€éæ•°ç»„å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨æŸäº›æƒ…å†µä¸‹è°ƒç”¨é›†åˆçš„toArray()æ–¹æ³•è¿”å›çš„ç±»å‹å¹¶ä¸æ˜¯Object[].classï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Long[] array1 = &#123;<span class="number">1L</span>, <span class="number">2L</span>&#125;;</span><br><span class="line">List&lt;Long&gt; list1 = Arrays.asList(array1);</span><br><span class="line">Object[] array2 = list1.toArray();</span><br><span class="line">System.out.println(array2.getClass() == Object[].class); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">List&lt;Long&gt; list2 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">System.out.println(list2.toArray().getClass() == Object[].class); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p></p><h4 id="add-E-e"><a href="#add-E-e" class="headerlink" title="add(E e)"></a>add(E e)</h4><p><code>add(E e)</code>ç”¨äºå°¾éƒ¨æ·»åŠ å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç”¨äºç¡®å®šæ•°ç»„å®¹é‡</span></span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);</span><br><span class="line">    elementData[size++] = e;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å‡å¦‚ç°åœ¨æˆ‘ä»¬é€šè¿‡å¦‚ä¸‹ä»£ç åˆ›å»ºäº†ä¸€ä¸ªArrayListå®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">list.add(<span class="string">"hello"</span>);</span><br></pre></td></tr></table></figure><p></p><p>å†…éƒ¨è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç”¨äºç¡®å®šæ•°ç»„å®¹é‡ï¼Œe=helloï¼Œsize=0</span></span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// æœ«å°¾æ·»åŠ å…ƒç´ ï¼Œç„¶åsizeé€’å¢1</span></span><br><span class="line">    elementData[size++] = e;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123; <span class="comment">// minCapacity=1,elementData=&#123;&#125;</span></span><br><span class="line">    ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculateCapacity</span><span class="params">(Object[] elementData, <span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</span><br><span class="line">        <span class="comment">// DEFAULT_CAPACITY=10ï¼ŒminCapacity=1ï¼Œæ•…è¿”å›10</span></span><br><span class="line">        <span class="keyword">return</span> Math.max(DEFAULT_CAPACITY, minCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> minCapacity;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureExplicitCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123; <span class="comment">// minCapacity=10</span></span><br><span class="line">    modCount++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// minCapacity=10ï¼ŒelementData.length=0ï¼Œæ‰€ä»¥è°ƒç”¨growæ–¹æ³•æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123; <span class="comment">//minCapacity=10</span></span><br><span class="line">    <span class="comment">// oldCapacity=0</span></span><br><span class="line">    <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">    <span class="comment">// newCapacityä¸ºoldCapacityçš„1.5å€ï¼Œè¿™é‡Œä¸º0</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// newCapacity=0ï¼ŒminCapacity=10ï¼Œæ‰€ä»¥è¯¥æ¡ä»¶æˆç«‹</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// newCapacity=10</span></span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    <span class="comment">// å¤åˆ¶åˆ°æ–°æ•°ç»„ï¼Œæ•°ç»„å®¹é‡ä¸º10</span></span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">    <span class="comment">// MAX_ARRAY_SIZEå¸¸é‡å€¼ä¸ºInteger.MAX_VALUE - 8ï¼Œé€šè¿‡</span></span><br><span class="line">    <span class="comment">// è¿™æ®µé€»è¾‘æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒArrayListæœ€å¤§å®¹é‡ä¸ºInteger.MAX_VALUE</span></span><br><span class="line">    <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?</span><br><span class="line">        Integer.MAX_VALUE :</span><br><span class="line">        MAX_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡ä¸Šé¢æºç åˆ†ææˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š</p><ol><li>ä»»ä½•ä¸€ä¸ªç©ºçš„ArrayListåœ¨æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå†…éƒ¨æ•°ç»„å®¹é‡å°†è¢«æ‰©å®¹ä¸º10ï¼›</li><li>æ‰©å®¹æ—¶ï¼ŒnewCapacityä¸ºoldCapacityçš„1.5å€ï¼›</li><li>æ•°ç»„å®¹é‡æœ€å¤§ä¸ºInteger.MAX_VALUEï¼›</li><li>å°¾éƒ¨æ·»åŠ å…ƒç´ ä¸ç”¨ç§»åŠ¨ä»»ä½•å…ƒç´ ï¼Œæ‰€ä»¥é€Ÿåº¦å¿«ã€‚</li></ol><h4 id="add-int-index-E-element"><a href="#add-int-index-E-element" class="headerlink" title="add(int index, E element)"></a>add(int index, E element)</h4><p><code>add(int index, E element)</code>ç”¨äºåœ¨æŒ‡å®šä½ç½®æ·»åŠ å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸‹æ ‡æ£€æŸ¥</span></span><br><span class="line">    rangeCheckForAdd(index);</span><br><span class="line">    <span class="comment">// ç¡®å®šæ•°ç»„å®¹é‡ï¼Œå’Œä¸Šé¢add(E e)æ–¹æ³•ä»‹ç»çš„ä¸€è‡´</span></span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// å°†åŸæ¥indexåé¢çš„æ‰€æœ‰å…ƒç´ å¾€åé¢ç§»åŠ¨ä¸€ä¸ªä½ç½®</span></span><br><span class="line">    System.arraycopy(elementData, index, elementData, index + <span class="number">1</span>,</span><br><span class="line">                     size - index);</span><br><span class="line">    <span class="comment">// indexå¤„æ”¾å…¥æ–°å…ƒç´ </span></span><br><span class="line">    elementData[index] = element;</span><br><span class="line">    <span class="comment">// sizeé€’å¢</span></span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rangeCheckForAdd</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸‹æ ‡æ¯”sizeå¤§æˆ–è€…ä¸‹æ ‡å°äº0ï¼Œéƒ½ä¼šæŠ›å‡ºä¸‹æ ‡è¶Šç•Œå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (index &gt; size || index &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(outOfBoundsMsg(index));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿™é‡Œæ¶‰åŠåˆ°å…ƒç´ ç§»åŠ¨ï¼Œæ‰€ä»¥é€Ÿåº¦è¾ƒæ…¢ã€‚</p><h4 id="get-int-index"><a href="#get-int-index" class="headerlink" title="get(int index)"></a>get(int index)</h4><p><code>get(int index)</code>è·å–æŒ‡å®šä½ç½®å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸‹æ ‡åˆæ³•æ€§æ£€æŸ¥</span></span><br><span class="line">    rangeCheck(index);</span><br><span class="line">    <span class="comment">// ç›´æ¥è¿”å›æ•°ç»„æŒ‡å®šä½ç½®å…ƒç´ </span></span><br><span class="line">    <span class="keyword">return</span> elementData(index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">E <span class="title">elementData</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (E) elementData[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>get</code>æ–¹æ³•ç›´æ¥è¿”å›æ•°ç»„æŒ‡å®šä¸‹æ ‡å…ƒç´ ï¼Œé€Ÿåº¦éå¸¸å¿«ã€‚</p><h4 id="set-int-index-E-element"><a href="#set-int-index-E-element" class="headerlink" title="set(int index, E element)"></a>set(int index, E element)</h4><p><code>set(int index, E element)</code>è®¾ç½®æŒ‡å®šä½ç½®å…ƒç´ ä¸ºæŒ‡å®šå€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸‹æ ‡åˆæ³•æ€§æ£€æŸ¥</span></span><br><span class="line">    rangeCheck(index);</span><br><span class="line">    <span class="comment">// æ ¹æ®ä¸‹æ ‡è·å–æ—§å€¼</span></span><br><span class="line">    E oldValue = elementData(index);</span><br><span class="line">    <span class="comment">// è®¾ç½®æ–°å€¼</span></span><br><span class="line">    elementData[index] = element;</span><br><span class="line">    <span class="comment">// è¿”å›æ—§å€¼</span></span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>set</code>æ–¹æ³•ä¸æ¶‰åŠå…ƒç´ ç§»åŠ¨å’Œéå†ï¼Œæ‰€ä»¥é€Ÿåº¦å¿«ã€‚</p><h4 id="remove-int-index"><a href="#remove-int-index" class="headerlink" title="remove(int index)"></a>remove(int index)</h4><p><code>remove(int index)</code>åˆ é™¤æŒ‡å®šä½ç½®å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    rangeCheck(index);</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// è·å–æŒ‡å®šä½ç½®å…ƒç´ ï¼ˆéœ€è¦è¢«åˆ é™¤çš„å…ƒç´ ï¼‰</span></span><br><span class="line">    E oldValue = elementData(index);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numMoved = size - index - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// ç›´æ¥å°†indexåé¢çš„å…ƒç´ å¾€å‰ç§»åŠ¨ä¸€ä½ï¼Œè¦†ç›–indexå¤„çš„å…ƒç´ </span></span><br><span class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    elementData[--size] = <span class="keyword">null</span>; <span class="comment">// clear to let GC do its work</span></span><br><span class="line">    <span class="comment">// è¿”å›è¢«åˆ é™¤çš„å…ƒ</span></span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šè¿°æ–¹æ³•æ¶‰åŠåˆ°å…ƒç´ ç§»åŠ¨ï¼Œæ‰€ä»¥æ•ˆç‡ä¹Ÿä¸é«˜ã€‚</p><h4 id="remove-Object-o"><a href="#remove-Object-o" class="headerlink" title="remove(Object o)"></a>remove(Object o)</h4><p><code>remove(Object o)</code>åˆ é™¤æŒ‡å®šå…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éå†æ•°ç»„ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªç›®æ ‡å…ƒç´ ï¼Œç„¶ååˆ é™¤</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; size; index++)</span><br><span class="line">            <span class="keyword">if</span> (elementData[index] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; size; index++)</span><br><span class="line">            <span class="keyword">if</span> (o.equals(elementData[index])) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é€»è¾‘å’Œremoveä¸€è‡´ï¼Œéƒ½æ˜¯å°†indexåé¢çš„å…ƒç´ å¾€å‰ç§»åŠ¨ä¸€ä½ï¼Œè¦†ç›–indexå¤„çš„å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fastRemove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">int</span> numMoved = size - index - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</span><br><span class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    elementData[--size] = <span class="keyword">null</span>; <span class="comment">// clear to let GC do its work</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–¹æ³•æ¶‰åŠåˆ°æ•°ç»„éå†å’Œå…ƒç´ ç§»åŠ¨ï¼Œæ•ˆç‡ä¹Ÿä¸é«˜ã€‚</p><h4 id="trimToSize"><a href="#trimToSize" class="headerlink" title="trimToSize()"></a>trimToSize()</h4><p><code>trimToSize()</code>æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trimToSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">if</span> (size &lt; elementData.length) &#123;</span><br><span class="line">        elementData = (size == <span class="number">0</span>)</span><br><span class="line">          ? EMPTY_ELEMENTDATA</span><br><span class="line">          : Arrays.copyOf(elementData, size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¯¥æ–¹æ³•ç”¨äºå°†æ•°ç»„å®¹é‡è°ƒæ•´ä¸ºå®é™…å…ƒç´ ä¸ªæ•°å¤§å°ï¼Œå½“ä¸€ä¸ªArrayListå…ƒç´ ä¸ªæ•°ä¸ä¼šå‘ç”Ÿæ”¹å˜æ—¶ï¼Œå¯ä»¥è°ƒç”¨è¯¥æ–¹æ³•å‡å°‘å†…å­˜å ç”¨ã€‚</p><blockquote><p>å…¶ä»–æ–¹æ³•å¯ä»¥è‡ªå·±é˜…è¯»ArrayListæºç ï¼Œæ­¤å¤–åœ¨æ¶‰åŠå¢åˆ æ”¹çš„æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬éƒ½çœ‹åˆ°äº†modCount++æ“ä½œï¼Œå’Œä¹‹å‰ä»‹ç»HashMapæºç æ—¶ä¸€è‡´ï¼Œç”¨äºå¿«é€Ÿå¤±è´¥ã€‚</p></blockquote><h2 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h2><h3 id="ç±»ç»“æ„-1"><a href="#ç±»ç»“æ„-1" class="headerlink" title="ç±»ç»“æ„"></a>ç±»ç»“æ„</h3><p>LinkedListåº•å±‚é‡‡ç”¨åŒå‘é“¾è¡¨ç»“æ„å­˜å‚¨æ•°æ®ï¼Œå…è®¸é‡å¤æ•°æ®å’Œnullå€¼ï¼Œé•¿åº¦æ²¡æœ‰é™åˆ¶ï¼š</p><p><img src="img/QQ20210220-112151@2x.png" alt="QQ20210220-112151@2x"></p><p>æ¯ä¸ªèŠ‚ç‚¹ç”¨å†…éƒ¨ç±»Nodeè¡¨ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    E item;</span><br><span class="line">    Node&lt;E&gt; next;</span><br><span class="line">    Node&lt;E&gt; prev;</span><br><span class="line"></span><br><span class="line">    Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.item = element;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">        <span class="keyword">this</span>.prev = prev;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>NodeèŠ‚ç‚¹åŒ…å«itemï¼ˆå­˜å‚¨æ•°æ®ï¼‰ï¼Œnextï¼ˆåç»§èŠ‚ç‚¹ï¼‰å’Œprevï¼ˆå‰ç»§èŠ‚ç‚¹ï¼‰ã€‚æ•°ç»„å†…å­˜åœ°å€å¿…é¡»è¿ç»­ï¼Œè€Œé“¾è¡¨å°±æ²¡æœ‰è¿™ä¸ªé™åˆ¶äº†ï¼ŒNodeå¯ä»¥åˆ†å¸ƒäºå„ä¸ªå†…å­˜åœ°å€ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»é€šè¿‡prevå’Œnextç»´æŠ¤ã€‚</p><p>LinkedListç±»å…³ç³»å›¾ï¼š</p><p><img src="img/QQ20210220-112546@2x.png" alt="QQ20210220-112546@2x"></p><p>å¯ä»¥çœ‹åˆ°LinkedListç±»å¹¶æ²¡æœ‰å®ç°RandomAccessæ¥å£ï¼Œé¢å¤–å®ç°äº†Dequeæ¥å£ï¼Œæ‰€ä»¥åŒ…å«ä¸€äº›é˜Ÿåˆ—æ–¹æ³•ã€‚</p><p>LinkedListåŒ…å«å¦‚ä¸‹æˆå‘˜å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…ƒç´ ä¸ªæ•°ï¼Œé»˜è®¤ä¸º0</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¡¨ç¤ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»æ»¡è¶³(first == null &amp;&amp; last == null) || (first.prev == null &amp;&amp; first.item != null)</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;E&gt; first;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¡¨ç¤ºæœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæœ€åä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»æ»¡è¶³(first == null &amp;&amp; last == null) || (last.next == null &amp;&amp; last.item != null)</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;E&gt; last;</span><br></pre></td></tr></table></figure><p></p><h3 id="æ–¹æ³•è§£æ-1"><a href="#æ–¹æ³•è§£æ-1" class="headerlink" title="æ–¹æ³•è§£æ"></a>æ–¹æ³•è§£æ</h3><h4 id="æ„é€ å‡½æ•°-1"><a href="#æ„é€ å‡½æ•°-1" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h4><p><code>LinkedList()</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç©ºå‚æ„é€ å‡½æ•°ï¼Œé»˜è®¤sizeä¸º0ï¼Œæ¯æ¬¡æ·»åŠ æ–°å…ƒç´ éƒ½è¦åˆ›å»ºNodeèŠ‚ç‚¹ã€‚</p><p><code>LinkedList(Collection&lt;? extends E&gt; c)</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>();</span><br><span class="line">    addAll(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addAll(size, c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(<span class="keyword">int</span> index, Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    checkPositionIndex(index);</span><br><span class="line"></span><br><span class="line">    Object[] a = c.toArray();</span><br><span class="line">    <span class="keyword">int</span> numNew = a.length;</span><br><span class="line">    <span class="keyword">if</span> (numNew == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    Node&lt;E&gt; pred, succ;</span><br><span class="line">    <span class="keyword">if</span> (index == size) &#123;</span><br><span class="line">        succ = <span class="keyword">null</span>;</span><br><span class="line">        pred = last;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        succ = node(index);</span><br><span class="line">        pred = succ.prev;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¾ªç¯åˆ›å»ºèŠ‚ç‚¹ï¼Œè®¾ç½®prevï¼ŒnextæŒ‡å‘</span></span><br><span class="line">    <span class="keyword">for</span> (Object o : a) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) E e = (E) o;</span><br><span class="line">        Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(pred, e, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</span><br><span class="line">            first = newNode;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pred.next = newNode;</span><br><span class="line">        pred = newNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (succ == <span class="keyword">null</span>) &#123;</span><br><span class="line">        last = pred;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pred.next = succ;</span><br><span class="line">        succ.prev = pred;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size += numNew;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¯¥æ„é€ å‡½æ•°ç”¨äºåˆ›å»ºLinkedListï¼Œå¹¶å¾€é‡Œæ·»åŠ æŒ‡å®šé›†åˆå…ƒç´ ã€‚</p><h4 id="add-int-index-E-element-1"><a href="#add-int-index-E-element-1" class="headerlink" title="add(int index, E element)"></a>add(int index, E element)</h4><p><code>add(int index, E element)</code>æŒ‡å®šä¸‹æ ‡æ’å…¥å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸‹æ ‡åˆæ³•æ€§æ£€æŸ¥</span></span><br><span class="line">    checkPositionIndex(index);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == size)</span><br><span class="line">        <span class="comment">// å¦‚æœæ’å…¥ä¸‹æ ‡ç­‰äºsizeï¼Œè¯´æ˜æ˜¯åœ¨å°¾éƒ¨æ’å…¥ï¼Œæ‰§è¡Œå°¾éƒ¨æ’å…¥æ“ä½œ</span></span><br><span class="line">        linkLast(element);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// å¦‚æœä¸æ˜¯å°¾æ’å…¥ï¼Œåˆ™åœ¨æŒ‡å®šä¸‹æ ‡èŠ‚ç‚¹å‰æ’å…¥</span></span><br><span class="line">        linkBefore(element, node(index));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkPositionIndex</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isPositionIndex(index))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(outOfBoundsMsg(index));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isPositionIndex</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt;= size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">linkLast</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–æœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; l = last;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œprevä¸ºåŸé“¾è¡¨æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œnextä¸ºnull</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(l, e, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// æ›´æ–°lastä¸ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">    last = newNode;</span><br><span class="line">    <span class="keyword">if</span> (l == <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">// å¦‚æœåŸé“¾è¡¨æœ€åä¸€ä¸ªèŠ‚ç‚¹ä¸ºnullï¼Œè¯´æ˜åŸé“¾è¡¨æ²¡æœ‰èŠ‚ç‚¹ï¼Œå°†æ–°èŠ‚ç‚¹èµ‹ç»™first</span></span><br><span class="line">        first = newNode;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// å¦åˆ™æ›´æ–°åŸé“¾è¡¨æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„nextä¸ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">        l.next = newNode;</span><br><span class="line">    <span class="comment">// sizeé€’å¢</span></span><br><span class="line">    size++;</span><br><span class="line">    <span class="comment">// æ¨¡æ•°é€’å¢ï¼Œç”¨äºå¿«é€Ÿå¤±è´¥</span></span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">linkBefore</span><span class="params">(E e, Node&lt;E&gt; succ)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// succä¸ºåŸé“¾è¡¨æŒ‡å®šindexä½ç½®çš„èŠ‚ç‚¹ï¼Œè·å–å…¶prevèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; pred = succ.prev;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œprevä¸ºåŸé“¾è¡¨æŒ‡å®šindexä½ç½®çš„èŠ‚ç‚¹çš„prevèŠ‚ç‚¹ï¼Œnextä¸ºåŸé“¾è¡¨æŒ‡å®šindexä½ç½®çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(pred, e, succ);</span><br><span class="line">    <span class="comment">// å°†åŸé“¾è¡¨æŒ‡å®šindexä½ç½®çš„èŠ‚ç‚¹çš„prevæ›´æ–°ä¸ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">    succ.prev = newNode;</span><br><span class="line">    <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">// å¦‚æœé“¾è¡¨æŒ‡å®šindexä½ç½®çš„èŠ‚ç‚¹çš„prevä¸ºnullï¼Œè¯´æ˜åŸé“¾è¡¨æ²¡æœ‰èŠ‚ç‚¹ï¼Œå°†æ–°èŠ‚ç‚¹èµ‹ç»™first</span></span><br><span class="line">        first = newNode;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// å¦åˆ™æ›´æ–°åŸé“¾è¡¨æŒ‡å®šindexä½ç½®çš„èŠ‚ç‚¹çš„prevçš„nextèŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">        pred.next = newNode;</span><br><span class="line">    <span class="comment">// sizeé€’å¢</span></span><br><span class="line">    size++;</span><br><span class="line">    <span class="comment">// æ¨¡æ•°é€’å¢ï¼Œç”¨äºå¿«é€Ÿå¤±è´¥</span></span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡‡ç”¨äºŒåˆ†æ³•éå†æ¯ä¸ªNodeèŠ‚ç‚¹ï¼Œç›´åˆ°æ‰¾åˆ°indexä½ç½®çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="function">Node&lt;E&gt; <span class="title">node</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert isElementIndex(index);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &lt; (size &gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">        Node&lt;E&gt; x = first;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">            x = x.next;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;E&gt; x = last;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = size - <span class="number">1</span>; i &gt; index; i--)</span><br><span class="line">            x = x.prev;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä»£ç è¾ƒä¸ºç®€å•ï¼Œæ— éå°±æ˜¯è®¾ç½®èŠ‚ç‚¹çš„prevå’Œnextå…³ç³»ã€‚å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†å¤´æ’å’Œå°¾æ’å¤–ï¼Œåœ¨é“¾è¡¨åˆ«çš„ä½ç½®æ’å…¥æ–°èŠ‚ç‚¹ï¼Œæ¶‰åŠåˆ°èŠ‚ç‚¹éå†æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¸¸è¯´çš„é“¾è¡¨æ’å…¥é€Ÿåº¦å¿«ï¼ŒæŒ‡çš„æ˜¯æ’å…¥èŠ‚ç‚¹æ”¹å˜å‰åèŠ‚ç‚¹çš„å¼•ç”¨è¿‡ç¨‹å¾ˆå¿«ã€‚</p><h4 id="get-int-index-1"><a href="#get-int-index-1" class="headerlink" title="get(int index)"></a>get(int index)</h4><p><code>get(int index)</code>è·å–æŒ‡å®šä¸‹æ ‡å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    <span class="keyword">return</span> node(index).item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡‡ç”¨äºŒåˆ†æ³•éå†æ¯ä¸ªNodeèŠ‚ç‚¹ï¼Œç›´åˆ°æ‰¾åˆ°indexä½ç½®çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="function">Node&lt;E&gt; <span class="title">node</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert isElementIndex(index);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &lt; (size &gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">        Node&lt;E&gt; x = first;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">            x = x.next;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;E&gt; x = last;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = size - <span class="number">1</span>; i &gt; index; i--)</span><br><span class="line">            x = x.prev;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä»£ç è¾ƒä¸ºç®€å•ï¼Œå°±æ˜¯é€šè¿‡nodeå‡½æ•°æŸ¥æ‰¾æŒ‡å®šindexä¸‹æ ‡Nodeï¼Œç„¶åè·å–å…¶itemå±æ€§å€¼ï¼ŒèŠ‚ç‚¹æŸ¥æ‰¾éœ€è¦éå†ã€‚</p><h4 id="set-int-index-E-element-1"><a href="#set-int-index-E-element-1" class="headerlink" title="set(int index, E element)"></a>set(int index, E element)</h4><p><code>set(int index, E element)</code>è®¾ç½®æŒ‡å®šä¸‹æ ‡èŠ‚ç‚¹çš„itemä¸ºæŒ‡å®šå€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸‹æ ‡åˆæ³•æ€§æ£€æŸ¥</span></span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    <span class="comment">// è·å–indexä¸‹æ ‡èŠ‚ç‚¹</span></span><br><span class="line">    Node&lt;E&gt; x = node(index);</span><br><span class="line">    <span class="comment">// è·å–æ—§å€¼</span></span><br><span class="line">    E oldVal = x.item;</span><br><span class="line">    <span class="comment">// è®¾ç½®æ–°å€¼</span></span><br><span class="line">    x.item = element;</span><br><span class="line">    <span class="comment">// è¿”å›æ—§å€¼</span></span><br><span class="line">    <span class="keyword">return</span> oldVal;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡‡ç”¨äºŒåˆ†æ³•éå†æ¯ä¸ªNodeèŠ‚ç‚¹ï¼Œç›´åˆ°æ‰¾åˆ°indexä½ç½®çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="function">Node&lt;E&gt; <span class="title">node</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert isElementIndex(index);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &lt; (size &gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">        Node&lt;E&gt; x = first;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">            x = x.next;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;E&gt; x = last;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = size - <span class="number">1</span>; i &gt; index; i--)</span><br><span class="line">            x = x.prev;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œsetæ–¹æ³•ä¹Ÿéœ€è¦é€šè¿‡éå†æŸ¥æ‰¾ç›®æ ‡èŠ‚ç‚¹ã€‚</p><h4 id="remove-int-index-1"><a href="#remove-int-index-1" class="headerlink" title="remove(int index)"></a>remove(int index)</h4><p><code>remove(int index)</code>åˆ é™¤æŒ‡å®šä¸‹æ ‡èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    <span class="keyword">return</span> unlink(node(index));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">E <span class="title">unlink</span><span class="params">(Node&lt;E&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert x != null;</span></span><br><span class="line">    <span class="keyword">final</span> E element = x.item;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; next = x.next;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; prev = x.prev;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev == <span class="keyword">null</span>) &#123;</span><br><span class="line">        first = next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        prev.next = next;</span><br><span class="line">        x.prev = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</span><br><span class="line">        last = prev;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next.prev = prev;</span><br><span class="line">        x.next = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    x.item = <span class="keyword">null</span>;</span><br><span class="line">    size--;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>remove(int index)</code>é€šè¿‡nodeæ–¹æ³•æ‰¾åˆ°éœ€è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨unlinkæ–¹æ³•æ”¹å˜åˆ é™¤èŠ‚ç‚¹çš„prevå’ŒnextèŠ‚ç‚¹çš„å‰ç»§å’Œåç»§èŠ‚ç‚¹ã€‚</p><blockquote><p>å‰©ä¸‹çš„æ–¹æ³•å¯ä»¥è‡ªå·±é˜…è¯»æºç ã€‚</p></blockquote><h2 id="RandomAccessæ¥å£"><a href="#RandomAccessæ¥å£" class="headerlink" title="RandomAccessæ¥å£"></a>RandomAccessæ¥å£</h2><p>RandomAccessæ¥å£æ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œä¸åŒ…å«ä»»ä½•æ–¹æ³•ï¼Œåªæ˜¯ä½œä¸ºä¸€ä¸ªæ ‡è¯†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RandomAccess</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å®ç°è¯¥æ¥å£çš„ç±»è¯´æ˜å…¶æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®ï¼Œæ¯”å¦‚ArrayListå®ç°äº†è¯¥æ¥å£ï¼Œè¯´æ˜ArrayListæ”¯æŒå¿«é€Ÿéšæœºè®¿é—®ã€‚æ‰€è°“å¿«é€Ÿéšæœºè®¿é—®æŒ‡çš„æ˜¯é€šè¿‡å…ƒç´ çš„ä¸‹æ ‡å³å¯å¿«é€Ÿè·å–å…ƒç´ å¯¹è±¡ï¼Œæ— éœ€éå†ï¼Œè€ŒLinkedListåˆ™æ²¡æœ‰è¿™ä¸ªç‰¹æ€§ï¼Œå…ƒç´ è·å–å¿…é¡»éå†é“¾è¡¨ã€‚</p><p>åœ¨Collectionsç±»çš„<code>binarySearch(List&lt;? extends Comparable&lt;? super T&gt;&gt; list, T key)</code>æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°RandomAccessçš„åº”ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binarySearch</span><span class="params">(List&lt;? extends Comparable&lt;? <span class="keyword">super</span> T&gt;&gt; list, T key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (list <span class="keyword">instanceof</span> RandomAccess || list.size()&lt;BINARYSEARCH_THRESHOLD)</span><br><span class="line">        <span class="keyword">return</span> Collections.indexedBinarySearch(list, key);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> Collections.iteratorBinarySearch(list, key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å½“listå®ç°äº†RandomAccessæ¥å£æ—¶ï¼Œè°ƒç”¨indexedBinarySearchæ–¹æ³•ï¼Œå¦åˆ™è°ƒç”¨iteratorBinarySearchã€‚æ‰€ä»¥å½“æˆ‘ä»¬éå†é›†åˆæ—¶ï¼Œå¦‚æœé›†åˆå®ç°äº†RandomAccessæ¥å£ï¼Œä¼˜å…ˆé€‰æ‹©æ™®é€šforå¾ªç¯ï¼Œå…¶æ¬¡foreachï¼›éå†æœªå®ç°RandomAccessçš„æ¥å£ï¼Œä¼˜å…ˆé€‰æ‹©iteratoréå†ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:20 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;æœ¬æ–‡è®°å½•ArrayList &amp;amp; LinkedListæºç è§£æï¼ŒåŸºäºJDK1.8ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£Springå¾ªç¯ä¾èµ–</title>
    <link href="http://mrbird.cc/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Spring%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96.html"/>
    <id>http://mrbird.cc/æ·±å…¥ç†è§£Springå¾ªç¯ä¾èµ–.html</id>
    <published>2020-07-25T07:50:27.000Z</published>
    <updated>2021-01-31T02:24:19.987Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --><p>æ‰€è°“å¾ªç¯ä¾èµ–æŒ‡çš„æ˜¯ï¼šBeanAå¯¹è±¡çš„åˆ›å»ºä¾èµ–äºBeanBï¼ŒBeanBå¯¹è±¡çš„åˆ›å»ºä¹Ÿä¾èµ–äºBeanAï¼Œè¿™å°±é€ æˆäº†æ­»å¾ªç¯ï¼Œå¦‚æœä¸åšå¤„ç†çš„è¯åŠ¿å¿…ä¼šé€ æˆæ ˆæº¢å‡ºã€‚Springé€šè¿‡æå‰æ›å…‰æœºåˆ¶ï¼Œåˆ©ç”¨ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚æœ¬èŠ‚å°†è®°å½•å•å®ä¾‹Beançš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¹¶ä¸”ä»…è®°å½•ä¸¤ç§å¸¸è§çš„å¾ªç¯ä¾èµ–æƒ…å†µï¼šæ™®é€šBeanä¸æ™®é€šBeanä¹‹é—´çš„å¾ªç¯ä¾èµ–ï¼Œæ™®é€šBeanä¸ä»£ç†Beanä¹‹é—´çš„å¾ªç¯ä¾èµ–ã€‚</p><a id="more"></a><h2 id="Beanåˆ›å»ºæºç "><a href="#Beanåˆ›å»ºæºç " class="headerlink" title="Beanåˆ›å»ºæºç "></a>Beanåˆ›å»ºæºç </h2><p>æˆ‘ä»¬å…ˆé€šè¿‡æºç ç†Ÿæ‚‰ä¸‹Beanåˆ›å»ºè¿‡ç¨‹ï¼ˆæºç ä»…è´´å‡ºç›¸å…³éƒ¨åˆ†ï¼‰ã€‚</p><p>IOCå®¹å™¨è·å–Beançš„å…¥å£ä¸ºAbstractBeanFactoryç±»çš„getBeanæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBeanFactory</span> <span class="keyword">extends</span> <span class="title">FactoryBeanRegistrySupport</span> <span class="keyword">implements</span> <span class="title">ConfigurableBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> doGetBean(name, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªç©ºå£³æ–¹æ³•ï¼Œå…·ä½“é€»è¾‘éƒ½åœ¨doGetBeanæ–¹æ³•å†…ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBeanFactory</span> <span class="keyword">extends</span> <span class="title">FactoryBeanRegistrySupport</span> <span class="keyword">implements</span> <span class="title">ConfigurableBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object[] args, <span class="keyword">boolean</span> typeCheckOnly)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–Beanåç§°</span></span><br><span class="line">        String beanName = transformedBeanName(name);</span><br><span class="line">        Object bean;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–ç›®æ ‡Beanå®ä¾‹</span></span><br><span class="line">        Object sharedInstance = getSingleton(beanName);</span><br><span class="line">        <span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¸ä¸ºç©ºï¼Œåˆ™è¿›è¡Œåç»­å¤„ç†å¹¶è¿”å›</span></span><br><span class="line">            bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ......</span><br><span class="line">                RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">                ......</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä»ä¸‰çº§ç¼“å­˜ä¸­æ²¡æœ‰è·å–åˆ°Beanå®ä¾‹ï¼Œå¹¶ä¸”ç›®æ ‡Beanæ˜¯å•å®ä¾‹Beançš„è¯</span></span><br><span class="line">                <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// é€šè¿‡getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory)æ–¹æ³•åˆ›å»ºBeanå®ä¾‹</span></span><br><span class="line">                    sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">// åˆ›å»ºBeanå®ä¾‹</span></span><br><span class="line">                            <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                            ......</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="comment">// åç»­å¤„ç†ï¼Œå¹¶è¿”å›</span></span><br><span class="line">                    bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> (T) bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>doGetBeanæ–¹æ³•ä¸­å…ˆé€šè¿‡getSingleton(String beanName)æ–¹æ³•ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–Beanå®ä¾‹ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™è¿›è¡Œåç»­å¤„ç†ï¼›å¦‚æœä¸ºç©ºï¼Œåˆ™é€šè¿‡getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory)æ–¹æ³•åˆ›å»ºBeanå®ä¾‹å¹¶è¿›è¡Œåç»­å¤„ç†ã€‚</p><p>è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯AbstractBeanFactoryçˆ¶ç±»DefaultSingletonBeanRegistryçš„æ–¹æ³•ï¼ŒAbstractBeanFactoryå±‚çº§å…³ç³»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20210128-160315@2x.png" alt="QQ20210128-160315@2x"></p><p>getSingleton(String beanName)ç›¸å…³æºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSingletonBeanRegistry</span> <span class="keyword">extends</span> <span class="title">SimpleAliasRegistry</span> <span class="keyword">implements</span> <span class="title">SingletonBeanRegistry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSingleton(beanName, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä»ä¸€çº§ç¼“å­˜ä¸­è·å–ç›®æ ‡Beanå®ä¾‹</span></span><br><span class="line">        Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">        <span class="comment">// å¦‚æœä»ä¸€çº§ç¼“å­˜ä¸­æ²¡æœ‰è·å–åˆ°ï¼Œå¹¶ä¸”è¯¥Beanå¤„äºæ­£åœ¨åˆ›å»ºä¸­çš„çŠ¶æ€æ—¶</span></span><br><span class="line">        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">            <span class="comment">// ä»äºŒçº§ç¼“å­˜è·å–ç›®æ ‡Beanå®ä¾‹</span></span><br><span class="line">            singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œå¹¶ä¸”å…è®¸æå‰æ›å…‰çš„è¯</span></span><br><span class="line">            <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">                    <span class="comment">// åœ¨é”å†…é‡æ–°ä»ä¸€çº§ç¼“å­˜ä¸­å¾€ä¸‹æŸ¥æ‰¾</span></span><br><span class="line">                    singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">                    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">                        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// ä»ä¸‰çº§ç¼“å­˜ä¸­å–å‡ºç›®æ ‡Beanå·¥å‚å¯¹è±¡</span></span><br><span class="line">                            ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                            <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// å·¥å‚å¯¹è±¡ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡è°ƒç”¨getObjectæ–¹æ³•å®ä¾‹åŒ–Beanå®ä¾‹</span></span><br><span class="line">                                singletonObject = singletonFactory.getObject();</span><br><span class="line">                                <span class="comment">// æ”¾åˆ°äºŒçº§ç¼“å­˜ä¸­</span></span><br><span class="line">                                <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                                <span class="comment">// åˆ é™¤å¯¹åº”çš„ä¸‰çº§ç¼“å­˜</span></span><br><span class="line">                                <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singletonObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p></p><p>æ‰€è°“çš„ä¸‰çº§ç¼“å­˜æŒ‡çš„æ˜¯DefaultSingletonBeanRegistryç±»çš„ä¸‰ä¸ªæˆå‘˜å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSingletonBeanRegistry</span> <span class="keyword">extends</span> <span class="title">SimpleAliasRegistry</span> <span class="keyword">implements</span> <span class="title">SingletonBeanRegistry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Cache of singleton objects: bean name to bean instance. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Cache of singleton factories: bean name to ObjectFactory. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Cache of early singleton objects: bean name to bean instance. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><table><thead><tr><th>å˜é‡</th><th>æè¿°</th></tr></thead><tbody><tr><td>singletonObjects</td><td>ä¸€çº§ç¼“å­˜ï¼Œkeyä¸ºBeanåç§°ï¼Œvalueä¸ºBeanå®ä¾‹ã€‚è¿™é‡Œçš„Beanå®ä¾‹æŒ‡çš„æ˜¯å·²ç»å®Œå…¨åˆ›å»ºå¥½çš„ï¼Œå³å·²ç»ç»å†å®ä¾‹åŒ–-&gt;å±æ€§å¡«å……-&gt;åˆå§‹åŒ–ä»¥åŠå„ç§åç½®å¤„ç†è¿‡ç¨‹çš„Beanï¼Œå¯ç›´æ¥ä½¿ç”¨ã€‚</td></tr><tr><td>earlySingletonObjects</td><td>äºŒçº§ç¼“å­˜ï¼Œkeyä¸ºBeanåç§°ï¼Œvalueä¸ºBeanå®ä¾‹ã€‚è¿™é‡Œçš„Beanå®ä¾‹æŒ‡çš„æ˜¯ä»…å®Œæˆå®ä¾‹åŒ–çš„Beanï¼Œè¿˜æœªè¿›è¡Œå±æ€§å¡«å……ç­‰åç»­æ“ä½œã€‚ç”¨äºæå‰æ›å…‰ï¼Œä¾›åˆ«çš„Beanå¼•ç”¨ï¼Œè§£å†³å¾ªç¯ä¾èµ–ã€‚</td></tr><tr><td>singletonFactories</td><td>ä¸‰çº§ç¼“å­˜ï¼Œkeyä¸ºBeanåç§°ï¼Œvalueä¸ºBeanå·¥å‚ã€‚åœ¨Beanå®ä¾‹åŒ–åï¼Œå±æ€§å¡«å……ä¹‹å‰ï¼Œå¦‚æœå…è®¸æå‰æ›å…‰ï¼ŒSpringä¼šæŠŠè¯¥Beanè½¬æ¢æˆBeanå·¥å‚å¹¶åŠ å…¥åˆ°ä¸‰çº§ç¼“å­˜ã€‚åœ¨éœ€è¦å¼•ç”¨æå‰æ›å…‰å¯¹è±¡æ—¶å†é€šè¿‡å·¥å‚å¯¹è±¡çš„getObject()æ–¹æ³•è·å–ã€‚</td></tr></tbody></table><p>å¦‚æœé€šè¿‡ä¸‰çº§ç¼“å­˜çš„æŸ¥æ‰¾éƒ½æ²¡æœ‰æ‰¾åˆ°ç›®æ ‡Beanå®ä¾‹ï¼Œåˆ™é€šè¿‡getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory)æ–¹æ³•åˆ›å»ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSingletonBeanRegistry</span> <span class="keyword">extends</span> <span class="title">SimpleAliasRegistry</span> <span class="keyword">implements</span> <span class="title">SingletonBeanRegistry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">            <span class="comment">// ä»ä¸€çº§ç¼“å­˜è·å–</span></span><br><span class="line">            Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">            <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// ä¸ºç©ºåˆ™ç»§ç»­</span></span><br><span class="line">                ......</span><br><span class="line">                <span class="comment">// æ–¹æ³•å†…ä¼šå°†å½“å‰Beanåç§°æ·»åŠ åˆ°æ­£åœ¨åˆ›å»ºBeançš„é›†åˆï¼ˆsingletonsCurrentlyInCreationï¼‰ä¸­</span></span><br><span class="line">                beforeSingletonCreation(beanName);</span><br><span class="line">                <span class="keyword">boolean</span> newSingleton = <span class="keyword">false</span>;</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// é€šè¿‡å‡½æ•°å¼æ¥å£åˆ›å»ºBeanå®ä¾‹ï¼Œè¯¥å®ä¾‹å·²ç»ç»å†å®ä¾‹åŒ–-&gt;å±æ€§å¡«å……-&gt;åˆå§‹åŒ–ä»¥åŠå„ç§åç½®å¤„ç†è¿‡ç¨‹ï¼Œå¯ç›´æ¥ä½¿ç”¨</span></span><br><span class="line">                    singletonObject = singletonFactory.getObject();</span><br><span class="line">                    newSingleton = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">                   ......</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">finally</span> &#123;</span><br><span class="line">                    ......</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (newSingleton) &#123;</span><br><span class="line">                    <span class="comment">// æ·»åŠ åˆ°ç¼“å­˜ä¸­</span></span><br><span class="line">                    addSingleton(beanName, singletonObject);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> singletonObject;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingleton</span><span class="params">(String beanName, Object singletonObject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">            <span class="comment">// æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜</span></span><br><span class="line">            <span class="keyword">this</span>.singletonObjects.put(beanName, singletonObject);</span><br><span class="line">            <span class="comment">// åˆ é™¤å¯¹åº”çš„äºŒä¸‰çº§ç¼“å­˜</span></span><br><span class="line">            <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">            <span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">            <span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šè¿°ä»£ç é‡ç‚¹å…³æ³¨singletonFactory.getObject()ï¼ŒsingletonFactoryæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œå¯¹åº”AbstractBeanFactoryçš„doGetBeanæ–¹æ³•ä¸­çš„lambdaè¡¨è¾¾å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºBeanå®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p>é‡ç‚¹å…³æ³¨createBeanæ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œç”±AbstractBeanFactoryå­ç±»AbstractAutowireCapableBeanFactoryå®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title">AbstractBeanFactory</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">AutowireCapableBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºBeanå®ä¾‹</span></span><br><span class="line">            Object beanInstance = doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">            <span class="keyword">return</span> beanInstance;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>doCreateBeanæºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title">AbstractBeanFactory</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">AutowireCapableBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        BeanWrapper instanceWrapper = <span class="keyword">null</span>;</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–Bean</span></span><br><span class="line">        <span class="keyword">if</span> (instanceWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">        &#125;</span><br><span class="line">        Object bean = instanceWrapper.getWrappedInstance();</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mbd.postProcessed) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// æ‰§è¡ŒMergedBeanDefinitionPostProcessorç±»å‹åç½®å¤„ç†å™¨</span></span><br><span class="line">                    applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                    ......</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥Beanæ˜¯å•ä¾‹ï¼Œå¹¶ä¸”allowCircularReferenceså±æ€§ä¸ºtrueï¼ˆæ ‡è¯†å…è®¸å¾ªç¯ä¾èµ–çš„å‡ºç°ï¼‰ä»¥åŠè¯¥Beanæ­£åœ¨åˆ›å»ºä¸­</span></span><br><span class="line">        <span class="comment">// çš„è¯ï¼ŒearlySingletonExposureå°±ä¸ºtrueï¼Œæ ‡è¯†å…è®¸å•å®ä¾‹Beanæå‰æš´éœ²åŸå§‹å¯¹è±¡å¼•ç”¨ï¼ˆä»…å®ä¾‹åŒ–ï¼‰</span></span><br><span class="line">        <span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">                isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">        <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">            <span class="comment">// æ·»åŠ åˆ°å•å®ä¾‹å·¥å‚é›†åˆä¸­ï¼Œå³ä¸‰çº§ç¼“å­˜å¯¹è±¡ï¼Œè¯¥æ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°ç±»å‹ä¸ºObjectFactory&lt;?&gt; singletonFactoryï¼Œ</span></span><br><span class="line">            <span class="comment">// å‰é¢æåˆ°è¿‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œè¿™é‡Œç”¨lambdaè¡¨è¾¾å¼() -&gt; getEarlyBeanReference(beanName, mbd, bean)è¡¨ç¤º</span></span><br><span class="line">            addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object exposedObject = bean;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å±æ€§èµ‹å€¼æ“ä½œ</span></span><br><span class="line">            populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–Beanï¼ˆåˆå§‹åŒ–æ“ä½œä¸»è¦åŒ…æ‹¬xxxxAwareæ³¨å…¥ï¼ŒBeanPostProcessoråç½®å¤„ç†å™¨æ–¹æ³•è°ƒç”¨ä»¥</span></span><br><span class="line">            <span class="comment">// åŠInitializingBeanæ¥å£æ–¹æ³•è°ƒç”¨ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±æŸ¥çœ‹æºç ï¼‰</span></span><br><span class="line">            exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœearlySingletonExposureä¸ºtrue</span></span><br><span class="line">        <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">            <span class="comment">// ç¬¬äºŒä¸ªå‚æ•°ä¸ºfalseè¡¨ç¤ºä»…ä»ä¸€çº§å’ŒäºŒçº§ç¼“å­˜ä¸­è·å–Beanå®ä¾‹</span></span><br><span class="line">            Object earlySingletonReference = getSingleton(beanName, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (earlySingletonReference != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (exposedObject == bean) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœä»ä¸€çº§å’ŒäºŒçº§ç¼“å­˜ä¸­è·å–Beanå®ä¾‹ä¸ä¸ºç©ºï¼Œå¹¶ä¸”exposedObject == beançš„è¯ï¼Œ</span></span><br><span class="line">                    <span class="comment">// å°†earlySingletonReferenceèµ‹å€¼ç»™exposedObjectè¿”å›</span></span><br><span class="line">                    exposedObject = earlySingletonReference;</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// è¿”å›æœ€ç»ˆBeanå®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> exposedObject;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">getEarlyBeanReference</span><span class="params">(String beanName, RootBeanDefinition mbd, Object bean)</span> </span>&#123;</span><br><span class="line">        Object exposedObject = bean;</span><br><span class="line">        <span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="comment">// SmartInstantiationAwareBeanPostProcessorç±»å‹åç½®å¤„ç†ï¼Œå¸¸è§çš„åœºæ™¯ä¸ºAOPä»£ç†</span></span><br><span class="line">            <span class="keyword">for</span> (SmartInstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().smartInstantiationAware) &#123;</span><br><span class="line">                exposedObject = bp.getEarlyBeanReference(exposedObject, beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> exposedObject;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>addSingletonFactoryæ–¹æ³•ä¸ºçˆ¶ç±»DefaultSingletonBeanRegistryçš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSingletonBeanRegistry</span> <span class="keyword">extends</span> <span class="title">SimpleAliasRegistry</span> <span class="keyword">implements</span> <span class="title">SingletonBeanRegistry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingletonFactory</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">            <span class="comment">// ä¸€çº§ç¼“å­˜æ²¡æœ‰ç›®æ ‡Beanå®ä¾‹çš„è¯ï¼Œæ·»åŠ ä¸‰çº§ç¼“å­˜</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.singletonObjects.containsKey(beanName)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.singletonFactories.put(beanName, singletonFactory);</span><br><span class="line">                <span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">                <span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šè¿°æ•´ä¸ªè¿‡ç¨‹å¯ä»¥ç”¨ä¸‹å›¾æ¥æ€»ç»“ï¼ˆå¯å³é”®é€‰æ‹©æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å›¾ç‰‡ï¼‰ï¼š</p><p><img src="img/getBean.svg" alt="getBean.svg"></p><p>å…‰çœ‹æºç æœ‰ç‚¹æŠ½è±¡ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸¤ä¸ªåœºæ™¯æ¥åŠ æ·±ç†è§£ã€‚</p><h2 id="æ™®é€šBeanä¸æ™®é€šBean"><a href="#æ™®é€šBeanä¸æ™®é€šBean" class="headerlink" title="æ™®é€šBeanä¸æ™®é€šBean"></a>æ™®é€šBeanä¸æ™®é€šBean</h2><p>é¦–å…ˆæ¨¡æ‹Ÿæ™®é€šSpring Beanä¸æ™®é€šSpring Beanä¹‹é—´å¾ªç¯ä¾èµ–çš„åœºæ™¯ã€‚</p><p>æ–°å»ºSpringBooté¡¹ç›®ï¼Œpomå¼•å…¥å¦‚ä¸‹ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºCircularReferenceTestç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularReferenceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(BeanA.class, BeanB.class);</span><br><span class="line">        BeanA beanA = context.getBean(BeanA.class);</span><br><span class="line">        BeanB beanB = context.getBean(BeanB.class);</span><br><span class="line">        BeanB beanBInBeanA = beanA.getBeanB();</span><br><span class="line">        BeanA beanAInBeanB = beanB.getBeanA();</span><br><span class="line">        System.out.println(beanA);</span><br><span class="line">        System.out.println(beanB);</span><br><span class="line">        System.out.println(beanB == beanBInBeanA);</span><br><span class="line">        System.out.println(beanA == beanAInBeanB);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeanA</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BeanB beanB;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BeanB <span class="title">getBeanB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beanB;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanB</span><span class="params">(BeanB beanB)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanB = beanB;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeanB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BeanA beanA;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BeanA <span class="title">getBeanA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beanA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanA</span><span class="params">(BeanA beanA)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanA = beanA;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç é€šè¿‡AnnotationConfigApplicationContextåˆ›å»ºäº†IOCå®¹å™¨ï¼Œå¹¶å…ˆåæ³¨å†Œäº†BeanAå’ŒBeanBï¼ŒBeanAå’ŒBeanBç›¸äº’ä¾èµ–ï¼Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cc.mrbird.BeanA@368f2016</span><br><span class="line">cc.mrbird.BeanB@6f03482</span><br><span class="line">true</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒSpringæˆåŠŸè§£å†³äº†å¾ªç¯ä¾èµ–ã€‚ä¸‹é¢é…åˆæºç æ¥åˆ†æè¿™ä¸ªè¿‡ç¨‹ã€‚</p><p>ä¸Šé¢ç¨‹åºä¸­ï¼Œå…ˆåˆ›å»ºBeanAï¼ŒSpringå†…éƒ¨è°ƒç”¨doGetBeanæ–¹æ³•è·å–BeanAã€‚ä¸€å¼€å§‹ä¸‰çº§ç¼“å­˜ä¸­è‚¯å®šæ²¡æœ‰BeanAå’ŒBeanBç›¸å…³å®ä¾‹ï¼š</p><p><img src="img/2021å¹´01æœˆ29æ—¥09-54-54.png" alt="2021å¹´01æœˆ29æ—¥09-54-54"></p><p><img src="img/QQ20210129-095639@2x.png" alt="QQ20210129-095639@2x"></p><p><img src="img/QQ20210129-095708@2x.png" alt="QQ20210129-095708@2x"></p><p>æ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹doCreateBeanç›¸å…³æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title">AbstractBeanFactory</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">AutowireCapableBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        BeanWrapper instanceWrapper = <span class="keyword">null</span>;</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–BeanAï¼ŒBeanAçš„æ—©æœŸå¯¹è±¡ï¼Œå±æ€§è¿˜æœªèµ‹å€¼ï¼Œè¿˜æœªè¿›è¡Œåç½®å¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (instanceWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">        &#125;</span><br><span class="line">        Object bean = instanceWrapper.getWrappedInstance();</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// BeanAæ˜¯å•ä¾‹å¯¹è±¡ï¼Œå¹¶ä¸”allowCircularReferencesä¸ºtrueï¼ŒBeanAæ­£åœ¨åˆ›å»ºä¸­ï¼Œæ‰€ä»¥</span></span><br><span class="line">        <span class="comment">// æœ€ç»ˆearlySingletonExposureä¸ºtrue</span></span><br><span class="line">        <span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">                isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">        <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">            <span class="comment">// å°†BeanAæ—©æœŸå¯¹è±¡ä¼ é€’ç»™Beanå·¥å‚ï¼Œå¹¶æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜ä¸­</span></span><br><span class="line">            addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object exposedObject = bean;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å±æ€§èµ‹å€¼æ“ä½œ</span></span><br><span class="line">            populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ï¼ŒSpringå®ä¾‹åŒ–äº†BeanAï¼Œç„¶åå¾€ä¸‰çº§ç¼“å­˜ä¸­æ·»åŠ äº†BeanAçš„å·¥å‚å¯¹è±¡ï¼Œæ ¹æ®å‰é¢getEarlyBeanReferenceæ–¹æ³•çš„æºç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œåœ¨ä¸å­˜åœ¨AOPä»£ç†çš„æƒ…å†µä¸‹ï¼Œè¯¥æ–¹æ³•ç›´æ¥è¿”å›åŸå§‹BeanAå¯¹è±¡ã€‚æ‰€ä»¥é€šè¿‡è¯¥å·¥å‚æ–¹æ³•åˆ›å»ºçš„BeanAå¯¹è±¡ä»…ä»…æ˜¯è¿›è¡Œäº†å®ä¾‹åŒ–æ“ä½œï¼Œå±æ€§è¿˜æœªè¢«èµ‹å€¼ï¼Œæ¢å¥è¯è¯´ï¼Œè¯¥å·¥å‚ç”¨äºæå‰æ›å…‰BeanAå®ä¾‹ã€‚</p><p>æ¥ç€è°ƒç”¨populateBeanæ–¹æ³•å¯¹BeanAå±æ€§èµ‹å€¼ï¼Œèµ‹å€¼è¿‡ç¨‹å‘ç°BeanAä¾èµ–äºBeanBï¼Œæ‰€ä»¥Springé‡å¤ä»¥ä¸Šæ­¥éª¤åˆ›å»ºBeanBã€‚åˆ›å»ºè¿‡ç¨‹ä¸­åŒæ ·ä¼šé‡åˆ°populateBeanæ–¹æ³•å¯¹BeanBå±æ€§èµ‹å€¼ï¼Œèµ‹å€¼è¿‡ç¨‹ä¸­å‘ç°BeanBä¾èµ–äºBeanAï¼Œäºæ˜¯Springåˆå›å¤´åˆ›å»ºBeanAï¼Œä¸è¿‡è¿™æ—¶å€™æƒ…å†µå°±å¼€å§‹ä¸ä¸€æ ·äº†ï¼ï¼</p><p>doGetBeanæ–¹æ³•å†…éƒ¨ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–BeanAå¯¹è±¡æ—¶ï¼Œä¸‰çº§ç¼“å­˜å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="img/2021å¹´01æœˆ29æ—¥15-08-41.png" alt="2021å¹´01æœˆ29æ—¥15-08-41"></p><p><img src="img/QQ20210129-150926@2x.png" alt="QQ20210129-150926@2x"></p><p><img src="img/2021å¹´01æœˆ29æ—¥15-10-15.png" alt="2021å¹´01æœˆ29æ—¥15-10-15"></p><p>å¯ä»¥çœ‹åˆ°ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜æ²¡æœ‰ä»€ä¹ˆä¸ä¸€æ ·ï¼Œä½†ä¸‰çº§ç¼“å­˜ä¸­å·²ç»å­˜åœ¨BeanAå’ŒBeanBçš„å·¥å‚å¯¹è±¡äº†ï¼</p><p>æ‰€ä»¥æ­¤æ—¶getSingleton(String beanName, boolean allowEarlyReference)æ–¹æ³•å†…çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSingletonBeanRegistry</span> <span class="keyword">extends</span> <span class="title">SimpleAliasRegistry</span> <span class="keyword">implements</span> <span class="title">SingletonBeanRegistry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">        Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">        <span class="comment">// ä¸€çº§ç¼“å­˜ä¸­æ²¡æœ‰BeanAï¼Œå¹¶ä¸”BeanAæ­£åœ¨åˆ›å»ºä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">            singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">            <span class="comment">// äºŒçº§ç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰BeanA</span></span><br><span class="line">            <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">                    <span class="comment">// åœ¨é”å†…é‡æ–°ä»ä¸€çº§ç¼“å­˜ä¸­å¾€ä¸‹æŸ¥æ‰¾</span></span><br><span class="line">                    singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">                    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">                        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// ä»ä¸‰çº§ç¼“å­˜ä¸­å–å‡ºç›®æ ‡BeanAçš„å·¥å‚å¯¹è±¡</span></span><br><span class="line">                            ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                            <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// å·¥å‚å¯¹è±¡ä¸ä¸ºç©ºï¼Œè°ƒç”¨getObjectæ–¹æ³•è·å–å‰é¢æå‰æ›å…‰çš„BeanAæ—©æœŸå®ä¾‹</span></span><br><span class="line">                                singletonObject = singletonFactory.getObject();</span><br><span class="line">                                <span class="comment">// å°†BeanAæ—©æœŸå®ä¾‹æ”¾åˆ°äºŒçº§ç¼“å­˜ä¸­</span></span><br><span class="line">                                <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                                <span class="comment">// åˆ é™¤å¯¹åº”çš„ä¸‰çº§ç¼“å­˜</span></span><br><span class="line">                                <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›BeanAæ—©æœŸå®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> singletonObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p></p><p>æ­¤æ—¶æŸ¥çœ‹äºŒçº§ç¼“å­˜ï¼š</p><p><img src="img/2021å¹´01æœˆ29æ—¥15-15-49.png" alt="2021å¹´01æœˆ29æ—¥15-15-49"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒBeanAç¡®å®åªæ˜¯æ—©æœŸå®ä¾‹ï¼Œå±æ€§BeanBè¿˜æœªè¢«èµ‹å€¼å‘¢ã€‚</p><p>éšåBeanBåœ¨å±æ€§å¡«å……çš„æ—¶å€™è·å–åˆ°äº†BeanAæ—©æœŸå®ä¾‹ï¼Œå®Œæˆå±æ€§å¡«å……ã€åˆå§‹åŒ–ç­‰åç»­æ“ä½œï¼ŒBeanBåˆ›å»ºå®Œæ¯•ã€‚BeanBå®Œæ•´åˆ›å»ºå®Œæ¯•åï¼ŒBeanAéšä¹‹ä¹Ÿå®Œæˆå±æ€§å¡«å……ã€åˆå§‹åŒ–ç­‰åç»­æ“ä½œï¼ŒBeanAä¹Ÿåˆ›å»ºå®Œæ¯•ï¼Œå¾ªç¯ä¾èµ–å¾—ä»¥è§£å†³ã€‚</p><p>BeanBè™½ç„¶è·å–åˆ°çš„æ˜¯BeanAçš„æ—©æœŸå¯¹è±¡ï¼Œä½†å½“BeanAå®Œæ•´åˆ›å»ºå®Œæ¯•åï¼ŒBeanBé‡Œçš„BeanAä¹Ÿå°†ä¼šæ˜¯å®Œæ•´çš„ï¼Œå› ä¸ºæŒ‡é’ˆæŒ‡å‘çš„éƒ½æ˜¯åŒä¸€ä¸ªBeanAåœ°å€ã€‚</p><p>ç”»ä¸ªå›¾æ€»ç»“ä¸Šé¢çš„è¿‡ç¨‹ï¼ˆå¯å³é”®é€‰æ‹©æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å›¾ç‰‡ï¼‰ï¼š</p><p><img src="img/20210129155555.svg" alt="20210129155555.svg"></p><h2 id="æ™®é€šBeanä¸ä»£ç†Bean"><a href="#æ™®é€šBeanä¸ä»£ç†Bean" class="headerlink" title="æ™®é€šBeanä¸ä»£ç†Bean"></a>æ™®é€šBeanä¸ä»£ç†Bean</h2><p>æ™®é€šBeanå’Œä»£ç†Beanä¹‹é—´çš„å¾ªç¯ä¾èµ–å’Œä¸Šé¢è¿‡ç¨‹å·®ä¸å¤šï¼Œä¸è¿‡ç»†èŠ‚ä¸Šæœ‰äº›è®¸å·®å¼‚ã€‚</p><p>åˆ é™¤ä¸Šé¢åˆ›å»ºçš„CircularReferenceTestç±»ã€‚ä¸ºäº†æ¨¡æ‹ŸAOPä»£ç†çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥AOPä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>ç„¶åä¿®æ”¹Bootå…¥å£ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(MyApplication.class, args);</span><br><span class="line">        BeanA beanA = context.getBean(BeanA.class);</span><br><span class="line">        BeanB beanB = context.getBean(BeanB.class);</span><br><span class="line">        BeanB beanBInBeanA = beanA.getBeanB();</span><br><span class="line">        BeanA beanAInBeanB = beanB.getBeanA();</span><br><span class="line">        System.out.println(<span class="string">"BeanAæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡ï¼š"</span> + AopUtils.isAopProxy(beanA));</span><br><span class="line">        System.out.println(<span class="string">"BeanBæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡ï¼š"</span> + AopUtils.isAopProxy(beanB));</span><br><span class="line">        System.out.println(<span class="string">"beanAInBeanBæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡ï¼š"</span> + AopUtils.isAopProxy(beanAInBeanB));</span><br><span class="line">        System.out.println(beanB == beanBInBeanA);</span><br><span class="line">        System.out.println(beanA == beanAInBeanB);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeanA</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BeanB beanB;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BeanB <span class="title">getBeanB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beanB;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanB</span><span class="params">(BeanB beanB)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanB = beanB;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeanB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BeanA beanA;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BeanA <span class="title">getBeanA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beanA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanA</span><span class="params">(BeanA beanA)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanA = beanA;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(public * cc.mrbird.BeanA.getBeanB())"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"pointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBefore</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onBeforeï¼š"</span> + joinPoint.getSignature().getName() + <span class="string">"æ–¹æ³•å¼€å§‹æ‰§è¡Œ"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºMyAspectåˆ‡é¢ç±»çš„å­˜åœ¨ï¼ŒBeanAå°†ä¼šæ˜¯ä¸ªä»£ç†ç±»ï¼Œè€ŒBeanBåˆ™æ˜¯æ™®é€šBeanï¼Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">onBeforeï¼šgetBeanBæ–¹æ³•å¼€å§‹æ‰§è¡Œ</span><br><span class="line">BeanAæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡ï¼štrue</span><br><span class="line">BeanBæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡ï¼šfalse</span><br><span class="line">beanAInBeanBæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡ï¼štrue</span><br><span class="line">true</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p></p><p>å‡è®¾å®¹å™¨å…ˆåˆ›å»ºBeanAï¼Œè¿‡ç¨‹å’Œä¸Šé¢çš„ä¾‹å­ä¸€è‡´ï¼Œå±æ€§å¡«å……æ—¶ï¼Œå‘ç°BeanAä¾èµ–BeanBï¼Œç„¶åSpringå¼€å§‹åˆ›å»ºBeanBã€‚åˆ›å»ºBeanBæ—¶å€™åˆå‘ç°å…¶ä¾èµ–BeanAï¼Œè¿™æ—¶ä¸‰çº§ç¼“å­˜ä¸­å·²ç»å­˜åœ¨BeanAçš„å·¥å‚å¯¹è±¡äº†ï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡è¯¥å·¥å‚å¯¹è±¡è·å–BeanAçš„æ—©æœŸå®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSingletonBeanRegistry</span> <span class="keyword">extends</span> <span class="title">SimpleAliasRegistry</span> <span class="keyword">implements</span> <span class="title">SingletonBeanRegistry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">        Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">        <span class="comment">// ä¸€çº§ç¼“å­˜ä¸­æ²¡æœ‰BeanAï¼Œå¹¶ä¸”BeanAæ­£åœ¨åˆ›å»ºä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">            singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">            <span class="comment">// äºŒçº§ç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰BeanA</span></span><br><span class="line">            <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">                    <span class="comment">// åœ¨é”å†…é‡æ–°ä»ä¸€çº§ç¼“å­˜ä¸­å¾€ä¸‹æŸ¥æ‰¾</span></span><br><span class="line">                    singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">                    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">                        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// ä»ä¸‰çº§ç¼“å­˜ä¸­å–å‡ºç›®æ ‡BeanAçš„å·¥å‚å¯¹è±¡</span></span><br><span class="line">                            ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                            <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// å·¥å‚å¯¹è±¡ä¸ä¸ºç©ºï¼Œè°ƒç”¨getObjectæ–¹æ³•è·å–å‰é¢æå‰æ›å…‰çš„BeanAæ—©æœŸå®ä¾‹</span></span><br><span class="line">                                singletonObject = singletonFactory.getObject();</span><br><span class="line">                                <span class="comment">// å°†BeanAæ—©æœŸå®ä¾‹æ”¾åˆ°äºŒçº§ç¼“å­˜ä¸­</span></span><br><span class="line">                                <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                                <span class="comment">// åˆ é™¤å¯¹åº”çš„ä¸‰çº§ç¼“å­˜</span></span><br><span class="line">                                <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›BeanAæ—©æœŸå®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> singletonObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>singletonFactory.getObject()å®é™…å®ç°ä¸ºlambdaè¡¨è¾¾å¼() -&gt; getEarlyBeanReference(beanName, mbd, bean)ï¼ŒgetEarlyBeanReferenceæ–¹æ³•æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getEarlyBeanReference</span><span class="params">(String beanName, RootBeanDefinition mbd, Object bean)</span> </span>&#123;</span><br><span class="line">    Object exposedObject = bean;</span><br><span class="line">    <span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SmartInstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().smartInstantiationAware) &#123;</span><br><span class="line">            exposedObject = bp.getEarlyBeanReference(exposedObject, beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨å¼•å…¥AOPä¾èµ–åï¼Œå®¹å™¨ä¸­å°†ä¼šæœ‰ä¸€ä¸ªSmartInstantiationAwareBeanPostProcessoræ¥å£çš„å®ç°ç±»AbstractAutoProxyCreatorï¼Œç”¨äºåˆ›å»ºAOPä»£ç†ï¼Œæ‰€ä»¥ä¸Šé¢getEarlyBeanReferenceæ–¹æ³•é‡Œçš„bp.getEarlyBeanReference(exposedObject, beanName)é€»è¾‘å®é™…ä¸Šä¸ºAbstractAutoProxyCreatorå®ç°çš„getEarlyBeanReferenceæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAutoProxyCreator</span> <span class="keyword">extends</span> <span class="title">ProxyProcessorSupport</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">SmartInstantiationAwareBeanPostProcessor</span>, <span class="title">BeanFactoryAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getEarlyBeanReference</span><span class="params">(Object bean, String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç”Ÿæˆç¼“å­˜Key</span></span><br><span class="line">        Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br><span class="line">        <span class="comment">// æ”¾å…¥earlyProxyReferencesé›†åˆä¸­ï¼Œæ ‡è¯†BeanAä¸ºæ—©æœŸä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">this</span>.earlyProxyReferences.put(cacheKey, bean);</span><br><span class="line">        <span class="comment">// åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒBeanAå°†è¢«åŒ…è£…ä¸ºä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ‰€ä»¥BeanBä»ä¸‰çº§ç¼“å­˜ä¸­è·å–åˆ°çš„ä¸ºä»£ç†åçš„BeanAå®ä¾‹ï¼š</p><p><img src="img/2021å¹´01æœˆ31æ—¥09-31-16.png" alt="2021å¹´01æœˆ31æ—¥09-31-16"></p><p>BeanBåˆ›å»ºå®Œæ¯•åï¼ŒBeanAå±æ€§å¡«å……æ“ä½œéšä¹‹ç»“æŸã€‚</p><p>é€šè¿‡<a href="/æ·±å…¥ç†è§£Spring-AOPåŸç†.html">æ·±å…¥ç†è§£Spring-AOPåŸç†</a>å¯¹AOPçš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œä»£ç†å¯¹è±¡æ˜¯åœ¨åç½®å¤„ç†BeanPostProcessorçš„postProcessAfterInitializationæ–¹æ³•å†…å®Œæˆçš„ï¼Œè€Œè¯¥æ–¹æ³•çš„è°ƒç”¨æ—¶æœºä¸ºBeanå±æ€§å¡«å……åçš„åˆå§‹åŒ–æ“ä½œæ—¶ï¼Œæ‰€ä»¥åœ¨BeanAå±æ€§å¡«å……æ“ä½œç»“æŸæ—¶ï¼ŒBeanAè¿˜åªæ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œè€ŒBeanBé‡Œçš„BeanAå·²ç»æ˜¯ä»£ç†å¯¹è±¡äº†ã€‚</p><p>ç»§ç»­BeanAçš„åˆ›å»ºè¿‡ç¨‹ï¼ŒBeanAå±æ€§å¡«å……å®Œåï¼Œæ‰§è¡ŒinitializeBean(beanName, exposedObject, mbd)æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title">AbstractBeanFactory</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">AutowireCapableBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        Object exposedObject = bean;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å±æ€§èµ‹å€¼æ“ä½œ</span></span><br><span class="line">            populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">            exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨åˆå§‹åŒ–æ“ä½œé˜¶æ®µæ‰§è¡ŒåŠ¨æ€ä»£ç†çš„åç½®å¤„ç†æ–¹æ³•è¿‡ç¨‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAutoProxyCreator</span> <span class="keyword">extends</span> <span class="title">ProxyProcessorSupport</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">SmartInstantiationAwareBeanPostProcessor</span>, <span class="title">BeanFactoryAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(@Nullable Object bean, String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br><span class="line">            <span class="comment">// åœ¨BeanBå¡«å……å±æ€§æ—¶ï¼ŒBeanAå·²ç»è¢«æ”¾å…¥åˆ°earlyProxyReferencesé›†åˆä¸­äº†</span></span><br><span class="line">            <span class="comment">// æ‰€ä»¥è¯¥ifä¸æˆç«‹ï¼Œç›´æ¥è·³è¿‡ï¼Œé¿å…äºŒæ¬¡ä»£ç†</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.earlyProxyReferences.remove(cacheKey) != bean) &#123;</span><br><span class="line">                <span class="keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰€ä»¥è¿™é‡Œè¿”å›çš„è¿˜æ˜¯BeanAåŸå§‹å¯¹è±¡ï¼Œå¹¶éä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p></p><p>åˆ°è¿™é‡ŒBeanAä¾æ—§æ˜¯æ™®é€šå¯¹è±¡ï¼Œç»§ç»­æŸ¥çœ‹doCreateBeanæ–¹æ³•çš„åç»­é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title">AbstractBeanFactory</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">AutowireCapableBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// åŸå§‹BeanAèµ‹å€¼ç»™exposedObject</span></span><br><span class="line">        Object exposedObject = bean;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å±æ€§èµ‹å€¼æ“ä½œ</span></span><br><span class="line">            populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–æ“ä½œï¼Œé€šè¿‡ä¸Šé¢åˆ†æï¼Œæ­¤æ—¶è¿”å›çš„è¿˜æ˜¯åŸå§‹çš„BeanAå¯¹è±¡</span></span><br><span class="line">            exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">            <span class="comment">// ä»ç¼“å­˜ä¸­è·å–BeanAï¼Œæ­¤æ—¶äºŒçº§ç¼“å­˜ä¸­å·²ç»å­˜åœ¨BeanAçš„ä»£ç†å¯¹è±¡äº†ï¼Œæ‰€ä»¥</span></span><br><span class="line">            <span class="comment">// è¿™é‡ŒearlySingletonReferenceä¸ºBeanAçš„ä»£ç†å¯¹è±¡ï¼ˆå¦‚ä¸‹å›¾ï¼‰</span></span><br><span class="line">            Object earlySingletonReference = getSingleton(beanName, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (earlySingletonReference != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// exposedObjectå’Œbeanç›¸ç­‰ï¼Œå› ä¸ºBeanAå¹¶æœªåœ¨åˆå§‹åŒ–çš„æ—¶å€™è¢«äºŒæ¬¡ä»£ç†</span></span><br><span class="line">                <span class="keyword">if</span> (exposedObject == bean) &#123;</span><br><span class="line">                    <span class="comment">// è¿™é‡Œå°†ä»£ç†å¯¹è±¡BeanAèµ‹å€¼ç»™exposedObject</span></span><br><span class="line">                    exposedObject = earlySingletonReference;</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// æœ€ç»ˆè¿”å›çš„exposedObjectå¯¹è±¡ä¸ºä»äºŒçº§ç¼“å­˜ä¸­è·å–åˆ°çš„BeanAä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> exposedObject;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQ20210131-094307@2x.png" alt="QQ20210131-094307@2x"></p><p>åˆ°è¿™é‡Œï¼Œæ— è®ºæ˜¯BeanBé‡Œçš„BeanAï¼Œè¿˜æ˜¯IOCå®¹å™¨ä¸­çš„BeanAï¼Œéƒ½æ˜¯ä»£ç†åçš„BeanAäº†ã€‚</p><p>ç”»å¼ å›¾æ€»ç»“ä¸‹ä¸Šé¢çš„è¿‡ç¨‹ï¼ˆå¯å³é”®é€‰æ‹©æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å›¾ç‰‡ï¼‰ï¼š</p><p><img src="img/20210131100707.svg" alt="20210131100707.svg"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸Šé¢çš„ä¾‹å­éƒ½æ˜¯åŸºäºå±æ€§æ³¨å…¥çš„æƒ…å†µï¼Œå‡å¦‚å­˜åœ¨æ„é€ å™¨æ³¨å…¥æƒ…å†µä¸‹çš„å¾ªç¯ä¾èµ–ï¼ŒSpringå°†æ²¡åŠæ³•è§£å†³ã€‚è¿™æ˜¯å› ä¸ºå¯¹è±¡çš„æå‰æ›å…‰æ—¶æœºå‘ç”Ÿåœ¨å¯¹è±¡å®ä¾‹åŒ–ä¹‹åï¼Œè€Œæ„é€ å™¨æ³¨å…¥æ—¶æœºä¸ºå¯¹è±¡å®ä¾‹åŒ–æ—¶ï¼Œæ‰€ä»¥æ­¤æ—¶è¿˜æœªè¿›è¡Œæå‰æ›å…‰æ“ä½œï¼Œå¾ªç¯ä¾èµ–ä¹Ÿå°±æ²¡åŠæ³•è§£å†³äº†ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ç§æƒ…å†µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeanA</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BeanB beanB;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BeanA</span><span class="params">(BeanB beanB)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanB = beanB;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BeanB <span class="title">getBeanB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beanB;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanB</span><span class="params">(BeanB beanB)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanB = beanB;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeanB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BeanA beanA;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BeanB</span><span class="params">(BeanA beanA)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanA = beanA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BeanA <span class="title">getBeanA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beanA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanA</span><span class="params">(BeanA beanA)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanA = beanA;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºå°†æŠ›å‡ºå¦‚ä¸‹å¼‚å¸¸ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">***************************</span><br><span class="line">APPLICATION FAILED TO START</span><br><span class="line">***************************</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line"></span><br><span class="line">The dependencies of some of the beans in the application context form a cycle:</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”</span><br><span class="line">|  beanA defined in file [/Users/mrbird/idea workspace/aop-deep-learn/target/classes/cc/mrbird/BeanA.class]</span><br><span class="line">â†‘     â†“</span><br><span class="line">|  beanB defined in file [/Users/mrbird/idea workspace/aop-deep-learn/target/classes/cc/mrbird/BeanB.class]</span><br><span class="line">â””â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p></p><p>æ­¤å¤–ï¼Œè¿™é‡Œè®¨è®ºäº†æ™®é€šBeanä¸æ™®é€šBeanä¹‹é—´çš„å¾ªç¯ä¾èµ–ï¼Œä»£ç†Beanä¸æ™®é€šBeanä¹‹é—´çš„å¾ªç¯ä¾èµ–ï¼Œå®é™…æƒ…å†µè¿˜å¯èƒ½å­˜åœ¨å·¥å‚Beanä¸æ™®é€šBeanã€ä»£ç†Beanä¹‹é—´çš„å¾ªç¯ä¾èµ–ï¼Œè¿™ç§æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œæœ¬æ–‡ä¸è®¨è®ºï¼Œå› ä¸ºå°±ç†è§£Springè§£å†³å¾ªç¯ä¾èµ–çš„æ€æƒ³è€Œè¨€ï¼Œä¸Šé¢ä¸¤ç§æƒ…å†µææ¸…æ¥šäº†å°±OKäº†ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;æ‰€è°“å¾ªç¯ä¾èµ–æŒ‡çš„æ˜¯ï¼šBeanAå¯¹è±¡çš„åˆ›å»ºä¾èµ–äºBeanBï¼ŒBeanBå¯¹è±¡çš„åˆ›å»ºä¹Ÿä¾èµ–äºBeanAï¼Œè¿™å°±é€ æˆäº†æ­»å¾ªç¯ï¼Œå¦‚æœä¸åšå¤„ç†çš„è¯åŠ¿å¿…ä¼šé€ æˆæ ˆæº¢å‡ºã€‚Springé€šè¿‡æå‰æ›å…‰æœºåˆ¶ï¼Œåˆ©ç”¨ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚æœ¬èŠ‚å°†è®°å½•å•å®ä¾‹Beançš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¹¶ä¸”ä»…è®°å½•ä¸¤ç§å¸¸è§çš„å¾ªç¯ä¾èµ–æƒ…å†µï¼šæ™®é€šBeanä¸æ™®é€šBeanä¹‹é—´çš„å¾ªç¯ä¾èµ–ï¼Œæ™®é€šBeanä¸ä»£ç†Beanä¹‹é—´çš„å¾ªç¯ä¾èµ–ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring" scheme="http://mrbird.cc/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Java HashMapåº•å±‚å®ç°åŸç†</title>
    <link href="http://mrbird.cc/Java-HashMap%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html"/>
    <id>http://mrbird.cc/Java-HashMapåº•å±‚å®ç°åŸç†.html</id>
    <published>2020-07-20T02:56:38.000Z</published>
    <updated>2021-02-25T10:46:33.814Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:19 GMT+0800 (GMT+08:00) --><p>æœ¬èŠ‚ç”¨äºè®°å½•Java HashMapåº•å±‚æ•°æ®ç»“æ„ã€æ–¹æ³•å®ç°åŸç†ç­‰ï¼ŒåŸºäºJDK 1.8ã€‚</p><a id="more"></a><h2 id="åº•å±‚æ•°æ®ç»“æ„"><a href="#åº•å±‚æ•°æ®ç»“æ„" class="headerlink" title="åº•å±‚æ•°æ®ç»“æ„"></a>åº•å±‚æ•°æ®ç»“æ„</h2><p>Java HashMapåº•å±‚é‡‡ç”¨å“ˆå¸Œè¡¨ç»“æ„ï¼ˆæ•°ç»„+é“¾è¡¨ã€JDK1.8åä¸ºæ•°ç»„+é“¾è¡¨æˆ–çº¢é»‘æ ‘ï¼‰å®ç°ï¼Œç»“åˆäº†æ•°ç»„å’Œé“¾è¡¨çš„ä¼˜ç‚¹ï¼š</p><ol><li><p>æ•°ç»„ä¼˜ç‚¹ï¼šé€šè¿‡æ•°ç»„ä¸‹æ ‡å¯ä»¥å¿«é€Ÿå®ç°å¯¹æ•°ç»„å…ƒç´ çš„è®¿é—®ï¼Œæ•ˆç‡æé«˜ï¼›</p></li><li><p>é“¾è¡¨ä¼˜ç‚¹ï¼šæ’å…¥æˆ–åˆ é™¤æ•°æ®ä¸éœ€è¦ç§»åŠ¨å…ƒç´ ï¼Œåªéœ€ä¿®æ”¹èŠ‚ç‚¹å¼•ç”¨ï¼Œæ•ˆç‡æé«˜ã€‚</p></li></ol><p>HashMapå›¾ç¤ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20210106-145557@2x.png" alt="QQ20210106-145557@2x"></p><p>HashMapå†…éƒ¨ä½¿ç”¨æ•°ç»„å­˜å‚¨æ•°æ®ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ç±»å‹ä¸º<code>Node&lt;K,V&gt;</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Node&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">    Node(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.hash = hash;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>        </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>      </span>&#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> key + <span class="string">"="</span> + value; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V newValue)</span> </span>&#123;</span><br><span class="line">        V oldValue = value;</span><br><span class="line">        value = newValue;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">this</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">            Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class="line">                Objects.equals(value, e.getValue()))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>NodeåŒ…å«äº†å››ä¸ªå­—æ®µï¼šhashã€keyã€valueã€nextï¼Œå…¶ä¸­nextè¡¨ç¤ºé“¾è¡¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><p>HashMapé€šè¿‡<code>hash</code>æ–¹æ³•è®¡ç®—keyçš„å“ˆå¸Œç ï¼Œç„¶åé€šè¿‡<code>(n-1)&amp;hash</code>å…¬å¼ï¼ˆnä¸ºæ•°ç»„é•¿åº¦ï¼‰å¾—åˆ°keyåœ¨æ•°ç»„ä¸­å­˜æ”¾çš„ä¸‹æ ‡ã€‚å½“ä¸¤ä¸ªkeyåœ¨æ•°ç»„ä¸­å­˜æ”¾çš„ä¸‹æ ‡ä¸€è‡´æ—¶ï¼Œæ•°æ®å°†ä»¥é“¾è¡¨çš„æ–¹å¼å­˜å‚¨ï¼ˆå“ˆå¸Œå†²çªï¼Œå“ˆå¸Œç¢°æ’ï¼‰ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨é“¾è¡¨ä¸­æŸ¥æ‰¾æ•°æ®å¿…é¡»ä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ä¸€å±‚ä¸€å±‚å¾€ä¸‹æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(N)ï¼Œæ‰€ä»¥å½“é“¾è¡¨é•¿åº¦è¶Šæ¥è¶Šé•¿æ—¶ï¼ŒHashMapçš„æ•ˆç‡è¶Šæ¥è¶Šä½ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJDK1.8å¼€å§‹é‡‡ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„ç»“æ„æ¥å®ç°HashMapã€‚å½“é“¾è¡¨ä¸­çš„å…ƒç´ è¶…è¿‡8ä¸ªï¼ˆ<strong>TREEIFY_THRESHOLD</strong>ï¼‰å¹¶ä¸”æ•°ç»„é•¿åº¦å¤§äº64ï¼ˆ<strong>MIN_TREEIFY_CAPACITY</strong>ï¼‰æ—¶ï¼Œä¼šå°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œè½¬æ¢åæ•°æ®æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸ºO(logN)ã€‚</p><p>çº¢é»‘æ ‘çš„èŠ‚ç‚¹ä½¿ç”¨TreeNodeè¡¨ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; parent;  <span class="comment">// red-black tree links</span></span><br><span class="line">    TreeNode&lt;K,V&gt; left;</span><br><span class="line">    TreeNode&lt;K,V&gt; right;</span><br><span class="line">    TreeNode&lt;K,V&gt; prev;    <span class="comment">// needed to unlink next upon deletion</span></span><br><span class="line">    <span class="keyword">boolean</span> red;</span><br><span class="line">    TreeNode(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">super</span>(hash, key, val, next);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>HashMapåŒ…å«å‡ ä¸ªé‡è¦çš„å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°ç»„é»˜è®¤çš„åˆå§‹åŒ–é•¿åº¦16</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„æœ€å¤§å®¹é‡ï¼Œ2çš„30æ¬¡å¹‚ï¼Œå³1073741824</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é»˜è®¤åŠ è½½å› å­å€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘çš„é•¿åº¦é˜ˆå€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¢é»‘æ ‘è½¬æ¢ä¸ºé“¾è¡¨çš„é•¿åº¦é˜ˆå€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘æ—¶ï¼Œæ•°ç»„å®¹é‡å¿…é¡»å¤§äºç­‰äº64</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HashMapé‡Œé”®å€¼å¯¹ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰©å®¹é˜ˆå€¼ï¼Œè®¡ç®—æ–¹æ³•ä¸º æ•°ç»„å®¹é‡*åŠ è½½å› å­</span></span><br><span class="line"><span class="keyword">int</span> threshold;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HashMapä½¿ç”¨æ•°ç»„å­˜æ”¾æ•°æ®ï¼Œæ•°ç»„å…ƒç´ ç±»å‹ä¸ºNode&lt;K,V&gt;</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ è½½å› å­</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºå¿«é€Ÿå¤±è´¥ï¼Œç”±äºHashMapéçº¿ç¨‹å®‰å…¨ï¼Œåœ¨å¯¹HashMapè¿›è¡Œè¿­ä»£æ—¶ï¼Œå¦‚æœæœŸé—´å…¶ä»–çº¿ç¨‹çš„å‚ä¸å¯¼è‡´HashMapçš„ç»“æ„å‘ç”Ÿå˜åŒ–äº†ï¼ˆæ¯”å¦‚putï¼Œremoveç­‰æ“ä½œï¼‰ï¼Œç›´æ¥æŠ›å‡ºConcurrentModificationExceptionå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> modCount;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢è¿™äº›å­—æ®µåœ¨ä¸‹é¢æºç è§£æçš„æ—¶å€™å°¤ä¸ºé‡è¦ï¼Œå…¶ä¸­éœ€è¦ç€é‡è®¨è®ºçš„æ˜¯åŠ è½½å› å­æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆé»˜è®¤å€¼ä¸º0.75fã€‚</p><p>åŠ è½½å› å­ä¹Ÿå«æ‰©å®¹å› å­ï¼Œç”¨äºå†³å®šHashMapæ•°ç»„ä½•æ—¶è¿›è¡Œæ‰©å®¹ã€‚æ¯”å¦‚æ•°ç»„å®¹é‡ä¸º16ï¼ŒåŠ è½½å› å­ä¸º0.75ï¼Œé‚£ä¹ˆæ‰©å®¹é˜ˆå€¼ä¸º<code>16*0.75=12</code>ï¼Œå³HashMapæ•°æ®é‡å¤§äºç­‰äº12æ—¶ï¼Œæ•°ç»„å°±ä¼šè¿›è¡Œæ‰©å®¹ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ•°ç»„å®¹é‡çš„å¤§å°åœ¨åˆ›å»ºçš„æ—¶å€™å°±ç¡®å®šäº†ï¼Œæ‰€è°“çš„æ‰©å®¹æŒ‡çš„æ˜¯é‡æ–°åˆ›å»ºä¸€ä¸ªæŒ‡å®šå®¹é‡çš„æ•°ç»„ï¼Œç„¶åå°†æ—§å€¼å¤åˆ¶åˆ°æ–°çš„æ•°ç»„é‡Œã€‚æ‰©å®¹è¿™ä¸ªè¿‡ç¨‹éå¸¸è€—æ—¶ï¼Œä¼šå½±å“ç¨‹åºæ€§èƒ½ã€‚æ‰€ä»¥åŠ è½½å› å­æ˜¯åŸºäºå®¹é‡å’Œæ€§èƒ½ä¹‹é—´å¹³è¡¡çš„ç»“æœï¼š</p><ul><li>å½“åŠ è½½å› å­è¿‡å¤§æ—¶ï¼Œæ‰©å®¹é˜ˆå€¼ä¹Ÿå˜å¤§ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰©å®¹çš„é—¨æ§›æé«˜äº†ï¼Œè¿™æ ·å®¹é‡çš„å ç”¨å°±ä¼šé™ä½ã€‚ä½†è¿™æ—¶å“ˆå¸Œç¢°æ’çš„å‡ ç‡å°±ä¼šå¢åŠ ï¼Œæ•ˆç‡ä¸‹é™ï¼›</li><li>å½“åŠ è½½å› å­è¿‡å°æ—¶ï¼Œæ‰©å®¹é˜ˆå€¼å˜å°ï¼Œæ‰©å®¹é—¨æ§›é™ä½ï¼Œå®¹é‡å ç”¨å˜å¤§ã€‚è¿™æ—¶å€™å“ˆå¸Œç¢°æ’çš„å‡ ç‡ä¸‹é™ï¼Œæ•ˆç‡æé«˜ã€‚</li></ul><p>å¯ä»¥çœ‹åˆ°å®¹é‡å ç”¨å’Œæ€§èƒ½æ˜¯æ­¤æ¶ˆå½¼é•¿çš„å…³ç³»ï¼Œå®ƒä»¬çš„å¹³è¡¡ç‚¹ç”±åŠ è½½å› å­å†³å®šï¼Œ0.75æ˜¯ä¸€ä¸ªå³å…¼é¡¾å®¹é‡åˆå…¼é¡¾æ€§èƒ½çš„ç»éªŒå€¼ã€‚</p><p>æ­¤å¤–ç”¨äºå­˜å‚¨æ•°æ®çš„tableå­—æ®µä½¿ç”¨transientä¿®é¥°ï¼Œé€šè¿‡transientä¿®é¥°çš„å­—æ®µåœ¨åºåˆ—åŒ–çš„æ—¶å€™å°†è¢«æ’é™¤åœ¨å¤–ï¼Œé‚£ä¹ˆHashMapåœ¨åºåˆ—åŒ–åè¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œæ˜¯å¦‚ä½•æ¢å¤æ•°æ®çš„å‘¢ï¼ŸHashMapé€šè¿‡è‡ªå®šä¹‰çš„readObject/writeObjectæ–¹æ³•è‡ªå®šä¹‰åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œã€‚è¿™æ ·åšä¸»è¦æ˜¯å‡ºäºä»¥ä¸‹ä¸¤ç‚¹è€ƒè™‘ï¼š</p><ol><li>tableä¸€èˆ¬ä¸ä¼šå­˜æ»¡ï¼Œå³å®¹é‡å¤§äºå®é™…é”®å€¼å¯¹ä¸ªæ•°ï¼Œåºåˆ—åŒ–tableæœªä½¿ç”¨çš„éƒ¨åˆ†ä¸ä»…æµªè´¹æ—¶é—´ä¹Ÿæµªè´¹ç©ºé—´ï¼›</li><li>keyå¯¹åº”çš„ç±»å‹å¦‚æœæ²¡æœ‰é‡å†™hashCodeæ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒå°†è°ƒç”¨Objectçš„hashCodeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸ºnativeæ–¹æ³•ï¼Œåœ¨ä¸åŒJVMä¸‹å®ç°å¯èƒ½ä¸åŒï¼›æ¢å¥è¯è¯´ï¼ŒåŒä¸€ä¸ªé”®å€¼å¯¹åœ¨ä¸åŒçš„JVMç¯å¢ƒä¸‹ï¼Œåœ¨tableä¸­å­˜å‚¨çš„ä½ç½®å¯èƒ½ä¸åŒï¼Œé‚£ä¹ˆåœ¨ååºåˆ—åŒ–tableæ“ä½œæ—¶å¯èƒ½ä¼šå‡ºé”™ã€‚</li></ol><p>æ‰€ä»¥åœ¨HashXXXç±»ä¸­ï¼ˆå¦‚HashTableï¼ŒHashSetï¼ŒLinkedHashMapç­‰ç­‰ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™äº›ç±»ç”¨äºå­˜å‚¨æ•°æ®çš„å­—æ®µéƒ½ç”¨transientä¿®é¥°ï¼Œå¹¶ä¸”éƒ½è‡ªå®šä¹‰äº†readObject/writeObjectæ–¹æ³•ã€‚readObject/writeObjectæ–¹æ³•è¿™èŠ‚å°±ä¸è¿›è¡Œæºç åˆ†æäº†ï¼Œæœ‰å…´è¶£è‡ªå·±ç ”ç©¶ã€‚</p><h2 id="putæºç "><a href="#putæºç " class="headerlink" title="putæºç "></a>putæºç </h2><p>putæ–¹æ³•æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>putæ–¹æ³•é€šè¿‡hashå‡½æ•°è®¡ç®—keyå¯¹åº”çš„å“ˆå¸Œå€¼ï¼Œhashå‡½æ•°æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¦‚æœkeyä¸ºnullï¼Œè¿”å›0ï¼Œä¸ä¸ºnullï¼Œåˆ™é€šè¿‡<code>(h = key.hashCode()) ^ (h &gt;&gt;&gt; 16)</code>å…¬å¼è®¡ç®—å¾—åˆ°å“ˆå¸Œå€¼ã€‚è¯¥å…¬å¼é€šè¿‡hashCodeçš„é«˜16ä½å¼‚æˆ–ä½16ä½å¾—åˆ°å“ˆå¸Œå€¼ï¼Œä¸»è¦ä»æ€§èƒ½ã€å“ˆå¸Œç¢°æ’è§’åº¦è€ƒè™‘ï¼Œå‡å°‘ç³»ç»Ÿå¼€é”€ï¼Œä¸ä¼šé€ æˆå› ä¸ºé«˜ä½æ²¡æœ‰å‚ä¸ä¸‹æ ‡è®¡ç®—ä»è€Œå¼•èµ·çš„ç¢°æ’ã€‚</p><p>å¾—åˆ°keyå¯¹åº”çš„å“ˆå¸Œå€¼åï¼Œå†è°ƒç”¨<code>putVal(hash(key), key, value, false, true)</code>æ–¹æ³•æ’å…¥å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="comment">// å¦‚æœæ•°ç»„(å“ˆå¸Œè¡¨)ä¸ºnullæˆ–è€…é•¿åº¦ä¸º0ï¼Œåˆ™è¿›è¡Œæ•°ç»„åˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">// æ ¹æ®keyçš„å“ˆå¸Œå€¼è®¡ç®—å‡ºæ•°æ®æ’å…¥æ•°ç»„çš„ä¸‹æ ‡ä½ç½®ï¼Œå…¬å¼ä¸º(n-1)&amp;hash</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥ä¸‹æ ‡ä½ç½®è¿˜æ²¡æœ‰å…ƒç´ ï¼Œåˆ™ç›´æ¥åˆ›å»ºNodeå¯¹è±¡ï¼Œå¹¶æ’å…¥</span></span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="comment">// å¦‚æœç›®æ ‡ä½ç½®keyå·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¦†ç›–</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="comment">// å¦‚æœç›®æ ‡ä½ç½®keyä¸å­˜åœ¨ï¼Œå¹¶ä¸”èŠ‚ç‚¹ä¸ºçº¢é»‘æ ‘ï¼Œåˆ™æ’å…¥çº¢é»‘æ ‘ä¸­</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦åˆ™ä¸ºé“¾è¡¨ç»“æ„ï¼Œéå†é“¾è¡¨ï¼Œå°¾éƒ¨æ’å…¥</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">// å¦‚æœé“¾è¡¨é•¿åº¦å¤§äºç­‰äºTREEIFY_THRESHOLDï¼Œåˆ™è€ƒè™‘è½¬æ¢ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash); <span class="comment">// è½¬æ¢ä¸ºçº¢é»‘æ ‘æ“ä½œï¼Œå†…éƒ¨è¿˜ä¼šåˆ¤æ–­æ•°ç»„é•¿åº¦æ˜¯å¦å°äºMIN_TREEIFY_CAPACITYï¼Œå¦‚æœæ˜¯çš„è¯ä¸è½¬æ¢</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å¦‚æœé“¾è¡¨ä¸­å·²ç»å­˜åœ¨è¯¥keyçš„è¯ï¼Œç›´æ¥è¦†ç›–æ›¿æ¢</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">            <span class="comment">// è¿”å›è¢«æ›¿æ¢çš„å€¼</span></span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ¨¡æ•°é€’å¢</span></span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="comment">// å½“é”®å€¼å¯¹ä¸ªæ•°å¤§äºç­‰äºæ‰©å®¹é˜ˆå€¼çš„æ—¶å€™ï¼Œè¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>putæ“ä½œè¿‡ç¨‹æ€»ç»“ï¼š</p><ol><li>åˆ¤æ–­HashMapæ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œæ˜¯çš„è¯åˆå§‹åŒ–æ•°ç»„ï¼ˆç”±æ­¤å¯è§ï¼Œåœ¨åˆ›å»ºHashMapå¯¹è±¡çš„æ—¶å€™å¹¶ä¸ä¼šç›´æ¥åˆå§‹åŒ–æ•°ç»„ï¼‰ï¼›</li><li>é€šè¿‡<code>(n-1) &amp; hash</code>è®¡ç®—keyåœ¨æ•°ç»„ä¸­çš„å­˜æ”¾ç´¢å¼•ï¼›</li><li>ç›®æ ‡ç´¢å¼•ä½ç½®ä¸ºç©ºçš„è¯ï¼Œç›´æ¥åˆ›å»ºNodeå­˜å‚¨ï¼›</li><li><p>ç›®æ ‡ç´¢å¼•ä½ç½®ä¸ä¸ºç©ºçš„è¯ï¼Œåˆ†ä¸‹é¢ä¸‰ç§æƒ…å†µï¼š</p><p>4.1. keyç›¸åŒï¼Œè¦†ç›–æ—§å€¼ï¼›</p><p>4.2. è¯¥èŠ‚ç‚¹ç±»å‹æ˜¯çº¢é»‘æ ‘çš„è¯ï¼Œæ‰§è¡Œçº¢é»‘æ ‘æ’å…¥æ“ä½œï¼›</p><p>4.3. è¯¥èŠ‚ç‚¹ç±»å‹æ˜¯é“¾è¡¨çš„è¯ï¼Œéå†åˆ°æœ€åä¸€ä¸ªå…ƒç´ å°¾æ’å…¥ï¼Œå¦‚æœæœŸé—´æœ‰é‡åˆ°keyç›¸åŒçš„ï¼Œåˆ™ç›´æ¥è¦†ç›–ã€‚å¦‚æœé“¾è¡¨é•¿åº¦å¤§äºç­‰äºTREEIFY_THRESHOLDï¼Œå¹¶ä¸”æ•°ç»„å®¹é‡å¤§äºç­‰äºMIN_TREEIFY_CAPACITYï¼Œåˆ™å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ç»“æ„ï¼›</p></li><li><p>åˆ¤æ–­HashMapå…ƒç´ ä¸ªæ•°æ˜¯å¦å¤§äºç­‰äºthresholdï¼Œæ˜¯çš„è¯ï¼Œè¿›è¡Œæ‰©å®¹æ“ä½œã€‚</p></li></ol><h2 id="getæºç "><a href="#getæºç " class="headerlink" title="getæºç "></a>getæºç </h2><p>getå’Œputç›¸æ¯”ï¼Œå°±ç®€å•å¤šäº†ï¼Œä¸‹é¢æ˜¯getæ“ä½œæºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="keyword">int</span> n; K k;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œæ•°ç»„é•¿åº¦æ˜¯å¦å¤§äº0ï¼Œç›®æ ‡ç´¢å¼•ä½ç½®ä¸‹å…ƒç´ æ˜¯å¦ä¸ºç©ºï¼Œæ˜¯çš„è¯ç›´æ¥è¿”å›null</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœç›®æ ‡ç´¢å¼•ä½ç½®å…ƒç´ å°±æ˜¯è¦æ‰¾çš„å…ƒç´ ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">            ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="comment">// å¦‚æœç›®æ ‡ç´¢å¼•ä½ç½®å…ƒç´ çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœç±»å‹æ˜¯çº¢é»‘æ ‘ï¼Œåˆ™ä»çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾</span></span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// å¦åˆ™å°±æ˜¯é“¾è¡¨ï¼Œéå†é“¾è¡¨æŸ¥æ‰¾ç›®æ ‡å…ƒç´ </span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="resizeæºç "><a href="#resizeæºç " class="headerlink" title="resizeæºç "></a>resizeæºç </h2><p>ç”±å‰é¢çš„putæºç åˆ†ææˆ‘ä»¬çŸ¥é“ï¼Œæ•°ç»„çš„åˆå§‹åŒ–å’Œæ‰©å®¹éƒ½æ˜¯é€šè¿‡è°ƒç”¨resizeæ–¹æ³•å®Œæˆçš„ï¼Œæ‰€ä»¥ç°åœ¨æ¥å…³æ³¨ä¸‹resizeæ–¹æ³•çš„æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    <span class="comment">// æ‰©å®¹å‰çš„æ•°ç»„</span></span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="comment">// æ‰©å®¹å‰çš„æ•°ç»„çš„å¤§å°å’Œé˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="comment">// é¢„å®šä¹‰æ–°æ•°ç»„çš„å¤§å°å’Œé˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// è¶…è¿‡æœ€å¤§å€¼å°±ä¸å†æ‰©å®¹äº†</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰©å¤§å®¹é‡ä¸ºå½“å‰å®¹é‡çš„ä¸¤å€ï¼Œä½†ä¸èƒ½è¶…è¿‡ MAXIMUM_CAPACITY</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å½“å‰æ•°ç»„æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨åˆå§‹åŒ–çš„å€¼</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">        <span class="comment">// å¦‚æœåˆå§‹åŒ–çš„å€¼ä¸º 0ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„åˆå§‹åŒ–å®¹é‡ï¼Œé»˜è®¤å€¼ä¸º16</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ–°çš„å®¹é‡ç­‰äº 0</span></span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    threshold = newThr; </span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">    <span class="comment">// å¼€å§‹æ‰©å®¹ï¼Œå°†æ–°çš„å®¹é‡èµ‹å€¼ç»™ table</span></span><br><span class="line">    table = newTab;</span><br><span class="line">    <span class="comment">// åŸæ•°æ®ä¸ä¸ºç©ºï¼Œå°†åŸæ•°æ®å¤åˆ¶åˆ°æ–° table ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®å®¹é‡å¾ªç¯æ•°ç»„ï¼Œå¤åˆ¶éç©ºå…ƒç´ åˆ°æ–° table</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">// å¦‚æœé“¾è¡¨åªæœ‰ä¸€ä¸ªï¼Œåˆ™è¿›è¡Œç›´æ¥èµ‹å€¼</span></span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    <span class="comment">// çº¢é»‘æ ‘ç›¸å…³çš„æ“ä½œ</span></span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                    <span class="comment">// é“¾è¡¨å¤åˆ¶ï¼ŒJDK 1.8 æ‰©å®¹ä¼˜åŒ–éƒ¨åˆ†</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="comment">// åŸç´¢å¼•</span></span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// åŸç´¢å¼• + oldCap</span></span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">// å°†åŸç´¢å¼•æ”¾åˆ°å“ˆå¸Œæ¡¶ä¸­</span></span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å°†åŸç´¢å¼• + oldCap æ”¾åˆ°å“ˆå¸Œæ¡¶ä¸­</span></span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>JDK1.8åœ¨æ‰©å®¹æ—¶é€šè¿‡é«˜ä½è¿ç®—<code>e.hash &amp; oldCap</code>ç»“æœæ˜¯å¦ä¸º0æ¥ç¡®å®šå…ƒç´ æ˜¯å¦éœ€è¦ç§»åŠ¨ï¼Œä¸»è¦æœ‰å¦‚ä¸‹ä¸¤ç§æƒ…å†µï¼š</p><p>æƒ…å†µä¸€ï¼š</p><p>æ‰©å®¹å‰oldCap=16ï¼Œhash=5ï¼Œ<code>(n-1)&amp;hash=15&amp;5=5</code>ï¼Œ<code>hash&amp;oldCap=5&amp;16=0</code>ï¼›</p><p>æ‰©å®¹ånewCap=32ï¼Œhash=5ï¼Œ<code>(n-1)&amp;hash=31&amp;5=5</code>ï¼Œ<code>hash&amp;oldCap=5&amp;16=0</code>ã€‚</p><p>è¿™ç§æƒ…å†µä¸‹ï¼Œæ‰©å®¹åå…ƒç´ ç´¢å¼•ä½ç½®ä¸å˜ï¼Œå¹¶ä¸”hash&amp;oldCap==0ã€‚</p><p>æƒ…å†µäºŒï¼š</p><p>æ‰©å®¹å‰oldCap=16ï¼Œhash=18ï¼Œ<code>(n-1)&amp;hash=15&amp;18=2</code>ï¼Œ<code>hash&amp;oldCap=18&amp;16=16</code>ï¼›</p><p>æ‰©å®¹ånewCap=32ï¼Œhash=18ï¼Œ<code>(n-1)&amp;hash=31&amp;18=18</code>ï¼Œ<code>hash&amp;oldCap=18&amp;16=16</code>ã€‚</p><p>è¿™ç§æƒ…å†µä¸‹ï¼Œæ‰©å®¹åå…ƒç´ ç´¢å¼•ä½ç½®ä¸º18ï¼Œå³æ—§ç´¢å¼•2åŠ 16(oldCap)ï¼Œå¹¶ä¸”hash&amp;oldCap!=0ã€‚</p><h2 id="éå†åŸç†"><a href="#éå†åŸç†" class="headerlink" title="éå†åŸç†"></a>éå†åŸç†</h2><p>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ä¸‹é¢ä¸¤ç§æ–¹å¼éå†HashMapï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">map.put(<span class="string">"1"</span>, <span class="string">"a"</span>);</span><br><span class="line">map.put(<span class="string">"4"</span>, <span class="string">"d"</span>);</span><br><span class="line">map.put(<span class="string">"2"</span>, <span class="string">"b"</span>);</span><br><span class="line">map.put(<span class="string">"9"</span>, <span class="string">"i"</span>);</span><br><span class="line">map.put(<span class="string">"3"</span>, <span class="string">"c"</span>);</span><br><span class="line"></span><br><span class="line">Set&lt;Map.Entry&lt;String, Object&gt;&gt; entries = map.entrySet();</span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : entries) &#123;</span><br><span class="line">    System.out.println(entry.getKey() + <span class="string">": "</span> + entry.getValue());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"-------"</span>);</span><br><span class="line"></span><br><span class="line">Set&lt;String&gt; keySet = map.keySet();</span><br><span class="line"><span class="keyword">for</span> (String key : keySet) &#123;</span><br><span class="line">    System.out.println(key + <span class="string">": "</span> + map.get(key));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: a</span><br><span class="line"><span class="number">2</span>: b</span><br><span class="line"><span class="number">3</span>: c</span><br><span class="line"><span class="number">4</span>: d</span><br><span class="line"><span class="number">9</span>: i</span><br><span class="line">-------</span><br><span class="line"><span class="number">1</span>: a</span><br><span class="line"><span class="number">2</span>: b</span><br><span class="line"><span class="number">3</span>: c</span><br><span class="line"><span class="number">4</span>: d</span><br><span class="line"><span class="number">9</span>: i</span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡å‰é¢å¯¹putæºç çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“HashMapæ˜¯æ— åºçš„ï¼Œè¾“å‡ºå…ƒç´ é¡ºåºå’Œæ’å…¥å…ƒç´ é¡ºåºä¸€èˆ¬éƒ½ä¸ä¸€æ ·ã€‚ä½†æ˜¯å¤šæ¬¡è¿è¡Œä¸Šé¢çš„ç¨‹åºä½ ä¼šå‘ç°ï¼Œæ¯æ¬¡éå†çš„é¡ºåºéƒ½æ˜¯ä¸€æ ·çš„ã€‚é‚£ä¹ˆéå†çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œå†…éƒ¨æ˜¯å¦‚ä½•æ“ä½œçš„ï¼Ÿ</p><p>é€šè¿‡entrySetæˆ–è€…keySetéå†ï¼Œå®ƒä»¬çš„å†…éƒ¨åŸç†æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œä»¥entrySetä¸ºä¾‹ã€‚</p><p>é€šè¿‡æŸ¥çœ‹ä»£ç å¯¹åº”çš„classæ–‡ä»¶ï¼Œä½ ä¼šå‘ç°ä¸‹é¢è¿™æ®µä»£ç å®é™…ä¼šè¢«è½¬æ¢ä¸ºiteratoréå†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;Map.Entry&lt;String, Object&gt;&gt; entries = map.entrySet();</span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : entries) &#123;</span><br><span class="line">    System.out.println(entry.getKey() + <span class="string">": "</span> + entry.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¢å¼ºforå¾ªç¯ä¼šè¢«ç¼–è¯‘ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;Entry&lt;String, Object&gt;&gt; entries = map.entrySet();</span><br><span class="line">Iterator var3 = entries.iterator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">    Entry&lt;String, Object&gt; entry = (Entry)var3.next();</span><br><span class="line">    System.out.println((String)entry.getKey() + <span class="string">": "</span> + entry.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬æŸ¥çœ‹entrySetï¼Œiteratorï¼ŒhasNextï¼Œnextæ–¹æ³•çš„æºç å°±å¯ä»¥æ¸…æ¥šçš„äº†è§£åˆ°HashMapéå†åŸç†äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet() &#123;</span><br><span class="line">    Set&lt;Map.Entry&lt;K,V&gt;&gt; es;</span><br><span class="line">    <span class="comment">// entrySetä¸€å¼€å§‹ä¸ºnullï¼Œé€šè¿‡new EntrySet()åˆ›å»º</span></span><br><span class="line">    <span class="keyword">return</span> (es = entrySet) == <span class="keyword">null</span> ? (entrySet = <span class="keyword">new</span> EntrySet()) : es;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySet</span> <span class="keyword">extends</span> <span class="title">AbstractSet</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span>                 </span>&#123; <span class="keyword">return</span> size; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span>               </span>&#123; HashMap.<span class="keyword">this</span>.clear(); &#125;</span><br><span class="line">    <span class="comment">// EntrySetå†…éƒ¨åŒ…å«è¿­ä»£å™¨æ–¹æ³•ï¼Œæ–¹æ³•å†…éƒ¨é€šè¿‡new EntryIterator()åˆ›å»ºEntryè¿­ä»£å™¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Iterator&lt;Map.Entry&lt;K,V&gt;&gt; iterator() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EntryIterator();</span><br><span class="line">    &#125;</span><br><span class="line">    ...... </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EntryIteratorç»§æ‰¿è‡ªHashIteratorï¼Œè°ƒç”¨EntryIteratorçš„hasNextæ–¹æ³•å®é™…è°ƒç”¨çš„æ˜¯</span></span><br><span class="line"><span class="comment">// çˆ¶ç±»HashIteratorçš„hashNextæ–¹æ³•ï¼Œè°ƒç”¨EntryIteratorçš„nextæ–¹æ³•ï¼Œæ–¹æ³•å†…éƒ¨è°ƒç”¨çš„æ˜¯çˆ¶ç±»HashIterator</span></span><br><span class="line"><span class="comment">// çš„nextNodeæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸»è¦å…³æ³¨HashIteratorçš„æºç </span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EntryIterator</span> <span class="keyword">extends</span> <span class="title">HashIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Map.<span class="function">Entry&lt;K,V&gt; <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> nextNode(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HashIterator</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; next;        <span class="comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    Node&lt;K,V&gt; current;     <span class="comment">// å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">int</span> expectedModCount;  <span class="comment">// æœŸå¾…çš„æ¨¡æ•°å€¼ï¼Œç”¨äºå¿«é€Ÿå¤±è´¥</span></span><br><span class="line">    <span class="keyword">int</span> index;             <span class="comment">// å½“å‰éå†çš„table index</span></span><br><span class="line"></span><br><span class="line">    HashIterator() &#123;</span><br><span class="line">        <span class="comment">// å°†å½“å‰æ¨¡æ•°å€¼èµ‹å€¼ç»™æœŸå¾…çš„æ¨¡æ•°å€¼ï¼Œæ‰€ä»¥åœ¨éå†çš„æ—¶å€™ï¼Œåˆ«çš„çº¿ç¨‹è°ƒç”¨äº†å½“å‰hashMapå®ä¾‹çš„</span></span><br><span class="line">        <span class="comment">// å¢åˆ æ”¹æ–¹æ³•ï¼Œæ¨¡æ•°å€¼ä¼šæ”¹å˜ï¼Œé‚£ä¹ˆexpectedModCountå’ŒmodCountå°±ä¸ç›¸ç­‰äº†ï¼Œéå†æ“ä½œç›´æ¥</span></span><br><span class="line">        <span class="comment">// æŠ›å‡ºConcurrentModificationException</span></span><br><span class="line">        expectedModCount = modCount;</span><br><span class="line">        Node&lt;K,V&gt;[] t = table;</span><br><span class="line">        current = next = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// ä»hashMapæ•°ç»„å¤´éƒ¨å¼€å§‹éå†</span></span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; size &gt; <span class="number">0</span>) &#123; <span class="comment">// advance to first entry</span></span><br><span class="line">            <span class="comment">// ä»æ•°ç»„å¤´éƒ¨å¼€å§‹æ‰¾ï¼Œindexé€’å¢ï¼Œå½“indexä½ç½®çš„èŠ‚ç‚¹ä¸ä¸ºç©ºæ—¶ï¼Œå°†å…¶èµ‹å€¼ç»™next</span></span><br><span class="line">            <span class="comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åˆ›å»ºhashMapè¿­ä»£å™¨çš„æ—¶å€™ï¼Œå†…éƒ¨å°±å·²ç»æ‰¾åˆ°äº†hashMapæ•°ç»„ä¸­ç¬¬ä¸€ä¸ªéç©ºèŠ‚ç‚¹äº†</span></span><br><span class="line">            <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ¤æ–­nextæ˜¯å¦ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">return</span> next != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">nextNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        Node&lt;K,V&gt; e = next;</span><br><span class="line">        <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">            <span class="comment">// æ¨¡æ•°åˆ¤æ–­</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">// å¦‚æœnextä¸ºç©ºäº†ï¼Œè¿˜è°ƒç”¨nextNodeæ–¹æ³•çš„è¯ï¼Œå°†æŠ›å‡ºNoSuchElementExceptionå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">        <span class="comment">// è¿™æ®µé€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œä¸»è¦åŒ…å«å¦‚ä¸‹ä¸¤ç§æƒ…å†µï¼š</span></span><br><span class="line">        <span class="comment">// 1. å¦‚æœå½“å‰èŠ‚ç‚¹çš„nextèŠ‚ç‚¹ä¸ºç©ºçš„è¯ï¼Œè¯´æ˜è¯¥èŠ‚ç‚¹æ— éœ€è¿›è¡Œé“¾è¡¨éå†äº†ï¼ˆå°±ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…å·²ç»åˆ°äº†é“¾è¡¨çš„æœ«å°¾ï¼‰ï¼Œé‚£ä¹ˆè¿›è¡Œdo whileå¾ªç¯ï¼Œç›´åˆ°æ‰¾åˆ°hashMapæ•°ç»„ä¸­ä¸‹ä¸€ä¸ªä¸ä¸ºç©ºçš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// 2. å¦‚æœå½“å‰èŠ‚ç‚¹çš„nextèŠ‚ç‚¹ä¸ä¸ºç©ºçš„è¯ï¼Œè¯´æ˜è¯¥ä½ç½®å­˜åœ¨é“¾è¡¨ï¼Œé‚£ä¹ˆå¤–ç•Œåœ¨å¾ªç¯è°ƒç”¨iteratorçš„nextæ–¹æ³•æ—¶ï¼Œå®é™…å°±æ˜¯ä¸æ–­è°ƒç”¨nextNodeæ–¹æ³•éå†é“¾è¡¨æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> ((next = (current = e).next) == <span class="keyword">null</span> &amp;&amp; (t = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ€»ä¹‹ï¼Œéå†HashMapçš„è¿‡ç¨‹å°±æ˜¯ä»å¤´æŸ¥æ‰¾HashMapæ•°ç»„ä¸­çš„ä¸ä¸ºç©ºçš„ç»“ç‚¹ï¼Œå¦‚æœè¯¥ç»“ç‚¹ä¸‹å­˜åœ¨é“¾è¡¨ï¼Œåˆ™éå†è¯¥é“¾è¡¨ï¼Œéå†å®Œé“¾è¡¨åå†æ‰¾HashMapæ•°ç»„ä¸­ä¸‹ä¸€ä¸ªä¸ä¸ºç©ºçš„ç»“ç‚¹ï¼Œä»¥æ­¤è¿›è¡Œä¸‹å»ç›´åˆ°éå†ç»“æŸã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚æœæŸä¸ªç»“ç‚¹ä¸‹æ˜¯çº¢é»‘æ ‘ç»“æ„çš„è¯ï¼Œæ€ä¹ˆéå†ï¼Ÿå…¶å®å½“é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘æ—¶ï¼Œé“¾è¡¨èŠ‚ç‚¹é‡ŒåŒ…å«çš„nextå­—æ®µä¿¡æ¯æ˜¯ä¿ç•™çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¾æ—§å¯ä»¥é€šè¿‡çº¢é»‘æ ‘èŠ‚ç‚¹ä¸­çš„nextå­—æ®µæ‰¾åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><h2 id="ä¸JDK1-7ä¸»è¦åŒºåˆ«"><a href="#ä¸JDK1-7ä¸»è¦åŒºåˆ«" class="headerlink" title="ä¸JDK1.7ä¸»è¦åŒºåˆ«"></a>ä¸JDK1.7ä¸»è¦åŒºåˆ«</h2><p>JDK1.7 HashMapæºç ï¼š<a href="https://github.com/ZhaoX/jdk-1.7-annotated/blob/master/src/java/util/HashMap.java" target="_blank" rel="noopener">https://github.com/ZhaoX/jdk-1.7-annotated/blob/master/src/java/util/HashMap.java</a>ã€‚</p><h3 id="æ•°ç»„å…ƒç´ ç±»å‹ä¸åŒ"><a href="#æ•°ç»„å…ƒç´ ç±»å‹ä¸åŒ" class="headerlink" title="æ•°ç»„å…ƒç´ ç±»å‹ä¸åŒ"></a>æ•°ç»„å…ƒç´ ç±»å‹ä¸åŒ</h3><p>JDK1.8 HashMapæ•°ç»„å…ƒç´ ç±»å‹ä¸º<code>Node&lt;K,V&gt;</code>ï¼ŒJDK1.7 HashMapæ•°ç»„å…ƒç´ ç±»å‹ä¸º<code>Entry&lt;K,V&gt;</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> Entry&lt;K,V&gt;[] table = (Entry&lt;K,V&gt;[]) EMPTY_TABLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Entry&lt;K,V&gt; next;</span><br><span class="line">    <span class="keyword">int</span> hash;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å®é™…å°±æ˜¯æ¢äº†ä¸ªç±»åï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆæœ¬è´¨ä¸åŒã€‚</p><h3 id="hashè®¡ç®—è§„åˆ™ä¸åŒ"><a href="#hashè®¡ç®—è§„åˆ™ä¸åŒ" class="headerlink" title="hashè®¡ç®—è§„åˆ™ä¸åŒ"></a>hashè®¡ç®—è§„åˆ™ä¸åŒ</h3><p>JDK1.7 hashè®¡ç®—è§„åˆ™ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h = hashSeed;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != h &amp;&amp; k <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    h ^= k.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This function ensures that hashCodes that differ only by</span></span><br><span class="line">    <span class="comment">// constant multiples at each bit position have a bounded</span></span><br><span class="line">    <span class="comment">// number of collisions (approximately 8 at default load factor).</span></span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç›¸æ¯”äºJDK1.8çš„hashæ–¹æ³•ï¼ŒJDK1.7çš„hashæ–¹æ³•çš„æ€§èƒ½ä¼šç¨å·®ä¸€ç‚¹ã€‚</p><h3 id="putæ“ä½œä¸åŒ"><a href="#putæ“ä½œä¸åŒ" class="headerlink" title="putæ“ä½œä¸åŒ"></a>putæ“ä½œä¸åŒ</h3><p>JDK1.7å¹¶æ²¡æœ‰ä½¿ç”¨çº¢é»‘æ ‘ï¼Œå¦‚æœå“ˆå¸Œå†²çªåï¼Œéƒ½ç”¨é“¾è¡¨è§£å†³ã€‚åŒºåˆ«äºJDK1.8çš„å°¾éƒ¨æ’å…¥ï¼ŒJDK1.7é‡‡ç”¨å¤´éƒ¨æ’å…¥çš„æ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;   </span><br><span class="line">    <span class="comment">// é”®ä¸ºnullï¼Œå°†å…ƒç´ æ”¾ç½®åˆ°tableæ•°ç»„çš„0ä¸‹æ ‡å¤„</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)  </span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value); </span><br><span class="line">    <span class="comment">// è®¡ç®—hashå’Œæ•°ç»„ä¸‹æ ‡ç´¢å¼•ä½ç½®</span></span><br><span class="line">    <span class="keyword">int</span> hash = hash(key.hashCode());  </span><br><span class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);  </span><br><span class="line">    <span class="comment">// éå†é“¾è¡¨ï¼Œå½“keyä¸€è‡´æ—¶ï¼Œè¯´æ˜è¯¥keyå·²ç»å­˜åœ¨ï¼Œä½¿ç”¨æ–°å€¼æ›¿æ¢æ—§å€¼å¹¶è¿”å›</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;  </span><br><span class="line">        Object k;  </span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;  </span><br><span class="line">            V oldValue = e.value;  </span><br><span class="line">            e.value = value;  </span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);  </span><br><span class="line">            <span class="keyword">return</span> oldValue;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    </span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// æ’å…¥é“¾è¡¨</span></span><br><span class="line">    addEntry(hash, key, value, i);  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> V <span class="title">putForNullKey</span><span class="params">(V value)</span> </span>&#123; </span><br><span class="line">    <span class="comment">// ä¸€æ ·çš„ï¼Œæ–°æ—§å€¼æ›¿æ¢</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[<span class="number">0</span>]; e != <span class="keyword">null</span>; e = e.next) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (e.key == <span class="keyword">null</span>) &#123;  </span><br><span class="line">            V oldValue = e.value;  </span><br><span class="line">            e.value = value;  </span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);  </span><br><span class="line">            <span class="keyword">return</span> oldValue;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    </span><br><span class="line">    modCount++;  </span><br><span class="line">    <span class="comment">// æ’å…¥åˆ°æ•°ç»„ä¸‹æ ‡ä¸º0ä½ç½®</span></span><br><span class="line">    addEntry(<span class="number">0</span>, <span class="keyword">null</span>, value, <span class="number">0</span>);  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ–°å€¼å¤´éƒ¨æ’å…¥ï¼ŒåŸå…ˆå¤´éƒ¨å˜æˆæ–°çš„å¤´éƒ¨å…ƒç´ çš„next</span></span><br><span class="line">    Entry&lt;K, V&gt; e = table[bucketIndex];</span><br><span class="line">    table[bucketIndex] = <span class="keyword">new</span> Entry&lt;K, V&gt;(hash, key, value, e);</span><br><span class="line">    <span class="comment">// è®¡æ•°ï¼Œæ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (size++ &gt;= threshold)</span><br><span class="line">        resize(<span class="number">2</span> * table.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="æ‰©å®¹æ“ä½œä¸åŒ"><a href="#æ‰©å®¹æ“ä½œä¸åŒ" class="headerlink" title="æ‰©å®¹æ“ä½œä¸åŒ"></a>æ‰©å®¹æ“ä½œä¸åŒ</h3><p>JDK1.8åœ¨æ‰©å®¹æ—¶é€šè¿‡é«˜ä½è¿ç®—<code>e.hash &amp; oldCap</code>ç»“æœæ˜¯å¦ä¸º0æ¥ç¡®å®šå…ƒç´ æ˜¯å¦éœ€è¦ç§»åŠ¨ï¼ŒJDK1.7é‡æ–°è®¡ç®—äº†æ¯ä¸ªå…ƒç´ çš„å“ˆå¸Œå€¼ï¼ŒæŒ‰æ—§é“¾è¡¨çš„æ­£åºéå†é“¾è¡¨ã€åœ¨æ–°é“¾è¡¨çš„å¤´éƒ¨ä¾æ¬¡æ’å…¥ï¼Œå³åœ¨è½¬ç§»æ•°æ®ã€æ‰©å®¹åï¼Œå®¹æ˜“å‡ºç°é“¾è¡¨é€†åºçš„æƒ…å†µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>&#123;</span><br><span class="line">    Entry[] oldTable = table;</span><br><span class="line">    <span class="keyword">int</span> oldCapacity = oldTable.length;</span><br><span class="line">    <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        threshold = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Entry[] newTable = <span class="keyword">new</span> Entry[newCapacity];</span><br><span class="line">    transfer(newTable, initHashSeedAsNeeded(newCapacity));</span><br><span class="line">    table = newTable;</span><br><span class="line">    threshold = (<span class="keyword">int</span>)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Transfers all entries from current table to newTable.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Entry[] newTable, <span class="keyword">boolean</span> rehash)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> newCapacity = newTable.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e : table) &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">null</span> != e) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; next = e.next;</span><br><span class="line">            <span class="keyword">if</span> (rehash) &#123;</span><br><span class="line">                e.hash = <span class="keyword">null</span> == e.key ? <span class="number">0</span> : hash(e.key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> i = indexFor(e.hash, newCapacity);</span><br><span class="line">            e.next = newTable[i];</span><br><span class="line">            newTable[i] = e;</span><br><span class="line">            e = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ­¤æ—¶è‹¥å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œresizeæ“ä½œï¼Œå®¹æ˜“å‡ºç°ç¯å½¢é“¾è¡¨ï¼Œä»è€Œåœ¨è·å–æ•°æ®ã€éå†é“¾è¡¨æ—¶é€ æˆæ­»å¾ªç¯ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼š<a href="https://blog.csdn.net/hhx0626/article/details/54024222" target="_blank" rel="noopener">https://blog.csdn.net/hhx0626/article/details/54024222</a>ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:19 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;æœ¬èŠ‚ç”¨äºè®°å½•Java HashMapåº•å±‚æ•°æ®ç»“æ„ã€æ–¹æ³•å®ç°åŸç†ç­‰ï¼ŒåŸºäºJDK 1.8ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>æ•°æ®ç»“æ„ - äºŒå‰æ ‘å­¦ä¹ ç¬”è®°</title>
    <link href="http://mrbird.cc/%E4%BA%8C%E5%8F%89%E6%A0%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>http://mrbird.cc/äºŒå‰æ ‘å­¦ä¹ ç¬”è®°.html</id>
    <published>2020-07-17T08:50:28.000Z</published>
    <updated>2021-01-05T10:45:13.734Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --><p>æ ‘ï¼ˆTreeï¼‰æ˜¯ä¸€ç§å¾ˆæœ‰è¶£çš„æ•°æ®ç»“æ„ï¼Œå®ƒæ—¢èƒ½åƒé“¾è¡¨é‚£æ ·å¿«é€Ÿçš„æ’å…¥å’Œåˆ é™¤ï¼Œåˆèƒ½åƒæœ‰åºæ•°ç»„é‚£æ ·å¿«é€ŸæŸ¥æ‰¾ã€‚æ ‘çš„ç§ç±»å¾ˆå¤šï¼Œæœ¬èŠ‚å°†è®°å½•ä¸€ç§ç‰¹æ®Šçš„æ ‘â€”â€”â€”â€”äºŒå‰æ ‘ï¼ˆBinary Treeï¼‰ã€‚äºŒå‰æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šåªèƒ½æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œé€šå¸¸ç§°ä¸ºå·¦å­èŠ‚ç‚¹å’Œå³å­èŠ‚ç‚¹ã€‚å¦‚æœä¸€ä¸ªäºŒå‰æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹çš„å…³é”®å­—å€¼å°äºè¯¥èŠ‚ç‚¹ï¼Œå³å­èŠ‚ç‚¹çš„å…³é”®å­—å€¼å¤§äºç­‰äºè¯¥èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™ç§äºŒå‰æ ‘ä¹Ÿç§°ä¸ºäºŒå‰æœç´¢æ ‘ï¼ˆBinary Search Tree,<strong>BST</strong>ï¼‰ï¼Œæœ¬èŠ‚ä¸»è¦å…³æ³¨BSTã€‚</p><a id="more"></a><h2 id="ç›¸å…³æœ¯è¯­"><a href="#ç›¸å…³æœ¯è¯­" class="headerlink" title="ç›¸å…³æœ¯è¯­"></a>ç›¸å…³æœ¯è¯­</h2><p>æŸ¥çœ‹ä¸€ä¸ªBSTä¾‹å­ï¼š</p><p><img src="img/2020å¹´12æœˆ30æ—¥10-01-34.png" alt="2020å¹´12æœˆ30æ—¥10-01-34"></p><ul><li>è·¯å¾„ï¼šä»ä¸€ä¸ªèŠ‚ç‚¹èµ°åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç»è¿‡çš„èŠ‚ç‚¹é¡ºåºå°±ç§°ä¸ºè·¯å¾„ï¼›</li><li>æ ¹ï¼šæ ‘çš„é¡¶ç«¯èŠ‚ç‚¹ç§°ä¸ºæ ¹ï¼Œä¸€ä¸ªæ•°åªèƒ½æœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œå¹¶ä¸”ä»æ ¹èŠ‚ç‚¹åˆ°ä»»æ„å­èŠ‚ç‚¹åªèƒ½æœ‰ä¸€æ¡è·¯å¾„ï¼›</li><li>çˆ¶èŠ‚ç‚¹ï¼šæ¯ä¸ªèŠ‚ç‚¹ï¼ˆé™¤äº†æ ¹ï¼‰éƒ½æœ‰ä¸€æ¡è¾¹å‘ä¸Šè¿æ¥åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸‹é¢èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼›</li><li>å­èŠ‚ç‚¹ï¼šæ¯ä¸ªèŠ‚ç‚¹ï¼ˆé™¤äº†å¶å­èŠ‚ç‚¹ï¼‰éƒ½æœ‰ä¸€æ¡æˆ–ä¸¤æ¡è¾¹å‘ä¸‹è¿æ¥å…¶ä»–èŠ‚ç‚¹ï¼Œä¸‹é¢è¿™äº›èŠ‚ç‚¹å°±æ˜¯å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ã€‚å­èŠ‚ç‚¹åˆ†ä¸ºå·¦å­èŠ‚ç‚¹å’Œå³å­èŠ‚ç‚¹ï¼›</li><li>å¶èŠ‚ç‚¹ï¼šæ²¡æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ç§°ä¸ºå¶å­èŠ‚ç‚¹ï¼Œæˆ–å¶èŠ‚ç‚¹ï¼›</li><li>å…³é”®å­—ï¼šèŠ‚ç‚¹ä¸­çš„æ•°æ®ï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­çš„æ•°å€¼ã€‚</li></ul><h2 id="æ“ä½œBST"><a href="#æ“ä½œBST" class="headerlink" title="æ“ä½œBST"></a>æ“ä½œBST</h2><p>åœ¨æ“ä½œBSTå‰ï¼Œæˆ‘ä»¬å…ˆç”¨ä»£ç å®šä¹‰ä¸€ä¸ªBSTçš„éª¨æ¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** BST */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** æ ¹èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line">    <span class="comment">/** èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** å…³é”®å­— */</span></span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="comment">/** é¢å¤–æºå¸¦çš„æ•°æ® */</span></span><br><span class="line">        String value;</span><br><span class="line">        <span class="comment">/** å·¦å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node leftChild;</span><br><span class="line">        <span class="comment">/** å³å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node rightChild;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸‹é¢çš„è¿™äº›æ“ä½œéƒ½ä»¥è¿™ä¸ªBSTä¸ºä¾‹ï¼š</p><p><img src="img/QQ20201230-102608@2x.png" alt="QQ20201230-102608@2x"></p><h3 id="æ’å…¥"><a href="#æ’å…¥" class="headerlink" title="æ’å…¥"></a>æ’å…¥</h3><p>å‡å¦‚æˆ‘ä»¬éœ€è¦æ’å…¥ä¸€ä¸ªkeyä¸º88çš„èŠ‚ç‚¹ï¼Œéœ€è¦ç»è¿‡å¦‚ä¸‹æ­¥éª¤ï¼š</p><ol><li>ä»æ ¹èŠ‚ç‚¹å‡ºå‘ï¼Œ88æ¯”72å¤§ï¼Œæ‰€ä»¥èµ°å³å­èŠ‚ç‚¹82è·¯å¾„ï¼›</li><li>88æ¯”82å¤§ï¼Œæ‰€ä»¥èµ°å³å­èŠ‚ç‚¹90è·¯å¾„ï¼›</li><li>88æ¯”90å°ï¼Œæ‰€ä»¥èµ°å·¦å­èŠ‚ç‚¹87è·¯å¾„ï¼›</li><li>88æ¯”87å¤§ï¼Œå¹¶ä¸”87çš„å³å­èŠ‚ç‚¹ä¸ºç©ºï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆæŠŠ88ä½œä¸º87çš„å³å­èŠ‚ç‚¹æ’å…¥æ ‘ä¸­ã€‚</li></ol><p>å½“keyé‡å¤æ—¶ï¼Œå¯ä»¥é€‰æ‹©è¦†ç›–æˆ–è€…å¿½ç•¥ï¼Œè¿™ç”±ä¸šåŠ¡å†³å®šã€‚</p><p>ä¸Šè¿°è¿‡ç¨‹åŠ¨æ€å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/2020-12-30 13.53.58.gif" alt="2020-12-30 13.53.58.gif"></p><p>Javaä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** BST */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** æ ¹èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line">    <span class="comment">/** èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** å…³é”®å­— */</span></span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="comment">/** é¢å¤–æºå¸¦çš„æ•°æ® */</span></span><br><span class="line">        String value;</span><br><span class="line">        <span class="comment">/** å·¦å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node leftChild;</span><br><span class="line">        <span class="comment">/** å³å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node rightChild;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** æ’å…¥ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹</span></span><br><span class="line">        Node newNode = <span class="keyword">new</span> Node(key, value);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ ¹ä¸ºnullï¼Œåˆ™è¿™ä¸ªæ–°èŠ‚ç‚¹å°±æ˜¯æ ¹</span></span><br><span class="line">            root = newNode;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœè·Ÿä¸ä¸ºnullï¼Œåˆ™ä»æ ¹å¼€å§‹æœç´¢æ’å…¥ä½ç½®</span></span><br><span class="line">            Node currentNode = root;</span><br><span class="line">            <span class="comment">// ç”¨äºæš‚å­˜çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">            Node parentNode;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                parentNode = currentNode;</span><br><span class="line">                <span class="keyword">if</span> (key &lt; currentNode.key) &#123;</span><br><span class="line">                    currentNode = currentNode.leftChild;</span><br><span class="line">                    <span class="keyword">if</span> (currentNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// å¦‚æœkeyå°äºå½“å‰èŠ‚ç‚¹keyï¼Œå¹¶ä¸”å½“å‰èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™å°†æ–°èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="comment">// è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ï¼ˆçˆ¶èŠ‚ç‚¹æš‚å­˜å¯¹è±¡ï¼‰çš„å·¦å­èŠ‚ç‚¹ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                        parentNode.leftChild = newNode;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key &gt; currentNode.key) &#123;</span><br><span class="line">                    currentNode = currentNode.rightChild;</span><br><span class="line">                    <span class="keyword">if</span> (currentNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// å¦‚æœkeyå¤§äºå½“å‰èŠ‚ç‚¹keyï¼Œå¹¶ä¸”å½“å‰èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™å°†æ–°èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="comment">// è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ï¼ˆçˆ¶èŠ‚ç‚¹æš‚å­˜å¯¹è±¡ï¼‰çš„åˆå­èŠ‚ç‚¹ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                        parentNode.rightChild = newNode;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœkeyç­‰äºå½“å‰èŠ‚ç‚¹keyï¼Œåˆ™å°†valueè¦†ç›–å½“å‰èŠ‚ç‚¹value</span></span><br><span class="line">                    currentNode.value = newNode.value;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¼–å†™æµ‹è¯•ç¨‹åºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTreeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BinarySearchTree bst = <span class="keyword">new</span> BinarySearchTree();</span><br><span class="line">        Arrays.asList(<span class="number">72</span>, <span class="number">57</span>, <span class="number">82</span>, <span class="number">30</span>, <span class="number">63</span>, <span class="number">79</span>, <span class="number">90</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">62</span>, <span class="number">67</span>, <span class="number">80</span>, <span class="number">87</span>, <span class="number">48</span>).forEach(key -&gt; &#123;</span><br><span class="line">            String value = <span class="string">"æˆ‘æ˜¯keyä¸º"</span> + key + <span class="string">"çš„value"</span>;</span><br><span class="line">            bst.insert(key, value);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä»¥debugçš„æ–¹å¼è¿è¡Œç¨‹åºï¼ŒæŸ¥çœ‹bstç»“æ„ï¼š</p><p><img src="img/QQ20201230-140411@2x.png" alt="QQ20201230-140411@2x"></p><p>bstç»“æ„å’Œä¸Šå›¾ä¸€è‡´ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±éªŒè¯ã€‚</p><h3 id="æŸ¥æ‰¾"><a href="#æŸ¥æ‰¾" class="headerlink" title="æŸ¥æ‰¾"></a>æŸ¥æ‰¾</h3><p>å‡å¦‚æˆ‘ä»¬éœ€è¦æŸ¥æ‰¾keyä¸º67çš„èŠ‚ç‚¹ï¼Œéœ€è¦ç»è¿‡å¦‚ä¸‹æ­¥éª¤ï¼š</p><ol><li>ä»æ ¹èŠ‚ç‚¹å‡ºå‘ï¼Œ67æ¯”72å°ï¼Œæ‰€ä»¥èµ°å·¦å­èŠ‚ç‚¹57è·¯å¾„ï¼›</li><li>67æ¯”57å¤§ï¼Œæ‰€ä»¥èµ°å³å­èŠ‚ç‚¹63è·¯å¾„ï¼›</li><li>67æ¯”63å¤§ï¼Œæ‰€ä»¥èµ°å³å­èŠ‚ç‚¹67è·¯å¾„ï¼›</li><li>67ç­‰äº67ï¼Œæ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œé€€å‡ºï¼›</li><li>å¦‚æœæœç´¢ç›´åˆ°å¶å­èŠ‚ç‚¹éƒ½æ²¡æ‰¾åˆ°ï¼Œåˆ™è¿”å›ç©ºã€‚</li></ol><p>ä¸Šè¿°è¿‡ç¨‹åŠ¨æ€å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/2020-12-30 10.39.41.gif" alt="2020-12-30 10.39.41.gif"></p><p>Javaä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** BST */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** æ ¹èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line">    <span class="comment">/** èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** å…³é”®å­— */</span></span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="comment">/** é¢å¤–æºå¸¦çš„æ•°æ® */</span></span><br><span class="line">        String value;</span><br><span class="line">        <span class="comment">/** å·¦å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node leftChild;</span><br><span class="line">        <span class="comment">/** å³å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node rightChild;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** æŸ¥æ‰¾ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">find</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä»æ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾</span></span><br><span class="line">        Node currentNode = root;</span><br><span class="line">        <span class="comment">// å½“å‰èŠ‚ç‚¹çš„keyä¸ç­‰äºè¢«æŸ¥æ‰¾çš„keyæ—¶</span></span><br><span class="line">        <span class="keyword">while</span> (currentNode.key != key) &#123;</span><br><span class="line">            <span class="keyword">if</span> (key &lt; currentNode.key) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœkeyå€¼å°äºå½“å‰èŠ‚ç‚¹keyï¼Œåˆ™æŸ¥æ‰¾å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">                currentNode = currentNode.leftChild;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœkeyå€¼å¤§äºç­‰äºå½“å‰èŠ‚ç‚¹keyï¼Œåˆ™æŸ¥æ‰¾å³å­èŠ‚ç‚¹</span></span><br><span class="line">                currentNode = currentNode.rightChild;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºnullï¼Œè¯´æ˜æŸ¥åˆ°å¶å­èŠ‚ç‚¹äº†ï¼Œä»æ²¡æŸ¥åˆ°ç›®æ ‡keyï¼Œåˆ™ç›´æ¥è¿”å›null</span></span><br><span class="line">            <span class="keyword">if</span> (currentNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›å½“å‰èŠ‚ç‚¹ï¼ˆé€€å‡ºwhileå¾ªç¯è¦ä¹ˆkeyç›¸ç­‰ï¼Œè¦ä¹ˆæ²¡æ‰¾åˆ°ï¼Œç»“æœä¸ºnullï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> currentNode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¼–å†™æµ‹è¯•ç¨‹åºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTreeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BinarySearchTree bst = <span class="keyword">new</span> BinarySearchTree();</span><br><span class="line">        Arrays.asList(<span class="number">72</span>, <span class="number">57</span>, <span class="number">82</span>, <span class="number">30</span>, <span class="number">63</span>, <span class="number">79</span>, <span class="number">90</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">62</span>, <span class="number">67</span>, <span class="number">80</span>, <span class="number">87</span>, <span class="number">48</span>).forEach(key -&gt; &#123;</span><br><span class="line">            String value = <span class="string">"æˆ‘æ˜¯keyä¸º"</span> + key + <span class="string">"çš„value"</span>;</span><br><span class="line">            bst.insert(key, value);</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(bst.find(<span class="number">87</span>).value);</span><br><span class="line">        bst.insert(<span class="number">87</span>, <span class="string">"hello world"</span>);</span><br><span class="line">        System.out.println(bst.find(<span class="number">87</span>).value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æˆ‘æ˜¯keyä¸º87çš„value</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure><p></p><h3 id="æœ€å¤§æœ€å°å€¼"><a href="#æœ€å¤§æœ€å°å€¼" class="headerlink" title="æœ€å¤§æœ€å°å€¼"></a>æœ€å¤§æœ€å°å€¼</h3><p>åœ¨BSTé‡ŒæŸ¥æ‰¾æœ€å¤§å€¼å’Œæœ€å°å€¼æ˜¯éå¸¸å®¹æ˜“çš„ä¸€ä»¶äº‹ï¼Œæ ¹æ®BSTç‰¹æ€§ï¼Œå°çš„å€¼éƒ½åˆ†å¸ƒåœ¨å·¦èŠ‚ç‚¹ï¼Œå¤§çš„å€¼éƒ½åˆ†å¸ƒåœ¨å³èŠ‚ç‚¹ï¼Œæ‰€ä»¥<strong>æœ€å°å€¼æŸ¥æ‰¾æ–¹æ³•ä¸ºï¼šä»æ ¹èŠ‚ç‚¹å‡ºå‘ï¼Œä¸€ç›´å¾€ä¸‹æŸ¥æ‰¾å·¦å­èŠ‚ç‚¹ï¼Œå½“è¯¥èŠ‚ç‚¹ä¸å†æœ‰å·¦å­èŠ‚ç‚¹æ—¶ï¼Œè¯¥èŠ‚ç‚¹å°±æ˜¯æœ€å°èŠ‚ç‚¹ï¼›æœ€å¤§å€¼æŸ¥æ‰¾æ–¹æ³•ä¸ºï¼šä»æ ¹èŠ‚ç‚¹å‡ºå‘ï¼Œä¸€ç›´å¾€ä¸‹æŸ¥æ‰¾å³å­èŠ‚ç‚¹ï¼Œå½“è¯¥èŠ‚ç‚¹ä¸å†æœ‰å³å­èŠ‚ç‚¹æ—¶ï¼Œè¯¥èŠ‚ç‚¹å°±æ˜¯æœ€å¤§èŠ‚ç‚¹</strong>ã€‚</p><p>æŸ¥æ‰¾æœ€å°å€¼å›¾ç¤ºï¼š</p><p><img src="img/2020-12-30 14.23.27.gif" alt="2020-12-30 14.23.27.gif"></p><p>æŸ¥æ‰¾æœ€å¤§å€¼å›¾ç¤ºï¼š</p><p><img src="img/2020-12-30 14.28.09.gif" alt="2020-12-30 14.28.09.gif"></p><p>Javaä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/** BST */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** æ ¹èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line">    <span class="comment">/** èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** å…³é”®å­— */</span></span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="comment">/** é¢å¤–æºå¸¦çš„æ•°æ® */</span></span><br><span class="line">        String value;</span><br><span class="line">        <span class="comment">/** å·¦å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node leftChild;</span><br><span class="line">        <span class="comment">/** å³å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node rightChild;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ€å°å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">min</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node currentNode = root;</span><br><span class="line">        <span class="keyword">while</span> (currentNode.leftChild != <span class="keyword">null</span>) &#123;</span><br><span class="line">            currentNode = currentNode.leftChild;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ€å¤§å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">max</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node currentNode = root;</span><br><span class="line">        <span class="keyword">while</span> (currentNode.rightChild != <span class="keyword">null</span>) &#123;</span><br><span class="line">            currentNode = currentNode.rightChild;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentNode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–å†™æµ‹è¯•ç¨‹åºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTreeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BinarySearchTree bst = <span class="keyword">new</span> BinarySearchTree();</span><br><span class="line">        Arrays.asList(<span class="number">72</span>, <span class="number">57</span>, <span class="number">82</span>, <span class="number">30</span>, <span class="number">63</span>, <span class="number">79</span>, <span class="number">90</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">62</span>, <span class="number">67</span>, <span class="number">80</span>, <span class="number">87</span>, <span class="number">48</span>).forEach(key -&gt; &#123;</span><br><span class="line">            String value = <span class="string">"æˆ‘æ˜¯keyä¸º"</span> + key + <span class="string">"çš„value"</span>;</span><br><span class="line">            bst.insert(key, value);</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(bst.min().value);</span><br><span class="line">        System.out.println(bst.max().value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æˆ‘æ˜¯keyä¸º27çš„value</span><br><span class="line">æˆ‘æ˜¯keyä¸º90çš„value</span><br></pre></td></tr></table></figure><p></p><h3 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h3><p>åˆ é™¤æ˜¯BSTæ“ä½œé‡Œæœ€å¤æ‚çš„ä¸€ä¸ªï¼Œå› ä¸ºéœ€è¦è€ƒè™‘çš„å› ç´ æ¯”è¾ƒå¤šï¼š</p><ol><li>è¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹ï¼›</li><li>è¢«åˆ é™¤çš„èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼›</li><li>è¢«åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ã€‚</li></ol><p>ä¸‹é¢æˆ‘ä»¬é€ä¸ªåˆ†æï¼š</p><h4 id="è¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹"><a href="#è¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹" class="headerlink" title="è¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹"></a>è¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹</h4><p>è¿™ç§æƒ…å†µæœ€ä¸ºç®€å•ï¼Œåˆ é™¤èŠ‚ç‚¹å‰éœ€è¦å…ˆæ‰¾åˆ°è¯¥èŠ‚ç‚¹ï¼Œè¿‡ç¨‹å’Œä¸Šé¢çš„æŸ¥æ‰¾ç±»ä¼¼ã€‚æ‰¾åˆ°éœ€è¦åˆ é™¤çš„èŠ‚ç‚¹åï¼Œå¦‚æœæ˜¯å¶å­èŠ‚ç‚¹ï¼Œåˆ™å°†è¯¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å¼•ç”¨ç½®ä¸ºnullï¼Œè¢«åˆ é™¤çš„èŠ‚ç‚¹æ²¡äº†å¼•ç”¨ï¼Œåç»­ç”±GCè‡ªåŠ¨å›æ”¶ã€‚</p><p>å‡å¦‚æˆ‘ä»¬éœ€è¦åˆ é™¤keyä¸º48çš„èŠ‚ç‚¹ï¼Œéœ€è¦ç»è¿‡å¦‚ä¸‹æ­¥éª¤ï¼š</p><ol><li>ä»æ ¹èŠ‚ç‚¹å‡ºå‘ï¼Œ48æ¯”72å°ï¼Œæ‰€ä»¥èµ°å·¦å­èŠ‚ç‚¹57è·¯å¾„ï¼›</li><li>48æ¯”57å°ï¼Œæ‰€ä»¥èµ°å·¦å­èŠ‚ç‚¹30è·¯å¾„ï¼›</li><li>48æ¯”30å¤§ï¼Œæ‰€ä»¥èµ°å³å­èŠ‚ç‚¹40è·¯å¾„ï¼›</li><li>48æ¯”40å¤§ï¼Œæ‰€ä»¥èµ°å³å­èŠ‚ç‚¹48è·¯å¾„ï¼›</li><li>48ç­‰äº48ï¼Œæ‰€ä»¥å½“å‰èŠ‚ç‚¹å°±æ˜¯éœ€è¦è¢«åˆ é™¤èŠ‚ç‚¹ï¼›</li><li>48æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œä¸ºå¶å­èŠ‚ç‚¹ï¼Œæ‰€ä»¥ç›´æ¥å°†40çš„å³å­èŠ‚ç‚¹å¼•ç”¨è®¾ç½®ä¸ºnullå³å¯ã€‚</li></ol><p>è¯¥è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/2020-12-30 15.07.30.gif" alt="2020-12-30 15.07.30.gif"></p><p>Javaä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** BST */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** æ ¹èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line">    <span class="comment">/** èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** å…³é”®å­— */</span></span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="comment">/** é¢å¤–æºå¸¦çš„æ•°æ® */</span></span><br><span class="line">        String value;</span><br><span class="line">        <span class="comment">/** å·¦å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node leftChild;</span><br><span class="line">        <span class="comment">/** å³å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node rightChild;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** åˆ é™¤ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* --------- æŸ¥æ‰¾éœ€è¦è¢«åˆ é™¤çš„èŠ‚ç‚¹ä»¥åŠå®ƒçš„çˆ¶èŠ‚ç‚¹ ------- */</span></span><br><span class="line">        <span class="comment">// ä»æ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾</span></span><br><span class="line">        Node deleteNode = root;</span><br><span class="line">        <span class="comment">// æš‚å­˜éœ€è¦è¢«åˆ é™¤èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">        Node parentNode = root;</span><br><span class="line">        <span class="comment">// æ ‡è¯†è¢«åˆ é™¤çš„èŠ‚ç‚¹æ—¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹è¿˜æ˜¯å³å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">boolean</span> isLeftChild = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// ä¸‹é¢è¿™ä¸ªè¿‡ç¨‹å’ŒæŸ¥æ‰¾ä¸€è‡´ï¼Œåªä¸è¿‡åŠ äº†isLeftChildæ ‡è¯†</span></span><br><span class="line">        <span class="keyword">while</span> (deleteNode.key != key) &#123;</span><br><span class="line">            parentNode = deleteNode;</span><br><span class="line">            <span class="keyword">if</span> (key &lt; deleteNode.key) &#123;</span><br><span class="line">                isLeftChild = <span class="keyword">true</span>;</span><br><span class="line">                deleteNode = deleteNode.leftChild;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                isLeftChild = <span class="keyword">false</span>;</span><br><span class="line">                deleteNode = deleteNode.rightChild;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœç›®æ ‡keyå¯¹åº”çš„èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™ä¸éœ€è¦åˆ é™¤ï¼Œç›´æ¥è¿”å›false</span></span><br><span class="line">            <span class="keyword">if</span> (deleteNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* --------- æƒ…å†µ1ï¼šè¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹ ------- */</span></span><br><span class="line">        <span class="keyword">if</span> (deleteNode.leftChild == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; deleteNode.rightChild == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (deleteNode == root) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„èŠ‚ç‚¹ä¸ºrootï¼Œåˆ™ç›´æ¥å°†rootèŠ‚ç‚¹è®¾ç½®ä¸ºnull</span></span><br><span class="line">                root = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isLeftChild) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å…³è”ç½®ä¸ºnull</span></span><br><span class="line">                parentNode.leftChild = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å…³è”ç½®ä¸ºnull</span></span><br><span class="line">                parentNode.rightChild = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–å†™æµ‹è¯•ç¨‹åºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTreeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BinarySearchTree bst = <span class="keyword">new</span> BinarySearchTree();</span><br><span class="line">        Arrays.asList(<span class="number">72</span>, <span class="number">57</span>, <span class="number">82</span>, <span class="number">30</span>, <span class="number">63</span>, <span class="number">79</span>, <span class="number">90</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">62</span>, <span class="number">67</span>, <span class="number">80</span>, <span class="number">87</span>, <span class="number">48</span>).forEach(key -&gt; &#123;</span><br><span class="line">            String value = <span class="string">"æˆ‘æ˜¯keyä¸º"</span> + key + <span class="string">"çš„value"</span>;</span><br><span class="line">            bst.insert(key, value);</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(bst.delete(<span class="number">49</span>));</span><br><span class="line">        System.out.println(bst.delete(<span class="number">48</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><img src="img/2020å¹´12æœˆ30æ—¥15-30-40.png" alt="2020å¹´12æœˆ30æ—¥15-30-40"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">false</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°40çš„å³å­èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤ã€‚</p><h4 id="è¢«åˆ é™¤çš„èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹"><a href="#è¢«åˆ é™¤çš„èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹" class="headerlink" title="è¢«åˆ é™¤çš„èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹"></a>è¢«åˆ é™¤çš„èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹</h4><p>è¿™ç§æƒ…å†µä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦å°†è¢«åˆ é™¤èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å’Œå…¶çˆ¶èŠ‚ç‚¹å»ºç«‹è¿æ¥å…³ç³»å³å¯ã€‚</p><p>å‡å¦‚æˆ‘ä»¬éœ€è¦åˆ é™¤keyä¸º79çš„èŠ‚ç‚¹ï¼Œéœ€è¦ç»è¿‡å¦‚ä¸‹æ­¥éª¤ï¼š</p><ol><li>ä»æ ¹èŠ‚ç‚¹å‡ºå‘ï¼Œ79æ¯”72å¤§ï¼Œæ‰€ä»¥èµ°å³å­èŠ‚ç‚¹82è·¯å¾„ï¼›</li><li>79æ¯”82å°ï¼Œæ‰€ä»¥èµ°å·¦å­èŠ‚ç‚¹79è·¯å¾„ï¼›</li><li>79ç­‰äº79ï¼Œæ‰€ä»¥å½“å‰èŠ‚ç‚¹å°±æ˜¯éœ€è¦è¢«åˆ é™¤èŠ‚ç‚¹ï¼›</li><li>79åªæœ‰ä¸€ä¸ªå³å­èŠ‚ç‚¹ï¼Œå› ä¸º79æ˜¯82çš„å·¦å­èŠ‚ç‚¹ï¼Œæ‰€ä»¥ç›´æ¥å°†80è®¾ç½®ä¸º82çš„å·¦å­èŠ‚ç‚¹å³å¯ã€‚</li></ol><p>è¯¥è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/2020-12-30 16.08.17.gif" alt="2020-12-30 16.08.17.gif"></p><p>Javaä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** BST */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** æ ¹èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line">    <span class="comment">/** èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** å…³é”®å­— */</span></span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="comment">/** é¢å¤–æºå¸¦çš„æ•°æ® */</span></span><br><span class="line">        String value;</span><br><span class="line">        <span class="comment">/** å·¦å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node leftChild;</span><br><span class="line">        <span class="comment">/** å³å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node rightChild;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* --------- æŸ¥æ‰¾éœ€è¦è¢«åˆ é™¤çš„èŠ‚ç‚¹ä»¥åŠå®ƒçš„çˆ¶èŠ‚ç‚¹ ------- */</span></span><br><span class="line">        <span class="comment">// ä»æ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾</span></span><br><span class="line">        Node deleteNode = root;</span><br><span class="line">        <span class="comment">// æš‚å­˜éœ€è¦è¢«åˆ é™¤èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">        Node parentNode = root;</span><br><span class="line">        <span class="comment">// æ ‡è¯†è¢«åˆ é™¤çš„èŠ‚ç‚¹æ—¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹è¿˜æ˜¯å³å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">boolean</span> isLeftChild = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// ä¸‹é¢è¿™ä¸ªè¿‡ç¨‹å’ŒæŸ¥æ‰¾ä¸€è‡´ï¼Œåªä¸è¿‡åŠ äº†isLeftChildæ ‡è¯†</span></span><br><span class="line">        <span class="keyword">while</span> (deleteNode.key != key) &#123;</span><br><span class="line">            parentNode = deleteNode;</span><br><span class="line">            <span class="keyword">if</span> (key &lt; deleteNode.key) &#123;</span><br><span class="line">                isLeftChild = <span class="keyword">true</span>;</span><br><span class="line">                deleteNode = deleteNode.leftChild;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                isLeftChild = <span class="keyword">false</span>;</span><br><span class="line">                deleteNode = deleteNode.rightChild;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœç›®æ ‡keyå¯¹åº”çš„èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™ä¸éœ€è¦åˆ é™¤ï¼Œç›´æ¥è¿”å›false</span></span><br><span class="line">            <span class="keyword">if</span> (deleteNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* --------- æƒ…å†µ1ï¼šè¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹ ------- */</span></span><br><span class="line">        <span class="keyword">if</span> (deleteNode.leftChild == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; deleteNode.rightChild == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (deleteNode == root) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„èŠ‚ç‚¹ä¸ºrootï¼Œåˆ™ç›´æ¥å°†rootèŠ‚ç‚¹è®¾ç½®ä¸ºnull</span></span><br><span class="line">                root = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isLeftChild) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å…³è”ç½®ä¸ºnull</span></span><br><span class="line">                parentNode.leftChild = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å…³è”ç½®ä¸ºnull</span></span><br><span class="line">                parentNode.rightChild = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (deleteNode.leftChild != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; deleteNode.rightChild != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">/* --------- æƒ…å†µ3ï¼šè¢«åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ ------- */</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* --------- æƒ…å†µ2ï¼šè¢«åˆ é™¤çš„èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ ------- */</span></span><br><span class="line">            <span class="comment">// è·å–è¢«åˆ é™¤èŠ‚ç‚¹çš„å”¯ä¸€å­èŠ‚ç‚¹</span></span><br><span class="line">            Node deleteNodeChild = deleteNode.leftChild == <span class="keyword">null</span> ?</span><br><span class="line">                    deleteNode.rightChild : deleteNode.leftChild;</span><br><span class="line">            <span class="keyword">if</span> (deleteNode == root) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¢«åˆ é™¤èŠ‚ç‚¹å°±æ˜¯rootï¼Œé‚£ä¹ˆå°†å…¶å”¯ä¸€å­èŠ‚ç‚¹è®¾ç½®ä¸ºroot</span></span><br><span class="line">                root = deleteNodeChild;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isLeftChild) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å…³è”ç½®ä¸ºè¢«åˆ é™¤èŠ‚ç‚¹çš„å”¯ä¸€å­èŠ‚ç‚¹</span></span><br><span class="line">                parentNode.leftChild = deleteNodeChild;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å…³è”ç½®ä¸ºè¢«åˆ é™¤èŠ‚ç‚¹çš„å”¯ä¸€å­èŠ‚ç‚¹</span></span><br><span class="line">                parentNode.rightChild = deleteNodeChild;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¼–å†™æµ‹è¯•ç¨‹åºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTreeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BinarySearchTree bst = <span class="keyword">new</span> BinarySearchTree();</span><br><span class="line">        Arrays.asList(<span class="number">72</span>, <span class="number">57</span>, <span class="number">82</span>, <span class="number">30</span>, <span class="number">63</span>, <span class="number">79</span>, <span class="number">90</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">62</span>, <span class="number">67</span>, <span class="number">80</span>, <span class="number">87</span>, <span class="number">48</span>).forEach(key -&gt; &#123;</span><br><span class="line">            String value = <span class="string">"æˆ‘æ˜¯keyä¸º"</span> + key + <span class="string">"çš„value"</span>;</span><br><span class="line">            bst.insert(key, value);</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(bst.delete(<span class="number">79</span>));</span><br><span class="line">        System.out.println(bst.find(<span class="number">82</span>).leftChild.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><img src="img/2020å¹´12æœˆ30æ—¥16-24-53.png" alt="2020å¹´12æœˆ30æ—¥16-24-53"></p><p>ç¨‹åºè¾“å‡ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">æˆ‘æ˜¯keyä¸º80çš„value</span><br></pre></td></tr></table></figure><p></p><h4 id="è¢«åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹"><a href="#è¢«åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹" class="headerlink" title="è¢«åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹"></a>è¢«åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹</h4><p>è¿™ç§æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œåˆ é™¤çš„èŠ‚ç‚¹ä¸èƒ½ç”¨åˆ é™¤èŠ‚ç‚¹çš„æŸä¸ªå­èŠ‚ç‚¹æ¥ä»£æ›¿ã€‚æ¯”å¦‚ç°åœ¨éœ€è¦åˆ é™¤ä¸Šè¿°BSTçš„57èŠ‚ç‚¹ï¼Œå‡å¦‚ç”¨57èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹63ä»£æ›¿è¯¥èŠ‚ç‚¹ï¼Œé‚£ä¹ˆ63çš„å·¦å­èŠ‚ç‚¹æ—¢ä¸èƒ½æ˜¯62ï¼Œä¹Ÿä¸èƒ½æ˜¯57çš„å·¦å­èŠ‚ç‚¹30ã€‚</p><p>è¿™ç§æƒ…å†µä¸‹éœ€è¦æ‰¾åˆ°è¢«åˆ é™¤èŠ‚ç‚¹çš„ä¸­åºåç»§èŠ‚ç‚¹ï¼ˆsuccessorï¼‰æ¥ä»£æ›¿å®ƒã€‚æ‰€è°“çš„ä¸­åºåç»§èŠ‚ç‚¹å°±æ˜¯ï¼š<strong>æ•´ä¸ªæ ‘ä¸­å…³é”®å­—å€¼æ¯”è¢«åˆ é™¤èŠ‚ç‚¹å¤§ï¼Œå¹¶ä¸”æ¯”è¢«åˆ é™¤èŠ‚ç‚¹å³å­èŠ‚ç‚¹å°çš„é‚£éƒ¨åˆ†èŠ‚ç‚¹ä¸­çš„å…³é”®å­—å€¼æœ€å°çš„èŠ‚ç‚¹</strong>ã€‚</p><p>æ ¹æ®ä¸­åºåç»§èŠ‚ç‚¹çš„å®šä¹‰æ¥çœ‹ï¼Œè¦æ‰¾åˆ°å®ƒä¹Ÿå¾ˆç®€å•ï¼š</p><ol><li>ä»è¢«åˆ é™¤èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å‡ºå‘ï¼Œä¸€ç›´å¾€ä¸‹æ‰¾å·¦å­èŠ‚ç‚¹ï¼Œå½“è¯¥èŠ‚ç‚¹ä¸å†æœ‰å·¦å­èŠ‚ç‚¹æ—¶ï¼Œè¯¥èŠ‚ç‚¹å°±æ˜¯ä¸­åºåç»§èŠ‚ç‚¹ï¼›</li><li>å¦‚æœè¢«åˆ é™¤èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹æ²¡æœ‰å·¦å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯è¦æ‰¾çš„ä¸­åºåç»§èŠ‚ç‚¹ã€‚</li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ç°åœ¨éœ€è¦åˆ é™¤ä¸Šè¿°BSTçš„57èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ƒçš„ä¸­åºåç»§èŠ‚ç‚¹ä¸º62ï¼›å‡å¦‚è¦åˆ é™¤çš„èŠ‚ç‚¹ä¸º63ï¼Œé‚£ä¹ˆå®ƒçš„ä¸­åºåç»§ä¸º67ï¼š</p><ol><li><p>å½“åˆ é™¤çš„èŠ‚ç‚¹ä¸º57æ—¶ï¼Œè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/2020-12-31 09.42.19.gif" alt="2020-12-31 09.42.19.gif"></p></li><li><p>å½“åˆ é™¤çš„èŠ‚ç‚¹ä¸º63æ—¶ï¼Œè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/2020-12-31 09.48.23.gif" alt="2020-12-31 09.48.23.gif"></p></li></ol><p>ç¼–å†™æŸ¥æ‰¾ä¸­åºåç»§èŠ‚ç‚¹çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** BST */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** æ ¹èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line">    <span class="comment">/** èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** å…³é”®å­— */</span></span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="comment">/** é¢å¤–æºå¸¦çš„æ•°æ® */</span></span><br><span class="line">        String value;</span><br><span class="line">        <span class="comment">/** å·¦å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node leftChild;</span><br><span class="line">        <span class="comment">/** å³å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node rightChild;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥æ‰¾ä¸­åºåç»§èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">getSuccessor</span><span class="params">(Node deleteNode)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æš‚å­˜ä¸­åºåç»§èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">        Node successorParent = deleteNode;</span><br><span class="line">        <span class="comment">// æš‚å­˜ä¸­åºåç»§èŠ‚ç‚¹</span></span><br><span class="line">        Node successor = deleteNode;</span><br><span class="line">        <span class="comment">// å…ˆä»åˆ é™¤èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾</span></span><br><span class="line">        Node currentNode = deleteNode.rightChild;</span><br><span class="line">        <span class="keyword">while</span> (currentNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">            successorParent = successor;</span><br><span class="line">            successor = currentNode;</span><br><span class="line">            <span class="comment">// ä¸€ç›´å¾€ä¸‹æŸ¥æ‰¾å½“å‰èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œç›´åˆ°ä¸ºç©º</span></span><br><span class="line">            currentNode = currentNode.leftChild;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚ä¸Šé¢æ–‡ç« æ‰€è¯´ï¼Œä¸­åºåç»§èŠ‚ç‚¹å’Œåˆ é™¤èŠ‚ç‚¹æœ‰ä¸¤ç§å¯èƒ½æ€§ï¼Œ</span></span><br><span class="line">        <span class="comment">// å½“ä¸­åºåç»§èŠ‚ç‚¹ä¸æ˜¯åˆ é™¤èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹æ—¶ï¼Œéœ€è¦åšå¦‚ä¸‹é¢å¤–æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (successor != deleteNode.rightChild) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸­åºåç»§èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸ä¸ºç©ºçš„è¯ï¼Œå°†å…¶å’Œä¸­åºåç»§èŠ‚ç‚¹çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹æŒ‚é’©</span></span><br><span class="line">            <span class="keyword">if</span> (successor.rightChild != <span class="keyword">null</span>) &#123;</span><br><span class="line">                successorParent.leftChild = successor.rightChild;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä¸­åºåç»§èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å’Œåˆ é™¤èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹æŒ‚é’©</span></span><br><span class="line">            successor.rightChild = deleteNode.rightChild;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸­åºåç»§èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å’Œåˆ é™¤èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹æŒ‚é’©</span></span><br><span class="line">        successor.leftChild = deleteNode.leftChild;</span><br><span class="line">        <span class="comment">// å‰©ä¸‹çš„åˆ é™¤èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å’Œä¸­åºåç»§èŠ‚ç‚¹çš„è¿æ¥å…³ç³»åœ¨åˆ é™¤æ–¹æ³•é‡Œå¤„ç†ï¼Œ</span></span><br><span class="line">        <span class="comment">// å› ä¸ºè¿™ä¸ªæ–¹æ³•å†…æ— æ³•è·å–åˆ é™¤èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> successor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å®Œæˆåˆ é™¤æ–¹æ³•çš„æœ€åä¸€ä¸ªéƒ¨åˆ†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** BST */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** æ ¹èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line">    <span class="comment">/** èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** å…³é”®å­— */</span></span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="comment">/** é¢å¤–æºå¸¦çš„æ•°æ® */</span></span><br><span class="line">        String value;</span><br><span class="line">        <span class="comment">/** å·¦å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node leftChild;</span><br><span class="line">        <span class="comment">/** å³å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node rightChild;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* --------- æŸ¥æ‰¾éœ€è¦è¢«åˆ é™¤çš„èŠ‚ç‚¹å·²ç»å®ƒçš„çˆ¶èŠ‚ç‚¹ ------- */</span></span><br><span class="line">        <span class="comment">// ä»æ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾</span></span><br><span class="line">        Node deleteNode = root;</span><br><span class="line">        <span class="comment">// æš‚å­˜éœ€è¦è¢«åˆ é™¤èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">        Node parentNode = root;</span><br><span class="line">        <span class="comment">// æ ‡è¯†è¢«åˆ é™¤çš„èŠ‚ç‚¹æ—¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹è¿˜æ˜¯å³å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">boolean</span> isLeftChild = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// ä¸‹é¢è¿™ä¸ªè¿‡ç¨‹å’ŒæŸ¥æ‰¾ä¸€è‡´ï¼Œåªä¸è¿‡åŠ äº†isLeftChildæ ‡è¯†</span></span><br><span class="line">        <span class="keyword">while</span> (deleteNode.key != key) &#123;</span><br><span class="line">            parentNode = deleteNode;</span><br><span class="line">            <span class="keyword">if</span> (key &lt; deleteNode.key) &#123;</span><br><span class="line">                isLeftChild = <span class="keyword">true</span>;</span><br><span class="line">                deleteNode = deleteNode.leftChild;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                isLeftChild = <span class="keyword">false</span>;</span><br><span class="line">                deleteNode = deleteNode.rightChild;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœç›®æ ‡keyå¯¹åº”çš„èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™ä¸éœ€è¦åˆ é™¤ï¼Œç›´æ¥è¿”å›false</span></span><br><span class="line">            <span class="keyword">if</span> (deleteNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* --------- æƒ…å†µ1ï¼šè¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹ ------- */</span></span><br><span class="line">        <span class="keyword">if</span> (deleteNode.leftChild == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; deleteNode.rightChild == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (deleteNode == root) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„èŠ‚ç‚¹ä¸ºrootï¼Œåˆ™ç›´æ¥å°†rootèŠ‚ç‚¹è®¾ç½®ä¸ºnull</span></span><br><span class="line">                root = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isLeftChild) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å…³è”ç½®ä¸ºnull</span></span><br><span class="line">                parentNode.leftChild = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å…³è”ç½®ä¸ºnull</span></span><br><span class="line">                parentNode.rightChild = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (deleteNode.leftChild != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; deleteNode.rightChild != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">/* --------- æƒ…å†µ3ï¼šè¢«åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ ------- */</span></span><br><span class="line">            <span class="comment">// è·å–åˆ é™¤èŠ‚ç‚¹çš„ä¸­åºåç»§èŠ‚ç‚¹</span></span><br><span class="line">            Node successor = getSuccessor(deleteNode);</span><br><span class="line">            <span class="comment">// å¦‚æœä¼¤å¤„èŠ‚ç‚¹å°±æ˜¯æ ¹èŠ‚ç‚¹çš„è¯ï¼Œä¸­åºåç»§èŠ‚ç‚¹ç›´æ¥æˆä¸ºæ–°çš„æ ¹</span></span><br><span class="line">            <span class="keyword">if</span> (deleteNode == root) &#123;</span><br><span class="line">                root = successor;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isLeftChild) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœåˆ é™¤èŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å’Œä¸­åºåç»§èŠ‚ç‚¹æŒ‚é’©</span></span><br><span class="line">                parentNode.leftChild = successor;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœåˆ é™¤èŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å’Œä¸­åºåç»§èŠ‚ç‚¹æŒ‚é’©</span></span><br><span class="line">                parentNode.rightChild = successor;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* --------- æƒ…å†µ2ï¼šè¢«åˆ é™¤çš„èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ ------- */</span></span><br><span class="line">            <span class="comment">// è·å–è¢«åˆ é™¤èŠ‚ç‚¹çš„å”¯ä¸€å­èŠ‚ç‚¹</span></span><br><span class="line">            Node deleteNodeChild = deleteNode.leftChild == <span class="keyword">null</span> ?</span><br><span class="line">                    deleteNode.rightChild : deleteNode.leftChild;</span><br><span class="line">            <span class="keyword">if</span> (deleteNode == root) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¢«åˆ é™¤èŠ‚ç‚¹å°±æ˜¯rootï¼Œé‚£ä¹ˆå°†å…¶å”¯ä¸€å­èŠ‚ç‚¹è®¾ç½®ä¸ºroot</span></span><br><span class="line">                root = deleteNodeChild;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isLeftChild) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å…³è”ç½®ä¸ºè¢«åˆ é™¤èŠ‚ç‚¹çš„å”¯ä¸€å­èŠ‚ç‚¹</span></span><br><span class="line">                parentNode.leftChild = deleteNodeChild;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å…³è”ç½®ä¸ºè¢«åˆ é™¤èŠ‚ç‚¹çš„å”¯ä¸€å­èŠ‚ç‚¹</span></span><br><span class="line">                parentNode.rightChild = deleteNodeChild;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¼–å†™æµ‹è¯•ç¨‹åºæµ‹è¯•ä¸€ä¸‹ï¼š</p><p>å½“åˆ é™¤çš„èŠ‚ç‚¹ä¸º57æ—¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTreeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BinarySearchTree bst = <span class="keyword">new</span> BinarySearchTree();</span><br><span class="line">        Arrays.asList(<span class="number">72</span>, <span class="number">57</span>, <span class="number">82</span>, <span class="number">30</span>, <span class="number">63</span>, <span class="number">79</span>, <span class="number">90</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">62</span>, <span class="number">67</span>, <span class="number">80</span>, <span class="number">87</span>, <span class="number">48</span>).forEach(key -&gt; &#123;</span><br><span class="line">            String value = <span class="string">"æˆ‘æ˜¯keyä¸º"</span> + key + <span class="string">"çš„value"</span>;</span><br><span class="line">            bst.insert(key, value);</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(<span class="string">"åˆ é™¤57èŠ‚ç‚¹: "</span> + bst.delete(<span class="number">57</span>));</span><br><span class="line">        System.out.println(<span class="string">"72èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸º: "</span> + bst.find(<span class="number">72</span>).leftChild.key);</span><br><span class="line">        BinarySearchTree.Node node62 = bst.find(<span class="number">62</span>);</span><br><span class="line">        System.out.println(<span class="string">"62èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸º: "</span> + node62.leftChild.key);</span><br><span class="line">        System.out.println(<span class="string">"62èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸º: "</span> + node62.rightChild.key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åˆ é™¤57èŠ‚ç‚¹: true</span><br><span class="line">72èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸º: 62</span><br><span class="line">62èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸º: 30</span><br><span class="line">62èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸º: 63</span><br></pre></td></tr></table></figure><p></p><p><img src="img/2020å¹´12æœˆ31æ—¥09-57-35.png" alt="2020å¹´12æœˆ31æ—¥09-57-35"></p><p>å½“åˆ é™¤çš„èŠ‚ç‚¹ä¸º63æ—¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTreeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BinarySearchTree bst = <span class="keyword">new</span> BinarySearchTree();</span><br><span class="line">        Arrays.asList(<span class="number">72</span>, <span class="number">57</span>, <span class="number">82</span>, <span class="number">30</span>, <span class="number">63</span>, <span class="number">79</span>, <span class="number">90</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">62</span>, <span class="number">67</span>, <span class="number">80</span>, <span class="number">87</span>, <span class="number">48</span>).forEach(key -&gt; &#123;</span><br><span class="line">            String value = <span class="string">"æˆ‘æ˜¯keyä¸º"</span> + key + <span class="string">"çš„value"</span>;</span><br><span class="line">            bst.insert(key, value);</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(<span class="string">"åˆ é™¤63èŠ‚ç‚¹: "</span> + bst.delete(<span class="number">63</span>));</span><br><span class="line">        System.out.println(<span class="string">"57èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸º: "</span> + bst.find(<span class="number">57</span>).rightChild.key);</span><br><span class="line">        BinarySearchTree.Node node67 = bst.find(<span class="number">67</span>);</span><br><span class="line">        System.out.println(<span class="string">"67èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸º: "</span> + node67.leftChild.key);</span><br><span class="line">        System.out.println(<span class="string">"67èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸º: "</span> + (node67.rightChild == <span class="keyword">null</span> ? <span class="keyword">null</span> : node67.rightChild.key));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åˆ é™¤63èŠ‚ç‚¹: true</span><br><span class="line">57èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸º: 67</span><br><span class="line">67èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸º: 62</span><br><span class="line">67èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸º: null</span><br></pre></td></tr></table></figure><p></p><p><img src="img/2020å¹´12æœˆ31æ—¥10-04-25.png" alt="2020å¹´12æœˆ31æ—¥10-04-25"></p><h3 id="éå†"><a href="#éå†" class="headerlink" title="éå†"></a>éå†</h3><p>éå†æ ‘æŒ‡çš„æ˜¯ä»¥ä¸€ç§ç‰¹å®šé¡ºåºè®¿é—®æ ‘çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™ä¸ªé¡ºåºåˆ†ä¸ºï¼šä¸­åºã€å‰åºå’Œååºã€‚</p><h4 id="ä¸­åºéå†"><a href="#ä¸­åºéå†" class="headerlink" title="ä¸­åºéå†"></a>ä¸­åºéå†</h4><p>ä¸­åºéå†çš„æ­¥éª¤ä¸ºï¼š</p><ol><li>é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼›</li><li>è®¿é—®ç›®æ ‡èŠ‚ç‚¹æœ¬èº«ï¼›</li><li>é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ã€‚</li></ol><p>Javaå®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** BST */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** æ ¹èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** éå†éœ€è¦ä»æ ¹å¼€å§‹éå†ï¼Œæ‰€ä»¥æ·»åŠ æ ¹çš„getæ–¹æ³• */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">getRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** å…³é”®å­— */</span></span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="comment">/** é¢å¤–æºå¸¦çš„æ•°æ® */</span></span><br><span class="line">        String value;</span><br><span class="line">        <span class="comment">/** å·¦å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node leftChild;</span><br><span class="line">        <span class="comment">/** å³å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node rightChild;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ä¸­åºéå† */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inOrder</span><span class="params">(Node targetNode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (targetNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">            inOrder(targetNode.leftChild);</span><br><span class="line">            <span class="comment">// è®¿é—®ç›®æ ‡èŠ‚ç‚¹æœ¬èº«</span></span><br><span class="line">            System.out.print(targetNode.key + <span class="string">" "</span>);</span><br><span class="line">            <span class="comment">// é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">            inOrder(targetNode.rightChild);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¼–å†™æµ‹è¯•ç¨‹åºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTreeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BinarySearchTree bst = <span class="keyword">new</span> BinarySearchTree();</span><br><span class="line">        Arrays.asList(<span class="number">72</span>, <span class="number">57</span>, <span class="number">82</span>, <span class="number">30</span>, <span class="number">63</span>, <span class="number">79</span>, <span class="number">90</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">62</span>, <span class="number">67</span>, <span class="number">80</span>, <span class="number">87</span>, <span class="number">48</span>).forEach(key -&gt; &#123;</span><br><span class="line">            String value = <span class="string">"æˆ‘æ˜¯keyä¸º"</span> + key + <span class="string">"çš„value"</span>;</span><br><span class="line">            bst.insert(key, value);</span><br><span class="line">        &#125;);</span><br><span class="line">        bst.inOrder(bst.getRoot());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">27 30 40 48 57 62 63 67 72 79 80 82 87 90</span><br></pre></td></tr></table></figure><p></p><p>è¿™ä¸ªè¿‡ç¨‹å¦‚ä¸‹åŠ¨å›¾æ‰€ç¤ºï¼š</p><p><img src="img/2020-12-31 10.25.02.gif" alt="2020-12-31 10.25.02.gif"></p><h4 id="å‰åºéå†"><a href="#å‰åºéå†" class="headerlink" title="å‰åºéå†"></a>å‰åºéå†</h4><p>å‰åºéå†çš„æ­¥éª¤ä¸ºï¼š</p><ol><li>è®¿é—®ç›®æ ‡èŠ‚ç‚¹æœ¬èº«ï¼›</li><li>é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼›</li><li>é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ã€‚</li></ol><p>Javaå®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** BST */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** æ ¹èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** éå†éœ€è¦ä»æ ¹å¼€å§‹éå†ï¼Œæ‰€ä»¥æ·»åŠ æ ¹çš„getæ–¹æ³• */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">getRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** å…³é”®å­— */</span></span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="comment">/** é¢å¤–æºå¸¦çš„æ•°æ® */</span></span><br><span class="line">        String value;</span><br><span class="line">        <span class="comment">/** å·¦å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node leftChild;</span><br><span class="line">        <span class="comment">/** å³å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node rightChild;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** å‰åºéå† */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preOrder</span><span class="params">(Node targetNode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (targetNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è®¿é—®ç›®æ ‡èŠ‚ç‚¹æœ¬èº«</span></span><br><span class="line">            System.out.print(targetNode.key + <span class="string">" "</span>);</span><br><span class="line">            <span class="comment">// é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">            preOrder(targetNode.leftChild);</span><br><span class="line">            <span class="comment">// é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">            preOrder(targetNode.rightChild);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¼–å†™æµ‹è¯•ç¨‹åºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTreeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BinarySearchTree bst = <span class="keyword">new</span> BinarySearchTree();</span><br><span class="line">        Arrays.asList(<span class="number">72</span>, <span class="number">57</span>, <span class="number">82</span>, <span class="number">30</span>, <span class="number">63</span>, <span class="number">79</span>, <span class="number">90</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">62</span>, <span class="number">67</span>, <span class="number">80</span>, <span class="number">87</span>, <span class="number">48</span>).forEach(key -&gt; &#123;</span><br><span class="line">            String value = <span class="string">"æˆ‘æ˜¯keyä¸º"</span> + key + <span class="string">"çš„value"</span>;</span><br><span class="line">            bst.insert(key, value);</span><br><span class="line">        &#125;);</span><br><span class="line">        bst.preOrder(bst.getRoot());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">72 57 30 27 40 48 63 62 67 82 79 80 90 87</span><br></pre></td></tr></table></figure><p></p><p>è¿™ä¸ªè¿‡ç¨‹å¦‚ä¸‹åŠ¨å›¾æ‰€ç¤ºï¼š</p><p><img src="img/2020-12-31 10.48.18.gif" alt="2020-12-31 10.48.18.gif"></p><h4 id="ååºéå†"><a href="#ååºéå†" class="headerlink" title="ååºéå†"></a>ååºéå†</h4><p>å‰åºéå†çš„æ­¥éª¤ä¸ºï¼š</p><ol><li>é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼›</li><li>é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼›</li><li>è®¿é—®ç›®æ ‡èŠ‚ç‚¹æœ¬èº«ã€‚</li></ol><p>Javaå®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** BST */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** æ ¹èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** éå†éœ€è¦ä»æ ¹å¼€å§‹éå†ï¼Œæ‰€ä»¥æ·»åŠ æ ¹çš„getæ–¹æ³• */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">getRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** å…³é”®å­— */</span></span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="comment">/** é¢å¤–æºå¸¦çš„æ•°æ® */</span></span><br><span class="line">        String value;</span><br><span class="line">        <span class="comment">/** å·¦å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node leftChild;</span><br><span class="line">        <span class="comment">/** å³å­èŠ‚ç‚¹ */</span></span><br><span class="line">        Node rightChild;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** åç»­éå† */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postOrder</span><span class="params">(Node targetNode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (targetNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">            postOrder(targetNode.leftChild);</span><br><span class="line">            <span class="comment">// é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">            postOrder(targetNode.rightChild);</span><br><span class="line">            <span class="comment">// è®¿é—®ç›®æ ‡èŠ‚ç‚¹æœ¬èº«</span></span><br><span class="line">            System.out.print(targetNode.key + <span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¼–å†™æµ‹è¯•ç¨‹åºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTreeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BinarySearchTree bst = <span class="keyword">new</span> BinarySearchTree();</span><br><span class="line">        Arrays.asList(<span class="number">72</span>, <span class="number">57</span>, <span class="number">82</span>, <span class="number">30</span>, <span class="number">63</span>, <span class="number">79</span>, <span class="number">90</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">62</span>, <span class="number">67</span>, <span class="number">80</span>, <span class="number">87</span>, <span class="number">48</span>).forEach(key -&gt; &#123;</span><br><span class="line">            String value = <span class="string">"æˆ‘æ˜¯keyä¸º"</span> + key + <span class="string">"çš„value"</span>;</span><br><span class="line">            bst.insert(key, value);</span><br><span class="line">        &#125;);</span><br><span class="line">        bst.postOrder(bst.getRoot());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">27 48 40 30 62 67 63 57 80 79 87 90 82 72</span><br></pre></td></tr></table></figure><p></p><p>è¿™ä¸ªè¿‡ç¨‹å¦‚ä¸‹åŠ¨å›¾æ‰€ç¤ºï¼š</p><p><img src="img/2020-12-31 10.52.00.gif" alt="2020-12-31 10.52.00.gif"></p><h3 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BST</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchTree</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éå†éœ€è¦ä»æ ¹å¼€å§‹éå†ï¼Œæ‰€ä»¥æ·»åŠ æ ¹çš„getæ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">getRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ’å…¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹</span></span><br><span class="line">        Node newNode = <span class="keyword">new</span> Node(key, value);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ ¹ä¸ºnullï¼Œåˆ™è¿™ä¸ªæ–°èŠ‚ç‚¹å°±æ˜¯æ ¹</span></span><br><span class="line">            root = newNode;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœè·Ÿä¸ä¸ºnullï¼Œåˆ™ä»æ ¹å¼€å§‹æœç´¢æ’å…¥ä½ç½®</span></span><br><span class="line">            Node currentNode = root;</span><br><span class="line">            <span class="comment">// ç”¨äºæš‚å­˜çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">            Node parentNode;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                parentNode = currentNode;</span><br><span class="line">                <span class="keyword">if</span> (key &lt; currentNode.key) &#123;</span><br><span class="line">                    currentNode = currentNode.leftChild;</span><br><span class="line">                    <span class="keyword">if</span> (currentNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// å¦‚æœkeyå°äºå½“å‰èŠ‚ç‚¹keyï¼Œå¹¶ä¸”å½“å‰èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™å°†æ–°èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="comment">// è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ï¼ˆçˆ¶èŠ‚ç‚¹æš‚å­˜å¯¹è±¡ï¼‰çš„å·¦å­èŠ‚ç‚¹ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                        parentNode.leftChild = newNode;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key &gt; currentNode.key) &#123;</span><br><span class="line">                    currentNode = currentNode.rightChild;</span><br><span class="line">                    <span class="keyword">if</span> (currentNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// å¦‚æœkeyå¤§äºå½“å‰èŠ‚ç‚¹keyï¼Œå¹¶ä¸”å½“å‰èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™å°†æ–°èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="comment">// è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ï¼ˆçˆ¶èŠ‚ç‚¹æš‚å­˜å¯¹è±¡ï¼‰çš„åˆå­èŠ‚ç‚¹ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                        parentNode.rightChild = newNode;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœkeyç­‰äºå½“å‰èŠ‚ç‚¹keyï¼Œåˆ™å°†valueè¦†ç›–å½“å‰èŠ‚ç‚¹value</span></span><br><span class="line">                    currentNode.value = newNode.value;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥æ‰¾</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">find</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä»æ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾</span></span><br><span class="line">        Node currentNode = root;</span><br><span class="line">        <span class="comment">// å½“å‰èŠ‚ç‚¹çš„keyä¸ç­‰äºè¢«æŸ¥æ‰¾çš„keyæ—¶</span></span><br><span class="line">        <span class="keyword">while</span> (currentNode.key != key) &#123;</span><br><span class="line">            <span class="keyword">if</span> (key &lt; currentNode.key) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœkeyå€¼å°äºå½“å‰èŠ‚ç‚¹keyï¼Œåˆ™æŸ¥æ‰¾å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">                currentNode = currentNode.leftChild;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœkeyå€¼å¤§äºç­‰äºå½“å‰èŠ‚ç‚¹keyï¼Œåˆ™æŸ¥æ‰¾å³å­èŠ‚ç‚¹</span></span><br><span class="line">                currentNode = currentNode.rightChild;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºnullï¼Œè¯´æ˜æŸ¥åˆ°å¶å­èŠ‚ç‚¹äº†ï¼Œä»æ²¡æŸ¥åˆ°ç›®æ ‡keyï¼Œåˆ™ç›´æ¥è¿”å›null</span></span><br><span class="line">            <span class="keyword">if</span> (currentNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›å½“å‰èŠ‚ç‚¹ï¼ˆé€€å‡ºwhileå¾ªç¯è¦ä¹ˆkeyç›¸ç­‰ï¼Œè¦ä¹ˆæ²¡æ‰¾åˆ°ï¼Œç»“æœä¸ºnullï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> currentNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ€å°å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">min</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node currentNode = root;</span><br><span class="line">        <span class="keyword">while</span> (currentNode.leftChild != <span class="keyword">null</span>) &#123;</span><br><span class="line">            currentNode = currentNode.leftChild;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ€å¤§å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">max</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node currentNode = root;</span><br><span class="line">        <span class="keyword">while</span> (currentNode.rightChild != <span class="keyword">null</span>) &#123;</span><br><span class="line">            currentNode = currentNode.rightChild;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* --------- æŸ¥æ‰¾éœ€è¦è¢«åˆ é™¤çš„èŠ‚ç‚¹å·²ç»å®ƒçš„çˆ¶èŠ‚ç‚¹ ------- */</span></span><br><span class="line">        <span class="comment">// ä»æ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾</span></span><br><span class="line">        Node deleteNode = root;</span><br><span class="line">        <span class="comment">// æš‚å­˜éœ€è¦è¢«åˆ é™¤èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">        Node parentNode = root;</span><br><span class="line">        <span class="comment">// æ ‡è¯†è¢«åˆ é™¤çš„èŠ‚ç‚¹æ—¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹è¿˜æ˜¯å³å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">boolean</span> isLeftChild = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// ä¸‹é¢è¿™ä¸ªè¿‡ç¨‹å’ŒæŸ¥æ‰¾ä¸€è‡´ï¼Œåªä¸è¿‡åŠ äº†isLeftChildæ ‡è¯†</span></span><br><span class="line">        <span class="keyword">while</span> (deleteNode.key != key) &#123;</span><br><span class="line">            parentNode = deleteNode;</span><br><span class="line">            <span class="keyword">if</span> (key &lt; deleteNode.key) &#123;</span><br><span class="line">                isLeftChild = <span class="keyword">true</span>;</span><br><span class="line">                deleteNode = deleteNode.leftChild;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                isLeftChild = <span class="keyword">false</span>;</span><br><span class="line">                deleteNode = deleteNode.rightChild;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœç›®æ ‡keyå¯¹åº”çš„èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™ä¸éœ€è¦åˆ é™¤ï¼Œç›´æ¥è¿”å›false</span></span><br><span class="line">            <span class="keyword">if</span> (deleteNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* --------- æƒ…å†µ1ï¼šè¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹ ------- */</span></span><br><span class="line">        <span class="keyword">if</span> (deleteNode.leftChild == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; deleteNode.rightChild == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (deleteNode == root) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„èŠ‚ç‚¹ä¸ºrootï¼Œåˆ™ç›´æ¥å°†rootèŠ‚ç‚¹è®¾ç½®ä¸ºnull</span></span><br><span class="line">                root = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isLeftChild) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å…³è”ç½®ä¸ºnull</span></span><br><span class="line">                parentNode.leftChild = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å…³è”ç½®ä¸ºnull</span></span><br><span class="line">                parentNode.rightChild = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (deleteNode.leftChild != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; deleteNode.rightChild != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">/* --------- æƒ…å†µ3ï¼šè¢«åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ ------- */</span></span><br><span class="line">            <span class="comment">// è·å–åˆ é™¤èŠ‚ç‚¹çš„ä¸­åºåç»§èŠ‚ç‚¹</span></span><br><span class="line">            Node successor = getSuccessor(deleteNode);</span><br><span class="line">            <span class="comment">// å¦‚æœä¼¤å¤„èŠ‚ç‚¹å°±æ˜¯æ ¹èŠ‚ç‚¹çš„è¯ï¼Œä¸­åºåç»§èŠ‚ç‚¹ç›´æ¥æˆä¸ºæ–°çš„æ ¹</span></span><br><span class="line">            <span class="keyword">if</span> (deleteNode == root) &#123;</span><br><span class="line">                root = successor;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isLeftChild) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœåˆ é™¤èŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å’Œä¸­åºåç»§èŠ‚ç‚¹æŒ‚é’©</span></span><br><span class="line">                parentNode.leftChild = successor;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœåˆ é™¤èŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å’Œä¸­åºåç»§èŠ‚ç‚¹æŒ‚é’©</span></span><br><span class="line">                parentNode.rightChild = successor;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* --------- æƒ…å†µ2ï¼šè¢«åˆ é™¤çš„èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ ------- */</span></span><br><span class="line">            <span class="comment">// è·å–è¢«åˆ é™¤èŠ‚ç‚¹çš„å”¯ä¸€å­èŠ‚ç‚¹</span></span><br><span class="line">            Node deleteNodeChild = deleteNode.leftChild == <span class="keyword">null</span> ?</span><br><span class="line">                    deleteNode.rightChild : deleteNode.leftChild;</span><br><span class="line">            <span class="keyword">if</span> (deleteNode == root) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¢«åˆ é™¤èŠ‚ç‚¹å°±æ˜¯rootï¼Œé‚£ä¹ˆå°†å…¶å”¯ä¸€å­èŠ‚ç‚¹è®¾ç½®ä¸ºroot</span></span><br><span class="line">                root = deleteNodeChild;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isLeftChild) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å…³è”ç½®ä¸ºè¢«åˆ é™¤èŠ‚ç‚¹çš„å”¯ä¸€å­èŠ‚ç‚¹</span></span><br><span class="line">                parentNode.leftChild = deleteNodeChild;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¦åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œåˆ™å°†çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å…³è”ç½®ä¸ºè¢«åˆ é™¤èŠ‚ç‚¹çš„å”¯ä¸€å­èŠ‚ç‚¹</span></span><br><span class="line">                parentNode.rightChild = deleteNodeChild;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ä¸­åºéå† */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inOrder</span><span class="params">(Node targetNode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (targetNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">            inOrder(targetNode.leftChild);</span><br><span class="line">            <span class="comment">// è®¿é—®ç›®æ ‡èŠ‚ç‚¹æœ¬èº«</span></span><br><span class="line">            System.out.print(targetNode.key + <span class="string">" "</span>);</span><br><span class="line">            <span class="comment">// é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">            inOrder(targetNode.rightChild);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** å‰åºéå† */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preOrder</span><span class="params">(Node targetNode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (targetNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è®¿é—®ç›®æ ‡èŠ‚ç‚¹æœ¬èº«</span></span><br><span class="line">            System.out.print(targetNode.key + <span class="string">" "</span>);</span><br><span class="line">            <span class="comment">// é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">            preOrder(targetNode.leftChild);</span><br><span class="line">            <span class="comment">// é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">            preOrder(targetNode.rightChild);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** åç»­éå† */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postOrder</span><span class="params">(Node targetNode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (targetNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">            postOrder(targetNode.leftChild);</span><br><span class="line">            <span class="comment">// é€’å½’éå†ç›®æ ‡èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">            postOrder(targetNode.rightChild);</span><br><span class="line">            <span class="comment">// è®¿é—®ç›®æ ‡èŠ‚ç‚¹æœ¬èº«</span></span><br><span class="line">            System.out.print(targetNode.key + <span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥æ‰¾ä¸­åºåç»§èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">getSuccessor</span><span class="params">(Node deleteNode)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æš‚å­˜ä¸­åºåç»§èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">        Node successorParent = deleteNode;</span><br><span class="line">        <span class="comment">// æš‚å­˜ä¸­åºåç»§èŠ‚ç‚¹</span></span><br><span class="line">        Node successor = deleteNode;</span><br><span class="line">        <span class="comment">// å…ˆä»åˆ é™¤èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾</span></span><br><span class="line">        Node currentNode = deleteNode.rightChild;</span><br><span class="line">        <span class="keyword">while</span> (currentNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">            successorParent = successor;</span><br><span class="line">            successor = currentNode;</span><br><span class="line">            <span class="comment">// ä¸€ç›´å¾€ä¸‹æŸ¥æ‰¾å½“å‰èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œç›´åˆ°ä¸ºç©º</span></span><br><span class="line">            currentNode = currentNode.leftChild;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚ä¸Šé¢æ–‡ç« æ‰€è¯´ï¼Œä¸­åºåç»§èŠ‚ç‚¹å’Œåˆ é™¤èŠ‚ç‚¹æœ‰ä¸¤ç§å¯èƒ½æ€§ï¼Œ</span></span><br><span class="line">        <span class="comment">// å½“ä¸­åºåç»§èŠ‚ç‚¹ä¸æ˜¯åˆ é™¤èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹æ—¶ï¼Œéœ€è¦åšå¦‚ä¸‹é¢å¤–æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (successor != deleteNode.rightChild) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸­åºåç»§èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸ä¸ºç©ºçš„è¯ï¼Œå°†å…¶å’Œä¸­åºåç»§èŠ‚ç‚¹çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹æŒ‚é’©</span></span><br><span class="line">            <span class="keyword">if</span> (successor.rightChild != <span class="keyword">null</span>) &#123;</span><br><span class="line">                successorParent.leftChild = successor.rightChild;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä¸­åºåç»§èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å’Œåˆ é™¤èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹æŒ‚é’©</span></span><br><span class="line">            successor.rightChild = deleteNode.rightChild;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸­åºåç»§èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å’Œåˆ é™¤èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹æŒ‚é’©</span></span><br><span class="line">        successor.leftChild = deleteNode.leftChild;</span><br><span class="line">        <span class="comment">// å‰©ä¸‹çš„åˆ é™¤èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å’Œä¸­åºåç»§èŠ‚ç‚¹çš„è¿æ¥å…³ç³»åœ¨åˆ é™¤æ–¹æ³•é‡Œå¤„ç†ï¼Œ</span></span><br><span class="line">        <span class="comment">// å› ä¸ºè¿™ä¸ªæ–¹æ³•å†…æ— æ³•è·å–åˆ é™¤èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> successor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å…³é”®å­—</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * é¢å¤–æºå¸¦çš„æ•°æ®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String value;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å·¦å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Node leftChild;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å³å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Node rightChild;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="BSTæ•ˆç‡"><a href="#BSTæ•ˆç‡" class="headerlink" title="BSTæ•ˆç‡"></a>BSTæ•ˆç‡</h2><p>èŠ‚ç‚¹çš„æŸ¥æ‰¾éœ€è¦ä»æ ¹èŠ‚ç‚¹å¼€å§‹ä¸€å±‚ä¸€å±‚å¾€ä¸‹æ‰¾ï¼Œæ ‘èŠ‚ç‚¹æ•°å’Œå±‚æ•°çš„å…³ç³»å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><tr><th style="width:50%">èŠ‚ç‚¹æ•°</th><th>å±‚æ•°</th></tr><tr><td>1</td><td>1</td></tr><tr><td>3</td><td>2</td></tr><tr><td>7</td><td>3</td></tr><tr><td>15</td><td>4</td></tr><tr><td>31</td><td>5</td></tr><tr><td>â€¦</td><td>â€¦</td></tr><tr><td>1023</td><td>10</td></tr><tr><td>â€¦</td><td>â€¦</td></tr><tr><td>32767</td><td>15</td></tr><tr><td>â€¦</td><td>â€¦</td></tr><tr><td>1048575</td><td>20</td></tr><tr><td>â€¦</td><td>â€¦</td></tr><tr><td>33554432</td><td>25</td></tr><tr><td>â€¦</td><td>â€¦</td></tr><tr><td>1073741824</td><td>30</td></tr></table><p>å‡è®¾èŠ‚ç‚¹æ•°ä¸ºNï¼Œå±‚æ•°ä¸ºLï¼Œé‚£ä¹ˆä¸éš¾çœ‹å‡ºå®ƒä»¬çš„å…³ç³»ä¸ºï¼šN=2^(L-1)ï¼Œæ‰€ä»¥L=log2(N+1)ï¼Œå¤§çº¦ä¸ºlog2Nï¼Œå¤§Oè¡¨ç¤ºæ³•ä¸ºO(logN)ã€‚</p><h2 id="çº¢é»‘æ ‘"><a href="#çº¢é»‘æ ‘" class="headerlink" title="çº¢é»‘æ ‘"></a>çº¢é»‘æ ‘</h2><h3 id="BSTçš„ç¼ºé™·"><a href="#BSTçš„ç¼ºé™·" class="headerlink" title="BSTçš„ç¼ºé™·"></a>BSTçš„ç¼ºé™·</h3><p>è™½ç„¶BSTç»“åˆäº†æ•°ç»„å’Œé“¾è¡¨çš„ä¼˜åŠ¿ï¼Œä½†å®ƒä¹Ÿä¸æ˜¯å®Œç¾çš„ï¼Œå½“BSTä¸å¹³è¡¡çš„æ—¶å€™ï¼ŒæŸ¥æ‰¾æ“ä½œæ•ˆç‡æ€¥å‰§ä¸‹é™ã€‚ä¸¾ä¸ªæ¯”è¾ƒæç«¯çš„ä¾‹å­ï¼š</p><p>å‡å¦‚æ’å…¥çš„æ•°æ®æ˜¯å‡åºæ•°æ®ï¼š2ï¼Œ4ï¼Œ6ï¼Œ8ï¼Œ10ï¼Œ12â€¦ï¼Œè¿™æ—¶å€™BSTå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20210105-181845@2x.png" alt="QQ20210105-181845@2x"></p><p>è¿™æ—¶å€™BSTå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„äº†ï¼Œæœç´¢æ•ˆç‡ä¸ºO(N)ã€‚ä¸€ä¸ªBSTå®Œå…¨å¹³è¡¡å’Œå®Œå…¨ä¸å¹³è¡¡çš„æƒ…å†µæ¯”è¾ƒå°‘è§ï¼Œå°±æ¦‚ç‡æ¥è¯´ï¼ŒBSTçš„æœç´¢æ•ˆç‡ä»‹äºO(N)ä¸O(logN)ä¹‹é—´ã€‚</p><h3 id="çº¢é»‘æ ‘è§„åˆ™"><a href="#çº¢é»‘æ ‘è§„åˆ™" class="headerlink" title="çº¢é»‘æ ‘è§„åˆ™"></a>çº¢é»‘æ ‘è§„åˆ™</h3><p>ä¸ºäº†è§£å†³éå¹³è¡¡æ ‘æœç´¢æ•ˆç‡ä¸‹é™çš„é—®é¢˜ï¼Œäººä»¬åˆæå‡ºäº†çº¢é»‘æ ‘çš„æ¦‚å¿µã€‚åœ¨çº¢é»‘æ ‘ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹è¦ä¹ˆæ˜¯çº¢è‰²çš„è¦ä¹ˆæ˜¯é»‘è‰²çš„ï¼Œçº¢é»‘æ ‘åœ¨æ’å…¥å’Œåˆ é™¤çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦éµå¾ªæŸäº›ç‰¹å®šçš„è§„åˆ™ï¼Œéµå¾ªè¿™äº›è§„åˆ™å¯ä»¥ç¡®ä¿æ•°å§‹ç»ˆæ˜¯è¶‹äºå¹³è¡¡çš„ã€‚</p><p>çº¢é»‘æ ‘é™¤äº†éµå¾ªåŸºæœ¬çš„BSTè§„åˆ™å¤–ï¼Œè¿˜éœ€éµå¾ªä»¥ä¸‹4ä¸ªè§„åˆ™ï¼š</p><ol><li>æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯çº¢è‰²å°±æ˜¯é»‘è‰²ï¼›</li><li>æ ¹èŠ‚ç‚¹ä¸€å®šæ˜¯é»‘è‰²çš„ï¼›</li><li>å¦‚æœèŠ‚ç‚¹æ—¶çº¢è‰²çš„ï¼Œé‚£ä¹ˆå®ƒçš„å­èŠ‚ç‚¹å¿…é¡»éƒ½æ˜¯é»‘è‰²çš„ï¼›</li><li>ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹æˆ–ç©ºå­èŠ‚ç‚¹çš„æ¯æ¡è·¯å¾„ï¼Œå¿…é¡»åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ã€‚</li></ol><p>åœ¨æ•°æ®æ’å…¥å’Œåˆ é™¤è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¿èƒŒäº†ä¸Šè¿°4ä¸ªè§„åˆ™ï¼Œåˆ™æ ‘ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œè¿›è¡Œä¿®æ­£ï¼Œä»¥é‡æ–°æ»¡è¶³ä¸Šè¿°4ä¸ªè§„åˆ™ï¼š</p><ol><li>æ”¹å˜èŠ‚ç‚¹çš„é¢œè‰²ï¼›</li><li>æ‰§è¡Œæ—‹è½¬æ“ä½œã€‚</li></ol><h3 id="çº¢é»‘æ ‘æ¼”ç¤º"><a href="#çº¢é»‘æ ‘æ¼”ç¤º" class="headerlink" title="çº¢é»‘æ ‘æ¼”ç¤º"></a>çº¢é»‘æ ‘æ¼”ç¤º</h3><p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªåŠ¨å›¾æ¼”ç¤ºçº¢é»‘æ ‘å¦‚ä½•å¤„ç†å‡åºæ•°æ®ï¼š2ï¼Œ4ï¼Œ6ï¼Œ8ï¼Œ10ï¼Œ12çš„æ’å…¥ï¼Œä½¿å¾—æ ‘è¶‹äºå¹³è¡¡ï¼š</p><p><img src="img/2021-01-05 18.38.43.gif" alt="2021-01-05 18.38.43.gif"></p><blockquote><p>å‚è€ƒè‡ªã€ŠJavaæ•°æ®ç»“æ„ä¸ç®—æ³•ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ï¼Œä¸Šè¿°BSTå›¾ç‰‡å‡æ¥è‡ª<a href="http://btv.melezinek.cz/binary-search-tree.html" target="_blank" rel="noopener">http://btv.melezinek.cz/binary-search-tree.html</a>ç½‘ç«™ï¼Œçº¢é»‘æ ‘ç¤ºä¾‹æ¥è‡ª<a href="https://www.wztlink1013.com/visualization/RedBlack.html" target="_blank" rel="noopener">https://www.wztlink1013.com/visualization/RedBlack.html</a>ã€‚</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;æ ‘ï¼ˆTreeï¼‰æ˜¯ä¸€ç§å¾ˆæœ‰è¶£çš„æ•°æ®ç»“æ„ï¼Œå®ƒæ—¢èƒ½åƒé“¾è¡¨é‚£æ ·å¿«é€Ÿçš„æ’å…¥å’Œåˆ é™¤ï¼Œåˆèƒ½åƒæœ‰åºæ•°ç»„é‚£æ ·å¿«é€ŸæŸ¥æ‰¾ã€‚æ ‘çš„ç§ç±»å¾ˆå¤šï¼Œæœ¬èŠ‚å°†è®°å½•ä¸€ç§ç‰¹æ®Šçš„æ ‘â€”â€”â€”â€”äºŒå‰æ ‘ï¼ˆBinary Treeï¼‰ã€‚äºŒå‰æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šåªèƒ½æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œé€šå¸¸ç§°ä¸ºå·¦å­èŠ‚ç‚¹å’Œå³å­èŠ‚ç‚¹ã€‚å¦‚æœä¸€ä¸ªäºŒå‰æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹çš„å…³é”®å­—å€¼å°äºè¯¥èŠ‚ç‚¹ï¼Œå³å­èŠ‚ç‚¹çš„å…³é”®å­—å€¼å¤§äºç­‰äºè¯¥èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™ç§äºŒå‰æ ‘ä¹Ÿç§°ä¸ºäºŒå‰æœç´¢æ ‘ï¼ˆBinary Search Tree,&lt;strong&gt;BST&lt;/strong&gt;ï¼‰ï¼Œæœ¬èŠ‚ä¸»è¦å…³æ³¨BSTã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://mrbird.cc/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="ç®—æ³•" scheme="http://mrbird.cc/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£Springäº‹ä»¶å‘å¸ƒä¸ç›‘å¬</title>
    <link href="http://mrbird.cc/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Spring%E4%BA%8B%E4%BB%B6%E5%8F%91%E5%B8%83%E4%B8%8E%E7%9B%91%E5%90%AC.html"/>
    <id>http://mrbird.cc/æ·±å…¥ç†è§£Springäº‹ä»¶å‘å¸ƒä¸ç›‘å¬.html</id>
    <published>2020-06-22T10:18:58.000Z</published>
    <updated>2020-12-23T06:35:34.023Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --><p>åœ¨ä½¿ç”¨Springæ„å»ºçš„åº”ç”¨ç¨‹åºä¸­ï¼Œé€‚å½“ä½¿ç”¨äº‹ä»¶å‘å¸ƒä¸ç›‘å¬çš„æœºåˆ¶å¯ä»¥ä½¿æˆ‘ä»¬çš„ä»£ç çµæ´»åº¦æ›´é«˜ï¼Œé™ä½è€¦åˆåº¦ã€‚Springæä¾›äº†å®Œæ•´çš„äº‹ä»¶å‘å¸ƒä¸ç›‘å¬æ¨¡å‹ï¼Œåœ¨è¯¥æ¨¡å‹ä¸­ï¼Œäº‹ä»¶å‘å¸ƒæ–¹åªéœ€å°†äº‹ä»¶å‘å¸ƒå‡ºå»ï¼Œæ— éœ€å…³å¿ƒæœ‰å¤šå°‘ä¸ªå¯¹åº”çš„äº‹ä»¶ç›‘å¬å™¨ï¼›ç›‘å¬å™¨æ— éœ€å…³å¿ƒæ˜¯è°å‘å¸ƒäº†äº‹ä»¶ï¼Œå¹¶ä¸”å¯ä»¥åŒæ—¶ç›‘å¬æ¥è‡ªå¤šä¸ªäº‹ä»¶å‘å¸ƒæ–¹å‘å¸ƒçš„äº‹ä»¶ï¼Œé€šè¿‡è¿™ç§æœºåˆ¶ï¼Œäº‹ä»¶å‘å¸ƒä¸ç›‘å¬æ˜¯è§£è€¦çš„ã€‚</p><p>æœ¬èŠ‚å°†ä¸¾ä¾‹äº‹ä»¶å‘å¸ƒä¸ç›‘å¬çš„ä½¿ç”¨ï¼Œå¹¶ä»‹ç»å†…éƒ¨å®ç°åŸç†ã€‚</p><a id="more"></a><h2 id="äº‹ä»¶å‘å¸ƒç›‘å¬ä¾‹å­"><a href="#äº‹ä»¶å‘å¸ƒç›‘å¬ä¾‹å­" class="headerlink" title="äº‹ä»¶å‘å¸ƒç›‘å¬ä¾‹å­"></a>äº‹ä»¶å‘å¸ƒç›‘å¬ä¾‹å­</h2><p>æ–°å»ºspringbootåº”ç”¨ï¼Œbootç‰ˆæœ¬2.4.0ï¼Œå¼•å…¥å¦‚ä¸‹ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><h3 id="è‡ªå®šä¹‰äº‹ä»¶"><a href="#è‡ªå®šä¹‰äº‹ä»¶" class="headerlink" title="è‡ªå®šä¹‰äº‹ä»¶"></a>è‡ªå®šä¹‰äº‹ä»¶</h3><p>Springä¸­ä½¿ç”¨ApplicationEventæ¥å£æ¥è¡¨ç¤ºä¸€ä¸ªäº‹ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰äº‹ä»¶MyEventéœ€è¦å®ç°è¯¥æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyEvent</span><span class="params">(Object source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ„é€ å™¨sourceå‚æ•°è¡¨ç¤ºå½“å‰äº‹ä»¶çš„äº‹ä»¶æºï¼Œä¸€èˆ¬ä¼ å…¥Springçš„contextä¸Šä¸‹æ–‡å¯¹è±¡å³å¯ã€‚</p><h3 id="äº‹ä»¶å‘å¸ƒå™¨"><a href="#äº‹ä»¶å‘å¸ƒå™¨" class="headerlink" title="äº‹ä»¶å‘å¸ƒå™¨"></a>äº‹ä»¶å‘å¸ƒå™¨</h3><p>äº‹ä»¶å‘å¸ƒé€šè¿‡äº‹ä»¶å‘å¸ƒå™¨ApplicationEventPublisherå®Œæˆï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªäº‹ä»¶å‘å¸ƒå™¨MyEventPublisherï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEventPublisher</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span>, <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationEventPublisher = applicationEventPublisher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"å¼€å§‹å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶MyEvent"</span>);</span><br><span class="line">        MyEvent myEvent = <span class="keyword">new</span> MyEvent(applicationContext);</span><br><span class="line">        applicationEventPublisher.publishEvent(myEvent);</span><br><span class="line">        logger.info(<span class="string">"å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶MyEventç»“æŸ"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨è‡ªå®šä¹‰äº‹ä»¶å‘å¸ƒå™¨MyEventPublisherä¸­ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ApplicationEventPublisheræ¥å‘å¸ƒäº‹ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å®ç°äº†ApplicationEventPublisherAwareæ¥å£ï¼Œé€šè¿‡å›è°ƒæ–¹æ³•setApplicationEventPublisherä¸ºMyEventPublisherçš„ApplicationEventPublisherå±æ€§èµ‹å€¼ï¼›åŒæ ·çš„ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„äº‹ä»¶MyEventæ„é€ å‡½æ•°éœ€è¦ä¼ å…¥Springä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥MyEventPublisherè¿˜å®ç°äº†ApplicationContextAwareæ¥å£ï¼Œæ³¨å…¥äº†ä¸Šä¸‹æ–‡å¯¹è±¡ApplicationContextã€‚</p><p>publishEventæ–¹æ³•å‘å¸ƒäº†ä¸€ä¸ªè‡ªå®šä¹‰äº‹ä»¶MyEventã€‚äº‹ä»¶å‘å¸ƒå‡ºå»åï¼Œæˆ‘ä»¬æ¥ç€ç¼–å†™ç›¸åº”çš„äº‹ä»¶ç›‘å¬å™¨ã€‚</p><h3 id="æ³¨è§£ç›‘å¬"><a href="#æ³¨è§£ç›‘å¬" class="headerlink" title="æ³¨è§£ç›‘å¬"></a>æ³¨è§£ç›‘å¬</h3><p>æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°é€šè¿‡@EventListeneræ³¨è§£å®ç°äº‹ä»¶ç›‘å¬ï¼Œç¼–å†™MyEventPublisherï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAnnotationEventListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMyEventPublished</span><span class="params">(MyEvent myEvent)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶MyEvent -- MyAnnotationEventListener"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¢«@EventListeneræ³¨è§£æ ‡æ³¨çš„æ–¹æ³•å…¥å‚ä¸ºMyEventç±»å‹ï¼Œæ‰€ä»¥åªè¦MyEventäº‹ä»¶è¢«å‘å¸ƒäº†ï¼Œè¯¥ç›‘å¬å™¨å°±ä¼šèµ·ä½œç”¨ï¼Œå³è¯¥æ–¹æ³•ä¼šè¢«å›è°ƒã€‚</p><h3 id="ç¼–ç¨‹å®ç°ç›‘å¬"><a href="#ç¼–ç¨‹å®ç°ç›‘å¬" class="headerlink" title="ç¼–ç¨‹å®ç°ç›‘å¬"></a>ç¼–ç¨‹å®ç°ç›‘å¬</h3><p>é™¤äº†ä½¿ç”¨@EventListeneræ³¨è§£å®ç°äº‹ä»¶çš„ç›‘å¬å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨å®ç°ApplicationListener<t>æ¥å£æ¥å®ç°äº‹ä»¶çš„ç›‘å¬ï¼ˆæ³›å‹ä¸ºç›‘å¬çš„äº‹ä»¶ç±»å‹ï¼‰ï¼š<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEventListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">MyEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(MyEvent event)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶MyEvent"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></t></p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>åœ¨springbootçš„å…¥å£ç±»ä¸­æµ‹è¯•äº‹ä»¶çš„å‘å¸ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(MyApplication.class, args);</span><br><span class="line">        MyEventPublisher publisher = context.getBean(MyEventPublisher.class);</span><br><span class="line">        publisher.publishEvent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿è¡Œç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2020-06-22 16:31:46.667  INFO 83600 --- [           main] c.m.demo.publisher.MyEventPublisher      : å¼€å§‹å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶MyEvent</span><br><span class="line">2020-06-22 16:31:46.668  INFO 83600 --- [           main] cc.mrbird.demo.listener.MyEventListener  : æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶MyEvent</span><br><span class="line">2020-06-22 16:31:46.668  INFO 83600 --- [           main] c.m.d.l.MyAnnotationEventListener        : æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶MyEvent -- MyAnnotationEventListener</span><br><span class="line">2020-06-22 16:31:46.668  INFO 83600 --- [           main] c.m.demo.publisher.MyEventPublisher      : å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶MyEventç»“æŸ</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªç›‘å¬å™¨éƒ½ç›‘å¬åˆ°äº†äº‹ä»¶çš„å‘å¸ƒã€‚æ­¤å¤–ç»†å¿ƒçš„è¯»è€…ä¼šå‘ç°ï¼Œäº‹ä»¶å‘å¸ƒå’Œäº‹ä»¶ç›‘å¬æ˜¯åŒä¸€ä¸ªçº¿ç¨‹å®Œæˆçš„ï¼Œè¿‡ç¨‹ä¸ºåŒæ­¥æ“ä½œï¼Œåªæœ‰å½“æ‰€æœ‰å¯¹åº”äº‹ä»¶ç›‘å¬å™¨çš„é€»è¾‘æ‰§è¡Œå®Œæ¯•åï¼Œäº‹ä»¶å‘å¸ƒæ–¹æ³•æ‰èƒ½å‡ºæ ˆã€‚åé¢è¿›é˜¶ä½¿ç”¨ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼è¿›è¡Œäº‹ä»¶ç›‘å¬ã€‚</p><h2 id="äº‹ä»¶å‘å¸ƒç›‘å¬åŸç†"><a href="#äº‹ä»¶å‘å¸ƒç›‘å¬åŸç†" class="headerlink" title="äº‹ä»¶å‘å¸ƒç›‘å¬åŸç†"></a>äº‹ä»¶å‘å¸ƒç›‘å¬åŸç†</h2><h3 id="äº‹ä»¶å‘å¸ƒç›‘å¬è¿‡ç¨‹"><a href="#äº‹ä»¶å‘å¸ƒç›‘å¬è¿‡ç¨‹" class="headerlink" title="äº‹ä»¶å‘å¸ƒç›‘å¬è¿‡ç¨‹"></a>äº‹ä»¶å‘å¸ƒç›‘å¬è¿‡ç¨‹</h3><p>åœ¨äº‹ä»¶å‘å¸ƒæ–¹æ³•ä¸Šæ‰“ä¸ªæ–­ç‚¹ï¼š</p><p><img src="img/2020å¹´12æœˆ22æ—¥16-45-07.png" alt="2020å¹´12æœˆ22æ—¥16-45-07"></p><p>ä»¥debugçš„æ–¹å¼å¯åŠ¨ç¨‹åºï¼Œç¨‹åºæ‰§è¡Œåˆ°è¯¥æ–­ç‚¹åç‚¹å‡»Step IntoæŒ‰é’®ï¼Œç¨‹åºè·³è½¬åˆ°AbstractApplicationContextçš„publishEvent(ApplicationEvent event)æ–¹æ³•ï¼š</p><p><img src="img/2020å¹´12æœˆ22æ—¥16-46-47.png" alt="2020å¹´12æœˆ22æ—¥16-46-47"></p><p>ç»§ç»­ç‚¹å‡»Step Intoï¼Œç¨‹åºè·³è½¬åˆ°AbstractApplicationContextçš„publishEvent(Object event, @Nullable ResolvableType eventType)æ–¹æ³•ï¼š</p><p><img src="img/2020å¹´12æœˆ22æ—¥16-51-23.png" alt="2020å¹´12æœˆ22æ—¥16-51-23"></p><ol><li><p>getApplicationEventMulticasteræ–¹æ³•ç”¨äºè·å–å¹¿æ’­äº‹ä»¶ç”¨çš„å¤šæ’­å™¨ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/2020å¹´12æœˆ22æ—¥16-53-28.png" alt="2020å¹´12æœˆ22æ—¥16-53-28"></p><p>é‚£ä¹ˆAbstractApplicationContextçš„applicationEventMulticasterå±æ€§æ˜¯ä½•æ—¶èµ‹å€¼çš„å‘¢ï¼Œä¸‹é¢å°†ä¼šä»‹ç»åˆ°ã€‚</p></li><li><p>è·å–åˆ°äº‹ä»¶å¤šæ’­å™¨åï¼Œè°ƒç”¨å…¶multicastEventæ–¹æ³•å¹¿æ’­äº‹ä»¶ï¼Œç‚¹å‡»Step Intoè¿›å…¥è¯¥æ–¹æ³•å†…éƒ¨æŸ¥çœ‹å…·ä½“é€»è¾‘ï¼š</p><p><img src="img/2020å¹´12æœˆ22æ—¥16-59-42.png" alt="2020å¹´12æœˆ22æ—¥16-59-42"></p><p>æŸ¥çœ‹invokeListeneræ–¹æ³•æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ22æ—¥17-00-58.png" alt="2020å¹´12æœˆ22æ—¥17-00-58"></p><p>ç»§ç»­æŸ¥çœ‹doInvokeListeneræ–¹æ³•æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ22æ—¥17-02-48.png" alt="2020å¹´12æœˆ22æ—¥17-02-48"></p></li></ol><p>ä¸Šè¿°è¿‡ç¨‹å°±æ˜¯æ•´ä¸ªäº‹ä»¶å‘å¸ƒä¸ç›‘å¬çš„è¿‡ç¨‹ã€‚</p><h3 id="å¤šæ’­å™¨åˆ›å»ºè¿‡ç¨‹"><a href="#å¤šæ’­å™¨åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="å¤šæ’­å™¨åˆ›å»ºè¿‡ç¨‹"></a>å¤šæ’­å™¨åˆ›å»ºè¿‡ç¨‹</h3><p>ä¸ºäº†å¼„æ¸…æ¥šAbstractApplicationContextçš„applicationEventMulticasterå±æ€§æ˜¯ä½•æ—¶èµ‹å€¼çš„ï¼ˆå³äº‹ä»¶å¤šæ’­å™¨æ˜¯ä½•æ—¶åˆ›å»ºçš„ï¼‰ï¼Œæˆ‘ä»¬åœ¨AbstractApplicationContextçš„applicationEventMulticasterå±æ€§ä¸Šæ‰“ä¸ªæ–­ç‚¹ï¼š</p><p><img src="img/QQ20201222-170637@2x.png" alt="QQ20201222-170637@2x"></p><p>ä»¥debugçš„æ–¹å¼å¯åŠ¨ç¨‹åºï¼Œç¨‹åºè·³è½¬åˆ°äº†AbstractApplicationContextçš„initApplicationEventMulticasteræ–¹æ³•ä¸­ï¼š</p><p><img src="img/2020å¹´12æœˆ22æ—¥18-28-25.png" alt="2020å¹´12æœˆ22æ—¥18-28-25"></p><p>é€šè¿‡è·Ÿè¸ªæ–¹æ³•è°ƒç”¨æ ˆï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºç¨‹åºæ‰§è¡Œåˆ°ä¸Šè¿°æˆªå›¾çš„è¿‡ç¨‹ï¼š</p><ol><li><p>SpringBootå…¥å£ç±»çš„mainæ–¹æ³•æ‰§è¡ŒSpringApplication.run(MyApplication.class, args)å¯åŠ¨åº”ç”¨ï¼š</p><p><img src="img/QQ20201222-183103@2x.png" alt="QQ20201222-183103@2x"></p></li><li><p>runæ–¹æ³•å†…éƒ¨åŒ…å«refreshContextæ–¹æ³•ï¼ˆåˆ·æ–°ä¸Šä¸‹æ–‡ï¼‰ï¼š</p><p><img src="img/QQ20201222-183201@2x.png" alt="QQ20201222-183201@2x"></p></li><li><p>refreshæ–¹æ³•å†…éƒ¨åŒ…å«initApplicationEventMulticasteræ–¹æ³•ï¼š</p><p><img src="img/2020å¹´12æœˆ22æ—¥18-33-42.png" alt="2020å¹´12æœˆ22æ—¥18-33-42"></p></li><li><p>initApplicationEventMulticasteræ–¹æ³•åˆ›å»ºå¤šæ’­å™¨ã€‚</p></li></ol><h3 id="ç›‘å¬å™¨è·å–è¿‡ç¨‹"><a href="#ç›‘å¬å™¨è·å–è¿‡ç¨‹" class="headerlink" title="ç›‘å¬å™¨è·å–è¿‡ç¨‹"></a>ç›‘å¬å™¨è·å–è¿‡ç¨‹</h3><p>åœ¨è¿½è¸ªäº‹ä»¶å‘å¸ƒä¸ç›‘å¬çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“äº‹ä»¶å¯¹åº”çš„ç›‘å¬å™¨æ˜¯é€šè¿‡getApplicationListenersæ–¹æ³•è·å–çš„ï¼š</p><p><img src="img/QQ20201222-183704@2x.png" alt="QQ20201222-183704@2x"></p><p>æ–¹æ³•è¿”å›ä¸‰ä¸ªMyEventäº‹ä»¶å¯¹åº”çš„ç›‘å¬å™¨ï¼Œç´¢å¼•ä¸º0çš„ç›‘å¬å™¨ä¸ºDelegatingApplicationListenerï¼Œå®ƒæ²¡æœ‰å®è´¨æ€§çš„å¤„ç†æŸäº‹ä»¶ï¼Œå¿½ç•¥ï¼›ç´¢å¼•ä¸º1çš„ç›‘å¬å™¨ä¸ºé€šè¿‡å®ç°ApplicationEventListeneræ¥å£çš„ç›‘å¬å™¨ï¼›ç´¢å¼•ä¸º2çš„ç›‘å¬å™¨ä¸ºé€šè¿‡@EventListenerå®ç°çš„ç›‘å¬å™¨ã€‚</p><h4 id="ç¼–ç¨‹å®ç°ç›‘å¬å™¨æ³¨å†Œè¿‡ç¨‹"><a href="#ç¼–ç¨‹å®ç°ç›‘å¬å™¨æ³¨å†Œè¿‡ç¨‹" class="headerlink" title="ç¼–ç¨‹å®ç°ç›‘å¬å™¨æ³¨å†Œè¿‡ç¨‹"></a>ç¼–ç¨‹å®ç°ç›‘å¬å™¨æ³¨å†Œè¿‡ç¨‹</h4><p>æŸ¥çœ‹getApplicationListenersæºç ï¼š</p><p><img src="img/2020å¹´12æœˆ23æ—¥10-07-36.png" alt="2020å¹´12æœˆ23æ—¥10-07-36"></p><p>å…¶ä¸­retrieverCacheçš„å®šä¹‰ä¸º<code>final Map&lt;ListenerCacheKey, CachedListenerRetriever&gt; retrieverCache = new ConcurrentHashMap&lt;&gt;(64)</code>ã€‚</p><p>æ¥ç€æŸ¥çœ‹retrieveApplicationListenersæ–¹æ³•ï¼ˆæ–¹æ³•è§åçŸ¥æ„ï¼Œç¨‹åºç¬¬ä¸€æ¬¡è·å–äº‹ä»¶å¯¹åº”çš„ç›‘å¬å™¨æ—¶ï¼Œç¼“å­˜ä¸­æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥ç»§ç»­æ£€ç´¢è·å–äº‹ä»¶å¯¹åº”çš„ç›‘å¬å™¨ï¼‰ï¼š</p><p><img src="img/2020å¹´12æœˆ23æ—¥10-26-32.png" alt="2020å¹´12æœˆ23æ—¥10-26-32"></p><p>ä»ä¸Šé¢è¿™æ®µä»£ç æˆ‘ä»¬çŸ¥é“ï¼Œç”¨äºéå†çš„ç›‘å¬å™¨é›†åˆå¯¹è±¡listenerså’ŒlistenerBeansçš„å€¼æ˜¯ä»this.defaultRetrieverçš„applicationListenerså’ŒapplicationListenerBeanså±æ€§è·å–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…³æ³¨è¿™äº›å±æ€§æ˜¯ä½•æ—¶è¢«èµ‹å€¼çš„ã€‚defaultRetrieverçš„ç±»å‹ä¸ºDefaultListenerRetrieverï¼š</p><p><img src="img/2020å¹´12æœˆ23æ—¥10-32-02.png" alt="2020å¹´12æœˆ23æ—¥10-32-02"></p><p>æˆ‘ä»¬åœ¨applicationListenerså±æ€§ä¸Šå³é”®é€‰æ‹©Find UsagesæŸ¥çœ‹èµ‹å€¼ç›¸å…³æ“ä½œï¼š</p><p><img src="img/QQ20201223-103808@2x.png" alt="QQ20201223-103808@2x"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œèµ‹å€¼æ“ä½œå‘ç”Ÿåœ¨AbstractApplicationEventMulticasterçš„addApplicationListeneræ–¹æ³•ä¸­ï¼Œ</p><p>ç»§ç»­åœ¨addApplicationListeneræ–¹æ³•ä¸Šå³é”®é€‰æ‹©Find UsagesæŸ¥çœ‹è°ƒç”¨æºï¼š</p><p><img src="img/QQ20201223-104122@2x.png" alt="QQ20201223-104122@2x"></p><p>æˆ‘ä»¬åœ¨registerListenersæ–¹æ³•ä¸Šæ‰“ä¸ªæ–­ç‚¹ï¼Œé‡æ–°å¯åŠ¨ç¨‹åºï¼ŒæŸ¥çœ‹æ–¹æ³•è°ƒç”¨æ ˆï¼š</p><p><img src="img/QQ20201223-104340@2x.png" alt="QQ20201223-104340@2x"></p><p>ä»æ–¹æ³•è°ƒç”¨æ ˆæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºthis.defaultRetrieverçš„applicationListenerså’ŒapplicationListenerBeanså±æ€§å€¼èµ‹å€¼çš„è¿‡ç¨‹ï¼š</p><ol><li><p><code>SpringApplication.run(MyApplication.class, args)</code>å¯åŠ¨Bootç¨‹åºï¼›</p></li><li><p><code>run</code>æ–¹æ³•å†…éƒ¨è°ƒç”¨<code>refreshContext</code>åˆ·æ–°å®¹å™¨æ–¹æ³•ï¼š</p><p><img src="img/QQ20201223-104458@2x.png" alt="QQ20201223-104458@2x"></p></li><li><p><code>refresh</code>æ–¹æ³•å†…éƒ¨è°ƒç”¨äº†<code>registerListener</code>æ–¹æ³•æ³¨å†Œç›‘å¬å™¨ï¼š</p><p><img src="img/QQ20201223-104621@2x.png" alt="QQ20201223-104621@2x"></p></li><li><p><code>registerListeners</code>æ–¹æ³•å†…éƒ¨ä»IOCå®¹å™¨è·å–æ‰€æœ‰ApplicationListenerç±»å‹Beanï¼Œç„¶åèµ‹å€¼ç»™this.defaultRetrieverçš„applicationListenerså’ŒapplicationListenerBeanså±æ€§ã€‚</p></li></ol><h4 id="æ³¨è§£ç›‘å¬å™¨æ³¨å†Œè¿‡ç¨‹"><a href="#æ³¨è§£ç›‘å¬å™¨æ³¨å†Œè¿‡ç¨‹" class="headerlink" title="æ³¨è§£ç›‘å¬å™¨æ³¨å†Œè¿‡ç¨‹"></a>æ³¨è§£ç›‘å¬å™¨æ³¨å†Œè¿‡ç¨‹</h4><p>æŸ¥çœ‹<code>@EventListener</code>æ³¨è§£æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ23æ—¥11-17-54.png" alt="2020å¹´12æœˆ23æ—¥11-17-54"></p><p>æŸ¥çœ‹EventListenerMethodProcessoræºç ï¼š</p><p><img src="img/QQ20201223-111901@2x.png" alt="QQ20201223-111901@2x"></p><p>å…¶å®ç°äº†SmartInitializingSingletonæ¥å£ï¼Œè¯¥æ¥å£åŒ…å«afterSingletonsInstantiatedæ–¹æ³•ï¼š</p><p><img src="img/QQ20201223-111939@2x.png" alt="QQ20201223-111939@2x"></p><p>é€šè¿‡æ³¨é‡Šå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨æ—¶æœºä¸ºï¼šå•å®ä¾‹Beanå®ä¾‹åŒ–åè¢«è°ƒç”¨ï¼Œæ­¤æ—¶Beanå·²ç»è¢«åˆ›å»ºå‡ºæ¥ã€‚</p><p>æˆ‘ä»¬æŸ¥çœ‹EventListenerMethodProcessoræ˜¯å¦‚ä½•å®ç°è¯¥æ–¹æ³•çš„ï¼š</p><p><img src="img/2020å¹´12æœˆ23æ—¥11-23-53.png" alt="2020å¹´12æœˆ23æ—¥11-23-53"></p><p>ç»§ç»­æŸ¥çœ‹processBeanæ–¹æ³•æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ23æ—¥11-34-06.png" alt="2020å¹´12æœˆ23æ—¥11-34-06"></p><p>è‡³æ­¤ï¼Œä¸¤ç§æ–¹å¼æ³¨å†Œç›‘å¬å™¨çš„åŸç†éƒ½ææ¸…æ¥šäº†ã€‚</p><h2 id="ä½¿ç”¨è¿›é˜¶ä¸æ‹“å±•"><a href="#ä½¿ç”¨è¿›é˜¶ä¸æ‹“å±•" class="headerlink" title="ä½¿ç”¨è¿›é˜¶ä¸æ‹“å±•"></a>ä½¿ç”¨è¿›é˜¶ä¸æ‹“å±•</h2><h3 id="äº‹ä»¶ç›‘å¬å¼‚æ­¥åŒ–"><a href="#äº‹ä»¶ç›‘å¬å¼‚æ­¥åŒ–" class="headerlink" title="äº‹ä»¶ç›‘å¬å¼‚æ­¥åŒ–"></a>äº‹ä»¶ç›‘å¬å¼‚æ­¥åŒ–</h3><p>é€šè¿‡å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“äº‹ä»¶å¹¿æ’­å’Œç›‘å¬æ˜¯ä¸€ä¸ªçº¿ç¨‹å®Œæˆçš„åŒæ­¥æ“ä½œï¼Œæœ‰æ—¶å€™ä¸ºäº†è®©å¹¿æ’­æ›´æœ‰æ•ˆç‡ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å°†äº‹ä»¶ç›‘å¬è¿‡ç¨‹å¼‚æ­¥åŒ–ã€‚</p><h4 id="å•ä¸ªå¼‚æ­¥"><a href="#å•ä¸ªå¼‚æ­¥" class="headerlink" title="å•ä¸ªå¼‚æ­¥"></a>å•ä¸ªå¼‚æ­¥</h4><p>å…ˆæ¥çœ‹çœ‹å¦‚ä½•å®ç°å•ä¸ªç›‘å¬å™¨å¼‚æ­¥ã€‚</p><p>é¦–å…ˆéœ€è¦åœ¨springbootå…¥å£ç±»ä¸Šé€šè¿‡<code>@EnableAsync</code>æ³¨è§£å¼€å¯å¼‚æ­¥ï¼Œç„¶ååœ¨éœ€è¦å¼‚æ­¥æ‰§è¡Œçš„ç›‘å¬å™¨æ–¹æ³•ä¸Šä½¿ç”¨<code>@Async</code>æ³¨è§£æ ‡æ³¨ï¼Œä»¥MyAnnotationEventListenerä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAnnotationEventListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span> <span class="comment">// å¼‚æ­¥</span></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMyEventPublished</span><span class="params">(MyEvent myEvent)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶MyEvent -- MyAnnotationEventListener"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨ç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQ20201223-115052@2x.png" alt="QQ20201223-115052@2x"></p><p>é€šè¿‡æ—¥å¿—å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¯¥ç›‘å¬å™¨æ–¹æ³•å·²ç»å¼‚æ­¥åŒ–ï¼Œæ‰§è¡Œçº¿ç¨‹ä¸ºtask-1ã€‚</p><h4 id="æ•´ä½“å¼‚æ­¥"><a href="#æ•´ä½“å¼‚æ­¥" class="headerlink" title="æ•´ä½“å¼‚æ­¥"></a>æ•´ä½“å¼‚æ­¥</h4><p>é€šè¿‡å‰é¢æºç åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“å¤šæ’­å™¨åœ¨å¹¿æ’­äº‹ä»¶æ—¶ï¼Œä¼šå…ˆåˆ¤æ–­æ˜¯å¦æœ‰æŒ‡å®šexecutorï¼Œæœ‰çš„è¯é€šè¿‡executoræ‰§è¡Œç›‘å¬å™¨é€»è¾‘ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®šexecutorçš„æ–¹å¼æ¥è®©æ‰€æœ‰çš„ç›‘å¬æ–¹æ³•éƒ½å¼‚æ­¥æ‰§è¡Œï¼š</p><p><img src="img/QQ20201223-135028@2x.png" alt="QQ20201223-135028@2x"></p><p>æ–°å»ºä¸€ä¸ªé…ç½®ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncEventConfigure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = AbstractApplicationContext.APPLICATION_EVENT_MULTICASTER_BEAN_NAME)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApplicationEventMulticaster <span class="title">simpleApplicationEventMulticaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SimpleApplicationEventMulticaster eventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster();</span><br><span class="line">        eventMulticaster.setTaskExecutor(<span class="keyword">new</span> SimpleAsyncTaskExecutor());</span><br><span class="line">        <span class="keyword">return</span> eventMulticaster;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨é…ç½®ç±»ä¸­ï¼Œæˆ‘ä»¬æ³¨å†Œäº†ä¸€ä¸ªåç§°ä¸ºAbstractApplicationContext.APPLICATION_EVENT_MULTICASTER_BEAN_NAMEï¼ˆå³applicationEventMulticasterï¼‰çš„Beanï¼Œç”¨äºè¦†ç›–é»˜è®¤çš„äº‹ä»¶å¤šæ’­å™¨ï¼Œç„¶åæŒ‡å®šäº†TaskExecutorï¼ŒSimpleAsyncTaskExecutorä¸ºSpringæä¾›çš„å¼‚æ­¥ä»»åŠ¡executorã€‚</p><p>åœ¨å¯åŠ¨é¡¹ç›®å‰ï¼Œå…ˆæŠŠä¹‹å‰åœ¨springbootå…¥å£ç±»æ·»åŠ çš„<code>@EnableAsync</code>æ³¨è§£å»æ‰ï¼Œç„¶åå¯åŠ¨é¡¹ç›®ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQ20201223-135759@2x.png" alt="QQ20201223-135759@2x"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç›‘å¬å™¨äº‹ä»¶éƒ½å¼‚æ­¥åŒ–äº†ã€‚</p><h3 id="å¤šäº‹ä»¶ç›‘å¬å™¨"><a href="#å¤šäº‹ä»¶ç›‘å¬å™¨" class="headerlink" title="å¤šäº‹ä»¶ç›‘å¬å™¨"></a>å¤šäº‹ä»¶ç›‘å¬å™¨</h3><p>äº‹ä»¶ç›‘å¬å™¨é™¤äº†å¯ä»¥ç›‘å¬å•ä¸ªäº‹ä»¶å¤–ï¼Œä¹Ÿå¯ä»¥ç›‘å¬å¤šä¸ªäº‹ä»¶ï¼ˆä»…@EventListeneræ”¯æŒï¼‰ï¼Œä¿®æ”¹MyAnnotationEventListenerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAnnotationEventListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span>(classes = &#123;MyEvent.class, ContextRefreshedEvent.class, ContextClosedEvent.class&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMyEventPublished</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> MyEvent) &#123;</span><br><span class="line">            logger.info(<span class="string">"ç›‘å¬åˆ°MyEventäº‹ä»¶"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ContextRefreshedEvent) &#123;</span><br><span class="line">            logger.info(<span class="string">"ç›‘å¬åˆ°ContextRefreshedEventäº‹ä»¶"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ContextClosedEvent) &#123;</span><br><span class="line">            logger.info(<span class="string">"ç›‘å¬åˆ°ContextClosedEventäº‹ä»¶"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¯¥ç›‘å¬å™¨å°†åŒæ—¶ç›‘å¬MyEventã€ContextRefreshedEventå’ŒContextClosedEventä¸‰ç§ç±»å‹äº‹ä»¶ï¼š</p><p><img src="img/QQ20201223-140231@2x.png" alt="QQ20201223-140231@2x"></p><h3 id="ç›‘å¬å™¨æ’åº"><a href="#ç›‘å¬å™¨æ’åº" class="headerlink" title="ç›‘å¬å™¨æ’åº"></a>ç›‘å¬å™¨æ’åº</h3><p>å•ä¸ªç±»å‹äº‹ä»¶ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªç›‘å¬å™¨åŒæ—¶ç›‘å¬ï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡å®ç°Orderedæ¥å£å®ç°æ’åºï¼ˆæˆ–è€…@Orderæ³¨è§£æ ‡æ³¨ï¼‰ã€‚</p><p>ä¿®æ”¹MyEventListenerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEventListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">MyEvent</span>&gt;, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(MyEvent event)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶MyEventï¼Œæˆ‘çš„ä¼˜å…ˆçº§è¾ƒé«˜"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹MyAnnotationEventListenerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAnnotationEventListener</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span>(classes = &#123;MyEvent.class&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMyEventPublished</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> MyEvent) &#123;</span><br><span class="line">            logger.info(<span class="string">"ç›‘å¬åˆ°MyEventäº‹ä»¶ï¼Œæˆ‘çš„ä¼˜å…ˆçº§è¾ƒä½"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQ20201223-140600@2x.png" alt="QQ20201223-140600@2x"></p><h3 id="é…åˆSpELè¡¨è¾¾å¼"><a href="#é…åˆSpELè¡¨è¾¾å¼" class="headerlink" title="é…åˆSpELè¡¨è¾¾å¼"></a>é…åˆSpELè¡¨è¾¾å¼</h3><p>@EventListeneræ³¨è§£è¿˜åŒ…å«ä¸€ä¸ªconditionå±æ€§ï¼Œå¯ä»¥é…åˆSpELè¡¨è¾¾å¼æ¥æ¡ä»¶åŒ–è§¦å‘ç›‘å¬æ–¹æ³•ã€‚ä¿®æ”¹MyEventï¼Œæ·»åŠ ä¸€ä¸ªbooleanç±»å‹å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> flag;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFlag</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlag</span><span class="params">(<span class="keyword">boolean</span> flag)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.flag = flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyEvent</span><span class="params">(Object source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨å‘å¸ƒäº‹ä»¶çš„æ—¶å€™ï¼Œå°†è¯¥å±æ€§è®¾ç½®ä¸ºfalseï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEventPublisher</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span>, <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationEventPublisher = applicationEventPublisher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"å¼€å§‹å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶MyEvent"</span>);</span><br><span class="line">        MyEvent myEvent = <span class="keyword">new</span> MyEvent(applicationContext);</span><br><span class="line">        myEvent.setFlag(<span class="keyword">false</span>); <span class="comment">// è®¾ç½®ä¸ºfalse</span></span><br><span class="line">        applicationEventPublisher.publishEvent(myEvent);</span><br><span class="line">        logger.info(<span class="string">"å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶MyEventç»“æŸ"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨MyAnnotationEventListenerçš„@EventListeneræ³¨è§£ä¸Šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨SpELï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAnnotationEventListener</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span>(classes = &#123;MyEvent.class&#125;, condition = <span class="string">"#event.flag"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMyEventPublished</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> MyEvent) &#123;</span><br><span class="line">            logger.info(<span class="string">"ç›‘å¬åˆ°MyEventäº‹ä»¶ï¼Œæˆ‘çš„ä¼˜å…ˆçº§è¾ƒä½"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>condition = &quot;#event.flag&quot;</code>çš„å«ä¹‰ä¸ºï¼Œå½“å‰eventäº‹ä»¶ï¼ˆè¿™é‡Œä¸ºMyEventï¼‰çš„flagå±æ€§ä¸ºtrueçš„æ—¶å€™æ‰§è¡Œã€‚</p><p>å¯åŠ¨ç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQ20201223-141248@2x.png" alt="QQ20201223-141248@2x"></p><p>å› ä¸ºæˆ‘ä»¬å‘å¸ƒçš„MyEventçš„flagå±æ€§å€¼ä¸ºfalseï¼Œæ‰€ä»¥ä¸Šé¢è¿™ä¸ªç›‘å¬å™¨æ²¡æœ‰è¢«è§¦å‘ã€‚</p><h3 id="äº‹åŠ¡äº‹ä»¶ç›‘å¬å™¨"><a href="#äº‹åŠ¡äº‹ä»¶ç›‘å¬å™¨" class="headerlink" title="äº‹åŠ¡äº‹ä»¶ç›‘å¬å™¨"></a>äº‹åŠ¡äº‹ä»¶ç›‘å¬å™¨</h3><p>Spring 4.2å¼€å§‹æä¾›äº†ä¸€ä¸ª@TransactionalEventListeneræ³¨è§£ç”¨äºç›‘å¬æ•°æ®åº“äº‹åŠ¡çš„å„ä¸ªé˜¶æ®µï¼š</p><ol><li>AFTER_COMMIT - äº‹åŠ¡æˆåŠŸæäº¤ï¼›</li><li>AFTER_ROLLBACK â€“ äº‹åŠ¡å›æ»šåï¼›</li><li>AFTER_COMPLETION â€“ äº‹åŠ¡å®Œæˆåï¼ˆæ— è®ºæ˜¯æäº¤è¿˜æ˜¯å›æ»šï¼‰ï¼›</li><li>BEFORE_COMMIT - äº‹åŠ¡æäº¤å‰ï¼›</li></ol><p>ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TransactionalEventListener</span>(phase = TransactionPhase.AFTER_COMMIT)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTransactionChange</span><span class="params">(ApplicationEvent event)</span></span>&#123;</span><br><span class="line">    logger.info(<span class="string">"ç›‘å¬åˆ°äº‹åŠ¡æäº¤äº‹ä»¶"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨ä½¿ç”¨Springæ„å»ºçš„åº”ç”¨ç¨‹åºä¸­ï¼Œé€‚å½“ä½¿ç”¨äº‹ä»¶å‘å¸ƒä¸ç›‘å¬çš„æœºåˆ¶å¯ä»¥ä½¿æˆ‘ä»¬çš„ä»£ç çµæ´»åº¦æ›´é«˜ï¼Œé™ä½è€¦åˆåº¦ã€‚Springæä¾›äº†å®Œæ•´çš„äº‹ä»¶å‘å¸ƒä¸ç›‘å¬æ¨¡å‹ï¼Œåœ¨è¯¥æ¨¡å‹ä¸­ï¼Œäº‹ä»¶å‘å¸ƒæ–¹åªéœ€å°†äº‹ä»¶å‘å¸ƒå‡ºå»ï¼Œæ— éœ€å…³å¿ƒæœ‰å¤šå°‘ä¸ªå¯¹åº”çš„äº‹ä»¶ç›‘å¬å™¨ï¼›ç›‘å¬å™¨æ— éœ€å…³å¿ƒæ˜¯è°å‘å¸ƒäº†äº‹ä»¶ï¼Œå¹¶ä¸”å¯ä»¥åŒæ—¶ç›‘å¬æ¥è‡ªå¤šä¸ªäº‹ä»¶å‘å¸ƒæ–¹å‘å¸ƒçš„äº‹ä»¶ï¼Œé€šè¿‡è¿™ç§æœºåˆ¶ï¼Œäº‹ä»¶å‘å¸ƒä¸ç›‘å¬æ˜¯è§£è€¦çš„ã€‚&lt;/p&gt;&lt;p&gt;æœ¬èŠ‚å°†ä¸¾ä¾‹äº‹ä»¶å‘å¸ƒä¸ç›‘å¬çš„ä½¿ç”¨ï¼Œå¹¶ä»‹ç»å†…éƒ¨å®ç°åŸç†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring" scheme="http://mrbird.cc/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Springå£°æ˜å¼äº‹åŠ¡åŸç†</title>
    <link href="http://mrbird.cc/Spring%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86.html"/>
    <id>http://mrbird.cc/Springå£°æ˜å¼äº‹åŠ¡åŸç†.html</id>
    <published>2020-06-14T01:27:34.000Z</published>
    <updated>2020-12-22T01:34:53.139Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --><p>åœ¨<a href="/Spring-äº‹åŠ¡ç®¡ç†.html">Spring-äº‹åŠ¡ç®¡ç†</a>ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†åœ¨Springä¸­å¦‚ä½•æ–¹ä¾¿çš„ç®¡ç†æ•°æ®åº“äº‹åŠ¡ï¼Œå¹¶äº†è§£äº†ä¸€äº›å’Œäº‹åŠ¡ç›¸å…³çš„ä¸“ä¸šæœ¯è¯­ã€‚æœ¬èŠ‚å°†é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­å›é¡¾Springå£°æ˜å¼äº‹åŠ¡çš„ä½¿ç”¨ï¼Œå¹¶é€šè¿‡æºç è§£è¯»å†…éƒ¨å®ç°åŸç†ï¼Œæœ€åé€šè¿‡åˆ—ä¸¾ä¸€äº›å¸¸è§äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„åœºæ™¯æ¥åŠ æ·±å¯¹Springäº‹åŠ¡åŸç†çš„ç†è§£ã€‚</p><a id="more"></a><h2 id="äº‹åŠ¡ä¾‹å­å›é¡¾"><a href="#äº‹åŠ¡ä¾‹å­å›é¡¾" class="headerlink" title="äº‹åŠ¡ä¾‹å­å›é¡¾"></a>äº‹åŠ¡ä¾‹å­å›é¡¾</h2><p>æ–°å»ºSpringBooté¡¹ç›®ï¼ŒBootç‰ˆæœ¬2.4.0ï¼Œç„¶åå¼•å…¥å¦‚ä¸‹ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>å¼•å…¥äº†JDBCã€MySQLé©±åŠ¨å’Œmybatisç­‰ä¾èµ–ã€‚</p><p>ç„¶ååœ¨Springå…¥å£ç±»ä¸ŠåŠ ä¸Š<code>@EnableTransactionManagement</code>æ³¨è§£ï¼Œä»¥å¼€å¯äº‹åŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SpringApplication.run(TransactionApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€æ–°å»ºåç§°ä¸ºtestçš„MySQLæ•°æ®åº“ï¼Œå¹¶åˆ›å»ºUSERè¡¨ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`USER`</span> (</span><br><span class="line">  <span class="string">`USER_ID`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'ç”¨æˆ·ID'</span>,</span><br><span class="line">  <span class="string">`USERNAME`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'ç”¨æˆ·å'</span>,</span><br><span class="line">  <span class="string">`AGE`</span> <span class="built_in">varchar</span>(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'ç”¨æˆ·å¹´é¾„'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`USER_ID`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure><p></p><p>å…¶ä¸­USER_IDå­—æ®µéç©ºã€‚</p><p>åœ¨application.propertiesé…ç½®ä¸­æ·»åŠ æ•°æ®åº“ç›¸å…³é…ç½®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=123456</span><br><span class="line">spring.datasource.url=jdbc:mysql://127.0.0.1:3306/test?useUnicode=true&amp;characterEncoding=UTF-8&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=GMT%2b8</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºUSERè¡¨å¯¹åº”å®ä½“ç±»Userï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String userId, String username, String age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserId</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(String age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºUserMapperï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"insert into user(user_id,username,age) values(#&#123;userId&#125;,#&#123;username&#125;,#&#123;age&#125;)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åŒ…å«ä¸€ä¸ªæ–°å¢ç”¨æˆ·çš„æ–¹æ³•saveã€‚</p><p>åˆ›å»ºServiceæ¥å£UserServiceï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å…¶å®ç°ç±»UserServiceImplï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserMapper userMapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userMapper.save(user);</span><br><span class="line">        <span class="comment">// æµ‹è¯•äº‹åŠ¡å›æ»š</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(user.getUsername())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"usernameä¸èƒ½ä¸ºç©º"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨SpringBootçš„å…¥å£ç±»ä¸­æµ‹è¯•ä¸€æ³¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(TransactionApplication.class, args);</span><br><span class="line">        UserService userService = context.getBean(UserService.class);</span><br><span class="line">        User user = <span class="keyword">new</span> User(<span class="string">"1"</span>, <span class="keyword">null</span>, <span class="string">"18"</span>);</span><br><span class="line">        userService.saveUser(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¦‚æœäº‹åŠ¡ç”Ÿæ•ˆçš„è¯ï¼Œè¿™æ¡æ•°æ®å°†ä¸ä¼šè¢«æ’å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œè¿è¡Œç¨‹åºåï¼ŒæŸ¥çœ‹åº“è¡¨ï¼š</p><p><img src="img/QQ20201221-154216@2x.png" alt="QQ20201221-154216@2x"></p><p>å¯ä»¥çœ‹åˆ°æ•°æ®å¹¶æ²¡æœ‰è¢«æ’å…¥ï¼Œè¯´æ˜äº‹åŠ¡æ§åˆ¶æˆåŠŸã€‚</p><p>æˆ‘ä»¬æ³¨é‡Šæ‰UserServiceImplçš„saveUseræ–¹æ³•ä¸Šçš„<code>@Transactional</code>æ³¨è§£ï¼Œé‡æ–°è¿è¡Œç¨‹åºï¼ŒæŸ¥çœ‹åº“è¡¨ï¼š</p><p><img src="img/QQ20201221-154521@2x.png" alt="QQ20201221-154521@2x"></p><p>å¯ä»¥çœ‹åˆ°æ•°æ®è¢«æ’å…¥åˆ°æ•°æ®åº“ä¸­äº†ï¼Œäº‹åŠ¡æ§åˆ¶å¤±æ•ˆã€‚</p><h2 id="äº‹åŠ¡åŸç†"><a href="#äº‹åŠ¡åŸç†" class="headerlink" title="äº‹åŠ¡åŸç†"></a>äº‹åŠ¡åŸç†</h2><h3 id="EnableTransactionManagement"><a href="#EnableTransactionManagement" class="headerlink" title="@EnableTransactionManagement"></a>@EnableTransactionManagement</h3><p>ä¸Šé¢ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡æ¨¡å—é©±åŠ¨æ³¨è§£<code>@EnableTransactionManagement</code>å¼€å¯äº†äº‹åŠ¡ç®¡ç†åŠŸèƒ½ï¼ŒæŸ¥çœ‹å…¶æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥15-53-04.png" alt="2020å¹´12æœˆ21æ—¥15-53-04"></p><p>æ¥ç€æŸ¥çœ‹TransactionManagementConfigurationSelectorçš„æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥15-57-32.png" alt="2020å¹´12æœˆ21æ—¥15-57-32"></p><div class="note info">å¯¹é€šè¿‡Selectorå¾€IOCå®¹å™¨ä¸­å¯¼å…¥ç»„ä»¶ä¸ç†Ÿæ‚‰çš„è¯»è€…å¯ä»¥å‚è€ƒ<a href="/Spring-Bean-Regist.html">æ·±å…¥å­¦ä¹ Springç»„ä»¶æ³¨å†Œ</a>ã€‚</div><p>æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹å…³æ³¨AutoProxyRegistrarå’ŒProxyTransactionManagementConfigurationçš„é€»è¾‘å³å¯ã€‚</p><h3 id="AutoProxyRegistrar"><a href="#AutoProxyRegistrar" class="headerlink" title="AutoProxyRegistrar"></a>AutoProxyRegistrar</h3><p>æŸ¥çœ‹AutoProxyRegistrarçš„æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥16-11-23.png" alt="2020å¹´12æœˆ21æ—¥16-11-23"></p><p>æŸ¥çœ‹<code>AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry)</code>æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥16-15-50.png" alt="2020å¹´12æœˆ21æ—¥16-15-50"></p><p>æŸ¥çœ‹<code>InfrastructureAdvisorAutoProxyCreator</code>çš„å±‚çº§å…³ç³»å›¾ï¼š</p><p><img src="img/QQ20201221-162016@2x.png" alt="QQ20201221-162016@2x"></p><p>è¿™å’Œ<a href="/æ·±å…¥ç†è§£Spring-AOPåŸç†.html">æ·±å…¥ç†è§£Spring-AOPåŸç†</a>ä¸€æ–‡ä¸­çš„AnnotationAwareAspectJAutoProxyCreatorçš„å±‚çº§å…³ç³»å›¾ä¸€è‡´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ¨æ–­å‡ºInfrastructureAdvisorAutoProxyCreatorçš„ä½œç”¨ä¸ºï¼šä¸ºç›®æ ‡Serviceåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå¢å¼ºç›®æ ‡Serviceæ–¹æ³•ï¼Œç”¨äºäº‹åŠ¡æ§åˆ¶ã€‚</p><h3 id="ProxyTransactionManagementConfiguration"><a href="#ProxyTransactionManagementConfiguration" class="headerlink" title="ProxyTransactionManagementConfiguration"></a>ProxyTransactionManagementConfiguration</h3><p>æŸ¥çœ‹ProxyTransactionManagementConfigurationæºç ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥16-57-15.png" alt="2020å¹´12æœˆ21æ—¥16-57-15"></p><ol><li><p>æ³¨å†ŒBeanFactoryTransactionAttributeSourceAdvisorå¢å¼ºå™¨ï¼Œè¯¥å¢å¼ºå™¨éœ€è¦å¦‚ä¸‹ä¸¤ä¸ªBeanï¼š</p><ul><li>TransactionAttributeSource</li><li>TransactionInterceptor</li></ul></li><li><p>æ³¨å†ŒTransactionAttributeSourceï¼š</p><p><img src="img/QQ20201221-170327@2x.png" alt="QQ20201221-170327@2x"></p><p>æ–¹æ³•ä½“å†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ªç±»å‹ä¸ºAnnotationTransactionAttributeSourceçš„Beanï¼ŒæŸ¥çœ‹å…¶æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥17-02-22.png" alt="2020å¹´12æœˆ21æ—¥17-02-22"></p><p>æŸ¥çœ‹SpringTransactionAnnotationParseræºç ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥17-06-16.png" alt="2020å¹´12æœˆ21æ—¥17-06-16"></p></li><li><p>æ³¨å†ŒTransactionInterceptoräº‹åŠ¡æ‹¦æˆªå™¨ï¼š</p><p><img src="img/QQ20201221-170716@2x.png" alt="QQ20201221-170716@2x"></p><p>æŸ¥çœ‹TransactionInterceptoræºç ï¼Œå…¶å®ç°äº†MethodInterceptoræ–¹æ³•æ‹¦æˆªå™¨æ¥å£ï¼Œåœ¨<a href="/æ·±å…¥ç†è§£Spring-AOPåŸç†.html">æ·±å…¥ç†è§£Spring-AOPåŸç†</a>ä¸€æ–‡ä¸­æ›¾ä»‹ç»è¿‡ï¼ŒMethodBeforeAdviceInterceptorã€AspectJAfterAdviceã€AfterReturningAdviceInterceptorå’ŒAspectJAfterThrowingAdviceç­‰å¢å¼ºå™¨éƒ½æ˜¯MethodInterceptorçš„å®ç°ç±»ï¼Œç›®æ ‡æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯¹åº”æ‹¦æˆªå™¨çš„invokeæ–¹æ³•ä¼šè¢«æ‰§è¡Œï¼Œæ‰€ä»¥é‡ç‚¹å…³æ³¨TransactionInterceptorå®ç°çš„invokeæ–¹æ³•ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥17-14-11.png" alt="2020å¹´12æœˆ21æ—¥17-14-11"></p><p>æŸ¥çœ‹invokeWithinTransactionæ–¹æ³•æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥18-33-23.png" alt="2020å¹´12æœˆ21æ—¥18-33-23"></p></li></ol><p>completeTransactionAfterThrowingæºç å¦‚ä¸‹ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥18-41-49.png" alt="2020å¹´12æœˆ21æ—¥18-41-49"></p><p>è¿™é‡Œï¼Œå‡å¦‚æ²¡æœ‰åœ¨@Transactionalæ³¨è§£ä¸ŠæŒ‡å®šå›æ»šçš„å¼‚å¸¸ç±»å‹çš„è¯ï¼Œé»˜è®¤åªå¯¹RunTimeExcetionå’ŒErrorç±»å‹å¼‚å¸¸è¿›è¡Œå›æ»šï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥18-43-45.png" alt="2020å¹´12æœˆ21æ—¥18-43-45"></p><p>commitTransactionAfterReturningæºç å¦‚ä¸‹ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥18-45-46.png" alt="2020å¹´12æœˆ21æ—¥18-45-46"></p><h3 id="debugéªŒè¯"><a href="#debugéªŒè¯" class="headerlink" title="debugéªŒè¯"></a>debugéªŒè¯</h3><p>é‡æ–°æ‰“å¼€UserServiceImplçš„saveUseræ–¹æ³•ä¸Šçš„<code>@Transactional</code>æ³¨è§£ï¼Œç„¶ååœ¨å¦‚ä¸‹æ‰€ç¤ºä½ç½®æ‰“ä¸ªæ–­ç‚¹ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥18-50-14.png" alt="2020å¹´12æœˆ21æ—¥18-50-14"></p><p>ä»¥debugçš„æ–¹å¼å¯åŠ¨ç¨‹åºï¼š</p><p><img src="img/QQ20201221-185241@2x.png" alt="QQ20201221-185241@2x"></p><p>å¯ä»¥çœ‹åˆ°ç›®æ ‡å¯¹è±¡å·²ç»è¢«JDKä»£ç†ï¼ˆç›®æ ‡å¯¹è±¡å®ç°äº†æ¥å£ï¼Œé»˜è®¤èµ°JDKåŠ¨æ€ä»£ç†ã€‚å¯ä»¥é€šè¿‡spring.aop.proxy-target-class=trueé…ç½®æ¥å¼ºåˆ¶ä½¿ç”¨cglibä»£ç†ï¼Œéœ€è¦é¢å¤–å¼•å…¥AOPè‡ªåŠ¨è£…é…ä¾èµ–ï¼‰ã€‚</p><p>åœ¨æ–­ç‚¹å¤„æ‰§è¡ŒStep Intoï¼Œç¨‹åºè·³è½¬åˆ°JdkDynamicAopProxyçš„invokeæ–¹æ³•ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥19-01-32.png" alt="2020å¹´12æœˆ21æ—¥19-01-32"></p><p><img src="img/2020å¹´12æœˆ21æ—¥19-05-09.png" alt="2020å¹´12æœˆ21æ—¥19-05-09"></p><p>ç¨‹åºè·³è½¬åˆ°TransactionInterceptorçš„invokeæ–¹æ³•ï¼š</p><p><img src="img/2020å¹´12æœˆ21æ—¥19-06-43.png" alt="2020å¹´12æœˆ21æ—¥19-06-43"></p><p><img src="img/2020å¹´12æœˆ21æ—¥19-09-45.png" alt="2020å¹´12æœˆ21æ—¥19-09-45"></p><p>å¯ä»¥çœ‹åˆ°æ•´ä¸ªè¿‡ç¨‹å’Œ<a href="/æ·±å…¥ç†è§£Spring-AOPåŸç†.html">æ·±å…¥ç†è§£Spring-AOPåŸç†</a>ä¸€æ–‡ä»‹ç»çš„ä¸€è‡´ã€‚</p><h2 id="äº‹åŠ¡ä¸ç”Ÿæ•ˆåœºæ™¯"><a href="#äº‹åŠ¡ä¸ç”Ÿæ•ˆåœºæ™¯" class="headerlink" title="äº‹åŠ¡ä¸ç”Ÿæ•ˆåœºæ™¯"></a>äº‹åŠ¡ä¸ç”Ÿæ•ˆåœºæ™¯</h2><p>å¯¹Springäº‹åŠ¡æœºåˆ¶ä¸ç†Ÿæ‚‰çš„coderç»å¸¸ä¼šé‡åˆ°äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„åœºæ™¯ï¼Œè¿™é‡Œåˆ—ä¸¾ä¸¤ä¸ªæœ€ä¸ºå¸¸è§çš„åœºæ™¯ï¼Œå¹¶ç»™å‡ºå¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚</p><h3 id="åœºæ™¯ä¸€"><a href="#åœºæ™¯ä¸€" class="headerlink" title="åœºæ™¯ä¸€"></a>åœºæ™¯ä¸€</h3><p>Serviceæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ä¸æ˜¯RuntimeExceptionæˆ–è€…Errorç±»å‹ï¼Œå¹¶ä¸”@Transactionalæ³¨è§£ä¸Šæ²¡æœ‰æŒ‡å®šå›æ»šå¼‚å¸¸ç±»å‹ã€‚</p><p>å¯¹åº”çš„ä»£ç ä¾‹å­ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserMapper userMapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        userMapper.save(user);</span><br><span class="line">        <span class="comment">// æµ‹è¯•äº‹åŠ¡å›æ»š</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(user.getUsername())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"usernameä¸èƒ½ä¸ºç©º"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿™å†²æƒ…å†µä¸‹ï¼ŒSpringå¹¶ä¸ä¼šè¿›è¡Œäº‹åŠ¡å›æ»šæ“ä½œã€‚</p><p>æ­£å¦‚@Transactionalæ³¨è§£æºç æ³¨é‡Šæ‰€è¿°çš„é‚£æ ·ï¼š</p><p><img src="img/QQ20201221-191914@2x.png" alt="QQ20201221-191914@2x"></p><p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpringäº‹åŠ¡åªå¯¹RuntimeExceptionæˆ–è€…Errorç±»å‹å¼‚å¸¸ï¼ˆé”™è¯¯ï¼‰è¿›è¡Œå›æ»šï¼Œæ£€æŸ¥å¼‚å¸¸ï¼ˆé€šå¸¸ä¸ºä¸šåŠ¡ç±»å¼‚å¸¸ï¼‰ä¸ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šã€‚</strong>ã€‚</p><p>æ‰€ä»¥è¦è§£å†³ä¸Šé¢è¿™ä¸ªäº‹åŠ¡ä¸ç”Ÿæ•ˆçš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p><ol><li><p>æ‰‹åŠ¨åœ¨@Transactionalæ³¨è§£ä¸Šå£°æ˜å›æ»šçš„å¼‚å¸¸ç±»å‹ï¼ˆæ–¹æ³•æŠ›å‡ºè¯¥å¼‚å¸¸åŠå…¶æ‰€æœ‰å­ç±»å‹å¼‚å¸¸éƒ½èƒ½è§¦å‘äº‹åŠ¡å›æ»šï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserMapper userMapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        userMapper.save(user);</span><br><span class="line">        <span class="comment">// æµ‹è¯•äº‹åŠ¡å›æ»š</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(user.getUsername())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"usernameä¸èƒ½ä¸ºç©º"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ–¹æ³•å†…æ‰‹åŠ¨æŠ›å‡ºçš„æ£€æŸ¥å¼‚å¸¸ç±»å‹æ”¹ä¸ºRuntimeExceptionå­ç±»å‹ï¼š</p><p>å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰å¼‚å¸¸ç±»å‹ParamInvalidExceptionï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParamInvalidException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParamInvalidException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹UserServiceImplçš„saveUseræ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserMapper userMapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userMapper.save(user);</span><br><span class="line">        <span class="comment">// æµ‹è¯•äº‹åŠ¡å›æ»š</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(user.getUsername())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParamInvalidException(<span class="string">"usernameä¸èƒ½ä¸ºç©º"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>è¿™ä¸¤ç§æ–¹å¼éƒ½èƒ½è®©äº‹åŠ¡æŒ‰ç…§æˆ‘ä»¬çš„é¢„æœŸç”Ÿæ•ˆã€‚</p><h3 id="åœºæ™¯äºŒ"><a href="#åœºæ™¯äºŒ" class="headerlink" title="åœºæ™¯äºŒ"></a>åœºæ™¯äºŒ</h3><p>éäº‹åŠ¡æ–¹æ³•ç›´æ¥é€šè¿‡thisè°ƒç”¨æœ¬ç±»äº‹åŠ¡æ–¹æ³•ã€‚è¿™ç§æƒ…å†µä¹Ÿæ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä¿®æ”¹UserServiceImplï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserMapper userMapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUserTest</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.saveUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userMapper.save(user);</span><br><span class="line">        <span class="comment">// æµ‹è¯•äº‹åŠ¡å›æ»š</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(user.getUsername())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParamInvalidException(<span class="string">"usernameä¸èƒ½ä¸ºç©º"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨UserServiceImplä¸­ï¼Œæˆ‘ä»¬æ–°å¢äº†saveUserTestæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ²¡æœ‰ä½¿ç”¨@Transactionalæ³¨è§£æ ‡æ³¨ï¼Œä¸ºéäº‹åŠ¡æ–¹æ³•ï¼Œå†…éƒ¨ç›´æ¥è°ƒç”¨äº†saveUseräº‹åŠ¡æ–¹æ³•ã€‚</p><p>åœ¨å…¥å£ç±»é‡Œæµ‹è¯•è¯¥æ–¹æ³•çš„è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(TransactionApplication.class, args);</span><br><span class="line">        UserService userService = context.getBean(UserService.class);</span><br><span class="line">        User user = <span class="keyword">new</span> User(<span class="string">"2"</span>, <span class="keyword">null</span>, <span class="string">"28"</span>);</span><br><span class="line">        userService.saveUserTest(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ç¨‹åºï¼Œè§‚å¯Ÿæ•°æ®åº“æ•°æ®ï¼š</p><p><img src="img/QQ20201222-091609@2x.png" alt="QQ20201222-091609@2x"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œäº‹åŠ¡å¹¶æ²¡æœ‰å›æ»šï¼Œæ•°æ®å·²ç»è¢«æ’å…¥åˆ°äº†æ•°æ®åº“ä¸­ã€‚</p><p><strong>è¿™ç§æƒ…å†µä¸‹äº‹åŠ¡å¤±æ•ˆçš„åŸå› ä¸ºï¼šSpringäº‹åŠ¡æ§åˆ¶ä½¿ç”¨AOPä»£ç†å®ç°ï¼Œé€šè¿‡å¯¹ç›®æ ‡å¯¹è±¡çš„ä»£ç†æ¥å¢å¼ºç›®æ ‡æ–¹æ³•ã€‚è€Œä¸Šé¢ä¾‹å­ç›´æ¥é€šè¿‡thisè°ƒç”¨æœ¬ç±»çš„æ–¹æ³•çš„æ—¶å€™ï¼Œthisçš„æŒ‡å‘å¹¶éä»£ç†ç±»ï¼Œè€Œæ˜¯è¯¥ç±»æœ¬èº«ã€‚</strong></p><p>ä½¿ç”¨debugæ¥éªŒè¯thisæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡ï¼š</p><p><img src="img/2020å¹´12æœˆ22æ—¥09-23-04.png" alt="2020å¹´12æœˆ22æ—¥09-23-04"></p><p>è¿™ç§æƒ…å†µä¸‹è¦è®©äº‹åŠ¡ç”Ÿæ•ˆä¸»è¦æœ‰å¦‚ä¸‹ä¸¤ç§è§£å†³æ–¹å¼ï¼ˆåŸç†éƒ½æ˜¯ä½¿ç”¨ä»£ç†å¯¹è±¡æ¥æ›¿ä»£thisï¼‰ï¼š</p><ol><li>ä»IOCå®¹å™¨ä¸­è·å–UserService Beanï¼Œç„¶åè°ƒç”¨å®ƒçš„saveUseræ–¹æ³•ï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span>, <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserMapper userMapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUserTest</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        UserService userService = context.getBean(UserService.class);</span><br><span class="line">        userService.saveUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userMapper.save(user);</span><br><span class="line">        <span class="comment">// æµ‹è¯•äº‹åŠ¡å›æ»š</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(user.getUsername())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParamInvalidException(<span class="string">"usernameä¸èƒ½ä¸ºç©º"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç æˆ‘ä»¬é€šè¿‡å®ç°ApplicationContextAwareæ¥å£æ³¨å…¥äº†åº”ç”¨ä¸Šä¸‹æ–‡ApplicationContextï¼Œç„¶åä»ä¸­å–å‡ºUserService Beanæ¥ä»£æ›¿thisã€‚</p><ol start="2"><li><p>ä»AOPä¸Šä¸‹æ–‡ä¸­å–å‡ºå½“å‰ä»£ç†å¯¹è±¡ï¼š</p><p>è¿™ç§æƒ…å†µé¦–å…ˆéœ€è¦å¼•å…¥AOP Starterï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨SpringBootå…¥å£ç±»ä¸­é€šè¿‡æ³¨è§£@EnableAspectJAutoProxy(exposeProxy = true)å°†å½“å‰ä»£ç†å¯¹è±¡æš´éœ²åˆ°AOPä¸Šä¸‹æ–‡ä¸­ï¼ˆé€šè¿‡AopContextçš„ThreadLocalå®ç°ï¼‰ã€‚</p><p>æœ€ååœ¨UserServcieImplçš„saveUserTestæ–¹æ³•ä¸­é€šè¿‡AopContextè·å–UserServceçš„ä»£ç†å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserMapper userMapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUserTest</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        UserService userService = (UserService) AopContext.currentProxy();</span><br><span class="line">        userService.saveUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userMapper.save(user);</span><br><span class="line">        <span class="comment">// æµ‹è¯•äº‹åŠ¡å›æ»š</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(user.getUsername())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParamInvalidException(<span class="string">"usernameä¸èƒ½ä¸ºç©º"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨&lt;a href=&quot;/Spring-äº‹åŠ¡ç®¡ç†.html&quot;&gt;Spring-äº‹åŠ¡ç®¡ç†&lt;/a&gt;ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†åœ¨Springä¸­å¦‚ä½•æ–¹ä¾¿çš„ç®¡ç†æ•°æ®åº“äº‹åŠ¡ï¼Œå¹¶äº†è§£äº†ä¸€äº›å’Œäº‹åŠ¡ç›¸å…³çš„ä¸“ä¸šæœ¯è¯­ã€‚æœ¬èŠ‚å°†é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­å›é¡¾Springå£°æ˜å¼äº‹åŠ¡çš„ä½¿ç”¨ï¼Œå¹¶é€šè¿‡æºç è§£è¯»å†…éƒ¨å®ç°åŸç†ï¼Œæœ€åé€šè¿‡åˆ—ä¸¾ä¸€äº›å¸¸è§äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„åœºæ™¯æ¥åŠ æ·±å¯¹Springäº‹åŠ¡åŸç†çš„ç†è§£ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring" scheme="http://mrbird.cc/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£Spring AOPåŸç†</title>
    <link href="http://mrbird.cc/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Spring-AOP%E5%8E%9F%E7%90%86.html"/>
    <id>http://mrbird.cc/æ·±å…¥ç†è§£Spring-AOPåŸç†.html</id>
    <published>2020-06-08T01:04:57.000Z</published>
    <updated>2020-12-11T01:52:25.342Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --><p>AOPåº•å±‚ä¸ºåŠ¨æ€ä»£ç†ï¼ŒAOPæŒ‡çš„æ˜¯ï¼šåœ¨ç¨‹åºè¿è¡ŒæœŸé—´åŠ¨æ€åœ°å°†æŸæ®µä»£ç åˆ‡å…¥åˆ°æŒ‡å®šæ–¹æ³•æŒ‡å®šä½ç½®è¿›è¡Œè¿è¡Œçš„ç¼–ç¨‹æ–¹å¼ï¼Œç›¸å…³è®¾è®¡æ¨¡å¼ä¸ºä»£ç†æ¨¡å¼ã€‚æœ¬èŠ‚å°†é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­å›é¡¾Spring AOPçš„ä½¿ç”¨ï¼Œå¹¶ä¸”é€šè¿‡debugæºç æ·±å…¥ç†è§£å†…éƒ¨åŸç†ã€‚hintsï¼šæœ¬èŠ‚å›¾ç‰‡è¾ƒå¤šï¼ŒåŠ è½½è¾ƒæ…¢ã€‚</p><a id="more"></a><h2 id="å›é¡¾Spring-AOPçš„ä½¿ç”¨"><a href="#å›é¡¾Spring-AOPçš„ä½¿ç”¨" class="headerlink" title="å›é¡¾Spring AOPçš„ä½¿ç”¨"></a>å›é¡¾Spring AOPçš„ä½¿ç”¨</h2><p>æ–°å»ºä¸€ä¸ªSpringBooté¡¹ç›®ï¼ŒSpringBootç‰ˆæœ¬ä¸º2.4.0ï¼Œå¼•å…¥å¦‚ä¸‹ä¸¤ä¸ªä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>ç„¶ååˆ›å»ºä¸€ä¸ªç›®æ ‡ç±»TatgetClassï¼ŒåŒ…å«å¾…ä¼šéœ€è¦è¢«AOPä»£ç†å¢å¼ºçš„æ–¹æ³•testï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TargetClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ç›®æ ‡æ–¹æ³•testè¢«æ‰§è¡Œ"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasLength(value)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"valueä¸èƒ½ä¸ºç©º"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¼–å†™åˆ‡é¢ç±»MyAspectï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(public * cc.mrbird..*.TargetClass.test(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"pointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBefore</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onBeforeï¼š"</span> + joinPoint.getSignature().getName() + <span class="string">"æ–¹æ³•å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š"</span></span><br><span class="line">                + Arrays.asList(joinPoint.getArgs()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"pointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAfter</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onAfterï¼š"</span> + joinPoint.getSignature().getName() + <span class="string">"æ–¹æ³•æ‰§è¡Œç»“æŸï¼Œå‚æ•°ï¼š"</span></span><br><span class="line">                + Arrays.asList(joinPoint.getArgs()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(value = <span class="string">"pointcut()"</span>, returning = <span class="string">"result"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">(JoinPoint joinPoint, Object result)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"afterReturningï¼š"</span> + joinPoint.getSignature().getName() + <span class="string">"æ–¹æ³•æ‰§è¡Œç»“æŸè¿”å›ï¼Œå‚æ•°ï¼š"</span></span><br><span class="line">                + Arrays.asList(joinPoint.getArgs()) + <span class="string">"ï¼Œè¿”å›å€¼ï¼š"</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(value = <span class="string">"pointcut()"</span>, throwing = <span class="string">"exception"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">(JoinPoint joinPoint, Exception exception)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"afterThrowingï¼š"</span> + joinPoint.getSignature().getName() + <span class="string">"æ–¹æ³•æ‰§è¡Œå‡ºé”™ï¼Œå‚æ•°ï¼š"</span></span><br><span class="line">                + Arrays.asList(joinPoint.getArgs()) + <span class="string">"ï¼Œå¼‚å¸¸ï¼š"</span> + exception);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¯¥åˆ‡é¢åŒ…å«äº†4ä¸ªé€šçŸ¥æ–¹æ³•ï¼š</p><ul><li>å‰ç½®é€šçŸ¥ï¼ˆ@Beforeï¼‰ï¼šåœ¨ç›®æ ‡æ–¹æ³•è¢«è°ƒç”¨ä¹‹å‰è°ƒç”¨é€šçŸ¥åŠŸèƒ½ï¼›</li><li>åç½®é€šçŸ¥ï¼ˆ@Afterï¼‰ï¼šåœ¨ç›®æ ‡æ–¹æ³•å®Œæˆä¹‹åè°ƒç”¨é€šçŸ¥ï¼Œæ­¤æ—¶ä¸ä¼šå…³å¿ƒæ–¹æ³•çš„è¾“å‡ºæ˜¯ä»€ä¹ˆï¼›</li><li>è¿”å›é€šçŸ¥ï¼ˆ@AfterReturningï¼‰ï¼šåœ¨ç›®æ ‡æ–¹æ³•æˆåŠŸæ‰§è¡Œä¹‹åè°ƒç”¨é€šçŸ¥ï¼›</li><li>å¼‚å¸¸é€šçŸ¥ï¼ˆ@AfterThrowingï¼‰ï¼šåœ¨ç›®æ ‡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åè°ƒç”¨é€šçŸ¥ã€‚</li></ul><p>è¿™å‡ ä¸ªé€šçŸ¥çš„é¡ºåºåœ¨ä¸åŒçš„Springç‰ˆæœ¬ä¸­æœ‰æ‰€ä¸åŒï¼š</p><ol><li><p>Spring4.x</p><ul><li>æ­£å¸¸æƒ…å†µï¼š@Before â€”-&gt; ç›®æ ‡æ–¹æ³• â€”-&gt; @After â€”-&gt; @AfterReturning</li><li>å¼‚å¸¸æƒ…å†µï¼š@Before â€”-&gt; ç›®æ ‡æ–¹æ³• â€”-&gt; @After â€”-&gt; @AfterThrowing</li></ul></li><li><p>Spring5.x</p><ul><li>æ­£å¸¸æƒ…å†µï¼š@Before â€”-&gt; ç›®æ ‡æ–¹æ³• â€”-&gt; @AfterReturning â€”-&gt; @After</li><li>å¼‚å¸¸æƒ…å†µï¼š@Before â€”-&gt; ç›®æ ‡æ–¹æ³• â€”-&gt; @AfterThrowing â€”-&gt; @After</li></ul></li></ol><p>å…·ä½“å¯ä»¥å‚è€ƒè¿™ç¯‡åšå®¢ï¼š<a href="https://www.cnblogs.com/orzjiangxiaoyu/p/13869747.html" target="_blank" rel="noopener">https://www.cnblogs.com/orzjiangxiaoyu/p/13869747.html</a>ã€‚é€šçŸ¥é¡ºåºå¹¶ä¸å½±å“æœ¬æ–‡å¯¹SpringAOPæºç çš„ç†è§£ã€‚</p><p>åœ¨SpringBootå…¥å£ç±»æµ‹è¯•AOPç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AopApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(AopApplication.class, args);</span><br><span class="line">        TargetClass targetClass = context.getBean(TargetClass.class);</span><br><span class="line">        targetClass.test(<span class="string">"aop"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸»è¦é€»è¾‘ä¸ºä»IOCå®¹å™¨ä¸­è·å–TargetClass Beanï¼Œç„¶åè°ƒç”¨å…¶testæ–¹æ³•ï¼Œç¨‹åºè¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">onBeforeï¼štestæ–¹æ³•å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š[aop]</span><br><span class="line">ç›®æ ‡æ–¹æ³•testè¢«æ‰§è¡Œ</span><br><span class="line">afterReturningï¼štestæ–¹æ³•æ‰§è¡Œç»“æŸè¿”å›ï¼Œå‚æ•°ï¼š[aop]ï¼Œè¿”å›å€¼ï¼šaop</span><br><span class="line">onAfterï¼štestæ–¹æ³•æ‰§è¡Œç»“æŸï¼Œå‚æ•°ï¼š[aop]</span><br></pre></td></tr></table></figure><p></p><p><code>test</code>æ–¹æ³•å‚æ•°ä¸ºç©ºæ—¶ï¼Œç¨‹åºè¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">onBeforeï¼štestæ–¹æ³•å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š[]</span><br><span class="line">ç›®æ ‡æ–¹æ³•testè¢«æ‰§è¡Œ</span><br><span class="line">afterThrowingï¼štestæ–¹æ³•æ‰§è¡Œå‡ºé”™ï¼Œå‚æ•°ï¼š[]ï¼Œå¼‚å¸¸ï¼šjava.lang.RuntimeException: valueä¸èƒ½ä¸ºç©º</span><br><span class="line">onAfterï¼štestæ–¹æ³•æ‰§è¡Œç»“æŸï¼Œå‚æ•°ï¼š[]</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æˆåŠŸé€šè¿‡Spring AOPå°†å„ä¸ªé€šçŸ¥æ–¹æ³•ç»‡å…¥åˆ°äº†ç›®æ ‡æ–¹æ³•çš„å„ä¸ªæ‰§è¡Œé˜¶æ®µï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥æ·±å…¥æ¢ç©¶Spring AOPçš„å®ç°åŸç†ã€‚</p><h2 id="EnableAspectJAutoProxy"><a href="#EnableAspectJAutoProxy" class="headerlink" title="@EnableAspectJAutoProxy"></a>@EnableAspectJAutoProxy</h2><p>å‰é¢æˆ‘ä»¬å¼•å…¥äº†Spring AOPå¼€ç®±å³ç”¨çš„starter<code>spring-boot-starter-aop</code>ï¼Œ@Enableæ¨¡å—é©±åŠ¨æ³¨è§£<code>EnableAspectJAutoProxy</code>ç”¨äºå¼€å¯AspectJè‡ªåŠ¨ä»£ç†ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;AspectJAutoProxyRegistrar.class&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAspectJAutoProxy &#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">proxyTargetClass</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">exposeProxy</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¯¥æ³¨è§£ç±»ä¸Šé€šè¿‡@Importå¯¼å…¥äº†<code>AspectJAutoProxyRegistrar</code>AspectJè‡ªåŠ¨ä»£ç†æ³¨å†Œå™¨ï¼ˆå¯¹@Importä¸äº†è§£çš„è¯»è€…å¯ä»¥å‚è€ƒ<a href="/Spring-Bean-Regist.html">æ·±å…¥å­¦ä¹ Springç»„ä»¶æ³¨å†Œ</a>ï¼‰ï¼ŒæŸ¥çœ‹<code>AspectJAutoProxyRegistrar</code>çš„æºç ï¼š</p><p><img src="img/QQ20201208-141342@2x.png" alt="QQ20201208-141342@2x"></p><p>é€šè¿‡æ³¨é‡Šæˆ‘ä»¬å¤§ä½“å¯ä»¥çŸ¥é“ï¼Œè¯¥æ³¨å†Œå™¨çš„ä½œç”¨æ˜¯å¾€IOCå®¹å™¨é‡Œæ³¨å†Œäº†ä¸€ä¸ªç±»å‹ä¸º<code>AnnotationAwareAspectJAutoProxyCreator</code>ï¼ˆæ³¨è§£é©±åŠ¨çš„AspectJè‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨ï¼‰çš„Beanã€‚è¯¥ç±»çš„<code>registerBeanDefinitions</code>æ–¹æ³•ä¸»è¦å…³æ³¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);</span><br></pre></td></tr></table></figure><p></p><p>æŸ¥çœ‹å…¶æºç ï¼š</p><p><img src="img/dddddddddddddddd.png" alt="dddddddddddddddd"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒé€»è¾‘ä¸ºé€šè¿‡<code>RootBeanDefinition</code>å¾€IOCæ³¨å†Œäº†åç§°ä¸º<code>AUTO_PROXY_CREATOR_BEAN_NAME</code>ï¼ˆå¸¸é‡ï¼Œå€¼ä¸ºorg.springframework.aop.config.internalAutoProxyCreatorï¼‰ï¼Œç±»å‹ä¸ºAnnotationAwareAspectJAutoProxyCreatorçš„Beanï¼ˆå¯¹è¿™ç§é€šè¿‡ImportBeanDefinitionRegistrarå¾€IOCæ³¨å†ŒBeanæ–¹å¼ä¸äº†è§£çš„è¯»è€…å¯ä»¥å‚è€ƒ<a href="/Spring-Bean-Regist.html">æ·±å…¥å­¦ä¹ Springç»„ä»¶æ³¨å†Œ</a>ï¼‰ã€‚</p><div class="note info">æ€»ç»“ï¼š<code>@EnableAspectJAutoProxy</code>æ¨¡å—é©±åŠ¨æ³¨è§£å¾€IOCå®¹å™¨ä¸­æ³¨å†Œäº†ç±»å‹ä¸ºAnnotationAwareAspectJAutoProxyCreatorçš„Beanï¼ŒBeanåç§°ä¸ºorg.springframework.aop.config.internalAutoProxyCreatorã€‚</div><h2 id="AnnotationAwareAspectJAutoProxyCreator-class-hierarchy"><a href="#AnnotationAwareAspectJAutoProxyCreator-class-hierarchy" class="headerlink" title="AnnotationAwareAspectJAutoProxyCreator class hierarchy"></a>AnnotationAwareAspectJAutoProxyCreator class hierarchy</h2><p>é€šè¿‡å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬çš„ç›®å…‰èšç„¦åœ¨<code>AnnotationAwareAspectJAutoProxyCreator</code>ç±»ä¸Šï¼Œä¸ºäº†ææ¸…æ¥šè¿™ä¸ªç±»çš„ä½œç”¨ï¼Œæˆ‘ä»¬å…ˆæ‹æ¸…ç±»çš„å±‚çº§å…³ç³»ï¼š</p><p><img src="img/QQ20201208-143923@2x.png" alt="QQ20201208-143923@2x"></p><p>å¯ä»¥çœ‹åˆ°AnnotationAwareAspectJAutoProxyCreatorçš„çˆ¶ç±»AbstractAutoProxyCreatorå®ç°äº†SmartInstantiationAwareBeanPostProcessorå’ŒBeanFactoryAwareæ¥å£ã€‚å®ç°BeanFactoryAwareç”¨äºåœ¨Beanåˆå§‹åŒ–æ—¶æ³¨å…¥BeanFactoryï¼Œè€ŒSmartInstantiationAwareBeanPostProcessoræ¥å£çš„çˆ¶ç±»ä¸ºInstantiationAwareBeanPostProcessoræ¥å£ï¼Œè¯¥æ¥å£ç»§æ‰¿è‡ªBeanPostProcessoræ¥å£ã€‚</p><p>é€šè¿‡<a href="/æ·±å…¥ç†è§£Spring-BeanPostProcessor-InstantiationAwareBeanPostProcessor.html">æ·±å…¥ç†è§£Spring BeanPostProcessor &amp; InstantiationAwareBeanPostProcessor</a>ä¸€èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“BeanPostProcessoræ¥å£å’ŒInstantiationAwareBeanPostProcessoræ¥å£åŒ…å«ä¸€äº›ç”¨äºBeanå®ä¾‹åŒ–åˆå§‹åŒ–å‰åè¿›è¡Œè‡ªå®šä¹‰æ“ä½œçš„æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¤§ä½“å¯ä»¥çŒœæµ‹å‡ºç›®æ ‡Beançš„ä»£ç†æ˜¯åœ¨è¿™äº›æ¥å£æ–¹æ³•é‡Œå®ç°çš„ã€‚</p><p>é€šè¿‡æŸ¥çœ‹AnnotationAwareAspectJAutoProxyCreatoråŠå…¶å„ä¸ªå±‚çº§çˆ¶ç±»æºç å¯ä»¥å‘ç°ï¼ŒAbstractAutoProxyCreatorç±»å®ç°äº†InstantiationAwareBeanPostProcessoræ¥å£çš„postProcessBeforeInstantiationæ–¹æ³•ï¼ˆè‡ªå®šä¹‰Beanå®ä¾‹åŒ–å‰æ“ä½œé€»è¾‘ï¼‰ï¼Œå®ç°äº†BeanPostProcessorçš„postProcessAfterInitializationæ–¹æ³•ï¼ˆè‡ªå®šä¹‰Beanåˆå§‹åŒ–åæ“ä½œé€»è¾‘ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸Šæ‰“ä¸ªç«¯ç‚¹ï¼Œç”¨äºåç»­debugï¼š</p><p><img src="img/2020å¹´12æœˆ10æ—¥10-33-06.png" alt="2020å¹´12æœˆ10æ—¥10-33-06"></p><h2 id="AOPä»£ç†åˆ›å»ºè¿‡ç¨‹"><a href="#AOPä»£ç†åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="AOPä»£ç†åˆ›å»ºè¿‡ç¨‹"></a>AOPä»£ç†åˆ›å»ºè¿‡ç¨‹</h2><p>æˆ‘ä»¬ä»¥debugçš„æ–¹å¼å¯åŠ¨å‰é¢çš„AOPä¾‹å­ï¼Œå› ä¸ºåç½®å¤„ç†å™¨å¯¹æ‰€æœ‰Beanéƒ½ç”Ÿæ•ˆï¼Œæ‰€ä»¥æ¯ä¸ªBeanåˆ›å»ºæ—¶éƒ½ä¼šè¿›å…¥æˆ‘ä»¬åˆšåˆšæ‰“æ–­ç‚¹çš„é‚£ä¸¤ä¸ªæ–¹æ³•ä¸­ã€‚ä½†æˆ‘ä»¬åªå…³å¿ƒSpring AOPæ˜¯æ€æ ·å¢å¼ºæˆ‘ä»¬å®šä¹‰çš„ç›®æ ‡ç±»TargetClassçš„ï¼Œæ‰€ä»¥å¦‚æœBeanç±»å‹ä¸æ˜¯TargetClassï¼Œæˆ‘ä»¬éƒ½ç›´æ¥ç‚¹å‡»Resume ProgramæŒ‰é’®è·³è¿‡ï¼Œç›´åˆ°Beanç±»å‹æ˜¯TargetClassï¼š</p><p><img src="img/QQ20201210-104756@2x.png" alt="QQ20201210-104756@2x"></p><p>postProcessBeforeInstantiationæ–¹æ³•ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š</p><p><img src="img/2020å¹´12æœˆ10æ—¥13-58-48.png" alt="2020å¹´12æœˆ10æ—¥13-58-48"></p><ol><li><p>é€šè¿‡Beanåç§°å’ŒBeanç±»å‹è·å–è¯¥Beançš„å”¯ä¸€ç¼“å­˜é”®åï¼ŒgetCacheKeyæ–¹æ³•æºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/2020å¹´12æœˆ10æ—¥14-05-07.png" alt="2020å¹´12æœˆ10æ—¥14-05-07"></p><p>åœ¨è¿™é‡Œï¼ŒcacheKeyçš„å€¼ä¸ºtargetClassã€‚</p></li><li><p>åˆ¤æ–­å½“å‰Beanï¼ˆTargetClassï¼‰æ˜¯å¦åŒ…å«åœ¨advisedBeansé›†åˆä¸­ï¼ˆAbstractAutoProxyCreatorçš„æˆå‘˜å˜é‡<code>private final Map&lt;Object, Boolean&gt; advisedBeans = new ConcurrentHashMap&lt;&gt;(256)</code>ï¼Œç”¨äºå­˜æ”¾æ‰€æœ‰Beanæ˜¯å¦éœ€è¦å¢å¼ºæ ‡è¯†ï¼Œé”®ä¸ºæ¯ä¸ªBeançš„cacheKeyï¼Œå€¼ä¸ºå¸ƒå°”ç±»å‹ï¼Œtrueè¡¨ç¤ºéœ€è¦å¢å¼ºï¼Œfalseè¡¨ç¤ºä¸éœ€è¦å¢å¼ºï¼‰ï¼Œæ­¤æ—¶TargetClassè¿˜æœªå®ä¾‹åŒ–ï¼Œæ‰€ä»¥è‡ªç„¶ä¸åœ¨è¯¥é›†åˆä¸­ã€‚</p></li><li><p>åˆ¤æ–­å½“å‰Beanï¼ˆTargetClassï¼‰æ˜¯å¦æ˜¯åŸºç¡€ç±»ï¼ŒæŸ¥çœ‹isInfrastructureClassæ–¹æ³•æºç ï¼š</p><p><img src="img/349A29C0-307C-46C8-8FCC-821B3D46F0E4.png" alt="349A29C0-307C-46C8-8FCC-821B3D46F0E4"></p><p>æ–¹æ³•è°ƒç”¨äº†çˆ¶ç±»çš„isInfrastructureClassæ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-141913@2x.png" alt="QQ20201210-141913@2x"></p><p>this.aspectJAdvisorFactory.isAspectæ–¹æ³•æºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20201210-142323@2x.png" alt="QQ20201210-142323@2x"></p><p>æ‰€ä»¥è¿™ä¸€æ­¥é€»è¾‘ä¸ºï¼šåˆ¤æ–­å½“å‰Beanï¼ˆTargetClassï¼‰æ˜¯å¦æ˜¯Adviceï¼ŒPointcutï¼ŒAdvisorï¼ŒAopInfrastructureBeançš„å­ç±»æˆ–è€…æ˜¯å¦ä¸ºåˆ‡é¢ç±»ï¼ˆ@Aspectæ³¨è§£æ ‡æ³¨ï¼‰ã€‚</p></li><li><p>åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡ï¼š</p><p>shouldSkipæºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20201210-142604@2x.png" alt="QQ20201210-142604@2x"></p><p><img src="img/QQ20201210-142745@2x.png" alt="QQ20201210-142745@2x"></p><p>é€šè¿‡Beanåç§°åˆ¤æ–­æ˜¯å¦ä»¥AutowireCapableBeanFactory.ORIGINAL_INSTANCE_SUFFIXï¼ˆ.ORIGINALï¼‰ç»“å°¾ï¼Œæ˜¯çš„è¯è¿”å›trueè¡¨ç¤ºè·³è¿‡ä»£ç†ã€‚</p><p>å¾ˆæ˜æ˜¾æˆ‘ä»¬çš„TargetClassä¸ç¬¦åˆ3å’Œ4ï¼Œæ‰€ä»¥ç»§ç»­èµ°ç¬¬5æ­¥ã€‚</p></li><li><p>å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰äº†TargetSourceï¼Œåˆ™åœ¨æ­¤å¤„åˆ›å»ºBeanä»£ç†ï¼Œä»¥å–ä»£ç›®æ ‡Beançš„åç»­é»˜è®¤å®ä¾‹åŒ–æ–¹å¼ã€‚æˆ‘ä»¬å¹¶æ²¡æœ‰è‡ªå®šä¹‰TargetSourceï¼Œæ‰€ä»¥ç›´æ¥è·³è¿‡ã€‚</p></li></ol><hr><p>ç»è¿‡ä»¥ä¸Šè¿™äº›æ­¥éª¤ï¼Œå°±TargetClassè¿™ä¸ªBeanè€Œè¨€ï¼ŒpostProcessBeforeInstantiationæ–¹æ³•æœ€ç»ˆè¿”å›nullã€‚Beanå®ä¾‹åŒ–å‰ç½®å¤„ç†åˆ°æ­¤å®Œæ¯•ï¼Œç‚¹å‡»Resume Programï¼Œç»§ç»­Beançš„åç»­ç”Ÿå‘½å‘¨æœŸå¤„ç†é€»è¾‘ï¼Œç¨‹åºè·³è½¬åˆ°Beanåˆå§‹åŒ–åç½®å¤„ç†æ–¹æ³•postProcessAfterInitializationï¼š</p><p><img src="img/QQ20201210-144041@2x.png" alt="QQ20201210-144041@2x"></p><p>è¯¥æ–¹æ³•é‡ç‚¹å…³æ³¨wrapIfNecessaryæ–¹æ³•ï¼ŒæŸ¥çœ‹wrapIfNecessaryæ–¹æ³•æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ10æ—¥14-49-28.png" alt="2020å¹´12æœˆ10æ—¥14-49-28"></p><ol><li><p>getAdvicesAndAdvisorsForBeanæ–¹æ³•å†…éƒ¨ä¸»è¦åŒ…å«ä»¥ä¸‹è¿™äº›é€»è¾‘ï¼ˆæœ‰å…´è¶£è‡ªå·±debugæŸ¥çœ‹å…·ä½“åˆ¤æ–­é€»è¾‘å®ç°ï¼Œè¿™é‡Œä¸å†è´´å›¾ï¼Œåªåšæ€»ç»“ï¼‰ï¼š</p><ul><li>è·å–æ‰€æœ‰çš„é€šçŸ¥æ–¹æ³•ï¼ˆåˆ‡é¢é‡Œå®šä¹‰çš„å„ä¸ªæ–¹æ³•ï¼‰ï¼›</li><li>é€šè¿‡åˆ‡ç‚¹è¡¨è¾¾å¼åˆ¤æ–­è¿™äº›é€šçŸ¥æ–¹æ³•æ˜¯å¦å¯ä¸ºå½“å‰Beanæ‰€ç”¨ï¼›</li><li>å¦‚æœæœ‰ç¬¦åˆçš„é€šçŸ¥æ–¹æ³•ï¼Œåˆ™å¯¹å®ƒä»¬è¿›è¡Œæ’åºï¼ˆæ’åºè§„åˆ™ä¸åŒç‰ˆæœ¬Springæœ‰æ‰€ä¸åŒï¼Œä¸Šé¢å·²ç»æåŠè¿‡ï¼‰ã€‚</li></ul><p>åœ¨å‰é¢çš„AOPä¾‹å­ä¸­ï¼Œåˆ‡é¢MyAspecté‡Œçš„é€šçŸ¥æ–¹æ³•å°±æ˜¯ä¸ºäº†å¢å¼ºTargetClassæ‰€è®¾çš„ï¼ˆæ ¹æ®åˆ‡ç‚¹è¡¨è¾¾å¼ï¼‰ï¼Œæ‰€ä»¥getAdvicesAndAdvisorsForBeanæ–¹æ³•è¿”å›å€¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20201210-145937@2x.png" alt="QQ20201210-145937@2x"></p><p>è¿™äº›é€šçŸ¥æ–¹æ³•å°±æ˜¯æˆ‘ä»¬åœ¨MyAspectåˆ‡é¢é‡Œå®šä¹‰çš„é€šçŸ¥æ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-150430@2x.png" alt="QQ20201210-150430@2x"></p></li><li><p>å¦‚æœè¯¥Beançš„é€šçŸ¥æ–¹æ³•é›†åˆä¸ä¸ºç©ºçš„è¯ï¼Œåˆ™åˆ›å»ºè¯¥Beançš„ä»£ç†å¯¹è±¡ï¼Œå…·ä½“æŸ¥çœ‹createProxyæ–¹æ³•æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ10æ—¥15-25-17.png" alt="2020å¹´12æœˆ10æ—¥15-25-17"></p><p>ç»§ç»­è·Ÿè¸ªproxyFactory.getProxy(getProxyClassLoader())æºç ï¼š</p><p><img src="img/QQ20201210-152727@2x.png" alt="QQ20201210-152727@2x"></p><p><img src="img/QQ20201210-152758@2x.png" alt="QQ20201210-152758@2x"></p><p><img src="img/QQ20201210-152921@2x.png" alt="QQ20201210-152921@2x"></p><p>Springä¼šåˆ¤æ–­å½“å‰ä½¿ç”¨å“ªç§ä»£ç†å¯¹è±¡ï¼ˆä¸€èˆ¬æ¥è¯´å½“Beanæœ‰å®ç°æ¥å£æ—¶ï¼Œä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼Œå½“Beanæ²¡æœ‰å®ç°æ¥å£æ—¶ï¼Œä½¿ç”¨cglibä»£ç†ï¼Œåœ¨Bootä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>spring.aop.proxy-target-class=true</code>é…ç½®æ¥å¼ºåˆ¶ä½¿ç”¨cglibä»£ç†ï¼‰ã€‚</p></li></ol><p>é€šè¿‡Beanåˆå§‹åŒ–åç½®ä»£ç†æ–¹æ³•postProcessBeforeInstantiationå¤„ç†åï¼ŒTargetClassè¢«åŒ…è£…ä¸ºäº†cglibä»£ç†çš„å¢å¼ºBeanï¼Œæ³¨å†Œåˆ°IOCå®¹å™¨ä¸­ï¼š</p><p><img src="img/2020å¹´12æœˆ10æ—¥15-38-49.png" alt="2020å¹´12æœˆ10æ—¥15-38-49"></p><p>åç»­ä»IOCå®¹å™¨ä¸­è·å¾—çš„TargetClasså°±æ˜¯è¢«ä»£ç†åçš„å¯¹è±¡ï¼Œæ‰§è¡Œä»£ç†å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•çš„æ—¶å€™ï¼Œä»£ç†å¯¹è±¡ä¼šæ‰§è¡Œç›¸åº”çš„é€šçŸ¥æ–¹æ³•é“¾ï¼Œä¸‹é¢æ¥ç€åˆ†æã€‚</p><h2 id="ç”Ÿæˆæ‹¦æˆªå™¨é“¾MethodInterceptor"><a href="#ç”Ÿæˆæ‹¦æˆªå™¨é“¾MethodInterceptor" class="headerlink" title="ç”Ÿæˆæ‹¦æˆªå™¨é“¾MethodInterceptor"></a>ç”Ÿæˆæ‹¦æˆªå™¨é“¾MethodInterceptor</h2><p>AOPä»£ç†å¯¹è±¡ç”Ÿæˆåï¼Œæˆ‘ä»¬æ¥ç€å…³æ³¨ä»£ç†å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œé€šçŸ¥æ–¹æ³•æ˜¯æ€ä¹ˆè¢«æ‰§è¡Œçš„ã€‚</p><p>å…ˆå°†å‰é¢æ‰“çš„æ–­ç‚¹éƒ½å»æ‰ï¼Œç„¶ååœ¨SpringBootçš„å…¥å£ç±»AopApplicationçš„å¦‚ä¸‹ä½ç½®æ‰“ä¸ªæ–­ç‚¹ï¼š</p><p><img src="img/QQ20201210-154403@2x.png" alt="QQ20201210-154403@2x"></p><p>ä»¥debugæ–¹å¼å¯åŠ¨ç¨‹åºï¼š</p><p>å¯ä»¥çœ‹åˆ°è·å–åˆ°çš„TargetClass Beanå°±æ˜¯å‰é¢cglibä»£ç†åçš„Beanï¼ˆTargetClass$$EnhanceBySpringCGLIBï¼‰ï¼š</p><p><img src="img/QQ20201210-154800@2x.png" alt="QQ20201210-154800@2x"></p><p>ç‚¹å‡»Step Intoè¿›å…¥testæ–¹æ³•å†…éƒ¨è°ƒç”¨é€»è¾‘ï¼Œä¼šå‘ç°ç¨‹åºè·³è½¬åˆ°äº†CglibAopProxyçš„interceptæ–¹æ³•ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„ç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•è¢«CglibAopProxyçš„interceptæ–¹æ³•æ‹¦æˆªäº†ï¼Œè¯¥æ‹¦æˆªæ–¹æ³•ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="img/2020å¹´12æœˆ11æ—¥09-08-20.png" alt="2020å¹´12æœˆ10æ—¥16-29-04"></p><p>è¿™é‡Œå…ˆé‡ç‚¹å…³æ³¨ä¸‹getInterceptorsAndDynamicInterceptionAdviceæ–¹æ³•ï¼Œå…¶æºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQ20201210-163728@2x.png" alt="QQ20201210-163728@2x"></p><blockquote><p>å›¾ä¸­é”™åˆ«å­—çº æ­£ï¼šæä¾›-&gt;æé«˜ï¼Œæ‡’å¾—å†æ¬¡æˆªå›¾æ³¨é‡Šäº†ğŸ˜¢</p></blockquote><div class="note info">æ‰€è°“çš„æ‹¦æˆªå™¨é“¾ï¼Œå°±æ˜¯åœ¨ä»£ç†å¯¹è±¡çš„æŸä¸ªæ–¹æ³•è¢«æ‰§è¡Œæ—¶ï¼Œä»é€šçŸ¥æ–¹æ³•é›†åˆï¼ˆåˆ›å»ºä»£ç†å¯¹è±¡çš„æ—¶å€™å°±å·²ç»å°†å¯ç”¨é€šçŸ¥é›†åˆä¿å­˜åœ¨ä»£ç†å¯¹è±¡ä¸­äº†ï¼‰ä¸­ç­›é€‰å‡ºé€‚ç”¨äºè¯¥æ–¹æ³•çš„é€šçŸ¥ï¼Œç„¶åå°è£…ä¸ºæ‹¦æˆªå™¨å¯¹è±¡é›†åˆï¼ˆç±»å‹ä¸ºMethodInteceptorï¼Œä¸‹é¢ä¼šä»‹ç»åˆ°ï¼‰ã€‚</div><p>ç»§ç»­æŸ¥çœ‹this.advisorChainFactory.getInterceptorsAndDynamicInterceptionAdviceæºç ï¼š</p><p><img src="img/2020å¹´12æœˆ10æ—¥16-55-58.png" alt="2020å¹´12æœˆ10æ—¥16-55-58.png"></p><p>é€šè¿‡debugæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰ä»£ç†å¯¹è±¡çš„testæ–¹æ³•çš„æ‹¦æˆªå™¨é“¾ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å…ƒç´ ä¸ªæ•°ä¸º5ï¼š</p><p><img src="img/QQ20201210-165919@2x.png" alt="QQ20201210-165919@2x"></p><p>æ‹¦æˆªå™¨é“¾ç¬¬ä¸€ä¸ªå…ƒç´ ç±»å‹ä¸ºExposeInvocationInterceptorï¼Œæ˜¯é»˜è®¤çš„æ‹¦æˆªå™¨ï¼Œåé¢ä¼šä»‹ç»åˆ°å®ƒçš„ä½œç”¨ã€‚å‰©ä¸‹å››ä¸ªä¾æ¬¡ä¸ºï¼šMethodBeforeAdviceInterceptorã€AspectJAfterAdviceã€AfterReturningAdviceInterceptorå’ŒAspectJAfterThrowingAdviceï¼Œå®ƒä»¬éƒ½æ˜¯MethodInterceptorçš„å®ç°ç±»ï¼š</p><p><img src="img/QQ20201210-170632@2x.png" alt="QQ20201210-170632@2x"></p><h2 id="é“¾å¼è°ƒç”¨é€šçŸ¥æ–¹æ³•"><a href="#é“¾å¼è°ƒç”¨é€šçŸ¥æ–¹æ³•" class="headerlink" title="é“¾å¼è°ƒç”¨é€šçŸ¥æ–¹æ³•"></a>é“¾å¼è°ƒç”¨é€šçŸ¥æ–¹æ³•</h2><p>è·å–åˆ°äº†ä»£ç†å¯¹è±¡ç›®æ ‡æ–¹æ³•çš„æ‹¦æˆªå™¨é“¾åï¼Œæˆ‘ä»¬æœ€åæ¥å…³æ³¨è¿™äº›æ‹¦æˆªå™¨æ˜¯å¦‚ä½•é“¾å¼è°ƒç”¨é€šçŸ¥æ–¹æ³•çš„ã€‚è·å–æ‹¦æˆªå™¨é“¾å¹¶ä¸”æ‹¦æˆªå™¨é“¾ä¸ä¸ºç©ºæ—¶ï¼ŒCglibAopProxyçš„interceptæ–¹æ³•åˆ›å»ºCglibMethodInvocationå¯¹è±¡ï¼Œå¹¶è°ƒç”¨å®ƒçš„proceedæ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-182903@2x.png" alt="QQ20201210-182903@2x"></p><p>æŸ¥çœ‹CglibMethodInvocationæºç ï¼š</p><p><img src="img/QQ20201210-183201@2x.png" alt="QQ20201210-183201@2x"></p><p>æŸ¥çœ‹CglibMethodInvocationçˆ¶ç±»ReflectiveMethodInvocation proceedæ–¹æ³•æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ10æ—¥18-38-50.png" alt="2020å¹´12æœˆ10æ—¥18-38-50.png"></p><p>æ¸…é™¤æ‰ä¹‹å‰æ‰“çš„æ–­ç‚¹ï¼Œåœ¨è¯¥æ–¹æ³•ä¸Šç¬¬ä¸€è¡Œæ‰“ä¸ªç«¯ç‚¹ï¼Œé‡æ–°ä»¥debugæ–¹å¼å¯åŠ¨Bootåº”ç”¨ï¼š</p><p><img src="img/QQ20201210-184836@2x.png" alt="QQ20201210-184836@2x"></p><p>ç¨‹åºç¬¬ä¸€æ¬¡è¿›è¯¥æ–¹æ³•æ—¶currentInterceptorIndexå€¼ä¸º-1ï¼Œthis.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex)å–å‡ºæ‹¦æˆªå™¨é“¾ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ExposeInvocationInterceptorï¼Œæ–¹æ³•æœ€åè°ƒç”¨è¯¥æ‹¦æˆªå™¨çš„invokeæ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-185149@2x.png" alt="QQ20201210-185149@2x"></p><p>miå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ReflectiveMethodInvocationå¯¹è±¡ï¼Œç¨‹åºæ‰§è¡Œåˆ°mi.proceedæ–¹æ³•æ—¶ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-185436@2x.png" alt="QQ20201210-185436@2x"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶ç¨‹åºç¬¬äºŒæ¬¡æ‰§è¡ŒReflectiveMethodInvocationçš„poceedæ–¹æ³•ï¼ŒcurrentInterceptorIndexå€¼ä¸º0ï¼Œthis.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex)å–å‡ºæ‹¦æˆªå™¨é“¾ç¬¬äºŒä¸ªæ‹¦æˆªå™¨MethodBeforeAdviceInterceptorï¼Œæ–¹æ³•æœ€åè°ƒç”¨è¯¥æ‹¦æˆªå™¨çš„invokeæ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-185704@2x.png" alt="QQ20201210-185704@2x"></p><p>å¯ä»¥çœ‹åˆ°MethodBeforeAdviceInterceptorçš„invokeæ–¹æ³•ç¬¬ä¸€è¡Œè°ƒç”¨äº†é€šçŸ¥æ–¹æ³•beforeï¼Œæ­¤æ—¶æ§åˆ¶å°æ‰“å°å†…å®¹ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onBeforeï¼štestæ–¹æ³•å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š[hello]</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€åˆé€šè¿‡mi.proceedå†æ¬¡è°ƒç”¨ReflectiveMethodInvocationçš„poceedæ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-190035@2x.png" alt="QQ20201210-190035@2x"></p><p>æ­¤æ—¶ç¨‹åºç¬¬ä¸‰æ¬¡æ‰§è¡ŒReflectiveMethodInvocationçš„poceedæ–¹æ³•ï¼ŒcurrentInterceptorIndexå€¼ä¸º1ï¼Œthis.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex)å–å‡ºæ‹¦æˆªå™¨é“¾ç¬¬ä¸‰ä¸ªæ‹¦æˆªå™¨AspectJAfterAdviceï¼Œæ–¹æ³•æœ€åè°ƒç”¨è¯¥æ‹¦æˆªå™¨çš„invokeæ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-190158@2x.png" alt="QQ20201210-190158@2x"></p><p>å¯ä»¥çœ‹åˆ°AspectJAfterAdviceçš„invokeæ–¹æ³•å†…é€šè¿‡mi.proceedå†æ¬¡è°ƒç”¨ReflectiveMethodInvocationçš„poceedæ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-190413@2x.png" alt="QQ20201210-190413@2x"></p><p>æ­¤æ—¶ç¨‹åºç¬¬å››æ¬¡æ‰§è¡ŒReflectiveMethodInvocationçš„poceedæ–¹æ³•ï¼ŒcurrentInterceptorIndexå€¼ä¸º2ï¼Œthis.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex)å–å‡ºæ‹¦æˆªå™¨é“¾ç¬¬å››ä¸ªæ‹¦æˆªå™¨AfterReturningAdviceInterceptorï¼Œæ–¹æ³•æœ€åè°ƒç”¨è¯¥æ‹¦æˆªå™¨çš„invokeæ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-190604@2x.png" alt="QQ20201210-190604@2x"></p><p>å¯ä»¥çœ‹åˆ°AfterReturningAdviceInterceptorçš„invokeæ–¹æ³•å†…é€šè¿‡mi.proceedå†æ¬¡è°ƒç”¨ReflectiveMethodInvocationçš„poceedæ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-190706@2x.png" alt="QQ20201210-190706@2x"></p><p>æ­¤æ—¶ç¨‹åºç¬¬äº”æ¬¡æ‰§è¡ŒReflectiveMethodInvocationçš„poceedæ–¹æ³•ï¼ŒcurrentInterceptorIndexå€¼ä¸º3ï¼Œthis.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex)å–å‡ºæ‹¦æˆªå™¨é“¾ç¬¬äº”ä¸ªæ‹¦æˆªå™¨AspectJAfterThrowingAdviceï¼Œæ–¹æ³•æœ€åè°ƒç”¨è¯¥æ‹¦æˆªå™¨çš„invokeæ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-190828@2x.png" alt="QQ20201210-190828@2x"></p><p>å¯ä»¥çœ‹åˆ°AspectJAfterThrowingAdviceçš„invokeæ–¹æ³•å†…é€šè¿‡mi.proceedå†æ¬¡è°ƒç”¨ReflectiveMethodInvocationçš„poceedæ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-191109@2x.png" alt="QQ20201210-191109@2x"></p><p>æ­¤æ—¶ç¨‹åºç¬¬å…­æ¬¡æ‰§è¡ŒReflectiveMethodInvocationçš„poceedæ–¹æ³•ï¼ŒcurrentInterceptorIndexå€¼ä¸º4ï¼Œè€Œæ‹¦æˆªå™¨é“¾çš„é•¿åº¦ä¸º5ï¼Œ4==5-1æˆç«‹ï¼Œæ‰€ä»¥æ‰§è¡ŒinvokeJoinpoint()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨é€šè¿‡åå°„è°ƒç”¨äº†ç›®æ ‡æ–¹æ³•ï¼ˆè¿™é‡Œä¸ºTargetClassçš„testæ–¹æ³•ï¼‰ï¼Œæ‰§è¡Œåï¼Œæ§åˆ¶å°æ‰“å°å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">onBeforeï¼štestæ–¹æ³•å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š[hello]</span><br><span class="line">ç›®æ ‡æ–¹æ³•testè¢«æ‰§è¡Œ</span><br></pre></td></tr></table></figure><p></p><p>éšç€invokeJoinpoint()æ–¹æ³•æ‰§è¡Œç»“æŸè¿”å›å‡ºæ ˆï¼Œç¨‹åºå›åˆ°AspectJAfterThrowingAdviceçš„invokeæ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-191519@2x.png" alt="QQ20201210-191519@2x"></p><p>å°±è¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œç›®æ ‡æ–¹æ³•testå¹¶æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥AspectJAfterThrowingAdviceçš„invokeæ–¹æ³•æ‰§è¡Œç»“æŸå‡ºæ ˆï¼Œç¨‹åºå›åˆ°AfterReturningAdviceInteceptorçš„invokeæ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-191650@2x.png" alt="QQ20201210-191650@2x"></p><p>this.advice.afterReturningæ‰§è¡ŒafterReturningé€šçŸ¥æ–¹æ³•ï¼Œæ§åˆ¶å°æ‰“å°å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onBeforeï¼štestæ–¹æ³•å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š[hello]</span><br><span class="line">ç›®æ ‡æ–¹æ³•testè¢«æ‰§è¡Œ</span><br><span class="line">afterReturningï¼štestæ–¹æ³•æ‰§è¡Œç»“æŸè¿”å›ï¼Œå‚æ•°ï¼š[hello]ï¼Œè¿”å›å€¼ï¼šhello</span><br></pre></td></tr></table></figure><p></p><p>AfterReturningAdviceInteceptorçš„invokeæ–¹æ³•æ‰§è¡Œç»“æŸå‡ºæ ˆï¼Œç¨‹åºå›åˆ°AspectJAfterAdviceçš„invokeæ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-192054@2x.png" alt="QQ20201210-192054@2x"></p><p>AspectJAfterAdviceçš„invokeæ–¹æ³•æœ€ç»ˆæ‰§è¡Œfinally afteré€»è¾‘ï¼Œæ§åˆ¶å°æ‰“å°å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">onBeforeï¼štestæ–¹æ³•å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š[hello]</span><br><span class="line">ç›®æ ‡æ–¹æ³•testè¢«æ‰§è¡Œ</span><br><span class="line">afterReturningï¼štestæ–¹æ³•æ‰§è¡Œç»“æŸè¿”å›ï¼Œå‚æ•°ï¼š[hello]ï¼Œè¿”å›å€¼ï¼šhello</span><br><span class="line">onAfterï¼štestæ–¹æ³•æ‰§è¡Œç»“æŸï¼Œå‚æ•°ï¼š[hello]</span><br></pre></td></tr></table></figure><p>AspectJAfterAdviceçš„invokeæ–¹æ³•æ‰§è¡Œç»“æŸå‡ºæ ˆï¼Œç¨‹åºå›åˆ°MethodBeforeAdviceInterceptorçš„invokeæ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-192249@2x.png" alt="QQ20201210-192249@2x"></p><p>MethodBeforeAdviceInterceptorçš„invokeæ–¹æ³•æ­£å¸¸æ‰§è¡Œç»“æŸï¼Œå‡ºæ ˆï¼Œç¨‹åºå›åˆ°ExposeInvocationInterceptorçš„invokeæ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-192435@2x.png" alt="QQ20201210-192435@2x"></p><p>ExposeInvocationInterceptorçš„invokeæ–¹æ³•æ‰§è¡Œç»“æŸå‡ºæ ˆï¼Œç¨‹åºå›åˆ°CglibAopProxyçš„interceptæ–¹æ³•ï¼š</p><p><img src="img/QQ20201210-192556@2x.png" alt="QQ20201210-192556@2x"></p><p>CglibAopProxyçš„interceptæ–¹æ³•æ‰§è¡Œç»“æŸå‡ºæ ˆåï¼Œæ•´ä¸ªAOPçš„æ‹¦æˆªå™¨é“¾è°ƒç”¨ä¹Ÿéšä¹‹ç»“æŸäº†ï¼š</p><p><img src="img/QQ20201210-192827@2x.png" alt="QQ20201210-192827@2x"></p><p>æˆ‘ä»¬å·²ç»æˆåŠŸåœ¨ç›®æ ‡æ–¹æ³•çš„å„ä¸ªæ‰§è¡Œæ—¶æœŸç»‡å…¥äº†é€šçŸ¥æ–¹æ³•ã€‚ä¸Šè¿°è¿‡ç¨‹ä¼´éšç€ä¸æ–­çš„å…¥æ ˆå‡ºæ ˆæ“ä½œï¼Œä¸æ‡‚æ‚¨çœ‹æ‡‚æ²¡ğŸ¤¨ã€‚</p><p>ä¸‹é¢ç”¨ä¸€å¼ å›¾æ€»ç»“æ‹¦æˆªå™¨é“¾è°ƒç”¨è¿‡ç¨‹ï¼š</p><p><img src="img/QQ20201211-094704@2x.png" alt="QQ20201211-094704@2x"></p><blockquote><p>å°šç¡…è°·AOPæºç è§£æå­¦ä¹ ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;AOPåº•å±‚ä¸ºåŠ¨æ€ä»£ç†ï¼ŒAOPæŒ‡çš„æ˜¯ï¼šåœ¨ç¨‹åºè¿è¡ŒæœŸé—´åŠ¨æ€åœ°å°†æŸæ®µä»£ç åˆ‡å…¥åˆ°æŒ‡å®šæ–¹æ³•æŒ‡å®šä½ç½®è¿›è¡Œè¿è¡Œçš„ç¼–ç¨‹æ–¹å¼ï¼Œç›¸å…³è®¾è®¡æ¨¡å¼ä¸ºä»£ç†æ¨¡å¼ã€‚æœ¬èŠ‚å°†é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­å›é¡¾Spring AOPçš„ä½¿ç”¨ï¼Œå¹¶ä¸”é€šè¿‡debugæºç æ·±å…¥ç†è§£å†…éƒ¨åŸç†ã€‚hintsï¼šæœ¬èŠ‚å›¾ç‰‡è¾ƒå¤šï¼ŒåŠ è½½è¾ƒæ…¢ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring" scheme="http://mrbird.cc/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£BeanFactoryPostProcessor &amp; BeanDefinitionRegistryPostProcessor</title>
    <link href="http://mrbird.cc/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3BeanFactoryPostProcessor-BeanDefinitionRegistryPostProcessor.html"/>
    <id>http://mrbird.cc/æ·±å…¥ç†è§£BeanFactoryPostProcessor-BeanDefinitionRegistryPostProcessor.html</id>
    <published>2020-06-03T10:20:12.000Z</published>
    <updated>2020-12-24T07:55:49.678Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --><p>æœ¬èŠ‚ä¸»è¦è®°å½•BeanFactoryPostProcessorå’ŒBeanDefinitionRegistryPostProcessorçš„æ–¹æ³•æ‰§è¡Œæ—¶æœºä»¥åŠç®€å•åŸç†åˆ†æã€‚</p><a id="more"></a><h2 id="BeanFactoryPostProcessor"><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h2><p>æŸ¥çœ‹BeanFactoryPostProcessoræºç ï¼š</p><p><img src="img/QQ20201224-104608@2x.png" alt="QQ20201224-104608@2x"></p><p>æ ¹æ®æ³¨é‡Šæˆ‘ä»¬äº†è§£åˆ°postProcessBeanFactoryæ–¹æ³•çš„æ‰§è¡Œæ—¶æœºä¸ºï¼šBeanFactoryæ ‡å‡†åˆå§‹åŒ–ä¹‹åï¼Œæ‰€æœ‰çš„Beanå®šä¹‰å·²ç»è¢«åŠ è½½ï¼Œä½†Beançš„å®ä¾‹è¿˜æ²¡è¢«åˆ›å»ºï¼ˆä¸åŒ…æ‹¬BeanFactoryPostProcessorç±»å‹ï¼‰ã€‚è¯¥æ–¹æ³•é€šå¸¸ç”¨äºä¿®æ”¹beançš„å®šä¹‰ï¼ŒBeançš„å±æ€§å€¼ç­‰ï¼Œç”šè‡³å¯ä»¥åœ¨æ­¤å¿«é€Ÿåˆå§‹åŒ–Beanã€‚</p><p>ä¸‹é¢æµ‹è¯•ä¸€æ³¢ã€‚</p><p>æ–°å»ºSpringBooté¡¹ç›®ï¼ŒBootç‰ˆæœ¬2.4.0ï¼Œä¾èµ–å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>ç„¶åæ–°å»ºMyBeanFactoryPostProcessorï¼Œå®ç°BeanFactoryPostProcessoræ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MyBeanFactoryPostProcessor.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBeanFactoryPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"å®ä¾‹åŒ–MyBeanFactoryPostProcessor Bean"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> beanDefinitionCount = beanFactory.getBeanDefinitionCount();</span><br><span class="line">        logger.info(<span class="string">"Beanå®šä¹‰ä¸ªæ•°: "</span> + beanDefinitionCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Component</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBean</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            logger.info(<span class="string">"å®ä¾‹åŒ–TestBean"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨postProcessBeanFactoryæ–¹æ³•å†…ï¼Œæˆ‘ä»¬æ‰“å°äº†å½“å‰å·²åŠ è½½Beanå®šä¹‰çš„ä¸ªæ•°ï¼Œå¹¶ä¸”åœ¨MyBeanFactoryPostProcessorç±»ä¸­ï¼Œæ³¨å†Œäº†TestBeanã€‚MyBeanFactoryPostProcessorå’ŒTestBeançš„æ„é€ å‡½æ•°è¾“å‡ºçš„æ—¥å¿—ç”¨äºè§‚å¯ŸBeanå®ä¾‹åŒ–æ—¶æœºã€‚</p><p>å¯åŠ¨ç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQ20201224-105343@2x.png" alt="QQ20201224-105343@2x"></p><p>ä¸Šé¢çš„æ—¥å¿—è¯å®äº†æ–¹æ³•çš„æ‰§è¡Œæ—¶æœºçš„ç¡®æ˜¯åœ¨BeanFactoryæ ‡å‡†åˆå§‹åŒ–ä¹‹åï¼Œæ‰€æœ‰çš„Beanå®šä¹‰å·²ç»è¢«åŠ è½½ï¼Œä½†Beançš„å®ä¾‹è¿˜æ²¡è¢«åˆ›å»ºï¼ˆæ­¤æ—¶TestBeanè¿˜æœªè¢«å®ä¾‹åŒ–ï¼Œæ—¥å¿—è¿˜æ²¡æœ‰è¾“å‡ºâ€å®ä¾‹åŒ–TestBeanâ€ï¼Œä½†è¿™ä¸åŒ…æ‹¬BeanFactoryPostProcessorç±»å‹Beanï¼Œè¯¥æ–¹æ³•æ‰§è¡Œä¹‹å‰ï¼Œæ—¥å¿—å°±å·²ç»è¾“å‡ºäº†â€å®ä¾‹åŒ–MyBeanFactoryPostProcessor Beanâ€ï¼‰ã€‚</p><p>æˆ‘ä»¬åœ¨postProcessBeanFactoryæ–¹æ³•ä¸Šæ‰“ä¸ªæ–­ç‚¹ï¼š</p><p><img src="img/QQ20201224-105621@2x.png" alt="QQ20201224-105621@2x"></p><p>ä»¥debugæ–¹å¼å¯åŠ¨ç¨‹åºï¼š</p><p><img src="img/QQ20201224-110850@2x.png" alt="QQ20201224-110850@2x"></p><p>é€šè¿‡è¿½è¸ªæ–¹æ³•è°ƒç”¨æ ˆï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºBeanFactoryPostProcessorçš„postProcessBeanFactoryæ–¹æ³•æ‰§è¡Œæ—¶æœºå’ŒåŸç†ï¼š</p><ol><li><p><code>SpringApplication.run(MyApplication.class, args)</code>å¯åŠ¨Bootç¨‹åºï¼š</p><p><img src="img/QQ20201224-143234@2x.png" alt="QQ20201224-143234@2x"></p></li><li><p><code>run</code>æ–¹æ³•å†…éƒ¨è°ƒç”¨<code>refreshContext</code>æ–¹æ³•åˆ·æ–°ä¸Šä¸‹æ–‡ï¼š</p><p><img src="img/QQ20201224-143311@2x.png" alt="QQ20201224-143311@2x"></p></li><li><p><code>refresh</code>æ–¹æ³•å†…éƒ¨è°ƒç”¨<code>invokeBeanFactoryPostProcessors</code>æ–¹æ³•ï¼š</p><p><img src="img/QQ20201224-143410@2x.png" alt="QQ20201224-143410@2x"></p></li><li><p>PostProcessorRegistrationDelegateçš„<code>invokeBeanFactoryPostProcessors</code>æ–¹æ³•å†…éƒ¨ï¼š</p><p><img src="img/2020å¹´12æœˆ24æ—¥14-41-11.png" alt="2020å¹´12æœˆ24æ—¥14-41-11"></p><p><img src="img/QQ20201224-144317@2x.png" alt="QQ20201224-144317@2x"></p></li></ol><h2 id="BeanDefinitionRegistryPostProcessor"><a href="#BeanDefinitionRegistryPostProcessor" class="headerlink" title="BeanDefinitionRegistryPostProcessor"></a>BeanDefinitionRegistryPostProcessor</h2><p>BeanDefinitionRegistryPostProcessorç»§æ‰¿è‡ªBeanFactoryPostProcessorï¼Œæ–°å¢äº†ä¸€ä¸ªpostProcessBeanDefinitionRegistryæ–¹æ³•ï¼š</p><p><img src="img/QQ20201224-153034@2x.png" alt="QQ20201224-153034@2x"></p><p>é€šè¿‡æ³¨é‡Šæˆ‘ä»¬äº†è§£åˆ°postProcessBeanDefinitionRegistryæ–¹æ³•çš„æ‰§è¡Œæ—¶æœºä¸ºï¼šæ‰€æœ‰çš„Beanå®šä¹‰å³å°†è¢«åŠ è½½ï¼Œä½†Beançš„å®ä¾‹è¿˜æ²¡è¢«åˆ›å»ºæ—¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒBeanDefinitionRegistryPostProcessorçš„postProcessBeanDefinitionRegistryæ–¹æ³•æ‰§è¡Œæ—¶æœºå…ˆäºBeanFactoryPostProcessorçš„postProcessBeanFactoryæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•é€šå¸¸ç”¨äºç»™IOCå®¹å™¨æ·»åŠ é¢å¤–çš„ç»„ä»¶ã€‚</p><p>ä¸¾ä¸ªä¾‹å­æµ‹è¯•ä¸€æ³¢ã€‚</p><p>æ–°å»ºBeanDefinitionRegistryPostProcessorçš„å®ç°ç±»MyBeanDefinitionRegistryPostProcessorï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanDefinitionRegistryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MyBeanDefinitionRegistryPostProcessor.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> beanDefinitionCount = registry.getBeanDefinitionCount();</span><br><span class="line">        logger.info(<span class="string">"Beanå®šä¹‰ä¸ªæ•°: "</span> + beanDefinitionCount);</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ªæ–°çš„Beanå®šä¹‰</span></span><br><span class="line">        RootBeanDefinition definition = <span class="keyword">new</span> RootBeanDefinition(Object.class);</span><br><span class="line">        registry.registerBeanDefinition(<span class="string">"hello"</span>, definition);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨ç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQ20201224-153548@2x.png" alt="QQ20201224-153548@2x"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒBeanDefinitionRegistryPostProcessorçš„postProcessBeanDefinitionRegistryæ–¹æ³•æ‰§è¡Œæ—¶æœºçš„ç¡®å…ˆäºBeanFactoryPostProcessorçš„postProcessBeanFactoryæ–¹æ³•ã€‚</p><p>é€šè¿‡æŸ¥çœ‹PostProcessorRegistrationDelegateçš„<code>invokeBeanFactoryPostProcessors</code>æ–¹æ³•æºç ä¹Ÿå¯ä»¥è¯å®è¿™ä¸€ç‚¹ï¼š</p><p><img src="img/2020å¹´12æœˆ24æ—¥15-44-15.png" alt="2020å¹´12æœˆ24æ—¥15-44-15.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;æœ¬èŠ‚ä¸»è¦è®°å½•BeanFactoryPostProcessorå’ŒBeanDefinitionRegistryPostProcessorçš„æ–¹æ³•æ‰§è¡Œæ—¶æœºä»¥åŠç®€å•åŸç†åˆ†æã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring" scheme="http://mrbird.cc/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£Spring BeanPostProcessor &amp; InstantiationAwareBeanPostProcessor</title>
    <link href="http://mrbird.cc/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Spring-BeanPostProcessor-InstantiationAwareBeanPostProcessor.html"/>
    <id>http://mrbird.cc/æ·±å…¥ç†è§£Spring-BeanPostProcessor-InstantiationAwareBeanPostProcessor.html</id>
    <published>2020-06-02T07:59:35.000Z</published>
    <updated>2020-12-24T02:37:14.900Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --><p>åœ¨<a href="/Spring-Bean-Lifecycle.html">æ·±å…¥å­¦ä¹ Spring Beanç”Ÿå‘½å‘¨æœŸ</a>ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†Beanåç½®å¤„ç†å™¨BeanPostProcessorï¼Œç”¨äºåœ¨Beanåˆå§‹åŒ–å‰åæ’å…¥æˆ‘ä»¬è‡ªå·±çš„é€»è¾‘ï¼ˆBeanå¢å¼ºï¼ŒBeanä»£ç†ç­‰ï¼‰ã€‚ä»Šå¤©å¶ç„¶æ¥è§¦åˆ°BeanPostProcessorçš„å­ç±»InstantiationAwareBeanPostProcessorï¼Œç”¨äºBeanå®ä¾‹åŒ–å‰åå¤„ç†ã€‚æœ¬èŠ‚è®°å½•ä¸¤è€…çš„åŒºåˆ«ä»¥åŠç®€å•åŸç†åˆ†æã€‚</p><a id="more"></a><h2 id="ä¸¤è€…æ¯”è¾ƒ"><a href="#ä¸¤è€…æ¯”è¾ƒ" class="headerlink" title="ä¸¤è€…æ¯”è¾ƒ"></a>ä¸¤è€…æ¯”è¾ƒ</h2><p>Initializationä¸ºåˆå§‹åŒ–çš„æ„æ€ï¼ŒInstantiationä¸ºå®ä¾‹åŒ–çš„æ„æ€ã€‚åœ¨Spring Beanç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå®ä¾‹åŒ–æŒ‡çš„æ˜¯åˆ›å»ºBeançš„è¿‡ç¨‹ï¼Œåˆå§‹åŒ–æŒ‡çš„æ˜¯Beanåˆ›å»ºåï¼Œå¯¹å…¶å±æ€§è¿›è¡Œèµ‹å€¼ï¼ˆpopulate beanï¼‰ã€åç½®å¤„ç†ç­‰æ“ä½œçš„è¿‡ç¨‹ï¼Œæ‰€ä»¥Instantiationæ‰§è¡Œæ—¶æœºå…ˆäºInitializationã€‚</p><h3 id="ç±»å…³ç³»"><a href="#ç±»å…³ç³»" class="headerlink" title="ç±»å…³ç³»"></a>ç±»å…³ç³»</h3><p>å…ˆæ¥çœ‹çœ‹BeanPostProcessorçš„ç±»ç»“æ„ï¼š</p><p><img src="img/QQ20201208-190911@2x.png" alt="QQ20201208-190911@2x"></p><p>InstantiationAwareBeanPostProcessorä¸ºBeanPostProcessorçš„å­ç±»ï¼Œæ–°å¢äº†ä¸‰ä¸ªé¢å¤–çš„æ–¹æ³•ï¼š</p><p><img src="img/QQ20201208-191154@2x.png" alt="QQ20201208-191154@2x"></p><p><img src="img/QQ20201209-090854@2x.png" alt="QQ20201209-090854@2x"></p><h3 id="æ–¹æ³•è§£æ"><a href="#æ–¹æ³•è§£æ" class="headerlink" title="æ–¹æ³•è§£æ"></a>æ–¹æ³•è§£æ</h3><ol><li><p>BeanPostProcessor</p><ul><li><code>postProcessBeforeInitialization(Object bean, String beanName)</code>ï¼šbeanï¼šBeanå®ä¾‹ï¼›beanNameï¼šBeanåç§°ã€‚æ–¹æ³•å°†åœ¨Beanå®ä¾‹çš„afterPropertiesSetæ–¹æ³•æˆ–è€…è‡ªå®šä¹‰çš„initæ–¹æ³•è¢«è°ƒç”¨å‰è°ƒç”¨ï¼Œæ­¤æ—¶Beanå±æ€§å·²ç»è¢«èµ‹å€¼ã€‚æ–¹æ³•è¿”å›åŸå§‹Beanå®ä¾‹æˆ–è€…åŒ…è£…åçš„Beanå®ä¾‹ï¼Œå¦‚æœè¿”å›nullï¼Œåˆ™åç»­çš„åç½®å¤„ç†æ–¹æ³•ä¸å†è¢«è°ƒç”¨ã€‚</li><li><code>postProcessAfterInitialization(Object bean, String beanName)</code>ï¼šbeanï¼šBeanå®ä¾‹ï¼›beanNameï¼šBeanåç§°ã€‚æ–¹æ³•å°†åœ¨Beanå®ä¾‹çš„afterPropertiesSetæ–¹æ³•æˆ–è€…è‡ªå®šä¹‰çš„initæ–¹æ³•è¢«è°ƒç”¨åè°ƒç”¨ï¼Œæ­¤æ—¶Beanå±æ€§å·²ç»è¢«èµ‹å€¼ã€‚æ–¹æ³•è¿”å›åŸå§‹Beanå®ä¾‹æˆ–è€…åŒ…è£…åçš„Beanå®ä¾‹ï¼Œå¦‚æœè¿”å›nullï¼Œåˆ™åç»­çš„åç½®å¤„ç†æ–¹æ³•ä¸å†è¢«è°ƒç”¨ã€‚</li></ul></li><li><p>InstantiationAwareBeanPostProcessor</p><ul><li><code>postProcessBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName)</code>ï¼šbeanClassï¼šå¾…å®ä¾‹åŒ–çš„Beanç±»å‹ï¼›beanNameï¼šå¾…å®ä¾‹åŒ–çš„Beanåç§°ã€‚æ–¹æ³•ä½œç”¨ä¸ºï¼šåœ¨Beanå®ä¾‹åŒ–å‰è°ƒç”¨è¯¥æ–¹æ³•ï¼Œè¿”å›å€¼å¯ä»¥ä¸ºä»£ç†åçš„Beanï¼Œä»¥æ­¤ä»£æ›¿Beané»˜è®¤çš„å®ä¾‹åŒ–è¿‡ç¨‹ã€‚è¿”å›å€¼ä¸ä¸ºnullæ—¶ï¼Œåç»­åªä¼šè°ƒç”¨BeanPostProcessorçš„ postProcessAfterInitializationæ–¹æ³•ï¼Œè€Œä¸ä¼šè°ƒç”¨åˆ«çš„åç»­åç½®å¤„ç†æ–¹æ³•ï¼ˆå¦‚postProcessAfterInitializationã€postProcessBeforeInstantiationç­‰æ–¹æ³•ï¼‰ï¼›è¿”å›å€¼ä¹Ÿå¯ä»¥ä¸ºnullï¼Œè¿™æ—¶å€™Beanå°†æŒ‰é»˜è®¤æ–¹å¼åˆå§‹åŒ–ã€‚</li><li><code>postProcessAfterInstantiation(Object bean, String beanName)</code>ï¼šbeanï¼šå®ä¾‹åŒ–åçš„Beanï¼Œæ­¤æ—¶å±æ€§è¿˜æ²¡æœ‰è¢«èµ‹å€¼ï¼›beanNameï¼šBeanåç§°ã€‚æ–¹æ³•ä½œç”¨ä¸ºï¼šå½“Beané€šè¿‡æ„é€ å™¨æˆ–è€…å·¥å‚æ–¹æ³•è¢«å®ä¾‹åŒ–åï¼Œå½“å±æ€§è¿˜æœªè¢«èµ‹å€¼å‰ï¼Œè¯¥æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œä¸€èˆ¬ç”¨äºè‡ªå®šä¹‰å±æ€§èµ‹å€¼ã€‚æ–¹æ³•è¿”å›å€¼ä¸ºå¸ƒå°”ç±»å‹ï¼Œè¿”å›trueæ—¶ï¼Œè¡¨ç¤ºBeanå±æ€§éœ€è¦è¢«èµ‹å€¼ï¼›è¿”å›falseè¡¨ç¤ºè·³è¿‡Beanå±æ€§èµ‹å€¼ï¼Œå¹¶ä¸”InstantiationAwareBeanPostProcessorçš„postProcessPropertiesæ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨ã€‚</li></ul></li></ol><h3 id="æ‰§è¡Œæ—¶æœºå¯¹æ¯”"><a href="#æ‰§è¡Œæ—¶æœºå¯¹æ¯”" class="headerlink" title="æ‰§è¡Œæ—¶æœºå¯¹æ¯”"></a>æ‰§è¡Œæ—¶æœºå¯¹æ¯”</h3><p>ä¸ºäº†éªŒè¯å®ä¾‹åŒ–å’Œåˆå§‹åŒ–çš„å…ˆåé¡ºåºï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªSpringBooté¡¹ç›®ï¼Œç‰ˆæœ¬2.4.0ï¼Œä¾èµ–å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>Springå…¥å£ç±»åç§°ä¸º<code>DemoApplication</code>ã€‚æ–°å»º<code>MyBeanPostProcessor</code>å®ç°BeanPostProcessoræ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"demoApplication"</span>.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">"post processor before "</span> + beanName + <span class="string">" initialization"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"demoApplication"</span>.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">"post processor after "</span> + beanName + <span class="string">" initialization"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºå¯¹æ‰€æœ‰çš„Beanç”Ÿæ•ˆï¼Œæ‰€ä»¥ä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿè¾“å‡ºï¼Œè¿™é‡Œä»…å½“Beanåç§°ä¸º<code>demoApplication</code>æ—¶æ‰æ‰“å°è¾“å‡ºã€‚</p><p>æ¥ç€æ–°å»º<code>MyBeanInstantiationPostProcessor</code>å®ç°InstantiationAwareBeanPostProcessoræ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanInstantiationPostProcessor</span> <span class="keyword">implements</span> <span class="title">InstantiationAwareBeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"demoApplication"</span>.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">"post process before "</span> + beanName + <span class="string">" instantiation"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">postProcessAfterInstantiation</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"demoApplication"</span>.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">"post process after "</span> + beanName + <span class="string">" instantiation"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PropertyValues <span class="title">postProcessProperties</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"demoApplication"</span>.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">"post process "</span> + beanName + <span class="string">" properties"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pvs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨ç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">post process before demoApplication instantiation</span><br><span class="line">post process after demoApplication instantiation</span><br><span class="line">post process demoApplication properties</span><br><span class="line">post processor before demoApplication initialization</span><br><span class="line">post processor after demoApplication initialization</span><br></pre></td></tr></table></figure><p></p><p>å¦‚æœå°†MyBeanInstantiationPostProcessorçš„postProcessAfterInstantiationæ–¹æ³•è¿”å›å€¼æ”¹ä¸ºfalseï¼Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">post process before demoApplication instantiation</span><br><span class="line">post process after demoApplication instantiation</span><br><span class="line">post processor before demoApplication initialization</span><br><span class="line">post processor after demoApplication initialization</span><br></pre></td></tr></table></figure><p></p><h2 id="åŸç†è§£æ"><a href="#åŸç†è§£æ" class="headerlink" title="åŸç†è§£æ"></a>åŸç†è§£æ</h2><p>postProcessAfterInitializationå’ŒInstantiationAwareBeanPostProcessorçš„æ–¹æ³•éƒ½å’ŒBeanç”Ÿå‘½å‘¨æœŸæœ‰å…³ï¼Œè¦åˆ†æå®ƒä»¬çš„å®ç°åŸç†è‡ªç„¶è¦ä»Beançš„åˆ›å»ºè¿‡ç¨‹å…¥æ‰‹ã€‚Beanåˆ›å»ºçš„å…¥å£ä¸º<code>AbstractAutowireCapableBeanFactory</code>çš„createBeanæ–¹æ³•ï¼ŒæŸ¥çœ‹å…¶æºç ï¼š</p><p><img src="img/2020-12-09 10-32-44.png" alt="2020-12-09 10-32-44"></p><p>resolveBeforeInstantiationæ–¹æ³•æºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/2020å¹´12æœˆ09æ—¥10-57-07.png" alt="2020å¹´12æœˆ09æ—¥10-57-07"></p><p>ä¸Šé¢æ–¹æ³•è¿”å›çš„beanå¦‚æœä¸ºç©ºçš„è¯ï¼Œ<code>AbstractAutowireCapableBeanFactory</code>çš„createBeanæ–¹æ³•å°†ç»§ç»­å¾€ä¸‹æ‰§è¡ŒdoCreateBeanæ–¹æ³•ï¼š</p><p><img src="img/2020å¹´12æœˆ09æ—¥11-04-18.png" alt="2020å¹´12æœˆ09æ—¥11-04-18"></p><p>æŸ¥çœ‹doCreateBeanæ–¹æ³•æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ09æ—¥14-11-50.png" alt="2020å¹´12æœˆ09æ—¥14-11-50"></p><p>å…¶ä»–éƒ¨åˆ†å’Œæœ¬èŠ‚è®¨è®ºå†…å®¹å…³ç³»ä¸å¤§ï¼ˆBeanç”Ÿå‘½å‘¨æœŸå…¶ä»–éƒ¨åˆ†ï¼‰ï¼Œé‡ç‚¹å…³æ³¨populateBeanå’ŒinitializeBeanæ–¹æ³•ã€‚æŸ¥çœ‹populateBeanæ–¹æ³•æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ09æ—¥14-30-56.png" alt="2020å¹´12æœˆ09æ—¥14-30-56"></p><p>æ¥ç€æŸ¥çœ‹initializeBeanæ–¹æ³•æºç ï¼š</p><p><img src="img/2020å¹´12æœˆ09æ—¥14-36-48.png" alt="2020å¹´12æœˆ09æ—¥14-36-48"></p><p>è‡³æ­¤æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹Beanç”Ÿå‘½å‘¨æœŸç›¸å…³æºç å¼„æ¸…æ¥šäº†BeanPostProcessorå’ŒInstantiationAwareBeanPostProcessorç›¸å…³æ–¹æ³•çš„æ‰§è¡Œæ—¶æœºä»¥åŠåŸç†ã€‚</p><p>ä¸Šé¢æºç çš„è¿½è¸ªå…¶å®ä¸ä»…æ¶‰åŠåˆ°äº†BeanPostProcessorå’ŒInstantiationAwareBeanPostProcessorç›¸å…³æ–¹æ³•çš„æ‰§è¡Œæ—¶æœºä»¥åŠåŸç†ï¼Œæ›´æ˜¯æ•´ä¸ªBeanç”Ÿå‘½å‘¨æœŸåˆ›å»ºè¿‡ç¨‹ï¼Œç»“åˆ<a href="/Spring-Beanç”Ÿå‘½å‘¨æœŸ.html">Spring-Beanç”Ÿå‘½å‘¨æœŸ</a>è¿™ç¯‡æ–‡ç« çš„æµç¨‹å†èµ°ä¸€éæºç ï¼Œä½ ä¼šå¯¹Beançš„ç”Ÿå‘½å‘¨æœŸæœ‰æ›´æ·±çš„ç†è§£ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸‹é¢é€šè¿‡ä¸€å¼ æµç¨‹å›¾æ€»ç»“æœ¬æ–‡ï¼š</p><p><img src="img/QQ20201209-151738@2x.png" alt="QQ20201209-151738@2x"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨&lt;a href=&quot;/Spring-Bean-Lifecycle.html&quot;&gt;æ·±å…¥å­¦ä¹ Spring Beanç”Ÿå‘½å‘¨æœŸ&lt;/a&gt;ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†Beanåç½®å¤„ç†å™¨BeanPostProcessorï¼Œç”¨äºåœ¨Beanåˆå§‹åŒ–å‰åæ’å…¥æˆ‘ä»¬è‡ªå·±çš„é€»è¾‘ï¼ˆBeanå¢å¼ºï¼ŒBeanä»£ç†ç­‰ï¼‰ã€‚ä»Šå¤©å¶ç„¶æ¥è§¦åˆ°BeanPostProcessorçš„å­ç±»InstantiationAwareBeanPostProcessorï¼Œç”¨äºBeanå®ä¾‹åŒ–å‰åå¤„ç†ã€‚æœ¬èŠ‚è®°å½•ä¸¤è€…çš„åŒºåˆ«ä»¥åŠç®€å•åŸç†åˆ†æã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring" scheme="http://mrbird.cc/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Springè‡ªå¸¦å·¥å…·ç±»ä½¿ç”¨å­¦ä¹ </title>
    <link href="http://mrbird.cc/Spring%E8%87%AA%E5%B8%A6%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%BD%BF%E7%94%A8%E5%AD%A6%E4%B9%A0.html"/>
    <id>http://mrbird.cc/Springè‡ªå¸¦å·¥å…·ç±»ä½¿ç”¨å­¦ä¹ .html</id>
    <published>2020-05-28T08:42:25.000Z</published>
    <updated>2020-12-24T01:31:01.922Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --><p>æˆ‘ä»¬é¡¹ç›®å¤§å¤šæ•°éƒ½æ˜¯åŸºäºSpringæ¶æ„ï¼ŒSpringè‡ªèº«åŒ…å«äº†è®¸å¤šå®ç”¨çš„å·¥å…·ç±»ï¼Œå­¦ä¹ è¿™äº›å·¥å…·ç±»çš„ä½¿ç”¨ä¸ä»…èƒ½è®©æˆ‘ä»¬è¾¾åˆ°äº‹åŠåŠŸå€çš„æ•ˆæœï¼Œè€Œä¸”è¿˜èƒ½å‡å°‘ä¸å¿…è¦çš„é¢å¤–çš„å·¥å…·ç±»çš„å¼•å…¥ã€‚æŸ¥çœ‹è¿™äº›å·¥å…·ç±»çš„æºç æ—¶å‘ç°å®ƒä»¬éƒ½æ˜¯abstractç±»å‹çš„ï¼Œè¿™æ˜¯å› ä¸ºå·¥å…·ç±»çš„æ–¹æ³•ä¸€èˆ¬éƒ½æ˜¯staticé™æ€æ–¹æ³•ï¼Œé™æ€æ–¹æ³•å’Œç±»ç»‘å®šï¼Œç±»åŠ è½½åå°±èƒ½ä½¿ç”¨äº†ï¼Œæ— éœ€å®ä¾‹åŒ–ï¼ˆåˆšå¥½abstractç±»ä¸èƒ½ç›´æ¥å®ä¾‹åŒ–ï¼Œå¹¶ä¸”å¯ä»¥å®šä¹‰éæŠ½è±¡æ–¹æ³•ï¼‰ï¼Œæ‰€ä»¥å·¥å…·ç±»å®šä¹‰ä¸ºabstractç±»å‹å†åˆé€‚ä¸è¿‡ã€‚</p><a id="more"></a><div class="note info">æœ¬æ–‡printæ–¹æ³•ä¸ºSystem.out.printlnçš„å°è£…ï¼š<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">    System.out.println(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="ClassUtils"><a href="#ClassUtils" class="headerlink" title="ClassUtils"></a>ClassUtils</h2><p>org.springframework.util.classUtilsåŒ…å«ä¸€äº›å’Œjava.lang.Classç›¸å…³çš„å®ç”¨æ–¹æ³•ã€‚</p><h3 id="getDefaultClassLoader"><a href="#getDefaultClassLoader" class="headerlink" title="getDefaultClassLoader"></a>getDefaultClassLoader</h3><p><code>ClassLoader getDefaultClassLoader()</code>è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ç±»åŠ è½½å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.getDefaultClassLoader());</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sun.misc.Launcher$AppClassLoader@18b4aac2</span><br></pre></td></tr></table></figure><h3 id="overrideThreadContextClassLoader"><a href="#overrideThreadContextClassLoader" class="headerlink" title="overrideThreadContextClassLoader"></a>overrideThreadContextClassLoader</h3><p><code>ClassLoader overrideThreadContextClassLoader(@Nullable ClassLoader classLoaderToUse)</code>ç”¨ç‰¹å®šçš„ç±»åŠ è½½å™¨è¦†ç›–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ç±»åŠ è½½å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.getDefaultClassLoader());</span><br><span class="line">ClassUtils.overrideThreadContextClassLoader(ClassLoader.getSystemClassLoader().getParent());</span><br><span class="line">print(ClassUtils.getDefaultClassLoader());</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sun.misc.Launcher$AppClassLoader@18b4aac2</span><br><span class="line">sun.misc.Launcher$ExtClassLoader@3feba861</span><br></pre></td></tr></table></figure><h3 id="forName"><a href="#forName" class="headerlink" title="forName"></a>forName</h3><p><code>forName(String name, @Nullable ClassLoader classLoader)</code>é€šè¿‡ç±»åè¿”å›ç±»å®ä¾‹ï¼Œç±»ä¼¼äºClass.forName()ï¼Œä½†åŠŸèƒ½æ›´å¼ºï¼Œå¯ä»¥ç”¨äºåŸå§‹ç±»å‹ï¼Œå†…éƒ¨ç±»ç­‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader classLoader = ClassUtils.getDefaultClassLoader();</span><br><span class="line">print(ClassUtils.forName(<span class="string">"int"</span>, classLoader));</span><br><span class="line">print(ClassUtils.forName(<span class="string">"java.lang.String[]"</span>, classLoader));</span><br><span class="line">print(ClassUtils.forName(<span class="string">"java.lang.Thread$State"</span>, classLoader));</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int</span><br><span class="line">class [Ljava.lang.String;</span><br><span class="line">class java.lang.Thread$State</span><br></pre></td></tr></table></figure><h3 id="isPresent"><a href="#isPresent" class="headerlink" title="isPresent"></a>isPresent</h3><p><code>boolean isPresent(String className, @Nullable ClassLoader classLoader)</code>åˆ¤æ–­å½“å‰classLoaderæ˜¯å¦åŒ…å«ç›®æ ‡ç±»å‹ï¼ˆåŒ…æ‹¬å®ƒçš„æ‰€æœ‰çˆ¶ç±»å’Œæ¥å£ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader classLoader = ClassUtils.getDefaultClassLoader();</span><br><span class="line">print(ClassUtils.isPresent(<span class="string">"int"</span>, classLoader));</span><br><span class="line">print(ClassUtils.isPresent(<span class="string">"intt"</span>, classLoader));</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">false</span><br></pre></td></tr></table></figure><h3 id="resolvePrimitiveClassName"><a href="#resolvePrimitiveClassName" class="headerlink" title="resolvePrimitiveClassName"></a>resolvePrimitiveClassName</h3><p><code>Class&lt;?&gt; resolvePrimitiveClassName(@Nullable String name)</code>é€šè¿‡ç»™å®šç±»åè·å–åŸå§‹ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.resolvePrimitiveClassName(<span class="string">"int"</span>));</span><br><span class="line">print(ClassUtils.resolvePrimitiveClassName(<span class="string">"java.lang.Integer"</span>));</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int</span><br><span class="line">null</span><br></pre></td></tr></table></figure><h3 id="isPrimitiveWrapper"><a href="#isPrimitiveWrapper" class="headerlink" title="isPrimitiveWrapper"></a>isPrimitiveWrapper</h3><p><code>boolean isPrimitiveWrapper(Class&lt;?&gt; clazz)</code>åˆ¤æ–­ç»™å®šç±»æ˜¯å¦ä¸ºåŒ…è£…ç±»ï¼Œå¦‚Boolean, Byte, Character, Short, Integer, Long, Float, Double æˆ–è€… Voidï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.isPrimitiveWrapper(Integer.class));</span><br><span class="line">print(ClassUtils.isPrimitiveWrapper(Character.class));</span><br><span class="line">print(ClassUtils.isPrimitiveWrapper(Void.class));</span><br><span class="line">print(ClassUtils.isPrimitiveWrapper(String.class));</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">true</span><br><span class="line">true</span><br><span class="line">false</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼çš„æ–¹æ³•è¿˜æœ‰<code>isPrimitiveOrWrapper</code>åˆ¤æ–­æ˜¯å¦ä¸ºåŸå§‹ç±»æˆ–è€…åŒ…è£…ç±»ã€<code>isPrimitiveWrapperArray</code>åˆ¤æ–­æ˜¯å¦ä¸ºåŒ…è£…ç±»æ•°ç»„ã€<code>isPrimitiveArray</code>åˆ¤æ–­æ˜¯å¦ä¸ºåŸå§‹ç±»æ•°ç»„ã€‚</p><h3 id="resolvePrimitiveIfNecessary"><a href="#resolvePrimitiveIfNecessary" class="headerlink" title="resolvePrimitiveIfNecessary"></a>resolvePrimitiveIfNecessary</h3><p><code>Class&lt;?&gt; resolvePrimitiveIfNecessary(Class&lt;?&gt; clazz)</code>å¦‚æœç»™å®šç±»æ˜¯åŸå§‹ç±»ï¼Œåˆ™è¿”å›å¯¹åº”åŒ…è£…ç±»ï¼Œå¦åˆ™ç›´æ¥è¿”å›ç»™å®šç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.resolvePrimitiveIfNecessary(<span class="keyword">int</span>.class));</span><br><span class="line">print(ClassUtils.resolvePrimitiveIfNecessary(Object.class));</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class java.lang.Integer</span><br><span class="line">class java.lang.Object</span><br></pre></td></tr></table></figure><h3 id="isAssignable"><a href="#isAssignable" class="headerlink" title="isAssignable"></a>isAssignable</h3><p><code>boolean isAssignable(Class&lt;?&gt; lhsType, Class&lt;?&gt; rhsType)</code>é€šè¿‡åå°„æ£€æŸ¥ï¼Œæ˜¯å¦å¯ä»¥å°†rhsTypeèµ‹å€¼ç»™lhsTypeï¼ˆæ³¨æ„ï¼ŒåŒ…è£…ç±»å‹å¯ä»¥èµ‹å€¼ç»™ç›¸åº”çš„åŸå§‹ç±»å‹ï¼Œè‡ªåŠ¨æ‹†è£…ç®±æœºåˆ¶ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.isAssignable(Integer.class, <span class="keyword">int</span>.class));</span><br><span class="line">print(ClassUtils.isAssignable(Object.class, String.class));</span><br><span class="line">print(ClassUtils.isAssignable(BeanPostProcessor.class, InstantiationAwareBeanPostProcessor.class));</span><br><span class="line">print(ClassUtils.isAssignable(<span class="keyword">double</span>.class, Double.class)); <span class="comment">// consider this</span></span><br><span class="line">print(ClassUtils.isAssignable(Integer.class, Long.class));</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">true</span><br><span class="line">true</span><br><span class="line">true</span><br><span class="line">false</span><br></pre></td></tr></table></figure><h3 id="isAssignableValue"><a href="#isAssignableValue" class="headerlink" title="isAssignableValue"></a>isAssignableValue</h3><p><code>boolean isAssignableValue(Class&lt;?&gt; type, @Nullable Object value)</code>åˆ¤æ–­ç»™å®šçš„å€¼æ˜¯å¦ç¬¦åˆç»™å®šçš„ç±»å‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.isAssignableValue(Integer.class, <span class="number">1</span>));</span><br><span class="line">print(ClassUtils.isAssignableValue(Integer.class, <span class="number">1L</span>));</span><br><span class="line">print(ClassUtils.isAssignableValue(<span class="keyword">int</span>.class, Integer.valueOf(<span class="number">1</span>)));</span><br><span class="line">print(ClassUtils.isAssignableValue(Object.class,<span class="number">1</span>));</span><br><span class="line">print(ClassUtils.isAssignableValue(String.class,<span class="number">1</span>));</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">false</span><br><span class="line">true</span><br><span class="line">true</span><br><span class="line">false</span><br></pre></td></tr></table></figure><h3 id="convertResourcePathToClassName"><a href="#convertResourcePathToClassName" class="headerlink" title="convertResourcePathToClassName"></a>convertResourcePathToClassName</h3><p><code>String convertResourcePathToClassName(String resourcePath)</code>å°†ç±»è·¯å¾„è½¬æ¢ä¸ºå…¨é™å®šç±»åï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.convertResourcePathToClassName(<span class="string">"java/lang/String"</span>));</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.String</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šå°±æ˜¯å°†<code>/</code>æ›¿æ¢ä¸º<code>.</code>ã€‚<code>convertClassNameToResourcePath</code>æ–¹æ³•åŠŸèƒ½ç›¸åã€‚</p><h3 id="classNamesToString"><a href="#classNamesToString" class="headerlink" title="classNamesToString"></a>classNamesToString</h3><p><code>String classNamesToString(Class&lt;?&gt;... classes)</code>ç›´æ¥çœ‹æ¼”ç¤ºä¸è§£é‡Šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.classNamesToString(String.class, Integer.class, BeanPostProcessor.class));</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[java.lang.String, java.lang.Integer, org.springframework.beans.factory.config.BeanPostProcessor]</span><br></pre></td></tr></table></figure><h3 id="getAllInterfaces"><a href="#getAllInterfaces" class="headerlink" title="getAllInterfaces"></a>getAllInterfaces</h3><p><code>Class&lt;?&gt;[] getAllInterfaces(Object instance)</code>è¿”å›ç»™å®šå®ä¾‹å¯¹è±¡æ‰€å®ç°æ¥å£ç±»å‹é›†åˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AutowiredAnnotationBeanPostProcessor processor = <span class="keyword">new</span> AutowiredAnnotationBeanPostProcessor();</span><br><span class="line">Class&lt;?&gt;[] allInterfaces = ClassUtils.getAllInterfaces(processor);</span><br><span class="line">Arrays.stream(allInterfaces).forEach(System.out::println);</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">interface org.springframework.beans.factory.config.SmartInstantiationAwareBeanPostProcessor</span><br><span class="line">interface org.springframework.beans.factory.support.MergedBeanDefinitionPostProcessor</span><br><span class="line">interface org.springframework.core.PriorityOrdered</span><br><span class="line">interface org.springframework.beans.factory.BeanFactoryAware</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼çš„æ–¹æ³•è¿˜æœ‰<code>getAllInterfacesForClass</code>ã€<code>getAllInterfacesAsSet</code>ã€<code>getAllInterfacesForClassAsSet</code></p><h3 id="determineCommonAncestor"><a href="#determineCommonAncestor" class="headerlink" title="determineCommonAncestor"></a>determineCommonAncestor</h3><p><code>Class&lt;?&gt; determineCommonAncestor(@Nullable Class&lt;?&gt; clazz1, @Nullable Class&lt;?&gt; clazz2)</code>å¯»æ‰¾ç»™å®šç±»å‹çš„å…±åŒç¥–å…ˆï¼ˆæ‰€è°“å…±åŒç¥–å…ˆæŒ‡çš„æ˜¯ç»™å®šç±»å‹è°ƒç”¨<code>class.getSuperclass</code>è·å¾—çš„å…±åŒç±»å‹ï¼Œå¦‚æœç»™å®šç±»å‹æ˜¯Object.classï¼Œæ¥å£ï¼ŒåŸå§‹ç±»å‹æˆ–è€…Voidï¼Œç›´æ¥è¿”å›nullï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®ƒä¸¤éƒ½æ˜¯æ¥å£</span></span><br><span class="line">print(ClassUtils.determineCommonAncestor(AutowireCapableBeanFactory.class, ListableBeanFactory.class));</span><br><span class="line">print(ClassUtils.determineCommonAncestor(Long.class, Integer.class));</span><br><span class="line">print(ClassUtils.determineCommonAncestor(String.class, Integer.class));</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">null</span><br><span class="line">class java.lang.Number</span><br><span class="line">null</span><br></pre></td></tr></table></figure><h3 id="isInnerClass"><a href="#isInnerClass" class="headerlink" title="isInnerClass"></a>isInnerClass</h3><p><code>boolean isInnerClass(Class&lt;?&gt; clazz)</code>åˆ¤æ–­ç»™å®šç±»å‹æ˜¯å¦ä¸ºå†…éƒ¨ç±»ï¼ˆéé™æ€ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">     <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">print(ClassUtils.isInnerClass(A.B.class)); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">print(ClassUtils.isInnerClass(A.B.class)); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">print(ClassUtils.isInnerClass(A.B.class)); <span class="comment">// false</span></span><br></pre></td></tr></table></figure><h3 id="isCglibProxy"><a href="#isCglibProxy" class="headerlink" title="isCglibProxy"></a>isCglibProxy</h3><p><code>boolean isCglibProxy(Object object)</code>æ˜¯å¦ä¸ºCglibä»£ç†å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AopApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfigure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(AopApplication.class, args);</span><br><span class="line">        MyConfigure myConfigure = context.getBean(MyConfigure.class);</span><br><span class="line">        System.out.println(ClassUtils.isCglibProxy(myConfigure));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">true</span><br></pre></td></tr></table></figure><p>é…ç½®ç±»ä¸ç”±Cglibä»£ç†çš„è¯ï¼Œè¿”å›ä¸ºfalseï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AopApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>) <span class="comment">// æ³¨æ„è¿™é‡Œ</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfigure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(AopApplication.class, args);</span><br><span class="line">        MyConfigure myConfigure = context.getBean(MyConfigure.class);</span><br><span class="line">        System.out.println(ClassUtils.isCglibProxy(myConfigure));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">false</span><br></pre></td></tr></table></figure><p>ä¸è¿‡è¿™ä¸ªæ–¹æ³•åºŸå¼ƒäº†ï¼Œå»ºè®®ä½¿ç”¨<code>org.springframework.aop.support.AopUtils.isCglibProxy(Object)</code>æ–¹æ³•ã€‚</p><h3 id="getUserClass"><a href="#getUserClass" class="headerlink" title="getUserClass"></a>getUserClass</h3><p><code>Class&lt;?&gt; getUserClass(Object instance)</code>è¿”å›ç»™å®šå®ä¾‹å¯¹åº”çš„ç±»å‹ï¼Œå¦‚æœå®ä¾‹æ˜¯Cglibä»£ç†åçš„å¯¹è±¡ï¼Œåˆ™è¿”å›ä»£ç†çš„ç›®æ ‡å¯¹è±¡ç±»å‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.getUserClass(<span class="string">"Hello"</span>)); <span class="comment">// class java.lang.String</span></span><br></pre></td></tr></table></figure><p></p><p>Cglibä»£ç†ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AopApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfigure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(AopApplication.class, args);</span><br><span class="line">        MyConfigure myConfigure = context.getBean(MyConfigure.class);</span><br><span class="line">        <span class="comment">// æ³¨æ„å®ƒä»¬çš„åŒºåˆ«</span></span><br><span class="line">        System.out.println(myConfigure.getClass());</span><br><span class="line">        System.out.println(ClassUtils.getUserClass(myConfigure));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class cc.mrbird.aop.AopApplication$MyConfigure$$EnhancerBySpringCGLIB$$e51ce45</span><br><span class="line">class cc.mrbird.aop.AopApplication$MyConfigure</span><br></pre></td></tr></table></figure><h3 id="matchesTypeName"><a href="#matchesTypeName" class="headerlink" title="matchesTypeName"></a>matchesTypeName</h3><p><code>boolean matchesTypeName(Class&lt;?&gt; clazz, @Nullable String typeName)</code>åˆ¤æ–­ç»™å®šclasså’Œç±»å‹åç§°æ˜¯å¦åŒ¹é…ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.matchesTypeName(String.class, <span class="string">"java.lang.String"</span>)); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p></p><h3 id="getShortName"><a href="#getShortName" class="headerlink" title="getShortName"></a>getShortName</h3><p><code>String getShortName(Class&lt;?&gt; clazz)</code>è¿”å›ç±»åï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.getShortName(String.class)); <span class="comment">// String</span></span><br></pre></td></tr></table></figure><p></p><h3 id="getShortNameAsProperty"><a href="#getShortNameAsProperty" class="headerlink" title="getShortNameAsProperty"></a>getShortNameAsProperty</h3><p><code>String getShortNameAsProperty(Class&lt;?&gt; clazz)</code>è¿”å›é¦–å­—æ¯å°å†™çš„ç±»åï¼Œå¦‚æœæ˜¯å†…éƒ¨ç±»çš„è¯ï¼Œåˆ™å»æ‰å¤–éƒ¨ç±»åï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.getShortNameAsProperty(String.class)); <span class="comment">// string</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">print(ClassUtils.getShortNameAsProperty(String.class)); <span class="comment">// b</span></span><br></pre></td></tr></table></figure><h3 id="getClassFileName"><a href="#getClassFileName" class="headerlink" title="getClassFileName"></a>getClassFileName</h3><p><code>String getClassFileName(Class&lt;?&gt; clazz)</code>è¿”å›ç±»å+.classï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.getShortNameAsProperty(String.class)); <span class="comment">// String.class</span></span><br></pre></td></tr></table></figure><p></p><h3 id="getPackageName"><a href="#getPackageName" class="headerlink" title="getPackageName"></a>getPackageName</h3><p><code>String getPackageName(Class&lt;?&gt; clazz)</code>è¿”å›åŒ…åï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.getShortNameAsProperty(String.class)); <span class="comment">// java.lang</span></span><br></pre></td></tr></table></figure><p></p><h3 id="getQualifiedName"><a href="#getQualifiedName" class="headerlink" title="getQualifiedName"></a>getQualifiedName</h3><p><code>String getQualifiedName(Class&lt;?&gt; clazz)</code>è¿”å›å…¨é™å®šç±»åï¼Œå¦‚æœæ˜¯æ•°ç»„ç±»å‹åˆ™æœ«å°¾åŠ []ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.getQualifiedName(String.class));</span><br><span class="line">print(ClassUtils.getQualifiedName(String[].class));</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.lang.String</span><br><span class="line">java.lang.String[]</span><br></pre></td></tr></table></figure><h3 id="getQualifiedMethodName"><a href="#getQualifiedMethodName" class="headerlink" title="getQualifiedMethodName"></a>getQualifiedMethodName</h3><p><code>String getQualifiedMethodName(Method method)</code>è·å–æ–¹æ³•çš„å…¨é™å®šåï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.getQualifiedMethodName(</span><br><span class="line">        ClassUtils.class.getDeclaredMethod(<span class="string">"getQualifiedMethodName"</span>, Method.class</span><br><span class="line">        )));</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.util.ClassUtils.getQualifiedMethodName</span><br></pre></td></tr></table></figure><h3 id="hasConstructor"><a href="#hasConstructor" class="headerlink" title="hasConstructor"></a>hasConstructor</h3><p><code>boolean hasConstructor(Class&lt;?&gt; clazz, Class&lt;?&gt;... paramTypes)</code>åˆ¤æ–­ç»™å®šç±»å‹æ˜¯å¦æœ‰ç»™å®šç±»å‹å‚æ•°æ„é€ å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.hasConstructor(String.class, String.class));</span><br><span class="line">print(ClassUtils.hasConstructor(String.class, Object.class));</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">false</span><br></pre></td></tr></table></figure><h3 id="getConstructorIfAvailable"><a href="#getConstructorIfAvailable" class="headerlink" title="getConstructorIfAvailable"></a>getConstructorIfAvailable</h3><p><code>&lt;T&gt; Constructor&lt;T&gt; getConstructorIfAvailable(Class&lt;T&gt; clazz, Class&lt;?&gt;... paramTypes)</code>è¿”å›ç»™å®šç±»å‹çš„ç»™å®šå‚æ•°ç±»å‹æ„é€ å™¨ï¼Œæ²¡æœ‰çš„è¯è¿”å›nullï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Constructor&lt;String&gt; constructorIfAvailable = ClassUtils.getConstructorIfAvailable(String.class, String.class);</span><br><span class="line">print(constructorIfAvailable != <span class="keyword">null</span>);</span><br><span class="line">print(constructorIfAvailable.toString());</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">public java.lang.String(java.lang.String)</span><br></pre></td></tr></table></figure><h3 id="hasMethod"><a href="#hasMethod" class="headerlink" title="hasMethod"></a>hasMethod</h3><p><code>boolean hasMethod(Class&lt;?&gt; clazz, Method method)</code>åˆ¤æ–­ç»™å®šç±»å‹æ˜¯å¦æœ‰æŒ‡å®šçš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Method hasMethod = ClassUtils.class.getDeclaredMethod(<span class="string">"hasMethod"</span>, Class.class, Method.class);</span><br><span class="line">print(ClassUtils.hasMethod(ClassUtils.class, hasMethod)); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p></p><p>é‡è½½æ–¹æ³•<code>boolean hasMethod(Class&lt;?&gt; clazz, String methodName, Class&lt;?&gt;... paramTypes)</code>ã€‚</p><h3 id="getMethod"><a href="#getMethod" class="headerlink" title="getMethod"></a>getMethod</h3><p><code>Method getMethod(Class&lt;?&gt; clazz, String methodName, @Nullable Class&lt;?&gt;... paramTypes)</code>ä»æŒ‡å®šç±»å‹ä¸­æ‰¾æŒ‡å®šæ–¹æ³•ï¼Œæ²¡æ‰¾åˆ°æŠ›IllegalStateExceptionå¼‚å¸¸ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ClassUtils.getMethod(ClassUtils.class,<span class="string">"hello"</span>, String.class);</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: Expected method not found: java.lang.NoSuchMethodException: org.springframework.util.ClassUtils.hello(java.lang.String)</span><br></pre></td></tr></table></figure><p>å¦‚æœå¸Œæœ›æ²¡æ‰¾åˆ°è¿”å›nullï¼Œè€ŒéæŠ›å¼‚å¸¸ï¼Œå¯ä»¥ç”¨<code>getMethodIfAvailable</code>æ–¹æ³•ã€‚</p><h3 id="getMethodCountForName"><a href="#getMethodCountForName" class="headerlink" title="getMethodCountForName"></a>getMethodCountForName</h3><p><code>int getMethodCountForName(Class&lt;?&gt; clazz, String methodName)</code>ä»æŒ‡å®šç±»å‹ä¸­é€šè¿‡æ–¹æ³•åç§°æŸ¥æ‰¾è¯¥æ–¹æ³•ä¸ªæ•°ï¼ˆé‡å†™ã€é‡è½½ã€épublicçš„éƒ½ç®—ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(ClassUtils.getMethodCountForName(ClassUtils.class,<span class="string">"hasMethod"</span>)); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure><p></p><p>ç±»ä¼¼çš„æ–¹æ³•è¿˜æœ‰<code>hasAtLeastOneMethodWithName</code>ï¼Œè‡³å°‘å¾—æœ‰ä¸€ä¸ªã€‚</p><h3 id="getStaticMethod"><a href="#getStaticMethod" class="headerlink" title="getStaticMethod"></a>getStaticMethod</h3><p><code>Method getStaticMethod(Class&lt;?&gt; clazz, String methodName, Class&lt;?&gt;... args)</code>è·å–ç»™å®šç±»å‹çš„é™æ€æ–¹æ³•ï¼Œå¦‚æœè¯¥æ–¹æ³•ä¸æ˜¯é™æ€çš„æˆ–è€…æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œåˆ™è¿”å›nullï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Method method = ClassUtils.getStaticMethod(ClassUtils.class, <span class="string">"getDefaultClassLoader"</span>);</span><br><span class="line">print(method != <span class="keyword">null</span>);</span><br><span class="line">print(method.getReturnType());</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">class java.lang.ClassLoader</span><br></pre></td></tr></table></figure><h2 id="FileSystemUtils"><a href="#FileSystemUtils" class="headerlink" title="FileSystemUtils"></a>FileSystemUtils</h2><p>æ–‡ä»¶ç³»ç»Ÿå®ç”¨å·¥å…·ç±»</p><h3 id="deleteRecursively"><a href="#deleteRecursively" class="headerlink" title="deleteRecursively"></a>deleteRecursively</h3><p><code>boolean deleteRecursively(@Nullable File root)</code>é€’å½’åˆ é™¤æŒ‡å®šæ–‡ä»¶æˆ–ç›®å½•ï¼Œåˆ é™¤æˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›falseï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><p>æ–°å»ºä¸€ä¸ªå¤šå±‚çº§ç›®å½•ï¼š</p><p><img src="img/QQ20201223-160010@2x.png" alt="QQ20201223-160010@2x"></p><p>å®ç”¨Fileçš„deleteç›®å½•å°è¯•åˆ é™¤aç›®å½•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">File file = <span class="keyword">new</span> File(<span class="string">"a"</span>);</span><br><span class="line">print(file.delete()); <span class="comment">// false</span></span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºaç›®å½•åŒ…å«å­ç›®å½•ï¼ˆæ–‡ä»¶ï¼‰ï¼Œæ‰€ä»¥åº”è¯¥ä½¿ç”¨é€’å½’åˆ é™¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">File file = <span class="keyword">new</span> File(<span class="string">"a"</span>);</span><br><span class="line">print(FileSystemUtils.deleteRecursively(file)); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p>é‡è½½æ–¹æ³•<code>boolean deleteRecursively(@Nullable Path root)</code>å’Œè¯¥æ–¹æ³•åŠŸèƒ½ç›¸ä¼¼ï¼Œä½†è¯¥æ–¹æ³•å¯èƒ½ä¼šæŠ›å‡ºIOå¼‚å¸¸ã€‚</p><h3 id="copyRecursively"><a href="#copyRecursively" class="headerlink" title="copyRecursively"></a>copyRecursively</h3><p><code>void copyRecursively(File src, File dest)</code>é€’å½’å¤åˆ¶srcæ–‡ä»¶åˆ°destï¼ˆç›®æ ‡è·¯å¾„ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»ºï¼‰ï¼š</p><p>æ–°å»ºä¸€ä¸ªå¤šå±‚çº§ç›®å½•ï¼š</p><p><img src="img/QQ20201223-160010@2x.png" alt="QQ20201223-160010@2x"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">File src = <span class="keyword">new</span> File(<span class="string">"a"</span>);</span><br><span class="line">File dest = <span class="keyword">new</span> File(<span class="string">"aa"</span>);</span><br><span class="line">FileSystemUtils.copyRecursively(src, dest);</span><br></pre></td></tr></table></figure><p><img src="img/QQ20201223-161119@2x.png" alt="QQ20201223-161119@2x"></p><p>é‡è½½æ–¹æ³•<code>void copyRecursively(Path src, Path dest)</code>ã€‚</p><h2 id="StreamUtils"><a href="#StreamUtils" class="headerlink" title="StreamUtils"></a>StreamUtils</h2><p>åŒ…å«ä¸€äº›æ–‡ä»¶æµçš„å®ç”¨æ–¹æ³•é»˜è®¤çš„ç¼“å†²åŒºå¤§å°ä¸º4096bytesã€‚</p><div class="note danger">æ³¨æ„ï¼šè¯¥å·¥å…·ç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¸ä¼šå¯¹æµè¿›è¡Œå…³é—­å¤„ç†ï¼</div><blockquote><p>æœªå®Œå¾…ç»­ï¼Œæ…¢æ…¢è®°å½•ğŸ˜´</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:21 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;æˆ‘ä»¬é¡¹ç›®å¤§å¤šæ•°éƒ½æ˜¯åŸºäºSpringæ¶æ„ï¼ŒSpringè‡ªèº«åŒ…å«äº†è®¸å¤šå®ç”¨çš„å·¥å…·ç±»ï¼Œå­¦ä¹ è¿™äº›å·¥å…·ç±»çš„ä½¿ç”¨ä¸ä»…èƒ½è®©æˆ‘ä»¬è¾¾åˆ°äº‹åŠåŠŸå€çš„æ•ˆæœï¼Œè€Œä¸”è¿˜èƒ½å‡å°‘ä¸å¿…è¦çš„é¢å¤–çš„å·¥å…·ç±»çš„å¼•å…¥ã€‚æŸ¥çœ‹è¿™äº›å·¥å…·ç±»çš„æºç æ—¶å‘ç°å®ƒä»¬éƒ½æ˜¯abstractç±»å‹çš„ï¼Œè¿™æ˜¯å› ä¸ºå·¥å…·ç±»çš„æ–¹æ³•ä¸€èˆ¬éƒ½æ˜¯staticé™æ€æ–¹æ³•ï¼Œé™æ€æ–¹æ³•å’Œç±»ç»‘å®šï¼Œç±»åŠ è½½åå°±èƒ½ä½¿ç”¨äº†ï¼Œæ— éœ€å®ä¾‹åŒ–ï¼ˆåˆšå¥½abstractç±»ä¸èƒ½ç›´æ¥å®ä¾‹åŒ–ï¼Œå¹¶ä¸”å¯ä»¥å®šä¹‰éæŠ½è±¡æ–¹æ³•ï¼‰ï¼Œæ‰€ä»¥å·¥å…·ç±»å®šä¹‰ä¸ºabstractç±»å‹å†åˆé€‚ä¸è¿‡ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring" scheme="http://mrbird.cc/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Java æ•°å­—ç­¾åç®—æ³•</title>
    <link href="http://mrbird.cc/Java-%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95.html"/>
    <id>http://mrbird.cc/Java-æ•°å­—ç­¾åç®—æ³•.html</id>
    <published>2020-05-17T06:25:21.000Z</published>
    <updated>2020-08-27T09:01:20.873Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:20 GMT+0800 (GMT+08:00) --><p>æ•°å­—ç­¾åç®—æ³•å¯ä»¥çœ‹æˆæ˜¯å¸¦ç§˜é’¥çš„æ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼Œç”¨äºéªŒè¯æ•°æ®å®Œæ•´æ€§ã€è®¤è¯æ•°æ®æ¥æºï¼Œå¹¶èµ·åˆ°æŠ—å¦è®¤çš„ä½œç”¨ã€‚éµå¾ªç§é’¥åŠ ç­¾ï¼Œå…¬é’¥éªŒç­¾çš„è§„åˆ™ï¼Œæ•°å­—ç­¾åç®—æ³•æ˜¯éå¯¹ç§°åŠ å¯†ç®—æ³•å’Œæ¶ˆæ¯æ‘˜è¦ç®—æ³•çš„ç»“åˆä½“ã€‚æ•°å­—ç­¾åç®—æ³•ä¸»è¦åŒ…æ‹¬RSAå’ŒDSAã€‚è¿™èŠ‚è®°å½•ä¸‹è¿™ä¸¤ç§ç®—æ³•åœ¨JDK8ä¸‹çš„å®ç°ã€‚<a id="more"></a></p><p>æ•°å­—ç­¾ååŠ ç­¾éªŒç­¾æµç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p><ol><li>Aåœ¨æœ¬åœ°æ„å»ºç§˜é’¥å¯¹ï¼Œå¹¶å°†å…¬é’¥å‘å¸ƒç»™Bï¼›</li><li>Aä½¿ç”¨ç§é’¥å¯¹æ•°æ®è¿›è¡Œç­¾åï¼›</li><li>Aå‘é€ç­¾åå’Œæ•°æ®ç»™Bï¼›</li><li>Bä½¿ç”¨å…¬é’¥å¯¹ç­¾åå’Œæ•°æ®è¿›è¡ŒéªŒç­¾ã€‚</li></ol><h2 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h2><p>RSAæ•°å­—ç­¾åç®—æ³•ä¸»è¦åˆ†ä¸ºMDç³»åˆ—å’ŒSHAç³»åˆ—ä¸¤å¤§ç±»ã€‚MDç³»åˆ—ä¸»è¦åŒ…æ‹¬MD2withRSAå’ŒMD5withRSAå…±2ç§æ•°å­—ç­¾åç®—æ³•ï¼›SHAç³»åˆ—ä¸»è¦åŒ…æ‹¬SHA1withRSAã€SHA224withRSAã€SHA256withRSAã€SHA384withRSAå’ŒSHA512withRSAå…±5ç§æ•°å­—ç­¾åç®—æ³•ã€‚</p><p>ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RsaSignatureDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String value = <span class="string">"mrbird's blog"</span>;</span><br><span class="line">        <span class="comment">// éå¯¹ç§°åŠ å¯†ç®—æ³•</span></span><br><span class="line">        String algorithm = <span class="string">"RSA"</span>;</span><br><span class="line">        <span class="comment">// ç­¾åç®—æ³•ï¼ŒRSA+SHA</span></span><br><span class="line">        String signAlgorithm = <span class="string">"SHA256withRSA"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----- å…¬ç§é’¥ç”Ÿæˆ --------</span></span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–ç§˜é’¥å¯¹ç”Ÿæˆå™¨</span></span><br><span class="line">        KeyPairGenerator keyPairGenerator = KeyPairGenerator.getInstance(algorithm);</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ï¼Œç§˜é’¥é•¿åº¦512~16384ä½ï¼Œ64å€æ•°</span></span><br><span class="line">        keyPairGenerator.initialize(<span class="number">512</span>);</span><br><span class="line">        <span class="comment">// ç”Ÿæˆç§˜é’¥å¯¹</span></span><br><span class="line">        KeyPair keyPair = keyPairGenerator.generateKeyPair();</span><br><span class="line">        <span class="comment">// å…¬é’¥</span></span><br><span class="line">        PublicKey publicKey = keyPair.getPublic();</span><br><span class="line">        System.out.println(<span class="string">"RSAå…¬é’¥: "</span> + Base64.getEncoder().encodeToString(publicKey.getEncoded()));</span><br><span class="line">        <span class="comment">// ç§é’¥</span></span><br><span class="line">        PrivateKey privateKey = keyPair.getPrivate();</span><br><span class="line">        System.out.println(<span class="string">"RSAç§é’¥: "</span> + Base64.getEncoder().encodeToString(privateKey.getEncoded()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----- ç§é’¥åŠ ç­¾ ---------</span></span><br><span class="line">        <span class="comment">// è·å–ç­¾åå¯¹è±¡</span></span><br><span class="line">        Signature signature = Signature.getInstance(signAlgorithm);</span><br><span class="line">        signature.initSign(privateKey);</span><br><span class="line">        signature.update(value.getBytes());</span><br><span class="line">        <span class="keyword">byte</span>[] sign = signature.sign();</span><br><span class="line">        System.out.println(<span class="string">"ç­¾åå€¼: "</span> + Base64.getEncoder().encodeToString(sign));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----- å…¬é’¥éªŒç­¾ ---------</span></span><br><span class="line">        signature.initVerify(publicKey);</span><br><span class="line">        signature.update(value.getBytes());</span><br><span class="line">        System.out.println(<span class="string">"éªŒç­¾ç»“æœ: "</span> + signature.verify(sign));</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç§˜é’¥å¯¹ç”Ÿæˆè¿‡ç¨‹å’Œä¸Šç¯‡RSAä»‹ç»çš„æ— å¼‚ï¼Œä¸»è¦å…³æ³¨åŠ ç­¾å’ŒéªŒç­¾æ“ä½œå³å¯ï¼Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RSAå…¬é’¥: MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAKTTlw+zyhGzmTmhT5w9vEP1ejOcVfM2rHbz8jUae7InAh42R9ZaYUk1c3q0uqmTv8xKOnszU/vrdV52zoFM+OMCAwEAAQ==</span><br><span class="line">RSAç§é’¥: MIIBUwIBADANBgkqhkiG9w0BAQEFAASCAT0wggE5AgEAAkEApNOXD7PKEbOZOaFPnD28Q/V6M5xV8zasdvPyNRp7sicCHjZH1lphSTVzerS6qZO/zEo6ezNT++t1XnbOgUz44wIDAQABAkBsZQXz+p2J1J2Qq8fqDSNxYc8Sf956SttSgw0m5Rqxxiw10cgHt67uocu3qK6UeMuJuaOiN3YT48kvFp6Joc75AiEA4L7R1zDWcOdWf2BE/k3yxJ4Uv0vbIZ9vWLuJGBR3xK0CIQC7v5f2fcedBWbJ/kR7CvbFE91ivM55dvWZMe/JrjXVzwIgFUn+FqRJq+g+CVLVNkGr/XP8AyLsXwL7SSx6kA1gSwECIHysAn4VEftr/dC+Pr0yD6HYyhbp53XzD6214lQbkfYzAiB1b2wNi0Y3N+D/OIrGUHlwgA0vkX82NP3V8qMDmRbCTQ==</span><br><span class="line">ç­¾åå€¼: HVN5WkhND0hy/xY43h8r3+AVt6oxMSv1Ug/Y+bv1tGxw4ePQtIgzFwK0lQQbhIlwts2d2STwQBews4dXCfEMmA==</span><br><span class="line">éªŒç­¾ç»“æœ: true</span><br></pre></td></tr></table></figure><p></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ä¸åŒç­¾åç®—æ³•éœ€è¦çš„ç§˜é’¥é•¿åº¦æœ€å°å€¼ä¸åŒï¼Œå¤§ä¼™å¯ä»¥è‡ªå·±è¯•è¯•ã€‚</p><h2 id="DSA"><a href="#DSA" class="headerlink" title="DSA"></a>DSA</h2><p>DSAç®—æ³•ä¸RSAç®—æ³•éƒ½æ˜¯æ•°å­—è¯ä¹¦ä¸­ä¸å¯æˆ–ç¼ºçš„ä¸¤ç§ç®—æ³•ã€‚ä¸¤è€…ä¸åŒçš„æ˜¯ï¼ŒDSAç®—æ³•ä»…åŒ…å«æ•°å­—ç­¾åç®—æ³•ï¼Œä½¿ç”¨DSAç®—æ³•çš„æ•°å­—è¯ä¹¦æ— æ³•è¿›è¡ŒåŠ å¯†é€šä¿¡ï¼Œè€ŒRSAç®—æ³•æ—¢åŒ…å«åŠ å¯†/è§£å¯†ç®—æ³•ï¼ŒåŒæ—¶å…¼æœ‰æ•°å­—ç­¾åç®—æ³•ã€‚</p><p>JDK8æ”¯æŒSHA1withDSAã€SHA224withDSAã€SHA256withDSAã€SHA384withDSAå’ŒSHA512withDSAè¿™äº”ç§DSAæ•°å­—ç­¾åç®—æ³•ã€‚</p><p>ä»£ç ç¤ºä¾‹ï¼ˆåªéœ€å°†ä¸Šé¢çš„ä¾‹å­ç®—æ³•æ›¿æ¢ä¸‹å°±å¥½ï¼Œå¹¶ä¸”æ³¨æ„ç§˜é’¥çš„é•¿åº¦èŒƒå›´ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RsaSignatureDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String value = <span class="string">"mrbird's blog"</span>;</span><br><span class="line">        <span class="comment">// éå¯¹ç§°åŠ å¯†ç®—æ³•</span></span><br><span class="line">        String algorithm = <span class="string">"DSA"</span>;</span><br><span class="line">        <span class="comment">// ç­¾åç®—æ³•ï¼ŒDSA+SHA</span></span><br><span class="line">        String signAlgorithm = <span class="string">"SHA224withDSA"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----- å…¬ç§é’¥ç”Ÿæˆ --------</span></span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–ç§˜é’¥å¯¹ç”Ÿæˆå™¨</span></span><br><span class="line">        KeyPairGenerator keyPairGenerator = KeyPairGenerator.getInstance(algorithm);</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ï¼Œç§˜é’¥é•¿åº¦512~1024ä½ï¼Œ64å€æ•°</span></span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">// ç”Ÿæˆç§˜é’¥å¯¹</span></span><br><span class="line">        KeyPair keyPair = keyPairGenerator.generateKeyPair();</span><br><span class="line">        <span class="comment">// å…¬é’¥</span></span><br><span class="line">        PublicKey publicKey = keyPair.getPublic();</span><br><span class="line">        System.out.println(<span class="string">"DSAå…¬é’¥: "</span> + Base64.getEncoder().encodeToString(publicKey.getEncoded()));</span><br><span class="line">        <span class="comment">// ç§é’¥</span></span><br><span class="line">        PrivateKey privateKey = keyPair.getPrivate();</span><br><span class="line">        System.out.println(<span class="string">"DSAç§é’¥: "</span> + Base64.getEncoder().encodeToString(privateKey.getEncoded()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----- ç§é’¥åŠ ç­¾ ---------</span></span><br><span class="line">        <span class="comment">// è·å–ç­¾åå¯¹è±¡</span></span><br><span class="line">        Signature signature = Signature.getInstance(signAlgorithm);</span><br><span class="line">        signature.initSign(privateKey);</span><br><span class="line">        signature.update(value.getBytes());</span><br><span class="line">        <span class="keyword">byte</span>[] sign = signature.sign();</span><br><span class="line">        System.out.println(<span class="string">"ç­¾åå€¼: "</span> + Base64.getEncoder().encodeToString(sign));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----- å…¬é’¥éªŒç­¾ ---------</span></span><br><span class="line">        signature.initVerify(publicKey);</span><br><span class="line">        signature.update(value.getBytes());</span><br><span class="line">        System.out.println(<span class="string">"éªŒç­¾ç»“æœ: "</span> + signature.verify(sign));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DSAå…¬é’¥: MIIBtzCCASwGByqGSM44BAEwggEfAoGBAP1/U4EddRIpUt9KnC7s5Of2EbdSPO9EAMMeP4C2USZpRV1AIlH7WT2NWPq/xfW6MPbLm1Vs14E7gB00b/JmYLdrmVClpJ+f6AR7ECLCT7up1/63xhv4O1fnxqimFQ8E+4P208UewwI1VBNaFpEy9nXzrith1yrv8iIDGZ3RSAHHAhUAl2BQjxUjC8yykrmCouuEC/BYHPUCgYEA9+GghdabPd7LvKtcNrhXuXmUr7v6OuqC+VdMCz0HgmdRWVeOutRZT+ZxBxCBgLRJFnEj6EwoFhO3zwkyjMim4TwWeotUfI0o4KOuHiuzpnWRbqN/C/ohNWLx+2J6ASQ7zKTxvqhRkImog9/hWuWfBpKLZl6Ae1UlZAFMO/7PSSoDgYQAAoGAcW0aiebAWi5M18Lu6QS/1OoHbtw2I7kyivwExbNAZpWR9I9sNIwE1T0a491t1oqRV1cdBHyd9jiJqFwfLG6k5QidasXTgGYSsSZqFBebP5nrF5q3RtkosoHeHVKDnShQf5b36NK53CpCRfLayk2e5inu7CCCo+a58piAMiF3c+k=</span><br><span class="line">DSAç§é’¥: MIIBTAIBADCCASwGByqGSM44BAEwggEfAoGBAP1/U4EddRIpUt9KnC7s5Of2EbdSPO9EAMMeP4C2USZpRV1AIlH7WT2NWPq/xfW6MPbLm1Vs14E7gB00b/JmYLdrmVClpJ+f6AR7ECLCT7up1/63xhv4O1fnxqimFQ8E+4P208UewwI1VBNaFpEy9nXzrith1yrv8iIDGZ3RSAHHAhUAl2BQjxUjC8yykrmCouuEC/BYHPUCgYEA9+GghdabPd7LvKtcNrhXuXmUr7v6OuqC+VdMCz0HgmdRWVeOutRZT+ZxBxCBgLRJFnEj6EwoFhO3zwkyjMim4TwWeotUfI0o4KOuHiuzpnWRbqN/C/ohNWLx+2J6ASQ7zKTxvqhRkImog9/hWuWfBpKLZl6Ae1UlZAFMO/7PSSoEFwIVAIv03r5wR+DolDC5bGFOqQ2vuHlo</span><br><span class="line">ç­¾åå€¼: MCwCFBRba/HI5/tLt+exzpgvLoq5mAwaAhQvaVv4dbGFNtMpcI4ZeqjgAGeGyg==</span><br><span class="line">éªŒç­¾ç»“æœ: true</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:20 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;æ•°å­—ç­¾åç®—æ³•å¯ä»¥çœ‹æˆæ˜¯å¸¦ç§˜é’¥çš„æ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼Œç”¨äºéªŒè¯æ•°æ®å®Œæ•´æ€§ã€è®¤è¯æ•°æ®æ¥æºï¼Œå¹¶èµ·åˆ°æŠ—å¦è®¤çš„ä½œç”¨ã€‚éµå¾ªç§é’¥åŠ ç­¾ï¼Œå…¬é’¥éªŒç­¾çš„è§„åˆ™ï¼Œæ•°å­—ç­¾åç®—æ³•æ˜¯éå¯¹ç§°åŠ å¯†ç®—æ³•å’Œæ¶ˆæ¯æ‘˜è¦ç®—æ³•çš„ç»“åˆä½“ã€‚æ•°å­—ç­¾åç®—æ³•ä¸»è¦åŒ…æ‹¬RSAå’ŒDSAã€‚è¿™èŠ‚è®°å½•ä¸‹è¿™ä¸¤ç§ç®—æ³•åœ¨JDK8ä¸‹çš„å®ç°ã€‚
    
    </summary>
    
    
      <category term="Security" scheme="http://mrbird.cc/tags/Security/"/>
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Java éå¯¹ç§°åŠ å¯†ç®—æ³•RSA</title>
    <link href="http://mrbird.cc/Java-%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95.html"/>
    <id>http://mrbird.cc/Java-éå¯¹ç§°åŠ å¯†ç®—æ³•.html</id>
    <published>2020-05-15T03:22:36.000Z</published>
    <updated>2020-08-27T06:26:00.006Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue Dec 14 2021 15:16:20 GMT+0800 (GMT+08:00) --><p>éå¯¹ç§°åŠ å¯†å’Œå¯¹ç§°åŠ å¯†ç®—æ³•ç›¸æ¯”ï¼Œå¤šäº†ä¸€æŠŠç§˜é’¥ï¼Œä¸ºåŒç§˜é’¥æ¨¡å¼ï¼Œä¸€ä¸ªå…¬å¼€ç§°ä¸ºå…¬é’¥ï¼Œä¸€ä¸ªä¿å¯†ç§°ä¸ºç§é’¥ã€‚éµå¾ªå…¬é’¥åŠ å¯†ç§é’¥è§£å¯†ï¼Œæˆ–è€…ç§é’¥åŠ å¯†å…¬é’¥è§£å¯†ã€‚éå¯¹ç§°åŠ å¯†ç®—æ³•æºäºDHç®—æ³•ï¼Œååˆæœ‰åŸºäºæ¤­åœ†æ›²çº¿åŠ å¯†ç®—æ³•çš„å¯†é’¥äº¤æ¢ç®—æ³•ECDHï¼Œä¸è¿‡ç›®å‰æœ€ä¸ºæµè¡Œçš„éå¯¹ç§°åŠ å¯†ç®—æ³•æ˜¯RSAï¼Œæœ¬æ–‡ç®€å•è®°å½•ä¸‹RSAçš„ä½¿ç”¨ã€‚<a id="more"></a></p><h2 id="RSAç®—æ³•"><a href="#RSAç®—æ³•" class="headerlink" title="RSAç®—æ³•"></a>RSAç®—æ³•</h2><p>RSAç®—æ³•æ˜¯æœ€ä¸ºå…¸å‹çš„éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œè¯¥ç®—æ³•ç”±ç¾å›½éº»çœç†å·¥å­¦é™¢ï¼ˆMITï¼‰çš„Ron Rivestã€Adi Shamirå’ŒLeonard Adlemanä¸‰ä½å­¦è€…æå‡ºï¼Œå¹¶ä»¥è¿™ä¸‰ä½å­¦è€…çš„å§“æ°å¼€å¤´å­—æ¯å‘½åï¼Œç§°ä¸ºRSAç®—æ³•ã€‚</p><p>RSAç®—æ³•çš„æ•°æ®äº¤æ¢è¿‡ç¨‹åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š</p><ol><li>Aæ„å»ºRSAç§˜é’¥å¯¹ï¼›</li><li>Aå‘Bå‘å¸ƒå…¬é’¥ï¼›</li><li>Aç”¨ç§é’¥åŠ å¯†æ•°æ®å‘ç»™Bï¼›</li><li>Bç”¨å…¬é’¥è§£å¯†æ•°æ®ï¼›</li><li>Bç”¨å…¬é’¥åŠ å¯†æ•°æ®å‘ç»™Aï¼›</li><li>Aç”¨ç§é’¥è§£å¯†æ•°æ®ã€‚</li></ol><p>JDK8æ”¯æŒRSAç®—æ³•ï¼š</p><table><tr><th>ç®—æ³•</th><th>ç§˜é’¥é•¿åº¦</th><th>åŠ å¯†æ¨¡å¼</th><th>å¡«å……æ¨¡å¼</th></tr><tr><td>RSA</td><td>512~16384ä½ï¼Œ64å€æ•°</td><td>ECB</td><td>NoPadding<br>PKCS1Padding<br>OAEPWithMD5AndMGF1Padding<br>OAEPWithSHA1AndMGF1Padding<br>OAEPWithSHA-1AndMGF1Padding<br>OAEPWithSHA-224AndMGF1Padding<br>OAEPWithSHA-256AndMGF1Padding<br>OAEPWithSHA-384AndMGF1Padding<br>OAEPWithSHA-512AndMGF1Padding OAEPWithSHA-512/224AndMGF1Padding<br>OAEPWithSHA-512/2256ndMGF1Padding</td></tr></table><p>ä»£ç ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivateKey;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String value = <span class="string">"mrbird's blog"</span>;</span><br><span class="line">        <span class="comment">// åŠ å¯†ç®—æ³•</span></span><br><span class="line">        String algorithm = <span class="string">"RSA"</span>;</span><br><span class="line">        <span class="comment">// è½¬æ¢æ¨¡å¼</span></span><br><span class="line">        String transform = <span class="string">"RSA/ECB/PKCS1Padding"</span>;</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–ç§˜é’¥å¯¹ç”Ÿæˆå™¨</span></span><br><span class="line">        KeyPairGenerator keyPairGenerator = KeyPairGenerator.getInstance(algorithm);</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ï¼Œç§˜é’¥é•¿åº¦512~16384ä½ï¼Œ64å€æ•°</span></span><br><span class="line">        keyPairGenerator.initialize(<span class="number">512</span>);</span><br><span class="line">        <span class="comment">// ç”Ÿæˆç§˜é’¥å¯¹</span></span><br><span class="line">        KeyPair keyPair = keyPairGenerator.generateKeyPair();</span><br><span class="line">        <span class="comment">// å…¬é’¥</span></span><br><span class="line">        PublicKey publicKey = keyPair.getPublic();</span><br><span class="line">        System.out.println(<span class="string">"RSAå…¬é’¥: "</span> + Base64.getEncoder().encodeToString(publicKey.getEncoded()));</span><br><span class="line">        <span class="comment">// ç§é’¥</span></span><br><span class="line">        PrivateKey privateKey = keyPair.getPrivate();</span><br><span class="line">        System.out.println(<span class="string">"RSAç§é’¥: "</span> + Base64.getEncoder().encodeToString(privateKey.getEncoded()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ------ æµ‹è¯•å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯† ------</span></span><br><span class="line">        Cipher cipher = Cipher.getInstance(transform);</span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, publicKey);</span><br><span class="line">        <span class="keyword">byte</span>[] pubEncryptBytes = cipher.doFinal(value.getBytes());</span><br><span class="line">        System.out.println(<span class="string">"RSAå…¬é’¥åŠ å¯†åæ•°æ®: "</span> + Base64.getEncoder().encodeToString(pubEncryptBytes));</span><br><span class="line"></span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, privateKey);</span><br><span class="line">        <span class="keyword">byte</span>[] priDecryptBytes = cipher.doFinal(pubEncryptBytes);</span><br><span class="line">        System.out.println(<span class="string">"RSAç§é’¥è§£å¯†åæ•°æ®: "</span> + <span class="keyword">new</span> String(priDecryptBytes));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ------ æµ‹è¯•ç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯† ------</span></span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, privateKey);</span><br><span class="line">        <span class="keyword">byte</span>[] priEncryptBytes = cipher.doFinal(value.getBytes());</span><br><span class="line">        System.out.println(<span class="string">"RSAç§é’¥åŠ å¯†åæ•°æ®: "</span> + Base64.getEncoder().encodeToString(priEncryptBytes));</span><br><span class="line"></span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, publicKey);</span><br><span class="line">        <span class="keyword">byte</span>[] pubDecryptBytes = cipher.doFinal(priEncryptBytes);</span><br><span class="line">        System.out.println(<span class="string">"RSAå…¬é’¥è§£å¯†åæ•°æ®: "</span> + <span class="keyword">new</span> String(pubDecryptBytes));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RSAå…¬é’¥: MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAKBvz9cma+hXNiv2yXg6e1PyZhHVZm3bJXDvTJP2LyXo4vs9grH36Q9kNgr6quHtuU6fEoUxUu2zbEB8dkEWB9UCAwEAAQ==</span><br><span class="line">RSAç§é’¥: MIIBVAIBADANBgkqhkiG9w0BAQEFAASCAT4wggE6AgEAAkEAoG/P1yZr6Fc2K/bJeDp7U/JmEdVmbdslcO9Mk/YvJeji+z2CsffpD2Q2Cvqq4e25Tp8ShTFS7bNsQHx2QRYH1QIDAQABAkEAjemZXORdesz52/WVzEVepai6ZHfw/Kdl/PmPMSoIFmz7mk55rprl2Akn2V0odSiHSnMWvDmOUIAvHaHF4Re4wQIhAN5GxVeF7ndyoWasxqIOVb6baNkUrapBM0nacPS4WA8JAiEAuMcvNM2Z1rW74JagoGlSIfRkNUqa+3LTCN/fK7VR2W0CICs/+gYduVjkpSMlW0ENKQH9m1kh/Oiz5xbnujLj676BAiBVGif7wdXgtcLaJYXFW7ygNtcQVFQdCz13EOTQVKpl4QIgY2YyH3vUYI2J68qCGtYjj5iNHUEwwze+Za1R7y0V43k=</span><br><span class="line">RSAå…¬é’¥åŠ å¯†åæ•°æ®: O55w+9ve4QPcNDXNXF3W6O3J9UHxGBWlOM8W5RkKIslMR5xoUkBqIufWO2mz5MWezfxHB9yH1mPQgrv3H1hMKQ==</span><br><span class="line">RSAç§é’¥è§£å¯†åæ•°æ®: mrbird&apos;s blog</span><br><span class="line">RSAç§é’¥åŠ å¯†åæ•°æ®: UtwtFxWstrg+fQV6WSw8PYY1YP5K9bjYH7uY20SQIJ5iWQ9FEERi8+ttk2MougQro66aiJRpdCeSpIVi09J+Ew==</span><br><span class="line">RSAå…¬é’¥è§£å¯†åæ•°æ®: mrbird&apos;s blog</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå…¬é’¥åŠ å¯†ç§é’¥è§£å¯†å’Œç§é’¥åŠ å¯†å…¬é’¥è§£å¯†çš„æ¨¡å¼éƒ½å¯è¡Œã€‚</p><h2 id="å…¬ç§é’¥è·å–"><a href="#å…¬ç§é’¥è·å–" class="headerlink" title="å…¬ç§é’¥è·å–"></a>å…¬ç§é’¥è·å–</h2><p>å‡å¦‚ç°åœ¨æœ‰RSAå…¬é’¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAKBvz9cma+hXNiv2yXg6e1PyZhHVZm3bJXDvTJP2LyXo4vs9grH36Q9kNgr6quHtuU6fEoUxUu2zbEB8dkEWB9UCAwEAAQ==</span><br></pre></td></tr></table></figure><p></p><p>RSAç§é’¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MIIBVAIBADANBgkqhkiG9w0BAQEFAASCAT4wggE6AgEAAkEAoG/P1yZr6Fc2K/bJeDp7U/JmEdVmbdslcO9Mk/YvJeji+z2CsffpD2Q2Cvqq4e25Tp8ShTFS7bNsQHx2QRYH1QIDAQABAkEAjemZXORdesz52/WVzEVepai6ZHfw/Kdl/PmPMSoIFmz7mk55rprl2Akn2V0odSiHSnMWvDmOUIAvHaHF4Re4wQIhAN5GxVeF7ndyoWasxqIOVb6baNkUrapBM0nacPS4WA8JAiEAuMcvNM2Z1rW74JagoGlSIfRkNUqa+3LTCN/fK7VR2W0CICs/+gYduVjkpSMlW0ENKQH9m1kh/Oiz5xbnujLj676BAiBVGif7wdXgtcLaJYXFW7ygNtcQVFQdCz13EOTQVKpl4QIgY2YyH3vUYI2J68qCGtYjj5iNHUEwwze+Za1R7y0V43k=</span><br></pre></td></tr></table></figure><p></p><p>éœ€è¦å°†å®ƒä»¬è¿˜åŸä¸ºPublicKeyå’ŒPrivateKeyå¯¹è±¡ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyFactory;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivateKey;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.PKCS8EncodedKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.X509EncodedKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String value = <span class="string">"mrbird's blog"</span>;</span><br><span class="line">        <span class="comment">// åŠ å¯†ç®—æ³•</span></span><br><span class="line">        String algorithm = <span class="string">"RSA"</span>;</span><br><span class="line">        <span class="comment">// è½¬æ¢æ¨¡å¼</span></span><br><span class="line">        String transform = <span class="string">"RSA/ECB/PKCS1Padding"</span>;</span><br><span class="line">        <span class="comment">// RSAå…¬é’¥BASE64å­—ç¬¦ä¸²</span></span><br><span class="line">        String rsaPublicKey = <span class="string">"MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAKBvz9cma+hXNiv2yXg6e1PyZhHVZm3bJXDvTJP2LyXo4vs9grH36Q9kNgr6quHtuU6fEoUxUu2zbEB8dkEWB9UCAwEAAQ=="</span>;</span><br><span class="line">        <span class="comment">// RSAç§é’¥BASE64å­—ç¬¦ä¸²</span></span><br><span class="line">        String rsaPrivateKey = <span class="string">"MIIBVAIBADANBgkqhkiG9w0BAQEFAASCAT4wggE6AgEAAkEAoG/P1yZr6Fc2K/bJeDp7U/JmEdVmbdslcO9Mk/YvJeji+z2CsffpD2Q2Cvqq4e25Tp8ShTFS7bNsQHx2QRYH1QIDAQABAkEAjemZXORdesz52/WVzEVepai6ZHfw/Kdl/PmPMSoIFmz7mk55rprl2Akn2V0odSiHSnMWvDmOUIAvHaHF4Re4wQIhAN5GxVeF7ndyoWasxqIOVb6baNkUrapBM0nacPS4WA8JAiEAuMcvNM2Z1rW74JagoGlSIfRkNUqa+3LTCN/fK7VR2W0CICs/+gYduVjkpSMlW0ENKQH9m1kh/Oiz5xbnujLj676BAiBVGif7wdXgtcLaJYXFW7ygNtcQVFQdCz13EOTQVKpl4QIgY2YyH3vUYI2J68qCGtYjj5iNHUEwwze+Za1R7y0V43k="</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ------- è¿˜åŸå…¬é’¥ --------</span></span><br><span class="line">        <span class="keyword">byte</span>[] publicKeyBytes = Base64.getDecoder().decode(rsaPublicKey);</span><br><span class="line">        X509EncodedKeySpec x509EncodedKeySpec = <span class="keyword">new</span> X509EncodedKeySpec(publicKeyBytes);</span><br><span class="line">        KeyFactory keyFactory = KeyFactory.getInstance(algorithm);</span><br><span class="line">        PublicKey publicKey = keyFactory.generatePublic(x509EncodedKeySpec);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ------- è¿˜åŸç§é’¥ --------</span></span><br><span class="line">        <span class="keyword">byte</span>[] privateKeyBytes = Base64.getDecoder().decode(rsaPrivateKey);</span><br><span class="line">        PKCS8EncodedKeySpec pkcs8EncodedKeySpec = <span class="keyword">new</span> PKCS8EncodedKeySpec(privateKeyBytes);</span><br><span class="line">        PrivateKey privateKey = keyFactory.generatePrivate(pkcs8EncodedKeySpec);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ------- æµ‹è¯•åŠ è§£å¯† --------</span></span><br><span class="line">        Cipher cipher = Cipher.getInstance(transform);</span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, publicKey);</span><br><span class="line">        <span class="keyword">byte</span>[] pubEncryptBytes = cipher.doFinal(value.getBytes());</span><br><span class="line">        System.out.println(<span class="string">"RSAå…¬é’¥åŠ å¯†æ•°æ®: "</span> + Base64.getEncoder().encodeToString(pubEncryptBytes));</span><br><span class="line"></span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, privateKey);</span><br><span class="line">        <span class="keyword">byte</span>[] priDecryptBytes = cipher.doFinal(pubEncryptBytes);</span><br><span class="line">        System.out.println(<span class="string">"RSAç§é’¥è§£å¯†æ•°æ®: "</span> + <span class="keyword">new</span> String(priDecryptBytes));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RSAå…¬é’¥åŠ å¯†æ•°æ®: PdSr+WRUWIxbA7stmZ03GCwDBnE3CyFL43bTskJmBilY+9lL63Jt0KxN0S2A4ombxvngbiB8PVZiqj1oSkgWpA==</span><br><span class="line">RSAç§é’¥è§£å¯†æ•°æ®: mrbird&apos;s blog</span><br></pre></td></tr></table></figure><p></p><h2 id="åˆ†æ®µåŠ è§£å¯†"><a href="#åˆ†æ®µåŠ è§£å¯†" class="headerlink" title="åˆ†æ®µåŠ è§£å¯†"></a>åˆ†æ®µåŠ è§£å¯†</h2><p>RSAåŠ è§£å¯†ä¸­å¿…é¡»è€ƒè™‘åˆ°çš„å¯†é’¥é•¿åº¦ã€æ˜æ–‡é•¿åº¦å’Œå¯†æ–‡é•¿åº¦é—®é¢˜ã€‚æ˜æ–‡é•¿åº¦éœ€è¦å°äºå¯†é’¥é•¿åº¦ï¼Œè€Œå¯†æ–‡é•¿åº¦åˆ™ç­‰äºå¯†é’¥é•¿åº¦ã€‚å› æ­¤å½“åŠ å¯†å†…å®¹é•¿åº¦å¤§äºå¯†é’¥é•¿åº¦æ—¶ï¼Œæœ‰æ•ˆçš„RSAåŠ è§£å¯†å°±éœ€è¦å¯¹å†…å®¹è¿›è¡Œåˆ†æ®µã€‚</p><p>è¿™æ˜¯å› ä¸ºï¼ŒRSAç®—æ³•æœ¬èº«è¦æ±‚åŠ å¯†å†…å®¹ä¹Ÿå°±æ˜¯æ˜æ–‡é•¿åº¦må¿…é¡»æ»¡è¶³<code>0&lt;m&lt;å¯†é’¥é•¿åº¦n</code>ã€‚å¦‚æœå°äºè¿™ä¸ªé•¿åº¦å°±éœ€è¦è¿›è¡Œpaddingï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰paddingï¼Œå°±æ— æ³•ç¡®å®šè§£å¯†åå†…å®¹çš„çœŸå®é•¿åº¦ï¼Œå­—ç¬¦ä¸²ä¹‹ç±»çš„å†…å®¹é—®é¢˜è¿˜ä¸å¤§ï¼Œä»¥0ä½œä¸ºç»“æŸç¬¦ï¼Œä½†å¯¹äºŒè¿›åˆ¶æ•°æ®å°±å¾ˆéš¾ï¼Œå› ä¸ºä¸ç¡®å®šåé¢çš„0æ˜¯å†…å®¹è¿˜æ˜¯å†…å®¹ç»“æŸç¬¦ã€‚è€Œåªè¦ç”¨åˆ°paddingï¼Œé‚£ä¹ˆå°±è¦å ç”¨å®é™…çš„æ˜æ–‡é•¿åº¦ï¼Œäºæ˜¯å®é™…æ˜æ–‡é•¿åº¦éœ€è¦å‡å»paddingå­—èŠ‚é•¿åº¦ã€‚æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨çš„paddingæ ‡å‡†æœ‰NoPPaddingã€OAEPPaddingã€PKCS1Paddingç­‰ï¼Œå…¶ä¸­PKCS#1å»ºè®®çš„paddingå°±å ç”¨äº†11ä¸ªå­—èŠ‚ã€‚</p><p>ä»¥ç§˜é’¥é•¿åº¦ä¸º1024bitsä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivateKey;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StringBuilder value = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">29</span>; i++) &#123;</span><br><span class="line">            value.append(<span class="string">"18cm"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"å¾…åŠ å¯†å†…å®¹é•¿åº¦: "</span> + value.toString().length());</span><br><span class="line">        <span class="comment">// åŠ å¯†ç®—æ³•</span></span><br><span class="line">        String algorithm = <span class="string">"RSA"</span>;</span><br><span class="line">        <span class="comment">// è½¬æ¢æ¨¡å¼</span></span><br><span class="line">        String transform = <span class="string">"RSA/ECB/PKCS1Padding"</span>;</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–ç§˜é’¥å¯¹ç”Ÿæˆå™¨</span></span><br><span class="line">        KeyPairGenerator keyPairGenerator = KeyPairGenerator.getInstance(algorithm);</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ï¼Œç§˜é’¥é•¿åº¦512~16384ä½ï¼Œ64å€æ•°</span></span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">// ç”Ÿæˆç§˜é’¥å¯¹</span></span><br><span class="line">        KeyPair keyPair = keyPairGenerator.generateKeyPair();</span><br><span class="line">        <span class="comment">// å…¬é’¥</span></span><br><span class="line">        PublicKey publicKey = keyPair.getPublic();</span><br><span class="line">        System.out.println(<span class="string">"RSAå…¬é’¥: "</span> + Base64.getEncoder().encodeToString(publicKey.getEncoded()));</span><br><span class="line">        <span class="comment">// ç§é’¥</span></span><br><span class="line">        PrivateKey privateKey = keyPair.getPrivate();</span><br><span class="line">        System.out.println(<span class="string">"RSAç§é’¥: "</span> + Base64.getEncoder().encodeToString(privateKey.getEncoded()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ------ æµ‹è¯•å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯† ------</span></span><br><span class="line">        Cipher cipher = Cipher.getInstance(transform);</span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, publicKey);</span><br><span class="line">        <span class="keyword">byte</span>[] pubEncryptBytes = cipher.doFinal(value.toString().getBytes());</span><br><span class="line">        System.out.println(<span class="string">"RSAå…¬é’¥åŠ å¯†åæ•°æ®: "</span> + Base64.getEncoder().encodeToString(pubEncryptBytes));</span><br><span class="line"></span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, privateKey);</span><br><span class="line">        <span class="keyword">byte</span>[] priDecryptBytes = cipher.doFinal(pubEncryptBytes);</span><br><span class="line">        System.out.println(<span class="string">"RSAç§é’¥è§£å¯†åæ•°æ®: "</span> + <span class="keyword">new</span> String(priDecryptBytes));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ------ æµ‹è¯•ç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯† ------</span></span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, privateKey);</span><br><span class="line">        <span class="keyword">byte</span>[] priEncryptBytes = cipher.doFinal(value.toString().getBytes());</span><br><span class="line">        System.out.println(<span class="string">"RSAç§é’¥åŠ å¯†åæ•°æ®: "</span> + Base64.getEncoder().encodeToString(priEncryptBytes));</span><br><span class="line"></span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, publicKey);</span><br><span class="line">        <span class="keyword">byte</span>[] pubDecryptBytes = cipher.doFinal(priEncryptBytes);</span><br><span class="line">        System.out.println(<span class="string">"RSAå…¬é’¥è§£å¯†åæ•°æ®: "</span> + <span class="keyword">new</span> String(pubDecryptBytes));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºä¼šæŠ›å‡ºå¦‚ä¸‹å¼‚å¸¸ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">å¾…åŠ å¯†å†…å®¹é•¿åº¦: 120</span><br><span class="line">RSAå…¬é’¥: MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC79DkQcppMMl11r21OMYcTlLWMJP9ZZw9BdszZPu+D1kHijbETrae84AwOrNPqrl8/vpPh2q9BLkrkfQuvSLQHk6tuefVEyWRnnnEwYJzIbjuQPhEwKU7khqjhNXdoW/27AN7kyQwFFnbLHfkc/lh6V6N6S2g5J2NmQL4hfqVgGwIDAQAB</span><br><span class="line">RSAç§é’¥: MIICdwIBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBALv0ORBymkwyXXWvbU4xhxOUtYwk/1lnD0F2zNk+74PWQeKNsROtp7zgDA6s0+quXz++k+Har0EuSuR9C69ItAeTq2559UTJZGeecTBgnMhuO5A+ETApTuSGqOE1d2hb/bsA3uTJDAUWdssd+Rz+WHpXo3pLaDknY2ZAviF+pWAbAgMBAAECgYA2ksoC6ZO9rh4O7rnpK15SJCq2n4N5HQCD/I+sQKbg+9QziPqygQikQdWeaTY6/Rhw9NARkyKx5VQfleNPqOeEj1KwNK8pctD7nkb/PL/LZofH1uk1J0sgaSPpox2LUrIabWFs/dztbHpR/aiaQLbLfrdOgkGoQWM3FB8hMEsbSQJBAPhD/US0C6VQuMqLytuOsB7imqNttD8F6gGQAXAGz2YcgDHSHdayzhT1q12J0nrzfJGfZLZpc+4t9szS9Oh3VvcCQQDBzznlqTbaq7KaxAacdo6BRQszVMuy9kJXupINUUyw+wEaCiz4sxCJsa8ASfJBnxRGFEPyi9Hea6ijOwckDYL9AkEAkAPYqn8K9mYCHDTFg2GdVv06mS0tTxXeLfPccaDxtJk54Cyz9HSayVvNgaBOgdY2376nzI0VnAf7z8tcGHIJ9wJAcPwb5pU1U1mRL8RjjkdXYGkd1Hj0n4oMtxQfHQBuUyahR8ry2LGbTIp3WRXC0xqoOQqLahS07pOYpkA9M3llCQJBAN4oaSLXsSpZtnwekocGapsBaY62Kn9QIZGaGHJkmAwXBXEdXZfr/16BhUd4JSlfGgL3CvdP57OaWjl0CPZ0wxs=</span><br><span class="line"></span><br><span class="line">javax.crypto.IllegalBlockSizeException: Data must not be longer than 117 bytes</span><br><span class="line"></span><br><span class="line">	at com.sun.crypto.provider.RSACipher.doFinal(RSACipher.java:344)</span><br><span class="line">	at com.sun.crypto.provider.RSACipher.engineDoFinal(RSACipher.java:389)</span><br><span class="line">	at javax.crypto.Cipher.doFinal(Cipher.java:2164)</span><br><span class="line">	at cc.mrbird.security.temp.rsa.Demo.test(Demo.java:42)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)</span><br><span class="line">	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)</span><br><span class="line">	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)</span><br><span class="line">	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)</span><br><span class="line">	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)</span><br><span class="line">	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)</span><br><span class="line">	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)</span><br><span class="line">	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)</span><br><span class="line">	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)</span><br><span class="line">	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)</span><br><span class="line">	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)</span><br><span class="line">	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)</span><br><span class="line">	at org.junit.runners.ParentRunner.run(ParentRunner.java:363)</span><br><span class="line">	at org.junit.runner.JUnitCore.run(JUnitCore.java:137)</span><br><span class="line">	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)</span><br><span class="line">	at com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:33)</span><br><span class="line">	at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:230)</span><br><span class="line">	at com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:58)</span><br></pre></td></tr></table></figure><p></p><p>å¯¹äº1024é•¿åº¦çš„å¯†é’¥ã€‚128å­—èŠ‚ï¼ˆ1024bits/8ï¼‰å‡å»PKCS#1å»ºè®®çš„paddingå°±å ç”¨äº†11ä¸ªå­—èŠ‚æ­£å¥½æ˜¯117å­—èŠ‚ã€‚æ‰€ä»¥åŠ å¯†çš„æ˜æ–‡é•¿åº¦120å­—èŠ‚å¤§äº117å­—èŠ‚ï¼Œç¨‹åºæŠ›å‡ºäº†å¼‚å¸¸ã€‚</p><p>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥é‡‡ç”¨åˆ†æ®µåŠ å¯†çš„æ‰‹æ®µã€‚ç¼–å†™ä¸€ä¸ªåˆ†æ®µåŠ è§£å¯†çš„å·¥å…·ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivateKey;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RSAåˆ†æ®µåŠ è§£å¯†</span></span><br><span class="line"><span class="comment"> * é’ˆå¯¹ç§˜é’¥é•¿åº¦ä¸º1024bits</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RsaUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€å¤§åŠ å¯†å—é•¿åº¦ 1024/8 - 11</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ENCRYPT_BLOCK = <span class="number">117</span>;</span><br><span class="line">    <span class="comment">// æœ€å¤§è§£å¯†å—é•¿åº¦ 1024/8</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_DECRYPT_BLOCK = <span class="number">128</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRANSFORM = <span class="string">"RSA/ECB/PKCS1Padding"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…¬é’¥åŠ å¯†</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> publicKey å…¬é’¥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value     å¾…åŠ å¯†å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åŠ å¯†å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encrypt</span><span class="params">(PublicKey publicKey, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream()) &#123;</span><br><span class="line">            Cipher cipher = Cipher.getInstance(TRANSFORM);</span><br><span class="line">            cipher.init(Cipher.ENCRYPT_MODE, publicKey);</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = value.getBytes();</span><br><span class="line">            <span class="keyword">int</span> length = bytes.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> offSet = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] cache;</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// å¯¹æ•°æ®åˆ†æ®µåŠ å¯†</span></span><br><span class="line">            <span class="keyword">while</span> (length - offSet &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (length - offSet &gt; MAX_ENCRYPT_BLOCK) &#123;</span><br><span class="line">                    cache = cipher.doFinal(bytes, offSet, MAX_ENCRYPT_BLOCK);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cache = cipher.doFinal(bytes, offSet, length - offSet);</span><br><span class="line">                &#125;</span><br><span class="line">                out.write(cache, <span class="number">0</span>, cache.length);</span><br><span class="line">                i++;</span><br><span class="line">                offSet = i * MAX_ENCRYPT_BLOCK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">byte</span>[] encryptedData = out.toByteArray();</span><br><span class="line">            <span class="keyword">return</span> Base64.getEncoder().encodeToString(encryptedData);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç§é’¥è§£å¯†</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> privateKey ç§é’¥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encrypt    å¸¦è§£å¯†å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è§£å¯†å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decrypt</span><span class="params">(PrivateKey privateKey, String encrypt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream()) &#123;</span><br><span class="line">            Cipher cipher = Cipher.getInstance(TRANSFORM);</span><br><span class="line">            cipher.init(Cipher.DECRYPT_MODE, privateKey);</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = Base64.getDecoder().decode(encrypt);</span><br><span class="line">            <span class="keyword">int</span> length = bytes.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> offSet = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] cache;</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// å¯¹æ•°æ®åˆ†æ®µè§£å¯†</span></span><br><span class="line">            <span class="keyword">while</span> (length - offSet &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (length - offSet &gt; MAX_DECRYPT_BLOCK) &#123;</span><br><span class="line">                    cache = cipher.doFinal(bytes, offSet, MAX_DECRYPT_BLOCK);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cache = cipher.doFinal(bytes, offSet, length - offSet);</span><br><span class="line">                &#125;</span><br><span class="line">                out.write(cache, <span class="number">0</span>, cache.length);</span><br><span class="line">                i++;</span><br><span class="line">                offSet = i * MAX_DECRYPT_BLOCK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">byte</span>[] decryptedData = out.toByteArray();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(decryptedData);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivateKey;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StringBuilder value = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">29</span>; i++) &#123;</span><br><span class="line">            value.append(<span class="string">"18cm"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"å¾…åŠ å¯†å†…å®¹é•¿åº¦: "</span> + value.toString().length());</span><br><span class="line">        <span class="comment">// åŠ å¯†ç®—æ³•</span></span><br><span class="line">        String algorithm = <span class="string">"RSA"</span>;</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–ç§˜é’¥å¯¹ç”Ÿæˆå™¨</span></span><br><span class="line">        KeyPairGenerator keyPairGenerator = KeyPairGenerator.getInstance(algorithm);</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ï¼Œç§˜é’¥é•¿åº¦512~16384ä½ï¼Œ64å€æ•°</span></span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">// ç”Ÿæˆç§˜é’¥å¯¹</span></span><br><span class="line">        KeyPair keyPair = keyPairGenerator.generateKeyPair();</span><br><span class="line">        <span class="comment">// å…¬é’¥</span></span><br><span class="line">        PublicKey publicKey = keyPair.getPublic();</span><br><span class="line">        System.out.println(<span class="string">"RSAå…¬é’¥: "</span> + Base64.getEncoder().encodeToString(publicKey.getEncoded()));</span><br><span class="line">        <span class="comment">// ç§é’¥</span></span><br><span class="line">        PrivateKey privateKey = keyPair.getPrivate();</span><br><span class="line">        System.out.println(<span class="string">"RSAç§é’¥: "</span> + Base64.getEncoder().encodeToString(privateKey.getEncoded()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ------ æµ‹è¯•å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯† ------</span></span><br><span class="line">        String pubEncrypt= RsaUtil.encrypt(publicKey, value.toString());</span><br><span class="line">        System.out.println(<span class="string">"RSAå…¬é’¥åŠ å¯†åæ•°æ®: "</span> + pubEncrypt);</span><br><span class="line"></span><br><span class="line">        String priDecrypt = RsaUtil.decrypt(privateKey, pubEncrypt);</span><br><span class="line">        System.out.println(<span class="string">"RSAç§é’¥è§£å¯†åæ•°æ®: "</span> + priDecrypt);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å¾…åŠ å¯†å†…å®¹é•¿åº¦: 120</span><br><span class="line">RSAå…¬é’¥: MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCJcyiFAbUHBYXe5BTY/TF5Bn4/fW4L0dK2eaDSPJr4uqTFxIj+sRDqRq71yZw3KJk0qxmmGbtMRQGuR+GVAyJ/0E2R3q2RM+aWCZmkzyDnq6xHIvV0d3mU3N8EDtPS6iO+ANOEPNKfdzr+BJN8NKnpXC2ii7phvMk/QlYqjVAbIwIDAQAB</span><br><span class="line">RSAç§é’¥: MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBAIlzKIUBtQcFhd7kFNj9MXkGfj99bgvR0rZ5oNI8mvi6pMXEiP6xEOpGrvXJnDcomTSrGaYZu0xFAa5H4ZUDIn/QTZHerZEz5pYJmaTPIOerrEci9XR3eZTc3wQO09LqI74A04Q80p93Ov4Ek3w0qelcLaKLumG8yT9CViqNUBsjAgMBAAECgYEAhaU2UdVuGoyxNR9acf4GW6IHoV4pYU68bnbm+2S4Xn7EdhN6DQNH6jOeLRjCTxOnnAF95/Z/GlLCpp335nbs1B1wlb6MP5l3keO2KhYuvPhnZdPInNV0aKWzOoX7gcmy12g5IAQgoYoc/IohPIpMmkgrbuGQGk2+jxnGPETgNdECQQDhDyP3VIH5AucbHHeL6fSU9kswO1eejLzRmvlKIwk15wE1xteFvIqpLOLlR8wJm+Eb5uB0HEr4X7rlWDQLq/OZAkEAnFilYybZfp4rRctsnYjFZf0QGUCCBV9hFa7xoGztV2rAkLLmsnayXzSJpOYYAOI7ekrqfLL3xALQKn8DZtr6GwJAecd9iKl7oshFUVA4B8dShwA2cyTJJou06B5ZYhpPM5GKABVWLZF13lDhfXs6FsD4L+bf8TQWBQuXz93IW8BxkQJAZqfR2BuPHRMPiKE77Of77K5PnrT7ajmpDkqy/knnQMmoLJo63Z0QG3Dsm6g0xIfG09JSypPcGQhb1DtXaXaIVwJAVVSPa1caRWLKYlEKAi1gBbrC5Zt7aTQ/ska2E3ksAhaVhScPBOEIoQf9EdbGajmpuueWeH9IlVrqQv0vFNY4gA==</span><br><span class="line">RSAå…¬é’¥åŠ å¯†åæ•°æ®: cy7Var2L72bgne9F8iGro+SCQxs2ejIMPwQDJ5hQFTLvyqtT4ZJYM5i2ClgOD9viAP2Tp/X5cCX0+K1xz88hf5w/xNPWonzdaJNa2J5gQv7KGxNe/pW4mtpf878u4sIvO9sT8AktWtJC3jFtvxL9u9vJdzWl99RSRf/3sNqWj3gLRM/YpCcGM0HPuDsyUdOA4q+Tn+d2nOf36XrBtjIl2QyOTwnMoMCbC9Hlt6jN8fMsSFW8oiFNqV/+HPlhs5ZtFixhUE6SryketJfzXGmUSXH5cM/+11pB2bBxrCvtqRUE5/MZKjL2kKmrZan3kDHi4aiwLSDdpYdZn0urrJObAA==</span><br><span class="line">RSAç§é’¥è§£å¯†åæ•°æ®: 18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm18cm</span><br></pre></td></tr></table></figure><p></p><h2 id="å»ºè®®"><a href="#å»ºè®®" class="headerlink" title="å»ºè®®"></a>å»ºè®®</h2><ol><li><p>å…¬é’¥æ˜¯é€šè¿‡Aå‘é€ç»™Bçš„ï¼Œå…¶åœ¨ä¼ é€’è¿‡ç¨‹ä¸­å¾ˆæœ‰å¯èƒ½è¢«æˆªè·ï¼Œä¹Ÿå°±æ˜¯è¯´çªƒå¬è€…å¾ˆæœ‰å¯èƒ½è·å¾—å…¬é’¥ã€‚å¦‚æœçªƒå¬è€…è·å¾—äº†å…¬é’¥ï¼Œå‘Aå‘é€æ•°æ®ï¼ŒAæ˜¯æ— æ³•è¾¨åˆ«æ¶ˆæ¯çš„çœŸä¼ªçš„ã€‚å› æ­¤ï¼Œè™½ç„¶å¯ä»¥ä½¿ç”¨å…¬é’¥å¯¹æ•°æ®åŠ å¯†ï¼Œä½†è¿™ç§æ–¹å¼è¿˜æ˜¯ä¼šæœ‰å­˜åœ¨ä¸€å®šçš„å®‰å…¨éšæ‚£ã€‚å¦‚æœè¦å»ºç«‹æ›´å®‰å…¨çš„åŠ å¯†æ¶ˆæ¯ä¼ é€’æ¨¡å‹ï¼Œå°±éœ€è¦ABåŒæ–¹æ„å»ºä¸¤å¥—éå¯¹ç§°åŠ å¯†ç®—æ³•å¯†é’¥ï¼Œä»…éµå¾ªâ€œç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯†â€çš„æ–¹å¼è¿›è¡ŒåŠ å¯†æ¶ˆæ¯ä¼ é€’ï¼›</p></li><li><p>RSAä¸é€‚åˆåŠ å¯†è¿‡é•¿çš„æ•°æ®ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡åˆ†æ®µåŠ å¯†æ‰‹æ®µè§£å†³ï¼Œä½†è¿‡é•¿çš„æ•°æ®åŠ è§£å¯†è€—æ—¶è¾ƒé•¿ï¼Œåœ¨å“åº”é€Ÿåº¦è¦æ±‚è¾ƒé«˜çš„æƒ…å†µä¸‹æ…ç”¨ã€‚ä¸€èˆ¬æ¨èä½¿ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•ä¼ è¾“å¯¹ç§°åŠ å¯†ç§˜é’¥ï¼ŒåŒæ–¹æ•°æ®åŠ å¯†ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•åŠ è§£å¯†ã€‚</p></li></ol><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue Dec 14 2021 15:16:20 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;éå¯¹ç§°åŠ å¯†å’Œå¯¹ç§°åŠ å¯†ç®—æ³•ç›¸æ¯”ï¼Œå¤šäº†ä¸€æŠŠç§˜é’¥ï¼Œä¸ºåŒç§˜é’¥æ¨¡å¼ï¼Œä¸€ä¸ªå…¬å¼€ç§°ä¸ºå…¬é’¥ï¼Œä¸€ä¸ªä¿å¯†ç§°ä¸ºç§é’¥ã€‚éµå¾ªå…¬é’¥åŠ å¯†ç§é’¥è§£å¯†ï¼Œæˆ–è€…ç§é’¥åŠ å¯†å…¬é’¥è§£å¯†ã€‚éå¯¹ç§°åŠ å¯†ç®—æ³•æºäºDHç®—æ³•ï¼Œååˆæœ‰åŸºäºæ¤­åœ†æ›²çº¿åŠ å¯†ç®—æ³•çš„å¯†é’¥äº¤æ¢ç®—æ³•ECDHï¼Œä¸è¿‡ç›®å‰æœ€ä¸ºæµè¡Œçš„éå¯¹ç§°åŠ å¯†ç®—æ³•æ˜¯RSAï¼Œæœ¬æ–‡ç®€å•è®°å½•ä¸‹RSAçš„ä½¿ç”¨ã€‚
    
    </summary>
    
    
      <category term="Security" scheme="http://mrbird.cc/tags/Security/"/>
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
</feed>
